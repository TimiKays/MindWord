/**
 * MindWord - æ ‘å¿ƒ | åƒç”»å›¾ä¸€æ ·å†™æ–‡æ¡£çš„æ€ç»´å¯¼å›¾å†™ä½œå·¥å…·
 * GitHub: https://github.com/TimiKays/MindWord
 * 
 * Copyright 2025 Timi Kays
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * LeanCloud Data åŒæ­¥ï¼ˆä¸­æ–‡æ¨¡å¼ï¼‰
 * ä»…åœ¨è¯­è¨€ä¸ºä¸­æ–‡æ—¶å¯ç”¨ UIï¼›æä¾›ï¼šä¸€é”®åŒæ­¥ï¼ˆæ™ºèƒ½åˆ†æï¼‰ã€æ¸…ç©ºäº‘æ•°æ®
 * æ”¹è¿›ï¼šæ”¯æŒæ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆå•å›¾200KBï¼Œæ€»é‡10Mï¼‰ï¼Œåˆ†ç±»å‹æ—¶é—´æˆ³è®°å½•
 * å­—æ®µï¼šdocs(json), aiConfig(json), promptTemplates(json), 
 *       docUpdatedAt(number), configUpdatedAt(number), templateUpdatedAt(number)
 */
(function () {
  const LANG_KEY = 'mw_lang';
  const CLASS_NAME = 'MWData';
  let cachedCloudRaw = null;   // ç¼“å­˜ç¬¬ä¸€æ¬¡ downloadCloud() çš„åŸç”Ÿå¯¹è±¡

  // æ–‡ä»¶å¤§å°é™åˆ¶
  const MAX_IMAGE_SIZE = 2 * 1024 * 1024; // 2MB
  const MAX_TOTAL_SIZE = 10 * 1024 * 1024; // 10M

  function getLang() {
    try { return localStorage.getItem(LANG_KEY) || 'zh'; } catch (_) { return 'zh'; }
  }

  // æ–°çš„åˆå¹¶ç®—æ³•ï¼šå°†äº‘ç«¯æ•°æ®åˆå¹¶åˆ°æœ¬åœ°

  function isLoggedIn() {
    try { return !!(window.AV && AV.User && AV.User.current()); } catch (_) { return false; }
  }

  function getLocalDocs() { try { return (typeof mw_loadDocs === 'function') ? mw_loadDocs() : []; } catch (_) { return []; } }

  // åˆ¤æ–­æ–‡æ¡£æ˜¯å¦æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼ˆæ²¡æœ‰çœŸå®å­èŠ‚ç‚¹ï¼‰
  function isAutoGeneratedEmptyDoc(doc) {
    if (!doc) return false;

    // æ£€æŸ¥åç§°æ˜¯å¦ä¸ºé»˜è®¤çš„"æœªå‘½åæ–‡æ¡£"
    const name = doc.name || '';
    if (name !== 'æœªå‘½åæ–‡æ¡£') return false;

    // æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºé»˜è®¤çš„"# æœªå‘½åæ–‡æ¡£\n"
    const md = doc.md || '';
    if (md.trim() !== '# æœªå‘½åæ–‡æ¡£') return false;

    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡ï¼ˆç©ºæ–‡æ¡£ä¸åº”è¯¥æœ‰å›¾ç‰‡ï¼‰
    if (doc.images && doc.images.length > 0) return false;

    return true;
  }

  /**
   * æ¯”è¾ƒä¸¤ä¸ªå›¾ç‰‡æ•°ç»„æ˜¯å¦ç›¸ç­‰
   * åªæ¯”è¾ƒå›¾ç‰‡çš„åŸºæœ¬ä¿¡æ¯ï¼ˆIDã€åç§°ã€MIMEç±»å‹ï¼‰ï¼Œå¿½ç•¥dataUrlç­‰å¯èƒ½å˜åŒ–çš„å†…å®¹
   * @param {Array} localImages - æœ¬åœ°å›¾ç‰‡æ•°ç»„
   * @param {Array} cloudImages - äº‘ç«¯å›¾ç‰‡æ•°ç»„
   * @returns {boolean} æ˜¯å¦ç›¸ç­‰
   */
  function areImagesEqual(localImages, cloudImages) {
    // å¦‚æœæ•°ç»„é•¿åº¦ä¸åŒï¼Œè‚¯å®šä¸ç›¸ç­‰
    if (localImages.length !== cloudImages.length) {
      return false;
    }

    // åˆ›å»ºæœ¬åœ°å›¾ç‰‡IDæ˜ å°„
    const localImageMap = new Map();
    for (const img of localImages) {
      if (img && img.id) {
        localImageMap.set(img.id, {
          id: img.id,
          name: img.name || '',
          mime: img.mime || ''
        });
      }
    }

    // æ£€æŸ¥æ¯ä¸ªäº‘ç«¯å›¾ç‰‡æ˜¯å¦åœ¨æœ¬åœ°å­˜åœ¨ä¸”åŸºæœ¬ä¿¡æ¯ä¸€è‡´
    for (const cloudImg of cloudImages) {
      if (!cloudImg || !cloudImg.id) {
        return false; // äº‘ç«¯å›¾ç‰‡ç¼ºå°‘IDï¼Œè®¤ä¸ºä¸ç›¸ç­‰
      }

      const localImg = localImageMap.get(cloudImg.id);
      if (!localImg) {
        return false; // æœ¬åœ°æ²¡æœ‰å¯¹åº”å›¾ç‰‡
      }

      // æ¯”è¾ƒåŸºæœ¬ä¿¡æ¯ï¼ˆå¿½ç•¥dataUrlç­‰å¯èƒ½å˜åŒ–çš„å†…å®¹ï¼‰
      if (localImg.name !== (cloudImg.name || '') ||
        localImg.mime !== (cloudImg.mime || '')) {
        return false; // åŸºæœ¬ä¿¡æ¯ä¸ä¸€è‡´
      }
    }

    return true; // æ‰€æœ‰å›¾ç‰‡éƒ½åŒ¹é…
  }

  /**
   * æ¯”è¾ƒä¸¤ä¸ªæ–‡æ¡£æ˜¯å¦ç›¸ç­‰
   * @param {Object} localDoc - æœ¬åœ°æ–‡æ¡£
   * @param {Object} cloudDoc - äº‘ç«¯æ–‡æ¡£
   * @returns {boolean} æ˜¯å¦ç›¸ç­‰
   */
  function areDocsEqual(localDoc, cloudDoc) {
    if (!localDoc || !cloudDoc) {
      return false; // ä»»ä¸€æ–‡æ¡£ä¸å­˜åœ¨ï¼Œè®¤ä¸ºä¸ç›¸ç­‰
    }

    // æ£€æŸ¥åˆ é™¤çŠ¶æ€æ˜¯å¦ä¸€è‡´
    if (!!localDoc.deleted !== !!cloudDoc.deleted) {
      return false;
    }

    // æ£€æŸ¥MDå†…å®¹æ˜¯å¦ä¸€è‡´
    if (localDoc.md !== cloudDoc.md) {
      return false;
    }

    // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦ä¸€è‡´
    const localImages = localDoc.images || [];
    const cloudImages = cloudDoc.images || [];
    return areImagesEqual(localImages, cloudImages);
  }

  /**
   * æ¯”è¾ƒå®Œæ•´æ•°æ®é›†æ˜¯å¦ç›¸ç­‰
   * @param {Object} localData - æœ¬åœ°æ•°æ®
   * @param {Object} cloudData - äº‘ç«¯æ•°æ®
   * @returns {boolean} æ˜¯å¦ç›¸ç­‰
   */
  function areDataSetsEqual(localData, cloudData) {
    if (!localData || !cloudData) {
      return false;
    }

    // æ£€æŸ¥é…ç½®å“ˆå¸Œæ˜¯å¦ä¸€è‡´
    if (localData.aiConfigHash !== cloudData.aiConfigHash ||
      localData.promptTemplatesHash !== cloudData.promptTemplatesHash ||
      localData.myPromptTemplatesHash !== cloudData.myPromptTemplatesHash) {
      return false;
    }

    // æ£€æŸ¥æ–‡æ¡£æ•°é‡æ˜¯å¦ä¸€è‡´
    const localDocs = localData.docs || [];
    const cloudDocs = cloudData.docs || [];
    if (localDocs.length !== cloudDocs.length) {
      return false;
    }

    // åˆ›å»ºæ–‡æ¡£IDæ˜ å°„
    const localDocMap = new Map(localDocs.map(d => [d.id, d]));
    const cloudDocMap = new Map(cloudDocs.map(d => [d.id, d]));

    // æ£€æŸ¥æ¯ä¸ªæ–‡æ¡£æ˜¯å¦åŒ¹é…
    for (const [docId, localDoc] of localDocMap) {
      const cloudDoc = cloudDocMap.get(docId);
      if (!areDocsEqual(localDoc, cloudDoc)) {
        return false;
      }
    }

    return true;
  }

  function saveLocalDocs(docs) { try { return (typeof mw_saveDocs === 'function') ? mw_saveDocs(docs) : null; } catch (_) { return null; } }

  // è·å–AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿
  function getLocalAIConfig() {
    try {
      const configStr = localStorage.getItem('allAIPlatformConfigs');
      return configStr ? JSON.parse(configStr) : {};
    } catch (_) {
      return {};
    }
  }

  function getLocalPromptTemplates() {
    try {
      const templatesStr = localStorage.getItem('promptTemplates');
      return templatesStr ? JSON.parse(templatesStr) : [];
    } catch (_) {
      return [];
    }
  }

  // è·å–æœ¬åœ° myPromptTemplates æ•°æ®
  function getLocalMyPromptTemplates() {
    try {
      const templatesStr = localStorage.getItem('myPromptTemplates');
      return templatesStr ? JSON.parse(templatesStr) : [];
    } catch (_) {
      return [];
    }
  }

  // ä¿å­˜AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿
  function saveLocalAIConfig(config) {
    try {
      localStorage.setItem('allAIPlatformConfigs', JSON.stringify(config));
      localStorage.setItem('allAIPlatformConfigs_last_modified', Date.now().toString());
      return true;
    } catch (_) {
      return false;
    }
  }

  function saveLocalPromptTemplates(templates) {
    try {
      localStorage.setItem('promptTemplates', JSON.stringify(templates));
      localStorage.setItem('promptTemplates_last_modified', Date.now().toString());
      return true;
    } catch (_) {
      return false;
    }
  }

  // ç›´æ¥è¯»ç°æˆçš„ hash ä¸ last_modifiedï¼Œä¸å†è‡ªå·±ç®—
  function getDataHashAndTime(_data, storageKey) {
    const hash = localStorage.getItem(storageKey + '_hash') || '';
    const lastModified = parseInt(localStorage.getItem(storageKey + '_last_modified') || '0');
    return { hash, lastModified };
  }

  // æ–‡ä»¶å¤§å°æ£€æŸ¥å‡½æ•°
  function checkFileSize(docs) {
    let totalSize = 0;
    const errors = [];

    for (const doc of (docs || [])) {
      if (!doc) continue;

      // è®¡ç®—æ–‡æ¡£æ–‡æœ¬å†…å®¹å¤§å°ï¼ˆUTF-8ç¼–ç ï¼‰
      if (doc.md) {
        const contentSize = new Blob([doc.md]).size;
        totalSize += contentSize;
      }

      // è®¡ç®—æ ‡é¢˜å¤§å°
      if (doc.name) {
        const titleSize = new Blob([doc.name]).size;
        totalSize += titleSize;
      }

      // è®¡ç®—å¤‡æ³¨å¤§å°
      if (doc.note) {
        const noteSize = new Blob([doc.note]).size;
        totalSize += noteSize;
      }

      // æ£€æŸ¥æ–‡æ¡£ä¸­çš„å›¾ç‰‡
      if (doc.md) {
        const imgMatches = doc.md.match(/data:image\/[^;]+;base64,[^"']+/g) || [];
        for (const imgData of imgMatches) {
          const base64Data = imgData.split(',')[1];
          const imgSize = Math.ceil(base64Data.length * 0.75); // base64è§£ç åçš„å¤§å°

          if (imgSize > MAX_IMAGE_SIZE) {
            errors.push(`æ–‡æ¡£"${doc.name || doc.id}"ä¸­çš„å›¾ç‰‡è¶…è¿‡200KBé™åˆ¶`);
          }
          totalSize += imgSize;
        }
      }

      // æ£€æŸ¥å¤‡æ³¨ä¸­çš„å›¾ç‰‡
      if (doc.note) {
        const noteImgMatches = doc.note.match(/data:image\/[^;]+;base64,[^"']+/g) || [];
        for (const imgData of noteImgMatches) {
          const base64Data = imgData.split(',')[1];
          const imgSize = Math.ceil(base64Data.length * 0.75);

          if (imgSize > MAX_IMAGE_SIZE) {
            errors.push(`æ–‡æ¡£"${doc.title || doc.id}"å¤‡æ³¨ä¸­çš„å›¾ç‰‡è¶…è¿‡200KBé™åˆ¶`);
          }
          totalSize += imgSize;
        }
      }
    }

    if (totalSize > MAX_TOTAL_SIZE) {
      errors.push(`æ€»æ–‡ä»¶å¤§å°è¶…è¿‡10Mé™åˆ¶ï¼ˆå½“å‰${Math.ceil(totalSize / 1024 / 1024)}Mï¼‰`);
    }

    return {
      valid: errors.length === 0,
      errors: errors,
      totalSize: totalSize
    };
  }

  // è·å–æ–‡æ¡£çš„æ—¶é—´æˆ³æ˜ å°„è¡¨
  function getDocTimestamps(docs) {
    const timestamps = {};
    for (const doc of (docs || [])) {
      if (doc && doc.id) {
        // å¯¹äºå·²åˆ é™¤çš„æ–‡æ¡£ï¼Œä½¿ç”¨deletedAtä½œä¸ºæ—¶é—´æˆ³ï¼Œç¡®ä¿åŒæ­¥é€»è¾‘æ­£ç¡®
        timestamps[doc.id] = Number(doc.updatedAt || doc.deletedAt || 0);
      }
    }
    return timestamps;
  }

  // ============= æ–°åŒæ­¥æ ¸å¿ƒï¼šåŒç»“æ„å¿«ç…§ + ä¸‰å‘åˆå¹¶ =============

  // æŠŠäº‘ç«¯åŸå§‹ doc è½¬æˆæœ¬åœ°æ ¼å¼ï¼Œå¹¶è¡¥å…¨ç¼ºå¤±å­—æ®µ
  function normalizeCloudDoc(cDoc) {
    return {
      id: cDoc.id,
      name: cDoc.name || '',
      md: cDoc.md || '',
      images: cDoc.images || [], // æ·»åŠ imagesæ•°ç»„å­—æ®µ
      updatedAt: Number(cDoc.updatedAt || 0),
      deletedAt: cDoc.deletedAt ? Number(cDoc.deletedAt) : undefined
    };
  }

  // æ‹‰å–å¹¶ç»„è£…æˆä¸ localFullData å®Œå…¨åŒæ„çš„å¯¹è±¡
  async function fetchCloudFullData() {
    // æ¯æ¬¡éƒ½é‡æ–°æ‹‰å–æœ€æ–°æ•°æ®ï¼Œé¿å…ç¼“å­˜å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
    const cloudRaw = cachedCloudRaw || await downloadCloud();
    // æ›´æ–°ç¼“å­˜ï¼Œç¡®ä¿åç»­å¯ä»¥ä½¿ç”¨
    cachedCloudRaw = cloudRaw;
    return {
      docs: (cloudRaw.docs || []).map(normalizeCloudDoc),
      aiConfig: cloudRaw.aiConfig || {},
      aiConfigHash: cloudRaw.aiConfigHash,                // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      aiConfigLastModified: Number(cloudRaw.configUpdatedAt || 0),
      promptTemplates: cloudRaw.promptTemplates || [],
      promptTemplatesHash: cloudRaw.promptTemplatesHash,    // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      promptTemplatesLastModified: Number(cloudRaw.templateUpdatedAt || 0),
      myPromptTemplates: cloudRaw.myPromptTemplates || [],
      myPromptTemplatesHash: cloudRaw.myPromptTemplatesHash,    // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      myPromptTemplatesLastModified: Number(cloudRaw.myPromptTemplateUpdatedAt || 0),
      lastSyncAt: 0                                         // äº‘ç«¯æ— æ­¤å­—æ®µ
    };
  }

  // ä¸‰å‘åˆå¹¶ï¼šæœ¬åœ° + äº‘ç«¯ â†’ ç›®æ ‡ç»“æ„
  async function mergeToTarget(local, cloud) {
    const target = {
      docs: [],
      aiConfig: {},
      promptTemplates: [],
      myPromptTemplates: [],
      aiConfigHash: undefined,
      aiConfigLastModified: 0,
      promptTemplatesHash: undefined,
      promptTemplatesLastModified: 0,
      myPromptTemplatesHash: undefined,
      myPromptTemplatesLastModified: 0,
      lastSyncAt: Date.now()
    };

    // 1. æ–‡æ¡£æ•°ç»„ï¼šæŒ‰ ID ä¸‰å‘åˆå¹¶ï¼ˆè·³è¿‡å·²åˆ é™¤ï¼Œå“ˆå¸Œç›¸åŒå–äº‘ç«¯ï¼Œä¸åŒæŒ‰æ—¶é—´æˆ³ï¼‰
    const hashDoc = d => {
      const str = (d.name || '') + '\n' + (d.md || '') + '\n' + JSON.stringify(d.images || []);
      let h = 5381;
      for (let i = 0; i < str.length; i++) h = (h << 5) + h + str.charCodeAt(i);
      return h >>> 0;          // è½¬æˆæ­£ 32 ä½æ•´æ•°
    };

    const localDocMap = new Map(local.docs.map(d => [d.id, d]));
    const cloudDocMap = new Map(cloud.docs.map(d => [d.id, d]));
    // åªæ’é™¤äº‘ç«¯å·²åˆ é™¤çš„ idï¼›æœ¬åœ°å·²åˆ é™¤ä»è¦å‚ä¸åˆå¹¶ï¼Œä»¥ä¾¿æŠŠåˆ é™¤åŒæ­¥åˆ°äº‘ç«¯
    const aliveIds = new Set([
      ...local.docs.map(d => d.id),                       // æœ¬åœ°å…¨éƒ¨ä¿ç•™
      ...cloud.docs.filter(d => !d.deletedAt).map(d => d.id) // äº‘ç«¯åªç•™æœªåˆ é™¤
    ]);
    const allIds = aliveIds;

    for (const id of allIds) {
      const ld = localDocMap.get(id);
      const cd = cloudDocMap.get(id);

      if (!ld && cd) {           // ä»…äº‘ç«¯æœ‰
        target.docs.push(await cleanDocImagesArray(cd));
      } else if (ld && !cd) {    // ä»…æœ¬åœ°æœ‰
        target.docs.push(await cleanDocImagesArray(ld));
      } else {                   // ä¸¤è¾¹éƒ½æœ‰
        const hashL = hashDoc(ld);
        const hashC = hashDoc(cd);
        if (hashL === hashC) {   // å†…å®¹ç›¸åŒï¼Œç”¨äº‘ç«¯
          target.docs.push(await cleanDocImagesArray(cd));
        } else {                 // å†…å®¹ä¸åŒï¼ŒæŒ‰æ—¶é—´æˆ³å†³èƒœ
          target.docs.push(await cleanDocImagesArray(Number(ld.updatedAt) >= Number(cd.updatedAt) ? ld : cd));
        }
      }
    }

    // 2. AI é…ç½®ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.aiConfigLastModified && cloud.aiConfigLastModified) {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    } else if (local.aiConfigLastModified && !cloud.aiConfigLastModified) {
      target.aiConfig = local.aiConfig;
      target.aiConfigHash = local.aiConfigHash;
      target.aiConfigLastModified = local.aiConfigLastModified;
    } else if (local.aiConfigHash === cloud.aiConfigHash) {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    } else if (local.aiConfigLastModified >= cloud.aiConfigLastModified) {
      target.aiConfig = local.aiConfig;
      target.aiConfigHash = local.aiConfigHash;
      target.aiConfigLastModified = local.aiConfigLastModified;
    } else {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    }

    // 3. æç¤ºè¯æ¨¡æ¿ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.promptTemplatesLastModified && cloud.promptTemplatesLastModified) {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    } else if (local.promptTemplatesLastModified && !cloud.promptTemplatesLastModified) {
      target.promptTemplates = local.promptTemplates;
      target.promptTemplatesHash = local.promptTemplatesHash;
      target.promptTemplatesLastModified = local.promptTemplatesLastModified;
    } else if (local.promptTemplatesHash === cloud.promptTemplatesHash) {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    } else if (local.promptTemplatesLastModified >= cloud.promptTemplatesLastModified) {
      target.promptTemplates = local.promptTemplates;
      target.promptTemplatesHash = local.promptTemplatesHash;
      target.promptTemplatesLastModified = local.promptTemplatesLastModified;
    } else {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    }

    // 4. æˆ‘çš„æç¤ºè¯æ¨¡æ¿ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.myPromptTemplatesLastModified && cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesLastModified && !cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = local.myPromptTemplates;
      target.myPromptTemplatesHash = local.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = local.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesHash === cloud.myPromptTemplatesHash) {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesLastModified >= cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = local.myPromptTemplates;
      target.myPromptTemplatesHash = local.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = local.myPromptTemplatesLastModified;
    } else {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    }

    console.log('åˆå¹¶åçš„ç›®æ ‡ç»“æ„:', target);
    return target;
  }

  // è½åœ°ï¼šäº‘ç«¯
  async function applyTargetToCloud(target, cloudFullData, cloudObj, localFullData) {
    console.log('[SYNC] å¼€å§‹äº‘ç«¯åŒæ­¥ï¼Œç”¨æˆ·çŠ¶æ€:', AV.User.current() ? 'å·²ç™»å½•' : 'æœªç™»å½•');
    const user = AV.User.current();
    if (!user) throw new Error('æœªç™»å½•');

    // æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥å’Œé˜²å¹¶å‘æœºåˆ¶
    if (!cloudObj) {
      throw new Error('äº‘ç«¯å¯¹è±¡ä¸ºç©ºï¼Œæ— æ³•åŒæ­¥');
    }

    // è·å–å½“å‰äº‘ç«¯å¯¹è±¡çš„ç‰ˆæœ¬ä¿¡æ¯
    const currentVersion = cloudObj.get('updatedAtMs') || 0;
    console.log('[SYNC] å½“å‰äº‘ç«¯å¯¹è±¡ç‰ˆæœ¬:', currentVersion);

    // å…³é”®éªŒè¯ï¼šç¡®ä¿targetæ•°æ®æ˜¯ç”¨æˆ·é€‰æ‹©çš„ç»“æœï¼Œè€Œä¸æ˜¯äº‘ç«¯æ•°æ®
    console.log('[SYNC] === å…³é”®æ•°æ®éªŒè¯ ===');
    console.log('[SYNC] targetæ•°æ®æ¥æºæ£€æŸ¥:');
    console.log('[SYNC] - target.docsæ•°é‡:', target.docs ? target.docs.length : 0);
    console.log('[SYNC] - target.aiConfigé”®æ•°é‡:', target.aiConfig ? Object.keys(target.aiConfig).length : 0);
    console.log('[SYNC] - target.promptTemplatesæ•°é‡:', target.promptTemplates ? target.promptTemplates.length : 0);
    console.log('[SYNC] - target.myPromptTemplatesæ•°é‡:', target.myPromptTemplates ? target.myPromptTemplates.length : 0);

    console.log('[SYNC] cloudFullDataæ•°æ®æ¥æºæ£€æŸ¥:');
    console.log('[SYNC] - cloudFullData.docsæ•°é‡:', cloudFullData.docs ? cloudFullData.docs.length : 0);
    console.log('[SYNC] - cloudFullData.aiConfigé”®æ•°é‡:', cloudFullData.aiConfig ? Object.keys(cloudFullData.aiConfig).length : 0);
    console.log('[SYNC] - cloudFullData.promptTemplatesæ•°é‡:', cloudFullData.promptTemplates ? cloudFullData.promptTemplates.length : 0);
    console.log('[SYNC] - cloudFullData.myPromptTemplatesæ•°é‡:', cloudFullData.myPromptTemplates ? cloudFullData.myPromptTemplates.length : 0);

    // éªŒè¯targetæ•°æ®æ˜¯å¦ä¸äº‘ç«¯æ•°æ®å®Œå…¨ç›¸åŒï¼ˆæ£€æŸ¥ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç”Ÿæ•ˆï¼‰
    if (target.docs && cloudFullData.docs) {
      const targetDocIds = new Set(target.docs.map(d => d.id));
      const cloudDocIds = new Set(cloudFullData.docs.map(d => d.id));
      const sameDocs = target.docs.length === cloudFullData.docs.length &&
        [...targetDocIds].every(id => cloudDocIds.has(id));

      if (sameDocs && target.docs.length > 0) {
        const firstTargetDoc = target.docs[0];
        const firstCloudDoc = cloudFullData.docs.find(d => d.id === firstTargetDoc.id);
        if (firstCloudDoc && firstTargetDoc.updatedAt === firstCloudDoc.updatedAt) {
          // åªæœ‰å½“ç”¨æˆ·æ˜ç¡®åšäº†é€‰æ‹©ï¼Œä½†æ•°æ®ä»ç„¶å®Œå…¨ä¸€è‡´æ—¶æ‰è­¦å‘Š
          const hasUserChoices = target.modifiedDocIds && target.modifiedDocIds.length > 0;
          if (hasUserChoices) {
            console.warn('[SYNC] âš ï¸ æ³¨æ„ï¼šç”¨æˆ·é€‰æ‹©äº†ä¿®æ”¹æ–‡æ¡£ï¼Œä½†ç›®æ ‡æ•°æ®ä¸äº‘ç«¯æ•°æ®å®Œå…¨ä¸€è‡´');
            console.warn('[SYNC] è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œç”¨æˆ·å¯èƒ½é€‰æ‹©äº†ä¿ç•™äº‘ç«¯ç‰ˆæœ¬');
          } else {
            console.log('[SYNC] ç›®æ ‡æ•°æ®ä¸äº‘ç«¯æ•°æ®ä¸€è‡´ï¼Œä½¿ç”¨ç³»ç»Ÿæ¨èæ–¹æ¡ˆ');
          }
        }
      }
    }

    // 0. å…ˆè¡¥å›äº‘ç«¯å·²åˆ é™¤è®°å½•ï¼ˆæœ¬åœ°å¯èƒ½å·²å½»åº•å‰”é™¤ï¼‰ï¼Œå¾—åˆ°å®Œæ•´ç›®æ ‡
    const targetIds = new Set((target.docs || []).map(d => d.id));

    console.log('[SYNC] buildTargetFromChoicesåçš„ç›®æ ‡æ•°æ®æ£€æŸ¥:');
    console.log('[SYNC] target.docsæ•°é‡:', target.docs ? target.docs.length : 0);
    console.log('[SYNC] targetIdsé›†åˆ:', Array.from(targetIds));
    console.log('[SYNC] cloudFullData.docsæ•°é‡:', cloudFullData && cloudFullData.docs ? cloudFullData.docs.length : 0);

    const mergedDocs = [...(target.docs || [])];
    console.log('[SYNC] åˆå§‹mergedDocsæ•°é‡:', mergedDocs.length);

    for (const cd of (cloudFullData ? cloudFullData.docs : [])) {
      if (!targetIds.has(cd.id) && cd.deletedAt) {
        mergedDocs.push(cd);   // äº‘ç«¯ç‹¬æœ‰ä¸”å·²æ ‡è®°åˆ é™¤
        console.log('[SYNC] æ·»åŠ äº‘ç«¯å·²åˆ é™¤æ–‡æ¡£:', cd.id, cd.title);
      }
    }

    console.log('[SYNC] æœ€ç»ˆmergedDocsæ•°é‡:', mergedDocs.length);

    // 1. ç”¨è¡¥å›åçš„å®Œæ•´ç›®æ ‡ä¸äº‘ç«¯å¯¹æ¯”ï¼Œè‹¥å®Œå…¨ä¸€è‡´ç›´æ¥è·³è¿‡
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨target.docsè€Œä¸æ˜¯mergedDocsï¼Œå› ä¸ºmergedDocså¯èƒ½åŒ…å«äº‘ç«¯å·²åˆ é™¤çš„è®°å½•
    console.log('[SYNC] æ•°æ®æ¯”è¾ƒå‰æ£€æŸ¥:');
    console.log('[SYNC] æœ¬åœ°æ–‡æ¡£æ•°é‡:', target.docs ? target.docs.length : 0);
    console.log('[SYNC] äº‘ç«¯æ–‡æ¡£æ•°é‡:', cloudFullData && cloudFullData.docs ? cloudFullData.docs.length : 0);

    const isEqual = areDataSetsEqual(target, cloudFullData);
    console.log('[SYNC] æ•°æ®æ¯”è¾ƒç»“æœ:', isEqual);

    if (isEqual) {
      console.log('[SYNC] äº‘ç«¯ä¸æœ¬åœ°ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥');
      showSuccess('äº‘ç«¯ä¸æœ¬åœ°ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥');
      return;   // æ— éœ€çœŸæ­£è½åº“
    }

    console.log('[SYNC] æ£€æµ‹åˆ°æ•°æ®å·®å¼‚ï¼Œå¼€å§‹åŒæ­¥åˆ°äº‘ç«¯');


    // ä½¿ç”¨ä¼ å…¥çš„äº‘ç«¯å¯¹è±¡ï¼Œé¿å…é‡å¤ä¸‹è½½
    const obj = cloudObj || await fetchOrCreateRecord();
    if (!obj) {
      throw new Error('æ— æ³•è·å–äº‘ç«¯å¯¹è±¡');
    }

    // ç¡®ä¿æ‰€æœ‰æ–‡æ¡£çš„imagesæ•°ç»„éƒ½å·²æ¸…ç†ï¼ŒåªåŒ…å«MDå†…å®¹ä¸­å®é™…å¼•ç”¨çš„å›¾ç‰‡
    const cleanedDocs = await Promise.all(mergedDocs.map(doc => cleanDocImagesArray(doc)));

    console.log('[SYNC] æ¸…ç†åçš„æ–‡æ¡£æ•°æ®æ£€æŸ¥:');
    console.log('[SYNC] cleanedDocsæ•°é‡:', cleanedDocs.length);

    // éªŒè¯å…³é”®æ–‡æ¡£æ•°æ®æ˜¯å¦æ­£ç¡®
    if (cleanedDocs.length > 0) {
      const firstDoc = cleanedDocs[0];
      const originalFirstDoc = mergedDocs[0];
      console.log('[SYNC] ç¬¬ä¸€ä¸ªæ–‡æ¡£éªŒè¯:');
      console.log('[SYNC] - ID:', firstDoc.id);
      console.log('[SYNC] - æ ‡é¢˜:', firstDoc.title);
      console.log('[SYNC] - å†…å®¹é•¿åº¦:', firstDoc.md ? firstDoc.md.length : 0);
      console.log('[SYNC] - æ›´æ–°æ—¶é—´:', firstDoc.updatedAt);
      console.log('[SYNC] - ä¸åŸå§‹æ•°æ®ä¸€è‡´:', firstDoc.id === originalFirstDoc.id);

      // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æ˜ç¡®é€‰æ‹©çš„æ–‡æ¡£
      const userSelectedDocs = cleanedDocs.filter(doc => {
        // è¿™é‡Œåº”è¯¥æ£€æŸ¥ç”¨æˆ·çš„é€‰æ‹©ï¼Œä½†æš‚æ—¶é€šè¿‡æ›´æ–°æ—¶é—´åˆ¤æ–­
        const localDoc = localFullData.docs.find(d => d.id === doc.id);
        const cloudDoc = cloudFullData.docs.find(d => d.id === doc.id);
        if (localDoc && cloudDoc) {
          return localDoc.updatedAt >= cloudDoc.updatedAt; // é€‰æ‹©äº†è¾ƒæ–°çš„æœ¬åœ°ç‰ˆæœ¬
        }
        return !!localDoc; // åªæœ‰æœ¬åœ°æœ‰ï¼Œè¯´æ˜æ˜¯æœ¬åœ°æ–°å¢
      });
      console.log('[SYNC] ç”¨æˆ·é€‰æ‹©æœ¬åœ°æ–‡æ¡£æ•°é‡:', userSelectedDocs.length);
    }

    console.log('[SYNC] å‡†å¤‡ä¿å­˜åˆ°äº‘ç«¯çš„æ–‡æ¡£æ•°é‡:', cleanedDocs.length);
    if (cleanedDocs.length > 0) {
      console.log('[SYNC] ç¬¬ä¸€ä¸ªè¦ä¿å­˜çš„æ–‡æ¡£ç¤ºä¾‹:', {
        id: cleanedDocs[0].id,
        title: cleanedDocs[0].title,
        mdLength: cleanedDocs[0].md ? cleanedDocs[0].md.length : 0,
        updatedAt: cleanedDocs[0].updatedAt
      });
    }

    obj.set('docs', cleanedDocs);
    obj.set('aiConfig', target.aiConfig);
    obj.set('aiConfigHash', target.aiConfigHash);
    obj.set('configUpdatedAt', target.aiConfigLastModified);
    obj.set('promptTemplates', target.promptTemplates);
    obj.set('promptTemplatesHash', target.promptTemplatesHash);
    obj.set('templateUpdatedAt', target.promptTemplatesLastModified);
    obj.set('myPromptTemplates', target.myPromptTemplates);
    obj.set('myPromptTemplatesHash', target.myPromptTemplatesHash);
    obj.set('myPromptTemplateUpdatedAt', target.myPromptTemplateLastModified);
    obj.set('docUpdatedAt', Math.max(...mergedDocs.map(d => Number(d.updatedAt)), 0));
    obj.set('updatedAtMs', Date.now());   // è¡¥ä¸Šç»Ÿä¸€æ—¶é—´æˆ³

    // åŒæ­¥å›¾ç‰‡æ•°æ®åˆ°äº‘ç«¯
    // æ³¨æ„ï¼šå›¾ç‰‡åŒæ­¥å°†åœ¨ bidirectionalSync å‡½æ•°çš„æœ«å°¾é€šè¿‡ syncAllImages ç»Ÿä¸€å¤„ç†
    // è¿™é‡Œä¸å†å•ç‹¬è°ƒç”¨ syncImagesToCloudï¼Œé¿å…é‡å¤åŒæ­¥å¯¼è‡´çš„é—®é¢˜
    console.log('[SYNC] å›¾ç‰‡æ•°æ®å°†åœ¨åç»­ç»Ÿä¸€åŒæ­¥');

    console.log('[SYNC] å¼€å§‹ä¿å­˜æ•°æ®åˆ°äº‘ç«¯...');
    console.log('[SYNC] å‡†å¤‡ä¿å­˜çš„æ–‡æ¡£æ•°é‡:', cleanedDocs.length);
    if (cleanedDocs.length > 0) {
      console.log('[SYNC] ç¬¬ä¸€ä¸ªå‡†å¤‡ä¿å­˜çš„æ–‡æ¡£:', {
        id: cleanedDocs[0].id,
        title: cleanedDocs[0].title,
        mdLength: cleanedDocs[0].md ? cleanedDocs[0].md.length : 0,
        updatedAt: cleanedDocs[0].updatedAt
      });
    }

    // æ·»åŠ ä¿å­˜é‡è¯•æœºåˆ¶ï¼Œé¿å…ç½‘ç»œé—®é¢˜å¯¼è‡´åŒæ­¥å¤±è´¥
    let retryCount = 0;
    const maxRetries = 3;

    while (retryCount < maxRetries) {
      try {
        await obj.save();
        console.log('[SYNC] ç¬¬', retryCount + 1, 'æ¬¡ä¿å­˜æˆåŠŸ');
        break;
      } catch (saveError) {
        retryCount++;
        console.error('[SYNC] ç¬¬', retryCount, 'æ¬¡ä¿å­˜å¤±è´¥:', saveError.message);

        if (retryCount >= maxRetries) {
          throw new Error(`äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²é‡è¯•${maxRetries}æ¬¡: ${saveError.message}`);
        }

        // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));

        // é‡æ–°è·å–äº‘ç«¯å¯¹è±¡ï¼Œé¿å…ç‰ˆæœ¬å†²çª
        try {
          const freshCloudData = await downloadCloud();
          obj = freshCloudData.obj;
          console.log('[SYNC] é‡æ–°è·å–äº‘ç«¯å¯¹è±¡æˆåŠŸ');
        } catch (refreshError) {
          console.error('[SYNC] é‡æ–°è·å–äº‘ç«¯å¯¹è±¡å¤±è´¥:', refreshError.message);
        }
      }
    }

    // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
    const savedDocs = obj.get('docs');
    console.log('[SYNC] ä¿å­˜åéªŒè¯äº‘ç«¯æ–‡æ¡£æ•°é‡:', savedDocs ? savedDocs.length : 0);
    if (savedDocs && savedDocs.length > 0) {
      console.log('[SYNC] ä¿å­˜åéªŒè¯ç¬¬ä¸€ä¸ªæ–‡æ¡£:', {
        id: savedDocs[0].id,
        title: savedDocs[0].title,
        mdLength: savedDocs[0].md ? savedDocs[0].md.length : 0,
        updatedAt: savedDocs[0].updatedAt
      });
    }

    console.log('[SYNC] äº‘ç«¯åŒæ­¥å®Œæˆ');
  }




  // æ˜¾ç¤ºå†²çªç¡®è®¤å¯¹è¯æ¡†
  function showConflictDialog(conflicts) {
    if (!conflicts || conflicts.length === 0) return true;

    const conflictList = conflicts.map(conflict =>
      `æ–‡æ¡£ï¼š${conflict.title}\n` +
      `æœ¬åœ°ä¿®æ”¹æ—¶é—´ï¼š${new Date(conflict.localTime).toLocaleString()}\n` +
      `äº‘ç«¯ä¿®æ”¹æ—¶é—´ï¼š${new Date(conflict.cloudTime).toLocaleString()}\n`
    ).join('\n---\n\n');

    const message = `æ£€æµ‹åˆ° ${conflicts.length} ä¸ªæ½œåœ¨å†²çªï¼š\n\n${conflictList}\n` +
      'è¿™äº›æ–‡æ¡£åœ¨æœ¬åœ°å’Œäº‘ç«¯éƒ½æœ‰ä¿®æ”¹ï¼Œä¸”æ—¶é—´å¾ˆæ¥è¿‘ã€‚\n' +
      'ç»§ç»­åŒæ­¥å°†æŒ‰ç…§"è°æ–°ç”¨è°"çš„è§„åˆ™å¤„ç†ã€‚\n\n' +
      'æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ';

    return confirm(message);
  }

  function showInfo(msg) {
    try {
      if (window.showInfo) {
        window.showInfo(msg);
      } else {
        console.info('[SYNC]', msg);
      }
    } catch (e) {
      console.error('[SYNC] showInfo error:', e);
      alert(msg);
    }
  }

  function showSuccess(msg) {
    try {
      if (window.showSuccess) {
        window.showSuccess(msg);
      } else {
        console.info('[SYNC]', msg);
      }
    } catch (e) {
      console.error('[SYNC] showSuccess error:', e);
      alert(msg);
    }
  }

  function showError(msg) {
    try {
      if (window.showError) {
        window.showError(msg);
      } else {
        console.error('[SYNC]', msg);
        alert(msg); // ç¡®ä¿å³ä½¿é€šçŸ¥ç³»ç»ŸæœªåŠ è½½ä¹Ÿèƒ½æ˜¾ç¤ºé”™è¯¯
      }
    } catch (e) {
      console.error('[SYNC] showError error:', e);
      alert(msg); // ç¡®ä¿å³ä½¿é€šçŸ¥ç³»ç»Ÿå‡ºé”™ä¹Ÿèƒ½æ˜¾ç¤ºé”™è¯¯
    }
  }
  function applyLangUIOnce() { try { if (typeof window.__mw_applyLangToUI === 'function') window.__mw_applyLangToUI(); } catch (_) { } }

  async function fetchOrCreateRecord() {
    const user = AV.User.current();
    if (!user) throw new Error('æœªç™»å½•');
    const MWData = AV.Object.extend(CLASS_NAME);
    try {
      const query = new AV.Query(MWData);
      query.equalTo('ownerId', user.id);
      const list = await query.find();
      if (list && list.length > 0) return list[0];
    } catch (e) {
      // Class å°šæœªåˆ›å»ºæˆ–æ—  schemaï¼šå¿½ç•¥æŸ¥è¯¢é”™è¯¯ï¼Œç›´æ¥åˆ›å»º
    }
    const obj = new MWData();
    obj.set('ownerId', user.id);
    obj.set('docs', []);
    obj.set('aiConfig', {});
    obj.set('promptTemplates', []);
    obj.set('myPromptTemplates', []);
    obj.set('docUpdatedAt', Date.now()); // ä½¿ç”¨å½“å‰æ—¶é—´è€Œä¸æ˜¯0
    obj.set('configUpdatedAt', Date.now());
    obj.set('templateUpdatedAt', Date.now());
    obj.set('myPromptTemplateUpdatedAt', Date.now());
    return await obj.save();
  }


  async function downloadCloud() {
    const obj = await fetchOrCreateRecord();
    const docs = obj.get('docs') || [];
    const docUpdatedAt = obj.get('docUpdatedAt') || 0;
    const aiConfig = obj.get('aiConfig') || {};
    const promptTemplates = obj.get('promptTemplates') || [];
    const myPromptTemplates = obj.get('myPromptTemplates') || [];

    const configUpdatedAt = obj.get('configUpdatedAt') || 0;
    const templateUpdatedAt = obj.get('templateUpdatedAt') || 0;
    const myPromptTemplateUpdatedAt = obj.get('myPromptTemplateUpdatedAt') || 0;

    // æ–°å¢ï¼šè¡¥é½ä¸Šè¡Œæ—¶ä¼šå†™å…¥çš„å“ˆå¸Œä¸ç»Ÿä¸€æ—¶é—´æˆ³
    const aiConfigHash = obj.get('aiConfigHash') || undefined;
    const promptTemplatesHash = obj.get('promptTemplatesHash') || undefined;
    const myPromptTemplatesHash = obj.get('myPromptTemplatesHash') || undefined;

    const updatedAtMs = obj.get('updatedAtMs') || 0;

    return {
      obj,
      docs,
      aiConfig,
      promptTemplates,
      myPromptTemplates,
      docUpdatedAt,
      configUpdatedAt,
      templateUpdatedAt,
      myPromptTemplateUpdatedAt,
      aiConfigHash,        // æ–°å¢
      promptTemplatesHash, // æ–°å¢
      myPromptTemplatesHash, // æ–°å¢
      updatedAtMs          // æ–°å¢
    };
  }

  // è½åœ°ï¼šæœ¬åœ°ï¼ˆåŒæ­¥åç‰©ç†åˆ é™¤å·²æ ‡è®°æ–‡æ¡£ï¼‰
  function applyTargetToLocal(target) {
    // ç‰©ç†å‰”é™¤å·²åˆ é™¤æ–‡æ¡£
    const aliveDocs = target.docs.filter(d => !d.deletedAt);
    localStorage.setItem('mw_documents', JSON.stringify(aliveDocs));
    // AI é…ç½®
    localStorage.setItem('allAIPlatformConfigs', JSON.stringify(target.aiConfig));
    localStorage.setItem('allAIPlatformConfigs_hash', target.aiConfigHash);
    localStorage.setItem('allAIPlatformConfigs_last_modified', String(target.aiConfigLastModified));
    // æç¤ºè¯æ¨¡æ¿
    localStorage.setItem('promptTemplates', JSON.stringify(target.promptTemplates));
    localStorage.setItem('promptTemplates_hash', target.promptTemplatesHash);
    localStorage.setItem('promptTemplates_last_modified', String(target.promptTemplatesLastModified));
    // æˆ‘çš„æç¤ºè¯æ¨¡æ¿
    localStorage.setItem('myPromptTemplates', JSON.stringify(target.myPromptTemplates));
    localStorage.setItem('myPromptTemplates_hash', target.myPromptTemplatesHash);
    localStorage.setItem('myPromptTemplates_last_modified', String(target.myPromptTemplatesLastModified));
    // åŒæ­¥æ—¶é—´æˆ³
    localStorage.setItem('mindword_last_sync_at', String(Date.now()));

    // è§¦å‘å›¾ç‰‡æ•°æ®åŒæ­¥ï¼ŒåªåŒæ­¥æœ‰ä¿®æ”¹çš„æ–‡æ¡£ä¸­çš„å›¾ç‰‡
    // æ³¨æ„ï¼šæ•°æ®å°†åœ¨åç»­ç»Ÿä¸€åŒæ­¥åˆ°äº‘ç«¯ï¼Œè¿™é‡Œè·³è¿‡äº‘ç«¯ä¿å­˜é¿å…é‡å¤
    syncImagesAfterDataSync(aliveDocs, target.modifiedDocIds, true);
  }

  // æ•°æ®åŒæ­¥ååŒæ­¥å›¾ç‰‡
  async function syncImagesAfterDataSync(docs, modifiedDocIds = null, skipCloudSave = false) {
    if (!isLoggedIn() || !window.imageStorage) {
      console.log('[SYNC] è·³è¿‡å›¾ç‰‡åŒæ­¥ï¼šæœªç™»å½•æˆ–å›¾ç‰‡å­˜å‚¨æœªåˆå§‹åŒ–');
      return;
    }

    try {
      console.log('[SYNC] å¼€å§‹åŒæ­¥å›¾ç‰‡æ•°æ®...');

      // æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å·²ç»åŒ…å«base64å›¾ç‰‡æ•°æ®
      const hasBase64Images = docs.some(doc => {
        if (!doc || !doc.images || !Array.isArray(doc.images)) return false;
        return doc.images.some(img => img && img.dataUrl);
      });

      if (hasBase64Images) {
        console.log('[SYNC] æ–‡æ¡£å·²åŒ…å«base64å›¾ç‰‡æ•°æ®ï¼Œè·³è¿‡å•ç‹¬å›¾ç‰‡åŒæ­¥');
        console.log('[SYNC] base64å›¾ç‰‡è¯¦æƒ…:', docs.map(doc => ({
          id: doc.id,
          name: doc.name,
          hasImages: !!(doc.images && doc.images.length),
          base64Images: doc.images ? doc.images.filter(img => img && img.dataUrl).length : 0
        })).filter(doc => doc.base64Images > 0));
        return { uploaded: 0, downloaded: 0, message: 'æ–‡æ¡£å·²åŒ…å«base64å›¾ç‰‡æ•°æ®' };
      }

      const result = await syncAllImages(docs, null, modifiedDocIds, skipCloudSave);
      console.log('[SYNC] å›¾ç‰‡åŒæ­¥ç»“æœ:', result);
    } catch (error) {
      console.error('[SYNC] å›¾ç‰‡åŒæ­¥å¤±è´¥:', error);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“ä¸»è¦æ•°æ®åŒæ­¥
    }
  }

  // async function uploadCloud(obj, docs) {
  //   obj.set('docs', docs);
  //   obj.set('updatedAtMs', Date.now());
  //   return await obj.save();
  // }

  // æ˜¾ç¤ºåŒæ­¥é¢„è§ˆå¯¹è¯æ¡†
  async function showSyncPreviewDialog(localFullData, cloudFullData, targetFullData) {
    return new Promise((resolve) => {
      // åˆ›å»ºå¯¹è¯æ¡†HTML
      const dialog = document.createElement('div');
      dialog.id = 'sync-preview-dialog';
      dialog.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 1000px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: #333; font-size: 20px; font-weight: 600;"><span data-i18n="cloud.syncPreview">ğŸ”„ åŒæ­¥é¢„è§ˆ</span></h3>
              <div style="margin-left: auto; font-size: 12px; color: #666; background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">
                <span data-i18n="cloud.selectDataToKeep">é€‰æ‹©è¦ä¿ç•™çš„æ•°æ®</span>
              </div>
            </div>
            <div style="flex: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f5f5f5; position: sticky; top: 0; z-index: 10;">
                  <tr>
                    <th style="padding: 16px; text-align: center; border-bottom: 1px solid #ddd; width: 50%; color: #333; font-weight: 600; font-size: 14px;">
                      <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>ğŸ“</span>
                        <span data-i18n="cloud.localData">æœ¬åœ°æ•°æ®</span>
                      </span>
                    </th>
                    <th style="padding: 16px; text-align: center; border-bottom: 1px solid #ddd; width: 50%; color: #333; font-weight: 600; font-size: 14px;">
                      <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>â˜ï¸</span>
                        <span data-i18n="cloud.cloudData">äº‘ç«¯æ•°æ®</span>
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody id="sync-preview-tbody">
                </tbody>
              </table>
            </div>
            <div style="margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; align-items: center;">
              <div>
                <button id="sync-preview-cancel" style="margin-right: 12px; padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" data-i18n="docs.cancel">å–æ¶ˆ</button>
                <button id="sync-preview-confirm" style="padding: 10px 24px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);"><span data-i18n="cloud.confirmSync">ğŸ”„ ç¡®å®šåŒæ­¥</span></button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // åº”ç”¨å›½é™…åŒ–ç¿»è¯‘
      if (window.i18nManager && window.i18nManager.updatePageTranslations) {
        window.i18nManager.updatePageTranslations();
      }

      // ç”Ÿæˆå¯¹æ¯”æ•°æ®
      const tbody = document.getElementById('sync-preview-tbody');
      const comparisons = generateSyncComparisons(localFullData, cloudFullData, targetFullData);

      comparisons.forEach((item, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #eee';

        // å¦‚æœå†…å®¹ä¸€è‡´ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²èƒŒæ™¯ï¼Œç¦ç”¨é€‰æ‹©åŠŸèƒ½
        if (item.isContentSame) {
          row.style.backgroundColor = '#f0f0f0';
          row.style.opacity = '0.8';
        }

        // çŠ¶æ€ç®¡ç† - ä½¿ç”¨æ•°æ®å±æ€§å­˜å‚¨å½“å‰é€‰æ‹©
        row.dataset.choice = item.recommendLocal ? 'local' : 'cloud';

        // æœ¬åœ°æ•°æ®åˆ—
        const localCell = document.createElement('td');
        localCell.style.padding = '8px';
        localCell.style.verticalAlign = 'top';
        localCell.style.position = 'relative';
        localCell.style.cursor = 'pointer';
        localCell.style.transition = 'all 0.2s ease';
        localCell.style.width = '50%';

        const updateLocalCellStyle = () => {
          if (item.isContentSame) {
            // å†…å®¹ä¸€è‡´æ—¶ä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²æ ·å¼
            localCell.style.backgroundColor = '#e8e8e8';
            localCell.style.border = '1px solid #ccc';
            localCell.style.borderRadius = '6px';
            localCell.style.margin = '2px';
          } else {
            const isSelected = row.dataset.choice === 'local';
            localCell.style.backgroundColor = isSelected ? '#f0f8f0' : '#fafafa';
            localCell.style.border = isSelected ? '2px solid #28a745' : '1px solid #eee';
            localCell.style.borderRadius = '6px';
            localCell.style.margin = '2px';

            // æ›´æ–°å‹¾é€‰å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€
            const checkMark = localCell.querySelector('.check-mark');
            const cloudCheckMark = cloudCell.querySelector('.check-mark');
            if (checkMark && cloudCheckMark) {
              checkMark.style.display = isSelected ? 'block' : 'none';
              cloudCheckMark.style.display = !isSelected ? 'block' : 'none';
            }
          }
        };

        localCell.innerHTML = `
          <div style="font-weight: bold; color: #333; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
            <span>${item.local.name}</span>
            <span class="check-mark" style="color: #28a745; font-size: 16px; display: ${item.isContentSame ? 'none' : (row.dataset.choice === 'local' ? 'block' : 'none')};">âœ“</span>
          </div>
          <div style="font-size: 11px; color: #666; line-height: 1.3;">${item.local.description}</div>
          <div style="font-size: 11px; color: #999; margin-top: 2px;"><span data-i18n="cloud.updatedAt">æ›´æ–°æ—¶é—´</span>: ${item.local.updatedAt}</div>
        `;

        // ç‚¹å‡»æœ¬åœ°åˆ—é€‰æ‹©æœ¬åœ° - å†…å®¹ä¸€è‡´æ—¶ç¦ç”¨ç‚¹å‡»
        localCell.addEventListener('click', () => {
          if (item.isContentSame) return; // å†…å®¹ä¸€è‡´æ—¶ä¸å…è®¸åˆ‡æ¢
          row.dataset.choice = 'local';
          updateLocalCellStyle();
          updateCloudCellStyle();
        });

        // äº‘ç«¯æ•°æ®åˆ—
        const cloudCell = document.createElement('td');
        cloudCell.style.padding = '8px';
        cloudCell.style.verticalAlign = 'top';
        cloudCell.style.position = 'relative';
        cloudCell.style.cursor = 'pointer';
        cloudCell.style.transition = 'all 0.2s ease';
        cloudCell.style.width = '50%';

        const updateCloudCellStyle = () => {
          if (item.isContentSame) {
            // å†…å®¹ä¸€è‡´æ—¶ä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²æ ·å¼
            cloudCell.style.backgroundColor = '#e8e8e8';
            cloudCell.style.border = '1px solid #ccc';
            cloudCell.style.borderRadius = '6px';
            cloudCell.style.margin = '2px';
          } else {
            const isSelected = row.dataset.choice === 'cloud';
            cloudCell.style.backgroundColor = isSelected ? '#f0f8f0' : '#fafafa';
            cloudCell.style.border = isSelected ? '2px solid #28a745' : '1px solid #eee';
            cloudCell.style.borderRadius = '6px';
            cloudCell.style.margin = '2px';

            // æ›´æ–°å‹¾é€‰å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€
            const checkMark = cloudCell.querySelector('.check-mark');
            const localCheckMark = localCell.querySelector('.check-mark');
            if (checkMark && localCheckMark) {
              checkMark.style.display = isSelected ? 'block' : 'none';
              localCheckMark.style.display = !isSelected ? 'block' : 'none';
            }
          }
        };

        cloudCell.innerHTML = `
          <div style="font-weight: bold; color: #333; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
            <span>${item.cloud.name}</span>
            <span class="check-mark" style="color: #28a745; font-size: 16px; display: ${item.isContentSame ? 'none' : (row.dataset.choice === 'cloud' ? 'block' : 'none')};">âœ“</span>
          </div>
          <div style="font-size: 11px; color: #666; line-height: 1.3;">${item.cloud.description}</div>
          <div style="font-size: 11px; color: #999; margin-top: 2px;"><span data-i18n="cloud.updatedAt">æ›´æ–°æ—¶é—´</span>: ${item.cloud.updatedAt}</div>
        `;

        // ç‚¹å‡»äº‘ç«¯åˆ—é€‰æ‹©äº‘ç«¯ - å†…å®¹ä¸€è‡´æ—¶ç¦ç”¨ç‚¹å‡»
        cloudCell.addEventListener('click', () => {
          if (item.isContentSame) return; // å†…å®¹ä¸€è‡´æ—¶ä¸å…è®¸åˆ‡æ¢
          row.dataset.choice = 'cloud';
          updateLocalCellStyle();
          updateCloudCellStyle();
        });

        // åˆå§‹åŒ–æ ·å¼
        updateLocalCellStyle();
        updateCloudCellStyle();

        row.appendChild(localCell);
        row.appendChild(cloudCell);
        tbody.appendChild(row);
      });

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('sync-preview-cancel').addEventListener('click', () => {
        document.body.removeChild(dialog);
        resolve(null); // ç”¨æˆ·å–æ¶ˆ
      });

      document.getElementById('sync-preview-confirm').addEventListener('click', () => {
        const choices = {};
        comparisons.forEach((item, index) => {
          // ç›´æ¥ä»è¡Œæ•°æ®å±æ€§è·å–é€‰æ‹©çŠ¶æ€
          const row = document.querySelectorAll('#sync-preview-tbody tr')[index];
          choices[item.key] = row.dataset.choice || (item.recommendLocal ? 'local' : 'cloud');
        });

        document.body.removeChild(dialog);
        resolve(choices); // è¿”å›ç”¨æˆ·é€‰æ‹©
      });
    });
  }

  // ç”ŸæˆåŒæ­¥å¯¹æ¯”æ•°æ®
  function generateSyncComparisons(localFullData, cloudFullData, targetFullData) {
    const comparisons = [];

    // æ–‡æ¡£å¯¹æ¯”
    const localDocs = localFullData.docs || [];
    const cloudDocs = cloudFullData.docs || [];

    // è¿‡æ»¤æ‰è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£
    const filteredLocalDocs = localDocs.filter(doc => !isAutoGeneratedEmptyDoc(doc));
    const filteredCloudDocs = cloudDocs.filter(doc => !isAutoGeneratedEmptyDoc(doc));

    const localDocMap = new Map(filteredLocalDocs.map(d => [d.id, d]));
    const cloudDocMap = new Map(filteredCloudDocs.map(d => [d.id, d]));

    // æ‰¾å‡ºæ‰€æœ‰æ–‡æ¡£IDï¼ˆåªåŒ…å«è¿‡æ»¤åçš„æ–‡æ¡£ï¼‰
    const allDocIds = new Set([...filteredLocalDocs.map(d => d.id), ...filteredCloudDocs.map(d => d.id)]);

    allDocIds.forEach(docId => {
      const localDoc = localDocMap.get(docId);
      const cloudDoc = cloudDocMap.get(docId);

      if (localDoc && cloudDoc) {
        // ä¸¤è¾¹éƒ½æœ‰ - æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸€è‡´ï¼ˆåŒ…å«å›¾ç‰‡æ•°æ®ï¼‰
        const isContentSame = areDocsEqual(localDoc, cloudDoc);

        // ä¸ºäº†ç”Ÿæˆè¯¦ç»†çš„æè¿°ä¿¡æ¯ï¼Œå•ç‹¬æ£€æŸ¥MDå’Œå›¾ç‰‡
        const localImages = localDoc.images || [];
        const cloudImages = cloudDoc.images || [];
        const imagesEqual = areImagesEqual(localImages, cloudImages);
        const mdEqual = localDoc.md === cloudDoc.md;

        let description = '';

        if (isContentSame) {
          description = '<span style="color: #28a745;">å†…å®¹ä¸€è‡´ âœ“</span>';
        } else {
          if (mdEqual && !imagesEqual) {
            description = '<span style="color: #ffc107;">å›¾ç‰‡å·²å˜æ›´</span>';
          } else if (!mdEqual && imagesEqual) {
            description = '<span style="color: #dc3545;">å†…å®¹ä¸ä¸€è‡´</span>';
          } else {
            description = '<span style="color: #dc3545;">å†…å®¹å’Œå›¾ç‰‡éƒ½å·²å˜æ›´</span>';
          }
        }
        const localTime = new Date(Number(localDoc.updatedAt)).toLocaleString();
        const cloudTime = new Date(Number(cloudDoc.updatedAt)).toLocaleString();
        const recommendLocal = localDoc.updatedAt >= cloudDoc.updatedAt;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£è¢«åˆ é™¤
        const localDeleted = localDoc.deletedAt;
        const cloudDeleted = cloudDoc.deletedAt;

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: localDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: localDeleted ? '<span style="color: #dc3545;">æœ¬åœ°å·²åˆ é™¤æ–‡æ¡£</span>' : description,
            updatedAt: localTime
          },
          cloud: {
            name: cloudDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: cloudDeleted ? '<span style="color: #dc3545;">äº‘ç«¯å·²åˆ é™¤æ–‡æ¡£</span>' : description,
            updatedAt: cloudTime
          },
          recommendLocal: recommendLocal,
          isContentSame: isContentSame && !localDeleted && !cloudDeleted
        });
      } else if (localDoc && !cloudDoc) {
        // åªæœ‰æœ¬åœ°æœ‰ - åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯åˆ é™¤
        // å¦‚æœæœ¬åœ°æ–‡æ¡£å·²åˆ é™¤ï¼Œåˆ™è·³è¿‡è¿™ä¸ªå¯¹æ¯”ï¼ˆç©ºå¯¹ç©ºæ²¡æœ‰æ„ä¹‰ï¼‰
        if (localDoc.deletedAt) {
          return; // è·³è¿‡æœ¬åœ°å·²åˆ é™¤æ–‡æ¡£
        }

        const isRecentlyUpdated = localDoc.updatedAt > Date.now() - 24 * 60 * 60 * 1000; // 24å°æ—¶å†…æ›´æ–°è¿‡
        let description = '';

        if (isRecentlyUpdated) {
          description = '<span style="color: #28a745;">æœ¬åœ°æ–°å¢æ–‡æ¡£</span>';
        } else {
          description = '<span style="color: #28a745;">æœ¬åœ°ç‹¬æœ‰æ–‡æ¡£</span>';
        }

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: localDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: description,
            updatedAt: new Date(Number(localDoc.updatedAt)).toLocaleString()
          },
          cloud: {
            name: '(æ— )',
            description: 'äº‘ç«¯ä¸å­˜åœ¨',
            updatedAt: '-'
          },
          recommendLocal: true
        });
      } else if (!localDoc && cloudDoc) {
        // åªæœ‰äº‘ç«¯æœ‰ - åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯åˆ é™¤
        // å¦‚æœäº‘ç«¯æ–‡æ¡£å·²åˆ é™¤ï¼Œåˆ™è·³è¿‡è¿™ä¸ªå¯¹æ¯”ï¼ˆç©ºå¯¹ç©ºæ²¡æœ‰æ„ä¹‰ï¼‰
        if (cloudDoc.deletedAt) {
          return; // è·³è¿‡äº‘ç«¯å·²åˆ é™¤æ–‡æ¡£
        }

        const isRecentlyUpdated = cloudDoc.updatedAt > Date.now() - 24 * 60 * 60 * 1000; // 24å°æ—¶å†…æ›´æ–°è¿‡
        let description = '';

        if (isRecentlyUpdated) {
          description = '<span style="color: #28a745;">äº‘ç«¯æ–°å¢æ–‡æ¡£</span>';
        } else {
          description = '<span style="color: #28a745;">äº‘ç«¯ç‹¬æœ‰æ–‡æ¡£</span>';
        }

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: '(æ— )',
            description: 'æœ¬åœ°ä¸å­˜åœ¨',
            updatedAt: '-'
          },
          cloud: {
            name: cloudDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: description,
            updatedAt: new Date(Number(cloudDoc.updatedAt)).toLocaleString()
          },
          recommendLocal: false
        });
      }
    });

    // AIé…ç½®å¯¹æ¯”
    const localAIConfig = localFullData.aiConfig || {};
    const cloudAIConfig = cloudFullData.aiConfig || {};
    const localAIConfigTime = new Date(localFullData.aiConfigLastModified).toLocaleString();
    const cloudAIConfigTime = new Date(cloudFullData.aiConfigLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isAIConfigSame = localFullData.aiConfigHash === cloudFullData.aiConfigHash;

    // åˆ¤æ–­é…ç½®æ˜¯å¦ä¸ºç©º
    const localConfigEmpty = Object.keys(localAIConfig).length === 0;
    const cloudConfigEmpty = Object.keys(cloudAIConfig).length === 0;

    comparisons.push({
      key: 'ai_config',
      local: {
        name: 'AIå¹³å°é…ç½®',
        description: isAIConfigSame ? `é…ç½®ä¸€è‡´ âœ“ (å¹³å°æ•°é‡: ${Object.keys(localAIConfig).length}ä¸ª)` :
          localConfigEmpty ? 'æœ¬åœ°æ— é…ç½®' : `å¹³å°æ•°é‡: ${Object.keys(localAIConfig).length}ä¸ª`,
        updatedAt: localAIConfigTime
      },
      cloud: {
        name: 'AIå¹³å°é…ç½®',
        description: isAIConfigSame ? `é…ç½®ä¸€è‡´ âœ“ (å¹³å°æ•°é‡: ${Object.keys(cloudAIConfig).length}ä¸ª)` :
          cloudConfigEmpty ? 'äº‘ç«¯æ— é…ç½®' : `å¹³å°æ•°é‡: ${Object.keys(cloudAIConfig).length}ä¸ª`,
        updatedAt: cloudAIConfigTime
      },
      recommendLocal: localFullData.aiConfigLastModified >= cloudFullData.aiConfigLastModified,
      isContentSame: isAIConfigSame
    });

    // æç¤ºè¯æ¨¡æ¿å¯¹æ¯”
    const localPromptTemplates = localFullData.promptTemplates || [];
    const cloudPromptTemplates = cloudFullData.promptTemplates || [];
    const localPromptTime = new Date(localFullData.promptTemplatesLastModified).toLocaleString();
    const cloudPromptTime = new Date(cloudFullData.promptTemplatesLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isPromptTemplatesSame = localFullData.promptTemplatesHash === cloudFullData.promptTemplatesHash;

    // åˆ¤æ–­æ¨¡æ¿æ˜¯å¦ä¸ºç©º
    const localTemplatesEmpty = localPromptTemplates.length === 0;
    const cloudTemplatesEmpty = cloudPromptTemplates.length === 0;

    comparisons.push({
      key: 'prompt_templates',
      local: {
        name: 'æç¤ºè¯æ¨¡æ¿',
        description: isPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${localPromptTemplates.length}ä¸ª)` :
          localTemplatesEmpty ? 'æœ¬åœ°æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${localPromptTemplates.length}ä¸ª`,
        updatedAt: localPromptTime
      },
      cloud: {
        name: 'æç¤ºè¯æ¨¡æ¿',
        description: isPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${cloudPromptTemplates.length}ä¸ª)` :
          cloudTemplatesEmpty ? 'äº‘ç«¯æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${cloudPromptTemplates.length}ä¸ª`,
        updatedAt: cloudPromptTime
      },
      recommendLocal: localFullData.promptTemplatesLastModified >= cloudFullData.promptTemplatesLastModified,
      isContentSame: isPromptTemplatesSame
    });

    // æˆ‘çš„æç¤ºè¯æ¨¡æ¿å¯¹æ¯”
    const localMyPromptTemplates = localFullData.myPromptTemplates || [];
    const cloudMyPromptTemplates = cloudFullData.myPromptTemplates || [];
    const localMyPromptTime = new Date(localFullData.myPromptTemplatesLastModified).toLocaleString();
    const cloudMyPromptTime = new Date(cloudFullData.myPromptTemplatesLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isMyPromptTemplatesSame = localFullData.myPromptTemplatesHash === cloudFullData.myPromptTemplatesHash;

    // åˆ¤æ–­æ¨¡æ¿æ˜¯å¦ä¸ºç©º
    const localMyTemplatesEmpty = localMyPromptTemplates.length === 0;
    const cloudMyTemplatesEmpty = cloudMyPromptTemplates.length === 0;

    comparisons.push({
      key: 'my_prompt_templates',
      local: {
        name: 'æˆ‘çš„æç¤ºè¯æ¨¡æ¿',
        description: isMyPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${localMyPromptTemplates.length}ä¸ª)` :
          localMyTemplatesEmpty ? 'æœ¬åœ°æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${localMyPromptTemplates.length}ä¸ª`,
        updatedAt: localMyPromptTime
      },
      cloud: {
        name: 'æˆ‘çš„æç¤ºè¯æ¨¡æ¿',
        description: isMyPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${cloudMyPromptTemplates.length}ä¸ª)` :
          cloudMyTemplatesEmpty ? 'äº‘ç«¯æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${cloudMyPromptTemplates.length}ä¸ª`,
        updatedAt: cloudMyPromptTime
      },
      recommendLocal: localFullData.myPromptTemplatesLastModified >= cloudFullData.myPromptTemplatesLastModified,
      isContentSame: isMyPromptTemplatesSame
    });

    return comparisons;
  }

  // æ ¹æ®ç”¨æˆ·é€‰æ‹©é‡æ–°æ„å»ºç›®æ ‡æ•°æ®
  async function buildTargetFromChoices(localFullData, cloudFullData, choices) {
    const target = {
      docs: [],
      aiConfig: {},
      promptTemplates: [],
      myPromptTemplates: [],
      aiConfigHash: undefined,
      aiConfigLastModified: 0,
      promptTemplatesHash: undefined,
      promptTemplatesLastModified: 0,
      myPromptTemplatesHash: undefined,
      myPromptTemplatesLastModified: 0,
      lastSyncAt: Date.now(),
      modifiedDocIds: [] // è®°å½•æœ‰ä¿®æ”¹çš„æ–‡æ¡£ID
    };

    // å¤„ç†æ–‡æ¡£é€‰æ‹©
    const localDocs = localFullData.docs || [];
    const cloudDocs = cloudFullData.docs || [];
    const localDocMap = new Map(localDocs.map(d => [d.id, d]));
    const cloudDocMap = new Map(cloudDocs.map(d => [d.id, d]));
    const allDocIds = new Set([...localDocs.map(d => d.id), ...cloudDocs.map(d => d.id)]);

    for (const docId of allDocIds) {
      const choice = choices[`doc_${docId}`];
      let docToAdd = null;
      let isModified = false;

      // ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†æœ¬åœ°ç‰ˆæœ¬
      if (choice === 'local') {
        if (localDocMap.has(docId)) {
          docToAdd = localDocMap.get(docId);
          isModified = true; // ç”¨æˆ·æ˜ç¡®é€‰æ‹©ï¼Œè§†ä¸ºæœ‰ä¿®æ”¹
        }
        // å¦‚æœç”¨æˆ·é€‰æ‹©æœ¬åœ°ä½†æœ¬åœ°ä¸å­˜åœ¨è¯¥æ–‡æ¡£ï¼Œåˆ™ä¸æ·»åŠ ï¼ˆå³åˆ é™¤ï¼‰
      }
      // ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†äº‘ç«¯ç‰ˆæœ¬
      else if (choice === 'cloud') {
        if (cloudDocMap.has(docId)) {
          docToAdd = cloudDocMap.get(docId);
          isModified = true; // ç”¨æˆ·æ˜ç¡®é€‰æ‹©ï¼Œè§†ä¸ºæœ‰ä¿®æ”¹
        }
        // å¦‚æœç”¨æˆ·é€‰æ‹©äº‘ç«¯ä½†äº‘ç«¯ä¸å­˜åœ¨è¯¥æ–‡æ¡£ï¼Œåˆ™ä¸æ·»åŠ ï¼ˆå³åˆ é™¤ï¼‰
      }
      // ç”¨æˆ·æ²¡æœ‰é€‰æ‹©ï¼Œä½¿ç”¨æ¨èé€»è¾‘
      else {
        if (localDocMap.has(docId) && cloudDocMap.has(docId)) {
          // ä¸¤è¾¹éƒ½æœ‰ï¼Œé€‰æ‹©æ›´æ–°æ—¶é—´è¾ƒæ–°çš„
          const localDoc = localDocMap.get(docId);
          const cloudDoc = cloudDocMap.get(docId);
          const useLocal = localDoc.updatedAt >= cloudDoc.updatedAt;
          docToAdd = useLocal ? localDoc : cloudDoc;

          // å¦‚æœé€‰æ‹©äº†ä¸äº‘ç«¯ä¸åŒçš„ç‰ˆæœ¬ï¼Œåˆ™è§†ä¸ºæœ‰ä¿®æ”¹
          if ((useLocal && localDoc.updatedAt !== cloudDoc.updatedAt) ||
            (!useLocal && localDoc.updatedAt !== cloudDoc.updatedAt)) {
            isModified = true;
          }
        } else if (localDocMap.has(docId)) {
          // åªæœ‰æœ¬åœ°æœ‰ï¼Œä¿ç•™æœ¬åœ°ç‰ˆæœ¬
          docToAdd = localDocMap.get(docId);
          isModified = true; // æ–°å¢æ–‡æ¡£ï¼Œè§†ä¸ºæœ‰ä¿®æ”¹
        } else if (cloudDocMap.has(docId)) {
          // åªæœ‰äº‘ç«¯æœ‰ï¼Œä¿ç•™äº‘ç«¯ç‰ˆæœ¬
          docToAdd = cloudDocMap.get(docId);
          isModified = true; // æ–°å¢æ–‡æ¡£ï¼Œè§†ä¸ºæœ‰ä¿®æ”¹
        }
      }

      // æ·»åŠ æ–‡æ¡£å¹¶è®°å½•ä¿®æ”¹çŠ¶æ€
      if (docToAdd) {
        target.docs.push(await cleanDocImagesArray(docToAdd));
        if (isModified) {
          target.modifiedDocIds.push(docId);
        }
      }
    }

    // å¤„ç†AIé…ç½®é€‰æ‹©
    if (choices.ai_config === 'local') {
      target.aiConfig = localFullData.aiConfig || {};
      target.aiConfigHash = localFullData.aiConfigHash;
      target.aiConfigLastModified = localFullData.aiConfigLastModified;
    } else {
      target.aiConfig = cloudFullData.aiConfig || {};
      target.aiConfigHash = cloudFullData.aiConfigHash;
      target.aiConfigLastModified = cloudFullData.aiConfigLastModified;
    }

    // å¤„ç†æç¤ºè¯æ¨¡æ¿é€‰æ‹©
    if (choices.prompt_templates === 'local') {
      target.promptTemplates = localFullData.promptTemplates || [];
      target.promptTemplatesHash = localFullData.promptTemplatesHash;
      target.promptTemplatesLastModified = localFullData.promptTemplatesLastModified;
    } else {
      target.promptTemplates = cloudFullData.promptTemplates || [];
      target.promptTemplatesHash = cloudFullData.promptTemplatesHash;
      target.promptTemplatesLastModified = cloudFullData.promptTemplatesLastModified;
    }

    // å¤„ç†æˆ‘çš„æç¤ºè¯æ¨¡æ¿é€‰æ‹©
    if (choices.my_prompt_templates === 'local') {
      target.myPromptTemplates = localFullData.myPromptTemplates || [];
      target.myPromptTemplatesHash = localFullData.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = localFullData.myPromptTemplatesLastModified;
    } else {
      target.myPromptTemplates = cloudFullData.myPromptTemplates || [];
      target.myPromptTemplatesHash = cloudFullData.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloudFullData.myPromptTemplatesLastModified;
    }

    return target;
  }

  // æ–°çš„åŒæ­¥é€»è¾‘ï¼šæŒ‰ç…§ç”¨æˆ·æ–¹æ¡ˆå®ç°
  async function bidirectionalSync() {
    try {
      // æ·»åŠ è¯¦ç»†çš„ç™»å½•çŠ¶æ€æ£€æŸ¥
      if (!isLoggedIn()) {
        console.log('[SYNC] ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡åŒæ­¥');
        return; // æœªç™»å½•æ—¶ä¸æ‰§è¡ŒåŒæ­¥ï¼Œç›´æ¥è¿”å›
      }

      // è¾“å‡ºå½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
      const currentUser = AV.User.current();
      console.log('[SYNC] å¼€å§‹åŒæ­¥ï¼Œå½“å‰ç”¨æˆ·:', currentUser ? currentUser.id : 'null');
      console.log('[SYNC] LeanCloudåº”ç”¨ID:', AV.applicationId || 'æœªåˆå§‹åŒ–');

      showInfo('æ­£åœ¨æ™ºèƒ½åŒæ­¥...');

      // 1. ç»„è£…æœ¬åœ°å®Œæ•´å¿«ç…§
      const localDocs = getLocalDocs();
      console.log('[SYNC] è·å–åˆ°æœ¬åœ°æ–‡æ¡£æ•°é‡:', localDocs.length);
      if (localDocs.length > 0) {
        console.log('[SYNC] ç¬¬ä¸€ä¸ªæœ¬åœ°æ–‡æ¡£ç¤ºä¾‹:', {
          id: localDocs[0].id,
          title: localDocs[0].title,
          mdLength: localDocs[0].md ? localDocs[0].md.length : 0,
          updatedAt: localDocs[0].updatedAt
        });
      }

      const localAIConfig = getLocalAIConfig();
      const localPromptTemplates = getLocalPromptTemplates();
      const localMyPromptTemplates = getLocalMyPromptTemplates();
      const localFullData = {
        docs: localDocs,
        aiConfig: localAIConfig,
        aiConfigHash: localStorage.getItem('allAIPlatformConfigs_hash') || undefined,
        aiConfigLastModified: Number(localStorage.getItem('allAIPlatformConfigs_last_modified') || 0),
        promptTemplates: localPromptTemplates,
        promptTemplatesHash: localStorage.getItem('promptTemplates_hash') || undefined,
        promptTemplatesLastModified: Number(localStorage.getItem('promptTemplates_last_modified') || 0),
        myPromptTemplates: localMyPromptTemplates,
        myPromptTemplatesHash: localStorage.getItem('myPromptTemplates_hash') || undefined,
        myPromptTemplatesLastModified: Number(localStorage.getItem('myPromptTemplates_last_modified') || 0),
        lastSyncAt: Number(localStorage.getItem('mindword_last_sync_at') || 0)
      };

      console.log('[SYNC] åˆå¹¶åçš„ç›®æ ‡ç»“æ„:', {
        docsCount: localFullData.docs.length,
        aiConfigKeys: Object.keys(localFullData.aiConfig || {}),
        promptTemplatesCount: localFullData.promptTemplates.length,
        myPromptTemplatesCount: localFullData.myPromptTemplates.length,
        aiConfigHash: localFullData.aiConfigHash
      });

      // æ–‡ä»¶å¤§å°æ£€æŸ¥
      const sizeCheck = checkFileSize(localDocs);
      if (!sizeCheck.valid) {
        throw new Error('æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥ï¼š' + sizeCheck.errors.join('ï¼›'));
      }

      // 2. æ‹‰å–äº‘ç«¯åŒç»“æ„å¿«ç…§ï¼ˆæ¯æ¬¡éƒ½é‡æ–°è·å–æœ€æ–°æ•°æ®ï¼Œé¿å…ç¼“å­˜é—®é¢˜ï¼‰
      cachedCloudRaw = null;  // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è·å–
      const cloudFullData = await fetchCloudFullData();

      // ä¿å­˜äº‘ç«¯å¯¹è±¡å¼•ç”¨ï¼Œé¿å…åç»­é‡å¤ä¸‹è½½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
      const cloudObjRef = cachedCloudRaw;

      // 3. ä¸‰å‘åˆå¹¶ â†’ ç›®æ ‡ç»“æ„
      const targetFullData = await mergeToTarget(localFullData, cloudFullData);

      // 4. æ˜¾ç¤ºåŒæ­¥é¢„è§ˆå¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©ä¿ç•™å“ªä¸€ä¾§çš„æ•°æ®
      const userChoices = await showSyncPreviewDialog(localFullData, cloudFullData, targetFullData);

      // ç”¨æˆ·å–æ¶ˆåŒæ­¥
      if (!userChoices) {
        showInfo('åŒæ­¥å·²å–æ¶ˆ');
        return;
      }

      // 5. æ ¹æ®ç”¨æˆ·é€‰æ‹©é‡æ–°æ„å»ºç›®æ ‡æ•°æ®
      const finalTargetFullData = await buildTargetFromChoices(localFullData, cloudFullData, userChoices);

      // 6. è½åœ°ï¼šå…ˆå†™æœ¬åœ°ï¼Œå†å†™äº‘ç«¯ï¼ˆç¡®ä¿æœ¬åœ°ä¼˜å…ˆï¼‰
      console.log('[SYNC] å¼€å§‹åº”ç”¨åŒæ­¥æ•°æ®...');
      applyTargetToLocal(finalTargetFullData);

      // ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„äº‘ç«¯å¯¹è±¡å¼•ç”¨ï¼Œé¿å…é‡æ–°ä¸‹è½½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
      if (!cloudObjRef) {
        throw new Error('äº‘ç«¯å¯¹è±¡å¼•ç”¨ä¸¢å¤±ï¼ŒåŒæ­¥å¤±è´¥');
      }
      await applyTargetToCloud(finalTargetFullData, cloudFullData, cloudObjRef.obj, localFullData);
      console.log('[SYNC] åŒæ­¥æ•°æ®å·²æˆåŠŸåº”ç”¨åˆ°äº‘ç«¯');

      // 6.5 åŒæ­¥å›¾ç‰‡æ•°æ® - åªåŒæ­¥æœ‰ä¿®æ”¹çš„æ–‡æ¡£ä¸­çš„å›¾ç‰‡
      // ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„äº‘ç«¯å¯¹è±¡å¼•ç”¨ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
      // æ³¨æ„ï¼šæ•°æ®å·²ç»åœ¨ applyTargetToCloud ä¸­ä¿å­˜ï¼Œè¿™é‡Œè·³è¿‡äº‘ç«¯ä¿å­˜é¿å…é‡å¤
      await syncAllImages(finalTargetFullData.docs, cloudObjRef, finalTargetFullData.modifiedDocIds, true);

      // 5. åˆ·æ–° UI
      if (typeof mw_renderList === 'function') mw_renderList();

      // 6. å¦‚æœå½“å‰æœ‰æ­£åœ¨ç¼–è¾‘çš„æ–‡æ¡£ï¼Œåˆ·æ–°æ•°æ®å±•ç¤º
      if (typeof mw_getActive === 'function' && typeof mw_notifyEditorLoad === 'function') {
        const activeId = mw_getActive();
        if (activeId && typeof mw_loadDocs === 'function') {
          const docs = mw_loadDocs();
          const currentDoc = docs.find(d => d.id === activeId);
          if (currentDoc) {
            // åˆ·æ–°å½“å‰æ–‡æ¡£åˆ°å„ä¸ªé¢æ¿
            mw_notifyEditorLoad(currentDoc);
            if (typeof mw_notifyPreviewLoad === 'function') mw_notifyPreviewLoad(currentDoc);
            if (typeof mw_notifyMindmapLoad === 'function') mw_notifyMindmapLoad(currentDoc);
            console.log('[SYNC] å·²åˆ·æ–°å½“å‰ç¼–è¾‘æ–‡æ¡£:', activeId);
          }
        }

        // æ£€æŸ¥å½“å‰æ–‡æ¡£æ˜¯å¦è¢«åˆ é™¤ï¼Œå¦‚æœæ˜¯åˆ™åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
        const currentActiveId = mw_getActive();
        if (currentActiveId) {
          const docs = getLocalDocs();
          const currentDoc = docs.find(d => d.id === currentActiveId);
          if (!currentDoc || currentDoc.deletedAt) {
            console.log('[SYNC] å½“å‰æ–‡æ¡£å·²è¢«åˆ é™¤ï¼Œå‡†å¤‡åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£');
            // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœªåˆ é™¤çš„æ–‡æ¡£
            const firstValidDoc = docs.find(d => !d.deletedAt);
            if (firstValidDoc) {
              mw_setActive(firstValidDoc.id);
              mw_notifyEditorLoad(firstValidDoc);
              mw_notifyPreviewLoad(firstValidDoc);
              mw_notifyMindmapLoad(firstValidDoc);
              console.log('[SYNC] å·²åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£:', firstValidDoc.id);
            } else {
              // æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆç©ºæ–‡æ¡£ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨åˆ›å»º
              console.log('[SYNC] æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨åˆ›å»º');
            }
          }
        }
      }

      // 7. åŒæ­¥å®Œæˆåï¼Œå¦‚æœå½“å‰æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
      setTimeout(() => {
        const currentActiveId = mw_getActive();
        if (currentActiveId && typeof mw_loadDocs === 'function') {
          const docs = mw_loadDocs();
          const currentDoc = docs.find(d => d.id === currentActiveId);

          // å¦‚æœå½“å‰æ–‡æ¡£æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
          if (currentDoc && isAutoGeneratedEmptyDoc(currentDoc)) {
            console.log('[SYNC] å½“å‰æ–‡æ¡£æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œå‡†å¤‡åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£');
            const validDocs = docs.filter(d => !d.deletedAt && !isAutoGeneratedEmptyDoc(d));
            if (validDocs.length > 0) {
              const firstValidDoc = validDocs[0];
              mw_setActive(firstValidDoc.id);
              mw_notifyEditorLoad(firstValidDoc);
              mw_notifyPreviewLoad(firstValidDoc);
              mw_notifyMindmapLoad(firstValidDoc);
              console.log('[SYNC] å·²åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£:', firstValidDoc.id);
            } else {
              console.log('[SYNC] æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œä¿æŒå½“å‰ç©ºæ–‡æ¡£çŠ¶æ€');
            }
          }
        }
      }, 200);
      // ç¼“å­˜åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ï¼ˆä¸­æ–‡ç‰ˆä½¿ç”¨ç‹¬ç«‹ç¼“å­˜é”®ï¼‰
      try {
        const docs = getLocalDocs();
        const fileCount = docs ? docs.length : 0;
        localStorage.setItem('mw_cloud_sync_cache_cn', JSON.stringify({
          fileCount: fileCount,
          sizeBytes: sizeCheck.totalSize,
          updatedAt: new Date().toISOString()
        }));
      } catch (_) { }

      showSuccess('åŒæ­¥å®Œæˆ');
      setTimeout(updateSyncStatus, 300);
    } catch (e) {
      // å¢å¼ºé”™è¯¯å¤„ç†ï¼Œç¡®ä¿ç™»å½•åç¬¬ä¸€æ¬¡åŒæ­¥å¤±è´¥èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤º
      const errorMsg = e.message || 'åŒæ­¥å¤±è´¥';
      console.error('[SYNC] åŒæ­¥å¤±è´¥:', errorMsg, e);

      // æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•åçš„ç¬¬ä¸€æ¬¡åŒæ­¥
      const isJustLoggedIn = localStorage.getItem('mw_just_logged_in') === 'true';
      if (isJustLoggedIn) {
        // å¦‚æœæ˜¯ç™»å½•åç¬¬ä¸€æ¬¡åŒæ­¥å¤±è´¥ï¼Œæ¸…é™¤æ ‡è®°å¹¶æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        localStorage.removeItem('mw_just_logged_in');
        const detailedErrorMsg = `ç™»å½•åé¦–æ¬¡åŒæ­¥å¤±è´¥: ${errorMsg}`;
        showError(detailedErrorMsg);
      } else {
        showError(errorMsg);
      }

      // ç¡®ä¿é”™è¯¯ä¿¡æ¯èƒ½å¤Ÿè¢«ç”¨æˆ·çœ‹åˆ°
      setTimeout(() => {
        // å¦‚æœé€šçŸ¥ç³»ç»Ÿä»æœªåŠ è½½ï¼Œä½¿ç”¨åŸç”Ÿalertç¡®ä¿ç”¨æˆ·çœ‹åˆ°é”™è¯¯
        if (!window.showError) {
          alert(`åŒæ­¥å¤±è´¥: ${errorMsg}`);
        }
      }, 1000);
    }
  }

  async function clearCloud() {
    try {
      if (!isLoggedIn()) { throw new Error('æœªç™»å½•'); }
      if (!confirm('ç¡®è®¤æ¸…ç©ºäº‘ç«¯æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€')) return;
      const { obj } = await downloadCloud();

      // æ¸…ç©ºæ‰€æœ‰æ•°æ®
      obj.set('docs', []);
      obj.set('aiConfig', {});
      obj.set('promptTemplates', []);
      obj.set('myPromptTemplates', []);
      obj.set('docUpdatedAt', Date.now());
      obj.set('configUpdatedAt', Date.now());
      obj.set('templateUpdatedAt', Date.now());
      obj.set('myPromptTemplateUpdatedAt', Date.now());

      await obj.save();
      showSuccess('äº‘ç«¯æ•°æ®å·²æ¸…ç©º');
    } catch (e) {
      showError(e.message || 'æ¸…ç©ºå¤±è´¥');
    }
  }

  function initUIBindings() {
    // è·å–èœå•ä¸­çš„åŒæ­¥æ§åˆ¶åŒºåŸŸ
    const zhCtrls = document.getElementById('lc-sync-controls-menu');

    // ä¸ªäººèœå•ä¸­çš„æŒ‰é’®
    const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
    const menuClearBtn = document.getElementById('lc-clear-btn-menu');

    // ç»‘å®šä¸ªäººèœå•æŒ‰é’® - ä½¿ç”¨addEventListenerç¡®ä¿å‡½æ•°å¯è®¿é—®
    if (menuSyncBtn) {
      console.log('æ‰¾åˆ°åŒæ­¥æŒ‰é’®ï¼Œç»‘å®šç‚¹å‡»äº‹ä»¶');
      menuSyncBtn.addEventListener('click', function (e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
        console.log('åŒæ­¥æŒ‰é’®è¢«ç‚¹å‡»');
        bidirectionalSync();
      });
    } else {
      console.error('æœªæ‰¾åˆ°åŒæ­¥æŒ‰é’® lc-sync-btn-menu');
    }

    if (menuClearBtn) {
      menuClearBtn.addEventListener('click', function (e) {
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
        clearCloud();
      });
    }

    // ç™»å½•çŠ¶æ€æˆ–è¯­è¨€å˜åŒ–æ—¶åˆ‡æ¢æ˜¾ç¤º
    function refreshVisible() {
      const authUser = document.getElementById('auth-user');
      // æœªç™»å½•ï¼šéšè—åŒæ­¥æ§åˆ¶åŒºåŸŸï¼Œé¿å…åˆæ¬¡é—ªç°
      if (!authUser || authUser.style.display === 'none') {
        if (zhCtrls) zhCtrls.style.display = 'none';
        return;
      }
      // å§‹ç»ˆæ˜¾ç¤ºä¸­æ–‡åŒæ­¥æ§åˆ¶åŒºåŸŸï¼Œä¸å—è¯­è¨€è®¾ç½®å½±å“
      if (zhCtrls) zhCtrls.style.display = 'flex';
    }

    document.addEventListener('DOMContentLoaded', refreshVisible);
    window.addEventListener('storage', function (e) {
      if (e.key === LANG_KEY || (e.key && e.key.startsWith('AV/'))) setTimeout(refreshVisible, 50);
    });
    // æä¾›ç»™å¤–éƒ¨åœ¨è®¤è¯åŒºå˜åŒ–ååˆ·æ–°
    window.__mw_refreshSyncLangUI = refreshVisible;

    // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
    setTimeout(updateSyncStatus, 500);
  }

  // é¡µé¢å°±ç»ªååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function () {
    initUIBindings();
    // å°è¯•åœ¨è®¤è¯åŒºåˆ·æ–°ååº”ç”¨ä¸€æ¬¡
    setTimeout(applyLangUIOnce, 300);

    // ç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°çŠ¶æ€
    if (typeof mw_getDocs === 'function') {
      // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–
      window.addEventListener('storage', function (e) {
        if (e.key && e.key.includes('doc')) {
          setTimeout(updateSyncStatus, 100);
        }
      });

      // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
      setInterval(updateSyncStatus, 30000);
    }

    // åˆå§‹åŒ–ä¸ªäººèœå•çŠ¶æ€
    setTimeout(() => {
      updateSyncStatus();
      // åˆå§‹åŒ–ä¸ªäººèœå•çŠ¶æ€
      updateSyncStatus();
    }, 100);
  });

  // é¢å¤–çš„åˆå§‹åŒ–å°è¯•ï¼Œç¡®ä¿æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ
  setTimeout(function () {
    console.log('é¢å¤–å°è¯•ç»‘å®šåŒæ­¥æŒ‰é’®äº‹ä»¶');
    const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
    if (menuSyncBtn && !menuSyncBtn.hasAttribute('data-sync-bound')) {
      console.log('æ‰¾åˆ°æœªç»‘å®šçš„åŒæ­¥æŒ‰é’®ï¼Œè¿›è¡Œç»‘å®š');
      menuSyncBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        console.log('åŒæ­¥æŒ‰é’®è¢«ç‚¹å‡»ï¼ˆé¢å¤–ç»‘å®šï¼‰');
        bidirectionalSync();
      });
      menuSyncBtn.setAttribute('data-sync-bound', 'true');
    }
  }, 2000);

  // æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’ŒåŒæ­¥çŠ¶æ€
  function updateSyncStatus() {
    try {
      // è·å–å½“å‰è¯­è¨€
      const currentLang = getLang();
      const t = window.i18nManager ? window.i18nManager.getTranslation : null;

      // è·å–ç¿»è¯‘æ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
      function getText(key, fallback) {
        if (t && t.call) {
          return t.call(window.i18nManager, key) || fallback;
        }
        return fallback;
      }

      // ä½¿ç”¨ä¸­æ–‡ç¼“å­˜é”®ï¼ˆä¿æŒä¸å˜ï¼‰
      const cacheKey = 'mw_cloud_sync_cache_cn';

      // é¦–å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®
      let cachedData = null;
      try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          cachedData = JSON.parse(cached);
        }
      } catch (_) { }

      // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®
      if (cachedData && cachedData.fileCount !== undefined && cachedData.sizeBytes !== undefined) {
        const fileCount = cachedData.fileCount || 0;
        const sizeBytes = cachedData.sizeBytes || 0;
        const totalSizeKB = (sizeBytes / 1024).toFixed(1);
        const updatedAt = cachedData.updatedAt || cachedData.timestamp;

        // è®¡ç®—ç›¸å¯¹æ—¶é—´
        let timeText = '';
        if (updatedAt) {
          const date = new Date(updatedAt);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) {
            timeText = getText('cloud.justNow', currentLang === 'en' ? 'Just now' : 'åˆšåˆš');
          } else if (diffMins < 60) {
            if (currentLang === 'en') {
              timeText = `${diffMins} ${getText('cloud.minutesAgo', 'minutes ago')}`;
            } else {
              timeText = `${diffMins}${getText('cloud.minutesAgo', 'åˆ†é’Ÿå‰')}`;
            }
          } else if (diffHours < 24) {
            if (currentLang === 'en') {
              timeText = `${diffHours} ${getText('cloud.hoursAgo', 'hours ago')}`;
            } else {
              timeText = `${diffHours}${getText('cloud.hoursAgo', 'å°æ—¶å‰')}`;
            }
          } else if (diffDays < 7) {
            if (currentLang === 'en') {
              timeText = `${diffDays} ${getText('cloud.daysAgo', 'days ago')}`;
            } else {
              timeText = `${diffDays}${getText('cloud.daysAgo', 'å¤©å‰')}`;
            }
          } else {
            timeText = date.toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', { month: 'short', day: 'numeric' });
          }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸»ç•Œé¢ï¼‰
        const statusElement = document.getElementById('lc-sync-status');
        if (statusElement) {
          if (currentLang === 'en') {
            // è‹±æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨æ›´ç®€æ´çš„æ ¼å¼
            statusElement.innerHTML = `
              <small style="color: #666; font-size: 11px;">
                ${fileCount} files<br>${totalSizeKB}KB / 10MB${timeText ? '<br>' + timeText : ''}
              </small>
            `;
          } else {
            // ä¸­æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨ä¸­æ–‡æ ¼å¼
            const filesText = getText('cloud.files', 'æ–‡ä»¶');
            const backupText = getText('cloud.backupTime', 'å¤‡ä»½');
            const fileCountText = `${fileCount}${getText('cloud.fileCount', 'ä¸ª')}`;
            statusElement.innerHTML = `
              <small style="color: #666; font-size: 11px;">
                ${filesText}: ${fileCountText}<br>${totalSizeKB}KB / 10MB${timeText ? '<br>' + backupText + ': ' + timeText : ''}
              </small>
            `;
          }

          // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
          if (sizeBytes > 8 * 1024 * 1024) { // è¶…è¿‡8MB
            statusElement.querySelector('small').style.color = '#e74c3c';
          } else if (sizeBytes > 5 * 1024 * 1024) { // è¶…è¿‡5MB
            statusElement.querySelector('small').style.color = '#f39c12';
          }
        }

        // æ›´æ–°ä¸ªäººèœå•ä¸­çš„çŠ¶æ€æ˜¾ç¤º
        const menuStatusElement = document.getElementById('lc-sync-status-menu');
        if (menuStatusElement) {
          if (currentLang === 'en') {
            // è‹±æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨æ›´ç®€æ´çš„æ ¼å¼
            menuStatusElement.innerHTML = `${fileCount} files<br>${totalSizeKB}KB / 10MB${timeText ? '<br>' + timeText : ''}`;
          } else {
            // ä¸­æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨ä¸­æ–‡æ ¼å¼
            const filesText = getText('cloud.files', 'æ–‡ä»¶');
            const backupText = getText('cloud.backupTime', 'å¤‡ä»½');
            const fileCountText = `${fileCount}${getText('cloud.fileCount', 'ä¸ª')}`;
            menuStatusElement.innerHTML = `${filesText}: ${fileCountText}<br>${totalSizeKB}KB / 10MB${timeText ? '<br>' + backupText + ': ' + timeText : ''}`;
          }

          // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
          if (sizeBytes > 8 * 1024 * 1024) { // è¶…è¿‡8MB
            menuStatusElement.style.color = '#e74c3c';
          } else if (sizeBytes > 5 * 1024 * 1024) { // è¶…è¿‡5MB
            menuStatusElement.style.color = '#f39c12';
          } else {
            menuStatusElement.style.color = '#9ca3af';
          }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        // æ³¨æ„ï¼šä¸»ç•Œé¢çš„åŒæ­¥æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä»£ç è¢«æ³¨é‡Šæ‰
        // const syncBtn = document.getElementById('lc-sync-btn');
        // if (syncBtn) {
        //   syncBtn.disabled = false;
        //   syncBtn.title = getText('cloud.oneClickSync', 'ä¸€é”®åŒæ­¥');
        //   syncBtn.style.opacity = '1';
        // }

        // æ›´æ–°ä¸ªäººèœå•ä¸­çš„åŒæ­¥æŒ‰é’®çŠ¶æ€
        const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
        if (menuSyncBtn) {
          menuSyncBtn.disabled = false;
          menuSyncBtn.title = getText('cloud.oneClickSync', 'ä¸€é”®åŒæ­¥');
          menuSyncBtn.style.opacity = '1';
        }

        return;
      }

      // å¦‚æœæ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨åŸæœ‰çš„æœ¬åœ°æ•°æ®é€»è¾‘
      const docs = getLocalDocs();
      // è¿‡æ»¤æ‰å·²åˆ é™¤çš„æ–‡æ¡£ï¼Œåªç»Ÿè®¡æœ‰æ•ˆæ–‡æ¡£
      const validDocs = docs ? docs.filter(doc => !doc.deletedAt) : [];
      const sizeCheck = checkFileSize(validDocs);

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸»ç•Œé¢ï¼‰
      // æ³¨æ„ï¼šä¸»ç•Œé¢çš„çŠ¶æ€æ˜¾ç¤ºå…ƒç´ ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä»£ç è¢«æ³¨é‡Šæ‰
      // const statusElement = document.getElementById('lc-sync-status');
      // if (statusElement) {
      //   const totalSizeMB = (sizeCheck.totalSize / 1024).toFixed(1);
      //   const fileCount = validDocs.length;

      //   if (currentLang === 'en') {
      //     // è‹±æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨æ›´ç®€æ´çš„æ ¼å¼
      //     statusElement.innerHTML = `
      //       <small style="color: #666; font-size: 11px;">
      //         ${fileCount} files<br>${totalSizeMB}KB / 10MB
      //       </small>
      //     `;
      //   } else {
      //     // ä¸­æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨ä¸­æ–‡æ ¼å¼
      //     const filesText = getText('cloud.files', 'æ–‡ä»¶');
      //     const fileCountText = `${fileCount}${getText('cloud.fileCount', 'ä¸ª')}`;
      //     statusElement.innerHTML = `
      //       <small style="color: #666; font-size: 11px;">
      //         ${filesText}: ${fileCountText}<br>${totalSizeMB}KB / 10MB
      //       </small>
      //     `;
      //   }

      //   // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
      //   if (sizeCheck.totalSize > 8 * 1024 * 1024) { // è¶…è¿‡8MB
      //     statusElement.querySelector('small').style.color = '#e74c3c';
      //   } else if (sizeCheck.totalSize > 5 * 1024 * 1024) { // è¶…è¿‡5MB
      //     statusElement.querySelector('small').style.color = '#f39c12';
      //   }
      // }

      // æ›´æ–°ä¸ªäººèœå•ä¸­çš„çŠ¶æ€æ˜¾ç¤º
      const menuStatusElement = document.getElementById('lc-sync-status-menu');
      if (menuStatusElement) {
        const totalSizeMB = (sizeCheck.totalSize / 1024).toFixed(1);
        const fileCount = validDocs.length;

        if (currentLang === 'en') {
          // è‹±æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨æ›´ç®€æ´çš„æ ¼å¼
          menuStatusElement.innerHTML = `${fileCount} files<br>${totalSizeMB}KB / 10MB`;
        } else {
          // ä¸­æ–‡ç¯å¢ƒä¸‹ä½¿ç”¨ä¸­æ–‡æ ¼å¼
          const filesText = getText('cloud.files', 'æ–‡ä»¶');
          const fileCountText = `${fileCount}${getText('cloud.fileCount', 'ä¸ª')}`;
          menuStatusElement.innerHTML = `${filesText}: ${fileCountText}<br>${totalSizeMB}KB / 10MB`;
        }

        // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
        if (sizeCheck.totalSize > 8 * 1024 * 1024) { // è¶…è¿‡8MB
          menuStatusElement.style.color = '#e74c3c';
        } else if (sizeCheck.totalSize > 5 * 1024 * 1024) { // è¶…è¿‡5MB
          menuStatusElement.style.color = '#f39c12';
        } else {
          menuStatusElement.style.color = '#9ca3af';
        }
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      // æ³¨æ„ï¼šä¸»ç•Œé¢çš„åŒæ­¥æŒ‰é’®ä¸å­˜åœ¨ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ä»£ç è¢«æ³¨é‡Šæ‰
      // const syncBtn = document.getElementById('lc-sync-btn');
      // if (syncBtn) {
      //   if (!sizeCheck.valid) {
      //     syncBtn.disabled = true;
      //     syncBtn.title = getText('cloud.fileSizeCheckFailed', 'æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥') + 'ï¼š' + sizeCheck.errors.join('ï¼›');
      //     syncBtn.style.opacity = '0.6';
      //   } else {
      //     syncBtn.disabled = false;
      //     syncBtn.title = getText('cloud.oneClickSync', 'ä¸€é”®åŒæ­¥');
      //     syncBtn.style.opacity = '1';
      //   }
      // }

      // æ›´æ–°ä¸ªäººèœå•ä¸­çš„åŒæ­¥æŒ‰é’®çŠ¶æ€
      const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
      if (menuSyncBtn) {
        if (!sizeCheck.valid) {
          menuSyncBtn.disabled = true;
          menuSyncBtn.title = getText('cloud.fileSizeCheckFailed', 'æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥') + 'ï¼š' + sizeCheck.errors.join('ï¼›');
          menuSyncBtn.style.opacity = '0.6';
        } else {
          menuSyncBtn.disabled = false;
          menuSyncBtn.title = getText('cloud.oneClickSync', 'ä¸€é”®åŒæ­¥');
          menuSyncBtn.style.opacity = '1';
        }
      }

    } catch (error) {
      console.warn('æ›´æ–°åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
    }
  }

  // ======== å›¾ç‰‡åŒæ­¥ç›¸å…³å‡½æ•° ========

  /**
   * åŒæ­¥æŒ‡å®šæ–‡æ¡£çš„å›¾ç‰‡
   * @param {string} docId - æ–‡æ¡£ID
   * @returns {Promise<Object>} åŒæ­¥ç»“æœ
   */
  async function syncImagesForDoc(docId) {
    if (!isLoggedIn()) {
      throw new Error('æœªç™»å½•ï¼Œæ— æ³•åŒæ­¥å›¾ç‰‡');
    }

    if (!window.imageStorage) {
      throw new Error('å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–');
    }

    try {
      showInfo('æ­£åœ¨åŒæ­¥æ–‡æ¡£å›¾ç‰‡...');

      // è·å–æœ¬åœ°æ–‡æ¡£
      const docs = getLocalDocs();
      const doc = docs.find(d => d.id === docId);
      if (!doc) {
        throw new Error('æ–‡æ¡£ä¸å­˜åœ¨');
      }

      // ä»æ–‡æ¡£å†…å®¹ä¸­æå–å›¾ç‰‡ID
      const imageIds = extractImageIdsFromDoc(doc);
      if (imageIds.length === 0) {
        return { uploaded: 0, downloaded: 0, message: 'æ–‡æ¡£ä¸­æ²¡æœ‰å›¾ç‰‡éœ€è¦åŒæ­¥' };
      }

      // è·å–æœ¬åœ°å›¾ç‰‡
      const localImagesMap = await window.imageStorage.getImagesMap();
      const localImageIds = Array.from(localImagesMap.keys());

      // è·å–äº‘ç«¯æ•°æ®
      const cloudData = await downloadCloud();
      const cloudDocs = cloudData.docs || [];

      // æ‰¾åˆ°å¯¹åº”çš„äº‘ç«¯æ–‡æ¡£
      const cloudDoc = cloudDocs.find(d => d.id === docId);
      if (!cloudDoc) {
        throw new Error('äº‘ç«¯æœªæ‰¾åˆ°å¯¹åº”æ–‡æ¡£');
      }

      // è·å–äº‘ç«¯æ–‡æ¡£ä¸­çš„å›¾ç‰‡
      const cloudDocImages = cloudDoc.images || [];
      const cloudImageIds = cloudDocImages.map(img => img && img.id).filter(Boolean);

      // è®¡ç®—éœ€è¦ä¸Šä¼ å’Œä¸‹è½½çš„å›¾ç‰‡
      const imagesToUpload = imageIds.filter(id => !cloudImageIds.includes(id) && localImageIds.includes(id));
      const imagesToDownload = imageIds.filter(id => cloudImageIds.includes(id) && !localImageIds.includes(id));

      let uploaded = 0;
      let downloaded = 0;

      // ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°äº‘ç«¯
      if (imagesToUpload.length > 0) {
        const uploadResult = await uploadLocalImages(imagesToUpload);
        uploaded = uploadResult.uploaded;
      }

      // ä»äº‘ç«¯ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°
      if (imagesToDownload.length > 0) {
        const downloadResult = await downloadCloudImages(imagesToDownload);
        downloaded = downloadResult.downloaded;
      }

      showSuccess(`å›¾ç‰‡åŒæ­¥å®Œæˆï¼šä¸Šä¼ ${uploaded}å¼ ï¼Œä¸‹è½½${downloaded}å¼ `);
      return { uploaded, downloaded, message: 'å›¾ç‰‡åŒæ­¥å®Œæˆ' };
    } catch (error) {
      showError(`å›¾ç‰‡åŒæ­¥å¤±è´¥ï¼š${error.message}`);
      throw error;
    }
  }

  /**
   * ä»æ–‡æ¡£å†…å®¹ä¸­æå–å›¾ç‰‡ID
   * @param {Object} doc - æ–‡æ¡£å¯¹è±¡
   * @returns {string[]} å›¾ç‰‡IDæ•°ç»„
   */
  function extractImageIdsFromDoc(doc) {
    const imageIds = [];
    const content = (doc.md || '') + (doc.note || '');

    // åŒ¹é…å›¾ç‰‡è¯­æ³• ![alt](imageId)
    const imageRegex = /!\[[^\]]*\]\(([^)]+)\)/g;
    let match;

    while ((match = imageRegex.exec(content)) !== null) {
      const imageId = match[1];
      // ç°åœ¨åŒ…æ‹¬base64å›¾ç‰‡IDï¼Œè¿‡æ»¤æ‰å¤–éƒ¨é“¾æ¥
      if (!imageId.startsWith('http')) {
        imageIds.push(imageId);
      }
    }

    // åªä»MDå†…å®¹ä¸­æå–å›¾ç‰‡IDï¼Œä¸å†æ£€æŸ¥imagesæ•°ç»„å­—æ®µ
    // è¿™ç¡®ä¿äº†imagesæ•°ç»„ä¸MDå†…å®¹ä¸­å¼•ç”¨çš„å›¾ç‰‡ä¿æŒä¸€è‡´

    return [...new Set(imageIds)]; // å»é‡
  }

  /**
   * ä»æ–‡æ¡£å†…å®¹ä¸­æå–base64å›¾ç‰‡æ•°æ®
   * @param {Object} doc - æ–‡æ¡£å¯¹è±¡
   * @returns {Array} base64å›¾ç‰‡å¯¹è±¡æ•°ç»„
   */
  function extractBase64ImagesFromDoc(doc) {
    const base64Images = [];
    const content = (doc.md || '') + (doc.note || '');

    // åŒ¹é…å›¾ç‰‡è¯­æ³• ![alt](data:image/...;base64,...)
    const imageRegex = /!\[[^\]]*\]\((data:image\/[^;]+;base64,[^)]+)\)/g;
    const altRegex = /!\[([^\]]*)\]\(/g;
    let match;
    let altMatch;

    while ((match = imageRegex.exec(content)) !== null) {
      const dataUrl = match[1];

      // æå–å¯¹åº”çš„altæ–‡æœ¬
      altRegex.lastIndex = match.index;
      altMatch = altRegex.exec(content);
      const altText = altMatch ? altMatch[1] : 'å›¾ç‰‡';

      // ç”Ÿæˆå›¾ç‰‡IDï¼ˆä½¿ç”¨dataUrlçš„å“ˆå¸Œå€¼ï¼‰
      const imageId = 'img_' + Math.abs(dataUrl.split(',')[1].split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
      }, 0)).toString(36);

      base64Images.push({
        id: imageId,
        dataUrl: dataUrl,
        alt: altText,
        name: altText || 'å›¾ç‰‡'
      });
    }

    return base64Images;
  }

  /**
   * æ¸…ç†æ–‡æ¡£çš„imagesæ•°ç»„ï¼Œç¡®ä¿åªåŒ…å«MDå†…å®¹ä¸­å®é™…å¼•ç”¨çš„å›¾ç‰‡
   * ç°åœ¨ä¸»åŠ¨ä»æœ¬åœ°å­˜å‚¨è·å–å›¾ç‰‡æ•°æ®å¹¶åµŒå…¥base64ï¼Œç®€åŒ–å›¾ç‰‡ä¸Šä¼ é€»è¾‘
   * @param {Object} doc - æ–‡æ¡£å¯¹è±¡
   * @returns {Object} æ¸…ç†åçš„æ–‡æ¡£å¯¹è±¡
   */
  async function cleanDocImagesArray(doc) {
    if (!doc) return doc;

    // æå–MDå†…å®¹ä¸­å®é™…å¼•ç”¨çš„å›¾ç‰‡IDï¼ˆåŒ…æ‹¬base64å›¾ç‰‡ï¼‰
    const referencedImageIds = extractImageIdsFromDoc(doc);

    // åŒæ—¶æå–æ–‡æ¡£å†…å®¹ä¸­çš„base64å›¾ç‰‡æ•°æ®
    const base64Images = extractBase64ImagesFromDoc(doc);

    // å¦‚æœæ–‡æ¡£æ²¡æœ‰imagesæ•°ç»„ï¼Œå…ˆåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
    let currentImages = [];
    if (doc.images && Array.isArray(doc.images)) {
      currentImages = [...doc.images];
    }

    // å°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–å›¾ç‰‡æ•°æ®å¹¶åµŒå…¥base64
    if (window.imageStorage && referencedImageIds.length > 0) {
      try {
        const localImagesMap = await window.imageStorage.getImagesMap();

        for (const imageId of referencedImageIds) {
          const localImageInfo = localImagesMap.get(imageId);
          if (localImageInfo) {
            // æŸ¥æ‰¾å½“å‰imagesæ•°ç»„ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥å›¾ç‰‡
            let existingImage = currentImages.find(img => img && img.id === imageId);

            if (!existingImage) {
              // å¦‚æœimagesæ•°ç»„ä¸­æ²¡æœ‰è¯¥å›¾ç‰‡ï¼Œåˆ›å»ºæ–°çš„å›¾ç‰‡å¯¹è±¡
              existingImage = {
                id: imageId,
                name: localImageInfo.name || 'image.png',
                mime: localImageInfo.type || 'image/png'
              };
              currentImages.push(existingImage);
            }

            // å¦‚æœæœ¬åœ°å­˜å‚¨æœ‰dataUrlï¼Œç›´æ¥åµŒå…¥
            if (localImageInfo.dataUrl) {
              existingImage.dataUrl = localImageInfo.dataUrl;
              console.log(`[SYNC] ä¸ºæ–‡æ¡£ ${doc.id} çš„å›¾ç‰‡ ${imageId} åµŒå…¥base64æ•°æ®`);
            } else if (localImageInfo.blob) {
              // å¦‚æœæœ‰blobæ•°æ®ï¼Œè½¬æ¢ä¸ºdataUrl
              try {
                existingImage.dataUrl = await window.imageStorage.blobToDataUrl(localImageInfo.blob);
                console.log(`[SYNC] ä¸ºæ–‡æ¡£ ${doc.id} çš„å›¾ç‰‡ ${imageId} è½¬æ¢blobä¸ºbase64æ•°æ®`);
              } catch (error) {
                console.warn(`[SYNC] è½¬æ¢å›¾ç‰‡ ${imageId} blobå¤±è´¥:`, error);
              }
            }
          }
        }
      } catch (error) {
        console.warn('[SYNC] ä»æœ¬åœ°å­˜å‚¨è·å–å›¾ç‰‡æ•°æ®å¤±è´¥:', error);
      }
    }

    // æ·»åŠ æ–‡æ¡£å†…å®¹ä¸­çš„base64å›¾ç‰‡
    for (const base64Img of base64Images) {
      const existingIndex = currentImages.findIndex(img => img && img.id === base64Img.id);
      if (existingIndex >= 0) {
        // æ›´æ–°å·²æœ‰çš„å›¾ç‰‡
        currentImages[existingIndex] = { ...currentImages[existingIndex], ...base64Img };
      } else {
        // æ·»åŠ æ–°å›¾ç‰‡
        currentImages.push(base64Img);
      }
    }

    // è¿‡æ»¤æ‰æ–‡æ¡£å†…å®¹ä¸­æ²¡æœ‰å¼•ç”¨çš„å›¾ç‰‡ï¼ˆä¿ç•™æœ‰dataUrlçš„å›¾ç‰‡ï¼‰
    const finalImages = currentImages.filter(img => {
      if (!img || !img.id) return false;
      // ä¿ç•™è¢«å¼•ç”¨çš„å›¾ç‰‡æˆ–æœ‰base64æ•°æ®çš„å›¾ç‰‡
      return referencedImageIds.includes(img.id) || img.dataUrl;
    });

    if (finalImages.length > 0) {
      const base64Count = finalImages.filter(img => img.dataUrl).length;
      console.log(`[SYNC] æ–‡æ¡£ ${doc.id} æœ€ç»ˆä¿ç•™ ${finalImages.length} å¼ å›¾ç‰‡ï¼Œå…¶ä¸­ ${base64Count} å¼ åŒ…å«base64æ•°æ®`);
    }

    // è¿”å›æ¸…ç†åçš„æ–‡æ¡£å¯¹è±¡ï¼ŒåŒ…å«åµŒå…¥çš„base64æ•°æ®
    return {
      ...doc,
      images: finalImages
    };
  }

  /**
   * æ‰¹é‡ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°äº‘ç«¯
   * @param {string[]} imageIds - è¦ä¸Šä¼ çš„å›¾ç‰‡IDæ•°ç»„
   * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
   */
  async function uploadLocalImages(imageIds, cloudObj = null) {
    if (!isLoggedIn()) {
      throw new Error('æœªç™»å½•ï¼Œæ— æ³•ä¸Šä¼ å›¾ç‰‡');
    }

    if (!window.imageStorage) {
      throw new Error('å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–');
    }

    try {
      const imagesMap = await window.imageStorage.getImagesMap();
      console.log(`[SYNC] è·å–åˆ° ${imagesMap.size} å¼ æœ¬åœ°å›¾ç‰‡`);

      // è°ƒè¯•ï¼šæ£€æŸ¥å‰å‡ ä¸ªå›¾ç‰‡çš„æ•°æ®ç»“æ„
      let debugCount = 0;
      for (const [id, info] of imagesMap) {
        console.log(`[SYNC] å›¾ç‰‡ ${id} æ•°æ®ç»“æ„:`, {
          hasDataUrl: !!info.dataUrl,
          hasBlob: !!info.blob,
          type: info.type,
          name: info.name
        });
        debugCount++;
        if (debugCount >= 3) break; // åªæ˜¾ç¤ºå‰3ä¸ªé¿å…æ—¥å¿—è¿‡å¤š
      }

      let uploaded = 0;

      // è·å–äº‘ç«¯æ•°æ®
      const cloudData = cloudObj ? { obj: cloudObj, docs: cloudObj.get('docs') || [] } : await downloadCloud();
      const cloudDocs = cloudData.docs || [];

      // åˆ›å»ºäº‘ç«¯æ–‡æ¡£çš„æ˜ å°„ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
      const cloudDocsMap = new Map();
      for (const doc of cloudDocs) {
        if (doc && doc.id) {
          cloudDocsMap.set(doc.id, doc);
        }
      }

      // å¤„ç†æ¯ä¸ªè¦ä¸Šä¼ çš„å›¾ç‰‡
      for (const imageId of imageIds) {
        const imageInfo = imagesMap.get(imageId);
        if (!imageInfo) {
          console.warn(`æœ¬åœ°æœªæ‰¾åˆ°å›¾ç‰‡ ${imageId} æ•°æ®ï¼Œè·³è¿‡ä¸Šä¼ `);
          continue;
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®ï¼ˆæ”¯æŒ dataUrl æˆ– blob æ ¼å¼ï¼‰
        let imageData = null;
        let imgSize = 0;

        if (imageInfo.dataUrl) {
          // ä½¿ç”¨ç°æœ‰çš„ dataUrl
          const base64Data = imageInfo.dataUrl.split(',')[1];
          if (!base64Data) {
            console.warn(`å›¾ç‰‡ ${imageId} æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡ä¸Šä¼ `);
            continue;
          }
          imgSize = Math.ceil(base64Data.length * 0.75); // base64è§£ç åçš„å¤§å°
          imageData = imageInfo.dataUrl;
        } else if (imageInfo.blob) {
          // å¦‚æœæœ‰ blob æ•°æ®ï¼Œè½¬æ¢ä¸º dataUrl
          try {
            imageData = await window.imageStorage.blobToDataUrl(imageInfo.blob);
            imgSize = imageInfo.blob.size;
          } catch (error) {
            console.warn(`å›¾ç‰‡ ${imageId} blobè½¬æ¢å¤±è´¥ï¼Œè·³è¿‡ä¸Šä¼ :`, error);
            continue;
          }
        } else {
          console.warn(`å›¾ç‰‡ ${imageId} æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®ï¼ˆç¼ºå°‘dataUrlæˆ–blobï¼‰ï¼Œè·³è¿‡ä¸Šä¼ `);
          continue;
        }

        if (imgSize > MAX_IMAGE_SIZE) {
          console.warn(`å›¾ç‰‡ ${imageId} è¶…è¿‡å¤§å°é™åˆ¶(${imgSize} > ${MAX_IMAGE_SIZE})ï¼Œè·³è¿‡ä¸Šä¼ `);
          continue;
        }

        // æŸ¥æ‰¾åŒ…å«æ­¤å›¾ç‰‡çš„äº‘ç«¯æ–‡æ¡£
        let foundDoc = null;
        for (const [docId, doc] of cloudDocsMap) {
          if (doc.images && Array.isArray(doc.images)) {
            const imgIndex = doc.images.findIndex(img => img && img.id === imageId);
            if (imgIndex !== -1) {
              foundDoc = doc;
              // æ›´æ–°æ–‡æ¡£ä¸­çš„å›¾ç‰‡æ•°æ®
              if (!foundDoc.images[imgIndex].dataUrl) {
                foundDoc.images[imgIndex].dataUrl = imageData;
                uploaded++;
                console.log(`å›¾ç‰‡ ${imageId} å·²æ·»åŠ åˆ°æ–‡æ¡£ ${docId}`);
              }
              break;
            }
          }
        }

        if (!foundDoc) {
          console.warn(`æœªæ‰¾åˆ°åŒ…å«å›¾ç‰‡ ${imageId} çš„æ–‡æ¡£ï¼Œè·³è¿‡ä¸Šä¼ `);
        }
      }

      // å¦‚æœæœ‰å›¾ç‰‡è¢«ä¸Šä¼ ï¼Œæ›´æ–°äº‘ç«¯æ•°æ®
      if (uploaded > 0) {
        const obj = cloudData.obj || await fetchOrCreateRecord();
        // ç¡®ä¿æ‰€æœ‰æ–‡æ¡£çš„imagesæ•°ç»„éƒ½å·²æ¸…ç†
        const cleanedDocs = await Promise.all(cloudDocs.map(doc => cleanDocImagesArray(doc)));
        obj.set('docs', cleanedDocs);

        // å¦‚æœæ²¡æœ‰ä¼ å…¥äº‘ç«¯å¯¹è±¡ï¼Œåˆ™ç«‹å³ä¿å­˜ï¼›å¦åˆ™ç”±è°ƒç”¨æ–¹ä¿å­˜
        if (!cloudObj) {
          await obj.save();
        }
      }

      console.log(`æˆåŠŸä¸Šä¼  ${uploaded} å¼ å›¾ç‰‡åˆ°äº‘ç«¯`);
      return { uploaded, message: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ' };
    } catch (error) {
      console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
      throw new Error(`ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼š${error.message}`);
    }
  }

  /**
   * æ‰¹é‡ä¸‹è½½äº‘ç«¯å›¾ç‰‡åˆ°æœ¬åœ°
   * @param {string[]} imageIds - è¦ä¸‹è½½çš„å›¾ç‰‡IDæ•°ç»„
   * @returns {Promise<Object>} ä¸‹è½½ç»“æœ
   */
  async function downloadCloudImages(imageIds) {
    if (!window.imageStorage) {
      throw new Error('å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–');
    }

    try {
      const downloaded = [];

      // è·å–äº‘ç«¯æ•°æ®
      const cloudData = await downloadCloud();
      const cloudDocs = cloudData.docs || [];

      // åˆ›å»ºäº‘ç«¯æ–‡æ¡£çš„æ˜ å°„ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
      const cloudDocsMap = new Map();
      for (const doc of cloudDocs) {
        if (doc && doc.id) {
          cloudDocsMap.set(doc.id, doc);
        }
      }

      // å¤„ç†æ¯ä¸ªè¦ä¸‹è½½çš„å›¾ç‰‡
      for (const imageId of imageIds) {
        try {
          let imageDataUrl = null;
          let documentId = null;

          // åœ¨æ‰€æœ‰äº‘ç«¯æ–‡æ¡£ä¸­æŸ¥æ‰¾åŒ…å«æ­¤å›¾ç‰‡çš„æ–‡æ¡£
          for (const [docId, doc] of cloudDocsMap) {
            if (doc.images && Array.isArray(doc.images)) {
              const img = doc.images.find(img => img && img.id === imageId);
              if (img && img.dataUrl) {
                imageDataUrl = img.dataUrl;
                documentId = docId;
                break;
              }
            }
          }

          if (!imageDataUrl) {
            console.warn(`äº‘ç«¯æœªæ‰¾åˆ°å›¾ç‰‡æ•°æ®: ${imageId}`);
            continue;
          }

          // å°†DataURLè½¬æ¢ä¸ºBlob
          const blob = await window.imageStorage.dataUrlToBlob(imageDataUrl);

          // ä¿å­˜åˆ°IndexedDBï¼Œæä¾›æ­£ç¡®çš„documentIdå…ƒæ•°æ®
          await window.imageStorage.saveImage(imageId, blob, {
            name: imageId,
            documentId: documentId
          });
          downloaded.push(imageId);
          console.log(`æˆåŠŸä¸‹è½½å›¾ç‰‡ ${imageId} (æ–‡æ¡£: ${documentId})`);
        } catch (error) {
          console.error(`ä¸‹è½½å›¾ç‰‡ ${imageId} å¤±è´¥:`, error);
        }
      }

      console.log(`æˆåŠŸä¸‹è½½ ${downloaded.length} å¼ å›¾ç‰‡åˆ°æœ¬åœ°`);
      return { downloaded: downloaded.length, message: 'å›¾ç‰‡ä¸‹è½½æˆåŠŸ' };
    } catch (error) {
      console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
      throw new Error(`ä¸‹è½½å›¾ç‰‡å¤±è´¥ï¼š${error.message}`);
    }
  }

  /**
   * ä»URLä¸­æå–å›¾ç‰‡ID
   * @param {string} url - å›¾ç‰‡URL
   * @returns {string|null} å›¾ç‰‡ID
   */
  function extractImageIdFromUrl(url) {
    // å‡è®¾URLæ ¼å¼ä¸º: https://example.com/images/{imageId}
    const match = url.match(/\/images\/([^/?]+)/);
    return match ? match[1] : null;
  }

  /**
   * è·å–å›¾ç‰‡æ•°æ®
   * @param {string} url - å›¾ç‰‡URL
   * @returns {Promise<string|null>} å›¾ç‰‡base64æ•°æ®
   */
  async function fetchImageData(url) {
    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const blob = await response.blob();
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    } catch (error) {
      console.error(`è·å–å›¾ç‰‡æ•°æ®å¤±è´¥: ${url}`, error);
      return null;
    }
  }

  /**
   * åŒæ­¥æ‰€æœ‰æ–‡æ¡£çš„å›¾ç‰‡æ•°æ®
   * @param {Array} docs - æ–‡æ¡£æ•°ç»„
   * @param {Object} cloudDataCache - äº‘ç«¯æ•°æ®ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
   * @param {Array} modifiedDocIds - æœ‰ä¿®æ”¹çš„æ–‡æ¡£IDåˆ—è¡¨ï¼Œå¦‚æœæä¾›åˆ™åªåŒæ­¥è¿™äº›æ–‡æ¡£çš„å›¾ç‰‡
   * @param {boolean} skipCloudSave - æ˜¯å¦è·³è¿‡äº‘ç«¯ä¿å­˜ï¼ˆå½“æ•°æ®å·²ç»åœ¨å…¶ä»–åœ°æ–¹ä¿å­˜æ—¶ï¼‰
   * @returns {Promise<Object>} åŒæ­¥ç»“æœ
   */
  async function syncAllImages(docs, cloudDataCache = null, modifiedDocIds = null, skipCloudSave = false) {
    if (!isLoggedIn()) {
      console.log('[SYNC] æœªç™»å½•ï¼Œè·³è¿‡å›¾ç‰‡åŒæ­¥');
      return { uploaded: 0, downloaded: 0, message: 'æœªç™»å½•ï¼Œè·³è¿‡å›¾ç‰‡åŒæ­¥' };
    }

    if (!window.imageStorage) {
      console.warn('[SYNC] å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å›¾ç‰‡åŒæ­¥');
      return { uploaded: 0, downloaded: 0, message: 'å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–' };
    }

    try {
      console.log('[SYNC] å¼€å§‹åŒæ­¥å›¾ç‰‡...');

      // ä½¿ç”¨ä¼ å…¥çš„äº‘ç«¯æ•°æ®ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°ä¸‹è½½
      const cloudData = cloudDataCache || await downloadCloud();
      const cloudDocs = cloudData.docs || [];

      // åˆ›å»ºäº‘ç«¯æ–‡æ¡£çš„æ˜ å°„ï¼Œæ–¹ä¾¿æŸ¥æ‰¾
      const cloudDocsMap = new Map();
      for (const doc of cloudDocs) {
        if (doc && doc.id) {
          cloudDocsMap.set(doc.id, doc);
        }
      }

      // è·å–æœ¬åœ°å›¾ç‰‡æ•°æ®
      const localImagesMap = await window.imageStorage.getImagesMap();

      let totalUploaded = 0;
      let totalDownloaded = 0;

      // æ”¶é›†æ‰€æœ‰éœ€è¦åŒæ­¥çš„å›¾ç‰‡IDï¼ŒåŒ…æ‹¬æ–‡æ¡£ä¸­å¼•ç”¨çš„å’Œå­˜å‚¨ä¸­çš„å›¾ç‰‡
      const allImageIds = new Set();

      // ç¡®å®šè¦å¤„ç†çš„æ–‡æ¡£åˆ—è¡¨
      let docsToProcess = docs;
      if (modifiedDocIds && modifiedDocIds.length > 0) {
        // å¦‚æœæœ‰æŒ‡å®šä¿®æ”¹çš„æ–‡æ¡£ï¼Œåªå¤„ç†è¿™äº›æ–‡æ¡£
        docsToProcess = docs.filter(doc => doc && modifiedDocIds.includes(doc.id));
        console.log(`[SYNC] åªå¤„ç†æœ‰ä¿®æ”¹çš„æ–‡æ¡£ï¼Œå…±${docsToProcess.length}ä¸ª`);
      } else {
        console.log(`[SYNC] å¤„ç†æ‰€æœ‰æ–‡æ¡£ï¼Œå…±${docsToProcess.length}ä¸ª`);
      }

      // 1. ä»æ–‡æ¡£å†…å®¹ä¸­æå–å›¾ç‰‡å¼•ç”¨
      for (const doc of docsToProcess) {
        if (!doc || !doc.id) continue;

        // ä»æ–‡æ¡£å†…å®¹ä¸­æå–å›¾ç‰‡ID
        const imageIds = extractImageIdsFromDoc(doc);
        imageIds.forEach(id => allImageIds.add(id));

        // åŒæ—¶æ£€æŸ¥æ–‡æ¡£çš„imagesæ•°ç»„
        if (doc.images && Array.isArray(doc.images)) {
          doc.images.forEach(img => {
            if (img && img.id) {
              allImageIds.add(img.id);
            }
          });
        }
      }

      // 2. æ·»åŠ æœ¬åœ°å­˜å‚¨ä¸­çš„æ‰€æœ‰å›¾ç‰‡IDï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•å›¾ç‰‡
      for (const [imageId, imageData] of localImagesMap) {
        allImageIds.add(imageId);
      }

      // 3. æ·»åŠ äº‘ç«¯å­˜å‚¨ä¸­çš„æ‰€æœ‰å›¾ç‰‡IDï¼Œç¡®ä¿ä¸é—æ¼äº‘ç«¯å›¾ç‰‡
      for (const [docId, doc] of cloudDocsMap) {
        if (doc.images && Array.isArray(doc.images)) {
          doc.images.forEach(img => {
            if (img && img.id) {
              allImageIds.add(img.id);
            }
          });
        }
      }

      console.log(`[SYNC] æ”¶é›†åˆ°${allImageIds.size}ä¸ªå›¾ç‰‡IDéœ€è¦åŒæ­¥æ£€æŸ¥`);

      // å¤„ç†æ¯ä¸ªå›¾ç‰‡
      for (const imageId of allImageIds) {
        if (!imageId) continue;

        // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰å›¾ç‰‡æ•°æ®
        const localImageData = localImagesMap.get(imageId);
        const hasLocalData = localImageData && localImageData.dataUrl;

        // æŸ¥æ‰¾åŒ…å«æ­¤å›¾ç‰‡çš„æ–‡æ¡£ï¼ˆæœ¬åœ°å’Œäº‘ç«¯ï¼‰
        const localDocContainingImage = docs.find(doc => {
          if (!doc || !doc.id) return false;
          const docImageIds = extractImageIdsFromDoc(doc);
          if (docImageIds.includes(imageId)) return true;

          // æ£€æŸ¥imagesæ•°ç»„
          if (doc.images && Array.isArray(doc.images)) {
            return doc.images.some(img => img && img.id === imageId);
          }
          return false;
        });

        const cloudDocContainingImage = Array.from(cloudDocsMap.values()).find(doc => {
          if (!doc || !doc.id) return false;

          // æ£€æŸ¥imagesæ•°ç»„
          if (doc.images && Array.isArray(doc.images)) {
            return doc.images.some(img => img && img.id === imageId);
          }
          return false;
        });

        // è·å–äº‘ç«¯å›¾ç‰‡æ•°æ®
        let cloudImageData = null;
        if (cloudDocContainingImage && cloudDocContainingImage.images) {
          const cloudImg = cloudDocContainingImage.images.find(img => img && img.id === imageId);
          if (cloudImg && cloudImg.dataUrl) {
            cloudImageData = cloudImg;
          }
        }

        const hasCloudData = cloudImageData && cloudImageData.dataUrl;

        // å†³å®šåŒæ­¥æ–¹å‘
        if (hasLocalData && !hasCloudData) {
          // æœ¬åœ°æœ‰ï¼Œäº‘ç«¯æ²¡æœ‰ - ä¸Šä¼ 
          try {
            const base64Data = localImageData.dataUrl.split(',')[1];
            if (!base64Data) {
              console.warn(`å›¾ç‰‡ ${imageId} æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡ä¸Šä¼ `);
              continue;
            }

            const imgSize = Math.ceil(base64Data.length * 0.75);
            if (imgSize > MAX_IMAGE_SIZE) {
              console.warn(`å›¾ç‰‡ ${imageId} è¶…è¿‡å¤§å°é™åˆ¶ï¼Œè·³è¿‡ä¸Šä¼ `);
              continue;
            }

            // ç¡®å®šå›¾ç‰‡æ‰€å±çš„æ–‡æ¡£
            const targetDoc = localDocContainingImage || docs[0]; // å¦‚æœæ‰¾ä¸åˆ°æ‰€å±æ–‡æ¡£ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡æ¡£
            if (!targetDoc || !targetDoc.id) {
              console.warn(`å›¾ç‰‡ ${imageId} æ‰¾ä¸åˆ°æ‰€å±æ–‡æ¡£ï¼Œè·³è¿‡ä¸Šä¼ `);
              continue;
            }

            // è·å–æˆ–åˆ›å»ºäº‘ç«¯æ–‡æ¡£
            let cloudDoc = cloudDocsMap.get(targetDoc.id);
            if (!cloudDoc) {
              // åˆ›å»ºäº‘ç«¯æ–‡æ¡£
              cloudDoc = {
                id: targetDoc.id,
                name: targetDoc.name || '',
                md: targetDoc.md || '',
                images: [],
                updatedAt: Number(targetDoc.updatedAt || 0)
              };
              cloudDocsMap.set(targetDoc.id, cloudDoc);
              cloudDocs.push(cloudDoc);
            }

            // ç¡®ä¿imagesæ•°ç»„å­˜åœ¨
            if (!cloudDoc.images) {
              cloudDoc.images = [];
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingImg = cloudDoc.images.find(img => img && img.id === imageId);
            if (existingImg) {
              existingImg.dataUrl = localImageData.dataUrl;
            } else {
              // æ·»åŠ æ–°å›¾ç‰‡
              cloudDoc.images.push({
                id: imageId,
                name: localImageData.name || imageId,
                mime: localImageData.mime || 'image/png',
                dataUrl: localImageData.dataUrl
              });
            }

            totalUploaded++;
            console.log(`[SYNC] ä¸Šä¼ å›¾ç‰‡ ${imageId} (æ–‡æ¡£: ${targetDoc.id})`);
          } catch (error) {
            console.error(`[SYNC] ä¸Šä¼ å›¾ç‰‡ ${imageId} å¤±è´¥:`, error);
          }
        } else if (!hasLocalData && hasCloudData) {
          // æœ¬åœ°æ²¡æœ‰ï¼Œäº‘ç«¯æœ‰ - ä¸‹è½½
          try {
            // ç¡®å®šå›¾ç‰‡æ‰€å±çš„æ–‡æ¡£
            const targetDoc = localDocContainingImage || Array.from(cloudDocsMap.values()).find(doc => {
              return doc.images && doc.images.some(img => img && img.id === imageId);
            });

            if (!targetDoc || !targetDoc.id) {
              console.warn(`å›¾ç‰‡ ${imageId} æ‰¾ä¸åˆ°æ‰€å±æ–‡æ¡£ï¼Œè·³è¿‡ä¸‹è½½`);
              continue;
            }

            const blob = await window.imageStorage.dataUrlToBlob(cloudImageData.dataUrl);
            await window.imageStorage.saveImage(imageId, blob, {
              name: cloudImageData.name || imageId,
              documentId: targetDoc.id
            });
            totalDownloaded++;
            console.log(`[SYNC] ä¸‹è½½å›¾ç‰‡ ${imageId} (æ–‡æ¡£: ${targetDoc.id})`);
          } catch (error) {
            console.error(`[SYNC] ä¸‹è½½å›¾ç‰‡ ${imageId} å¤±è´¥:`, error);
          }
        } else if (!hasLocalData && !hasCloudData) {
          // ä¸¤è¾¹éƒ½æ²¡æœ‰ - è®°å½•è­¦å‘Š
          console.warn(`[SYNC] å›¾ç‰‡ ${imageId} åœ¨æœ¬åœ°å’Œäº‘ç«¯éƒ½æ‰¾ä¸åˆ°æ•°æ®`);
        }
        // å¦‚æœä¸¤è¾¹éƒ½æœ‰æ•°æ®ï¼Œåˆ™ä¸éœ€è¦åŒæ­¥
      }

      // å¦‚æœæœ‰å›¾ç‰‡éœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯ï¼Œæ›´æ–°äº‘ç«¯æ–‡æ¡£æ•°æ®
      if (totalUploaded > 0 && !skipCloudSave) {
        // ä½¿ç”¨ä¼ å…¥çš„äº‘ç«¯å¯¹è±¡ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™é‡æ–°è·å–
        const obj = cloudDataCache && cloudDataCache.obj ? cloudDataCache.obj : await fetchOrCreateRecord();
        // ç¡®ä¿æ‰€æœ‰æ–‡æ¡£çš„imagesæ•°ç»„éƒ½å·²æ¸…ç†
        const cleanedDocs = await Promise.all(cloudDocs.map(doc => cleanDocImagesArray(doc)));
        obj.set('docs', cleanedDocs);
        await obj.save();
        console.log(`[SYNC] æ›´æ–°äº‘ç«¯æ–‡æ¡£æ•°æ®ï¼ŒåŒ…å«${totalUploaded}å¼ æ–°å›¾ç‰‡`);
      } else if (totalUploaded > 0 && skipCloudSave) {
        console.log(`[SYNC] è·³è¿‡ä¸Šå‚³å›¾ç‰‡çš„äº‘ç«¯ä¿å­˜ï¼Œå·²åœ¨å…¶ä»–åœ°æ–¹ä¿å­˜`);
      }

      console.log(`[SYNC] å›¾ç‰‡åŒæ­¥å®Œæˆï¼šä¸Šä¼ ${totalUploaded}å¼ ï¼Œä¸‹è½½${totalDownloaded}å¼ `);
      return { uploaded: totalUploaded, downloaded: totalDownloaded, message: 'å›¾ç‰‡åŒæ­¥å®Œæˆ' };
    } catch (error) {
      console.error('[SYNC] å›¾ç‰‡åŒæ­¥å¤±è´¥:', error);
      throw new Error(`å›¾ç‰‡åŒæ­¥å¤±è´¥ï¼š${error.message}`);
    }
  }

  /**
   * å°†å›¾ç‰‡æ•°æ®åŒæ­¥åˆ°äº‘ç«¯
   * @param {Array} docs - æ–‡æ¡£æ•°ç»„
   * @param {Object} cloudObj - äº‘ç«¯å¯¹è±¡ï¼ˆå¯é€‰ï¼‰
   * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ
   */
  async function syncImagesToCloud(docs, cloudObj = null) {
    if (!isLoggedIn()) {
      console.log('[SYNC] æœªç™»å½•ï¼Œè·³è¿‡å›¾ç‰‡ä¸Šä¼ åˆ°äº‘ç«¯');
      return { uploaded: 0, message: 'æœªç™»å½•ï¼Œè·³è¿‡å›¾ç‰‡ä¸Šä¼ ' };
    }

    if (!window.imageStorage) {
      console.warn('[SYNC] å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–ï¼Œè·³è¿‡å›¾ç‰‡ä¸Šä¼ åˆ°äº‘ç«¯');
      return { uploaded: 0, message: 'å›¾ç‰‡å­˜å‚¨ç®¡ç†å™¨æœªåˆå§‹åŒ–' };
    }

    try {
      console.log('[SYNC] å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ°äº‘ç«¯...');

      // ä»æ‰€æœ‰æ–‡æ¡£ä¸­æå–å›¾ç‰‡ID
      const allImageIds = new Set();
      for (const doc of docs) {
        if (doc && doc.md) {
          const imageIds = extractImageIdsFromDoc(doc);
          imageIds.forEach(id => allImageIds.add(id));
        }
      }

      if (allImageIds.size === 0) {
        console.log('[SYNC] æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„å›¾ç‰‡');
        return { uploaded: 0, message: 'æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„å›¾ç‰‡' };
      }

      // è·å–æœ¬åœ°å›¾ç‰‡æ•°æ®
      const localImagesMap = await window.imageStorage.getImagesMap();
      const imagesToUpload = Array.from(allImageIds).filter(id => localImagesMap.has(id));

      if (imagesToUpload.length === 0) {
        console.log('[SYNC] æœ¬åœ°æ²¡æœ‰æ‰¾åˆ°éœ€è¦ä¸Šä¼ çš„å›¾ç‰‡');
        return { uploaded: 0, message: 'æœ¬åœ°æ²¡æœ‰æ‰¾åˆ°éœ€è¦ä¸Šä¼ çš„å›¾ç‰‡' };
      }

      // ä¸Šä¼ å›¾ç‰‡ï¼Œä½¿ç”¨ä¼ å…¥çš„äº‘ç«¯å¯¹è±¡
      const uploadResult = await uploadLocalImages(imagesToUpload, cloudObj);
      console.log(`[SYNC] æˆåŠŸä¸Šä¼ ${uploadResult.uploaded}å¼ å›¾ç‰‡åˆ°äº‘ç«¯`);
      return uploadResult;
    } catch (error) {
      console.error('[SYNC] ä¸Šä¼ å›¾ç‰‡åˆ°äº‘ç«¯å¤±è´¥:', error);
      throw new Error(`ä¸Šä¼ å›¾ç‰‡åˆ°äº‘ç«¯å¤±è´¥ï¼š${error.message}`);
    }
  }

  // æš´éœ²æ‰‹åŠ¨å…¥å£ï¼ˆå¦‚éœ€ï¼‰
  window.MW_LC_SYNC = {
    sync: async function () {
      try {
        await bidirectionalSync();
      } catch (error) {
        console.error('[SYNC] åŒæ­¥å…¥å£æ•è·é”™è¯¯:', error);
        // ç¡®ä¿é”™è¯¯èƒ½å¤Ÿæ˜¾ç¤ºç»™ç”¨æˆ·
        const errorMsg = error.message || 'åŒæ­¥å¤±è´¥';
        if (window.showError) {
          window.showError(errorMsg);
        } else {
          alert(errorMsg);
        }
        throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…ä¹Ÿèƒ½å¤„ç†
      }
    },
    clear: clearCloud,
    updateStatus: updateSyncStatus,
    syncImagesForDoc: syncImagesForDoc,
    uploadLocalImages: uploadLocalImages,
    downloadCloudImages: downloadCloudImages,
    syncAllImages: syncAllImages,
    syncImagesToCloud: syncImagesToCloud
  };

  // æš´éœ²åŒæ­¥é¢„è§ˆå¯¹è¯æ¡†å‡½æ•°ç”¨äºæµ‹è¯•å›½é™…åŒ– (æµ‹è¯•å®Œæˆååº”æ³¨é‡Šæ‰)
  // window.showSyncPreviewDialog = showSyncPreviewDialog;

  // æ³¨å†Œè¯­è¨€å˜åŒ–ç›‘å¬å™¨ - å½“è¯­è¨€åˆ‡æ¢æ—¶é‡æ–°æ›´æ–°åŒæ­¥çŠ¶æ€
  if (window.i18nManager && window.i18nManager.addLanguageChangeListener) {
    window.i18nManager.addLanguageChangeListener(function (newLanguage) {
      console.log('[LeanCloudSync] Language changed to:', newLanguage, ' - updating sync status');
      updateSyncStatus();
    });
  }

})();
