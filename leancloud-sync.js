/**
 * LeanCloud Data åŒæ­¥ï¼ˆä¸­æ–‡æ¨¡å¼ï¼‰
 * ä»…åœ¨è¯­è¨€ä¸ºä¸­æ–‡æ—¶å¯ç”¨ UIï¼›æä¾›ï¼šä¸€é”®åŒæ­¥ï¼ˆæ™ºèƒ½åˆ†æï¼‰ã€æ¸…ç©ºäº‘æ•°æ®
 * æ”¹è¿›ï¼šæ”¯æŒæ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆå•å›¾200KBï¼Œæ€»é‡10Mï¼‰ï¼Œåˆ†ç±»å‹æ—¶é—´æˆ³è®°å½•
 * å­—æ®µï¼šdocs(json), aiConfig(json), promptTemplates(json), 
 *       docUpdatedAt(number), configUpdatedAt(number), templateUpdatedAt(number)
 */
(function () {
  const LANG_KEY = 'mw_lang';
  const CLASS_NAME = 'MWData';
  let cachedCloudRaw = null;   // ç¼“å­˜ç¬¬ä¸€æ¬¡ downloadCloud() çš„åŸç”Ÿå¯¹è±¡

  // æ–‡ä»¶å¤§å°é™åˆ¶
  const MAX_IMAGE_SIZE = 200 * 1024; // 200KB
  const MAX_TOTAL_SIZE = 10 * 1024 * 1024; // 10M

  function getLang() {
    try { return localStorage.getItem(LANG_KEY) || 'zh'; } catch (_) { return 'zh'; }
  }

  // æ–°çš„åˆå¹¶ç®—æ³•ï¼šå°†äº‘ç«¯æ•°æ®åˆå¹¶åˆ°æœ¬åœ°

  function isLoggedIn() {
    try { return !!(window.AV && AV.User && AV.User.current()); } catch (_) { return false; }
  }

  function getLocalDocs() { try { return (typeof mw_loadDocs === 'function') ? mw_loadDocs() : []; } catch (_) { return []; } }

  // åˆ¤æ–­æ–‡æ¡£æ˜¯å¦æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼ˆæ²¡æœ‰çœŸå®å­èŠ‚ç‚¹ï¼‰
  function isAutoGeneratedEmptyDoc(doc) {
    if (!doc) return false;

    // æ£€æŸ¥åç§°æ˜¯å¦ä¸ºé»˜è®¤çš„"æœªå‘½åæ–‡æ¡£"
    const name = doc.name || '';
    if (name !== 'æœªå‘½åæ–‡æ¡£') return false;

    // æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºé»˜è®¤çš„"# æœªå‘½åæ–‡æ¡£\n"
    const md = doc.md || '';
    if (md.trim() !== '# æœªå‘½åæ–‡æ¡£') return false;

    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡ï¼ˆç©ºæ–‡æ¡£ä¸åº”è¯¥æœ‰å›¾ç‰‡ï¼‰
    if (doc.images && doc.images.length > 0) return false;

    return true;
  }
  function saveLocalDocs(docs) { try { return (typeof mw_saveDocs === 'function') ? mw_saveDocs(docs) : null; } catch (_) { return null; } }

  // è·å–AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿
  function getLocalAIConfig() {
    try {
      const configStr = localStorage.getItem('allAIPlatformConfigs');
      return configStr ? JSON.parse(configStr) : {};
    } catch (_) {
      return {};
    }
  }

  function getLocalPromptTemplates() {
    try {
      const templatesStr = localStorage.getItem('promptTemplates');
      return templatesStr ? JSON.parse(templatesStr) : [];
    } catch (_) {
      return [];
    }
  }

  // è·å–æœ¬åœ° myPromptTemplates æ•°æ®
  function getLocalMyPromptTemplates() {
    try {
      const templatesStr = localStorage.getItem('myPromptTemplates');
      return templatesStr ? JSON.parse(templatesStr) : [];
    } catch (_) {
      return [];
    }
  }

  // ä¿å­˜AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿
  function saveLocalAIConfig(config) {
    try {
      localStorage.setItem('allAIPlatformConfigs', JSON.stringify(config));
      localStorage.setItem('allAIPlatformConfigs_last_modified', Date.now().toString());
      return true;
    } catch (_) {
      return false;
    }
  }

  function saveLocalPromptTemplates(templates) {
    try {
      localStorage.setItem('promptTemplates', JSON.stringify(templates));
      localStorage.setItem('promptTemplates_last_modified', Date.now().toString());
      return true;
    } catch (_) {
      return false;
    }
  }

  // ç›´æ¥è¯»ç°æˆçš„ hash ä¸ last_modifiedï¼Œä¸å†è‡ªå·±ç®—
  function getDataHashAndTime(_data, storageKey) {
    const hash = localStorage.getItem(storageKey + '_hash') || '';
    const lastModified = parseInt(localStorage.getItem(storageKey + '_last_modified') || '0');
    return { hash, lastModified };
  }

  // æ–‡ä»¶å¤§å°æ£€æŸ¥å‡½æ•°
  function checkFileSize(docs) {
    let totalSize = 0;
    const errors = [];

    for (const doc of (docs || [])) {
      if (!doc) continue;

      // è®¡ç®—æ–‡æ¡£æ–‡æœ¬å†…å®¹å¤§å°ï¼ˆUTF-8ç¼–ç ï¼‰
      if (doc.md) {
        const contentSize = new Blob([doc.md]).size;
        totalSize += contentSize;
      }

      // è®¡ç®—æ ‡é¢˜å¤§å°
      if (doc.name) {
        const titleSize = new Blob([doc.name]).size;
        totalSize += titleSize;
      }

      // è®¡ç®—å¤‡æ³¨å¤§å°
      if (doc.note) {
        const noteSize = new Blob([doc.note]).size;
        totalSize += noteSize;
      }

      // æ£€æŸ¥æ–‡æ¡£ä¸­çš„å›¾ç‰‡
      if (doc.md) {
        const imgMatches = doc.md.match(/data:image\/[^;]+;base64,[^"']+/g) || [];
        for (const imgData of imgMatches) {
          const base64Data = imgData.split(',')[1];
          const imgSize = Math.ceil(base64Data.length * 0.75); // base64è§£ç åçš„å¤§å°

          if (imgSize > MAX_IMAGE_SIZE) {
            errors.push(`æ–‡æ¡£"${doc.name || doc.id}"ä¸­çš„å›¾ç‰‡è¶…è¿‡200KBé™åˆ¶`);
          }
          totalSize += imgSize;
        }
      }

      // æ£€æŸ¥å¤‡æ³¨ä¸­çš„å›¾ç‰‡
      if (doc.note) {
        const noteImgMatches = doc.note.match(/data:image\/[^;]+;base64,[^"']+/g) || [];
        for (const imgData of noteImgMatches) {
          const base64Data = imgData.split(',')[1];
          const imgSize = Math.ceil(base64Data.length * 0.75);

          if (imgSize > MAX_IMAGE_SIZE) {
            errors.push(`æ–‡æ¡£"${doc.title || doc.id}"å¤‡æ³¨ä¸­çš„å›¾ç‰‡è¶…è¿‡200KBé™åˆ¶`);
          }
          totalSize += imgSize;
        }
      }
    }

    if (totalSize > MAX_TOTAL_SIZE) {
      errors.push(`æ€»æ–‡ä»¶å¤§å°è¶…è¿‡10Mé™åˆ¶ï¼ˆå½“å‰${Math.ceil(totalSize / 1024 / 1024)}Mï¼‰`);
    }

    return {
      valid: errors.length === 0,
      errors: errors,
      totalSize: totalSize
    };
  }

  // è·å–æ–‡æ¡£çš„æ—¶é—´æˆ³æ˜ å°„è¡¨
  function getDocTimestamps(docs) {
    const timestamps = {};
    for (const doc of (docs || [])) {
      if (doc && doc.id) {
        // å¯¹äºå·²åˆ é™¤çš„æ–‡æ¡£ï¼Œä½¿ç”¨deletedAtä½œä¸ºæ—¶é—´æˆ³ï¼Œç¡®ä¿åŒæ­¥é€»è¾‘æ­£ç¡®
        timestamps[doc.id] = Number(doc.updatedAt || doc.deletedAt || 0);
      }
    }
    return timestamps;
  }

  // ============= æ–°åŒæ­¥æ ¸å¿ƒï¼šåŒç»“æ„å¿«ç…§ + ä¸‰å‘åˆå¹¶ =============

  // æŠŠäº‘ç«¯åŸå§‹ doc è½¬æˆæœ¬åœ°æ ¼å¼ï¼Œå¹¶è¡¥å…¨ç¼ºå¤±å­—æ®µ
  function normalizeCloudDoc(cDoc) {
    return {
      id: cDoc.id,
      name: cDoc.name || '',
      md: cDoc.md || '',
      images: cDoc.images || [], // æ·»åŠ imagesæ•°ç»„å­—æ®µ
      updatedAt: Number(cDoc.updatedAt || 0),
      deletedAt: cDoc.deletedAt ? Number(cDoc.deletedAt) : undefined
    };
  }

  // æ‹‰å–å¹¶ç»„è£…æˆä¸ localFullData å®Œå…¨åŒæ„çš„å¯¹è±¡
  async function fetchCloudFullData() {
    // ä¼˜å…ˆç”¨ç¼“å­˜ï¼Œæ²¡æœ‰å†æ‹‰
    const cloudRaw = cachedCloudRaw || await downloadCloud();
    if (!cachedCloudRaw) cachedCloudRaw = cloudRaw;
    return {
      docs: (cloudRaw.docs || []).map(normalizeCloudDoc),
      aiConfig: cloudRaw.aiConfig || {},
      aiConfigHash: cloudRaw.aiConfigHash,                // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      aiConfigLastModified: Number(cloudRaw.configUpdatedAt || 0),
      promptTemplates: cloudRaw.promptTemplates || [],
      promptTemplatesHash: cloudRaw.promptTemplatesHash,    // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      promptTemplatesLastModified: Number(cloudRaw.templateUpdatedAt || 0),
      myPromptTemplates: cloudRaw.myPromptTemplates || [],
      myPromptTemplatesHash: cloudRaw.myPromptTemplatesHash,    // ç›´æ¥å–äº‘ç«¯å­˜çš„å“ˆå¸Œ
      myPromptTemplatesLastModified: Number(cloudRaw.myPromptTemplateUpdatedAt || 0),
      lastSyncAt: 0                                         // äº‘ç«¯æ— æ­¤å­—æ®µ
    };
  }

  // ä¸‰å‘åˆå¹¶ï¼šæœ¬åœ° + äº‘ç«¯ â†’ ç›®æ ‡ç»“æ„
  function mergeToTarget(local, cloud) {
    const target = {
      docs: [],
      aiConfig: {},
      promptTemplates: [],
      myPromptTemplates: [],
      aiConfigHash: undefined,
      aiConfigLastModified: 0,
      promptTemplatesHash: undefined,
      promptTemplatesLastModified: 0,
      myPromptTemplatesHash: undefined,
      myPromptTemplatesLastModified: 0,
      lastSyncAt: Date.now()
    };

    // 1. æ–‡æ¡£æ•°ç»„ï¼šæŒ‰ ID ä¸‰å‘åˆå¹¶ï¼ˆè·³è¿‡å·²åˆ é™¤ï¼Œå“ˆå¸Œç›¸åŒå–äº‘ç«¯ï¼Œä¸åŒæŒ‰æ—¶é—´æˆ³ï¼‰
    const hashDoc = d => {
      const str = (d.name || '') + '\n' + (d.md || '') + '\n' + JSON.stringify(d.images || []);
      let h = 5381;
      for (let i = 0; i < str.length; i++) h = (h << 5) + h + str.charCodeAt(i);
      return h >>> 0;          // è½¬æˆæ­£ 32 ä½æ•´æ•°
    };

    const localDocMap = new Map(local.docs.map(d => [d.id, d]));
    const cloudDocMap = new Map(cloud.docs.map(d => [d.id, d]));
    // åªæ’é™¤äº‘ç«¯å·²åˆ é™¤çš„ idï¼›æœ¬åœ°å·²åˆ é™¤ä»è¦å‚ä¸åˆå¹¶ï¼Œä»¥ä¾¿æŠŠåˆ é™¤åŒæ­¥åˆ°äº‘ç«¯
    const aliveIds = new Set([
      ...local.docs.map(d => d.id),                       // æœ¬åœ°å…¨éƒ¨ä¿ç•™
      ...cloud.docs.filter(d => !d.deletedAt).map(d => d.id) // äº‘ç«¯åªç•™æœªåˆ é™¤
    ]);
    const allIds = aliveIds;

    for (const id of allIds) {
      const ld = localDocMap.get(id);
      const cd = cloudDocMap.get(id);

      if (!ld && cd) {           // ä»…äº‘ç«¯æœ‰
        target.docs.push(cd);
      } else if (ld && !cd) {    // ä»…æœ¬åœ°æœ‰
        target.docs.push(ld);
      } else {                   // ä¸¤è¾¹éƒ½æœ‰
        const hashL = hashDoc(ld);
        const hashC = hashDoc(cd);
        if (hashL === hashC) {   // å†…å®¹ç›¸åŒï¼Œç”¨äº‘ç«¯
          target.docs.push(cd);
        } else {                 // å†…å®¹ä¸åŒï¼ŒæŒ‰æ—¶é—´æˆ³å†³èƒœ
          target.docs.push(Number(ld.updatedAt) >= Number(cd.updatedAt) ? ld : cd);
        }
      }
    }

    // 2. AI é…ç½®ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.aiConfigLastModified && cloud.aiConfigLastModified) {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    } else if (local.aiConfigLastModified && !cloud.aiConfigLastModified) {
      target.aiConfig = local.aiConfig;
      target.aiConfigHash = local.aiConfigHash;
      target.aiConfigLastModified = local.aiConfigLastModified;
    } else if (local.aiConfigHash === cloud.aiConfigHash) {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    } else if (local.aiConfigLastModified >= cloud.aiConfigLastModified) {
      target.aiConfig = local.aiConfig;
      target.aiConfigHash = local.aiConfigHash;
      target.aiConfigLastModified = local.aiConfigLastModified;
    } else {
      target.aiConfig = cloud.aiConfig;
      target.aiConfigHash = cloud.aiConfigHash;
      target.aiConfigLastModified = cloud.aiConfigLastModified;
    }

    // 3. æç¤ºè¯æ¨¡æ¿ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.promptTemplatesLastModified && cloud.promptTemplatesLastModified) {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    } else if (local.promptTemplatesLastModified && !cloud.promptTemplatesLastModified) {
      target.promptTemplates = local.promptTemplates;
      target.promptTemplatesHash = local.promptTemplatesHash;
      target.promptTemplatesLastModified = local.promptTemplatesLastModified;
    } else if (local.promptTemplatesHash === cloud.promptTemplatesHash) {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    } else if (local.promptTemplatesLastModified >= cloud.promptTemplatesLastModified) {
      target.promptTemplates = local.promptTemplates;
      target.promptTemplatesHash = local.promptTemplatesHash;
      target.promptTemplatesLastModified = local.promptTemplatesLastModified;
    } else {
      target.promptTemplates = cloud.promptTemplates;
      target.promptTemplatesHash = cloud.promptTemplatesHash;
      target.promptTemplatesLastModified = cloud.promptTemplatesLastModified;
    }

    // 4. æˆ‘çš„æç¤ºè¯æ¨¡æ¿ï¼šä¸‰å‘åˆå¹¶ï¼ˆå“ˆå¸Œç›¸åŒç”¨äº‘ç«¯ï¼Œä¸åŒè°æ–°ç”¨è°ï¼‰
    if (!local.myPromptTemplatesLastModified && cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesLastModified && !cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = local.myPromptTemplates;
      target.myPromptTemplatesHash = local.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = local.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesHash === cloud.myPromptTemplatesHash) {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    } else if (local.myPromptTemplatesLastModified >= cloud.myPromptTemplatesLastModified) {
      target.myPromptTemplates = local.myPromptTemplates;
      target.myPromptTemplatesHash = local.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = local.myPromptTemplatesLastModified;
    } else {
      target.myPromptTemplates = cloud.myPromptTemplates;
      target.myPromptTemplatesHash = cloud.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloud.myPromptTemplatesLastModified;
    }

    console.log('åˆå¹¶åçš„ç›®æ ‡ç»“æ„:', target);
    return target;
  }

  // è½åœ°ï¼šäº‘ç«¯
  async function applyTargetToCloud(target, cloudFullData, cloudObj) {
    const user = AV.User.current();
    if (!user) throw new Error('æœªç™»å½•');

    // 0. å…ˆè¡¥å›äº‘ç«¯å·²åˆ é™¤è®°å½•ï¼ˆæœ¬åœ°å¯èƒ½å·²å½»åº•å‰”é™¤ï¼‰ï¼Œå¾—åˆ°å®Œæ•´ç›®æ ‡
    const targetIds = new Set((target.docs || []).map(d => d.id));
    const mergedDocs = [...(target.docs || [])];
    for (const cd of (cloudFullData ? cloudFullData.docs : [])) {
      if (!targetIds.has(cd.id) && cd.deletedAt) {
        mergedDocs.push(cd);   // äº‘ç«¯ç‹¬æœ‰ä¸”å·²æ ‡è®°åˆ é™¤
      }
    }


    // 1. ç”¨è¡¥å›åçš„å®Œæ•´ç›®æ ‡ä¸äº‘ç«¯å¯¹æ¯”ï¼Œè‹¥å®Œå…¨ä¸€è‡´ç›´æ¥è·³è¿‡
    if (cloudFullData &&
      target.aiConfigHash === cloudFullData.aiConfigHash &&
      target.promptTemplatesHash === cloudFullData.promptTemplatesHash &&
      target.myPromptTemplatesHash === cloudFullData.myPromptTemplatesHash &&
      JSON.stringify(mergedDocs.map(d => ({ id: d.id, updatedAt: d.updatedAt, deleted: d.deleted, images: d.images || [] }))) ===
      JSON.stringify(cloudFullData.docs.map(d => ({ id: d.id, updatedAt: d.updatedAt, deleted: d.deleted, images: d.images || [] })))) {
      showSuccess('äº‘ç«¯ä¸æœ¬åœ°ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥');
      return;   // æ— éœ€çœŸæ­£è½åº“
    }


    // ä½¿ç”¨ä¼ å…¥çš„äº‘ç«¯å¯¹è±¡ï¼Œé¿å…é‡å¤ä¸‹è½½
    const obj = cloudObj || await fetchOrCreateRecord();
    obj.set('docs', mergedDocs);
    obj.set('aiConfig', target.aiConfig);
    obj.set('aiConfigHash', target.aiConfigHash);
    obj.set('configUpdatedAt', target.aiConfigLastModified);
    obj.set('promptTemplates', target.promptTemplates);
    obj.set('promptTemplatesHash', target.promptTemplatesHash);
    obj.set('templateUpdatedAt', target.promptTemplatesLastModified);
    obj.set('myPromptTemplates', target.myPromptTemplates);
    obj.set('myPromptTemplatesHash', target.myPromptTemplatesHash);
    obj.set('myPromptTemplateUpdatedAt', target.myPromptTemplatesLastModified);
    obj.set('docUpdatedAt', Math.max(...mergedDocs.map(d => Number(d.updatedAt)), 0));
    obj.set('updatedAtMs', Date.now());   // è¡¥ä¸Šç»Ÿä¸€æ—¶é—´æˆ³

    await obj.save();
  }




  // æ˜¾ç¤ºå†²çªç¡®è®¤å¯¹è¯æ¡†
  function showConflictDialog(conflicts) {
    if (!conflicts || conflicts.length === 0) return true;

    const conflictList = conflicts.map(conflict =>
      `æ–‡æ¡£ï¼š${conflict.title}\n` +
      `æœ¬åœ°ä¿®æ”¹æ—¶é—´ï¼š${new Date(conflict.localTime).toLocaleString()}\n` +
      `äº‘ç«¯ä¿®æ”¹æ—¶é—´ï¼š${new Date(conflict.cloudTime).toLocaleString()}\n`
    ).join('\n---\n\n');

    const message = `æ£€æµ‹åˆ° ${conflicts.length} ä¸ªæ½œåœ¨å†²çªï¼š\n\n${conflictList}\n` +
      'è¿™äº›æ–‡æ¡£åœ¨æœ¬åœ°å’Œäº‘ç«¯éƒ½æœ‰ä¿®æ”¹ï¼Œä¸”æ—¶é—´å¾ˆæ¥è¿‘ã€‚\n' +
      'ç»§ç»­åŒæ­¥å°†æŒ‰ç…§"è°æ–°ç”¨è°"çš„è§„åˆ™å¤„ç†ã€‚\n\n' +
      'æ˜¯å¦ç»§ç»­åŒæ­¥ï¼Ÿ';

    return confirm(message);
  }

  function showInfo(msg) { try { window.showInfo && window.showInfo(msg); } catch (_) { } }
  function showSuccess(msg) { try { window.showSuccess && window.showSuccess(msg); } catch (_) { } }
  function showError(msg) { try { window.showError && window.showError(msg); } catch (_) { alert(msg); } }
  function applyLangUIOnce() { try { if (typeof window.__mw_applyLangToUI === 'function') window.__mw_applyLangToUI(); } catch (_) { } }

  async function fetchOrCreateRecord() {
    const user = AV.User.current();
    if (!user) throw new Error('æœªç™»å½•');
    const MWData = AV.Object.extend(CLASS_NAME);
    try {
      const query = new AV.Query(MWData);
      query.equalTo('ownerId', user.id);
      const list = await query.find();
      if (list && list.length > 0) return list[0];
    } catch (e) {
      // Class å°šæœªåˆ›å»ºæˆ–æ—  schemaï¼šå¿½ç•¥æŸ¥è¯¢é”™è¯¯ï¼Œç›´æ¥åˆ›å»º
    }
    const obj = new MWData();
    obj.set('ownerId', user.id);
    obj.set('docs', []);
    obj.set('aiConfig', {});
    obj.set('promptTemplates', []);
    obj.set('myPromptTemplates', []);
    obj.set('docUpdatedAt', Date.now()); // ä½¿ç”¨å½“å‰æ—¶é—´è€Œä¸æ˜¯0
    obj.set('configUpdatedAt', Date.now());
    obj.set('templateUpdatedAt', Date.now());
    obj.set('myPromptTemplateUpdatedAt', Date.now());
    return await obj.save();
  }


  async function downloadCloud() {
    const obj = await fetchOrCreateRecord();
    const docs = obj.get('docs') || [];
    const docUpdatedAt = obj.get('docUpdatedAt') || 0;
    const aiConfig = obj.get('aiConfig') || {};
    const promptTemplates = obj.get('promptTemplates') || [];
    const myPromptTemplates = obj.get('myPromptTemplates') || [];

    const configUpdatedAt = obj.get('configUpdatedAt') || 0;
    const templateUpdatedAt = obj.get('templateUpdatedAt') || 0;
    const myPromptTemplateUpdatedAt = obj.get('myPromptTemplateUpdatedAt') || 0;

    // æ–°å¢ï¼šè¡¥é½ä¸Šè¡Œæ—¶ä¼šå†™å…¥çš„å“ˆå¸Œä¸ç»Ÿä¸€æ—¶é—´æˆ³
    const aiConfigHash = obj.get('aiConfigHash') || undefined;
    const promptTemplatesHash = obj.get('promptTemplatesHash') || undefined;
    const myPromptTemplatesHash = obj.get('myPromptTemplatesHash') || undefined;

    const updatedAtMs = obj.get('updatedAtMs') || 0;

    return {
      obj,
      docs,
      aiConfig,
      promptTemplates,
      myPromptTemplates,
      docUpdatedAt,
      configUpdatedAt,
      templateUpdatedAt,
      myPromptTemplateUpdatedAt,
      aiConfigHash,        // æ–°å¢
      promptTemplatesHash, // æ–°å¢
      myPromptTemplatesHash, // æ–°å¢
      updatedAtMs          // æ–°å¢
    };
  }

  // è½åœ°ï¼šæœ¬åœ°ï¼ˆåŒæ­¥åç‰©ç†åˆ é™¤å·²æ ‡è®°æ–‡æ¡£ï¼‰
  function applyTargetToLocal(target) {
    // ç‰©ç†å‰”é™¤å·²åˆ é™¤æ–‡æ¡£
    const aliveDocs = target.docs.filter(d => !d.deletedAt);
    localStorage.setItem('mw_documents', JSON.stringify(aliveDocs));
    // AI é…ç½®
    localStorage.setItem('allAIPlatformConfigs', JSON.stringify(target.aiConfig));
    localStorage.setItem('allAIPlatformConfigs_hash', target.aiConfigHash);
    localStorage.setItem('allAIPlatformConfigs_last_modified', String(target.aiConfigLastModified));
    // æç¤ºè¯æ¨¡æ¿
    localStorage.setItem('promptTemplates', JSON.stringify(target.promptTemplates));
    localStorage.setItem('promptTemplates_hash', target.promptTemplatesHash);
    localStorage.setItem('promptTemplates_last_modified', String(target.promptTemplatesLastModified));
    // æˆ‘çš„æç¤ºè¯æ¨¡æ¿
    localStorage.setItem('myPromptTemplates', JSON.stringify(target.myPromptTemplates));
    localStorage.setItem('myPromptTemplates_hash', target.myPromptTemplatesHash);
    localStorage.setItem('myPromptTemplates_last_modified', String(target.myPromptTemplatesLastModified));
    // åŒæ­¥æ—¶é—´æˆ³
    localStorage.setItem('mindword_last_sync_at', String(Date.now()));
  }

  // async function uploadCloud(obj, docs) {
  //   obj.set('docs', docs);
  //   obj.set('updatedAtMs', Date.now());
  //   return await obj.save();
  // }

  // æ˜¾ç¤ºåŒæ­¥é¢„è§ˆå¯¹è¯æ¡†
  async function showSyncPreviewDialog(localFullData, cloudFullData, targetFullData) {
    return new Promise((resolve) => {
      // åˆ›å»ºå¯¹è¯æ¡†HTML
      const dialog = document.createElement('div');
      dialog.id = 'sync-preview-dialog';
      dialog.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 1000px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: #333; font-size: 20px; font-weight: 600;">ğŸ”„ åŒæ­¥é¢„è§ˆ</h3>
              <div style="margin-left: auto; font-size: 12px; color: #666; background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">
                é€‰æ‹©è¦ä¿ç•™çš„æ•°æ®
              </div>
            </div>
            <div style="flex: 1; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f5f5f5; position: sticky; top: 0; z-index: 10;">
                  <tr>
                    <th style="padding: 16px; text-align: center; border-bottom: 1px solid #ddd; width: 50%; color: #333; font-weight: 600; font-size: 14px;">
                      <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>ğŸ“</span>
                        <span>æœ¬åœ°æ•°æ®</span>
                      </span>
                    </th>
                    <th style="padding: 16px; text-align: center; border-bottom: 1px solid #ddd; width: 50%; color: #333; font-weight: 600; font-size: 14px;">
                      <span style="display: inline-flex; align-items: center; gap: 8px;">
                        <span>â˜ï¸</span>
                        <span>äº‘ç«¯æ•°æ®</span>
                      </span>
                    </th>
                  </tr>
                </thead>
                <tbody id="sync-preview-tbody">
                </tbody>
              </table>
            </div>
            <div style="margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; align-items: center;">
              <div>
                <button id="sync-preview-cancel" style="margin-right: 12px; padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;">å–æ¶ˆ</button>
                <button id="sync-preview-confirm" style="padding: 10px 24px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);">ğŸ”„ ç¡®å®šåŒæ­¥</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(dialog);

      // ç”Ÿæˆå¯¹æ¯”æ•°æ®
      const tbody = document.getElementById('sync-preview-tbody');
      const comparisons = generateSyncComparisons(localFullData, cloudFullData, targetFullData);

      comparisons.forEach((item, index) => {
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #eee';

        // å¦‚æœå†…å®¹ä¸€è‡´ï¼Œä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²èƒŒæ™¯ï¼Œç¦ç”¨é€‰æ‹©åŠŸèƒ½
        if (item.isContentSame) {
          row.style.backgroundColor = '#f0f0f0';
          row.style.opacity = '0.8';
        }

        // çŠ¶æ€ç®¡ç† - ä½¿ç”¨æ•°æ®å±æ€§å­˜å‚¨å½“å‰é€‰æ‹©
        row.dataset.choice = item.recommendLocal ? 'local' : 'cloud';

        // æœ¬åœ°æ•°æ®åˆ—
        const localCell = document.createElement('td');
        localCell.style.padding = '8px';
        localCell.style.verticalAlign = 'top';
        localCell.style.position = 'relative';
        localCell.style.cursor = 'pointer';
        localCell.style.transition = 'all 0.2s ease';
        localCell.style.width = '50%';

        const updateLocalCellStyle = () => {
          if (item.isContentSame) {
            // å†…å®¹ä¸€è‡´æ—¶ä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²æ ·å¼
            localCell.style.backgroundColor = '#e8e8e8';
            localCell.style.border = '1px solid #ccc';
            localCell.style.borderRadius = '6px';
            localCell.style.margin = '2px';
          } else {
            const isSelected = row.dataset.choice === 'local';
            localCell.style.backgroundColor = isSelected ? '#f0f8f0' : '#fafafa';
            localCell.style.border = isSelected ? '2px solid #28a745' : '1px solid #eee';
            localCell.style.borderRadius = '6px';
            localCell.style.margin = '2px';

            // æ›´æ–°å‹¾é€‰å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€
            const checkMark = localCell.querySelector('.check-mark');
            const cloudCheckMark = cloudCell.querySelector('.check-mark');
            if (checkMark && cloudCheckMark) {
              checkMark.style.display = isSelected ? 'block' : 'none';
              cloudCheckMark.style.display = !isSelected ? 'block' : 'none';
            }
          }
        };

        localCell.innerHTML = `
          <div style="font-weight: bold; color: #333; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
            <span>${item.local.name}</span>
            <span class="check-mark" style="color: #28a745; font-size: 16px; display: ${item.isContentSame ? 'none' : (row.dataset.choice === 'local' ? 'block' : 'none')};">âœ“</span>
          </div>
          <div style="font-size: 11px; color: #666; line-height: 1.3;">${item.local.description}</div>
          <div style="font-size: 11px; color: #999; margin-top: 2px;">æ›´æ–°æ—¶é—´: ${item.local.updatedAt}</div>
        `;

        // ç‚¹å‡»æœ¬åœ°åˆ—é€‰æ‹©æœ¬åœ° - å†…å®¹ä¸€è‡´æ—¶ç¦ç”¨ç‚¹å‡»
        localCell.addEventListener('click', () => {
          if (item.isContentSame) return; // å†…å®¹ä¸€è‡´æ—¶ä¸å…è®¸åˆ‡æ¢
          row.dataset.choice = 'local';
          updateLocalCellStyle();
          updateCloudCellStyle();
        });

        // äº‘ç«¯æ•°æ®åˆ—
        const cloudCell = document.createElement('td');
        cloudCell.style.padding = '8px';
        cloudCell.style.verticalAlign = 'top';
        cloudCell.style.position = 'relative';
        cloudCell.style.cursor = 'pointer';
        cloudCell.style.transition = 'all 0.2s ease';
        cloudCell.style.width = '50%';

        const updateCloudCellStyle = () => {
          if (item.isContentSame) {
            // å†…å®¹ä¸€è‡´æ—¶ä½¿ç”¨ç»Ÿä¸€çš„æ·¡ç°è‰²æ ·å¼
            cloudCell.style.backgroundColor = '#e8e8e8';
            cloudCell.style.border = '1px solid #ccc';
            cloudCell.style.borderRadius = '6px';
            cloudCell.style.margin = '2px';
          } else {
            const isSelected = row.dataset.choice === 'cloud';
            cloudCell.style.backgroundColor = isSelected ? '#f0f8f0' : '#fafafa';
            cloudCell.style.border = isSelected ? '2px solid #28a745' : '1px solid #eee';
            cloudCell.style.borderRadius = '6px';
            cloudCell.style.margin = '2px';

            // æ›´æ–°å‹¾é€‰å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€
            const checkMark = cloudCell.querySelector('.check-mark');
            const localCheckMark = localCell.querySelector('.check-mark');
            if (checkMark && localCheckMark) {
              checkMark.style.display = isSelected ? 'block' : 'none';
              localCheckMark.style.display = !isSelected ? 'block' : 'none';
            }
          }
        };

        cloudCell.innerHTML = `
          <div style="font-weight: bold; color: #333; margin-bottom: 2px; display: flex; align-items: center; justify-content: space-between;">
            <span>${item.cloud.name}</span>
            <span class="check-mark" style="color: #28a745; font-size: 16px; display: ${item.isContentSame ? 'none' : (row.dataset.choice === 'cloud' ? 'block' : 'none')};">âœ“</span>
          </div>
          <div style="font-size: 11px; color: #666; line-height: 1.3;">${item.cloud.description}</div>
          <div style="font-size: 11px; color: #999; margin-top: 2px;">æ›´æ–°æ—¶é—´: ${item.cloud.updatedAt}</div>
        `;

        // ç‚¹å‡»äº‘ç«¯åˆ—é€‰æ‹©äº‘ç«¯ - å†…å®¹ä¸€è‡´æ—¶ç¦ç”¨ç‚¹å‡»
        cloudCell.addEventListener('click', () => {
          if (item.isContentSame) return; // å†…å®¹ä¸€è‡´æ—¶ä¸å…è®¸åˆ‡æ¢
          row.dataset.choice = 'cloud';
          updateLocalCellStyle();
          updateCloudCellStyle();
        });

        // åˆå§‹åŒ–æ ·å¼
        updateLocalCellStyle();
        updateCloudCellStyle();

        row.appendChild(localCell);
        row.appendChild(cloudCell);
        tbody.appendChild(row);
      });

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('sync-preview-cancel').addEventListener('click', () => {
        document.body.removeChild(dialog);
        resolve(null); // ç”¨æˆ·å–æ¶ˆ
      });

      document.getElementById('sync-preview-confirm').addEventListener('click', () => {
        const choices = {};
        comparisons.forEach((item, index) => {
          // ç›´æ¥ä»è¡Œæ•°æ®å±æ€§è·å–é€‰æ‹©çŠ¶æ€
          const row = document.querySelectorAll('#sync-preview-tbody tr')[index];
          choices[item.key] = row.dataset.choice || (item.recommendLocal ? 'local' : 'cloud');
        });

        document.body.removeChild(dialog);
        resolve(choices); // è¿”å›ç”¨æˆ·é€‰æ‹©
      });
    });
  }

  // ç”ŸæˆåŒæ­¥å¯¹æ¯”æ•°æ®
  function generateSyncComparisons(localFullData, cloudFullData, targetFullData) {
    const comparisons = [];

    // æ–‡æ¡£å¯¹æ¯”
    const localDocs = localFullData.docs || [];
    const cloudDocs = cloudFullData.docs || [];

    // è¿‡æ»¤æ‰è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£
    const filteredLocalDocs = localDocs.filter(doc => !isAutoGeneratedEmptyDoc(doc));
    const filteredCloudDocs = cloudDocs.filter(doc => !isAutoGeneratedEmptyDoc(doc));

    const localDocMap = new Map(filteredLocalDocs.map(d => [d.id, d]));
    const cloudDocMap = new Map(filteredCloudDocs.map(d => [d.id, d]));

    // æ‰¾å‡ºæ‰€æœ‰æ–‡æ¡£IDï¼ˆåªåŒ…å«è¿‡æ»¤åçš„æ–‡æ¡£ï¼‰
    const allDocIds = new Set([...filteredLocalDocs.map(d => d.id), ...filteredCloudDocs.map(d => d.id)]);

    allDocIds.forEach(docId => {
      const localDoc = localDocMap.get(docId);
      const cloudDoc = cloudDocMap.get(docId);

      if (localDoc && cloudDoc) {
        // ä¸¤è¾¹éƒ½æœ‰ - æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸€è‡´ï¼ˆåŒ…å«å›¾ç‰‡æ•°æ®ï¼‰
        const isContentSame = localDoc.md === cloudDoc.md && JSON.stringify(localDoc.images || []) === JSON.stringify(cloudDoc.images || []);
        let description = '';
        
        if (isContentSame) {
          description = '<span style="color: #28a745;">å†…å®¹ä¸€è‡´ âœ“</span>';
        } else {
          // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡å˜åŒ–
          const localImages = localDoc.images || [];
          const cloudImages = cloudDoc.images || [];
          const imagesChanged = JSON.stringify(localImages) !== JSON.stringify(cloudImages);
          const mdChanged = localDoc.md !== cloudDoc.md;
          
          if (mdChanged && imagesChanged) {
            description = '<span style="color: #dc3545;">å†…å®¹å’Œå›¾ç‰‡éƒ½å·²å˜æ›´</span>';
          } else if (imagesChanged) {
            description = '<span style="color: #ffc107;">å›¾ç‰‡å·²å˜æ›´</span>';
          } else {
            description = '<span style="color: #dc3545;">å†…å®¹ä¸ä¸€è‡´</span>';
          }
        }
        const localTime = new Date(Number(localDoc.updatedAt)).toLocaleString();
        const cloudTime = new Date(Number(cloudDoc.updatedAt)).toLocaleString();
        const recommendLocal = localDoc.updatedAt >= cloudDoc.updatedAt;

        // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡æ¡£è¢«åˆ é™¤
        const localDeleted = localDoc.deletedAt;
        const cloudDeleted = cloudDoc.deletedAt;

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: localDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: localDeleted ? '<span style="color: #dc3545;">æœ¬åœ°å·²åˆ é™¤æ–‡æ¡£</span>' : description,
            updatedAt: localTime
          },
          cloud: {
            name: cloudDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: cloudDeleted ? '<span style="color: #dc3545;">äº‘ç«¯å·²åˆ é™¤æ–‡æ¡£</span>' : description,
            updatedAt: cloudTime
          },
          recommendLocal: recommendLocal,
          isContentSame: isContentSame && !localDeleted && !cloudDeleted
        });
      } else if (localDoc && !cloudDoc) {
        // åªæœ‰æœ¬åœ°æœ‰ - åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯åˆ é™¤
        // å¦‚æœæœ¬åœ°æ–‡æ¡£å·²åˆ é™¤ï¼Œåˆ™è·³è¿‡è¿™ä¸ªå¯¹æ¯”ï¼ˆç©ºå¯¹ç©ºæ²¡æœ‰æ„ä¹‰ï¼‰
        if (localDoc.deletedAt) {
          return; // è·³è¿‡æœ¬åœ°å·²åˆ é™¤æ–‡æ¡£
        }

        const isRecentlyUpdated = localDoc.updatedAt > Date.now() - 24 * 60 * 60 * 1000; // 24å°æ—¶å†…æ›´æ–°è¿‡
        let description = '';

        if (isRecentlyUpdated) {
          description = '<span style="color: #28a745;">æœ¬åœ°æ–°å¢æ–‡æ¡£</span>';
        } else {
          description = '<span style="color: #28a745;">æœ¬åœ°ç‹¬æœ‰æ–‡æ¡£</span>';
        }

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: localDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: description,
            updatedAt: new Date(Number(localDoc.updatedAt)).toLocaleString()
          },
          cloud: {
            name: '(æ— )',
            description: 'äº‘ç«¯ä¸å­˜åœ¨',
            updatedAt: '-'
          },
          recommendLocal: true
        });
      } else if (!localDoc && cloudDoc) {
        // åªæœ‰äº‘ç«¯æœ‰ - åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯åˆ é™¤
        // å¦‚æœäº‘ç«¯æ–‡æ¡£å·²åˆ é™¤ï¼Œåˆ™è·³è¿‡è¿™ä¸ªå¯¹æ¯”ï¼ˆç©ºå¯¹ç©ºæ²¡æœ‰æ„ä¹‰ï¼‰
        if (cloudDoc.deletedAt) {
          return; // è·³è¿‡äº‘ç«¯å·²åˆ é™¤æ–‡æ¡£
        }

        const isRecentlyUpdated = cloudDoc.updatedAt > Date.now() - 24 * 60 * 60 * 1000; // 24å°æ—¶å†…æ›´æ–°è¿‡
        let description = '';

        if (isRecentlyUpdated) {
          description = '<span style="color: #28a745;">äº‘ç«¯æ–°å¢æ–‡æ¡£</span>';
        } else {
          description = '<span style="color: #28a745;">äº‘ç«¯ç‹¬æœ‰æ–‡æ¡£</span>';
        }

        comparisons.push({
          key: `doc_${docId}`,
          local: {
            name: '(æ— )',
            description: 'æœ¬åœ°ä¸å­˜åœ¨',
            updatedAt: '-'
          },
          cloud: {
            name: cloudDoc.name || 'æœªå‘½åæ–‡æ¡£',
            description: description,
            updatedAt: new Date(Number(cloudDoc.updatedAt)).toLocaleString()
          },
          recommendLocal: false
        });
      }
    });

    // AIé…ç½®å¯¹æ¯”
    const localAIConfig = localFullData.aiConfig || {};
    const cloudAIConfig = cloudFullData.aiConfig || {};
    const localAIConfigTime = new Date(localFullData.aiConfigLastModified).toLocaleString();
    const cloudAIConfigTime = new Date(cloudFullData.aiConfigLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isAIConfigSame = localFullData.aiConfigHash === cloudFullData.aiConfigHash;

    // åˆ¤æ–­é…ç½®æ˜¯å¦ä¸ºç©º
    const localConfigEmpty = Object.keys(localAIConfig).length === 0;
    const cloudConfigEmpty = Object.keys(cloudAIConfig).length === 0;

    comparisons.push({
      key: 'ai_config',
      local: {
        name: 'AIå¹³å°é…ç½®',
        description: isAIConfigSame ? `é…ç½®ä¸€è‡´ âœ“ (å¹³å°æ•°é‡: ${Object.keys(localAIConfig).length}ä¸ª)` :
          localConfigEmpty ? 'æœ¬åœ°æ— é…ç½®' : `å¹³å°æ•°é‡: ${Object.keys(localAIConfig).length}ä¸ª`,
        updatedAt: localAIConfigTime
      },
      cloud: {
        name: 'AIå¹³å°é…ç½®',
        description: isAIConfigSame ? `é…ç½®ä¸€è‡´ âœ“ (å¹³å°æ•°é‡: ${Object.keys(cloudAIConfig).length}ä¸ª)` :
          cloudConfigEmpty ? 'äº‘ç«¯æ— é…ç½®' : `å¹³å°æ•°é‡: ${Object.keys(cloudAIConfig).length}ä¸ª`,
        updatedAt: cloudAIConfigTime
      },
      recommendLocal: localFullData.aiConfigLastModified >= cloudFullData.aiConfigLastModified,
      isContentSame: isAIConfigSame
    });

    // æç¤ºè¯æ¨¡æ¿å¯¹æ¯”
    const localPromptTemplates = localFullData.promptTemplates || [];
    const cloudPromptTemplates = cloudFullData.promptTemplates || [];
    const localPromptTime = new Date(localFullData.promptTemplatesLastModified).toLocaleString();
    const cloudPromptTime = new Date(cloudFullData.promptTemplatesLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isPromptTemplatesSame = localFullData.promptTemplatesHash === cloudFullData.promptTemplatesHash;

    // åˆ¤æ–­æ¨¡æ¿æ˜¯å¦ä¸ºç©º
    const localTemplatesEmpty = localPromptTemplates.length === 0;
    const cloudTemplatesEmpty = cloudPromptTemplates.length === 0;

    comparisons.push({
      key: 'prompt_templates',
      local: {
        name: 'æç¤ºè¯æ¨¡æ¿',
        description: isPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${localPromptTemplates.length}ä¸ª)` :
          localTemplatesEmpty ? 'æœ¬åœ°æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${localPromptTemplates.length}ä¸ª`,
        updatedAt: localPromptTime
      },
      cloud: {
        name: 'æç¤ºè¯æ¨¡æ¿',
        description: isPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${cloudPromptTemplates.length}ä¸ª)` :
          cloudTemplatesEmpty ? 'äº‘ç«¯æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${cloudPromptTemplates.length}ä¸ª`,
        updatedAt: cloudPromptTime
      },
      recommendLocal: localFullData.promptTemplatesLastModified >= cloudFullData.promptTemplatesLastModified,
      isContentSame: isPromptTemplatesSame
    });

    // æˆ‘çš„æç¤ºè¯æ¨¡æ¿å¯¹æ¯”
    const localMyPromptTemplates = localFullData.myPromptTemplates || [];
    const cloudMyPromptTemplates = cloudFullData.myPromptTemplates || [];
    const localMyPromptTime = new Date(localFullData.myPromptTemplatesLastModified).toLocaleString();
    const cloudMyPromptTime = new Date(cloudFullData.myPromptTemplatesLastModified).toLocaleString();
    // ä½¿ç”¨å“ˆå¸Œå€¼å¿«é€Ÿå¯¹æ¯”å†…å®¹ä¸€è‡´æ€§
    const isMyPromptTemplatesSame = localFullData.myPromptTemplatesHash === cloudFullData.myPromptTemplatesHash;

    // åˆ¤æ–­æ¨¡æ¿æ˜¯å¦ä¸ºç©º
    const localMyTemplatesEmpty = localMyPromptTemplates.length === 0;
    const cloudMyTemplatesEmpty = cloudMyPromptTemplates.length === 0;

    comparisons.push({
      key: 'my_prompt_templates',
      local: {
        name: 'æˆ‘çš„æç¤ºè¯æ¨¡æ¿',
        description: isMyPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${localMyPromptTemplates.length}ä¸ª)` :
          localMyTemplatesEmpty ? 'æœ¬åœ°æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${localMyPromptTemplates.length}ä¸ª`,
        updatedAt: localMyPromptTime
      },
      cloud: {
        name: 'æˆ‘çš„æç¤ºè¯æ¨¡æ¿',
        description: isMyPromptTemplatesSame ? `æ¨¡æ¿ä¸€è‡´ âœ“ (æ¨¡æ¿æ•°é‡: ${cloudMyPromptTemplates.length}ä¸ª)` :
          cloudMyTemplatesEmpty ? 'äº‘ç«¯æ— æ¨¡æ¿' : `æ¨¡æ¿æ•°é‡: ${cloudMyPromptTemplates.length}ä¸ª`,
        updatedAt: cloudMyPromptTime
      },
      recommendLocal: localFullData.myPromptTemplatesLastModified >= cloudFullData.myPromptTemplatesLastModified,
      isContentSame: isMyPromptTemplatesSame
    });

    return comparisons;
  }

  // æ ¹æ®ç”¨æˆ·é€‰æ‹©é‡æ–°æ„å»ºç›®æ ‡æ•°æ®
  function buildTargetFromChoices(localFullData, cloudFullData, choices) {
    const target = {
      docs: [],
      aiConfig: {},
      promptTemplates: [],
      myPromptTemplates: [],
      aiConfigHash: undefined,
      aiConfigLastModified: 0,
      promptTemplatesHash: undefined,
      promptTemplatesLastModified: 0,
      myPromptTemplatesHash: undefined,
      myPromptTemplatesLastModified: 0,
      lastSyncAt: Date.now()
    };

    // å¤„ç†æ–‡æ¡£é€‰æ‹©
    const localDocs = localFullData.docs || [];
    const cloudDocs = cloudFullData.docs || [];
    const localDocMap = new Map(localDocs.map(d => [d.id, d]));
    const cloudDocMap = new Map(cloudDocs.map(d => [d.id, d]));
    const allDocIds = new Set([...localDocs.map(d => d.id), ...cloudDocs.map(d => d.id)]);

    allDocIds.forEach(docId => {
      const choice = choices[`doc_${docId}`];
      
      // ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†æœ¬åœ°ç‰ˆæœ¬
      if (choice === 'local') {
        if (localDocMap.has(docId)) {
          target.docs.push(localDocMap.get(docId));
        }
        // å¦‚æœç”¨æˆ·é€‰æ‹©æœ¬åœ°ä½†æœ¬åœ°ä¸å­˜åœ¨è¯¥æ–‡æ¡£ï¼Œåˆ™ä¸æ·»åŠ ï¼ˆå³åˆ é™¤ï¼‰
      }
      // ç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†äº‘ç«¯ç‰ˆæœ¬
      else if (choice === 'cloud') {
        if (cloudDocMap.has(docId)) {
          target.docs.push(cloudDocMap.get(docId));
        }
        // å¦‚æœç”¨æˆ·é€‰æ‹©äº‘ç«¯ä½†äº‘ç«¯ä¸å­˜åœ¨è¯¥æ–‡æ¡£ï¼Œåˆ™ä¸æ·»åŠ ï¼ˆå³åˆ é™¤ï¼‰
      }
      // ç”¨æˆ·æ²¡æœ‰é€‰æ‹©ï¼Œä½¿ç”¨æ¨èé€»è¾‘
      else {
        if (localDocMap.has(docId) && cloudDocMap.has(docId)) {
          // ä¸¤è¾¹éƒ½æœ‰ï¼Œé€‰æ‹©æ›´æ–°æ—¶é—´è¾ƒæ–°çš„
          const localDoc = localDocMap.get(docId);
          const cloudDoc = cloudDocMap.get(docId);
          target.docs.push(localDoc.updatedAt >= cloudDoc.updatedAt ? localDoc : cloudDoc);
        } else if (localDocMap.has(docId)) {
          // åªæœ‰æœ¬åœ°æœ‰ï¼Œä¿ç•™æœ¬åœ°ç‰ˆæœ¬
          target.docs.push(localDocMap.get(docId));
        } else if (cloudDocMap.has(docId)) {
          // åªæœ‰äº‘ç«¯æœ‰ï¼Œä¿ç•™äº‘ç«¯ç‰ˆæœ¬
          target.docs.push(cloudDocMap.get(docId));
        }
      }
    });

    // å¤„ç†AIé…ç½®é€‰æ‹©
    if (choices.ai_config === 'local') {
      target.aiConfig = localFullData.aiConfig || {};
      target.aiConfigHash = localFullData.aiConfigHash;
      target.aiConfigLastModified = localFullData.aiConfigLastModified;
    } else {
      target.aiConfig = cloudFullData.aiConfig || {};
      target.aiConfigHash = cloudFullData.aiConfigHash;
      target.aiConfigLastModified = cloudFullData.aiConfigLastModified;
    }

    // å¤„ç†æç¤ºè¯æ¨¡æ¿é€‰æ‹©
    if (choices.prompt_templates === 'local') {
      target.promptTemplates = localFullData.promptTemplates || [];
      target.promptTemplatesHash = localFullData.promptTemplatesHash;
      target.promptTemplatesLastModified = localFullData.promptTemplatesLastModified;
    } else {
      target.promptTemplates = cloudFullData.promptTemplates || [];
      target.promptTemplatesHash = cloudFullData.promptTemplatesHash;
      target.promptTemplatesLastModified = cloudFullData.promptTemplatesLastModified;
    }

    // å¤„ç†æˆ‘çš„æç¤ºè¯æ¨¡æ¿é€‰æ‹©
    if (choices.my_prompt_templates === 'local') {
      target.myPromptTemplates = localFullData.myPromptTemplates || [];
      target.myPromptTemplatesHash = localFullData.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = localFullData.myPromptTemplatesLastModified;
    } else {
      target.myPromptTemplates = cloudFullData.myPromptTemplates || [];
      target.myPromptTemplatesHash = cloudFullData.myPromptTemplatesHash;
      target.myPromptTemplatesLastModified = cloudFullData.myPromptTemplatesLastModified;
    }

    return target;
  }

  // æ–°çš„åŒæ­¥é€»è¾‘ï¼šæŒ‰ç…§ç”¨æˆ·æ–¹æ¡ˆå®ç°
  async function bidirectionalSync() {
    try {
      if (getLang() !== 'zh') { showInfo('å½“å‰ä¸ºè‹±æ–‡æ¨¡å¼ï¼Œå·²ä½¿ç”¨ Cloudflare Worker åŒæ­¥'); return; }
      if (!isLoggedIn()) { throw new Error('æœªç™»å½•'); }
      showInfo('æ­£åœ¨æ™ºèƒ½åŒæ­¥...');

      // 1. ç»„è£…æœ¬åœ°å®Œæ•´å¿«ç…§
      const localDocs = getLocalDocs();
      const localAIConfig = getLocalAIConfig();
      const localPromptTemplates = getLocalPromptTemplates();
      const localMyPromptTemplates = getLocalMyPromptTemplates();
      const localFullData = {
        docs: localDocs,
        aiConfig: localAIConfig,
        aiConfigHash: localStorage.getItem('allAIPlatformConfigs_hash') || undefined,
        aiConfigLastModified: Number(localStorage.getItem('allAIPlatformConfigs_last_modified') || 0),
        promptTemplates: localPromptTemplates,
        promptTemplatesHash: localStorage.getItem('promptTemplates_hash') || undefined,
        promptTemplatesLastModified: Number(localStorage.getItem('promptTemplates_last_modified') || 0),
        myPromptTemplates: localMyPromptTemplates,
        myPromptTemplatesHash: localStorage.getItem('myPromptTemplates_hash') || undefined,
        myPromptTemplatesLastModified: Number(localStorage.getItem('myPromptTemplates_last_modified') || 0),
        lastSyncAt: Number(localStorage.getItem('mindword_last_sync_at') || 0)
      };

      // æ–‡ä»¶å¤§å°æ£€æŸ¥
      const sizeCheck = checkFileSize(localDocs);
      if (!sizeCheck.valid) {
        throw new Error('æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥ï¼š' + sizeCheck.errors.join('ï¼›'));
      }

      // 2. æ‹‰å–äº‘ç«¯åŒç»“æ„å¿«ç…§ï¼ˆé¦–æ¬¡æ‹‰å–æ—¶ç¼“å­˜åŸç”Ÿå¯¹è±¡ï¼‰
      cachedCloudRaw = await downloadCloud();
      const cloudFullData = await fetchCloudFullData();

      // 3. ä¸‰å‘åˆå¹¶ â†’ ç›®æ ‡ç»“æ„
      const targetFullData = mergeToTarget(localFullData, cloudFullData);

      // 4. æ˜¾ç¤ºåŒæ­¥é¢„è§ˆå¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©ä¿ç•™å“ªä¸€ä¾§çš„æ•°æ®
      const userChoices = await showSyncPreviewDialog(localFullData, cloudFullData, targetFullData);

      // ç”¨æˆ·å–æ¶ˆåŒæ­¥
      if (!userChoices) {
        showInfo('åŒæ­¥å·²å–æ¶ˆ');
        return;
      }

      // 5. æ ¹æ®ç”¨æˆ·é€‰æ‹©é‡æ–°æ„å»ºç›®æ ‡æ•°æ®
      const finalTargetFullData = buildTargetFromChoices(localFullData, cloudFullData, userChoices);

      // 6. è½åœ°ï¼šå…ˆå†™æœ¬åœ°ï¼Œå†å†™äº‘ç«¯ï¼ˆç¡®ä¿æœ¬åœ°ä¼˜å…ˆï¼‰
      applyTargetToLocal(finalTargetFullData);
      await applyTargetToCloud(finalTargetFullData, cloudFullData, cachedCloudRaw.obj);

      // 5. åˆ·æ–° UI
      if (typeof mw_renderList === 'function') mw_renderList();

      // 6. å¦‚æœå½“å‰æœ‰æ­£åœ¨ç¼–è¾‘çš„æ–‡æ¡£ï¼Œåˆ·æ–°æ•°æ®å±•ç¤º
      if (typeof mw_getActive === 'function' && typeof mw_notifyEditorLoad === 'function') {
        const activeId = mw_getActive();
        if (activeId && typeof mw_loadDocs === 'function') {
          const docs = mw_loadDocs();
          const currentDoc = docs.find(d => d.id === activeId);
          if (currentDoc) {
            // åˆ·æ–°å½“å‰æ–‡æ¡£åˆ°å„ä¸ªé¢æ¿
            mw_notifyEditorLoad(currentDoc);
            if (typeof mw_notifyPreviewLoad === 'function') mw_notifyPreviewLoad(currentDoc);
            if (typeof mw_notifyMindmapLoad === 'function') mw_notifyMindmapLoad(currentDoc);
            console.log('[SYNC] å·²åˆ·æ–°å½“å‰ç¼–è¾‘æ–‡æ¡£:', activeId);
          }
        }

        // æ£€æŸ¥å½“å‰æ–‡æ¡£æ˜¯å¦è¢«åˆ é™¤ï¼Œå¦‚æœæ˜¯åˆ™åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
        const currentActiveId = mw_getActive();
        if (currentActiveId) {
          const docs = getLocalDocs();
          const currentDoc = docs.find(d => d.id === currentActiveId);
          if (!currentDoc || currentDoc.deletedAt) {
            console.log('[SYNC] å½“å‰æ–‡æ¡£å·²è¢«åˆ é™¤ï¼Œå‡†å¤‡åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£');
            // åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœªåˆ é™¤çš„æ–‡æ¡£
            const firstValidDoc = docs.find(d => !d.deletedAt);
            if (firstValidDoc) {
              mw_setActive(firstValidDoc.id);
              mw_notifyEditorLoad(firstValidDoc);
              mw_notifyPreviewLoad(firstValidDoc);
              mw_notifyMindmapLoad(firstValidDoc);
              console.log('[SYNC] å·²åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£:', firstValidDoc.id);
            } else {
              // æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆç©ºæ–‡æ¡£ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨åˆ›å»º
              console.log('[SYNC] æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨åˆ›å»º');
            }
          }
        }
      }

      // 7. åŒæ­¥å®Œæˆåï¼Œå¦‚æœå½“å‰æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
      setTimeout(() => {
        const currentActiveId = mw_getActive();
        if (currentActiveId && typeof mw_loadDocs === 'function') {
          const docs = mw_loadDocs();
          const currentDoc = docs.find(d => d.id === currentActiveId);

          // å¦‚æœå½“å‰æ–‡æ¡£æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£
          if (currentDoc && isAutoGeneratedEmptyDoc(currentDoc)) {
            console.log('[SYNC] å½“å‰æ–‡æ¡£æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ç©ºæ–‡æ¡£ï¼Œå‡†å¤‡åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£');
            const validDocs = docs.filter(d => !d.deletedAt && !isAutoGeneratedEmptyDoc(d));
            if (validDocs.length > 0) {
              const firstValidDoc = validDocs[0];
              mw_setActive(firstValidDoc.id);
              mw_notifyEditorLoad(firstValidDoc);
              mw_notifyPreviewLoad(firstValidDoc);
              mw_notifyMindmapLoad(firstValidDoc);
              console.log('[SYNC] å·²åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ–‡æ¡£:', firstValidDoc.id);
            } else {
              console.log('[SYNC] æ²¡æœ‰æœ‰æ•ˆæ–‡æ¡£ï¼Œä¿æŒå½“å‰ç©ºæ–‡æ¡£çŠ¶æ€');
            }
          }
        }
      }, 200);
      // ç¼“å­˜åŒæ­¥æ•°æ®åˆ°æœ¬åœ°ï¼ˆä¸­æ–‡ç‰ˆä½¿ç”¨ç‹¬ç«‹ç¼“å­˜é”®ï¼‰
      try {
        const docs = getLocalDocs();
        const fileCount = docs ? docs.length : 0;
        localStorage.setItem('mw_cloud_sync_cache_cn', JSON.stringify({
          fileCount: fileCount,
          sizeBytes: sizeCheck.totalSize,
          updatedAt: new Date().toISOString()
        }));
      } catch (_) { }

      showSuccess('åŒæ­¥å®Œæˆ');
      setTimeout(updateSyncStatus, 300);
    } catch (e) {
      showError(e.message || 'åŒæ­¥å¤±è´¥');
    }
  }

  async function clearCloud() {
    try {
      if (getLang() !== 'zh') { showInfo('å½“å‰ä¸ºè‹±æ–‡æ¨¡å¼ï¼Œè¯·ç”¨â€œæ¸…ç©ºå¤‡ä»½â€æŒ‰é’®'); return; }
      if (!isLoggedIn()) { throw new Error('æœªç™»å½•'); }
      if (!confirm('ç¡®è®¤æ¸…ç©ºäº‘ç«¯æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€')) return;
      const { obj } = await downloadCloud();

      // æ¸…ç©ºæ‰€æœ‰æ•°æ®
      obj.set('docs', []);
      obj.set('aiConfig', {});
      obj.set('promptTemplates', []);
      obj.set('myPromptTemplates', []);
      obj.set('docUpdatedAt', Date.now());
      obj.set('configUpdatedAt', Date.now());
      obj.set('templateUpdatedAt', Date.now());
      obj.set('myPromptTemplateUpdatedAt', Date.now());

      await obj.save();
      showSuccess('äº‘ç«¯æ•°æ®å·²æ¸…ç©º');
    } catch (e) {
      showError(e.message || 'æ¸…ç©ºå¤±è´¥');
    }
  }

  function initUIBindings() {
    const zhCtrls = document.getElementById('lc-sync-controls');


    // ä¸ªäººèœå•ä¸­çš„æŒ‰é’®
    const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
    const menuClearBtn = document.getElementById('lc-clear-btn-menu');

    // æ·»åŠ çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
    if (zhCtrls && !document.getElementById('lc-sync-status')) {
      const statusDiv = document.createElement('div');
      statusDiv.id = 'lc-sync-status';
      statusDiv.style.cssText = 'margin-left: 8px; padding: 4px 8px; background: #f8f9fa; border-radius: 4px;';
      zhCtrls.appendChild(statusDiv);
    }



    // ç»‘å®šä¸ªäººèœå•æŒ‰é’® - ä½¿ç”¨addEventListenerç¡®ä¿å‡½æ•°å¯è®¿é—®
    if (menuSyncBtn) {
      menuSyncBtn.addEventListener('click', bidirectionalSync);
    }
    if (menuClearBtn) {
      menuClearBtn.addEventListener('click', clearCloud);
    }

    // ç™»å½•çŠ¶æ€æˆ–è¯­è¨€å˜åŒ–æ—¶åˆ‡æ¢æ˜¾ç¤º
    function refreshVisible() {
      const authUser = document.getElementById('auth-user');
      const enCtrls = document.getElementById('cloud-sync-controls');
      // æœªç™»å½•ï¼šä¸¤ç»„éšè—ï¼Œé¿å…åˆæ¬¡é—ªç°
      if (!authUser || authUser.style.display === 'none') {
        if (enCtrls) enCtrls.style.display = 'none';
        if (zhCtrls) zhCtrls.style.display = 'none';
        return;
      }
      if (getLang() === 'zh') {
        if (enCtrls) enCtrls.style.display = 'none';
        if (zhCtrls) zhCtrls.style.display = 'inline-flex';
      } else {
        if (enCtrls) enCtrls.style.display = 'inline-flex';
        if (zhCtrls) zhCtrls.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', refreshVisible);
    window.addEventListener('storage', function (e) {
      if (e.key === LANG_KEY || (e.key && e.key.startsWith('AV/'))) setTimeout(refreshVisible, 50);
    });
    // æä¾›ç»™å¤–éƒ¨åœ¨è®¤è¯åŒºå˜åŒ–ååˆ·æ–°
    window.__mw_refreshSyncLangUI = refreshVisible;

    // åˆå§‹åŒ–çŠ¶æ€æ˜¾ç¤º
    setTimeout(updateSyncStatus, 500);
  }

  // é¡µé¢å°±ç»ªååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function () {
    initUIBindings();
    // å°è¯•åœ¨è®¤è¯åŒºåˆ·æ–°ååº”ç”¨ä¸€æ¬¡
    setTimeout(applyLangUIOnce, 300);

    // ç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°çŠ¶æ€
    if (typeof mw_getDocs === 'function') {
      // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–
      window.addEventListener('storage', function (e) {
        if (e.key && e.key.includes('doc')) {
          setTimeout(updateSyncStatus, 100);
        }
      });

      // å®šæœŸæ›´æ–°çŠ¶æ€ï¼ˆæ¯30ç§’ï¼‰
      setInterval(updateSyncStatus, 30000);
    }

    // åˆå§‹åŒ–ä¸ªäººèœå•çŠ¶æ€
    setTimeout(() => {
      updateSyncStatus();
      // åŒæ—¶æ›´æ–°Cloudflare Workerçš„ä¸ªäººèœå•çŠ¶æ€
      if (typeof window.__mw_initCloudSyncUI === 'function') {
        window.__mw_initCloudSyncUI();
      }
    }, 100);
  });

  // æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’ŒåŒæ­¥çŠ¶æ€
  function updateSyncStatus() {
    try {
      // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©å¯¹åº”çš„ç¼“å­˜é”®
      const currentLang = getLang();
      const cacheKey = currentLang === 'en' ? 'mw_cloud_sync_cache_en' : 'mw_cloud_sync_cache_cn';

      // é¦–å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è·å–æ•°æ®
      let cachedData = null;
      try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          cachedData = JSON.parse(cached);
        }
      } catch (_) { }

      // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®
      if (cachedData && cachedData.fileCount !== undefined && cachedData.sizeBytes !== undefined) {
        const fileCount = cachedData.fileCount || 0;
        const sizeBytes = cachedData.sizeBytes || 0;
        const totalSizeKB = (sizeBytes / 1024).toFixed(1);
        const updatedAt = cachedData.updatedAt || cachedData.timestamp;

        // è®¡ç®—ç›¸å¯¹æ—¶é—´
        let timeText = '';
        if (updatedAt) {
          const date = new Date(updatedAt);
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);

          if (diffMins < 1) {
            timeText = 'åˆšåˆš';
          } else if (diffMins < 60) {
            timeText = `${diffMins}åˆ†é’Ÿå‰`;
          } else if (diffHours < 24) {
            timeText = `${diffHours}å°æ—¶å‰`;
          } else if (diffDays < 7) {
            timeText = `${diffDays}å¤©å‰`;
          } else {
            timeText = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
          }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸»ç•Œé¢ï¼‰
        const statusElement = document.getElementById('lc-sync-status');
        if (statusElement) {
          statusElement.innerHTML = `
            <small style="color: #666; font-size: 11px;">
              æ–‡ä»¶: ${fileCount}ä¸ª<br>${totalSizeKB}KB / 10MB${timeText ? '<br>å¤‡ä»½: ' + timeText : ''}
            </small>
          `;

          // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
          if (sizeBytes > 8 * 1024 * 1024) { // è¶…è¿‡8MB
            statusElement.querySelector('small').style.color = '#e74c3c';
          } else if (sizeBytes > 5 * 1024 * 1024) { // è¶…è¿‡5MB
            statusElement.querySelector('small').style.color = '#f39c12';
          }
        }

        // æ›´æ–°ä¸ªäººèœå•ä¸­çš„çŠ¶æ€æ˜¾ç¤º
        const menuStatusElement = document.getElementById('lc-sync-status-menu');
        if (menuStatusElement) {
          menuStatusElement.innerHTML = `æ–‡ä»¶: ${fileCount}ä¸ª<br>${totalSizeKB}KB / 10MB${timeText ? '<br>å¤‡ä»½: ' + timeText : ''}`;

          // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
          if (sizeBytes > 8 * 1024 * 1024) { // è¶…è¿‡8MB
            menuStatusElement.style.color = '#e74c3c';
          } else if (sizeBytes > 5 * 1024 * 1024) { // è¶…è¿‡5MB
            menuStatusElement.style.color = '#f39c12';
          } else {
            menuStatusElement.style.color = '#9ca3af';
          }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const syncBtn = document.getElementById('lc-sync-btn');
        if (syncBtn) {
          syncBtn.disabled = false;
          syncBtn.title = 'ä¸€é”®åŒæ­¥';
          syncBtn.style.opacity = '1';
        }

        // æ›´æ–°ä¸ªäººèœå•ä¸­çš„åŒæ­¥æŒ‰é’®çŠ¶æ€
        const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
        if (menuSyncBtn) {
          menuSyncBtn.disabled = false;
          menuSyncBtn.title = 'ä¸€é”®åŒæ­¥';
          menuSyncBtn.style.opacity = '1';
        }

        return;
      }

      // å¦‚æœæ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨åŸæœ‰çš„æœ¬åœ°æ•°æ®é€»è¾‘
      const docs = getLocalDocs();
      // è¿‡æ»¤æ‰å·²åˆ é™¤çš„æ–‡æ¡£ï¼Œåªç»Ÿè®¡æœ‰æ•ˆæ–‡æ¡£
      const validDocs = docs ? docs.filter(doc => !doc.deletedAt) : [];
      const sizeCheck = checkFileSize(validDocs);

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆä¸»ç•Œé¢ï¼‰
      const statusElement = document.getElementById('lc-sync-status');
      if (statusElement) {
        const totalSizeMB = (sizeCheck.totalSize / 1024).toFixed(1);
        const fileCount = validDocs.length;

        statusElement.innerHTML = `
          <small style="color: #666; font-size: 11px;">
            æ–‡ä»¶: ${fileCount}ä¸ª<br>${totalSizeMB}KB / 10MB
          </small>
        `;

        // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
        if (sizeCheck.totalSize > 8 * 1024 * 1024) { // è¶…è¿‡8MB
          statusElement.querySelector('small').style.color = '#e74c3c';
        } else if (sizeCheck.totalSize > 5 * 1024 * 1024) { // è¶…è¿‡5MB
          statusElement.querySelector('small').style.color = '#f39c12';
        }
      }

      // æ›´æ–°ä¸ªäººèœå•ä¸­çš„çŠ¶æ€æ˜¾ç¤º
      const menuStatusElement = document.getElementById('lc-sync-status-menu');
      if (menuStatusElement) {
        const totalSizeMB = (sizeCheck.totalSize / 1024).toFixed(1);
        const fileCount = validDocs.length;

        menuStatusElement.innerHTML = `æ–‡ä»¶: ${fileCount}ä¸ª<br>${totalSizeMB}KB / 10MB`;

        // æ ¹æ®ä½¿ç”¨æƒ…å†µæ”¹å˜é¢œè‰²
        if (sizeCheck.totalSize > 8 * 1024 * 1024) { // è¶…è¿‡8MB
          menuStatusElement.style.color = '#e74c3c';
        } else if (sizeCheck.totalSize > 5 * 1024 * 1024) { // è¶…è¿‡5MB
          menuStatusElement.style.color = '#f39c12';
        } else {
          menuStatusElement.style.color = '#9ca3af';
        }
      }

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const syncBtn = document.getElementById('lc-sync-btn');
      if (syncBtn) {
        if (!sizeCheck.valid) {
          syncBtn.disabled = true;
          syncBtn.title = 'æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥ï¼š' + sizeCheck.errors.join('ï¼›');
          syncBtn.style.opacity = '0.6';
        } else {
          syncBtn.disabled = false;
          syncBtn.title = 'ä¸€é”®åŒæ­¥';
          syncBtn.style.opacity = '1';
        }
      }

      // æ›´æ–°ä¸ªäººèœå•ä¸­çš„åŒæ­¥æŒ‰é’®çŠ¶æ€
      const menuSyncBtn = document.getElementById('lc-sync-btn-menu');
      if (menuSyncBtn) {
        if (!sizeCheck.valid) {
          menuSyncBtn.disabled = true;
          menuSyncBtn.title = 'æ–‡ä»¶å¤§å°æ£€æŸ¥å¤±è´¥ï¼š' + sizeCheck.errors.join('ï¼›');
          menuSyncBtn.style.opacity = '0.6';
        } else {
          menuSyncBtn.disabled = false;
          menuSyncBtn.title = 'ä¸€é”®åŒæ­¥';
          menuSyncBtn.style.opacity = '1';
        }
      }

    } catch (error) {
      console.warn('æ›´æ–°åŒæ­¥çŠ¶æ€å¤±è´¥:', error);
    }
  }

  // æš´éœ²æ‰‹åŠ¨å…¥å£ï¼ˆå¦‚éœ€ï¼‰
  window.MW_LC_SYNC = { sync: bidirectionalSync, clear: clearCloud, updateStatus: updateSyncStatus };

})();
