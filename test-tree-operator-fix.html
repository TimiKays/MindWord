<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试树操作修复</title>
    <script src="jsmind/jsmind.js"></script>
    <script src="jsmind/tree-operator.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #jsmind_container { width: 800px; height: 400px; border: 1px solid #ccc; margin: 20px 0; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #f5f5f5; }
        .result { margin: 10px 0; padding: 10px; background: white; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>测试树操作修复 - 根节点包含问题</h1>
    
    <div class="test-section">
        <h2>测试场景</h2>
        <p>测试输入的Markdown结构：</p>
        <pre># 1 
555 
## 1.1 
666 
- 1.1.1 
888 
  - 1.1.1.1 
777</pre>
        <p>期望结果：根节点 "1" 应该被包含在插入结果中，而不是只插入子节点。</p>
    </div>

    <div class="test-section">
        <h2>思维导图容器</h2>
        <div id="jsmind_container"></div>
        <button onclick="createMindMap()">创建思维导图</button>
        <button onclick="testInsertTree()">测试插入树结构</button>
        <button onclick="clearMindMap()">清空</button>
    </div>

    <div class="test-section">
        <h2>测试结果</h2>
        <div id="test_result" class="result"></div>
    </div>

    <script>
        var jm = null;

        // 创建思维导图
        function createMindMap() {
            var mind = {
                "meta": {
                    "name": "测试",
                    "author": "测试用户",
                    "version": "1.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root",
                    "topic": "根节点",
                    "children": []
                }
            };

            var options = {
                container: 'jsmind_container',
                theme: 'primary',
                editable: true
            };

            jm = new jsMind(options);
            jm.show(mind);
            
            showResult('思维导图创建成功！', 'success');
        }

        // 清空思维导图
        function clearMindMap() {
            if (jm) {
                var mind = {
                    "meta": {
                        "name": "测试",
                        "author": "测试用户",
                        "version": "1.0"
                    },
                    "format": "node_tree",
                    "data": {
                        "id": "root",
                        "topic": "根节点",
                        "children": []
                    }
                };
                jm.show(mind);
                showResult('思维导图已清空！', 'success');
            }
        }

        // 测试插入树结构
        function testInsertTree() {
            if (!jm) {
                showResult('请先创建思维导图！', 'error');
                return;
            }

            // 模拟从Markdown解析得到的节点树结构
            var nodeTree = {
                "topic": "1",
                "data": {
                    "level": 1,
                    "raw": "555"
                },
                "children": [
                    {
                        "topic": "1.1",
                        "data": {
                            "level": 2,
                            "raw": "666"
                        },
                        "children": [
                            {
                                "topic": "1.1.1",
                                "data": {
                                    "level": 3,
                                    "raw": "888"
                                },
                                "children": [
                                    {
                                        "topic": "1.1.1.1",
                                        "data": {
                                            "level": 4,
                                            "raw": "777"
                                        }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };

            try {
                // 获取根节点
                var rootNode = jm.get_node('root');
                if (!rootNode) {
                    showResult('无法获取根节点！', 'error');
                    return;
                }

                showResult('开始测试插入树结构...', 'info');
                
                // 记录插入前的子节点数量
                var beforeCount = rootNode.children ? rootNode.children.length : 0;
                
                // 调用插入函数
                insertNodeTreeChildren('root', nodeTree, 'test-request-123');
                
                // 等待一下让操作完成
                setTimeout(function() {
                    // 重新获取根节点以查看结果
                    var updatedRoot = jm.get_node('root');
                    var afterCount = updatedRoot.children ? updatedRoot.children.length : 0;
                    
                    var result = '插入前子节点数量: ' + beforeCount + '<br>';
                    result += '插入后子节点数量: ' + afterCount + '<br>';
                    
                    if (afterCount > beforeCount) {
                        // 检查第一个子节点是否是 "1"
                        var firstChild = updatedRoot.children[0];
                        if (firstChild && firstChild.topic === '1') {
                            result += '✅ 成功：根节点 "1" 被正确插入！<br>';
                            result += '第一个子节点主题: ' + firstChild.topic + '<br>';
                            
                            // 检查是否有子节点
                            if (firstChild.children && firstChild.children.length > 0) {
                                result += '根节点 "1" 的子节点数量: ' + firstChild.children.length + '<br>';
                                if (firstChild.children[0].topic === '1.1') {
                                    result += '✅ 子节点 "1.1" 也被正确插入！';
                                }
                            }
                            showResult(result, 'success');
                        } else {
                            result += '❌ 失败：第一个子节点不是 "1"，而是: ' + (firstChild ? firstChild.topic : '无');
                            showResult(result, 'error');
                        }
                    } else {
                        result += '❌ 失败：没有插入任何节点';
                        showResult(result, 'error');
                    }
                    
                    // 显示完整的节点结构用于调试
                    console.log('完整的根节点结构:', updatedRoot);
                }, 500);
                
            } catch (error) {
                showResult('测试失败: ' + error.message, 'error');
                console.error('测试错误:', error);
            }
        }

        // 显示结果
        function showResult(message, type) {
            var resultDiv = document.getElementById('test_result');
            resultDiv.innerHTML = message;
            resultDiv.className = 'result ' + type;
        }

        // 页面加载完成后自动创建思维导图
        window.onload = function() {
            createMindMap();
        };
    </script>
</body>
</html>