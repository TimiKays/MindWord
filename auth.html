<!--
 * MindWord - 树心 | 像画图一样写文档的思维导图写作工具
 * GitHub: https://github.com/TimiKays/MindWord
 * 
 * Copyright 2025 Timi Kays
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="auth.pageTitle">账户 - 登录 / 注册</title>
    <link rel="icon" href="res/LOGO32.ico" />

    <!-- i18n scripts -->
    <script src="i18n/locales.js"></script>
    <script src="i18n/i18n-manager.js"></script>

    <!-- Language Detection Script -->
    <script>
        // Auto-detect browser language and set appropriate lang attribute
        (function () {
            const userLang = navigator.language || navigator.userLanguage;
            const htmlElement = document.documentElement;

            // If browser language is English, add English lang attribute
            if (userLang && userLang.startsWith('en')) {
                htmlElement.setAttribute('lang', 'en-US');
                htmlElement.setAttribute('xml:lang', 'en-US');
            }
        })();
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 440px;
            width: 90%;
            margin: 20px;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .container:hover {
            transform: translateY(-2px);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 30px;
            text-align: center;
            background: linear-gradient(135deg, #c5cffc 0%, #5eafe6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            border-radius: 8px;
            cursor: pointer;
            color: #718096;
            background: transparent;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .tab:hover {
            color: #4a5568;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            background: linear-gradient(135deg, #9fc0f5 0%, #53a8cf 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        form {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        form.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
            margin: 20px 0 8px;
            letter-spacing: 0.3px;
        }

        input {
            width: 100%;
            height: 48px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0 16px;
            font-size: 15px;
            color: #2d3748;
            background: #fff;
            transition: all 0.3s ease;
            outline: none;
        }

        input:focus {
            border-color: #619dff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        input::placeholder {
            color: #a0aec0;
        }

        button {
            height: 48px;
            width: 100%;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #9fc0f5 0%, #53a8cf 100%);
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0 24px;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-top: 24px;
        }

        .hint {
            font-size: 13px;
            color: #718096;
            margin-top: 12px;
            line-height: 1.5;
        }

        .err {
            font-size: 13px;
            color: #e53e3e;
            margin-top: 12px;
            font-weight: 500;
            line-height: 1.5;
        }

        .success {
            font-size: 13px;
            color: #38a169;
            margin-top: 12px;
            font-weight: 500;
            line-height: 1.5;
        }

        .back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 16px auto 0;
            color: #619dff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .back:hover {
            color: #5a67d8;

        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 15% auto;
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            margin: 0 0 16px;
            color: #38a169;
            font-size: 20px;
            font-weight: 600;
        }

        .modal-content p {
            margin-bottom: 24px;
            color: #4a5568;
            line-height: 1.6;
            font-size: 15px;
        }

        .modal-button {
            background: linear-gradient(135deg, #619dff 0%, #5eb97e 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* 重新发送激活邮件按钮样式 */
        .resend-email-btn {
            background: transparent;
            color: #619dff;
            border: 1px solid #619dff;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 8px;
        }

        .resend-email-btn:hover {
            background: #619dff;
            color: white;
            transform: translateY(-1px);
        }

        .resend-email-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 隐私协议勾选框样式 */
        .privacy-checkbox-container {
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .privacy-checkbox-container label {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            color: #4a5568;
        }

        .privacy-checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            margin-top: 3px;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .privacy-checkbox-container a {
            color: #53a8cf;
            text-decoration: none;
            font-weight: 500;
        }

        .privacy-checkbox-container a:hover {
            text-decoration: underline;
        }

        /* 响应式设计 */
        @media (max-width: 480px) {
            .container {
                padding: 32px 24px;
                margin: 16px;
            }

            h1 {
                font-size: 24px;
            }

            .modal-content {
                padding: 24px 20px;
                margin: 20% auto;
            }
        }
    </style>
    <!-- LeanCloud SDK -->
    <script src="/local-deps/av-min.js"></script>
</head>

<body style="flex-direction: column; ">
    <div>

    </div display="flex" flex-direction="column" align-items="center">
    <div class="container">
        <h1 data-i18n="auth.welcome">欢迎使用MindWord</h1>
        <div class="tabs">
            <div class="tab active" data-t="login" data-i18n="auth.login">登录</div>
            <div class="tab" data-t="signup" data-i18n="auth.signup">注册</div>
            <div class="tab" data-t="reset" data-i18n="auth.resetPassword">忘记密码</div>
        </div>

        <form id="f-login" class="active">
            <label data-i18n="auth.email">邮箱</label>
            <input id="login-email" type="email" data-i18n-placeholder="auth.emailPlaceholder" placeholder="请输入您的邮箱地址"
                required autocomplete="email" />
            <label data-i18n="auth.password">密码</label>
            <input id="login-pass" type="password" data-i18n-placeholder="auth.passwordPlaceholder"
                placeholder="请输入您的密码" required autocomplete="current-password" />
            <div class="row">
                <button id="btn-login" type="button" data-i18n="auth.login">登录</button>

            </div>
            <div id="login-msg" class="hint"></div>
        </form>

        <form id="f-signup">
            <label data-i18n="auth.email">邮箱（将作为用户名）</label>
            <input id="signup-email" type="email" data-i18n-placeholder="auth.signupEmailPlaceholder"
                placeholder="请输入您的邮箱地址" required autocomplete="email" />
            <label data-i18n="auth.password">密码</label>
            <input id="signup-pass" type="password" data-i18n-placeholder="auth.signupPasswordPlaceholder"
                placeholder="请设置至少6位密码" required autocomplete="new-password" />
            <label data-i18n="auth.confirmPassword">确认密码</label>
            <input id="signup-pass-confirm" type="password" data-i18n-placeholder="auth.confirmPasswordPlaceholder"
                placeholder="请再次输入密码" required autocomplete="new-password" />

            <div class="privacy-checkbox-container">
                <label>
                    <input type="checkbox" id="privacy-agreement" required />
                    <span>
                        我已阅读并同意
                        <a href="privacy.html" target="_blank">隐私政策</a>
                    </span>
                </label>
            </div>

            <div class="row">
                <button id="btn-signup" type="button" data-i18n="auth.signup">注册</button>

            </div>
            <div id="signup-msg" class="hint" data-i18n="auth.signupHint">注册后会发送验证邮件到您的邮箱</div>
        </form>

        <form id="f-reset">
            <label data-i18n="auth.email">邮箱</label>
            <input id="reset-email" type="email" data-i18n-placeholder="auth.emailPlaceholder" placeholder="请输入您的邮箱地址"
                required autocomplete="email" />
            <div class="row">
                <button id="btn-reset" type="button" data-i18n="auth.sendResetEmail">发送重置邮件</button>

            </div>
            <div id="reset-msg" class="hint" data-i18n="auth.resetHint">我们将向你的邮箱发送重置密码邮件</div>
        </form>

    </div>



    <!-- 返回应用链接 - 移动到登录注册面板下方 -->

    <a class="back" href="app.html"
        style="display: inline-block; padding: 12px 24px; text-decoration: none; color: #53a8cf; font-size: 14px; transition: all 0.3s ease; "
        data-i18n="auth.returnToApp">返回应用</a>
    </div>
    </div>

    <!-- 验证邮件发送成功弹窗 -->
    <div id="emailVerifyModal" class="modal">
        <div class="modal-content">
            <h3 data-i18n="auth.verificationEmailSent">验证邮件已发送</h3>
            <p data-i18n="auth.verificationEmailContent">验证邮件已发送。请查看邮箱并点击链接，完成注册后即可登录</p>
            <button id="btn-verify-complete" class="modal-button" data-i18n="auth.verifiedGoLogin">我已验证，去登录</button>
        </div>


        <script>
            //  LeanCloud 应用信息
            var APP_ID = 'MQ3fZEqOgskJBWGoxOwqG1nT-gzGzoHsz';
            var APP_KEY = 'bhU0peMhrAVKEJ2OQbiFKXwC';

            try {
                if (typeof AV !== 'undefined' && AV && !AV.applicationId) {
                    // 从 LeanCloud 控制台复制“API 服务器地址”到 SERVER_URL（必填）
                    var SERVER_URL = 'https://mq3fzeqo.lc-cn-n1-shared.com';
                    if (!SERVER_URL || SERVER_URL.indexOf('http') !== 0) {
                        console.error('[AUTH] LeanCloud SERVER_URL 未设置，请到控制台复制“API 服务器地址”并替换占位符 LEANCLOUD_SERVER_URL');
                    }
                    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
                }
            } catch (e) {
                console.warn('[AUTH] AV init failed', e);
            }

            // 轻量提示
            function setMsg(id, text, kind) {
                var el = document.getElementById(id);
                if (!el) return;
                el.className = kind || 'hint';
                el.textContent = text || '';
            }

            // Tab 切换
            document.querySelectorAll('.tab').forEach(function (tab) {
                tab.addEventListener('click', function () {
                    document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active'); });
                    tab.classList.add('active');
                    var t = tab.getAttribute('data-t');
                    document.querySelectorAll('form').forEach(function (f) { f.classList.remove('active'); });
                    document.getElementById('f-' + t).classList.add('active');
                });
            });

            // 为登录表单添加Enter键提交功能
            document.getElementById('login-pass').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('btn-login').click();
                }
            });

            // 为注册表单的确认密码输入框添加Enter键提交功能
            document.getElementById('signup-pass-confirm').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('btn-signup').click();
                }
            });

            // 为重置密码表单的邮箱输入框添加Enter键提交功能
            document.getElementById('reset-email').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('btn-reset').click();
                }
            });

            // 登录（仅支持邮箱+密码登录，检查邮箱验证状态）
            document.getElementById('btn-login').addEventListener('click', async function () {
                var email = document.getElementById('login-email').value.trim();
                var pass = document.getElementById('login-pass').value;
                if (!email || !pass) return setMsg('login-msg', i18n.t('auth.pleaseEnterEmailAndPassword'), 'err');
                setMsg('login-msg', i18n.t('auth.loggingIn'), 'hint');

                try {
                    // 仅使用邮箱登录
                    await AV.User.loginWithEmail(email, pass);

                    // 检查邮箱是否已验证
                    var currentUser = AV.User.current();
                    if (currentUser && !currentUser.get('emailVerified')) {
                        setMsg('login-msg', i18n.t('auth.emailNotVerified'), 'err');
                        // 登出未验证的用户
                        await AV.User.logOut();
                        return;
                    }

                    setMsg('login-msg', i18n.t('auth.loginSuccess'), 'success');
                    setTimeout(function () { window.location.href = 'app.html'; }, 600);
                } catch (e) {
                    let errorMsg = i18n.t('auth.loginFailed');
                    if (e && e.message) {
                        // 根据LeanCloud错误消息提供更友好的提示
                        if (e.message.includes("Email address isn't verified.")) {
                            errorMsg = i18n.t('auth.emailNotVerified');
                            setMsg('login-msg', errorMsg, 'err');

                            // 添加重新发送激活邮件的按钮
                            setTimeout(() => {
                                const loginMsg = document.getElementById('login-msg');
                                if (loginMsg && loginMsg.textContent.includes(i18n.t('auth.emailNotVerified'))) {
                                    const resendBtn = document.createElement('button');
                                    resendBtn.textContent = i18n.t('auth.resendActivationEmail');
                                    resendBtn.className = 'resend-email-btn';
                                    resendBtn.onclick = async function () {
                                        try {
                                            resendBtn.disabled = true;
                                            resendBtn.textContent = i18n.t('auth.sending');

                                            // 请求发送验证邮件
                                            await AV.User.requestEmailVerify(email);

                                            resendBtn.textContent = i18n.t('auth.sent');

                                            setMsg('login-msg', i18n.t('auth.activationEmailResent'), 'success');
                                        } catch (resendError) {
                                            resendBtn.disabled = false;
                                            resendBtn.textContent = i18n.t('auth.resendActivationEmail');

                                            let resendErrorMsg = i18n.t('auth.sendFailedRetry');
                                            if (resendError && resendError.message) {
                                                if (resendError.message.includes('network') || resendError.message.includes('timeout')) {
                                                    resendErrorMsg = i18n.t('auth.networkError');
                                                } else if (resendError.message.includes('email')) {
                                                    resendErrorMsg = i18n.t('auth.invalidEmailFormat');
                                                } else if (resendError.message.includes('already verified')) {
                                                    resendErrorMsg = i18n.t('auth.emailAlreadyVerified');
                                                } else {
                                                    resendErrorMsg = resendError.message;
                                                }
                                            }
                                            setMsg('login-msg', `${i18n.t('auth.resendFailed')}: ${resendErrorMsg}`, 'err');
                                        }
                                    };
                                    loginMsg.appendChild(resendBtn);
                                }
                            }, 100);
                            return;
                        } else if (e.message.includes('network') || e.message.includes('timeout')) {
                            errorMsg = i18n.t('auth.networkError');
                        } else {
                            errorMsg = i18n.t('auth.emailNotFoundOrWrongPassword');
                        }
                    }
                    return setMsg('login-msg', errorMsg, 'err');
                }
            });

            // 显示验证邮件弹窗
            function showEmailVerifyModal(email) {
                document.getElementById('emailVerifyModal').style.display = 'block';
            }

            // 隐藏验证邮件弹窗
            function hideEmailVerifyModal() {
                document.getElementById('emailVerifyModal').style.display = 'none';
            }

            // 注册（邮箱作为用户名 + email）
            document.getElementById('btn-signup').addEventListener('click', async function () {
                var email = document.getElementById('signup-email').value.trim();
                var pass = document.getElementById('signup-pass').value;
                var passConfirm = document.getElementById('signup-pass-confirm').value;
                var privacyAgreement = document.getElementById('privacy-agreement');

                if (!email || !pass) return setMsg('signup-msg', i18n.t('auth.pleaseEnterEmailAndPassword'), 'err');
                if (pass.length < 6) return setMsg('signup-msg', i18n.t('auth.passwordTooShort'), 'err');
                if (pass !== passConfirm) return setMsg('signup-msg', i18n.t('auth.passwordsDoNotMatch'), 'err');
                if (!privacyAgreement || !privacyAgreement.checked) return setMsg('signup-msg', '请阅读并同意隐私政策', 'err');
                setMsg('signup-msg', i18n.t('auth.registering'), 'info');
                try {
                    var user = new AV.User();
                    user.setUsername(email);
                    user.setPassword(pass);
                    user.setEmail(email);
                    // 设置邮箱未验证状态
                    user.set('emailVerified', false);
                    await user.signUp();

                    // signUp()已自动发送验证邮件，无需重复发送

                    // 清空密码字段
                    document.getElementById('signup-pass').value = '';
                    document.getElementById('signup-pass-confirm').value = '';

                    // 显示验证邮件弹窗
                    showEmailVerifyModal(email);

                    // 显示注册成功消息
                    setMsg('signup-msg', i18n.t('auth.signupSuccess'), 'ok');

                } catch (e) {
                    let errorMsg = i18n.t('auth.registrationFailed');
                    if (e && e.message) {
                        // 根据LeanCloud错误消息提供更友好的提示
                        if (e.message.includes('already exists') || e.message.includes('taken') || e.message.includes('此电子邮箱已经被占用')) {
                            errorMsg = i18n.t('auth.emailAlreadyExists');
                        } else if (e.message.includes('email')) {
                            errorMsg = i18n.t('auth.invalidEmailFormat');
                        } else if (e.message.includes('password')) {
                            errorMsg = i18n.t('auth.passwordRequirements');
                        } else if (e.message.includes('network') || e.message.includes('timeout')) {
                            errorMsg = i18n.t('auth.networkError');
                        } else {
                            errorMsg = e.message; // 其他未知错误显示原始消息
                        }
                    }
                    setMsg('signup-msg', errorMsg, 'err');
                }
            });

            // 点击"我已验证，去登录"按钮
            document.getElementById('btn-verify-complete').addEventListener('click', function () {
                hideEmailVerifyModal();

                // 获取注册时使用的邮箱
                var email = document.getElementById('signup-email').value.trim();

                // 切换到登录界面并传递邮箱
                document.querySelector('.tab[data-t="login"]').click();
                document.getElementById('login-email').value = email;
                document.getElementById('login-pass').focus();
            });

            // 点击弹窗外部关闭弹窗
            document.getElementById('emailVerifyModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    hideEmailVerifyModal();
                }
            });

            // 忘记密码（发送重置邮件）
            document.getElementById('btn-reset').addEventListener('click', async function () {
                var email = document.getElementById('reset-email').value.trim();
                if (!email) return setMsg('reset-msg', i18n.t('auth.pleaseEnterEmail'), 'err');
                setMsg('reset-msg', i18n.t('auth.sendingResetEmail'), 'hint');
                try {
                    await AV.User.requestPasswordReset(email);
                    setMsg('reset-msg', i18n.t('auth.resetEmailSent'), 'success');
                } catch (e) {
                    let errorMsg = i18n.t('auth.sendFailedRetry');
                    if (e && e.message) {
                        // 根据LeanCloud错误消息提供更友好的提示
                        if (e.message.includes('not found') || e.message.includes('user')) {
                            errorMsg = i18n.t('auth.emailNotRegistered');
                        } else if (e.message.includes('email')) {
                            errorMsg = i18n.t('auth.invalidEmailFormat');
                        } else if (e.message.includes('network') || e.message.includes('timeout')) {
                            errorMsg = i18n.t('auth.networkError');
                        } else {
                            errorMsg = e.message; // 其他未知错误显示原始消息
                        }
                    }
                    setMsg('reset-msg', errorMsg, 'err');
                }
            });

            // 若已登录，直接回跳
            try {
                var cur = AV.User.current && AV.User.current();
                if (cur) {
                    window.location.replace('app.html');
                }
            } catch (_) { }
        </script>

        <!-- Translation Application Script -->
        <script>
            // 在页面完全加载后立即应用翻译
            function applyTranslationsWhenReady() {
                if (window.i18nManager && window.i18nManager.isInitialized) {
                    // 如果i18n管理器已初始化，立即应用翻译
                    window.i18nManager.updatePageTranslations();
                    window.i18nManager.updatePageTitle();
                } else {
                    // 如果还未初始化，等待一下再试
                    setTimeout(applyTranslationsWhenReady, 100);
                }
            }

            // 多种方式确保翻译被应用
            if (document.readyState === 'complete') {
                applyTranslationsWhenReady();
            } else {
                window.addEventListener('load', applyTranslationsWhenReady);
                document.addEventListener('DOMContentLoaded', applyTranslationsWhenReady);
            }
        </script>
</body>

</html>