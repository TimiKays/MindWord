<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI服务调用工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#1F2937',
                        'neutral-light': '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .modal-backdrop {
                @apply fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4;
            }
            .modal-container {
                @apply bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col;
            }
            .modal-header {
                @apply px-6 py-4 border-b flex justify-between items-center;
            }
            .modal-body {
                @apply px-6 py-4 overflow-y-auto flex-grow;
            }
            .modal-footer {
                @apply px-6 py-4 border-t flex justify-end gap-3;
            }
            .form-group {
                @apply mb-4;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-control {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary;
            }
            .btn {
                @apply px-4 py-2 rounded-md font-medium cursor-pointer transition-colors;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .btn-secondary {
                @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
            }
            .btn-outline {
                @apply border border-gray-300 text-gray-700 hover:bg-gray-50;
            }
            .status-indicator {
                @apply inline-block w-2 h-2 rounded-full mr-2;
            }
            .config-section {
                @apply border rounded-lg p-4 mb-6 transition-all duration-300;
            }
            .config-header {
                @apply flex justify-between items-center cursor-pointer mb-3;
            }
            .collapsible-content {
                @apply transition-all duration-300 ease-in-out;
            }
            .model-search-container {
                @apply relative mb-2;
            }
            .model-search-input {
                @apply w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary;
            }
            .model-search-icon {
                @apply absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400;
            }
            .model-option-highlight {
                @apply bg-yellow-100;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <!-- 触发弹窗的按钮 -->
    <button id="openAIModalBtn" class="btn btn-primary">
        <i class="fa fa-robot mr-2"></i>打开AI工具
    </button>

    <!-- AI服务弹窗组件 -->
    <div id="aiServiceModal" class="modal-backdrop hidden">
        <div class="modal-container">
            <!-- 弹窗头部 -->
            <div class="modal-header">
                <h3 class="text-xl font-bold text-neutral">AI服务调用工具</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 弹窗主体 -->
            <div class="modal-body">
                <form id="aiServiceForm">
                    <!-- AI使用界面 -->
                    <div id="aiUsageView" class="view-container">
                        <!-- 配置状态提示 -->
                        <div id="usageConfigStatusBar" class="mb-4 p-3 rounded-md text-sm hidden">
                            <!-- 配置状态将动态更新 -->
                        </div>
                        
                        <!-- 模型选择（仅显示常用模型） -->
                        <div class="form-group">
                            <label class="form-label" for="usageModelSelect">选择模型</label>
                            <select id="usageModelSelect" class="form-control" required>
                                <option value="">-- 请先配置AI平台 --</option>
                                <!-- 常用模型选项将通过JS动态填充 -->
                            </select>
                        </div>
                        
                        <!-- 提示词输入 -->
                        <div class="form-group">
                            <div class="flex justify-between items-center">
                                <label class="form-label" for="usagePromptInput">提示词</label>
                                <button type="button" id="openConfigViewBtn" class="text-sm text-primary hover:text-primary/80">
                                    <i class="fa fa-cog mr-1"></i>AI配置
                                </button>
                            </div>
                            <textarea id="usagePromptInput" class="form-control h-32" placeholder="请输入提示词..." required></textarea>
                        </div>
                        
                        <!-- 状态和结果区域 -->
                        <div class="mt-6 pt-4 border-t">
                            <div id="usageStatusIndicator" class="hidden mb-4 p-3 rounded-md text-sm">
                                <!-- 状态信息将动态更新 -->
                            </div>
                            
                            <div id="usageResultContainer" class="hidden">
                                <h4 class="font-medium text-gray-800 mb-2">AI 响应结果:</h4>
                                <div id="usageResultContent" class="bg-neutral-light p-4 rounded-md whitespace-pre-wrap break-words max-h-64 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI配置界面 -->
                    <div id="aiConfigView" class="view-container hidden">
                        <!-- 配置状态提示 -->
                        <div id="configStatusBar" class="mb-4 p-3 rounded-md text-sm hidden">
                            <!-- 配置状态将动态更新 -->
                        </div>
                        
                        <!-- AI配置区域（可折叠） -->
                        <div class="config-section">
                            <div id="configHeader" class="config-header">
                                <h4 class="font-semibold text-lg">AI配置</h4>
                                <button type="button" id="toggleConfigBtn" class="text-gray-500 hover:text-gray-700">
                                    <i id="configIcon" class="fa fa-chevron-down"></i>
                                </button>
                            </div>
                            
                            <div id="configContent" class="collapsible-content">
                                <!-- 平台选择 -->
                                <div class="form-group">
                                    <label class="form-label" for="platformSelect">选择AI平台</label>
                                    <select id="platformSelect" class="form-control" required>
                                        <option value="">-- 请选择平台 --</option>
                                        <!-- 选项将通过JS动态填充 -->
                                    </select>
                                </div>
                                
                                <!-- API密钥配置 -->
                                <div class="form-group">
                                    <div class="flex justify-between items-center">
                                        <label class="form-label" for="apiKeyInput">API 密钥</label>
                                        <a id="apiKeyHelpLink" href="#" target="_blank" class="text-xs text-primary hover:underline">
                                            <i class="fa fa-external-link mr-1"></i>获取API密钥
                                        </a>
                                    </div>
                                    <div class="relative">
                                        <input type="password" id="apiKeyInput" class="form-control pr-10" placeholder="输入平台API密钥">
                                        <button type="button" id="toggleKeyVisibility" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                                            <i class="fa fa-eye-slash"></i>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">密钥将按平台保存在浏览器本地存储中</p>
                                </div>
                                
                                <!-- 平台特定配置 -->
                                <div id="platformSpecificConfigs">
                                    <!-- Cloudflare账户ID -->
                                    <div id="cloudflareConfig" class="form-group hidden">
                                        <label class="form-label" for="cloudflareAccountId">Cloudflare 账户ID</label>
                                        <input type="text" id="cloudflareAccountId" class="form-control" placeholder="输入Cloudflare账户ID">
                                    </div>
                                    
                                    <!-- Azure终结点 -->
                                    <div id="azureConfig" class="form-group hidden">
                                        <label class="form-label" for="azureEndpoint">Azure 终结点</label>
                                        <input type="text" id="azureEndpoint" class="form-control" placeholder="输入Azure OpenAI终结点">
                                    </div>
                                </div>
                                
                                <!-- 常用模型设置（带搜索功能） -->
                                <div class="form-group">
                                    <div class="flex justify-between items-center">
                                        <label class="form-label">常用模型设置</label>
                                        <button type="button" id="refreshFavoriteModelsBtn" class="text-sm text-primary hover:text-primary/80">
                                            <i class="fa fa-refresh mr-1"></i>刷新模型
                                        </button>
                                    </div>
                                    
                                    <!-- 模型搜索框 -->
                                    <div class="model-search-container" id="modelSearchContainer">
                                        <i class="fa fa-search model-search-icon"></i>
                                        <input type="text" id="modelSearchInput" class="model-search-input" placeholder="搜索模型...">
                                    </div>
                                    
                                    <div id="favoriteModelsContainer" class="border rounded-md p-3 bg-gray-50 mt-2">
                                        <div id="favoriteModelsList" class="max-h-48 overflow-y-auto">
                                            <!-- 常用模型复选框将通过JS动态填充 -->
                                        </div>
                                    </div>
                                    
                                    <div id="modelLoadingIndicator" class="hidden mt-2 text-sm text-gray-600">
                                        <i class="fa fa-circle-o-notch fa-spin mr-1"></i>正在获取模型列表...
                                    </div>
                                </div>
                                
                                <!-- 高级选项 -->
                                <div class="form-group mt-6">
                                    <details class="group">
                                        <summary class="text-sm font-medium text-gray-700 cursor-pointer">高级选项</summary>
                                        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label class="form-label" for="temperatureInput">温度 (0-1)</label>
                                                <input type="number" id="temperatureInput" class="form-control" min="0" max="1" step="0.1" value="0.7">
                                            </div>
                                            <div>
                                                <label class="form-label" for="maxTokensInput">最大Token数</label>
                                                <input type="number" id="maxTokensInput" class="form-control" min="1" max="4096" value="1000">
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- 弹窗底部 -->
            <div class="modal-footer">
                <!-- AI使用界面的底部按钮 -->
                <div id="usageViewFooter">
                    <button id="usageCancelBtn" class="btn btn-secondary">取消</button>
                    <button id="usageSubmitBtn" class="btn btn-primary" disabled>
                        <i class="fa fa-paper-plane mr-2"></i>发送请求
                    </button>
                </div>
                
                <!-- AI配置界面的底部按钮 -->
                <div id="configViewFooter" class="hidden">
                    <button id="configCancelBtn" class="btn btn-secondary">取消</button>
                    <button id="configSaveBtn" class="btn btn-primary">
                        <i class="fa fa-save mr-2"></i>保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI服务类
        class AIPlatformService {
            constructor() {
                // 初始化支持的平台基本信息，包含API密钥申请链接
                this.platforms = {
                    openai: {
                        name: "OpenAI",
                        baseUrl: "https://api.openai.com/v1",
                        modelsUrl: "https://api.openai.com/v1/models",
                        modelsFetched: false,
                        apiKeyUrl: "https://platform.openai.com/account/api-keys",
                        models: []
                    },
                    anthropic: {
                        name: "Anthropic",
                        baseUrl: "https://api.anthropic.com/v1",
                        modelsUrl: null,
                        modelsFetched: false,
                        apiKeyUrl: "https://console.anthropic.com/settings/keys",
                        predefinedModels: [
                            "claude-3-opus-20240229",
                            "claude-3-sonnet-20240229",
                            "claude-3-haiku-20240307",
                            "claude-2.1"
                        ],
                        models: []
                    },
                    google: {
                        name: "Google Gemini",
                        baseUrl: "https://generativelanguage.googleapis.com/v1beta",
                        modelsUrl: "https://generativelanguage.googleapis.com/v1beta/models?key=API_KEY_PLACEHOLDER",
                        modelsFetched: false,
                        apiKeyUrl: "https://makersuite.google.com/app/apikey",
                        models: []
                    },
                    azure: {
                        name: "Azure OpenAI",
                        modelsUrl: null,
                        modelsFetched: false,
                        apiKeyUrl: "https://portal.azure.com/",
                        models: []
                    },
                    openrouter: {
                        name: "OpenRouter",
                        baseUrl: "https://openrouter.ai/api/v1",
                        modelsUrl: "https://openrouter.ai/api/v1/models",
                        modelsFetched: false,
                        apiKeyUrl: "https://openrouter.ai/settings/keys",
                        models: []
                    },
                    cloudflare: {
                        name: "Cloudflare Workers AI",
                        baseUrl: "https://api.cloudflare.com/client/v4/accounts/ACCOUNT_ID_PLACEHOLDER/ai/run",
                        modelsUrl: "https0://api.cloudflare.com/client/v4/accounts/ACCOUNT_ID_PLACEHOLDER/ai/models",
                        modelsFetched: false,
                        apiKeyUrl: "https://dash.cloudflare.com/profile/api-tokens",
                        models: []
                    },
                    silibase: {
                        name: "硅基流动",
                        baseUrl: "https://api.silibase.com/v1",
                        modelsUrl: "https://api.silibase.com/v1/models",
                        modelsFetched: false,
                        apiKeyUrl: "https://www.silibase.com/console/apikey",
                        models: []
                    }
                };
                
                // 存储配置信息
                this.config = {
                    selectedPlatform: null,
                    selectedModel: null,
                    apiKey: null,
                    azureEndpoint: null,
                    cloudflareAccountId: null
                };
            }

            getPlatforms() {
                return {...this.platforms};
            }

            getModels(platform) {
                if (!this.platforms[platform]) {
                    throw new Error(`不支持的AI平台: ${platform}`);
                }
                if (platform === 'anthropic' && this.platforms[platform].models.length === 0) {
                    return [...this.platforms[platform].predefinedModels];
                }
                return [...this.platforms[platform].models];
            }

            async fetchModels(platform, apiKey = null, options = {}) {
                if (!this.platforms[platform]) {
                    throw new Error(`不支持的AI平台: ${platform}`);
                }

                const platformInfo = this.platforms[platform];
                
                if (platform === 'anthropic') {
                    platformInfo.models = [...platformInfo.predefinedModels];
                    platformInfo.modelsFetched = true;
                    return platformInfo.models;
                }
                
                if (platform === 'azure') {
                    console.warn('Azure平台不支持动态获取模型，请手动输入模型名称');
                    return [];
                }
                
                if (!platformInfo.modelsUrl) {
                    throw new Error(`平台 ${platform} 不支持动态获取模型`);
                }
                
                let url = platformInfo.modelsUrl;
                if (platform === 'google' && apiKey) {
                    url = url.replace('API_KEY_PLACEHOLDER', apiKey);
                }
                if (platform === 'cloudflare' && options.cloudflareAccountId) {
                    url = url.replace('ACCOUNT_ID_PLACEHOLDER', options.cloudflareAccountId);
                }
                
                const headers = {
                    "Content-Type": "application/json"
                };
                
                if (apiKey) {
                    switch (platform) {
                        case 'openai':
                        case 'openrouter':
                        case 'silibase':
                            headers["Authorization"] = `Bearer ${apiKey}`;
                            break;
                        case 'cloudflare':
                            headers["Authorization"] = `Bearer ${apiKey}`;
                            break;
                    }
                }
                
                try {
                    const response = await fetch(url, {
                        method: "GET",
                        headers: headers
                    });

                    if (!response.ok) {
                        throw new Error(`获取模型列表失败: ${response.statusText}`);
                    }

                    const data = await response.json();
                    let models = [];
                    
                    switch (platform) {
                        case 'openai':
                            models = data.data.map(model => model.id);
                            break;
                        case 'google':
                            models = data.models.map(model => model.name);
                            break;
                        case 'openrouter':
                            models = data.data.map(model => model.id);
                            break;
                        case 'cloudflare':
                            models = data.result.map(model => model.name);
                            break;
                        case 'silibase':
                            models = data.models.map(model => model.id);
                            break;
                    }
                    
                    platformInfo.models = models;
                    platformInfo.modelsFetched = true;
                    
                    return models;
                } catch (error) {
                    console.error(`获取${platform}模型列表失败:`, error);
                    throw error;
                }
            }

            configure(options) {
                const { platform, model, apiKey, azureEndpoint, cloudflareAccountId } = options;
                
                if (!this.platforms[platform]) {
                    throw new Error(`不支持的AI平台: ${platform}`);
                }
                
                if (platform === 'azure' && !azureEndpoint) {
                    throw new Error('Azure平台需要提供终结点(azureEndpoint)');
                }
                
                if (platform === 'cloudflare' && !cloudflareAccountId) {
                    throw new Error('Cloudflare平台需要提供账户ID(cloudflareAccountId)');
                }

                this.config = {
                    selectedPlatform: platform,
                    selectedModel: model,
                    apiKey: apiKey,
                    azureEndpoint: azureEndpoint || null,
                    cloudflareAccountId: cloudflareAccountId || null
                };
            }

            isConfigured() {
                if (!this.config.selectedPlatform || !this.config.selectedModel || !this.config.apiKey) {
                    return false;
                }
                
                if (this.config.selectedPlatform === 'azure' && !this.config.azureEndpoint) {
                    return false;
                }
                
                if (this.config.selectedPlatform === 'cloudflare' && !this.config.cloudflareAccountId) {
                    return false;
                }
                
                return true;
            }

            async generate(options) {
                if (!this.isConfigured()) {
                    throw new Error('AI服务尚未配置，请先调用configure方法');
                }

                const { prompt, temperature = 0.7, maxTokens = 1000 } = options;
                
                switch (this.config.selectedPlatform) {
                    case 'openai':
                        return this._callOpenAI(prompt, temperature, maxTokens);
                    case 'anthropic':
                        return this._callAnthropic(prompt, temperature, maxTokens);
                    case 'google':
                        return this._callGoogle(prompt, temperature, maxTokens);
                    case 'azure':
                        return this._callAzure(prompt, temperature, maxTokens);
                    case 'openrouter':
                        return this._callOpenRouter(prompt, temperature, maxTokens);
                    case 'cloudflare':
                        return this._callCloudflare(prompt, temperature, maxTokens);
                    case 'silibase':
                        return this._callSilibase(prompt, temperature, maxTokens);
                    default:
                        throw new Error(`不支持的AI平台: ${this.config.selectedPlatform}`);
                }
            }

            /**
             * 验证与AI平台的连接是否有效
             */
            async verifyConnection() {
                if (!this.isConfigured()) {
                    throw new Error('AI服务尚未配置完整，请检查配置');
                }

                try {
                    // 不同平台使用不同的验证方法
                    switch (this.config.selectedPlatform) {
                        case 'openai':
                            // 调用模型列表API验证
                            const models = await this.fetchModels(this.config.selectedPlatform, this.config.apiKey);
                            return models.length > 0;
                            
                        case 'anthropic':
                            // 发送一个简单的测试请求
                            const testPrompt = "请返回'连接成功'以验证API可用";
                            const response = await this._callAnthropic(testPrompt, 0, 10);
                            return response.includes('连接成功');
                            
                        case 'google':
                            // 调用模型列表API验证
                            const googleModels = await this.fetchModels(this.config.selectedPlatform, this.config.apiKey);
                            return googleModels.length > 0;
                            
                        case 'azure':
                            // 发送一个简单的测试请求
                            const azureTestPrompt = "请返回'连接成功'以验证API可用";
                            const azureResponse = await this._callAzure(azureTestPrompt, 0, 10);
                            return azureResponse.includes('连接成功');
                            
                        case 'openrouter':
                            // 调用模型列表API验证
                            const orModels = await this.fetchModels(this.config.selectedPlatform, this.config.apiKey);
                            return orModels.length > 0;
                            
                        case 'cloudflare':
                            // 调用模型列表API验证
                            const cfModels = await this.fetchModels(
                                this.config.selectedPlatform, 
                                this.config.apiKey,
                                { cloudflareAccountId: this.config.cloudflareAccountId }
                            );
                            return cfModels.length > 0;
                            
                        case 'silibase':
                            // 调用模型列表API验证
                            const sbModels = await this.fetchModels(this.config.selectedPlatform, this.config.apiKey);
                            return sbModels.length > 0;
                            
                        default:
                            throw new Error(`不支持的AI平台: ${this.config.selectedPlatform}`);
                    }
                } catch (error) {
                    console.error("连接验证失败:", error);
                    throw error;
                }
            }

            async _callOpenAI(prompt, temperature, maxTokens) {
                const url = `${this.platforms.openai.baseUrl}/chat/completions`;
                
                const messages = Array.isArray(prompt) 
                    ? prompt 
                    : [{ role: "user", content: prompt }];

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${this.config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: this.config.selectedModel,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`OpenAI API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error("OpenAI调用失败:", error);
                    throw error;
                }
            }

            async _callAnthropic(prompt, temperature, maxTokens) {
                const url = `${this.platforms.anthropic.baseUrl}/messages`;
                
                const messages = Array.isArray(prompt) 
                    ? prompt 
                    : [{ role: "user", content: prompt }];

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "x-api-key": this.config.apiKey,
                            "anthropic-version": "2023-06-01",
                            "User-Agent": ("AI Service Tool").replace(/[^\x00-\xFF]/g, '') // 移除非ASCII字符
                        },
                        body: JSON.stringify({
                            model: this.config.selectedModel,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Anthropic API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.content[0].text;
                } catch (error) {
                    console.error("Anthropic调用失败:", error);
                    throw error;
                }
            }

            async _callGoogle(prompt, temperature, maxTokens) {
                const url = `${this.platforms.google.baseUrl}/models/${this.config.selectedModel}:generateContent?key=${this.config.apiKey}`;
                
                const contents = Array.isArray(prompt)
                    ? prompt.map(msg => ({
                        role: msg.role === 'assistant' ? 'model' : msg.role,
                        parts: [{ text: msg.content }]
                    }))
                    : [{
                        role: 'user',
                        parts: [{ text: prompt }]
                    }];

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            contents: contents,
                            generationConfig: {
                                temperature: temperature,
                                maxOutputTokens: maxTokens
                            }
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Google Gemini API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Google Gemini调用失败:", error);
                    throw error;
                }
            }

            async _callAzure(prompt, temperature, maxTokens) {
                const url = `${this.config.azureEndpoint}/openai/deployments/${this.config.selectedModel}/chat/completions?api-version=2023-10-01-preview`;
                
                const messages = Array.isArray(prompt) 
                    ? prompt 
                    : [{ role: "user", content: prompt }];

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "api-key": this.config.apiKey
                        },
                        body: JSON.stringify({
                            messages: messages,
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Azure OpenAI API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error("Azure OpenAI调用失败:", error);
                    throw error;
                }
            }

            async _callOpenRouter(prompt, temperature, maxTokens) {
                const url = `${this.platforms.openrouter.baseUrl}/chat/completions`;
                
                const messages = Array.isArray(prompt) 
                    ? prompt 
                    : [{ role: "user", content: prompt }];

                // 处理可能包含非ASCII字符的referer和title
                const safeReferer = window.location.href.replace(/[^\x00-\xFF]/g, '');
                const safeTitle = (document.title || "AI Application").replace(/[^\x00-\xFF]/g, '');

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${this.config.apiKey}`,
                            "HTTP-Referer": safeReferer,
                            "X-Title": safeTitle
                        },
                        body: JSON.stringify({
                            model: this.config.selectedModel,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`OpenRouter API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error("OpenRouter调用失败:", error);
                    throw error;
                }
            }

            async _callCloudflare(prompt, temperature, maxTokens) {
                const url = `https://api.cloudflare.com/client/v4/accounts/${this.config.cloudflareAccountId}/ai/run/${this.config.selectedModel}`;
                
                const input = Array.isArray(prompt) 
                    ? { messages: prompt }
                    : { prompt: prompt };

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${this.config.apiKey}`
                        },
                        body: JSON.stringify({
                            input: input,
                            parameters: {
                                temperature: temperature,
                                max_tokens: maxTokens
                            }
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`Cloudflare API 错误: ${error.errors?.[0]?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    if (data.result?.response) return data.result.response;
                    if (data.result?.choices?.[0]?.message?.content) return data.result.choices[0].message.content;
                    return JSON.stringify(data.result);
                } catch (error) {
                    console.error("Cloudflare调用失败:", error);
                    throw error;
                }
            }

            async _callSilibase(prompt, temperature, maxTokens) {
                const url = `${this.platforms.silibase.baseUrl}/chat/completions`;
                
                const messages = Array.isArray(prompt) 
                    ? prompt 
                    : [{ role: "user", content: prompt }];

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${this.config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: this.config.selectedModel,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: maxTokens
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(`硅基流动 API 错误: ${error.error?.message || '未知错误'}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error("硅基流动调用失败:", error);
                    throw error;
                }
            }
        }

        // 创建AI服务实例
        const aiService = new AIPlatformService();

        // DOM元素引用
        const modal = document.getElementById('aiServiceModal');
        const openModalBtn = document.getElementById('openAIModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        
        // 视图容器
        const aiUsageView = document.getElementById('aiUsageView');
        const aiConfigView = document.getElementById('aiConfigView');
        
        // AI使用界面元素
        const usageConfigStatusBar = document.getElementById('usageConfigStatusBar');
        const usageModelSelect = document.getElementById('usageModelSelect');
        const usagePromptInput = document.getElementById('usagePromptInput');
        const openConfigViewBtn = document.getElementById('openConfigViewBtn');
        const usageStatusIndicator = document.getElementById('usageStatusIndicator');
        const usageResultContainer = document.getElementById('usageResultContainer');
        const usageResultContent = document.getElementById('usageResultContent');
        const usageCancelBtn = document.getElementById('usageCancelBtn');
        const usageSubmitBtn = document.getElementById('usageSubmitBtn');
        
        // AI配置界面元素
        const configStatusBar = document.getElementById('configStatusBar');
        const platformSelect = document.getElementById('platformSelect');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const toggleKeyVisibility = document.getElementById('toggleKeyVisibility');
        const modelSearchContainer = document.getElementById('modelSearchContainer');
        const modelSearchInput = document.getElementById('modelSearchInput');
        const refreshFavoriteModelsBtn = document.getElementById('refreshFavoriteModelsBtn');
        const modelLoadingIndicator = document.getElementById('modelLoadingIndicator');
        const platformSpecificConfigs = document.getElementById('platformSpecificConfigs');
        const cloudflareConfig = document.getElementById('cloudflareConfig');
        const azureConfig = document.getElementById('azureConfig');
        const cloudflareAccountId = document.getElementById('cloudflareAccountId');
        const azureEndpoint = document.getElementById('azureEndpoint');
        const configHeader = document.getElementById('configHeader');
        const configContent = document.getElementById('configContent');
        const toggleConfigBtn = document.getElementById('toggleConfigBtn');
        const configIcon = document.getElementById('configIcon');
        const apiKeyHelpLink = document.getElementById('apiKeyHelpLink');
        const configCancelBtn = document.getElementById('configCancelBtn');
        const configSaveBtn = document.getElementById('configSaveBtn');
        
        // 高级选项元素
        const temperatureInput = document.getElementById('temperatureInput');
        const maxTokensInput = document.getElementById('maxTokensInput');
        
        // 常用模型相关元素
        const favoriteModelsContainer = document.getElementById('favoriteModelsContainer');
        const favoriteModelsList = document.getElementById('favoriteModelsList');
        
        // 保存所有平台的配置数据
        let allPlatformConfigs = {};
        
        // 保存常用模型数据
        let favoriteModels = {};
        
        // 当前视图状态
        let currentView = 'usage'; // 'usage' 或 'config'

        // 初始化平台选择下拉框
        function initPlatformSelect() {
            // 确保平台选择元素存在
            if (!platformSelect) return;
            
            const platforms = aiService.getPlatforms();
            platformSelect.innerHTML = '<option value="">-- 请选择平台 --</option>'; // 清空并添加默认选项
            Object.entries(platforms).forEach(([key, platform]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = platform.name;
                platformSelect.appendChild(option);
            });
        }

        // 保存当前平台的配置到存储
        function saveCurrentPlatformConfig() {
            const selectedPlatform = platformSelect.value;
            if (!selectedPlatform) return;
            
            // 创建当前平台的配置对象
            const platformConfig = {
                apiKey: apiKeyInput.value,
                cloudflareAccountId: cloudflareAccountId.value,
                azureEndpoint: azureEndpoint.value,
                temperature: temperatureInput.value,
                maxTokens: maxTokensInput.value,
                // 保存常用模型设置
                favoriteModels: favoriteModels[selectedPlatform] || []
            };
            
            // 更新配置集合
            allPlatformConfigs[selectedPlatform] = platformConfig;
            
            // 保存到本地存储
            localStorage.setItem('allAIPlatformConfigs', JSON.stringify(allPlatformConfigs));
            
            // 添加调试信息
            console.log('保存配置:', selectedPlatform, platformConfig);
        }

        // 保存配置并返回使用界面
        function saveConfigAndReturn() {
            // 保存当前配置
            saveCurrentPlatformConfig();
            
            // 切换回使用界面
            switchToUsageView();
        }

        // 取消配置并返回使用界面
        function cancelConfigAndReturn() {
            // 重新加载配置以撤销未保存的更改
            loadCurrentPlatformConfig();
            
            // 切换回使用界面
            switchToUsageView();
        }

        // 从本地存储加载所有平台的配置
        function loadAllConfigsFromStorage() {
            const savedConfigs = localStorage.getItem('allAIPlatformConfigs');
            console.log('从本地存储加载配置:', savedConfigs);
            if (savedConfigs) {
                try {
                    allPlatformConfigs = JSON.parse(savedConfigs);
                    // 加载常用模型设置
                    for (const [platform, config] of Object.entries(allPlatformConfigs)) {
                        if (config.favoriteModels) {
                            favoriteModels[platform] = config.favoriteModels;
                        }
                    }
                    console.log('加载的配置:', allPlatformConfigs);
                } catch (e) {
                    console.error('加载平台配置失败:', e);
                    allPlatformConfigs = {};
                }
            }
            
            // 自动选择已配置的平台
            autoSelectConfiguredPlatform();
        }

        // 自动选择已配置的平台
        function autoSelectConfiguredPlatform() {
            console.log('自动选择平台: 检查所有平台配置', allPlatformConfigs);
            
            // 遍历所有已保存的配置，找到第一个完整配置的平台
            for (const [platform, config] of Object.entries(allPlatformConfigs)) {
                console.log(`检查平台 ${platform}:`, config);
                
                // 检查必要配置是否存在
                const hasApiKey = config.apiKey && config.apiKey.trim() !== '';
                const hasCloudflareAccount = platform !== 'cloudflare' || (config.cloudflareAccountId && config.cloudflareAccountId.trim() !== '');
                const hasAzureEndpoint = platform !== 'azure' || (config.azureEndpoint && config.azureEndpoint.trim() !== '');
                
                console.log(`平台 ${platform} 配置检查: apiKey=${hasApiKey}, cloudflare=${hasCloudflareAccount}, azure=${hasAzureEndpoint}`);
                
                if (hasApiKey && hasCloudflareAccount && hasAzureEndpoint) {
                    console.log(`选择平台 ${platform}`);
                    
                    // 设置平台选择
                    if (platformSelect) platformSelect.value = platform;
                    
                    // 直接加载该平台的配置
                    loadCurrentPlatformConfig();
                    
                    // 更新使用界面
                    updateUsageModelSelect();
                    updateUsageConfigStatus();
                    
                    return;
                }
            }
            
            console.log('没有找到完整配置的平台');
        }

        // 加载当前选中平台的配置
        function loadCurrentPlatformConfig() {
            const selectedPlatform = platformSelect.value;
            console.log('加载平台配置:', selectedPlatform);
            if (!selectedPlatform) return;
            
            const platformConfig = allPlatformConfigs[selectedPlatform] || {};
            console.log('平台配置内容:', platformConfig);
            
            // 填充表单字段
            apiKeyInput.value = platformConfig.apiKey || '';
            cloudflareAccountId.value = platformConfig.cloudflareAccountId || '';
            azureEndpoint.value = platformConfig.azureEndpoint || '';
            temperatureInput.value = platformConfig.temperature || 0.7;
            maxTokensInput.value = platformConfig.maxTokens || 1000;
            
            // 加载常用模型设置
            if (platformConfig.favoriteModels) {
                favoriteModels[selectedPlatform] = platformConfig.favoriteModels;
                console.log('加载常用模型:', platformConfig.favoriteModels);
            }
            
            // 更新API密钥申请链接
            const platforms = aiService.getPlatforms();
            if (platforms[selectedPlatform]?.apiKeyUrl) {
                apiKeyHelpLink.href = platforms[selectedPlatform].apiKeyUrl;
                apiKeyHelpLink.classList.remove('hidden');
            } else {
                apiKeyHelpLink.classList.add('hidden');
            }
            
            // 更新常用模型列表
            updateFavoriteModelsList();
            
            updateConfigStatus();
        }

        // 更新常用模型列表显示
        function updateFavoriteModelsList() {
            const selectedPlatform = platformSelect.value;
            if (!selectedPlatform) return;
            
            // 清空列表
            favoriteModelsList.innerHTML = '';
            
            // 获取当前平台的所有模型
            const allModels = aiService.getModels(selectedPlatform);
            
            // 如果没有模型，显示提示信息
            if (allModels.length === 0) {
                favoriteModelsList.innerHTML = '<p class="text-sm text-gray-500">暂无可用模型，请先获取模型列表</p>';
                return;
            }
            
            // 获取当前平台的常用模型设置
            const platformFavoriteModels = favoriteModels[selectedPlatform] || [];
            
            // 为每个模型创建复选框
            allModels.forEach(model => {
                const div = document.createElement('div');
                div.className = 'flex items-center mb-1';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `favorite-${model}`;
                checkbox.value = model;
                checkbox.className = 'mr-2';
                checkbox.checked = platformFavoriteModels.includes(model);
                
                const label = document.createElement('label');
                label.htmlFor = `favorite-${model}`;
                label.className = 'text-sm';
                label.textContent = model;
                
                // 添加事件监听器
                checkbox.addEventListener('change', function() {
                    toggleFavoriteModel(selectedPlatform, model, this.checked);
                });
                
                div.appendChild(checkbox);
                div.appendChild(label);
                favoriteModelsList.appendChild(div);
            });
        }

        // 切换常用模型状态
        function toggleFavoriteModel(platform, model, isFavorite) {
            console.log('切换常用模型状态:', platform, model, isFavorite);
            if (!favoriteModels[platform]) {
                favoriteModels[platform] = [];
            }
            
            if (isFavorite) {
                // 添加到常用模型
                if (!favoriteModels[platform].includes(model)) {
                    favoriteModels[platform].push(model);
                }
            } else {
                // 从常用模型中移除
                favoriteModels[platform] = favoriteModels[platform].filter(m => m !== model);
            }
            
            console.log('更新后的常用模型:', favoriteModels[platform]);
            
            // 保存配置
            saveCurrentPlatformConfig();
            
            // 更新快速切换按钮状态
            updateQuickModelSwitchButton();
        }

        // 刷新常用模型列表
        async function refreshFavoriteModels() {
            const selectedPlatform = platformSelect.value;
            const apiKey = apiKeyInput.value;
            
            if (!selectedPlatform || !apiKey) {
                showStatus('请先选择平台并输入API密钥', 'error');
                return;
            }
            
            try {
                modelLoadingIndicator.classList.remove('hidden');
                showStatus('正在获取模型列表...', 'info');
                
                // 准备平台特定选项
                const options = {};
                if (selectedPlatform === 'cloudflare') {
                    options.cloudflareAccountId = cloudflareAccountId.value;
                }
                
                // 获取模型列表
                await aiService.fetchModels(selectedPlatform, apiKey, options);
                
                // 更新常用模型列表
                updateFavoriteModelsList();
                
                showStatus('模型列表刷新成功', 'success');
            } catch (error) {
                showStatus(`获取模型列表失败: ${error.message}`, 'error');
            } finally {
                modelLoadingIndicator.classList.add('hidden');
            }
        }

        // 更新快速切换模型按钮状态
        function updateQuickModelSwitchButton() {
            // 确保元素存在再操作
            const quickModelSwitchBtn = document.getElementById('quickModelSwitchBtn');
            if (!quickModelSwitchBtn) return;
            
            const selectedPlatform = platformSelect.value;
            if (!selectedPlatform) {
                quickModelSwitchBtn.classList.add('hidden');
                return;
            }
            
            const platformFavoriteModels = favoriteModels[selectedPlatform] || [];
            if (platformFavoriteModels.length > 0) {
                quickModelSwitchBtn.classList.remove('hidden');
            } else {
                quickModelSwitchBtn.classList.add('hidden');
            }
        }

        // 显示常用模型下拉菜单
        function showFavoriteModelsDropdown() {
            // 确保元素存在再操作
            const favoriteModelsDropdown = document.getElementById('favoriteModelsDropdown');
            if (!favoriteModelsDropdown) return;
            
            const selectedPlatform = platformSelect.value;
            if (!selectedPlatform) return;
            
            const platformFavoriteModels = favoriteModels[selectedPlatform] || [];
            if (platformFavoriteModels.length === 0) return;
            
            // 清空下拉菜单
            favoriteModelsDropdown.innerHTML = '';
            
            // 为每个常用模型创建选项
            platformFavoriteModels.forEach(model => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer';
                div.textContent = model;
                
                // 添加点击事件
                div.addEventListener('click', () => {
                    // 隐藏下拉菜单
                    favoriteModelsDropdown.classList.add('hidden');
                });
                
                favoriteModelsDropdown.appendChild(div);
            });
            
            // 显示下拉菜单
            favoriteModelsDropdown.classList.remove('hidden');
        }

        // 隐藏常用模型下拉菜单
        function hideFavoriteModelsDropdown() {
            const favoriteModelsDropdown = document.getElementById('favoriteModelsDropdown');
            if (favoriteModelsDropdown) {
                favoriteModelsDropdown.classList.add('hidden');
            }
        }

        // 处理平台选择变化
        function onPlatformChange() {
            // 先保存当前平台的配置
            if (platformSelect.value) {
                saveCurrentPlatformConfig();
            }
            
            const selectedPlatform = platformSelect.value;
            
            // 显示平台特定配置
            cloudflareConfig.classList.add('hidden');
            azureConfig.classList.add('hidden');
            
            if (selectedPlatform === 'cloudflare') {
                cloudflareConfig.classList.remove('hidden');
            } else if (selectedPlatform === 'azure') {
                azureConfig.classList.remove('hidden');
            }
            
            // 加载新选中平台的配置
            loadCurrentPlatformConfig();
            
            // 如果有API密钥，尝试加载模型
            if (selectedPlatform && apiKeyInput.value) {
                refreshFavoriteModels();
            }
            
            // 延迟更新配置可见性，确保配置加载完成
            setTimeout(() => {
                updateConfigStatus();
                updateConfigVisibility();
            }, 300);
        }

        // 获取并更新模型列表
        async function fetchAndUpdateModels() {
            const selectedPlatform = platformSelect.value;
            const apiKey = apiKeyInput.value;
            
            if (!selectedPlatform || !apiKey) {
                showStatus('请先选择平台并输入API密钥', 'error');
                return;
            }
            
            try {
                modelLoadingIndicator.classList.remove('hidden');
                showStatus('正在获取模型列表...', 'info');
                
                // 准备平台特定选项
                const options = {};
                if (selectedPlatform === 'cloudflare') {
                    options.cloudflareAccountId = cloudflareAccountId.value;
                }
                
                // 获取模型列表
                const models = await aiService.fetchModels(selectedPlatform, apiKey, options);
                
                // 更新常用模型列表
                updateFavoriteModelsList();
                
                showStatus(`成功获取 ${models.length} 个模型`, 'success');
            } catch (error) {
                showStatus(`获取模型失败: ${error.message}`, 'error');
            } finally {
                modelLoadingIndicator.classList.add('hidden');
                updateConfigStatus();
            }
        }

        // 模型搜索功能
        function searchModels() {
            const searchTerm = modelSearchInput.value.toLowerCase().trim();
            const checkboxes = favoriteModelsList.querySelectorAll('input[type="checkbox"]');
            
            if (!searchTerm) {
                // 清空搜索时显示所有选项
                checkboxes.forEach(checkbox => {
                    const parentDiv = checkbox.parentElement;
                    parentDiv.style.display = '';
                });
                return;
            }
            
            // 过滤匹配的模型
            checkboxes.forEach(checkbox => {
                const label = checkbox.parentElement.querySelector('label');
                const text = label.textContent.toLowerCase();
                const matches = text.includes(searchTerm);
                
                const parentDiv = checkbox.parentElement;
                parentDiv.style.display = matches ? '' : 'none';
            });
        }

        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusIndicator = configStatusBar; // 使用配置状态栏作为状态指示器
            statusIndicator.textContent = message;
            statusIndicator.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 
                                           'bg-green-100', 'text-green-800', 
                                           'bg-yellow-100', 'text-yellow-800', 
                                           'bg-red-100', 'text-red-800');
            
            switch (type) {
                case 'info':
                    statusIndicator.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'success':
                    statusIndicator.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'warning':
                    statusIndicator.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'error':
                    statusIndicator.classList.add('bg-red-100', 'text-red-800');
                    break;
            }
        }

        // 隐藏状态信息
        function hideStatus() {
            const statusIndicator = configStatusBar; // 使用配置状态栏作为状态指示器
            statusIndicator.classList.add('hidden');
        }

        // 更新配置状态条
        function updateConfigStatus() {
            const isConfigured = checkIfConfigured();
            
            configStatusBar.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
            
            if (isConfigured) {
                const platforms = aiService.getPlatforms();
                const platformName = platforms[platformSelect.value]?.name || platformSelect.value;
                configStatusBar.innerHTML = `<i class="fa fa-check-circle text-green-600 mr-2"></i>已配置: ${platformName}`;
                configStatusBar.classList.add('bg-green-100', 'text-green-800');
            } else {
                configStatusBar.innerHTML = '<i class="fa fa-exclamation-triangle text-yellow-600 mr-2"></i>请完成AI配置以使用服务';
                configStatusBar.classList.add('bg-yellow-100', 'text-yellow-800');
            }
        }

        // 检查是否已配置
        function checkIfConfigured() {
            // 检查是否选择了平台
            if (!platformSelect.value) return false;
            
            // 检查是否输入了API密钥
            if (!apiKeyInput.value) return false;
            
            // 平台特定检查
            if (platformSelect.value === 'cloudflare' && !cloudflareAccountId.value) {
                return false;
            }
            
            if (platformSelect.value === 'azure' && !azureEndpoint.value) {
                return false;
            }
            
            return true;
        }

        // 更新配置区域可见性
        function updateConfigVisibility() {
            const isConfigured = checkIfConfigured();
            
            if (isConfigured) {
                // 已配置，默认隐藏配置内容
                collapseConfig();
            } else {
                // 未配置，默认显示配置内容
                expandConfig();
            }
            
            updateConfigStatus();
        }

        // 展开配置区域
        function expandConfig() {
            configContent.classList.remove('hidden', 'h-0', 'opacity-0', 'overflow-hidden');
            configIcon.classList.remove('fa-chevron-right');
            configIcon.classList.add('fa-chevron-down');
        }

        // 折叠配置区域
        function collapseConfig() {
            configContent.classList.add('h-0', 'opacity-0', 'overflow-hidden');
            setTimeout(() => {
                configContent.classList.add('hidden');
            }, 300);
            configIcon.classList.remove('fa-chevron-down');
            configIcon.classList.add('fa-chevron-right');
        }

        // 切换配置区域显示/隐藏
        function toggleConfig() {
            if (configContent.classList.contains('hidden') || configContent.classList.contains('h-0')) {
                expandConfig();
            } else {
                collapseConfig();
            }
        }

        // 更新提交按钮状态
        function updateSubmitButtonState() {
            const isReady = checkIfConfigured() && usagePromptInput.value; // 修复引用错误
            usageSubmitBtn.disabled = !isReady; // 修复引用错误
        }

        // 切换API密钥可见性
        function toggleKeyVisibilityHandler() {
            const type = apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
            apiKeyInput.setAttribute('type', type);
            toggleKeyVisibility.innerHTML = type === 'password' ? 
                '<i class="fa fa-eye-slash"></i>' : 
                '<i class="fa fa-eye"></i>';
        }

        // 验证连接
        async function verifyConnection() {
            const selectedPlatform = platformSelect.value;
            const apiKey = apiKeyInput.value;
            
            if (!selectedPlatform || !apiKey) {
                showStatus('请先选择平台并输入API密钥', 'error');
                return;
            }
            
            try {
                // 保存当前配置
                saveCurrentPlatformConfig();
                
                // 配置AI服务
                aiService.configure({
                    platform: selectedPlatform,
                    model: '', // 模型将在实际调用时指定
                    apiKey: apiKey,
                    azureEndpoint: azureEndpoint.value,
                    cloudflareAccountId: cloudflareAccountId.value
                });
                
                // 显示验证中状态
                showStatus('正在验证与AI平台的连接...', 'info');
                
                // 执行验证
                const isConnected = await aiService.verifyConnection();
                
                if (isConnected) {
                    showStatus('连接验证成功！可以使用AI服务', 'success');
                    updateConfigVisibility();
                    
                    // 更新常用模型列表
                    updateFavoriteModelsList();
                } else {
                    showStatus('连接验证失败，无法确认API是否可用', 'error');
                }
            } catch (error) {
                showStatus(`连接验证失败: ${error.message}`, 'error');
            }
        }

        // 发送AI请求
        async function sendAIRequest() {
            const selectedPlatform = platformSelect.value;
            const selectedModel = usageModelSelect.value;
            const apiKey = apiKeyInput.value;
            const prompt = usagePromptInput.value;
            const temperature = parseFloat(temperatureInput.value);
            const maxTokens = parseInt(maxTokensInput.value);
            
            // 保存配置
            saveCurrentPlatformConfig();
            
            try {
                // 配置AI服务
                aiService.configure({
                    platform: selectedPlatform,
                    model: selectedModel,
                    apiKey: apiKey,
                    azureEndpoint: azureEndpoint.value,
                    cloudflareAccountId: cloudflareAccountId.value
                });
                
                // 显示加载状态
                usageSubmitBtn.disabled = true;
                usageSubmitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>处理中...';
                showUsageStatus('正在向AI发送请求...', 'info');
                usageResultContainer.classList.add('hidden');
                
                // 调用AI生成内容
                const result = await aiService.generate({
                    prompt: prompt,
                    temperature: temperature,
                    maxTokens: maxTokens
                });
                
                // 显示结果
                showUsageStatus('请求成功完成', 'success');
                usageResultContent.textContent = result;
                usageResultContainer.classList.remove('hidden');
                
                // 滚动到结果区域
                usageResultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (error) {
                showUsageStatus(`请求失败: ${error.message}`, 'error');
                usageResultContainer.classList.add('hidden');
            } finally {
                usageSubmitBtn.disabled = false;
                usageSubmitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送请求';
            }
        }

        // 显示使用界面状态信息
        function showUsageStatus(message, type = 'info') {
            usageStatusIndicator.textContent = message;
            usageStatusIndicator.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 
                                           'bg-green-100', 'text-green-800', 
                                           'bg-yellow-100', 'text-yellow-800', 
                                           'bg-red-100', 'text-red-800');
            
            switch (type) {
                case 'info':
                    usageStatusIndicator.classList.add('bg-blue-100', 'text-blue-800');
                    break;
                case 'success':
                    usageStatusIndicator.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'warning':
                    usageStatusIndicator.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                case 'error':
                    usageStatusIndicator.classList.add('bg-red-100', 'text-red-800');
                    break;
            }
        }

        // 打开弹窗
        function openModal() {
            modal.classList.remove('hidden');
            // 如果有预设的提示词，填充它
            const presetPrompt = modal.dataset.presetPrompt;
            if (presetPrompt) {
                usagePromptInput.value = presetPrompt;
                // 清除预设，避免下次打开还显示
                delete modal.dataset.presetPrompt;
            }
            
            // 默认显示使用界面
            switchToUsageView();
        }

        // 关闭弹窗
        function closeModal() {
            // 保存当前配置
            if (platformSelect.value) {
                saveCurrentPlatformConfig();
            }
            modal.classList.add('hidden');
            hideStatus();
            showUsageStatus('', 'info'); // 清空使用界面状态
        }

        // 切换到AI使用界面
        function switchToUsageView() {
            aiUsageView.classList.remove('hidden');
            aiConfigView.classList.add('hidden');
            document.getElementById('usageViewFooter').classList.remove('hidden');
            document.getElementById('configViewFooter').classList.add('hidden');
            currentView = 'usage';
            
            // 更新使用界面的模型选择
            updateUsageModelSelect();
            
            // 更新配置状态
            updateUsageConfigStatus();
        }

        // 切换到AI配置界面
        function switchToConfigView() {
            aiUsageView.classList.add('hidden');
            aiConfigView.classList.remove('hidden');
            document.getElementById('usageViewFooter').classList.add('hidden');
            document.getElementById('configViewFooter').classList.remove('hidden');
            currentView = 'config';
            
            // 更新配置状态
            updateConfigStatus();
        }

        // 更新使用界面的模型选择
        function updateUsageModelSelect() {
            // 清空选择框
            usageModelSelect.innerHTML = '';
            
            // 获取当前配置的平台
            const selectedPlatform = platformSelect.value;
            if (!selectedPlatform) {
                usageModelSelect.innerHTML = '<option value="">-- 请先配置AI平台 --</option>';
                usageSubmitBtn.disabled = true;
                return;
            }
            
            // 获取当前平台的常用模型
            const platformFavoriteModels = favoriteModels[selectedPlatform] || [];
            
            // 如果有常用模型，显示常用模型
            if (platformFavoriteModels.length > 0) {
                platformFavoriteModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    usageModelSelect.appendChild(option);
                });
            } else {
                // 如果没有常用模型，显示提示信息
                usageModelSelect.innerHTML = '<option value="">-- 请先配置常用模型 --</option>';
            }
            
            // 更新发送按钮状态
            updateUsageSubmitButtonState();
        }

        // 更新使用界面配置状态
        function updateUsageConfigStatus() {
            const isConfigured = checkIfConfigured();
            
            usageConfigStatusBar.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
            
            if (isConfigured) {
                const platforms = aiService.getPlatforms();
                const platformName = platforms[platformSelect.value]?.name || platformSelect.value;
                usageConfigStatusBar.innerHTML = `<i class="fa fa-check-circle text-green-600 mr-2"></i>已配置: ${platformName}`;
                usageConfigStatusBar.classList.add('bg-green-100', 'text-green-800');
            } else {
                usageConfigStatusBar.innerHTML = '<i class="fa fa-exclamation-triangle text-yellow-600 mr-2"></i>请先配置AI平台';
                usageConfigStatusBar.classList.add('bg-yellow-100', 'text-yellow-800');
            }
        }

        // 更新使用界面发送按钮状态
        function updateUsageSubmitButtonState() {
            const isReady = checkIfConfigured() && usagePromptInput.value && usageModelSelect.value;
            usageSubmitBtn.disabled = !isReady;
        }

        // 事件监听器
        if (openModalBtn) openModalBtn.addEventListener('click', openModal);
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (usageCancelBtn) usageCancelBtn.addEventListener('click', closeModal);
        if (configCancelBtn) configCancelBtn.addEventListener('click', cancelConfigAndReturn);
        if (usageSubmitBtn) usageSubmitBtn.addEventListener('click', sendAIRequest);
        if (configSaveBtn) configSaveBtn.addEventListener('click', saveConfigAndReturn);
        if (openConfigViewBtn) openConfigViewBtn.addEventListener('click', switchToConfigView);
        if (platformSelect) platformSelect.addEventListener('change', onPlatformChange);
        if (refreshFavoriteModelsBtn) refreshFavoriteModelsBtn.addEventListener('click', refreshFavoriteModels);
        if (toggleKeyVisibility) toggleKeyVisibility.addEventListener('click', toggleKeyVisibilityHandler);
        if (toggleConfigBtn) toggleConfigBtn.addEventListener('click', toggleConfig);
        if (configHeader) configHeader.addEventListener('click', toggleConfig);
        
        // 输入变化时更新状态
        if (apiKeyInput) apiKeyInput.addEventListener('input', () => {
            updateConfigStatus();
        });
        if (usagePromptInput) usagePromptInput.addEventListener('input', updateUsageSubmitButtonState);
        if (usageModelSelect) usageModelSelect.addEventListener('change', updateUsageSubmitButtonState);
        if (cloudflareAccountId) cloudflareAccountId.addEventListener('input', () => {
            updateConfigStatus();
        });
        if (azureEndpoint) azureEndpoint.addEventListener('input', () => {
            updateConfigStatus();
        });
        if (temperatureInput) temperatureInput.addEventListener('change', saveCurrentPlatformConfig);
        if (maxTokensInput) maxTokensInput.addEventListener('change', saveCurrentPlatformConfig);
        
        // 模型搜索
        if (modelSearchInput) modelSearchInput.addEventListener('input', searchModels);
        
        // 点击弹窗背景关闭弹窗
        if (modal) modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
        
        // 按ESC键关闭弹窗
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // 初始化
        initPlatformSelect();
        loadAllConfigsFromStorage();

        // 提供一个公开方法，允许从外部设置提示词并打开弹窗
        window.setAIPromptAndOpenModal = function(prompt) {
            if (modal) modal.dataset.presetPrompt = prompt;
            openModal();
        };
    </script>
</body>
</html>
    