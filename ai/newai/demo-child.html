<!--
 * MindWord - 树心 | 像画图一样写文档的思维导图写作工具
 * GitHub: https://github.com/TimiKays/MindWord
 * 
 * Copyright 2025 Timi Kays
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>Demo 子页面（请求父页面打开 AI 弹窗）</title>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            padding: 12px;
        }

        label {
            display: block;
            margin-top: 8px;
            font-size: 13px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        #result {
            margin-top: 12px;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 6px;
            min-height: 40px;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h4>子页面演示</h4>
    <div>
        <label>预设提示词（presetPrompt）</label>
        <textarea id="preset" rows="3" placeholder="示例：请列出3条提高工作效率的建议"></textarea>

        <label>初始视图</label>
        <select id="initialView">
            <option value="usage">usage</option>
            <option value="config">config</option>
            <option value="template">template</option>
        </select>

        <button id="openBtn">打开 AI 弹窗</button>
    </div>

    <div id="result">等待结果...</div>

    <script>
        // 从 query 中读取 child id（可选）
        const params = new URLSearchParams(location.search);
        const childId = params.get('child') || 'child';

        function genId() { return 'r_' + Math.random().toString(36).slice(2, 10); }

        const openBtn = document.getElementById('openBtn');
        const preset = document.getElementById('preset');
        const viewSel = document.getElementById('initialView');
        const resultEl = document.getElementById('result');

        openBtn.addEventListener('click', () => {
            const rid = genId();
            const payload = {
                title: `来自 ${childId}`,
                initialView: viewSel.value,
                presetPrompt: preset.value || ''
            };
            console.log('[子页] 发送 AI_MODAL_OPEN_REQUEST', rid, payload);
            // 发送给父页面，请求打开顶层 aiModalFrame
            window.parent.postMessage({ type: 'AI_MODAL_OPEN_REQUEST', requestId: rid, payload }, '*');
            resultEl.textContent = '等待弹窗操作并返回结果...';
        });

        // 保留单一监听器：接收父页面转发的结果
        window.addEventListener('message', (e) => {
            try {
                console.log('[子页] 收到 message', e.origin, e.data);
                const msg = e?.data;
                if (!msg || typeof msg !== 'object') return;
                if (msg.type === 'AI_MODAL_RESULT' && msg.requestId) {
                    if (msg.status === 'success') {
                        resultEl.textContent = '成功：' + (msg.detail?.result || JSON.stringify(msg.detail));
                    } else {
                        resultEl.textContent = '失败：' + (msg.detail?.message || JSON.stringify(msg.detail));
                    }
                }
            } catch (err) {
                console.warn('[子页] message handler error', err);
            }
        }, false);
    </script>
</body>

</html>