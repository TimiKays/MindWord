<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>Demo - 父页面（托管 AI 弹窗）</title>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            padding: 16px;
        }

        .row {
            display: flex;
            gap: 12px;
        }

        iframe.child {
            width: 48%;
            height: 420px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        #aiModalFrame {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
            display: none;
            z-index: 9999;
            background: transparent;
        }

        .bar {
            margin: 8px 0;
            color: #666;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <h3>Demo（父页面） — 顶层托管 AI 弹窗（postMessage）</h3>
    <p class="bar">说明：页面包含两个子 iframe，每个 iframe 填写表单并请求打开 AI 弹窗。弹窗位于屏幕中央（由父页面的 aiModalFrame 承载）。结果回传到对应 iframe 并显示在其结果区。
    </p>

    <div class="row">
        <iframe id="child1" class="child" src="./demo-left.html"></iframe>
        <iframe id="child2" class="child" src="./demo-right.html"></iframe>
    </div>

    <!-- 顶层托管的 AI 弹窗（使用 iframe 加载 AIServiceModal.html） -->
    <iframe id="aiModalFrame" src="./AIServiceModal.html" aria-hidden="true"></iframe>

    <script>
        // 简单请求Id生成
        function genId() { return 'r_' + Math.random().toString(36).slice(2, 10); }

        const aiFrame = document.getElementById('aiModalFrame');
        const children = {
            child1: document.getElementById('child1').contentWindow,
            child2: document.getElementById('child2').contentWindow
        };

        // Map requestId -> source iframe element
        const reqMap = new Map();

        // 接收子 iframe 的 open 请求并转发到 aiModalFrame
        window.addEventListener('message', (e) => {
            try {
                console.log('[父页] 收到 message from', e.origin, e.data);
                const msg = e?.data;
                if (!msg || typeof msg !== 'object') return;
                // 子发起的打开请求
                if (msg.type === 'AI_MODAL_OPEN_REQUEST' && msg.requestId) {
                    console.log('[父页] AI_MODAL_OPEN_REQUEST', msg.requestId, msg.payload);
                    // 记录来源 window（通过 event.source）
                    reqMap.set(msg.requestId, e.source);

                    // 如果子页面要求直接返回（no modal），父页面可以直接处理或模拟返回，
                    // 这里支持 mode:'direct' 的快速响应（不显示 aiModalFrame）
                    if (msg.payload && msg.payload.mode === 'direct') {
                        console.log('[父页] 直接模式（direct），转为 headless 请求到 aiModalFrame（不弹窗）', msg.requestId, 'from', e.origin || '(unknown origin)');
                        // 构造 headless payload（兼容旧字段）
                        let platformCfgRaw = msg.payload.platformConfig || msg.payload.platform || {};
                        // 优先使用调用方提供的 provider；若未提供，尝试从 aiModalFrame 已保存的配置中选取第一个“完整配置”的平台（包含 apiKey 等）。
                        let platformConfig = Object.assign({}, platformCfgRaw);

                        try {
                            // 尝试从 aiModalFrame 的 localStorage 读取已保存平台（仅在同源时可用）
                            const storageStr = aiFrame && aiFrame.contentWindow && aiFrame.contentWindow.localStorage
                                ? aiFrame.contentWindow.localStorage.getItem('allAIPlatformConfigs')
                                : null;
                            if (!platformConfig.provider && storageStr) {
                                try {
                                    const allCfgs = JSON.parse(storageStr || '{}') || {};
                                    // 查找第一个完整配置：有 apiKey 且 cloudflare/azure 的特定字段满足要求
                                    const keys = Object.keys(allCfgs || {});
                                    let chosen = null;
                                    for (const k of keys) {
                                        const c = allCfgs[k] || {};
                                        const hasApiKey = c.apiKey && String(c.apiKey).trim() !== '';
                                        const okCloudflare = (k !== 'cloudflare') || (c.cloudflareAccountId && String(c.cloudflareAccountId).trim() !== '');
                                        const okAzure = (k !== 'azure') || (c.azureEndpoint && String(c.azureEndpoint).trim() !== '');
                                        if (hasApiKey && okCloudflare && okAzure) {
                                            chosen = { key: k, cfg: c };
                                            break;
                                        }
                                    }
                                    if (chosen) {
                                        platformConfig.provider = chosen.key;
                                        // 把必要字段（apiKey/azureEndpoint/cloudflareAccountId）带入 headless 调用
                                        platformConfig.apiKey = platformConfig.apiKey || chosen.cfg.apiKey || '';
                                        if (chosen.cfg.azureEndpoint) platformConfig.azureEndpoint = platformConfig.azureEndpoint || chosen.cfg.azureEndpoint;
                                        if (chosen.cfg.cloudflareAccountId) platformConfig.cloudflareAccountId = platformConfig.cloudflareAccountId || chosen.cfg.cloudflareAccountId;
                                        console.log('[父页] 从 aiModalFrame.localStorage 选择已保存完整平台作为 provider:', chosen.key);
                                    }
                                } catch (e) {
                                    console.warn('[父页] 解析 aiModalFrame localStorage 失败，忽略并继续', e);
                                }
                            }
                        } catch (err) {
                            console.warn('[父页] 读取 aiFrame localStorage 时发生错误（可能跨域），忽略并继续', err);
                        }

                        // 如果仍然没有 provider（或没有已保存完整平台），则打开组件的配置界面（让用户配置后再发起）
                        if (!platformConfig.provider) {
                            console.log('[父页] 未找到已保存完整平台，改为打开 AI 配置界面供用户配置', msg.requestId);
                            try {
                                // 转发到 aiModalFrame 并打开配置视图；保留原始 requestId 以便后续流程追溯
                                aiFrame.contentWindow.postMessage({
                                    type: 'AI_MODAL_OPEN',
                                    payload: Object.assign({}, msg.payload || {}, { initialView: 'config', requestId: msg.requestId })
                                }, '*');
                                console.log('[父页] 已请求 aiModalFrame 打开配置视图', msg.requestId);
                            } catch (postErr) {
                                console.error('[父页] 无法请求 aiModalFrame 打开配置视图', postErr);
                                // 直接回退错误给子 iframe
                                try {
                                    e.source.postMessage({
                                        type: 'AI_MODAL_RESULT',
                                        requestId: msg.requestId,
                                        status: 'error',
                                        detail: { message: '无法打开配置界面，请手动配置平台' }
                                    }, '*');
                                } catch (_) { /* noop */ }
                                reqMap.delete(msg.requestId);
                            }
                            return;
                        }

                        const _tplRaw = msg.payload.templateData || {
                            templateText: msg.payload.template || '',
                            placeholders: msg.payload.params || {}
                        };
                        // 如果 templateText 为空，则尝试从常见来源补齐：先用 placeholders.input.value，再用 msg.payload.template
                        try {
                            if (!(_tplRaw && typeof _tplRaw.templateText === 'string' && _tplRaw.templateText.trim())) {
                                const ph = _tplRaw && _tplRaw.placeholders ? _tplRaw.placeholders : (msg.payload.placeholders || msg.payload.params || {});
                                // 支持多种 placeholder 结构：{ input: { value: '...' } } 或 { input: '...' }
                                let candidate = '';
                                if (ph) {
                                    if (ph.input && typeof ph.input === 'object' && typeof ph.input.value === 'string') candidate = ph.input.value;
                                    else if (typeof ph.input === 'string') candidate = ph.input;
                                }
                                if (!candidate && typeof msg.payload.template === 'string') candidate = msg.payload.template;
                                if (candidate && String(candidate).trim()) {
                                    _tplRaw.templateText = String(candidate);
                                }
                            }
                        } catch (e) {
                            console.warn('[父页] 补齐 templateText 时发生错误，继续使用原始值', e);
                        }
                        const headlessPayload = {
                            platformConfig: platformConfig,
                            modelConfig: msg.payload.modelConfig || msg.payload.model || {},
                            templateData: _tplRaw,
                            options: msg.payload.options || {}
                        };
                        console.log('[父页] headlessPayload 构建完成:', { requestId: msg.requestId, preview: JSON.stringify(headlessPayload).slice(0, 500) });
                        // 发送 headless 请求给 aiModalFrame（使用主 handler 接收返回）
                        // 在发送前登记一个超时计时器（15s），如超时则回退错误给子 iframe
                        const HEADLESS_TIMEOUT_MS = 15000;
                        const headlessTimeouts = window._headlessTimeouts = window._headlessTimeouts || new Map();

                        try {
                            console.log('[父页] 即将向 aiModalFrame.postMessage 发送 headless 请求', msg.requestId);
                            aiFrame.contentWindow.postMessage({
                                type: 'AI_MODAL_RUN_HEADLESS',
                                requestId: msg.requestId,
                                payload: headlessPayload
                            }, '*');
                            console.log('[父页] 已发送 AI_MODAL_RUN_HEADLESS 到 aiModalFrame', msg.requestId);
                            // 注册超时回退
                            const t = setTimeout(() => {
                                try {
                                    e.source.postMessage({
                                        type: 'AI_MODAL_RESULT',
                                        requestId: msg.requestId,
                                        status: 'error',
                                        detail: { message: 'headless call timeout' }
                                    }, '*');
                                    console.warn('[父页] headless 请求超时，已回退 error', msg.requestId);
                                } catch (_) { /* noop */ }
                                headlessTimeouts.delete(msg.requestId);
                                reqMap.delete(msg.requestId);
                            }, HEADLESS_TIMEOUT_MS);
                            headlessTimeouts.set(msg.requestId, { timer: t, source: e.source });
                        } catch (err) {
                            // 发送失败立即回退
                            console.error('[父页] 发送到 aiModalFrame 失败', err);
                            try {
                                e.source.postMessage({
                                    type: 'AI_MODAL_RESULT',
                                    requestId: msg.requestId,
                                    status: 'error',
                                    detail: { message: 'failed to post to aiModalFrame: ' + (err && err.message ? err.message : String(err)) }
                                }, '*');
                                console.log('[父页] 已回退错误信息给 child', msg.requestId);
                            } catch (_) { /* noop */ }
                            reqMap.delete(msg.requestId);
                        }
                        return;
                    }

                    // 否则按原有流程显示 aiModalFrame（modal 模式）
                    try { aiFrame.style.display = 'block'; aiFrame.focus(); } catch (_) { }
                    // 转发给 aiModalFrame（payload 带 requestId），默认使用迷你模式
                    aiFrame.contentWindow.postMessage({
                        type: 'AI_MODAL_OPEN',
                        payload: Object.assign({}, msg.payload || {}, { 
                            requestId: msg.requestId,
                            initialView: 'mini'
                        })
                    }, '*');
                    console.log('[父页] 转发到 aiModalFrame', msg.requestId);
                }
                // aiModalFrame 发回的结果（modal 路径）
                if (msg.type === 'AI_MODAL_RESULT' && msg.requestId) {
                    console.log('[父页] AI_MODAL_RESULT 收到', msg.requestId, msg.status, msg.detail);
                    const srcWin = reqMap.get(msg.requestId);
                    // 隐藏 aiModalFrame（关闭 modal）
                    try { aiFrame.style.display = 'none'; } catch (_) { }
                    // 转发结果给原始子 iframe
                    if (srcWin) {
                        srcWin.postMessage(msg, '*');
                        console.log('[父页] 已转发结果到子 iframe', msg.requestId);
                        reqMap.delete(msg.requestId);
                    } else {
                        console.warn('[父页] 未找到请求来源 for', msg.requestId);
                    }
                }

                // aiModalFrame headless 返回（无弹窗路径）—— 兼容 AI_MODAL_RUN_RESULT
                if (msg.type === 'AI_MODAL_RUN_RESULT' && msg.requestId) {
                    console.log('[父页] AI_MODAL_RUN_RESULT 收到', msg.requestId, msg.status, msg.detail);
                    const srcWin = reqMap.get(msg.requestId);
                    // headless 返回通常无需更改 aiFrame 显示，但确保隐藏以防万一
                    try { aiFrame.style.display = 'none'; } catch (_) { }
                    // 将其包装为 AI_MODAL_RESULT 并转发给原始子 iframe（保持兼容）
                    const outMsg = {
                        type: 'AI_MODAL_RESULT',
                        requestId: msg.requestId,
                        status: msg.status === 'ok' ? 'ok' : 'error',
                        detail: msg.detail
                    };
                    if (srcWin) {
                        try {
                            srcWin.postMessage(outMsg, '*');
                            console.log('[父页] 已转发 headless 结果到子 iframe', msg.requestId, 'status=', outMsg.status);
                        } catch (err) {
                            console.warn('[父页] 转发 headless 结果失败', err);
                        }
                        reqMap.delete(msg.requestId);
                    } else {
                        console.warn('[父页] 未找到请求来源 for headless', msg.requestId);
                    }
                }

                // 处理 AI_MODAL_SAVE_OUTPUT 消息（保存并应用按钮）
                if (msg.type === 'AI_MODAL_SAVE_OUTPUT' && msg.requestId) {
                    console.log('[父页] AI_MODAL_SAVE_OUTPUT 收到', msg.requestId, msg.output);
                    const srcWin = reqMap.get(msg.requestId);
                    // 隐藏 aiModalFrame（关闭 modal）
                    try { aiFrame.style.display = 'none'; } catch (_) { }
                    
                    // 将其包装为 AI_MODAL_RESULT 并转发给原始子 iframe
                    const outMsg = {
                        type: 'AI_MODAL_RESULT',
                        requestId: msg.requestId,
                        status: 'ok',
                        detail: { output: msg.output }
                    };
                    if (srcWin) {
                        try {
                            srcWin.postMessage(outMsg, '*');
                            console.log('[父页] 已转发保存并应用结果到子 iframe', msg.requestId);
                        } catch (err) {
                            console.warn('[父页] 转发保存并应用结果失败', err);
                        }
                        reqMap.delete(msg.requestId);
                    } else {
                        console.warn('[父页] 未找到请求来源 for save output', msg.requestId);
                    }
                }
            } catch (err) {
                console.warn('父页面 message handler error', err);
            }
        }, false);

        // 当 aiModalFrame 本身想要关闭（例如内部 close），它可能也 postMessage 给父页面，我们保持兼容
        // 父页面不自动打开弹窗；一切由子发起
    </script>
</body>

</html>