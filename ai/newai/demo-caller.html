<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>Demo - 父页面（托管 AI 弹窗）</title>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            padding: 16px;
        }

        .row {
            display: flex;
            gap: 12px;
        }

        iframe.child {
            width: 48%;
            height: 420px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        #aiModalFrame {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            border: 0;
            display: none;
            z-index: 9999;
            background: transparent;
        }

        .bar {
            margin: 8px 0;
            color: #666;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <h3>Demo（父页面） — 顶层托管 AI 弹窗（postMessage）</h3>
    <p class="bar">说明：页面包含两个子 iframe，每个 iframe 填写表单并请求打开 AI 弹窗。弹窗位于屏幕中央（由父页面的 aiModalFrame 承载）。结果回传到对应 iframe 并显示在其结果区。
    </p>

    <div class="row">
        <iframe id="child1" class="child" src="./demo-child.html?child=1"></iframe>
        <iframe id="child2" class="child" src="./demo-child.html?child=2"></iframe>
    </div>

    <!-- 顶层托管的 AI 弹窗（使用 iframe 加载 AIServiceModal.html） -->
    <iframe id="aiModalFrame" src="./AIServiceModal.html" aria-hidden="true"></iframe>

    <script>
        // 简单请求Id生成
        function genId() { return 'r_' + Math.random().toString(36).slice(2, 10); }

        const aiFrame = document.getElementById('aiModalFrame');
        const children = {
            child1: document.getElementById('child1').contentWindow,
            child2: document.getElementById('child2').contentWindow
        };

        // Map requestId -> source iframe element
        const reqMap = new Map();

        // 接收子 iframe 的 open 请求并转发到 aiModalFrame
        window.addEventListener('message', (e) => {
            try {
                console.log('[父页] 收到 message from', e.origin, e.data);
                const msg = e?.data;
                if (!msg || typeof msg !== 'object') return;
                // 子发起的打开请求
                if (msg.type === 'AI_MODAL_OPEN_REQUEST' && msg.requestId) {
                    console.log('[父页] AI_MODAL_OPEN_REQUEST', msg.requestId, msg.payload);
                    // 记录来源 window（通过 event.source）
                    reqMap.set(msg.requestId, e.source);
                    // 确保 aiModalFrame 可见并已加载
                    aiFrame.style.display = 'block';
                    aiFrame.focus();
                    // 转发给 aiModalFrame（payload 带 requestId）
                    aiFrame.contentWindow.postMessage({
                        type: 'AI_MODAL_OPEN',
                        payload: Object.assign({}, msg.payload || {}, { requestId: msg.requestId })
                    }, '*');
                    console.log('[父页] 转发到 aiModalFrame', msg.requestId);
                }
                // aiModalFrame 发回的结果
                if (msg.type === 'AI_MODAL_RESULT' && msg.requestId) {
                    console.log('[父页] AI_MODAL_RESULT 收到', msg.requestId, msg.status, msg.detail);
                    const srcWin = reqMap.get(msg.requestId);
                    // 隐藏 aiModalFrame（关闭 modal）
                    try { aiFrame.style.display = 'none'; } catch (_) { }
                    // 转发结果给原始子 iframe
                    if (srcWin) {
                        srcWin.postMessage(msg, '*');
                        console.log('[父页] 已转发结果到子 iframe', msg.requestId);
                        reqMap.delete(msg.requestId);
                    } else {
                        console.warn('[父页] 未找到请求来源 for', msg.requestId);
                    }
                }
            } catch (err) {
                console.warn('父页面 message handler error', err);
            }
        }, false);

        // 当 aiModalFrame 本身想要关闭（例如内部 close），它可能也 postMessage 给父页面，我们保持兼容
        // 父页面不自动打开弹窗；一切由子发起
    </script>
</body>

</html>