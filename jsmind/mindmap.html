<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="../jsmind-local/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>



  <link rel="stylesheet" href="mindmap.css">
</head>

</head>

<body>
  <div class="toolbar">
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->


    <button id="export-json-btn" class="btn" onclick="exportData()">æŸ¥çœ‹JSON</button>
    <button class="btn" onclick="downloadMindmap()">ä¸‹è½½å›¾ç‰‡</button>

    <!-- å›¾æ ‡é€‰æ‹©å™¨ä¸‹æ‹‰èœå•ï¼ˆå·²å®šåˆ¶ï¼šéšè—é»˜è®¤ caretã€åªä¿ç•™ç½‘æ ¼å†…ç¬¬ä¸€ä¸ªâ€œæ¸…é™¤â€æŒ‰é’®ï¼‰ -->
    <style>
      /* éšè— Bootstrap çš„ä¸‹æ‹‰å°ç®­å¤´å¹¶å»æ‰å¯èƒ½çš„èšç„¦åŠ¨ç”»/outline */
      #iconPickerBtn.dropdown-toggle::after { display: none !important; }
      #iconPickerBtn:focus { outline: none !important; box-shadow: none !important; }
      /* å·¥å…·æ å†…å›¾æ ‡æŒ‰é’®ä¿è¯ emoji å¯è§ */
      #iconGridToolbar .icon-picker-item {
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", system-ui, sans-serif;
        color: #222 !important;
        font-size: 20px !important;
        line-height: 1;
        padding: 0;
        background: white !important;
      }
      /* å»æ‰ä¸‹æ‹‰èœå•è‡ªèº«çš„åŠ¨ç”»ï¼ˆè‹¥å­˜åœ¨ï¼‰ */
      #iconPickerDropdown .dropdown-menu {
        transition: none !important;
        -webkit-transition: none !important;
        -moz-transition: none !important;
        
      }
    </style>

    <div class="dropdown" id="iconPickerDropdown" style="display: inline-block;">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="iconPickerBtn" data-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false" title="é€‰æ‹©å›¾æ ‡">
        ğŸ˜Š å›¾æ ‡
      </button>
      <div class="dropdown-menu" aria-labelledby="iconPickerBtn"
        style="width: 360px; max-height: 420px; overflow-y: auto; overflow-x: hidden;">
        <div style="padding: 12px;">
          <h6 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">é€‰æ‹©å›¾æ ‡</h6>
          <div id="iconGridToolbar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding-bottom:8px; box-sizing: border-box; column-gap:6px;">
            <!-- å›¾æ ‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆï¼ˆç¬¬ä¸€ä¸ªä¸ºæ¸…é™¤ï¼‰ -->
          </div>
        </div>
        <!-- å·²ç§»é™¤é‡å¤çš„åº•éƒ¨æ¸…é™¤æŒ‰é’®ï¼ˆä»…ä¿ç•™ç½‘æ ¼ä¸­çš„ç¬¬ä¸€ä¸ªæ¸…é™¤æŒ‰é’®ï¼‰ -->
      </div>
    </div>

    <!-- å³ä¾§ä¸‰ä¸ªç®€å•å¤é€‰æ¡†ï¼šè¯¦æƒ…é¢æ¿ / æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹ / æ˜¾ç¤ºåˆ—è¡¨èŠ‚ç‚¹ -->
    <div id="toolbarToggles"
      style="margin-left:auto;display:flex;gap:12px;align-items:flex-end;justify-content:flex-end;">
      <label class="mw-toggle-showdetails"
        style="display:flex;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleNodeDetailsCheckbox" type="checkbox" checked style="width:18px;height:18px;margin:6px auto;display:block;">
        <span style="display:block;margin-top:0;">è¯¦æƒ…é¢æ¿</span>
      </label>
      <label class="mw-toggle-showtype"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowNodeTypeCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">æ˜¾ç¤ºç±»å‹</span>
      </label>
      <label class="mw-toggle-showtitleonly"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowListNodesCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">åªçœ‹æ ‡é¢˜</span>
      </label>
    </div>



    <!-- batchOperations ä¿ç•™åœ¨ DOM ä¸­ä½†ä¼šè¢«ç§»åŠ¨åˆ°ç”»å¸ƒå·¦ä¸Šï¼ˆé€šè¿‡è„šæœ¬åœ¨éç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ -->
    <div id="batchOperations"
      style="display: inline-block; margin-top: 2px; padding: 5px 10px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; margin-right: 10px;">å·²é€‰ä¸­ <span id="selectedCount">0</span>
        ä¸ªèŠ‚ç‚¹</span>
    </div>

  </div>

  <div class="main-container">
    <div id="fullScreenMindmap"></div>

    <!-- batchOperations å°†åœ¨é¡µé¢åŠ è½½æ—¶è¢«ç§»åŠ¨ï¼ˆéç§»åŠ¨ç«¯ï¼‰åˆ° #fullScreenMindmap å·¦ä¸Šè§’ -->


    <div id="mw-batchops" aria-hidden="false" style="display:none;">
      <span id="mw-batchops-text">å·²é€‰ä¸­ <strong id="selectedCountDisplay">0</strong> ä¸ªèŠ‚ç‚¹</span>
    </div>

    <!-- æµ®åŠ¨èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ï¼ˆå¯å…³é—­ï¼‰ï¼Œä¿ç•™å†…éƒ¨å­—æ®µå’ŒåŠŸèƒ½ -->
    <div id="nodeDetails" role="dialog" aria-hidden="true" aria-label="èŠ‚ç‚¹è¯¦æƒ…">
      <div class="panel-header">
        <strong>èŠ‚ç‚¹è¯¦æƒ…</strong>
        <button class="panel-close-btn" aria-label="å…³é—­èŠ‚ç‚¹è¯¦æƒ…" onclick="hideNodeDetails()">âœ•</button>
      </div>

      <div id="nodeInfo"></div>

      <div class="form-group">
        <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
        <textarea id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜..." rows="3" style="width:100%; resize:vertical; line-height:1.4em;"></textarea>
      </div>

      <div class="form-group">
        <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
        <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn" onclick="expandWithAI()"
          style="flex: 1; background: linear-gradient(135deg, #6da8e7, #6adbc8); color: white;">AIæ‰©å†™</button>
        <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #ffffff;"
          title="AIé…ç½®">âš™ï¸</button>
      </div>

      <!-- è‡ªåŠ¨æ›´æ–°æç¤º -->
      <div id="autoUpdateIndicator"
        style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
        <span style="display: inline-block; animation: pulse 1s ease-in-out;">âœ“</span> å·²è‡ªåŠ¨æ›´æ–°
      </div>

      <!-- é€šçŸ¥æ¡¥æ¥å™¨ -->
      <script src="../notification-bridge.js"></script>

    </div>
  </div>
  </div>

  <script src="../jsmind-local/jsmind.js"></script>
  <script src="../jsmind-local/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <!-- ä½¿ç”¨ä¸jsMind 0.5.7ç‰ˆæœ¬åŒ¹é…çš„æˆªå›¾æ’ä»¶ -->
  <script src="../jsmind-local/jsmind.screenshot.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script src="plugins/undo_manager.js"></script>




  <script src="icons.js"></script>
  <script type="module" src="mindmap-core.js"></script>
  <script src="mindmap-ui.js"></script>

  <script>
    // toolbar å›¾æ ‡é€‰æ‹©å™¨åˆå§‹åŒ– â€”â€” æ›´ç¨³å¥çš„å®ç°ï¼šä½¿ç”¨ textContentã€ç­‰å¾… availableIcons ä¸ jm å°±ç»ª
    (function () {
      function createToolbarIconGrid() {
        var grid = document.getElementById('iconGridToolbar');
        if (!grid) return;
        grid.innerHTML = '';

        // é¦–ä½ä¸ºæ¸…é™¤å›¾æ ‡æŒ‰é’®ï¼ˆç½‘æ ¼å†…å”¯ä¸€çš„æ¸…é™¤ï¼‰
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'icon-picker-item';
        clearBtn.title = 'æ¸…é™¤å›¾æ ‡';
        clearBtn.style.cssText = 'alpha:0.3;width:40px;height:40px;border:1px dashed #ddd;color:#dbdbdb !important;border-radius:4px;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;';
        clearBtn.textContent = 'ğŸš«';
        clearBtn.onclick = function (e) { e.stopPropagation(); clearIconFromToolbar(); };
        grid.appendChild(clearBtn);

        // å¦‚æœ MWIcons.getGroups å¯ç”¨ï¼ŒæŒ‰ç»„æ¸²æŸ“ï¼ˆå¸¦åˆ†ç»„æ ‡é¢˜ï¼‰
        var groups = (window.MWIcons && typeof window.MWIcons.getGroups === 'function') ? window.MWIcons.getGroups() : null;

        if (groups && Object.keys(groups).length > 0) {
          // åˆ›å»ºåˆ†ç»„å®¹å™¨
          Object.keys(groups).forEach(function (groupKey) {
            var group = groups[groupKey];
            // åˆ†ç»„æ ‡é¢˜
            var header = document.createElement('div');
            header.style.cssText = 'grid-column: 1 / -1; font-size:12px; font-weight:600; color:#333; padding:6px 0 4px 0;';
            header.textContent = (groupKey.charAt(0).toUpperCase() + groupKey.slice(1));
            grid.appendChild(header);

            // åˆ†ç»„å›¾æ ‡ç½‘æ ¼ï¼ˆ7åˆ—å†…ä½¿ç”¨ç›¸åŒæ ·å¼ï¼‰
            group.forEach(function (icon) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'icon-picker-item';
              btn.title = icon.name || '';
              btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
              btn.textContent = icon.emoji || '';
              btn.onclick = function (ev) {
                ev.stopPropagation();
                applyIconToSelection(icon.emoji);
                try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
              };
              btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
              btn.onmouseout = function () { btn.style.background = 'white'; };
              grid.appendChild(btn);
            });
          });
          return;
        }

        // å…¼å®¹å›é€€ï¼šæ‰å¹³åŒ– window.availableIcons æˆ–å…¨å±€ availableIcons
        var icons = (window.availableIcons && window.availableIcons.length) ? window.availableIcons
                  : (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length) ? availableIcons
                  : [];
        if (!icons || icons.length === 0) {
          // æ˜¾ç¤ºå ä½æç¤ºï¼ˆç”¨æˆ·çœ‹åˆ°ä¸ä¼šç©ºç™½ï¼‰
          var ph = document.createElement('div');
          ph.style.cssText = 'grid-column: 1 / -1; color:#6c757d; font-size:12px; padding:6px; text-align:center;';
          ph.textContent = 'å›¾æ ‡åº“åŠ è½½ä¸­...';
          grid.appendChild(ph);
          return;
        }

        icons.forEach(function (icon) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'icon-picker-item';
          btn.title = icon.name || '';
          btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
          btn.textContent = icon.emoji || '';
          btn.onclick = function (ev) {
            ev.stopPropagation();
            applyIconToSelection(icon.emoji);
            // å…³é—­ dropdownï¼ˆBootstrapï¼‰
            try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
          };
          btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
          btn.onmouseout = function () { btn.style.background = 'white'; };
          grid.appendChild(btn);
        });
      }

      // å®‰å…¨çš„åˆå§‹åŒ–ï¼šå¦‚æœ availableIcons å°šæœªå°±ç»ªï¼Œé‡å¤å°è¯•å‡ æ¬¡
      function initWithRetry(attemptsLeft) {
        try {
          if ((window.availableIcons && window.availableIcons.length > 0) || (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length > 0) || attemptsLeft <= 0) {
            createToolbarIconGrid();
            return;
          }
        } catch (e) { /* ignore */ }

        setTimeout(function () { initWithRetry(attemptsLeft - 1); }, 120);
      }

      // å°† emoji åº”ç”¨åˆ°å½“å‰é€‰ä¸­èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      function applyIconToSelection(emoji) {
        if (!window.jm) {
          console.warn('jm æœªåˆå§‹åŒ–ï¼Œæ— æ³•åº”ç”¨å›¾æ ‡');
          return;
        }

        // è·å–å¤šé€‰ï¼ˆæ¡†é€‰ï¼‰æˆ–å•é€‰
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') {
            ids = window.getMultiSelection() || [];
          }
        } catch (e) { ids = []; }

        // è‹¥æ— å¤šé€‰ï¼Œåˆ™å°è¯•ç”¨ jm.get_selected_nodeï¼ˆå•é€‰ï¼‰
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }

        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ 1 ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹');
          return;
        }

        // å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„ topic å‰é¢æ’å…¥ emojiï¼ˆè‹¥å·²å­˜åœ¨è¡¨æƒ…åˆ™æ›¿æ¢ï¼‰
        // ä½¿ç”¨å®½æ¾çš„ emoji å»é™¤æ­£åˆ™ï¼ˆå…¼å®¹æ€§å·®æ—¶ä¹Ÿèƒ½å·¥ä½œï¼‰
        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            // ç§»é™¤å¼€å¤´çš„éå­—æ¯æ•°å­—ä¸éä¸­æ–‡å­—ç¬¦ï¼ˆå¤šåŠæ˜¯ emoji æˆ–ç¬¦å·ï¼‰
            topic = topic.replace(emojiStrip, '').trim();
            var newTopic = (emoji ? (emoji + ' ' + topic) : topic);
            jm.update_node(node.id, newTopic);
          } catch (e) {
            console.warn('åº”ç”¨å›¾æ ‡å¤±è´¥', e);
          }
        });

        // ä¿å­˜å¹¶æç¤º
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²åº”ç”¨å›¾æ ‡'); } catch (e) { }
      }

      // ä»é€‰ä¸­èŠ‚ç‚¹æ¸…é™¤å›¾æ ‡ï¼ˆç›¸å½“äº applyIconToSelection('')ï¼‰
      window.clearIconFromToolbar = function () {
        if (!window.jm) return;
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') ids = window.getMultiSelection() || [];
        } catch (e) { ids = []; }
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }
        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ èŠ‚ç‚¹');
          return;
        }

        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            topic = topic.replace(emojiStrip, '').trim();
            jm.update_node(node.id, topic);
          } catch (e) { console.warn('æ¸…é™¤å›¾æ ‡å¤±è´¥', e); }
        });
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²æ¸…é™¤å›¾æ ‡'); } catch (e) { }
      };

      // åˆå§‹åŒ–å…¥å£ï¼šæœ€å¤šé‡è¯• 8 æ¬¡ï¼ˆæ¯æ¬¡ 120msï¼‰
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function () { initWithRetry(8); }, 120);
      } else {
        document.addEventListener('DOMContentLoaded', function () { setTimeout(function () { initWithRetry(8); }, 120); });
      }

      // åœ¨ jm åˆå§‹åŒ–åå†æ‰§è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ race
      window.MW_scheduleOnce && window.MW_scheduleOnce('initToolbarIconGrid', function () {
        initWithRetry(4);
      }, 300);
    })();
  </script>

</body>

</html>