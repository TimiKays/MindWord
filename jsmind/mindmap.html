<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/style/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    // é¢„åŠ è½½AIæ¨¡å—
    import { AIExpander } from './ai-expander.js';
    import { AIConfigManager } from './ai-config.js';
    // å°†ç±»å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    window.AIExpander = AIExpander;
    window.AIConfigManager = AIConfigManager;
  </script>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      flex: 1;
      display: flex;
      height: calc(100vh - 60px);
    }

    #fullScreenMindmap {
      width: 70%;
      height: 100%;
      position: relative;
      background: white;
      overflow: auto;
      /* æ·»åŠ æ»šåŠ¨æ¡æ”¯æŒ */
    }

    /* jsmind èŠ‚ç‚¹å®¹å™¨æ»šåŠ¨æ”¯æŒ */
    #fullScreenMindmap .jsmind-inner {
      overflow: auto !important;
    }

    /* ç¡®ä¿æ€ç»´å¯¼å›¾èŠ‚ç‚¹å®¹å™¨å¯ä»¥æ»šåŠ¨ */
    #fullScreenMindmap .jmnodes {
      overflow: visible !important;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    #fullScreenMindmap::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #fullScreenMindmap::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #fullScreenMindmap::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    #fullScreenMindmap::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    #nodeDetails {
      width: 30%;
      height: 100%;
      padding: 20px;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      background: #f8f9fa;
    }

    #notesOverlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px;
      max-width: 250px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      display: none;
      font-size: 12px;
      z-index: 100;
    }

    .node-info {
      background: white;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 500px;
    }

    .notes-section {
      background: white;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .note-item {
      padding: 10px;
      border-left: 3px solid #007bff;
      background: #f8f9fa;
      margin-bottom: 10px;
      border-radius: 0 4px 4px 0;
    }

    .note-item h5 {
      margin: 0 0 5px 0;
      color: #fad503;
      font-size: 14px;
    }

    .note-item p {
      margin: 0;
      color: #495057;
      font-size: 12px;
      line-height: 1.4;
    }

    /* è‡ªåŠ¨æ›´æ–°åŠ¨ç”» */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auto-update-show {
      animation: fadeIn 0.3s ease-in-out;
    }
  /* æ¡†é€‰çŸ©å½¢ä¸å¤šé€‰é«˜äº® */
  #selectionRect {
    position: absolute;
    border: 1px dashed #4c9aff;
    background: rgba(76, 154, 255, 0.15);
    pointer-events: none;
    display: none;
    z-index: 999;
  }
  /* è¢«å¤šé€‰çš„èŠ‚ç‚¹é«˜äº®ï¼šå†…å¤–æè¾¹ + æ·¡è“åº•è‰² + æé«˜å±‚çº§ï¼Œæ˜æ˜¾å¯è§ */
  #fullScreenMindmap .jmnode.multi-selected,
  #fullScreenMindmap jmnodes jmnode.multi-selected,
  jmnodes jmnode.multi-selected {
    position: relative !important;
    background-color: rgba(76, 154, 255, 0.5) !important;
    background: rgba(76, 154, 255, 0.5) !important;
    box-shadow:
      0 0 0 4px #4c9aff !important,         /* å¤–æè¾¹ */
      inset 0 0 0 3px #4c9aff !important,   /* å†…æè¾¹ */
      0 6px 20px rgba(76, 154, 255, 0.6) !important, /* å‘å…‰æ•ˆæœ */
      0 0 30px rgba(76, 154, 255, 0.4) !important; /* é¢å¤–å…‰æ™• */
    border-radius: 8px !important;
    z-index: 999 !important;
    transform: scale(1.08) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    animation: pulse 1.2s infinite ease-in-out !important;
    border: 3px solid #4c9aff !important;
    color: #fff !important;
    font-weight: bold !important;
  }

  /* ç¡®ä¿å¤šé€‰èŠ‚ç‚¹åœ¨æ‚¬åœæ—¶ä»ç„¶ä¿æŒé«˜äº® */
  #fullScreenMindmap .jmnode.multi-selected:hover,
  #fullScreenMindmap jmnodes jmnode.multi-selected:hover,
  jmnodes jmnode.multi-selected:hover {
    background-color: rgba(76, 154, 255, 0.7) !important;
    background: rgba(76, 154, 255, 0.7) !important;
    box-shadow:
      0 0 0 5px #4c9aff !important,
      inset 0 0 0 4px #4c9aff !important,
      0 8px 30px rgba(76, 154, 255, 0.8) !important,
      0 0 40px rgba(76, 154, 255, 0.5) !important;
    transform: scale(1.12) !important;
    border: 4px solid #4c9aff !important;
  }

  /* é€‰ä¸­èŠ‚ç‚¹çš„è„‰å†²åŠ¨ç”» - æ›´æ˜æ˜¾çš„å‘¼å¸æ•ˆæœ */
  @keyframes pulse {
    0% {
      box-shadow: 
        0 0 0 4px #4c9aff,
        inset 0 0 0 3px #4c9aff,
        0 6px 20px rgba(76, 154, 255, 0.6),
        0 0 30px rgba(76, 154, 255, 0.4);
      transform: scale(1.08);
      background-color: rgba(76, 154, 255, 0.5);
    }
    25% {
      box-shadow: 
        0 0 0 5px #4c9aff,
        inset 0 0 0 4px #4c9aff,
        0 8px 30px rgba(76, 154, 255, 0.8),
        0 0 40px rgba(76, 154, 255, 0.5);
      transform: scale(1.1);
      background-color: rgba(76, 154, 255, 0.6);
    }
    50% {
      box-shadow: 
        0 0 0 6px #4c9aff,
        inset 0 0 0 5px #4c9aff,
        0 10px 40px rgba(76, 154, 255, 1),
        0 0 50px rgba(76, 154, 255, 0.6);
      transform: scale(1.12);
      background-color: rgba(76, 154, 255, 0.7);
    }
    75% {
      box-shadow: 
        0 0 0 5px #4c9aff,
        inset 0 0 0 4px #4c9aff,
        0 8px 30px rgba(76, 154, 255, 0.8),
        0 0 40px rgba(76, 154, 255, 0.5);
      transform: scale(1.1);
      background-color: rgba(76, 154, 255, 0.6);
    }
    100% {
      box-shadow: 
        0 0 0 4px #4c9aff,
        inset 0 0 0 3px #4c9aff,
        0 6px 20px rgba(76, 154, 255, 0.6),
        0 0 30px rgba(76, 154, 255, 0.4);
      transform: scale(1.08);
      background-color: rgba(76, 154, 255, 0.5);
    }
  }

  /* é¢å¤–çš„æ ·å¼è¦†ç›– - ç¡®ä¿æˆ‘ä»¬çš„å¤šé€‰æ ·å¼ä¼˜å…ˆçº§æœ€é«˜ */
  /* åªè¦†ç›–jsMindçš„å¤šé€‰å†²çªï¼Œä¿ç•™å•é€‰æ ·å¼ */
  /* æ³¨æ„ï¼šå•é€‰èŠ‚ç‚¹åªæœ‰ .selected ç±»ï¼Œå¤šé€‰èŠ‚ç‚¹åŒæ—¶æœ‰ .selected å’Œ .multi-selected ç±» */
  
  /* æ¢å¤å•é€‰èŠ‚ç‚¹çš„é»˜è®¤æ ·å¼ï¼ˆåªæœ‰.selectedç±»ï¼Œæ²¡æœ‰.multi-selectedç±»ï¼‰ */
  html body #fullScreenMindmap .jsmind-inner jmnodes jmnode.selected:not(.multi-selected),
  html body .jsmind-inner jmnodes jmnode.selected:not(.multi-selected) {
    background-color: #11f !important;
    color: #fff !important;
    box-shadow: 2px 2px 8px #000 !important;
  }
  
  /* å¤šé€‰èŠ‚ç‚¹çš„æ ·å¼é‡ç½®ï¼ˆåŒæ—¶æœ‰.selectedå’Œ.multi-selectedç±»ï¼‰ */
  #fullScreenMindmap .jsmind-inner jmnodes jmnode.selected.multi-selected,
  .jsmind-inner jmnodes jmnode.selected.multi-selected {
    background-color: inherit !important;
    border: inherit !important;
    box-shadow: inherit !important;
  }

  /* æœ€é«˜ä¼˜å…ˆçº§çš„å¤šé€‰æ ·å¼ */
  html body #fullScreenMindmap .jsmind-inner jmnodes jmnode.multi-selected,
  html body .jsmind-inner jmnodes jmnode.multi-selected {
    background-color: rgba(76, 154, 255, 0.8) !important;
    border: 4px solid #4c9aff !important;
    transform: scale(1.1) !important;
    box-shadow: 0 0 0 4px #4c9aff, inset 0 0 0 3px #4c9aff, 0 6px 20px rgba(76, 154, 255, 0.6), 0 0 30px rgba(76, 154, 255, 0.4) !important;
    animation: pulse 1.2s infinite ease-in-out !important;
    color: #fff !important;
    font-weight: bold !important;
    z-index: 999 !important;
  }
  </style>
</head>

<body>
  <div class="toolbar">
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <div id="batchOperations" style="display: none; margin-right: 20px; padding: 5px 10px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; margin-right: 10px;">å·²é€‰ä¸­ <span id="selectedCount">0</span> ä¸ªèŠ‚ç‚¹</span>
      <button class="btn" onclick="batchDelete()" style="background: #dc3545; margin-right: 5px;" title="åˆ é™¤é€‰ä¸­çš„èŠ‚ç‚¹">åˆ é™¤</button>
      <button class="btn" onclick="batchMove()" style="background: #28a745; margin-right: 5px;" title="ç§»åŠ¨é€‰ä¸­çš„èŠ‚ç‚¹">ç§»åŠ¨</button>
      <button class="btn" onclick="clearMultiSelection()" style="background: #6c757d; margin-right: 5px;" title="æ¸…é™¤é€‰æ‹©">æ¸…é™¤</button>
      <button class="btn" onclick="debugMultiSelect()" style="background: #17a2b8;" title="è°ƒè¯•å¤šé€‰æ ·å¼">ğŸ” è°ƒè¯•</button>
    </div>

    <button class="btn" onclick="exportData()">æŸ¥çœ‹JSON</button>
    <button class="btn btn-success" onclick="downloadMindmap()">ä¸‹è½½å›¾ç‰‡</button>

  </div>

  <div class="main-container">
    <div id="fullScreenMindmap"></div>

    <div id="nodeDetails">


      <div id="nodeInfo">

      </div>


      <div class="form-group">
        <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
        <input type="text" id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜...">
      </div>

      <div class="form-group">
        <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
        <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn" onclick="expandWithAI()" style="flex: 1; background: #6f42c1;">
          AIæ‰©å†™
        </button>
        <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #6c757d;"
          title="AIé…ç½®">âš™ï¸</button>
      </div>

      <!-- è‡ªåŠ¨æ›´æ–°æç¤º -->
      <div id="autoUpdateIndicator"
        style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
        <span style="display: inline-block; animation: pulse 1s ease-in-out;">âœ“</span> å·²è‡ªåŠ¨æ›´æ–°
      </div>

      <!-- é€šçŸ¥æ¡¥æ¥å™¨ -->
      <script src="../notification-bridge.js"></script>
      <script>
        // AIæ‰©å†™å‡½æ•°
        function expandWithAI() {
          try {
            const selectedNode = jm.get_selected_node();
            if (!selectedNode) {
              showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
              return;
            }

            if (window.AIExpander) {
              window.AIExpander.expandNode(selectedNode.id, jm);
            } else {
              showError('AIæ‰©å†™æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
          } catch (e) {
            console.error('AIæ‰©å†™å‡ºé”™:', e);
            showError('AIæ‰©å†™å‡ºé”™: ' + e.message);
          }
        }
      </script>
    </div>
  </div>
  </div>

  </div>
  </div>

  <!-- é¼ æ ‡æ‚¬åœå¤‡æ³¨å±‚ -->
  <div id="notesOverlay">
    <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">èŠ‚ç‚¹å¤‡æ³¨</div>
    <div id="hoverNote"></div>
  </div>

  <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.js"></script>
  <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <script src="https://unpkg.com/jsmind@0.8.7/es6/jsmind.screenshot.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script>
    let jm = null;
    let currentNodeTree = null;

    // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
    function initMindmap() {
      if (jm) {
        loadNodeTree(); // ä¸ä¼ å‚æ•°ï¼Œè®©å‡½æ•°è‡ªå·±ä»localStorageè·å–
        return;
      }

      const options = {
        container: 'fullScreenMindmap',           // å®¹å™¨IDï¼Œå¿…å¡«
        editable: true,                         // æ˜¯å¦å¯ç¼–è¾‘ï¼Œé»˜è®¤ä¸ºtrue
        theme: 'primary',                       // ä¸»é¢˜ï¼šprimary|success|info|warning|danger|greensea|nephrite|belizehole|wisteria|asphalt
        mode: 'side',                           // æ˜¾ç¤ºæ¨¡å¼ï¼šfull|sideå³ä¾§
        support_html: true,                     // èŠ‚ç‚¹æ˜¯å¦æ”¯æŒHTMLï¼Œé»˜è®¤ä¸ºtrue
        view: {
          engine: 'svg',                   // æ€ç»´å¯¼å›¾å„èŠ‚ç‚¹ä¹‹é—´çº¿æ¡çš„ç»˜åˆ¶å¼•æ“ï¼Œcanvas|svg
          hmargin: 100,                       // æ°´å¹³è¾¹è·
          vmargin: 50,                        // å‚ç›´è¾¹è·
          line_width: 2,                      // è¿æ¥çº¿å®½åº¦
          line_color: '#555',                 // è¿æ¥çº¿é¢œè‰²
          expander_style: 'number',           // å±•å¼€å™¨æ ·å¼ï¼šnumber|circle|square
          expander_color: '#000',             // å±•å¼€å™¨é¢œè‰²
          expander_size: 12,                  // å±•å¼€å™¨å¤§å°
          node_overflow: 'wrap',            // æ–‡å­—è¿‡é•¿å¤„ç†ï¼šhidden|wrap
          zoom: {
            min: 0.1, // æœ€å°ç¼©æ”¾æ¯”ä¾‹
            max: 5.0, // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
            step: 0.1, // ç¼©æ”¾æ­¥é•¿
            mask_key: 4096 // Ctrl Key å¯ç”¨ç¼©æ”¾æ“ä½œçš„åŠŸèƒ½é”®
          },
          draggable: false,                    // ç¦ç”¨å†…ç½®ç”»å¸ƒæ‹–æ‹½ï¼›æ”¹ä¸ºæŒ‰ä½ç©ºæ ¼æ—¶è‡ªå®šä¹‰æ‹–æ‹½
          hide_scrollbars_when_draggable: false, // æ‹–æ‹½æ—¶æ˜¯å¦éšè—æ»šåŠ¨æ¡
          enable_mouse_wheel: false,          // ç¦ç”¨jsmindçš„é¼ æ ‡æ»šè½®å¤„ç†ï¼Œè®©æµè§ˆå™¨å¤„ç†æ»šåŠ¨
          mouse_wheel_zoom: false             // ç¦ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾
        },
        layout: {
          hspace: 30,                         // èŠ‚ç‚¹æ°´å¹³é—´è·
          vspace: 20,                         // èŠ‚ç‚¹å‚ç›´é—´è·
          pspace: 13,                         // èŠ‚ç‚¹ä¸è¿æ¥çº¿çš„é—´è·
          cousin_space: 10,                   // ç›¸é‚»èŠ‚ç‚¹å­èŠ‚ç‚¹ä¹‹é—´çš„é¢å¤–å‚ç›´ç©ºé—´

          // å¸ƒå±€ç®—æ³•ç›¸å…³
          depth_space: 15,                    // å±‚çº§é—´è·

          // èŠ‚ç‚¹å°ºå¯¸ç›¸å…³
          node_width: 100,                    // èŠ‚ç‚¹é»˜è®¤å®½åº¦
          node_height: 50,                    // èŠ‚ç‚¹é»˜è®¤é«˜åº¦

          // è¿æ¥çº¿æ ·å¼
          line_type: 'curve',              // è¿æ¥çº¿ç±»å‹ï¼šstraight|curve|polyline
          line_radius: 5,                     // è¿æ¥çº¿åœ†è§’åŠå¾„
          line_width: 2,                      // è¿æ¥çº¿å®½åº¦
          line_color: '#555'                  // è¿æ¥çº¿é¢œè‰²
        },
        shortcut: {
          enable: true,                         // æ˜¯å¦å¯ç”¨å¿«æ·é”®
          handles: {},                        // è‡ªå®šä¹‰å¤„ç†å‡½æ•°

          // å¿«æ·é”®æ˜ å°„
          mapping: {
            addchild: 9,                    // Tab - æ·»åŠ å­èŠ‚ç‚¹
            addbrother: 13,                 // Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
            editnode: 113,                  // F2 - ç¼–è¾‘èŠ‚ç‚¹
            delnode: 46,                    // Delete - åˆ é™¤èŠ‚ç‚¹
            toggle: 32,                     // Space - å±•å¼€/æŠ˜å èŠ‚ç‚¹

            // åˆ‡æ¢é€‰ä¸­
            left: 37,                       // é€‰ä¸­å·¦ä¾§èŠ‚ç‚¹
            up: 38,                         // 
            right: 39,                      // 
            down: 40,                       // 

            // ä¸‹é¢çš„éƒ½æ˜¯AIå¹»è§‰// å…¶ä»–å¸¸ç”¨å¿«æ·é”®
            // copy: 67,                       // Ctrl+C - å¤åˆ¶èŠ‚ç‚¹
            // paste: 86,                      // Ctrl+V - ç²˜è´´èŠ‚ç‚¹
            // cut: 88,                        // Ctrl+X - å‰ªåˆ‡èŠ‚ç‚¹
            // undo: 90,                       // Ctrl+Z - æ’¤é”€
            // redo: 89,                       // Ctrl+Y - é‡åš

            // // è§†å›¾æ“ä½œ
            // zoomin: 187,                    // Ctrl++ - æ”¾å¤§
            // zoomout: 189,                   // Ctrl+- - ç¼©å°
            // zoomfit: 48,                    // Ctrl+0 - é€‚åº”çª—å£

          }
        },

        // èŠ‚ç‚¹é»˜è®¤æ ·å¼
        node: {
          background_color: '#fff',           // èƒŒæ™¯é¢œè‰²
          foreground_color: '#333',           // æ–‡å­—é¢œè‰²
          border_color: '#ccc',               // è¾¹æ¡†é¢œè‰²
          border_width: 1,                    // è¾¹æ¡†å®½åº¦
          font_size: 14,                      // å­—ä½“å¤§å°
          font_family: 'Arial, sans-serif',   // å­—ä½“æ—
          font_weight: 'normal',                // å­—ä½“ç²—ç»†
          text_align: 'center',               // æ–‡å­—å¯¹é½æ–¹å¼
          line_height: 1.5,                   // è¡Œé«˜
          padding: 5,                         // å†…è¾¹è·
          border_radius: 5,                   // åœ†è§’åŠå¾„

          // èŠ‚ç‚¹é˜´å½±
          shadow: true,                       // æ˜¯å¦æ˜¾ç¤ºé˜´å½±
          shadow_color: '#000',               // é˜´å½±é¢œè‰²
          shadow_blur: 3,                     // é˜´å½±æ¨¡ç³Šåº¦
          shadow_offset_x: 1,                 // é˜´å½±æ°´å¹³åç§»
          shadow_offset_y: 1                  // é˜´å½±å‚ç›´åç§»
        },



        // äº‹ä»¶ç›‘å¬
        event_handles: {
          // èŠ‚ç‚¹äº‹ä»¶
          show: function (node) {
            // èŠ‚ç‚¹æ˜¾ç¤ºäº‹ä»¶
          },
          edit: function (node) {
            // èŠ‚ç‚¹ç¼–è¾‘äº‹ä»¶
          },
          select: function (node) {
            // èŠ‚ç‚¹é€‰æ‹©äº‹ä»¶
          },
          unselect: function (node) {
            // èŠ‚ç‚¹å–æ¶ˆé€‰æ‹©äº‹ä»¶
          },
          expand: function (node) {
            // èŠ‚ç‚¹å±•å¼€äº‹ä»¶
          },
          collapse: function (node) {
            // èŠ‚ç‚¹æŠ˜å äº‹ä»¶
          },
          add: function (node) {
            // èŠ‚ç‚¹æ·»åŠ äº‹ä»¶
          },
          remove: function (node) {
            // èŠ‚ç‚¹åˆ é™¤äº‹ä»¶
          },
          move: function (node) {
            // èŠ‚ç‚¹ç§»åŠ¨äº‹ä»¶
          },
          resize: function (node) {
            // èŠ‚ç‚¹å¤§å°æ”¹å˜äº‹ä»¶
          },

          // ç”»å¸ƒäº‹ä»¶
          mousedown: function (e) {
            // ç”»å¸ƒé¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
          },
          mousemove: function (e) {
            // ç”»å¸ƒé¼ æ ‡ç§»åŠ¨äº‹ä»¶
          },
          mouseup: function (e) {
            // ç”»å¸ƒé¼ æ ‡é‡Šæ”¾äº‹ä»¶
          },
          click: function (e) {
            // ç”»å¸ƒç‚¹å‡»äº‹ä»¶
          },
          dblclick: function (e) {
            // ç”»å¸ƒåŒå‡»äº‹ä»¶
          },
          contextmenu: function (e) {
            // ç”»å¸ƒå³é”®èœå•äº‹ä»¶
          },

          // é”®ç›˜äº‹ä»¶
          keydown: function (e) {
            // é”®ç›˜æŒ‰ä¸‹äº‹ä»¶
          },
          keyup: function (e) {
            // é”®ç›˜é‡Šæ”¾äº‹ä»¶
          }
        },

        // å·¥å…·æ é…ç½®
        toolbar: {
          enable: true,                       // æ˜¯å¦å¯ç”¨å·¥å…·æ 
          position: 'left',                    // å·¥å…·æ ä½ç½®ï¼štop|bottom|left|right
          buttons: [                          // å·¥å…·æ æŒ‰é’®
            'addchild',                     // æ·»åŠ å­èŠ‚ç‚¹
            'addbrother',                   // æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
            'editnode',                     // ç¼–è¾‘èŠ‚ç‚¹
            'delnode',                      // åˆ é™¤èŠ‚ç‚¹
            'toggle',                       // å±•å¼€/æŠ˜å 
            'zoomin',                       // æ”¾å¤§
            'zoomout',                      // ç¼©å°
            'zoomfit',                      // é€‚åº”çª—å£
            'expandall',                    // å±•å¼€å…¨éƒ¨
            'collapseall',                   // æŠ˜å å…¨éƒ¨
            'reset'                         // é‡ç½®è§†å›¾
          ]
        },

        // èœå•é…ç½®
        contextmenu: {
          enable: true,                       // æ˜¯å¦å¯ç”¨å³é”®èœå•
          items: [                            // èœå•é¡¹
            'addchild',                     // æ·»åŠ å­èŠ‚ç‚¹
            'addbrother',                   // æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
            'editnode',                     // ç¼–è¾‘èŠ‚ç‚¹
            'delnode',                      // åˆ é™¤èŠ‚ç‚¹
            'toggle',                       // å±•å¼€/æŠ˜å 
            'moveup',                       // ä¸Šç§»èŠ‚ç‚¹
            'movedown',                     // ä¸‹ç§»èŠ‚ç‚¹
            'movetop',                      // ç§»åŠ¨åˆ°é¡¶éƒ¨
            'movebottom'                    // ç§»åŠ¨åˆ°åº•éƒ¨
          ]
        }
      };

      jm = new jsMind(options);

      // å°†jsMindå®ä¾‹èµ‹å€¼ç»™windowï¼Œä¾›å…¶ä»–æ¨¡å—è®¿é—®
      window.jm = jm;

      // é…ç½®æ€ç»´å¯¼å›¾å®¹å™¨çš„æ»šåŠ¨è¡Œä¸º
      setupMindmapScrolling();

      // åŒ…è£…æ ¸å¿ƒAPIä»¥æ•è·æ–°å¢/ç§»åŠ¨èŠ‚ç‚¹ï¼Œåš"ç±»å‹å¯¹é½"å¹¶ä¿å­˜
      (function wrapMindAPIs() {
        // æ–°å¢èŠ‚ç‚¹åŒ…è£…
        const __origAdd = jm.add_node && jm.add_node.bind(jm);
        if (__origAdd) {
          jm.add_node = function (parent_node, nodeid, topic, data) {
            const ret = __origAdd(parent_node, nodeid, topic, data);
            try {
              const id = nodeid || (ret && ret.id);
              if (id && typeof applySiblingOrParentType === 'function') {
                applySiblingOrParentType(id);
              }
              // è‹¥çˆ¶èŠ‚ç‚¹ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨
              try {
                const pid = (typeof parent_node === 'string' ? parent_node : (parent_node && parent_node.id))
                  || (id && jm.get_node(id) && jm.get_node(id).parent && jm.get_node(id).parent.id);
                if (pid) {
                  const p = jm.get_node(pid);
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(id, p);
                  }
                }
              } catch (e2) {
                // å¿½ç•¥å½’ä¸€åˆ—è¡¨å¤„ç†é”™è¯¯
              }
              if (typeof debouncedSave === 'function') debouncedSave();
            } catch (e) {
              // å¿½ç•¥åç½®å¤„ç†é”™è¯¯
            }
            return ret;
          };
        }
        // ç§»åŠ¨èŠ‚ç‚¹åŒ…è£…
        const __origMove = jm.move_node && jm.move_node.bind(jm);
        if (__origMove) {
          jm.move_node = function (nodeid, beforeid, parentid, direction) {
            const ret = __origMove(nodeid, beforeid, parentid, direction);
            try {
              if (nodeid && typeof applySiblingOrParentType === 'function') {
                applySiblingOrParentType(nodeid);
              }
              // è‹¥æ–°çˆ¶èŠ‚ç‚¹ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨
              try {
                if (parentid) {
                  const p = jm.get_node(parentid);
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(nodeid, p);
                  }
                }
              } catch (e2) {
                // å¿½ç•¥å½’ä¸€åˆ—è¡¨å¤„ç†é”™è¯¯
              }
              if (typeof debouncedSave === 'function') debouncedSave();
            } catch (e) {
              // å¿½ç•¥åç½®å¤„ç†é”™è¯¯
            }
            return ret;
          };
        }
      })();

      // åˆå§‹åŒ–å®ŒæˆååŠ è½½æ•°æ®
      loadNodeTree();

      // ç»‘å®šäº‹ä»¶
      jm.add_event_listener(function (type, data) {
        if (type === jsMind.event_type.select) {
          const selectedNodeid = jm.get_selected_node();
          if (selectedNodeid) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºæ‰¹é‡ç§»åŠ¨æ¨¡å¼
            if (window.__batchMoving && window.__batchMoveIds && window.__batchMoveIds.length > 0) {
              // æ‰¹é‡ç§»åŠ¨æ¨¡å¼ï¼šæ‰§è¡Œç§»åŠ¨æ“ä½œ
              try {
                const targetNodeId = selectedNodeid;
                const idsToMove = [...window.__batchMoveIds];
                
                // å–æ¶ˆæ‰¹é‡ç§»åŠ¨æ¨¡å¼
                if (window.cancelBatchMove) {
                  window.cancelBatchMove();
                }
                
                // æ‰§è¡Œæ‰¹é‡ç§»åŠ¨
                let anchorId = targetNodeId;
                for (const nodeId of idsToMove) {
                  if (!nodeId || nodeId === targetNodeId) continue;
                  try {
                    jm.move_node(nodeId, anchorId, jm.get_node(targetNodeId).parent.id);
                    anchorId = nodeId;
                  } catch (e) {
                    console.warn('èŠ‚ç‚¹ç§»åŠ¨å¤±è´¥:', nodeId, e);
                  }
                }
                
                showSuccess(`æˆåŠŸç§»åŠ¨ ${idsToMove.length} ä¸ªèŠ‚ç‚¹`);
              } catch (e) {
                console.error('æ‰¹é‡ç§»åŠ¨å¤±è´¥:', e);
                showError('æ‰¹é‡ç§»åŠ¨å¤±è´¥');
              }
            } else {
              // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
              showNodeDetails(selectedNodeid);
            }
          }
        }
      });

    }

    // é…ç½®æ€ç»´å¯¼å›¾å®¹å™¨çš„æ»šåŠ¨è¡Œä¸º
    function setupMindmapScrolling() {
      if (!jm) return;

      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;

      // ç­‰å¾…jsmindå®Œå…¨åˆå§‹åŒ–
      setTimeout(() => {
        // æŸ¥æ‰¾jsmindåˆ›å»ºçš„jmnodeså®¹å™¨
        const jmnodes = container.querySelector('.jmnodes');
        const jsmindInner = container.querySelector('.jsmind-inner');

        if (jmnodes) {
          // ç¡®ä¿jmnodeså¯ä»¥è¶…å‡ºå®¹å™¨è¾¹ç•Œ
          jmnodes.style.overflow = 'visible';
          jmnodes.style.position = 'relative';
        }

        if (jsmindInner) {
          // ç¡®ä¿å†…éƒ¨å®¹å™¨æœ‰æ»šåŠ¨æ¡
          jsmindInner.style.overflow = 'auto';
          jsmindInner.style.width = '100%';
          jsmindInner.style.height = '100%';
        }

        // æ£€æŸ¥æ»šåŠ¨çŠ¶æ€
        const checkScrollStatus = () => {
          console.log('æ»šåŠ¨çŠ¶æ€æ£€æŸ¥:', {
            scrollHeight: container.scrollHeight,
            clientHeight: container.clientHeight,
            scrollWidth: container.scrollWidth,
            clientWidth: container.clientWidth,
            scrollTop: container.scrollTop,
            scrollLeft: container.scrollLeft
          });
        };

        // åˆå§‹æ£€æŸ¥
        checkScrollStatus();

        // å»¶è¿Ÿå†æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿jsmindå®Œå…¨æ¸²æŸ“
        setTimeout(checkScrollStatus, 1000);
        setTimeout(checkScrollStatus, 2000);

        console.log('æ€ç»´å¯¼å›¾æ»šåŠ¨åŠŸèƒ½å·²é…ç½®ï¼Œæµè§ˆå™¨å°†å¤„ç†æ»šåŠ¨');
      }, 500); // å»¶è¿Ÿ500msç¡®ä¿jsmindå®ŒæˆDOMåˆ›å»º
    }

    // åŠ è½½NodeTreeæ•°æ®
    function loadNodeTree(nodeTreeData) {
      if (!jm) return;

      // å¦‚æœæ²¡æœ‰æä¾›æ•°æ®ï¼Œå°è¯•ä»localStorageè·å–
      if (!nodeTreeData) {
        const cachedData = localStorage.getItem('mindword_nodetree_data');
        if (cachedData) {
          try {
            nodeTreeData = JSON.parse(cachedData);
          } catch (error) {
            nodeTreeData = getDefaultNodeTree();
          }
        } else {
          nodeTreeData = getDefaultNodeTree();
        }
      }

      try {
        // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
        if (typeof nodeTreeData === 'string') {
          nodeTreeData = JSON.parse(nodeTreeData);
        }

        jm.show(nodeTreeData);
        currentNodeTree = nodeTreeData;

        // å»¶è¿Ÿæ‰§è¡ŒDOMæ“ä½œï¼Œç¡®ä¿å…ƒç´ å·²åŠ è½½
        setTimeout(() => {
          refreshAllNotesDisplay();

          // è‡ªåŠ¨é€‰æ‹©æ ¹èŠ‚ç‚¹å¹¶æ˜¾ç¤ºè¯¦æƒ…
          const rootNode = jm.get_root();
          if (rootNode) {
            jm.select_node(rootNode.id);
            showNodeDetails(rootNode);
          }
        }, 100);
      } catch (error) {
        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½é»˜è®¤æ•°æ®
        try {
          jm.show(getDefaultNodeTree());
        } catch (defaultError) {
          console.error('åŠ è½½é»˜è®¤æ•°æ®å¤±è´¥:', defaultError);
        }
      }
    }

    // è·å–å½“å‰NodeTree
    function getCurrentNodeTree() {
      return jm ? jm.get_data() : null;
    }

    // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
    function showNodeDetails(node) {
      // å…è®¸ä¼ å…¥ id æˆ– node å¯¹è±¡ï¼Œç»Ÿä¸€ä¸º node
      if (node && typeof node === 'string') {
        node = jm && jm.get_node ? jm.get_node(node) : node;
      }
      if (!node) return;

      const nodeInfo = document.getElementById('nodeInfo');
      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');
      if (!nodeInfo || !nodeTopic || !nodeNotes) return;

      // å®‰å…¨å­—æ®µè¯»å–
      const level = (node.level != null) ? node.level
        : (node.data && node.data.level != null ? node.data.level : 0);
      const ordered = (node.ordered != null) ? node.ordered
        : (node.data && node.data.ordered != null ? node.data.ordered : undefined);
      const marker = (node.marker != null) ? node.marker
        : (node.data && node.data.marker != null ? node.data.marker : undefined);
      const type = (node.type != null) ? node.type
        : (node.data && node.data.type != null ? node.data.type : undefined);
      const notes = (node.notes != null) ? node.notes
        : (node.data && node.data.notes != null ? node.data.notes : '');

      // æ„é€ è°ƒè¯•å¿«ç…§ï¼ˆé¿å…å¾ªç¯å¼•ç”¨ï¼‰
      const snapshot = {
        id: node.id,
        topic: node.topic || '',
        type: type,
        level: level,
        ordered: ordered,
        marker: marker,
        notes: notes,
        parentId: node.parent && node.parent.id ? node.parent.id : null,
        childrenIds: Array.isArray(node.children) ? node.children.map(c => c && c.id).filter(Boolean) : []
      };


      nodeTopic.value = snapshot.topic || '';
      nodeNotes.value = notes || '';

      // è®¾ç½®è‡ªåŠ¨æ›´æ–°äº‹ä»¶ç›‘å¬
      setupAutoUpdate();
    }

    // è®¾ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
    function setupAutoUpdate() {
      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');

      if (!nodeTopic || !nodeNotes) return;

      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬é¿å…é‡å¤
      nodeTopic.removeEventListener('input', handleAutoUpdate);
      nodeNotes.removeEventListener('input', handleAutoUpdate);

      // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬
      nodeTopic.addEventListener('input', handleAutoUpdate);
      nodeNotes.addEventListener('input', handleAutoUpdate);
    }

    // å¤„ç†è‡ªåŠ¨æ›´æ–°
    let autoUpdateTimer = null;
    function handleAutoUpdate() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (autoUpdateTimer) {
        clearTimeout(autoUpdateTimer);
      }

      // å»¶è¿Ÿ500msæ‰§è¡Œæ›´æ–°ï¼Œé¿å…é¢‘ç¹æ›´æ–°
      autoUpdateTimer = setTimeout(() => {
        const selected = jm.get_selected_node();
        if (!selected) return;

        const nodeTopic = document.getElementById('nodeTopic');
        const nodeNotes = document.getElementById('nodeNotes');

        const newTopic = nodeTopic.value.trim();
        const newNotes = nodeNotes.value.trim();

        // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        let hasChanges = false;

        if (newTopic !== selected.topic) {
          jm.update_node(selected.id, newTopic);
          hasChanges = true;
        }

        if (newNotes !== (selected.notes || '')) {
          selected.data.notes = newNotes;
          hasChanges = true;
        }

        if (hasChanges) {
          refreshAllNotesDisplay();
          saveToLocalStorage();
          showAutoUpdateIndicator();
        }
      }, 500);
    }

    // æ˜¾ç¤ºè‡ªåŠ¨æ›´æ–°æç¤º
    function showAutoUpdateIndicator() {
      const indicator = document.getElementById('autoUpdateIndicator');
      if (!indicator) return;

      indicator.style.display = 'block';
      indicator.classList.add('auto-update-show');

      // 2ç§’åéšè—æç¤º
      setTimeout(() => {
        indicator.style.display = 'none';
        indicator.classList.remove('auto-update-show');
      }, 2000);
    }

    // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨
    function updateNodeNotes() {
      if (!jm) return;

      const selected = jm.get_selected_node();
      if (!selected) {
        showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
        return;
      }

      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');

      const newTopic = nodeTopic.value.trim();
      const newNotes = nodeNotes.value.trim();

      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜åŒ–éœ€è¦æ›´æ–°
      let hasChanges = false;

      // æ›´æ–°èŠ‚ç‚¹ä¸»é¢˜ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
      if (newTopic !== selected.topic) {
        jm.update_node(selected.id, newTopic);
        hasChanges = true;
      }

      // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
      if (newNotes !== (selected.notes || '')) {
        // ç›´æ¥æ›´æ–°æ ¹çº§åˆ«çš„noteså­—æ®µï¼ˆä¸å…¶ä»–ä»£ç ä¿æŒä¸€è‡´ï¼‰
        selected.data.notes = newNotes;
        hasChanges = true;
      }

      // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œæç¤ºç”¨æˆ·
      if (!hasChanges) {
        showInfo('èŠ‚ç‚¹å†…å®¹æ²¡æœ‰å˜åŒ–ï¼');
        return;
      }

      refreshAllNotesDisplay();

      // // åŒæ­¥åˆ°çˆ¶é¡µé¢
      // if (window.parent !== window) {
      //     window.parent.postMessage({
      //         type: 'mindmapUpdated',
      //         data: jm.get_data()
      //     }, '*');
      // }

      // ä¿å­˜åˆ°localStorageå¹¶åŒæ­¥
      saveToLocalStorage();

      showSuccess('èŠ‚ç‚¹æ›´æ–°æˆåŠŸï¼');
    }

    // åˆ·æ–°æ‰€æœ‰å¤‡æ³¨æ˜¾ç¤º
    function refreshAllNotesDisplay() {
      if (!jm) return;

      const notesList = document.getElementById('notesList');
      if (!notesList) return; // é˜²æ­¢DOMå…ƒç´ ä¸å­˜åœ¨

      const nodeTree = jm.get_data();

      if (!nodeTree || !nodeTree.data) {
        notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹æ•°æ®</p>';
        return;
      }

      const nodesWithNotes = [];

      function collectNodes(node) {
        if (!node) return;

        const notes = node.notes;  // ç›´æ¥ä»æ ¹çº§åˆ«è¯»å–notes
        if (notes && notes.trim()) {
          nodesWithNotes.push({
            id: node.id,
            topic: node.topic || 'æœªå‘½åèŠ‚ç‚¹',
            notes: notes.trim(),
            level: node.level || 0
          });
        }

        if (node.children) {
          node.children.forEach(collectNodes);
        }
      }

      collectNodes(nodeTree.data);

      if (nodesWithNotes.length === 0) {
        notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹åŒ…å«å¤‡æ³¨ä¿¡æ¯</p>';
        return;
      }

      nodesWithNotes.sort((a, b) => a.level - b.level);

      let html = '';
      nodesWithNotes.forEach(node => {
        const levelIndent = 'ã€€'.repeat(node.level);
        html += `
                    <div class="note-item">
                        <h5>${levelIndent}${node.topic}</h5>
                        <p>${node.notes}</p>
                        <small style="color: #6c757d;">ID: ${node.id}</small>
                    </div>
                `;
      });

      notesList.innerHTML = html;
    }

    // è®¾ç½®é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¤‡æ³¨
    function setupHoverNotes() {
      const container = document.getElementById('fullScreenMindmap');
      const notesOverlay = document.getElementById('notesOverlay');
      const hoverNote = document.getElementById('hoverNote');

      let hoverTimeout;

      container.addEventListener('mousemove', function (e) {
        if (!jm) return;

        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        let node = null;
        try {
          if (jm.get_node_by_coordinate) {
            node = jm.get_node_by_coordinate(x, y);
          } else {
            const target = e.target;
            if (target && target.closest('.jmnode')) {
              const nodeId = target.closest('.jmnode').getAttribute('nodeid');
              if (nodeId) {
                node = jm.get_node(nodeId);
              }
            }
          }
        } catch (error) {
          // é™é»˜å¤„ç†é”™è¯¯
        }

        if (node && node.notes && node.notes.trim()) {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            hoverNote.textContent = node.notes;
            notesOverlay.style.display = 'block';
            notesOverlay.style.left = Math.min(x + 10, rect.width - 260) + 'px';
            notesOverlay.style.top = Math.max(y - 50, 10) + 'px';
          }, 300);
        } else {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            notesOverlay.style.display = 'none';
          }, 100);
        }
      });

      container.addEventListener('mouseleave', function () {
        clearTimeout(hoverTimeout);
        notesOverlay.style.display = 'none';
      });
    }



    /* ç”»å¸ƒæ¡†é€‰å¤šé€‰åŠŸèƒ½ */
    function setupBoxSelection() {
      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;

      // åœ¨ jsmind å†…éƒ¨å®¹å™¨å†…ç»˜åˆ¶æ¡†é€‰çŸ©å½¢ï¼Œç¡®ä¿åæ ‡ä¸æ»šåŠ¨ä¸€è‡´
      const inner = container.querySelector('.jsmind-inner') || container;
      // ä½¿å®¹å™¨å¯èšç„¦ï¼Œç¡®ä¿åœ¨ iframe ä¸­å¯æ¥æ”¶ç©ºæ ¼é”®
      inner.setAttribute('tabindex', '0');
      inner.style.outline = 'none';
      inner.addEventListener('mouseenter', () => { try { inner.focus({ preventScroll: true }); } catch (e) {} });
      inner.addEventListener('mousedown', () => { try { inner.focus({ preventScroll: true }); } catch (e) {} });
      // èŠ‚ç‚¹å®¹å™¨ï¼ˆjsMind ä¼šæŠŠèŠ‚ç‚¹æ”¾åœ¨ .jmnodes ä¸‹ï¼‰
      const nodesRoot = container.querySelector('.jmnodes') || inner;
      
      // ğŸ” ç®€åŒ–çš„DOMç»“æ„åˆ†æ - åªè¾“å‡ºå…³é”®ä¿¡æ¯
      console.log('=== èŠ‚ç‚¹æŸ¥è¯¢åˆ†æ ===');
      
      // è·å–æ‰€æœ‰åŒ…å«nodeidå±æ€§çš„å…ƒç´ ï¼ˆè¿™æ˜¯æœ€å¯é çš„æ–¹å¼ï¼‰
      const allNodeElements = document.querySelectorAll('[nodeid]');
      console.log('ğŸ“Š æ‰¾åˆ°çš„æ€»èŠ‚ç‚¹æ•°ï¼ˆå¸¦nodeidï¼‰:', allNodeElements.length);
      
      if (allNodeElements.length > 0) {
        // æ˜¾ç¤ºå‰å‡ ä¸ªèŠ‚ç‚¹çš„å®é™…ç±»åï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£ç»“æ„
        const sampleNodes = Array.from(allNodeElements).slice(0, 3);
        sampleNodes.forEach((el, i) => {
          console.log(`èŠ‚ç‚¹${i+1}: ${el.tagName}."${el.className}" #${el.id} [nodeid="${el.getAttribute('nodeid')}"]`);
        });
      } else {
        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¸¦nodeidå±æ€§çš„èŠ‚ç‚¹ï¼');
      }
      
      // æ£€æŸ¥.jmnodeç±»åï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
      const jmnodeCount = document.querySelectorAll('.jmnode').length;
      console.log('ä¼ ç»Ÿ.jmnodeç±»åæ•°é‡:', jmnodeCount);
     

      // åˆ›å»ºæ¡†é€‰çŸ©å½¢å…ƒç´ ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
      let rectEl = inner.querySelector('#selectionRect');
      if (!rectEl) {
        rectEl = document.createElement('div');
        rectEl.id = 'selectionRect';
        inner.appendChild(rectEl);
      }

      let isSelecting = false;
      let isSelectingPrimed = false;
      let isPanning = false;
      let isDownOnNode = false;
      let isDraggingNode = false; // è®°å½•æ˜¯å¦æ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹
      let startX = 0, startY = 0;
      let startClientX = 0, startClientY = 0;
      let startScrollLeft = 0, startScrollTop = 0;
      let addMode = false; // æ˜¯å¦å åŠ é€‰æ‹©ï¼ˆShift/Metaï¼‰ï¼Œç©ºæ ¼ä¸ºç”»å¸ƒæ‹–æ‹½
      let isSpacePressed = false; // ç©ºæ ¼æŒ‰ä¸‹æ—¶å¯ç”¨ç”»å¸ƒæ‹–æ‹½

      // ç›‘å¬ç©ºæ ¼é”®çŠ¶æ€ï¼›åœ¨è¾“å…¥æ¡†/æ–‡æœ¬åŸŸ/å¯ç¼–è¾‘å†…å®¹å†…æŒ‰ç©ºæ ¼ä¸è§¦å‘æ‹–æ‹½
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar') {
          const t = e.target;
          const isTyping = t && (
            t.tagName === 'INPUT' ||
            t.tagName === 'TEXTAREA' ||
            t.isContentEditable
          );
          if (!isTyping) {
            isSpacePressed = true;
            // é˜»æ­¢é¡µé¢æ»šåŠ¨ï¼ˆç©ºæ ¼é»˜è®¤ä¼šæ»šåŠ¨é¡µé¢ï¼‰
            e.preventDefault();
          }
        }
      }, { passive: false });

      window.addEventListener('keyup', (e) => {
        if (e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar') {
          isSpacePressed = false;
        }
      });
      const multiSelected = new Set();

      function updateHighlight() {
        // æ¸…ç†é«˜äº®
        const allNodeElements = document.querySelectorAll('[nodeid]');
        let clearCount = 0;
        allNodeElements.forEach(el => {
          if (el.classList.contains('multi-selected')) {
            el.classList.remove('multi-selected');
            clearCount++;
          }
        });
        
        // åº”ç”¨é«˜äº®
        multiSelected.forEach(id => {
          const el = document.querySelector(`[nodeid="${id}"]`);
          if (el) {
            el.classList.add('multi-selected');
            console.log(`âœ… æ·»åŠ  multi-selected ç±»åˆ°èŠ‚ç‚¹ ${id}:`, el.className);
            
            // æ£€æŸ¥è®¡ç®—æ ·å¼
            const computedStyle = window.getComputedStyle(el);
            console.log(`ğŸ¨ èƒŒæ™¯è‰²:`, computedStyle.backgroundColor);
            console.log(`ğŸ¨ è¾¹æ¡†:`, computedStyle.border);
            console.log(`ğŸ¨ å˜æ¢:`, computedStyle.transform);
            console.log(`ğŸ¨ é˜´å½±:`, computedStyle.boxShadow);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å†…è”æ ·å¼è¦†ç›–äº†æˆ‘ä»¬çš„æ ·å¼
            console.log(`ğŸ” å†…è”æ ·å¼èƒŒæ™¯è‰²:`, el.style.backgroundColor);
            console.log(`ğŸ” å†…è”æ ·å¼è¾¹æ¡†:`, el.style.border);
            console.log(`ğŸ” å†…è”æ ·å¼å˜æ¢:`, el.style.transform);
            console.log(`ğŸ” å†…è”æ ·å¼é˜´å½±:`, el.style.boxShadow);
            
            // æ£€æŸ¥jsMindæ˜¯å¦é€šè¿‡å…¶ä»–æ–¹å¼è®¾ç½®äº†æ ·å¼
             console.log(`ğŸ” å…ƒç´ å±æ€§:`, {
               style: el.getAttribute('style'),
               class: el.getAttribute('class'),
               'data-jmstyle': el.getAttribute('data-jmstyle'),
               'data-theme': el.getAttribute('data-theme')
             });
             
             // æ£€æŸ¥jsMindçš„å†…ç½®é€‰ä¸­çŠ¶æ€
             console.log(`ğŸ” jsMindé€‰ä¸­çŠ¶æ€:`, {
               selected: el.classList.contains('selected'),
               'jsMindä¸»é¢˜': window.getComputedStyle(el).getPropertyValue('--jsmind-theme') || 'æœªè®¾ç½®'
             });
             
             // å‘æµ‹è¯•é¡µé¢å‘é€åé¦ˆï¼ˆå¦‚æœå­˜åœ¨ï¼‰
             if (window.opener && !window.opener.closed) {
               try {
                 window.opener.postMessage({
                   type: 'multiselect-test',
                   message: `å¤šé€‰èŠ‚ç‚¹æ£€æŸ¥å®Œæˆ - æ ·å¼åº”ç”¨${hasStyle ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                   nodeId: el.getAttribute('nodeid'),
                   hasMultiSelected: el.classList.contains('multi-selected'),
                   hasSelected: el.classList.contains('selected')
                 }, '*');
               } catch (e) {
                 console.log('æ— æ³•å‘æµ‹è¯•é¡µé¢å‘é€æ¶ˆæ¯:', e.message);
               }
             }
            
            // å¼ºåˆ¶åº”ç”¨æ ·å¼ä»¥ç¡®ä¿ç”Ÿæ•ˆ - ä½¿ç”¨æ›´æ¿€è¿›çš„æ–¹æ³•
            setTimeout(() => {
              // é¦–å…ˆæ¸…é™¤å¯èƒ½å†²çªçš„å†…è”æ ·å¼
              el.style.backgroundColor = '';
              el.style.border = '';
              el.style.transform = '';
              el.style.boxShadow = '';
              
              // ç„¶ååº”ç”¨æˆ‘ä»¬çš„æ ·å¼
              el.style.setProperty('background-color', 'rgba(76, 154, 255, 0.8)', 'important');
              el.style.setProperty('border', '4px solid #4c9aff', 'important');
              el.style.setProperty('transform', 'scale(1.1)', 'important');
              el.style.setProperty('box-shadow', '0 0 0 4px #4c9aff, inset 0 0 0 3px #4c9aff, 0 6px 20px rgba(76, 154, 255, 0.6), 0 0 30px rgba(76, 154, 255, 0.4)', 'important');
              el.style.setProperty('color', '#fff', 'important');
              el.style.setProperty('font-weight', 'bold', 'important');
              el.style.setProperty('z-index', '999', 'important');
              
              console.log(`ğŸ”§ å¼ºåˆ¶åº”ç”¨æ ·å¼åˆ°èŠ‚ç‚¹ ${id}`);
              
              // å†æ¬¡æ£€æŸ¥æ ·å¼æ˜¯å¦ç”Ÿæ•ˆ
              setTimeout(() => {
                const newComputedStyle = window.getComputedStyle(el);
                console.log(`âœ… å¼ºåˆ¶æ ·å¼å - èƒŒæ™¯è‰²:`, newComputedStyle.backgroundColor);
                console.log(`âœ… å¼ºåˆ¶æ ·å¼å - è¾¹æ¡†:`, newComputedStyle.border);
                console.log(`âœ… å¼ºåˆ¶æ ·å¼å - å˜æ¢:`, newComputedStyle.transform);
                console.log(`âœ… å¼ºåˆ¶æ ·å¼å - é˜´å½±:`, newComputedStyle.boxShadow);
              }, 200);
            }, 100);
          } else {
            console.log(`âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹å…ƒç´ : ${id}`);
          }
        });
        
        // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
        const batchOps = document.getElementById('batchOperations');
        const selectedCount = document.getElementById('selectedCount');
        const count = multiSelected.size;
        
        if (count > 0) {
          batchOps.style.display = 'inline-block';
          selectedCount.textContent = count;
        } else {
          batchOps.style.display = 'none';
        }
        
        // æš´éœ²ä¾¿æ· API
        window.getMultiSelection = () => Array.from(multiSelected);
        window.clearMultiSelection = () => { multiSelected.clear(); updateHighlight(); };
        window.selectMultipleNodes = (ids) => {
          if (!Array.isArray(ids)) return;
          ids.forEach(id => id && multiSelected.add(id));
          updateHighlight();
        };
        
        // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥å¤šé€‰æ ·å¼åº”ç”¨æƒ…å†µ
        window.debugMultiSelect = function() {
          console.log('=== å¤šé€‰è°ƒè¯•ä¿¡æ¯ ===');
          console.log('å¤šé€‰é›†åˆå¤§å°:', multiSelected.size);
          console.log('å¤šé€‰èŠ‚ç‚¹ID:', Array.from(multiSelected));
          
          multiSelected.forEach(id => {
               const el = document.querySelector(`[nodeid="${id}"]`);
               if (el) {
                 console.log(`èŠ‚ç‚¹ ${id}:`);
                 console.log('  - ç±»å:', el.className);
                 console.log('  - æœ‰multi-selectedç±»:', el.classList.contains('multi-selected'));
                 console.log('  - è®¡ç®—èƒŒæ™¯è‰²:', window.getComputedStyle(el).backgroundColor);
                 console.log('  - è®¡ç®—è¾¹æ¡†:', window.getComputedStyle(el).border);
                 console.log('  - è®¡ç®—å˜æ¢:', window.getComputedStyle(el).transform);
                 console.log('  - è®¡ç®—é˜´å½±:', window.getComputedStyle(el).boxShadow);
                 console.log('  - å†…è”æ ·å¼:', el.getAttribute('style'));
                 console.log('  - z-index:', window.getComputedStyle(el).zIndex);
               } else {
                 console.log(`èŠ‚ç‚¹ ${id}: æœªæ‰¾åˆ°å…ƒç´ `);
               }
             });
          
          // æ£€æŸ¥CSSè§„åˆ™æ˜¯å¦åŠ è½½
          const stylesheets = Array.from(document.styleSheets);
          console.log('æ ·å¼è¡¨æ•°é‡:', stylesheets.length);
          
          let foundMultiSelectRule = false;
          stylesheets.forEach((sheet, index) => {
            try {
              const rules = Array.from(sheet.cssRules || sheet.rules || []);
              rules.forEach((rule, ruleIndex) => {
                if (rule.selectorText && rule.selectorText.includes('multi-selected')) {
                  console.log(`åœ¨æ ·å¼è¡¨ ${index} è§„åˆ™ ${ruleIndex} æ‰¾åˆ° multi-selected è§„åˆ™:`, rule.selectorText);
                  console.log('è§„åˆ™å†…å®¹:', rule.cssText);
                  foundMultiSelectRule = true;
                }
              });
            } catch (e) {
              console.log(`æ— æ³•è®¿é—®æ ·å¼è¡¨ ${index}:`, e.message);
            }
          });
          
          if (!foundMultiSelectRule) {
            console.log('âŒ æœªæ‰¾åˆ°ä»»ä½• multi-selected CSS è§„åˆ™ï¼');
          }
        };
      }

      function rectsIntersect(a, b) {
        return a.left <= b.right && a.right >= b.left && a.top <= b.bottom && a.bottom >= b.top;
      }

      function onMouseDown(e) {
        if (e.button !== 0) return; // ä»…å·¦é”®
        // é¿å…åœ¨èŠ‚ç‚¹/å³ä¾§é¢æ¿/å·¥å…·æ ä¸Šè§¦å‘æ¡†é€‰/æ‹–æ‹½
        
        // ç®€åŒ–èŠ‚ç‚¹æ£€æµ‹ - ç›´æ¥æ£€æŸ¥ç›®æ ‡å…ƒç´ åŠå…¶çˆ¶å…ƒç´ 
        let nodeElement = null;
        const target = e.target;
        
        // æ–¹æ³•1: æ£€æŸ¥ç›®æ ‡å…ƒç´ æœ¬èº«æ˜¯å¦æœ‰.jmnodeç±»
        if (target.classList && target.classList.contains('jmnode')) {
          nodeElement = target;
        }
        // æ–¹æ³•2: æ£€æŸ¥ç›®æ ‡å…ƒç´ æ˜¯å¦æœ‰nodeidå±æ€§
        else if (target.hasAttribute && target.hasAttribute('nodeid')) {
          nodeElement = target;
        }
        // æ–¹æ³•3: æ£€æŸ¥çˆ¶å…ƒç´ 
        else if (target.closest) {
          nodeElement = target.closest('.jmnode');
          if (!nodeElement) {
            nodeElement = target.closest('[nodeid]');
          }
        }
        
        isDownOnNode = !!nodeElement;
        
        // åå¤‡æ–¹æ¡ˆï¼šæ£€æŸ¥é¼ æ ‡ä½ç½®æ˜¯å¦åœ¨èŠ‚ç‚¹åŒºåŸŸå†…
        if (!isDownOnNode) {
          const allNodes = document.querySelectorAll('[nodeid]');
          
          for (let i = 0; i < allNodes.length; i++) {
            const node = allNodes[i];
            const rect = node.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            if (mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom) {
              isDownOnNode = true;
              break;
            }
          }
        }
        
        // å¦‚æœç‚¹å‡»åœ¨ç©ºç™½åŒºåŸŸï¼ˆéèŠ‚ç‚¹ã€éå·¥å…·æ ã€éæ‰¹é‡æ“ä½œé¢æ¿ï¼‰ï¼Œæ¸…é™¤é€‰æ‹©
        if (!isDownOnNode && !e.target.closest('#toolbar') && !e.target.closest('#batchOperations')) {
          multiSelected.clear();
          updateHighlight();
        }
         
        if (isDownOnNode) {
          // åœ¨èŠ‚ç‚¹ä¸ŠæŒ‰ä¸‹ï¼Œæ ‡è®°ä¸ºæ‹–æ‹½çŠ¶æ€ï¼Œç¦ç”¨æ¡†é€‰
          isDraggingNode = true;
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';

          
          // å¦‚æœæŒ‰ä½Shifté”®ç‚¹å‡»èŠ‚ç‚¹ï¼Œåˆ‡æ¢é€‰æ‹©çŠ¶æ€
          if (e.shiftKey || e.metaKey) {
            const clickedNode = e.target.closest('.jmnode');
            if (clickedNode) {
              const nodeId = clickedNode.getAttribute('nodeid');
              if (nodeId) {
                if (multiSelected.has(nodeId)) {
                  multiSelected.delete(nodeId);
                } else {
                  multiSelected.add(nodeId);
                }
                updateHighlight();
                e.preventDefault();
                return;
              }
            }
          }
          
          // **å…³é”®ä¿®å¤**ï¼šå¦‚æœå½“å‰èŠ‚ç‚¹åœ¨å¤šé€‰é›†åˆä¸­ï¼Œé˜»æ­¢jsMindçš„æ‹–æ‹½æ’ä»¶å¤„ç†
          // é¿å…å¤šé€‰èŠ‚ç‚¹æ‹–æ‹½æ—¶å‡ºç° "Cannot read properties of null (reading 'tagName')" é”™è¯¯
          const clickedNode = e.target.closest('.jmnode');
          if (clickedNode) {
            const nodeId = clickedNode.getAttribute('nodeid');
            if (nodeId && multiSelected.has(nodeId) && multiSelected.size > 1) {
              // å¤šé€‰èŠ‚ç‚¹è¢«ç‚¹å‡»ï¼Œé˜»æ­¢jsMindæ‹–æ‹½æ’ä»¶çš„é»˜è®¤è¡Œä¸º
              e.preventDefault();
              e.stopPropagation();
              console.log('é˜»æ­¢jsMindæ‹–æ‹½æ’ä»¶å¤„ç†å¤šé€‰èŠ‚ç‚¹');
              return;
            }
          }
          
          // å•ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œè®©jsMindå¤„ç†æ‹–æ‹½
          return;
        }
        
        if (e.target.closest('#nodeDetails') || e.target.closest('.toolbar')) {
          // åœ¨é¢æ¿/å·¥å…·æ ä¸ŠæŒ‰ä¸‹ï¼Œç¦æ­¢æ¡†é€‰
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';

          // **ä¸é˜»æ­¢äº‹ä»¶å†’æ³¡**ï¼Œè®©å…¶ä»–åŠŸèƒ½æ­£å¸¸å·¥ä½œ
          return;
        }

        // ç©ºæ ¼ + æ‹–æ‹½ => ç”»å¸ƒå¹³ç§»
        if (isSpacePressed) {
          isPanning = true;
          const r = inner.getBoundingClientRect();
          startClientX = e.clientX;
          startClientY = e.clientY;
          startScrollLeft = inner.scrollLeft;
          startScrollTop = inner.scrollTop;
          inner.style.cursor = 'grabbing';
          e.preventDefault();
          return;
        }

        // æ™®é€šæ‹–æ‹½ => å¾…åˆ¤å®šæ¡†é€‰ï¼ˆä»…å½“ç§»åŠ¨è¶…é˜ˆå€¼æ‰çœŸæ­£å¼€å§‹ï¼‰
        isSelecting = false;
        isSelectingPrimed = true;
        addMode = !!(e.shiftKey || e.metaKey);

        const r = inner.getBoundingClientRect();
        // å°† client åæ ‡æ¢ç®—åˆ° inner çš„æ»šåŠ¨åæ ‡ç³»
        startX = e.clientX - r.left + inner.scrollLeft;
        startY = e.clientY - r.top + inner.scrollTop;

        // æš‚ä¸æ¸…ç©ºï¼Œç­‰çœŸæ­£å¼€å§‹æ¡†é€‰æ—¶å†å†³å®šæ˜¯å¦æ¸…ç©º
        Object.assign(rectEl.style, {
          display: 'none',
          left: `${startX}px`,
          top: `${startY}px`,
          width: '0px',
          height: '0px'
        });

        // é˜»æ­¢é»˜è®¤é€‰æ‹©è¡Œä¸ºï¼Œé¿å…æ–‡å­—é€‰ä¸­
        e.preventDefault();
      }

      function onMouseMove(e) {
        // ç”»å¸ƒå¹³ç§»æ¨¡å¼
        if (isPanning) {
          const dx = e.clientX - startClientX;
          const dy = e.clientY - startClientY;
          inner.scrollLeft = startScrollLeft - dx;
          inner.scrollTop = startScrollTop - dy;
          e.preventDefault();
          return;
        }

        // å¦‚æœæ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹ï¼Œå®Œå…¨è·³è¿‡æ¡†é€‰é€»è¾‘
        if (isDownOnNode || isDraggingNode) { 
          // éšè—æ¡†é€‰çŸ©å½¢ï¼Œä½†**ä¸é˜»æ­¢**jsMindçš„äº‹ä»¶å¤„ç†
          rectEl.style.display = 'none'; 
          
          // **æ–°å¢**ï¼šå¤šé€‰èŠ‚ç‚¹æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ
          if (isDraggingNode && multiSelected.size > 1) {
            // ä¸ºå¤šé€‰èŠ‚ç‚¹æ·»åŠ æ‹–æ‹½æ—¶çš„ç‰¹æ®Šæ ·å¼
            multiSelected.forEach(nodeId => {
              const nodeEl = document.querySelector(`[nodeid="${nodeId}"]`);
              if (nodeEl) {
                nodeEl.style.opacity = '0.8';
                nodeEl.style.transform = 'scale(1.1)';
                nodeEl.style.transition = 'all 0.1s ease';
              }
            });
          }
          
          return;
        }

        // æ™ºèƒ½æ‹–æ‹½æ£€æµ‹ï¼šå¦‚æœé¼ æ ‡æŒ‰ä¸‹æ—¶æœªæ£€æµ‹åˆ°èŠ‚ç‚¹ï¼Œä½†ç§»åŠ¨æ—¶æ£€æµ‹åˆ°åœ¨èŠ‚ç‚¹ä¸Šï¼Œåˆ™è®¤ä¸ºæ˜¯æ‹–æ‹½
        if (!isDownOnNode && !isDraggingNode && isSelectingPrimed) {
          const hoveredNode = document.elementFromPoint(e.clientX, e.clientY);
          if (hoveredNode && (hoveredNode.classList.contains('jmnode') || hoveredNode.closest('.jmnode'))) {
            isDraggingNode = true;
            isSelecting = false;
            isSelectingPrimed = false;
            rectEl.style.display = 'none';
            return;
          }
        }
        
        if (!isSelecting && !isSelectingPrimed) return;

        const r = inner.getBoundingClientRect();
        const curX = e.clientX - r.left + inner.scrollLeft;
        const curY = e.clientY - r.top + inner.scrollTop;

        const x = Math.min(startX, curX);
        const y = Math.min(startY, curY);
        const w = Math.abs(curX - startX);
        const h = Math.abs(curY - startY);

        // ç§»åŠ¨è¶…è¿‡é˜ˆå€¼(>4px)æ‰çœŸæ­£å¼€å§‹æ¡†é€‰
        if (isSelectingPrimed && !isSelecting) {
          if (w > 4 || h > 4) {
            isSelecting = true;
            isSelectingPrimed = false;
            if (!addMode) multiSelected.clear();
            rectEl.style.display = 'block';
          } else {
            return;
          }
        }

        Object.assign(rectEl.style, {
          left: `${x}px`,
          top: `${y}px`,
          width: `${w}px`,
          height: `${h}px`
        });

        // å°†é€‰æ¡†è½¬æ¢å› client åæ ‡ç”¨äºä¸èŠ‚ç‚¹ getBoundingClientRect ç›¸äº¤æµ‹è¯•
        const selClient = {
          left: x - inner.scrollLeft + r.left,
          top: y - inner.scrollTop + r.top,
          right: x - inner.scrollLeft + r.left + w,
          bottom: y - inner.scrollTop + r.top + h
        };



        // èŠ‚ç‚¹æŸ¥è¯¢
        let nodeElements = [];
        const allNodeElements = document.querySelectorAll('[nodeid]');
        
        if (allNodeElements.length > 0) {
          nodeElements = Array.from(allNodeElements);
        } else {
          if (nodesRoot) {
            nodeElements = Array.from(nodesRoot.querySelectorAll('.jmnode'));
          }
          
          if (nodeElements.length === 0) {
            nodeElements = Array.from(document.querySelectorAll('.jmnode'));
          }
        }
        
        let intersectedCount = 0;
        nodeElements.forEach(el => {
          const nb = el.getBoundingClientRect();
          const intersects = rectsIntersect(selClient, {
            left: nb.left, top: nb.top, right: nb.right, bottom: nb.bottom
          });
          const id = el.getAttribute('nodeid');
          if (!id) return;

          if (intersects) {
            multiSelected.add(id);
            intersectedCount++;
          } else if (!addMode) {
            // æ›¿æ¢æ¨¡å¼æ—¶ï¼Œå®æ—¶ç§»é™¤æœªå‘½ä¸­çš„èŠ‚ç‚¹
            multiSelected.delete(id);
          }
        });

        if (intersectedCount > 0) {
          console.log(`ğŸ¯ æ¡†é€‰åˆ° ${intersectedCount} ä¸ªèŠ‚ç‚¹ï¼Œå½“å‰å…±é€‰ä¸­ ${multiSelected.size} ä¸ª`);
        }

        updateHighlight();
      }

      function onMouseUp() {
        // ç»“æŸç”»å¸ƒå¹³ç§»
        if (isPanning) {
          isPanning = false;
          inner.style.cursor = '';
          return;
        }

        // è‹¥å¤„äºé¢„å¤‡çŠ¶æ€ä½†æœªè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™å–æ¶ˆ
        if (isSelectingPrimed && !isSelecting) {
          isSelectingPrimed = false;
          return;
        }

        // è‹¥æœ¬æ¬¡æ‹–æ‹½èµ·ç‚¹åœ¨èŠ‚ç‚¹ä¸Šæˆ–æ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹ï¼Œåˆ™ä¸è¿›è¡Œæ¡†é€‰
        if (isDownOnNode || isDraggingNode) {
          // **æ–°å¢**ï¼šå¤šé€‰èŠ‚ç‚¹æ‹–æ‹½ç»“æŸæ—¶çš„æ ·å¼æ¢å¤
          if (isDraggingNode && multiSelected.size > 1) {
            // æ¢å¤å¤šé€‰èŠ‚ç‚¹çš„åŸå§‹æ ·å¼
            multiSelected.forEach(nodeId => {
              const nodeEl = document.querySelector(`[nodeid="${nodeId}"]`);
              if (nodeEl) {
                nodeEl.style.opacity = '';
                nodeEl.style.transform = '';
                nodeEl.style.transition = '';
              }
            });
          }
          
          isDownOnNode = false;
          isDraggingNode = false;
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';
          return;
        }

        if (!isSelecting) return;
        isSelecting = false;
        rectEl.style.display = 'none';
        updateHighlight();
      }

      // ç»‘å®šäº‹ä»¶åˆ° innerï¼Œè¿™æ ·æ»šåŠ¨ä¸åæ ‡ç³»ä¸€è‡´
      // **ä¸ä½¿ç”¨æ•è·é˜¶æ®µ**ï¼Œé¿å…å¹²æ‰°jsMindçš„äº‹ä»¶å¤„ç†
      inner.addEventListener('mousedown', onMouseDown);
      inner.addEventListener('mousemove', onMouseMove);
      // mouseup ç»‘å®šåˆ° windowï¼Œé¿å…åœ¨å¿«é€Ÿæ‹–åŠ¨å‡ºå®¹å™¨æ—¶ä¸¢äº‹ä»¶
      window.addEventListener('mouseup', onMouseUp);
      
      // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬ï¼Œç”¨äºåˆ‡æ¢èŠ‚ç‚¹é€‰æ‹©çŠ¶æ€
      inner.addEventListener('dblclick', function(e) {
        const clickedNode = e.target.closest('.jmnode');
        if (clickedNode) {
          const nodeId = clickedNode.getAttribute('nodeid');
          if (nodeId) {
            if (multiSelected.has(nodeId)) {
              multiSelected.delete(nodeId);
            } else {
              multiSelected.add(nodeId);
            }
            updateHighlight();
            e.preventDefault();
          }
        }
      });

      // ä½¿ç”¨jsMindåŸç”Ÿäº‹ä»¶ç³»ç»Ÿæ£€æµ‹æ‹–æ‹½
      if (window.jsMind && jm) {
        // ç›‘å¬æ‰€æœ‰jsMindäº‹ä»¶
        jm.add_event_listener(function(type, data) {
          // æ‹–æ‹½å¼€å§‹äº‹ä»¶
          if (type === jsMind.event_type.move_node) {
            if (data && data.data && Array.isArray(data.data) && data.data.length >= 3) {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }
          }
          
          // ç›‘å¬èŠ‚ç‚¹é€‰æ‹©å˜åŒ–ï¼ˆå¯èƒ½è¡¨ç¤ºæ‹–æ‹½ç»“æŸï¼‰
          if (type === jsMind.event_type.select_node || type === jsMind.event_type.select_clear) {
            if (isDraggingNode) {
              setTimeout(() => {
                isDraggingNode = false;
              }, 100);
            }
          }
        });
      } else {
        // å¤‡ç”¨æ‹–æ‹½æ£€æµ‹æœºåˆ¶
        let dragStartTimer = null;
        
        // ç›‘å¬mousedownäº‹ä»¶ï¼Œæ£€æµ‹æ˜¯å¦åœ¨èŠ‚ç‚¹ä¸Š
        inner.addEventListener('mousedown', function(e) {
          if (e.target && e.target.closest && e.target.closest('.jmnode')) {
            // å»¶è¿Ÿè®¾ç½®æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…è¯¯è§¦å‘
            dragStartTimer = setTimeout(() => {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }, 100); // 100mså»¶è¿Ÿ
          }
        }, true);

        // ç›‘å¬mouseupäº‹ä»¶ï¼Œé‡ç½®æ‹–æ‹½çŠ¶æ€
        window.addEventListener('mouseup', function() {
          if (dragStartTimer) {
            clearTimeout(dragStartTimer);
            dragStartTimer = null;
          }
          if (isDraggingNode) {
            isDraggingNode = false;
          }
        });

        // ç›‘å¬mousemoveäº‹ä»¶ï¼Œå¦‚æœåœ¨èŠ‚ç‚¹ä¸Šç§»åŠ¨ä¸”æŒ‰ä¸‹äº†é¼ æ ‡ï¼Œè®¤ä¸ºæ˜¯æ‹–æ‹½
        inner.addEventListener('mousemove', function(e) {
          if (e.buttons === 1 && e.target && e.target.closest && e.target.closest('.jmnode')) {
            if (!isDraggingNode) {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }
          }
        }, true);
      }

      // æ‰¹é‡åˆ é™¤ï¼ˆDelete/Backspaceï¼‰å·²å¤šé€‰çš„èŠ‚ç‚¹ï¼ˆæ•è·é˜¶æ®µä¼˜å…ˆäºå†…ç½®åˆ é™¤ï¼‰
      document.addEventListener('keydown', (e) => {
        const key = e.key || '';
        if ((key === 'Delete' || key === 'Backspace') && typeof window.getMultiSelection === 'function') {
          const ids = window.getMultiSelection();
          if (Array.isArray(ids) && ids.length > 0) {
            e.preventDefault();
            e.stopPropagation();
            ids.filter(id => id && id !== 'root').forEach(id => {
              try { jm.remove_node(id); } catch (err) {}
            });
            if (typeof window.clearMultiSelection === 'function') window.clearMultiSelection();
            if (typeof debouncedSave === 'function') debouncedSave();
          }
        }
      }, true);

      // æ‰¹é‡åˆ é™¤å‡½æ•°ï¼ˆä¾›æŒ‰é’®è°ƒç”¨ï¼‰
      window.batchDelete = function() {
        const ids = window.getMultiSelection();
        if (!Array.isArray(ids) || ids.length === 0) {
          showWarning('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹');
          return;
        }
        
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªèŠ‚ç‚¹å—ï¼Ÿ`)) return;
        
        let deletedCount = 0;
        ids.filter(id => id && id !== 'root').forEach(id => {
          try { 
            jm.remove_node(id); 
            deletedCount++;
          } catch (err) {
            console.warn(`åˆ é™¤èŠ‚ç‚¹ ${id} å¤±è´¥:`, err);
          }
        });
        
        if (typeof window.clearMultiSelection === 'function') window.clearMultiSelection();
        if (typeof debouncedSave === 'function') debouncedSave();
        
        showSuccess(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªèŠ‚ç‚¹`);
      };

      // æ‰¹é‡ç§»åŠ¨å‡½æ•°
      window.batchMove = function() {
        const ids = window.getMultiSelection();
        if (!Array.isArray(ids) || ids.length === 0) {
          showWarning('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„èŠ‚ç‚¹');
          return;
        }
        
        // è®¾ç½®æ‰¹é‡ç§»åŠ¨æ¨¡å¼
        window.__batchMoving = true;
        window.__batchMoveIds = ids;
        
        // æ˜¾ç¤ºç§»åŠ¨æç¤º
        const hint = document.createElement('div');
        hint.id = 'batchMoveHint';
        hint.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(76, 154, 255, 0.9);
          color: white;
          padding: 15px 25px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          text-align: center;
          max-width: 300px;
        `;
        hint.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">æ‰¹é‡ç§»åŠ¨æ¨¡å¼</div>
          <div>ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹ï¼Œå°†é€‰ä¸­çš„ ${ids.length} ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹åé¢</div>
          <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">æŒ‰ ESC é”®å–æ¶ˆ</div>
        `;
        document.body.appendChild(hint);
        
        // æ·»åŠ ESCé”®å–æ¶ˆåŠŸèƒ½
        const escHandler = function(e) {
          if (e.key === 'Escape') {
            cancelBatchMove();
          }
        };
        document.addEventListener('keydown', escHandler);
        
        // å–æ¶ˆæ‰¹é‡ç§»åŠ¨å‡½æ•°
        window.cancelBatchMove = function() {
          window.__batchMoving = false;
          window.__batchMoveIds = [];
          const hint = document.getElementById('batchMoveHint');
          if (hint) hint.remove();
          document.removeEventListener('keydown', escHandler);
          delete window.cancelBatchMove;
        };
        
        showInfo('æ‰¹é‡ç§»åŠ¨æ¨¡å¼å·²æ¿€æ´»ï¼Œç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹å®Œæˆç§»åŠ¨');
      };
    }

    function exportData() {
      if (!jm) return;
      try {
        const data = jm.get_data();
        const jsonText = JSON.stringify(data, null, 2);
        const pre = document.getElementById('jsonPreview');
        if (pre) pre.textContent = jsonText;
        if (window.jQuery && $('#jsonModal').modal) {
          $('#jsonModal').modal('show');
        } else {
          const w = window.open('', '_blank', 'width=900,height=700');
          if (w) {
            w.document.write('<pre style="white-space:pre-wrap;word-break:break-word;">' +
              (jsonText.replace(/</g, '<')) + '</pre>');
            w.document.close();
          } else {
            showWarning('è¯·å…è®¸å¼¹çª—ä»¥æŸ¥çœ‹JSON');
          }
        }
      } catch (e) {
        showError('æŸ¥çœ‹JSONå¤±è´¥: ' + e.message);
      }
    }

    // æç¤ºä¿¡æ¯å‡½æ•°
    function showWarning(msg) {
      console.warn(msg);
      alert(msg);
    }

    function showError(msg) {
      console.error(msg);
      alert(msg);
    }

    function showSuccess(msg) {
      console.log(msg);
      alert(msg);
    }

    function showInfo(msg) {
      console.log(msg);
      alert(msg);
    }

    // è·å–é»˜è®¤NodeTree
    function getDefaultNodeTree() {
      return {
        "meta": {
          "name": "jsMind remote",
          "author": "mindword",
          "version": "1.0.0"
        },
        "format": "node_tree",
        "data": {
          "id": "root",
          "topic": "æ¬¢è¿ä½¿ç”¨æ€ç»´å¯¼å›¾",
          "children": [
            {
              "id": "sub1",
              "topic": "ç‚¹å‡»èŠ‚ç‚¹ç¼–è¾‘",
              "direction": "right",
              "children": [
                {
                  "id": "sub1_1",
                  "topic": "åŒå‡»ç¼–è¾‘æ–‡æœ¬",
                  "data": {
                    "notes": "åŒå‡»èŠ‚ç‚¹å¯ä»¥ç¼–è¾‘æ–‡æœ¬å†…å®¹"
                  }
                },
                {
                  "id": "sub1_2",
                  "topic": "æ‹–æ‹½è°ƒæ•´ä½ç½®",
                  "data": {
                    "notes": "æ‹–æ‹½èŠ‚ç‚¹å¯ä»¥è°ƒæ•´ä½ç½®å’Œå±‚çº§å…³ç³»"
                  }
                }
              ]
            },
            {
              "id": "sub2",
              "topic": "å³ä¾§ç¼–è¾‘è¯¦æƒ…",
              "direction": "right",
              "data": {
                "notes": "åœ¨å³ä¾§é¢æ¿å¯ä»¥ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯"
              }
            }
          ]
        }
      };
    }

    // ä¿å­˜å½“å‰æ•°æ®åˆ°localStorage
    function saveToLocalStorage() {
      if (!jm) return;

      const currentData = jm.get_data();
      const dataString = JSON.stringify(currentData);

      // é¿å…è§¦å‘æœ¬åœ°ç›‘å¬å™¨ï¼ˆé˜²æ­¢å¾ªç¯åŠ è½½ï¼‰
      lastStorageData = dataString;
      // æ ‡è®°æŠ‘åˆ¶ï¼šæœ¬é¡µå³å°†å†™å…¥ nodetreeï¼Œä¸€æ¬¡è‡ªå‘å†™å…¥
      window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
      localStorage.setItem('mindword_nodetree_data', dataString);
      // åŒæ­¥æ•°æ®åˆ°å„ä¸ªç³»ç»Ÿ
      try {
        // 1. ä¼˜å…ˆä½¿ç”¨syncAllå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof syncAll === 'function') {
          // åŠ¨æ€åŠ è½½è½¬æ¢å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if (!window.converter) {
            console.log('æ­£åœ¨åŠ è½½è½¬æ¢å™¨...');
            import('../converter/converter.js')
              .then(module => {
                window.converter = new module.ConverterManager();
                console.log('è½¬æ¢å™¨å·²åŠ è½½');
                // è½¬æ¢å™¨å°±ç»ªåï¼Œç»Ÿä¸€ä»æ€ç»´å¯¼å›¾æºåŒæ­¥å¹¶å†™ä¸‰ä»½ç¼“å­˜
                if (typeof syncAll === 'function') {
                  window.__mindmapSelfUpdateUntil = Date.now() + 1500;
                  // æ ‡è®°æŠ‘åˆ¶ï¼šsyncAll æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å†æ¬¡å†™å…¥ nodetree
                  window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
                  syncAll('mindmap', true, true, currentData);
                }
              })
              .catch(error => {
                console.warn('è½¬æ¢å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ¨¡å¼:', error);
                // é™çº§å¤„ç†ï¼šç›´æ¥ä¿å­˜åˆ°localStorage
                localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
              });
          } else {
            // è½¬æ¢å™¨å·²å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨ï¼šä»æ€ç»´å¯¼å›¾æºåŒæ­¥å¹¶å†™ä¸‰ä»½ç¼“å­˜
            if (typeof syncAll === 'function') {
              window.__mindmapSelfUpdateUntil = Date.now() + 1500;
              // æ ‡è®°æŠ‘åˆ¶ï¼šsyncAll æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å†æ¬¡å†™å…¥ nodetree
              window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
              syncAll('mindmap', true, true, currentData);
            }
          }
        } else {
          // 2. é™çº§å¤„ç†ï¼šä¿å­˜åˆ°localStorage
          console.log('syncAllå‡½æ•°ä¸å­˜åœ¨ï¼Œä¿å­˜åˆ°localStorage');
          localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
        }
        // åŒæ­¥åˆ°çˆ¶é¡µé¢
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'mindmapUpdated',
            data: currentData
          }, '*');
        }
      } catch (error) {
        console.warn('åŒæ­¥æ–¹æ³•è°ƒç”¨å¤±è´¥:', error);
        // æœ€ç»ˆé™çº§å¤„ç†
        localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
      }
    }

    // é˜²æŠ–ä¿å­˜
    let saveTimer = null;
    function debouncedSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveToLocalStorage(), 300);
    }

    // ç±»å‹å¯¹é½è¾…åŠ©å‡½æ•°ï¼šè¯»å–/å†™å…¥èŠ‚ç‚¹ç±»å‹ï¼ˆä¼˜å…ˆæ ¹çº§åˆ«ï¼Œå…¼å®¹ data.typeï¼‰
    function getNodeType(n) {
      if (!n) return undefined;

      if (typeof n.type !== 'undefined') {
        return n.type;
      } else if (n.data && typeof n.data.type !== 'undefined') {
        return n.data.type;
      } else if (n.data && n.data.data && typeof n.data.data.type !== 'undefined') {
        return n.data.data.type;
      }
      return undefined;
    }
    function setNodeType(n, t) {
      if (!n) return;
      n.type = t;
      if (n.data) {
        if (n.data.data) {
          n.data.data.type = t;
        } else {
          n.data.type = t;
        }
      }
    }

    // è®¾ç½®èŠ‚ç‚¹å±‚çº§ï¼ˆæ ‡é¢˜ç±»å‹ä¸“ç”¨ï¼‰
    function setNodeLevel(n, level) {
      if (!n || level < 1 || level > 6) return;
      n.level = level;
      if (n.data) {
        if (n.data.data) {
          n.data.data.level = level;
        } else {
          n.data.level = level;
        }
      }
    }
    // è¯»å–èŠ‚ç‚¹å±‚çº§ï¼ˆå…¼å®¹æ ¹çº§å’Œ data.levelï¼‰
    function getNodeLevel(n) {
      if (!n) return null;
      if (typeof n.level !== 'undefined') return n.level;
      if (n.data && typeof n.data.level !== 'undefined') return n.data.level;
      if (n.data && n.data.data && typeof n.data.data.level !== 'undefined') return n.data.data.level;

      // Fallback 1ï¼šå¦‚æœèŠ‚ç‚¹topicæ˜¯æ•°å­—ï¼Œå°è¯•è§£æä¸ºå±‚çº§
      if (n.topic && /^\d+$/.test(n.topic.trim())) {
        const topicLevel = parseInt(n.topic.trim());
        if (topicLevel >= 0 && topicLevel <= 6) {
          return topicLevel;
        }
      }

      // Fallback 2ï¼šåŸºäºèŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹ä¸­çš„ä½ç½®ä¼°ç®—å±‚çº§
      if (n.parent) {
        const parent = jm.get_node(n.parent.id);
        if (parent && parent.children && parent.children.length > 0) {
          // è®¡ç®—èŠ‚ç‚¹åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­çš„ä½ç½®
          const siblingIndex = parent.children.findIndex(child => child && child.id === n.id);
          if (siblingIndex >= 0) {
            // ç®€å•çš„å¯å‘å¼ï¼šå¦‚æœçˆ¶èŠ‚ç‚¹æœ‰æ˜ç¡®çš„å±‚çº§ï¼Œå­èŠ‚ç‚¹åº”è¯¥æ¯”çˆ¶èŠ‚ç‚¹ä½ä¸€çº§
            const parentLevel = getNodeLevel(parent);
            if (parentLevel !== null && parentLevel >= 1 && parentLevel < 6) {
              const estimatedLevel = parentLevel + 1;
              return estimatedLevel;
            }
          }
        }
      }

      return null;
    }

    // å°†èŠ‚ç‚¹å¼ºåˆ¶è®¾ä¸ºåˆ—è¡¨ç±»å‹ï¼Œå¹¶å°½é‡ç»§æ‰¿åˆ—è¡¨æ ‡è¯†
    function forceListType(n, inheritFrom) {
      if (!n) return;
      const oldType = getNodeType(n);
      let ordered = false;
      let marker = '-';
      if (inheritFrom) {
        const inhData = inheritFrom.data || {};
        ordered = (inhData.ordered != null) ? inhData.ordered : (inheritFrom.ordered != null ? inheritFrom.ordered : false);
        marker = (inhData.marker != null) ? inhData.marker : (inheritFrom.marker != null ? inheritFrom.marker : (ordered ? '1.' : '-'));
      }
      n.type = 'list';
      n.ordered = ordered;
      n.marker = marker;
      if (!n.data) n.data = {};

      // ä¿®å¤ï¼šå¤„ç† jsMind çš„æ•°æ®ç»“æ„å˜åŒ–
      if (n.data.data) {
        // å¦‚æœå­˜åœ¨åµŒå¥—çš„ data ç»“æ„
        n.data.data.type = 'list';
        n.data.data.ordered = ordered;
        n.data.data.marker = marker;
      } else {
        // ä¼ ç»Ÿçš„æ•°æ®ç»“æ„
        n.data.type = 'list';
        n.data.ordered = ordered;
        n.data.marker = marker;
      }

      delete n.level;
      if (n.data) {
        if (n.data.data) {
          delete n.data.data.level;
        } else {
          delete n.data.level;
        }
      }
    }

    // å°†æŸèŠ‚ç‚¹åŠå…¶å…¨éƒ¨å­å­™å½’ä¸€ä¸ºåˆ—è¡¨ï¼ˆç”¨äºè¢«æŒ‚è½½åˆ°åˆ—è¡¨çˆ¶èŠ‚ç‚¹ä¹‹ä¸‹ï¼‰
    function normalizeSubtreeUnderList(rootId, parentNodeForInherit) {
      if (!jm) return;
      const root = jm.get_node(rootId);
      if (!root) return;

      const inheritFrom = parentNodeForInherit || (root.parent ? jm.get_node(root.parent.id) : null);

      const stack = [root];

      while (stack.length > 0) {
        const cur = stack.pop();
        forceListType(cur, inheritFrom);

        if (cur.children && cur.children.length) {
          for (const ch of cur.children) {
            if (ch) stack.push(ch);
          }
        }
      }
    }



    // æ ¹æ®åŒçº§ï¼ˆè‹¥æœ‰ï¼‰æˆ–çˆ¶èŠ‚ç‚¹ï¼ˆè‹¥æ— åŒçº§ï¼‰å¯¹é½å½“å‰èŠ‚ç‚¹ç±»å‹
    function applySiblingOrParentType(nodeOrId) {
      if (!jm) return;
      let node = null;
      if (nodeOrId && typeof nodeOrId === 'object' && nodeOrId.id) {
        node = nodeOrId;
      } else {
        node = jm.get_node(nodeOrId);
      }
      if (!node) return;

      // æ”¶é›†åŒçº§ï¼ˆæ’é™¤è‡ªå·±ï¼‰
      let siblings = [];
      if (node.parent) {
        const parentNode = jm.get_node(node.parent.id);
        if (parentNode && parentNode.children && parentNode.children.length > 0) {
          siblings = parentNode.children.filter(c => c && c.id !== node.id);
        }
      }

      // å‚è€ƒç±»å‹ï¼šä¼˜å…ˆåŒçº§çš„ç¬¬ä¸€ä¸ªæœ‰ç±»å‹çš„èŠ‚ç‚¹ï¼Œå¦åˆ™çˆ¶èŠ‚ç‚¹ç±»å‹
      let refType;
      let refLevel;

      if (siblings.length > 0) {
        for (const s of siblings) {
          const t = getNodeType(s);
          if (typeof t !== 'undefined') {
            refType = t;
            refLevel = getNodeLevel(s);
            break;
          }
        }
      }

      if (typeof refType === 'undefined' && siblings.length === 0 && node.parent) {
        const p = jm.get_node(node.parent.id);
        const pType = getNodeType(p);
        const pLevel = getNodeLevel(p) || 0;

        if (pType === undefined) {
          refType = 'list';
        } else {
          refType = (pType === 'heading' && pLevel >= 6) ? 'list' : pType;

          if (refType === 'heading') {
            if (pLevel >= 1) {
              refLevel = pLevel + 1;
            } else {
              if (p.topic && /^\d+$/.test(p.topic.trim())) {
                const parentTopicLevel = parseInt(p.topic.trim());
                if (parentTopicLevel >= 0 && parentTopicLevel < 6) {
                  refLevel = parentTopicLevel + 1;
                } else {
                  refLevel = 2;
                }
              } else {
                refLevel = 2;
              }
            }
          }
        }
      }

      if (typeof refType === 'undefined') return; // æ²¡æœ‰å¯å‚è€ƒç±»å‹åˆ™ä¸æ”¹
      const curType = getNodeType(node);
      const curLevel = getNodeLevel(node);

      if (curType !== refType) {
        setNodeType(node, refType);

        // å¦‚æœæ˜¯æ ‡é¢˜ç±»å‹ä¸”æœ‰å‚è€ƒå±‚çº§ï¼Œè®¾ç½®åˆé€‚çš„å±‚çº§
        if (refType === 'heading' && typeof refLevel !== 'undefined' && refLevel > 0) {
          setNodeLevel(node, refLevel);
        }

        // ç±»å‹å˜åŒ–åè§¦å‘ä¸€æ¬¡è½»é‡ä¿å­˜ï¼ˆä¸é¢å¤–è°ƒç”¨å…¨é‡åŒæ­¥ï¼‰
        debouncedSave();
      } else if (refType === 'heading' && typeof refLevel !== 'undefined' && curLevel !== refLevel) {
        // ç±»å‹ç›¸åŒä½†å±‚çº§ä¸åŒï¼Œè°ƒæ•´å±‚çº§
        setNodeLevel(node, refLevel);
        debouncedSave();
      }
    }

    // è®¾ç½®æ€ç»´å¯¼å›¾å˜åŒ–ç›‘å¬å™¨
    function setupMindmapChangeWatcher() {
      if (!jm) return;

      // ç›‘å¬jsMindçš„å„ç§å˜åŒ–äº‹ä»¶
      jm.add_event_listener(function (type, data) {
        // åªåœ¨ç‰¹å®šäº‹ä»¶ç±»å‹æ—¶è§¦å‘ä¿å­˜
        const saveEvents = [
          jsMind.event_type.edit,
          jsMind.event_type.add_node,
          jsMind.event_type.remove_node,
          jsMind.event_type.move_node,
          jsMind.event_type.move
        ];

        if (saveEvents.includes(type)) {
          // ä¸“é—¨å¤„ç† move_nodeï¼šç”¨äº‹ä»¶è¿”å›çš„ [nodeId, beforeId, parentId, direction] å…ˆå¼ºåˆ¶é‡æŒ‚è½½ï¼Œå†å½’ä¸€/ä¿å­˜
          try {
            if (type === jsMind.event_type.move_node && data && Array.isArray(data.data) && data.data.length >= 3) {
              const movedId = data.data[0];
              const beforeId = data.data.length > 1 ? data.data[1] : null;
              const newParentId = data.data[2];
              const direction = data.data.length > 3 ? data.data[3] : null;

              // æ‰¹é‡è·Ÿéšç§»åŠ¨ï¼šå¦‚æœå­˜åœ¨å¤šé€‰å¹¶ä¸”å½“å‰ç§»åŠ¨çš„æ˜¯å¤šé€‰é›†åˆä¸­çš„ä¸€ä¸ªï¼Œåˆ™æŠŠå…¶ä½™é€‰ä¸­èŠ‚ç‚¹ä¹Ÿç§»åŠ¨åˆ°ç›¸åŒçš„æ–°çˆ¶èŠ‚ç‚¹ï¼Œä¾æ¬¡è·Ÿåœ¨ movedId ä¹‹å
              try {
                if (!window.__batchMoving && typeof window.getMultiSelection === 'function') {
                  const selectedIds = window.getMultiSelection ? window.getMultiSelection() : [];
                  if (Array.isArray(selectedIds) && selectedIds.length > 1 && selectedIds.includes(movedId)) {
                    window.__batchMoving = true;
                    // å…ˆå°† movedId ä½œä¸ºé”šç‚¹ï¼Œä¹‹åçš„èŠ‚ç‚¹ä¾æ¬¡æ’å…¥åˆ°å®ƒåé¢
                    let anchorId = movedId;
                    for (const sid of selectedIds) {
                      if (!sid || sid === movedId) continue;
                      try {
                        // å°†å…¶ä»–èŠ‚ç‚¹ç§»åŠ¨åˆ°ä¸ movedId ç›¸åŒçš„æ–°çˆ¶èŠ‚ç‚¹ï¼Œå¹¶æ’åœ¨ anchorId åé¢
                        jm.move_node(sid, anchorId, newParentId, direction);
                        anchorId = sid;
                      } catch (eMoveBatch) {
                        // å¿½ç•¥æŸä¸ªèŠ‚ç‚¹ç§»åŠ¨å¤±è´¥ï¼Œç»§ç»­å…¶ä»–
                      }
                    }
                  }
                }
              } finally {
                // çŸ­æš‚å»¶è¿Ÿåè§£é™¤æ‰¹é‡æ ‡è®°ï¼Œå…è®¸åç»­æ­£å¸¸ move äº‹ä»¶
                setTimeout(() => { window.__batchMoving = false; }, 0);
              }

              // 1) å¼ºåˆ¶é‡æŒ‚è½½ï¼ˆç¡®ä¿ç»“æ„çœŸçš„å˜åŒ–ï¼‰
              try {
                jm.move_node(movedId, beforeId, newParentId, direction);
              } catch (eMove) {
                // å¿½ç•¥é‡æŒ‚è½½é”™è¯¯
              }

              // 2) å»¶åä¸€å¸§è¯»å–æœ€æ–°èŠ‚ç‚¹ä¸çˆ¶èŠ‚ç‚¹ï¼Œåšç±»å‹å¯¹é½ä¸åˆ—è¡¨å½’ä¸€ï¼Œå†ä¿å­˜
              setTimeout(() => {
                try {
                  const fresh = jm.get_node(movedId);
                  const parentNode = jm.get_node(newParentId);

                  if (fresh) {
                    applySiblingOrParentType(fresh, parentNode);

                    if (parentNode && typeof getNodeType === 'function') {
                      const parentType = getNodeType(parentNode);
                      // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºåˆ—è¡¨ç±»å‹ï¼Œæˆ–è€…çœ‹èµ·æ¥åƒæ˜¯åˆ—è¡¨ï¼ˆæœ‰åˆ—è¡¨ç‰¹å¾ï¼‰
                      const hasListFeatures = parentNode.data && (parentNode.data.listMarker || parentNode.data.marker || parentNode.data.listLevel !== undefined);

                      if (parentType === 'list' || (parentType === undefined && hasListFeatures)) {
                        normalizeSubtreeUnderList(movedId, parentNode);
                      }
                    }
                  }

                  debouncedSave();
                } catch (eLater) {
                  console.warn('move_node å»¶åå¤„ç†å¤±è´¥:', eLater);
                }
              }, 0);
            }
          } catch (e0) {
            console.warn('åŸºäºè¿”å›IDå¤„ç† move_node å¤±è´¥:', e0);
          }

          // å°è¯•è·å–å—å½±å“èŠ‚ç‚¹å¯¹è±¡ï¼ˆå…¼å®¹å¤šç§äº‹ä»¶æ•°æ®å½¢æ€ï¼‰
          let node = null;
          try {
            // 1) å¸¸è§ï¼šdata.node å¯èƒ½æ˜¯å¯¹è±¡æˆ– id
            let maybe = data && (data.node != null ? data.node : null);
            // 2) move äº‹ä»¶æœ‰æ—¶ç›´æ¥æŠŠèŠ‚ç‚¹å¯¹è±¡æ”¾åœ¨ data ä¸Š
            if (!maybe && data && typeof data === 'object' && data.id) {
              maybe = data;
            }
            // 3) å¦‚æœ maybe æ˜¯ id å­—ç¬¦ä¸²
            if (maybe && typeof maybe === 'string') {
              node = jm.get_node(maybe);
            } else if (maybe && typeof maybe === 'object' && maybe.id) {
              node = maybe;
            }
            // 4) å…œåº•ï¼šç”¨å½“å‰é€‰ä¸­èŠ‚ç‚¹
            if (!node) {
              const sel = jm.get_selected_node && jm.get_selected_node();
              if (sel) {
                node = typeof sel === 'string' ? jm.get_node(sel) : sel;
              }
            }
          } catch (e) {
            console.warn('äº‹ä»¶æ•°æ®ä¸­æ— æ³•è§£æèŠ‚ç‚¹:', e);
          }

          // ç±»å‹å¯¹é½ï¼šå»¶ååˆ°ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯ï¼Œç¡®ä¿jsMindå·²æ›´æ–°çˆ¶å­å…³ç³»
          if (node) {
            setTimeout(() => {
              try {
                const fresh = jm.get_node(node.id);
                if (!fresh) return;

                // è·å–çˆ¶èŠ‚ç‚¹
                const parentNode = fresh.parent ? jm.get_node(fresh.parent.id) : null;
                applySiblingOrParentType(fresh, parentNode);

                // è‹¥çˆ¶ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨ï¼ˆå…œåº•ï¼Œé˜²æ­¢æœªèµ°APIåŒ…è£…ï¼‰
                try {
                  const p = fresh.parent ? jm.get_node(fresh.parent.id) : null;
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(fresh.id, p);
                  }
                } catch (e2) {
                  // å¿½ç•¥å½’ä¸€åŒ–é”™è¯¯
                }

                debouncedSave();
              } catch (e3) {
                console.warn('å»¶åå¤„ç†å¤±è´¥:', e3);
              }
            }, 0);
          }
        }
      });
    }


    // ç›‘å¬localStorageå˜åŒ–ï¼ˆåŒ…æ‹¬åŒä¸€é¡µé¢å†…çš„ä¿®æ”¹ï¼‰
    let lastStorageData = null;
    let storageCheckTimer = null;
    let lastChangeTime = 0;

    // æ£€æŸ¥localStorageæ•°æ®æ˜¯å¦å˜åŒ–çš„å‡½æ•°ï¼ˆå¸¦é˜²æŠ–ï¼‰
    function checkLocalStorageChange() {
      const now = Date.now();
      if (window.__mindmapSelfUpdateUntil && now < window.__mindmapSelfUpdateUntil) {
        return;
      }

      let currentData;
      try {
        currentData = localStorage.getItem('mindword_nodetree_data');
      } catch (e) {
        return;
      }

      // è‹¥ä¸ºæœ¬é¡µè‡ªå‘å†™å…¥ï¼Œæ¶ˆè´¹ä¸€æ¬¡æŠ‘åˆ¶è®¡æ•°å¹¶è·³è¿‡åˆ·æ–°
      if (window.__mindmapSuppressCount && window.__mindmapSuppressCount > 0) {
        window.__mindmapSuppressCount--;
        lastStorageData = currentData;
        return;
      }

      if (currentData !== lastStorageData) {
        lastStorageData = currentData;
        lastChangeTime = now;

        // é˜²æŠ–å¤„ç†ï¼šå»¶è¿Ÿ500msæ‰§è¡Œï¼Œé¿å…é¢‘ç¹åˆ·æ–°
        clearTimeout(storageCheckTimer);
        storageCheckTimer = setTimeout(() => {
          try {
            loadNodeTree();
          } catch (e) {
            // å¿½ç•¥é‡æ–°åŠ è½½é”™è¯¯
          }
        }, 500);
      }
    }


    // è®¾ç½®localStorageå˜åŒ–ç›‘å¬å™¨
    function setupLocalStorageWatcher() {
      // ä¿å­˜åˆå§‹æ•°æ®
      lastStorageData = localStorage.getItem('mindword_nodetree_data');

      // ä½¿ç”¨setIntervalå®šæœŸæ£€æŸ¥å˜åŒ–ï¼ˆæ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼‰
      setInterval(checkLocalStorageChange, 500);

      // åŒæ—¶ç›‘å¬storageäº‹ä»¶ï¼ˆå¤„ç†å…¶ä»–é¡µé¢çš„å˜åŒ–ï¼‰
      window.addEventListener('storage', function (e) {
        if (e.key === 'mindword_nodetree_data') {
          checkLocalStorageChange();
        }
      });

      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºåŒä¸€é¡µé¢å†…çš„é€šçŸ¥ï¼‰
      window.addEventListener('mindwordDataUpdated', function () {
        checkLocalStorageChange();
      });
    }

    // ä¸‹è½½æ€ç»´å¯¼å›¾ä¸ºå›¾ç‰‡
    function downloadMindmap() {
      if (!jm) return;
      try {
        jm.shoot();
      } catch (error) {
        // é™é»˜å¤„ç†ä¸‹è½½é”™è¯¯
      }
    }



    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', async function () {
      // åˆå§‹åŒ–è½¬æ¢å™¨
      try {
        if (!window.converter) {
          const module = await import('../converter/converter.js');
          window.converter = new module.ConverterManager();
          // å¹¿æ’­å°±ç»ªäº‹ä»¶ï¼ˆä¾›éœ€è¦æ—¶ç›‘å¬ï¼‰
          window.dispatchEvent(new Event('converterReady'));
        }
      } catch (error) {
        // å¿½ç•¥è½¬æ¢å™¨åˆå§‹åŒ–é”™è¯¯
      }

      initMindmap();
      setupLocalStorageWatcher();
      setupMindmapChangeWatcher();
      // å¯ç”¨æ¡†é€‰å¤šé€‰
      setupBoxSelection();

      // åˆå§‹åŒ–AIæ‰©å†™åŠŸèƒ½
      if (window.AIExpander) {
        window.aiExpander = new window.AIExpander();
        window.aiExpander.init(jm);
      }
    });



  </script>
</body>

</html>