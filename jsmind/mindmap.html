<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="../jsmind-local/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="tree-operator.js"></script>
  <script src="ai-handler.js"></script>
  <script src="../utils/html-to-markdown.js"></script>


  <link rel="stylesheet" href="mindmap.css">
  <style>
    .requires-single-selection {
      display: none !important;
    }

    .requires-single-selection.visible {
      display: inline-block !important;
    }
  </style>
</head>

</head>

<body>
  <div class="toolbar">
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->

    <!-- æ’¤é”€é‡åšæŒ‰é’® -->
    <span class="ico-btn" role="button" onclick="undoMindmap()" tabindex="0" title="æ’¤é”€"
      style="--ico: url('res/undo.svg'); "></span>
    <span class="ico-btn" role="button" onclick="redoMindmap()" tabindex="0" title="é‡åš"
      style="--ico: url('res/redo.svg'); "></span>

    <span class="ico-btn" role="button" onclick="downloadMindmap()" tabindex="0" title="ä¸‹è½½å›¾ç‰‡"
      style="--ico: url('res/download.svg'); "></span>
    <!-- å…ˆåœ¨æ§åˆ¶å°æ‰§è¡Œ jm.screenshot.setWhiteBackground(true) å†ä¸‹è½½ä¼šä¸‹è½½ç™½åº•ï¼›æ¢å¤é€æ˜åº•æ‰§è¡Œ falseã€‚ -->

    <span class="ico-btn" role="button" onclick="exportData()" tabindex="0" title="æŸ¥çœ‹JSON"
      style="--ico: url('res/code.svg'); "></span>
    <!-- éšè—AIç”Ÿæˆåˆå§‹æ ‘æŒ‰é’®ï¼Œä½†ä¿ç•™åŠŸèƒ½ä¾›åˆ›å»ºæ–°æ–‡æ¡£æ—¶è°ƒç”¨ -->
    <!-- <span class="ico-btn" role="button" onclick="handleAIGenerateInitialTree()" tabindex="0" title="AIç”Ÿæˆåˆå§‹æ ‘ï¼ˆç»„ä»¶è°ƒç”¨ï¼‰"
      style="--ico: url('../res/ç”Ÿæˆåˆå§‹æ ‘.svg');"></span> -->
    <span class="ico-btn" role="button" onclick="showAIGenerateInitialTreeModal()" tabindex="0" title="AIç”Ÿæˆåˆå§‹æ ‘"
      style="--ico: url('../res/ç”Ÿæˆåˆå§‹æ ‘.svg');"></span>
    <!-- é…ç½®æŒ‰é’® -->
    <span class="ico-btn" role="button" onclick="openConfigModal()" tabindex="0" title="é…ç½®"
      style="--ico: url('res/setting.svg'); "></span>

    <!-- AI å¿«æ·æ“ä½œ -->
    <div id="aiQuickActions" style="display:inline-flex;gap:8px;align-items:center;">
      <span style="color: gainsboro;"> | </span>
      <span class="ico-btn requires-single-selection" role="button" onclick="addSubtree()" tabindex="0" title="æ·»åŠ å­æ ‘"
        style="--ico: url('../res/æ·»åŠ å­æ ‘.svg');"></span>
      <span class="ico-btn requires-single-selection" role="button" onclick="aiCreateChild()" tabindex="0" title="åˆ›å»ºå­çº§"
        style="--ico: url('../res/æ·»åŠ å­çº§.svg');"></span>
      <span class="ico-btn requires-single-selection" role="button" onclick="aiCreateSibling()" tabindex="0"
        title="åˆ›å»ºåŒçº§" style="--ico: url('../res/æ·»åŠ åŒçº§.svg');"></span>
      <span class="ico-btn requires-single-selection" role="button" onclick="aiExpandNotes()" tabindex="0" title="æ‰©å†™å¤‡æ³¨"
        style="--ico: url('../res/æ‰©å†™å¤‡æ³¨.svg');"></span>
      <span class="ico-btn requires-single-selection" role="button" onclick="quickModifyNode()" tabindex="0" title="ä¿®æ”¹"
        style="--ico: url('../res/edit.svg');"></span>
      <span class="ico-btn" role="button" onclick="quickDeleteNode()" tabindex="0" title="åˆ é™¤èŠ‚ç‚¹"
        style="--ico: url('../res/åˆ é™¤.svg');"></span>

    </div>


    <!-- å›¾æ ‡é€‰æ‹©å™¨ä¸‹æ‹‰èœå•ï¼ˆå·²å®šåˆ¶ï¼šéšè—é»˜è®¤ caretã€åªä¿ç•™ç½‘æ ¼å†…ç¬¬ä¸€ä¸ªâ€œæ¸…é™¤â€æŒ‰é’®ï¼‰ -->
    <style>
      /* éšè— Bootstrap çš„ä¸‹æ‹‰å°ç®­å¤´å¹¶å»æ‰å¯èƒ½çš„èšç„¦åŠ¨ç”»/outline */
      #iconPickerBtn.dropdown-toggle::after {
        display: none !important;
      }

      #iconPickerBtn:focus {
        outline: none !important;
        box-shadow: none !important;
      }

      /* å·¥å…·æ å†…å›¾æ ‡æŒ‰é’®ä¿è¯ emoji å¯è§ */
      #iconGridToolbar .icon-picker-item {
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", system-ui, sans-serif;
        color: #222 !important;
        font-size: 20px !important;
        line-height: 1;
        padding: 0;
        background: white !important;
      }

      /* å»æ‰ä¸‹æ‹‰èœå•è‡ªèº«çš„åŠ¨ç”»ï¼ˆè‹¥å­˜åœ¨ï¼‰ */
      #iconPickerDropdown .dropdown-menu {
        transition: none !important;
        -webkit-transition: none !important;
        -moz-transition: none !important;

      }
    </style>

    <!-- å±‚çº§å±•å¼€æŒ‰é’®æ ·å¼ -->
    <style>
      .level-expand-btn {
        background: white;
        border: 1px solid #d1d5db;
        color: #374151;
        padding: 4px 8px;
        font-size: 12px;
        font-weight: 500;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 20px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .level-expand-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #111827;
      }

      .level-expand-btn:active {
        background: #e5e7eb;
        border-color: #6b7280;
      }

      #expandLevelButtons {
        margin-left: 8px;
      }

      /* é¢åŒ…å±‘å¯¼èˆªæ ·å¼ */
      #drilldown-breadcrumb .breadcrumb {
        background: transparent;
        margin: 0;
        padding: 0;
        font-size: 12px;
      }

      #drilldown-breadcrumb .breadcrumb-item a {
        color: #4b5563;
        text-decoration: none;
        padding: 2px 6px;
        border-radius: 3px;
        transition: background-color 0.2s ease;
      }

      #drilldown-breadcrumb .breadcrumb-item a:hover {
        background-color: #f3f4f6;
        color: #111827;
      }

      #drilldown-breadcrumb .breadcrumb-item.active {
        color: #111827;
        font-weight: 500;
        padding: 2px 6px;
      }

      #drilldown-breadcrumb .breadcrumb-item+.breadcrumb-item::before {
        content: "/";
        color: #9ca3af;
        padding: 0 4px;
      }
    </style>

    <div class="dropdown" id="iconPickerDropdown" style="display: inline-block;">

      <span id="iconPickerBtn" class="ico-btn dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true"
        aria-expanded="false" title="é€‰æ‹©å›¾æ ‡" tabindex="0" style="--ico: url('res/tag.svg');"></span>
      <div class="dropdown-menu" aria-labelledby="iconPickerBtn"
        style="width: 360px; max-height: 420px; overflow-y: auto; overflow-x: hidden;">
        <div style="padding: 12px;">
          <h6 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">é€‰æ‹©å›¾æ ‡</h6>
          <div id="iconGridToolbar"
            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding-bottom:8px; box-sizing: border-box; column-gap:6px;">
            <!-- å›¾æ ‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆï¼ˆç¬¬ä¸€ä¸ªä¸ºæ¸…é™¤ï¼‰ -->
          </div>
        </div>
        <!-- å·²ç§»é™¤é‡å¤çš„åº•éƒ¨æ¸…é™¤æŒ‰é’®ï¼ˆä»…ä¿ç•™ç½‘æ ¼ä¸­çš„ç¬¬ä¸€ä¸ªæ¸…é™¤æŒ‰é’®ï¼‰ -->
      </div>
    </div>

    <!-- å±‚çº§å±•å¼€æŒ‰é’® -->
    <div id="expandLevelButtons" style="display:inline-flex;gap:4px;align-items:center;margin-left:8px;">
      <span style="color: gainsboro;"> | </span>
      <button class="level-expand-btn" onclick="expandToLevel(1)" title="å±•å¼€åˆ°ç¬¬1çº§">1</button>
      <button class="level-expand-btn" onclick="expandToLevel(2)" title="å±•å¼€åˆ°ç¬¬2çº§">2</button>
      <button class="level-expand-btn" onclick="expandToLevel(3)" title="å±•å¼€åˆ°ç¬¬3çº§">3</button>
      <button class="level-expand-btn" onclick="expandToLevel(4)" title="å±•å¼€åˆ°ç¬¬4çº§">4</button>
      <button class="level-expand-btn" onclick="expandToLevel(5)" title="å±•å¼€åˆ°ç¬¬5çº§">5</button>
      <button class="level-expand-btn" onclick="expandToLevel('all')" title="å±•å¼€å…¨éƒ¨">all</button>
    </div>

    <!-- ä¸‹é’»åŠŸèƒ½æŒ‰é’® -->
    <div id="drilldownButtons" style="display:inline-flex;gap:4px;align-items:center;margin-left:8px;">
      <span style="color: gainsboro;"> | </span>
      <button id="drilldown-btn" class="level-expand-btn" onclick="viewStateManager.handleDrillDown()" title="ä¸‹é’»åˆ°é€‰ä¸­èŠ‚ç‚¹"
        disabled>
        â†“
      </button>
      <button id="return-btn" class="level-expand-btn" onclick="viewStateManager.handleReturn()" title="è¿”å›åˆ°ä¸Šä¸€çº§"
        disabled>
        â†‘
      </button>
    </div>





    <!-- batchOperations ä¿ç•™åœ¨ DOM ä¸­ä½†ä¼šè¢«ç§»åŠ¨åˆ°ç”»å¸ƒå·¦ä¸Šï¼ˆé€šè¿‡è„šæœ¬åœ¨éç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ -->
    <div id="batchOperations"
      style="display: none; float: right; padding: 1px 6px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; ">å·²é€‰ä¸­ <span id="selectedCount">0</span>
        ä¸ªèŠ‚ç‚¹</span>
    </div>

    <!-- å³ä¾§ä¸‰ä¸ªç®€å•å¤é€‰æ¡†ï¼šè¯¦æƒ…é¢æ¿ / æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹ / æ˜¾ç¤ºåˆ—è¡¨èŠ‚ç‚¹ -->
    <div id="toolbarToggles"
      style="margin-left:auto;display:flex;gap:12px;align-items:flex-end;justify-content:flex-end;">
      <span id="toggleQuickAIBtn" class="ico-btn state-off" role="button" tabindex="0" aria-pressed="false"
        title="å¿«é€ŸAIç”Ÿæˆï¼šå¼€å¯æ—¶å°†å…³é—­AIå¼¹çª—ï¼Œç›´æ¥ç”Ÿæˆå†…å®¹" style="--ico: url('res/kuaisu.svg'); "></span>
      <span id="toggleNodeDetailsBtn" class="ico-btn state-on" role="button" tabindex="0" aria-pressed="true"
        title="è¯¦æƒ…é¢æ¿" style="--ico: url('res/detail.svg'); "></span>
      <span id="help-btn" class="ico-btn" role="button" tabindex="0" title="å¸®åŠ©"
        style="--ico: url('../res/help.svg'); "></span>
      <label class="mw-toggle-showtype"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowNodeTypeCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">æ˜¾ç¤ºç±»å‹</span>
      </label>
      <label class="mw-toggle-showtitleonly"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowListNodesCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">åªçœ‹æ ‡é¢˜</span>
      </label>
    </div>





  </div>

  <div class="main-container">
    <!-- ä¸‹é’»é¢åŒ…å±‘å¯¼èˆª -->
    <div id="drilldown-breadcrumb"
      style="display:none; position: absolute; top: 10px; left: 10px; z-index: 1000; background: transparent; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500;">
    </div>
    <div id="fullScreenMindmap"></div>
    <!-- æµ®åŠ¨èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ï¼ˆå¯å…³é—­ï¼‰ï¼Œä¿ç•™å†…éƒ¨å­—æ®µå’ŒåŠŸèƒ½ -->
    <div id="nodeDetails" role="dialog" aria-hidden="true" aria-label="èŠ‚ç‚¹è¯¦æƒ…">
      <div class="panel-header">
        <strong>èŠ‚ç‚¹è¯¦æƒ…</strong>
        <button class="panel-close-btn" aria-label="å…³é—­èŠ‚ç‚¹è¯¦æƒ…" onclick="hideNodeDetails()">âœ•</button>
      </div>

      <div id="nodeDetailsEmpty" style="display:none; padding:24px; text-align:center; color:#64748b;">
        <img src="../res/empty.svg" alt="ç©ºçŠ¶æ€" style="width:72px;height:72px;opacity:0.9;margin-bottom:12px;">
        <div>è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>
      </div>

      <div id="nodeDetailsForm">
        <div id="nodeInfo"></div>

        <div style="margin-bottom: 15px;margin-top: 10px; display: flex; gap: 10px;">
          <span class="ico-btn requires-single-selection" role="button" onclick="addSubtree()" tabindex="0"
            title="æ·»åŠ å­æ ‘" style="--ico: url('../res/æ·»åŠ å­æ ‘.svg');"></span>
          <span class="ico-btn requires-single-selection" role="button" onclick="aiCreateChild()" tabindex="0"
            title="åˆ›å»ºå­çº§" style="--ico: url('../res/æ·»åŠ å­çº§.svg');"></span>
          <span class="ico-btn requires-single-selection" role="button" onclick="aiCreateSibling()" tabindex="0"
            title="åˆ›å»ºåŒçº§" style="--ico: url('../res/æ·»åŠ åŒçº§.svg');"></span>
          <span class="ico-btn requires-single-selection" role="button" onclick="aiExpandNotes()" tabindex="0"
            title="æ‰©å†™å¤‡æ³¨" style="--ico: url('../res/æ‰©å†™å¤‡æ³¨.svg');"></span>
          <span class="ico-btn" role="button" onclick="quickDeleteNode()" tabindex="0" title="åˆ é™¤èŠ‚ç‚¹"
            style="--ico: url('../res/åˆ é™¤.svg');"></span>
          <span class="ico-btn" role="button"
            onclick="(function(){try{function genId(){return 'r_'+Math.random().toString(36).slice(2,10);}var requestId=genId();var payload={initialView:'config',platformConfig:{},modelConfig:{},options:{},mode:'mini'};if(typeof window.openAIServiceModal==='function'){try{window.openAIServiceModal(Object.assign({},payload,{requestId:requestId}));return;}catch(e){console.warn('openAIServiceModal failed',e);} }try{window.parent.postMessage({type:'AI_MODAL_OPEN',requestId:requestId,payload:payload},'*');}catch(e){console.error('send AI config open request failed',e);} }catch(e){console.warn(e);} })()"
            tabindex="0" title="AIé…ç½®" style="--ico: url('../res/setting.svg');"></span>
          <!-- <button class="btn"
            onclick="(function(){try{function genId(){return 'r_'+Math.random().toString(36).slice(2,10);}var requestId=genId();var payload={initialView:'config',platformConfig:{},modelConfig:{},options:{},mode:'mini'};if(typeof window.openAIServiceModal==='function'){try{window.openAIServiceModal(Object.assign({},payload,{requestId:requestId}));return;}catch(e){console.warn('openAIServiceModal failed',e);} }try{window.parent.postMessage({type:'AI_MODAL_OPEN',requestId:requestId,payload:payload},'*');}catch(e){console.error('send AI config open request failed',e);} }catch(e){console.warn(e);} })()"
            style="flex: 0 0 40px; background: #ffffff;" title="AIé…ç½®">âš™ï¸</button> -->
        </div>

        <div class="form-group">
          <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
          <textarea id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜..." rows="3"
            style="width:100%; resize:vertical; line-height:1.4em;"></textarea>
        </div>

        <div class="form-group">
          <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
          <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
        </div>



        <!-- è‡ªåŠ¨æ›´æ–°æç¤º -->
        <div id="autoUpdateIndicator"
          style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
          <span style="display: inline-block; animation: pulse 1s ease-in-out;">âœ“</span> å·²è‡ªåŠ¨æ›´æ–°
        </div>

      </div>

      <!-- é€šçŸ¥æ¡¥æ¥å™¨ -->
      <script src="../notification-bridge.js"></script>

    </div>
  </div>
  </div>

  <script src="../jsmind-local/jsmind.js"></script>
  <script src="../jsmind-local/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <!-- ä½¿ç”¨ä¸jsMind 0.5.7ç‰ˆæœ¬åŒ¹é…çš„æˆªå›¾æ’ä»¶ -->
  <script src="../jsmind-local/jsmind.screenshot.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script src="plugins/undo_manager.js"></script>




  <script src="icons.js"></script>
  <!-- <script src="node-ultils.js"></script> -->
  <script src="node-operator.js"></script>
  <script src="ViewStateManager.js"></script>
  <script type="module" src="mindmap-core.js"></script>
  <script>

    /* mindmap-ui.js - UI related extracted scripts */

    // ç®€æ˜“ä¿®æ”¹/åˆ é™¤ï¼ˆå ä½å®ç°ï¼‰
    function quickModifyNode() {
      try {
        var sel = jm.get_selected_node && jm.get_selected_node();
        if (!sel) { showWarning && showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹'); return; }

        // æ— è®ºå¼€å…³æ˜¯å¦å¼€å¯ï¼Œéƒ½æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…é¢æ¿
        try {
          // å…ˆæ˜¾ç¤ºé¢æ¿
          if (typeof showNodeDetailsPanel === 'function') {
            showNodeDetailsPanel();
          }
          // å†æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…å†…å®¹
          // ä¸´æ—¶ç»•è¿‡è¯¦æƒ…å¼€å…³é™åˆ¶ï¼Œç¡®ä¿èƒ½æ˜¾ç¤ºå†…å®¹
          var __prevBypass = window.__bypassDetailsGuard;
          try {
            window.__bypassDetailsGuard = true;
            if (typeof window.showNodeDetails === 'function') {
              window.showNodeDetails(sel);
            } else if (typeof showNodeDetails === 'function') {
              showNodeDetails(sel);
            }
          } finally {
            window.__bypassDetailsGuard = __prevBypass;
          }
          // ç”¨æˆ·ä¸»åŠ¨æ‰“å¼€è¯¦æƒ…åï¼Œè‡ªåŠ¨å¼€å¯â€œè¯¦æƒ…é¢æ¿â€å¼€å…³å¹¶åŒæ­¥ UI
          try {
            window.__nodeDetailsEnabled = true;
            var cb = document.getElementById('toggleNodeDetailsCheckbox');
            if (cb) {
              cb.checked = true;
              cb.setAttribute('aria-checked', 'true');
            }
            var btn = document.getElementById('toggleNodeDetailsBtn');
            if (btn) {
              btn.classList.remove('state-off', 'state-default');
              btn.classList.add('state-on');
              btn.setAttribute('aria-pressed', 'true');
            }
          } catch (e) { /* ignore */ }
        } catch (e) {
          console.warn('æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…å¤±è´¥:', e);
        }
      } catch (e) {
        showError && showError('ä¿®æ”¹å¤±è´¥');
      }
    }
    function quickDeleteNode() {
      try {
        var selectedNodes = (typeof window.getMultiSelection === 'function') ? window.getMultiSelection() : [];
        if (selectedNodes.length > 1) {
          if (confirm('ç¡®è®¤åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„ ' + selectedNodes.length + ' ä¸ªèŠ‚ç‚¹ï¼Ÿ')) {
            selectedNodes.forEach(function (nodeId) {
              jm.remove_node(nodeId);
            });
            try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (_) { }
          }
        } else {
          var sel = jm.get_selected_node && jm.get_selected_node();
          if (!sel) { showWarning && showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹'); return; }
          if (confirm('ç¡®è®¤åˆ é™¤è¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹ï¼Ÿ')) {
            jm.remove_node(sel.id);
            try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (_) { }
          }
        }
      } catch (e) { showError && showError('åˆ é™¤å¤±è´¥'); }
    }

    // æ·»åŠ å­æ ‘åŠŸèƒ½
    function addSubtree() {
      try {
        var sel = jm.get_selected_node && jm.get_selected_node();
        if (!sel) { showWarning && showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹'); return; }
        
        // æ˜¾ç¤ºæ·»åŠ å­æ ‘å¼¹çª—
        showAddSubtreeModal();
      } catch (e) {
        showError && showError('æ·»åŠ å­æ ‘å¤±è´¥');
      }
    }

    // æ’¤é”€é‡åšåŠŸèƒ½å®ç°
    function undoMindmap() {
      try {
        if (window.undoManager && typeof window.undoManager.undo === 'function') {
          const result = window.undoManager.undo();
          if (result) {
            showInfo && showInfo('å·²æ’¤é”€');
          } else {
            showInfo && showInfo('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
          }
        } else {
          console.warn('æ’¤é”€ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          showInfo && showInfo('æ’¤é”€åŠŸèƒ½æš‚ä¸å¯ç”¨');
        }
      } catch (e) {
        console.error('æ’¤é”€å¤±è´¥:', e);
        showError && showError('æ’¤é”€å¤±è´¥');
      }
    }

    function redoMindmap() {
      try {
        if (window.undoManager && typeof window.undoManager.redo === 'function') {
          const result = window.undoManager.redo();
          if (result) {
            showInfo && showInfo('å·²é‡åš');
          } else {
            showInfo && showInfo('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ');
          }
        } else {
          console.warn('æ’¤é”€ç®¡ç†å™¨æœªåˆå§‹åŒ–');
          showInfo && showInfo('é‡åšåŠŸèƒ½æš‚ä¸å¯ç”¨');
        }
      } catch (e) {
        console.error('é‡åšå¤±è´¥:', e);
        showError && showError('é‡åšå¤±è´¥');
      }
    }

    function openConfigModal() {
      try {
        // ä½¿ç”¨ä¸èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ä¸­é…ç½®å›¾æ ‡ç›¸åŒçš„åŠŸèƒ½
        (function () { try { function genId() { return 'r_' + Math.random().toString(36).slice(2, 10); } var requestId = genId(); var payload = { initialView: 'config', platformConfig: {}, modelConfig: {}, options: {}, mode: 'mini' }; if (typeof window.openAIServiceModal === 'function') { try { window.openAIServiceModal(Object.assign({}, payload, { requestId: requestId })); return; } catch (e) { console.warn('openAIServiceModal failed', e); } } try { window.parent.postMessage({ type: 'AI_MODAL_OPEN', requestId: requestId, payload: payload }, '*'); } catch (e) { console.error('send AI config open request failed', e); } } catch (e) { console.warn(e); } })();
      } catch (e) { showError && showError('æ‰“å¼€é…ç½®å¤±è´¥'); }
    }


    // éšè—/æ˜¾ç¤ºæµ®åŠ¨é¢æ¿çš„ APIï¼ˆä¾› showNodeDetails è°ƒç”¨ï¼‰
    function hideNodeDetails() {
      const p = document.getElementById('nodeDetails');
      if (p) {
        p.style.display = 'none';
        p.setAttribute('aria-hidden', 'true');
        // å®‰å…¨ç§»é™¤æ‹–æ‹½ç›‘å¬ï¼ˆè‹¥åœ¨é—­åŒ…ä¸­å®šä¹‰åˆ™ä¸ä¼šæŠ›é”™ï¼‰
        if (typeof removeNodeDetailsDragHandlers === 'function') {
          try { removeNodeDetailsDragHandlers(); } catch (e) { /* ignore */ }
        } else if (typeof window.removeNodeDetailsDragHandlers === 'function') {
          try { window.removeNodeDetailsDragHandlers(); } catch (e) { /* ignore */ }
        }
      }
      // åŒæ­¥å…³é—­â€œè¯¦æƒ…é¢æ¿â€å¼€å…³ï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨å†å¼€å¯
      try {
        window.__nodeDetailsEnabled = false;
        const cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.checked = false;
          cb.setAttribute('aria-checked', 'false');
        }
        const btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.classList.remove('state-on');
          btn.classList.remove('state-default');
          btn.classList.add('state-off');
          btn.setAttribute('aria-pressed', 'false');
        }
      } catch (e) { /* ignore */ }
    }
    function showNodeDetailsPanel() {
      const p = document.getElementById('nodeDetails');
      if (p) {
        p.style.display = 'block';
        p.setAttribute('aria-hidden', 'false');
        // æå‡å±‚çº§ï¼Œç›–è¿‡æ‚¬æµ®åœ†å½¢æŒ‰é’®
        p.style.zIndex = '10010';
        // ä»…å½“é¢æ¿æœªè¢«ç”¨æˆ·ç§»åŠ¨è¿‡æ—¶ï¼Œæ‰é‡ç½®ä¸ºé»˜è®¤é å³ä½ç½®
        if (p.dataset.moved !== 'true') {
          p.style.right = '12px';
          p.style.left = 'auto';
          p.style.top = '80px';
        }
        // åˆå§‹åŒ–æ‹–æ‹½ç›‘å¬ï¼ˆå¹‚ç­‰ï¼‰
        try {
          if (typeof initNodeDetailsDragHandlers === 'function') {
            initNodeDetailsDragHandlers();
          } else if (typeof window.initNodeDetailsDragHandlers === 'function') {
            window.initNodeDetailsDragHandlers();
          }
        } catch (e) { /* ignore */ }
      }
    }

    /* æ‰“å¼€è¯¦æƒ…é¢æ¿å¹¶æç¤ºâ€œè¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹â€ */
    function showEmptyDetailsPrompt() {
      try {
        if (window.__nodeDetailsEnabled === false) {
          try { console.log('[MW][details][UI] skip empty: toggle disabled'); } catch (e) { }
          return;
        }
        // ç¡®ä¿é¢æ¿å¯è§
        try { showNodeDetailsPanel(); } catch (e) { try { console.warn('[MW][details][UI] showNodeDetailsPanel failed', e); } catch (ee) { } }
        var panel = document.getElementById('nodeDetails');
        var empty = document.getElementById('nodeDetailsEmpty');
        var form = document.getElementById('nodeDetailsForm');
        var info = document.getElementById('nodeInfo');
        var topic = document.getElementById('nodeTopic');
        var notes = document.getElementById('nodeNotes');

        // åˆ‡æ¢ä¸ºç©ºçŠ¶æ€ï¼šæ˜¾ç¤ºç©ºè§†å›¾ï¼Œéšè—è¡¨å•
        if (empty) empty.style.display = 'block';
        if (form) form.style.display = 'none';

        if (topic) topic.value = '';
        if (notes) notes.value = '';

        // å…³é”®æ—¥å¿—ï¼šè¾“å‡ºå„å…ƒç´ ä¸å¯è§æ€§
        try {
          console.log('[MW][details][UI] showEmptyDetailsPrompt:',
            {
              panelExists: !!panel,
              panelDisplay: panel && panel.style ? panel.style.display : undefined,
              panelAriaHidden: panel ? panel.getAttribute('aria-hidden') : undefined,
              emptyExists: !!empty,
              emptyDisplay: empty && empty.style ? empty.style.display : undefined,
              formExists: !!form,
              formDisplay: form && form.style ? form.style.display : undefined
            }
          );
        } catch (e) { }
      } catch (e) {
        try { console.warn('[MW][details][UI] showEmptyDetailsPrompt error', e); } catch (ee) { }
      }
    }

    try { window.showEmptyDetailsPrompt = showEmptyDetailsPrompt; } catch (e) { /* ignore */ }

    // æ˜¾ç¤ºæ€ç»´å¯¼å›¾å¸®åŠ©é¢æ¿ï¼ˆæ˜¾ç¤ºç¼–è¾‘å™¨çš„å¸®åŠ©å†…å®¹ï¼‰
    function showMindmapHelp() {
      // åˆ›å»ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.style.cssText = [
        'position: fixed',
        'top: 0',
        'left: 0',
        'width: 100%',
        'height: 100%',
        'background-color: rgba(0, 0, 0, 0.5)',
        'display: flex',
        'align-items: center',
        'justify-content: center',
        'z-index: 10000',
        'opacity: 0',
        'visibility: hidden',
        'transition: all 0.3s ease'
      ].join(';');

      const modalContent = document.createElement('div');
      modalContent.style.cssText = [
        'background-color: #fff',
        'padding: 24px',
        'max-width: 600px',
        'max-height: 80vh',
        'overflow-y: auto',
        'box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3)',
        'transform: scale(0.9)',
        'transition: transform 0.3s ease',
        'position: relative',
        'margin: 0 auto'
      ].join(';');

      const modalHeader = document.createElement('div');
      modalHeader.style.cssText = [
        'margin-bottom: 16px',
        'display: flex',
        'align-items: center',
        'justify-content: space-between'
      ].join(';');

      const modalTitle = document.createElement('h2');
      modalTitle.textContent = 'ğŸ“š ç¼–è¾‘å™¨å¸®åŠ©æ–‡æ¡£';
      modalTitle.style.cssText = [
        'font-size: 18px',
        'font-weight: 600',
        'color: #374151',
        'margin: 0'
      ].join(';');

      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = [
        'background: none',
        'border: none',
        'font-size: 24px',
        'cursor: pointer',
        'color: #6b7280',
        'padding: 4px'
      ].join(';');

      const helpContent = document.createElement('div');
      helpContent.style.cssText = [
        'font-size: 14px',
        'line-height: 1.6'
      ].join(';');

      helpContent.innerHTML = `
        <div style="margin-bottom: 24px;">
          <h3 style="color: #374151; margin-bottom: 12px; font-size: 16px; border-bottom: 2px solid #e5e7eb; padding-bottom: 6px;">âŒ¨ï¸ å¿«æ·æ“ä½œ</h3>
          <ul style="list-style: none; margin: 8px 0;">
            <li style="padding: 4px 0; color: #4b5563;"><strong>ç‚¹å‡»èŠ‚ç‚¹</strong>ï¼šé€‰ä¸­ï¼ˆé«˜äº®ï¼‰</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>åŒå‡»èŠ‚ç‚¹</strong>ï¼šç¼–è¾‘</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Tab</strong>ï¼šæ·»åŠ å­èŠ‚ç‚¹</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Enter</strong>ï¼šæ·»åŠ åŒçº§èŠ‚ç‚¹</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>æ‹–æ‹½èŠ‚ç‚¹</strong> / æ¡†é€‰ / Space+æ‹–åŠ¨ç”»å¸ƒ</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + æ»šè½®</strong>ï¼šæ”¾å¤§/ç¼©å°ç”»å¸ƒ</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Delete/Backspace</strong>ï¼šåˆ é™¤é€‰ä¸­èŠ‚ç‚¹</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + S</strong>ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + C</strong>ï¼šå¤åˆ¶é€‰ä¸­èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + X</strong>ï¼šå‰ªåˆ‡é€‰ä¸­èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + V</strong>ï¼šç²˜è´´å¤åˆ¶çš„èŠ‚ç‚¹</li>
            <li style="padding: 4px 0; color: #4b5563;"><strong>Ctrl + V</strong>ï¼šç²˜è´´å›¾ç‰‡</li>
          </ul>
        </div>

        <div style="margin-bottom: 24px;">
          <h3 style="color: #374151; margin-bottom: 12px; font-size: 16px; border-bottom: 2px solid #e5e7eb; padding-bottom: 6px;">ğŸ“ æ”¯æŒçš„Markdownæ ¼å¼</h3>

          <p style="color: #6b7280; margin-bottom: 8px;"><strong>èŠ‚ç‚¹ç±»å‹ï¼ˆä¼šç”Ÿæˆæ€ç»´å¯¼å›¾èŠ‚ç‚¹ï¼‰ï¼š</strong></p>
          <ul style="list-style: none; margin: 8px 0;">
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;"># æ ‡é¢˜</code> - ä¸€çº§æ ‡é¢˜</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">## æ ‡é¢˜</code> - äºŒçº§æ ‡é¢˜</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">### æ ‡é¢˜</code> - ä¸‰çº§æ ‡é¢˜</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">- æ— åºåˆ—è¡¨</code> - åˆ—è¡¨é¡¹</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">1. æœ‰åºåˆ—è¡¨</code> - ç¼–å·åˆ—è¡¨</li>
          </ul>

          <p style="color: #6b7280; margin-bottom: 8px;"><strong>éèŠ‚ç‚¹æ ¼å¼ï¼ˆä½œä¸ºèŠ‚ç‚¹å¤‡æ³¨ï¼‰ï¼š</strong></p>
          <ul style="list-style: none; margin: 8px 0;">
            <li style="padding: 4px 0; color: #4b5563;">æ™®é€šæ®µè½æ–‡æœ¬</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">**ç²—ä½“**</code> - <strong>ç²—ä½“</strong></li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">*æ–œä½“*</code> - <em>æ–œä½“</em></li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">\`ä»£ç \`</code> - <code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">è¡Œå†…ä»£ç </code></li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">> å¼•ç”¨</code> - å¼•ç”¨å—</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">![å›¾ç‰‡](url)</code> - å›¾ç‰‡</li>
            <li style="padding: 4px 0; color: #4b5563;"><code style="background-color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; color: #dc2626;">[é“¾æ¥](url)</code> - è¶…é“¾æ¥</li>
            <li style="padding: 4px 0; color: #4b5563;">è¡¨æ ¼ã€ä»£ç å—ç­‰</li>
          </ul>
        </div>

        <div style="margin-bottom: 24px;">
          <h3 style="color: #374151; margin-bottom: 12px; font-size: 16px; border-bottom: 2px solid #e5e7eb; padding-bottom: 6px;">ğŸ”§ è°ƒè¯•åŠŸèƒ½</h3>
          <ul style="list-style: none; margin: 8px 0;">
            <li style="padding: 4px 0; color: #4b5563;"><strong>æŸ¥çœ‹JSON</strong>ï¼šæŸ¥çœ‹è§£æåçš„æ•°æ®ç»“æ„</li>
            <li style="padding: 4px 0; color: #4b5563;">æ”¯æŒå¯¼å‡ºå®Œæ•´æ€ç»´å¯¼å›¾ä¸ºå›¾ç‰‡</li>
            
          </ul>
        </div>
      `;

      // ç»„è£…æ¨¡æ€æ¡†
      modalHeader.appendChild(modalTitle);
      modalHeader.appendChild(closeBtn);
      modalContent.appendChild(modalHeader);
      modalContent.appendChild(helpContent);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      setTimeout(() => {
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';
        modalContent.style.transform = 'scale(1)';
      }, 10);

      // å…³é—­äº‹ä»¶
      const closeModal = () => {
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        modalContent.style.transform = 'scale(0.9)';
        setTimeout(() => {
          document.body.removeChild(modal);
        }, 300);
      };

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // ESC é”®å…³é—­
      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      });
    }

    // ç¼©æ”¾ä¸­å¿ƒä¿®æ­£ï¼šåœ¨é¼ æ ‡/è§¦æ‘¸ä½ç½®è®¾ç½® transform-originï¼Œé…åˆç°æœ‰åº“ç¼©æ”¾ä»¥è¯¥ç‚¹ä¸ºä¸­å¿ƒ
    (function setupZoomOrigin() {
      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;
      function setOrigin(clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        container.style.transformOrigin = `${x}px ${y}px`;
      }
      // é¼ æ ‡æ»šè½®ï¼šåœ¨ç¼©æ”¾å‰è®¾ç½® origin
      container.addEventListener('wheel', function (e) {
        if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) {
          // è‹¥ç”¨æˆ·åŒæ—¶æŒ‰é”®ï¼Œä»æ”¯æŒï¼Œä½†ä¼˜å…ˆè®¾ç½® origin
        }
        setOrigin(e.clientX, e.clientY);
        // ä¸é˜»æ­¢åŸç”Ÿæ»šåŠ¨/ç¼©æ”¾é€»è¾‘ï¼Œè®©ç°æœ‰åº“å¤„ç†å®é™…ç¼©æ”¾
      }, { passive: true });
      // è§¦æ‘¸ï¼šè®°å½•è§¦æ‘¸ç‚¹ä»¥è®¾ç½® originï¼ˆç”¨äºåŒæŒ‡ç¼©æ”¾å‰ï¼‰
      container.addEventListener('touchstart', function (e) {
        if (!e.touches || e.touches.length === 0) return;
        const t = e.touches[0];
        setOrigin(t.clientX, t.clientY);
      }, { passive: true });
    })();


    /* æ‹–æ‹½æ”¯æŒï¼šé¼ æ ‡ä¸è§¦æ‘¸ */
    (function () {
      let dragging = false;
      let startX = 0, startY = 0;
      let origLeft = 0, origTop = 0;
      let handlersAdded = false;



      function onPointerDown(e) {
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        dragging = true;
        p.style.transition = 'none';
        const rect = p.getBoundingClientRect();
        origLeft = rect.left;
        origTop = rect.top;
        if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        } else {
          startX = e.clientX;
          startY = e.clientY;
        }
        // prevent iframe text selection during drag
        document.body.style.userSelect = 'none';
      }

      function onPointerMove(e) {
        if (!dragging) return;
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        let cx = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
        let cy = (e.type === 'touchmove') ? e.touches[0].clientY : e.clientY;
        const dx = cx - startX;
        const dy = cy - startY;
        const left = origLeft + dx;
        const top = origTop + dy;
        // é™åˆ¶åˆ°è§†å£å†…
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const rect = p.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        const minLeft = 8;
        const maxLeft = vw - w - 8;
        const minTop = 8;
        const maxTop = vh - h - 8;
        const nx = Math.min(Math.max(left, minLeft), Math.max(minLeft, maxLeft));
        const ny = Math.min(Math.max(top, minTop), Math.max(minTop, maxTop));
        // è®°å½•ä¸´æ—¶ä½ç§»é‡ï¼ŒonPointerUp ä¼šåŸºäºæ­¤åˆ¤æ–­æ˜¯å¦æ ‡è®°ä¸ºå·²ç§»åŠ¨
        try {
          p.dataset._dragMovedX = String(dx);
          p.dataset._dragMovedY = String(dy);
        } catch (e) { /* ignore */ }
        p.style.right = 'auto';
        p.style.left = nx + 'px';
        p.style.top = ny + 'px';
      }

      function onPointerUp() {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = '';
        const p = document.getElementById('nodeDetails');
        if (p) p.style.transition = '';
        // æ ‡è®°æ˜¯å¦å‘ç”Ÿè¿‡æ˜¾è‘—ä½ç§»ï¼Œé¡µé¢æœªåˆ·æ–°å‰ä¿æŒä½ç½®
        try {
          if (p) {
            const movedX = parseFloat(p.dataset._dragMovedX || '0');
            const movedY = parseFloat(p.dataset._dragMovedY || '0');
            if (Math.abs(movedX) > 2 || Math.abs(movedY) > 2) {
              p.dataset.moved = 'true';
            }
            delete p.dataset._dragMovedX;
            delete p.dataset._dragMovedY;
          }
        } catch (e) { /* ignore */ }
      }

      function initNodeDetailsDragHandlers() {
        if (handlersAdded) return;
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        // ä½¿ç”¨ panel-header ä½œä¸ºæŠ“æ‰‹ï¼Œå¦‚æ— åˆ™å…¨é¢æ¿å¯æ‹–
        const handle = p.querySelector('.panel-header') || p;
        handle.addEventListener('mousedown', onPointerDown, { passive: true });
        window.addEventListener('mousemove', onPointerMove, { passive: true });
        window.addEventListener('mouseup', onPointerUp, { passive: true });
        handle.addEventListener('touchstart', onPointerDown, { passive: true });
        window.addEventListener('touchmove', onPointerMove, { passive: true });
        window.addEventListener('touchend', onPointerUp, { passive: true });
        handlersAdded = true;
      }



      // å¦‚æœé¢æ¿å·²æ˜¾ç¤ºï¼Œåˆå§‹åŒ–ä¸€æ¬¡
      document.addEventListener('DOMContentLoaded', function () {
        const p = document.getElementById('nodeDetails');
        if (p && p.style.display !== 'none') initNodeDetailsDragHandlers();
      });
      // åœ¨çª—å£å¤§å°å˜åŒ–æ—¶å¾®è°ƒä½ç½®ï¼Œé¿å…è¶…å‡º
      window.addEventListener('resize', function () {
        const p = document.getElementById('nodeDetails');
        if (!p || p.style.display === 'none') return;
        const rect = p.getBoundingClientRect();
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const maxLeft = Math.max(8, vw - rect.width - 8);
        const maxTop = Math.max(8, vh - rect.height - 8);
        let left = rect.left;
        let top = rect.top;
        if (left > maxLeft) left = maxLeft;
        if (top > maxTop) top = maxTop;
        p.style.left = left + 'px';
        p.style.top = top + 'px';
      });

    })();


    // --- extracted block from original HTML ---
    (function () {
      // èŠ‚ç‚¹è¯¦æƒ…å¼€å…³ï¼ˆé»˜è®¤å¼€å¯ï¼‰
      window.__nodeDetailsEnabled = (window.__nodeDetailsEnabled === undefined) ? false : !!window.__nodeDetailsEnabled;

      function updateToggleUI() {
        var enabled = !!window.__nodeDetailsEnabled;
        // å¤é€‰æ¡†ï¼ˆå…¼å®¹ä¿ç•™ï¼‰
        var cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.checked = enabled;
          cb.setAttribute('aria-checked', enabled ? 'true' : 'false');
        }
        // å›¾æ ‡æŒ‰é’®ï¼ˆæ–°ï¼‰
        var btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.classList.remove('state-on', 'state-off', 'state-default');
          btn.classList.add(enabled ? 'state-on' : 'state-off');
          btn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
        }
      }

      // åˆ‡æ¢å¤„ç†ï¼šå¯ç”¨æ—¶è‹¥å­˜åœ¨é€‰ä¸­èŠ‚ç‚¹ç«‹å³æ˜¾ç¤ºè¯¦æƒ…ï¼›ç¦ç”¨æ—¶éšè—é¢æ¿å¹¶é˜»æ­¢åç»­å¼¹å‡º
      function handleToggleChange(checked) {
        window.__nodeDetailsEnabled = !!checked;
        if (!window.__nodeDetailsEnabled) {
          if (typeof hideNodeDetails === 'function') {
            try { hideNodeDetails(); } catch (e) { /* ignore */ }
          }
        } else {
          // å¯ç”¨æ—¶ï¼šè‹¥æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œç«‹å³æ˜¾ç¤ºå…¶è¯¦æƒ…ï¼›å¦åˆ™æ‰“å¼€é¢æ¿å¹¶æç¤ºâ€œè¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹â€
          try {
            var sel = null;
            if (window.jm && typeof window.jm.get_selected_node === 'function') {
              sel = window.jm.get_selected_node();
            }
            if (sel) {
              try { showNodeDetails(sel); } catch (e) { /* ignore */ }
            } else {
              // æ— é€‰ä¸­èŠ‚ç‚¹ï¼šæ‰“å¼€é¢æ¿å¹¶æ˜¾ç¤ºç©ºçŠ¶æ€
              try { showEmptyDetailsPrompt(); } catch (e) { /* ignore */ }
            }
          } catch (e) { /* ignore */ }
        }
        updateToggleUI();
      }

      // æŒ‚è½½äº‹ä»¶
      document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ– UIï¼ˆæ— è®ºæ˜¯å¦æœ‰å¤é€‰æ¡†æˆ–æŒ‰é’®ï¼‰
        updateToggleUI();

        // å¤é€‰æ¡†ï¼ˆå…¼å®¹ï¼‰
        var cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.addEventListener('change', function (e) {
            handleToggleChange(!!e.target.checked);
          }, { passive: true });
          cb.addEventListener('keydown', function (e) {
            if (e.key === ' ' || e.key === 'Enter') {
              setTimeout(function () { handleToggleChange(!!cb.checked); }, 0);
            }
          });
        }

        // å›¾æ ‡æŒ‰é’®ï¼ˆæ–°ï¼‰
        var btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.addEventListener('click', function () {
            handleToggleChange(!window.__nodeDetailsEnabled);
          });
          btn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleToggleChange(!window.__nodeDetailsEnabled);
            }
          });
        }

        // å¸®åŠ©æŒ‰é’®
        var helpBtn = document.getElementById('help-btn');
        if (helpBtn) {
          helpBtn.addEventListener('click', function () {
            showMindmapHelp();
          });
          helpBtn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              showMindmapHelp();
            }
          });
        }

        // å¿«é€ŸAIç”Ÿæˆå¼€å…³
        var quickAIBtn = document.getElementById('toggleQuickAIBtn');
        if (quickAIBtn) {
          // åˆå§‹åŒ–çŠ¶æ€
          window.__quickAIEnabled = false;

          // æ›´æ–°UIçŠ¶æ€
          function updateQuickAIButton() {
            var enabled = !!window.__quickAIEnabled;
            quickAIBtn.classList.remove('state-on', 'state-off');
            quickAIBtn.classList.add(enabled ? 'state-on' : 'state-off');
            quickAIBtn.setAttribute('aria-pressed', enabled ? 'true' : 'false');

            // æ›´æ–°æç¤ºæ–‡å­—
            var statusText = enabled ? 'å¿«é€ŸAIç”Ÿæˆï¼šå·²å¼€å¯ï¼Œå°†ç›´æ¥ç”Ÿæˆå†…å®¹' : 'å¿«é€ŸAIç”Ÿæˆï¼šå¼€å¯æ—¶å°†å…³é—­AIå¼¹çª—ï¼Œç›´æ¥ç”Ÿæˆå†…å®¹';
            quickAIBtn.setAttribute('title', statusText);
          }

          // ç‚¹å‡»äº‹ä»¶å¤„ç†
          quickAIBtn.addEventListener('click', function () {
            window.__quickAIEnabled = !window.__quickAIEnabled;
            updateQuickAIButton();
          });

          // é”®ç›˜äº‹ä»¶å¤„ç†
          quickAIBtn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              window.__quickAIEnabled = !window.__quickAIEnabled;
              updateQuickAIButton();
            }
          });

          // åˆå§‹åŒ–UI
          updateQuickAIButton();
        }
      });

      // åŒ…è£… showNodeDetailsï¼šè‹¥å¼€å…³å…³é—­åˆ™é™é»˜è¿”å›
      if (typeof window.showNodeDetails === 'function') {
        var _origShowNodeDetails = window.showNodeDetails;
        window.showNodeDetails = function (node) {
          // å…è®¸åœ¨æ˜¾å¼ç»•è¿‡æ ‡å¿—ä¸‹æ˜¾ç¤ºè¯¦æƒ…ï¼ˆä¸æ”¹å˜ç”¨æˆ·çš„å¼€å…³çŠ¶æ€ï¼‰
          if (window.__nodeDetailsEnabled === false && !window.__bypassDetailsGuard) return;
          return _origShowNodeDetails.apply(this, arguments);
        };
      } else {
        // è‹¥å‡½æ•°å°šæœªå®šä¹‰ï¼Œå»¶è¿ŸåŒ…è£…ï¼ˆåœ¨åç»­å®šä¹‰æ—¶æ£€æµ‹ï¼‰
        var _tryWrap = function () {
          if (typeof window.showNodeDetails === 'function') {
            var _orig = window.showNodeDetails;
            window.showNodeDetails = function (node) {
              if (window.__nodeDetailsEnabled === false && !window.__bypassDetailsGuard) return;
              return _orig.apply(this, arguments);
            };
            clearInterval(_tryWrapInterval);
          }
        };
        var _tryWrapInterval = setInterval(_tryWrap, 200);
      }
    })();


    // --- extracted block from original HTML ---
    (function mw_post_init_fix() {
      try {
        function isMobileNow() {
          var isSmallScreen = (window.matchMedia && window.matchMedia('(max-width: 1020px)').matches);
          var hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
          return isSmallScreen || (hasTouch && window.innerWidth <= 900);
        }

        function relocateBatchOpsIfNeeded() {
          try {
            var isMobile = isMobileNow();
            var batch = document.getElementById('batchOperations');
            var mw = document.getElementById('mw-batchops');
            if (!batch || !mw) return;
            if (!isMobile) {
              // copy count
              var sc = batch.querySelector('#selectedCount');
              var scVal = sc ? sc.textContent : '0';
              var targetStrong = mw.querySelector('#selectedCountDisplay');
              if (targetStrong) targetStrong.textContent = scVal;
              batch.style.display = 'none';
              mw.style.display = 'inline-flex';
              // keep references
              window.__mw_batch_source = batch;
              window.__mw_batch_target = mw;
            } else {
              batch.style.display = 'none';
              if (mw) mw.style.display = 'none';
            }
          } catch (e) { console.warn('[MW] relocateBatchOpsIfNeeded failed', e); }
        }

        function ensureDetailsToggleVisibleOnDesktop() {
          try {
            var cbDetails = document.getElementById('toggleNodeDetailsCheckbox');
            if (!cbDetails) return;
            var label = cbDetails.parentElement;
            if (!label) return;
            if (!isMobileNow()) {
              label.style.display = ''; // restore default
            }
          } catch (e) { /* ignore */ }
        }

        // sync selected count periodically (small cost, robust)
        function startSelectedCountSync() {
          try {
            var source = document.getElementById('batchOperations');
            var target = document.getElementById('mw-batchops');
            if (!source || !target) return;
            var sSrc = source.querySelector('#selectedCount');
            var sTgt = target.querySelector('#selectedCountDisplay');
            if (!sSrc || !sTgt) return;
            var last = null;
            setInterval(function () {
              try {
                var now = sSrc.textContent || sSrc.innerText || '0';
                if (now !== last) {
                  last = now;
                  sTgt.textContent = now;
                }
              } catch (e) { }
            }, 250);
          } catch (e) { /* ignore */ }
        }

        // run on load and on resize/orientationchange
        function boot() {
          relocateBatchOpsIfNeeded();
          ensureDetailsToggleVisibleOnDesktop();
          startSelectedCountSync();
          // åˆå§‹åŒ–AIå¿«æ·æ“ä½œæŒ‰é’®å¯è§æ€§
          if (typeof updateAIQuickActionsVisibility === 'function') {
            updateAIQuickActionsVisibility();
          }
        }

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setTimeout(boot, 50);
        } else {
          document.addEventListener('DOMContentLoaded', function () { setTimeout(boot, 50); });
          window.addEventListener('load', function () { setTimeout(boot, 50); });
        }
        window.addEventListener('resize', function () { setTimeout(relocateBatchOpsIfNeeded, 60); });
        window.addEventListener('orientationchange', function () { setTimeout(relocateBatchOpsIfNeeded, 60); });
      } catch (e) {
        console.error('[MW] post init fix error', e);
      }
    })();


    // toolbar å›¾æ ‡é€‰æ‹©å™¨åˆå§‹åŒ– â€”â€” æ›´ç¨³å¥çš„å®ç°ï¼šä½¿ç”¨ textContentã€ç­‰å¾… availableIcons ä¸ jm å°±ç»ª
    (function () {
      function createToolbarIconGrid() {
        var grid = document.getElementById('iconGridToolbar');
        if (!grid) return;
        grid.innerHTML = '';

        // é¦–ä½ä¸ºæ¸…é™¤å›¾æ ‡æŒ‰é’®ï¼ˆç½‘æ ¼å†…å”¯ä¸€çš„æ¸…é™¤ï¼‰
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'icon-picker-item';
        clearBtn.title = 'æ¸…é™¤å›¾æ ‡';
        clearBtn.style.cssText = 'alpha:0.3;width:40px;height:40px;border:1px dashed #ddd;color:#dbdbdb !important;border-radius:4px;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;';
        clearBtn.textContent = 'ğŸš«';
        clearBtn.onclick = function (e) { e.stopPropagation(); clearIconFromToolbar(); };
        grid.appendChild(clearBtn);

        // å¦‚æœ MWIcons.getGroups å¯ç”¨ï¼ŒæŒ‰ç»„æ¸²æŸ“ï¼ˆå¸¦åˆ†ç»„æ ‡é¢˜ï¼‰
        var groups = (window.MWIcons && typeof window.MWIcons.getGroups === 'function') ? window.MWIcons.getGroups() : null;

        if (groups && Object.keys(groups).length > 0) {
          // åˆ›å»ºåˆ†ç»„å®¹å™¨
          Object.keys(groups).forEach(function (groupKey) {
            var group = groups[groupKey];
            // åˆ†ç»„æ ‡é¢˜
            var header = document.createElement('div');
            header.style.cssText = 'grid-column: 1 / -1; font-size:12px; font-weight:600; color:#333; padding:6px 0 4px 0;';
            header.textContent = (groupKey.charAt(0).toUpperCase() + groupKey.slice(1));
            grid.appendChild(header);

            // åˆ†ç»„å›¾æ ‡ç½‘æ ¼ï¼ˆ7åˆ—å†…ä½¿ç”¨ç›¸åŒæ ·å¼ï¼‰
            group.forEach(function (icon) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'icon-picker-item';
              btn.title = icon.name || '';
              btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
              btn.textContent = icon.emoji || '';
              btn.onclick = function (ev) {
                ev.stopPropagation();
                applyIconToSelection(icon.emoji);
                try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
              };
              btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
              btn.onmouseout = function () { btn.style.background = 'white'; };
              grid.appendChild(btn);
            });
          });
          return;
        }

        // å…¼å®¹å›é€€ï¼šæ‰å¹³åŒ– window.availableIcons æˆ–å…¨å±€ availableIcons
        var icons = (window.availableIcons && window.availableIcons.length) ? window.availableIcons
          : (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length) ? availableIcons
            : [];
        if (!icons || icons.length === 0) {
          // æ˜¾ç¤ºå ä½æç¤ºï¼ˆç”¨æˆ·çœ‹åˆ°ä¸ä¼šç©ºç™½ï¼‰
          var ph = document.createElement('div');
          ph.style.cssText = 'grid-column: 1 / -1; color:#6c757d; font-size:12px; padding:6px; text-align:center;';
          ph.textContent = 'å›¾æ ‡åº“åŠ è½½ä¸­...';
          grid.appendChild(ph);
          return;
        }

        icons.forEach(function (icon) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'icon-picker-item';
          btn.title = icon.name || '';
          btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
          btn.textContent = icon.emoji || '';
          btn.onclick = function (ev) {
            ev.stopPropagation();
            applyIconToSelection(icon.emoji);
            // å…³é—­ dropdownï¼ˆBootstrapï¼‰
            try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
          };
          btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
          btn.onmouseout = function () { btn.style.background = 'white'; };
          grid.appendChild(btn);
        });
      }

      // å®‰å…¨çš„åˆå§‹åŒ–ï¼šå¦‚æœ availableIcons å°šæœªå°±ç»ªï¼Œé‡å¤å°è¯•å‡ æ¬¡
      function initWithRetry(attemptsLeft) {
        try {
          if ((window.availableIcons && window.availableIcons.length > 0) || (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length > 0) || attemptsLeft <= 0) {
            createToolbarIconGrid();
            return;
          }
        } catch (e) { /* ignore */ }

        setTimeout(function () { initWithRetry(attemptsLeft - 1); }, 120);
      }

      // å°† emoji åº”ç”¨åˆ°å½“å‰é€‰ä¸­èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      function applyIconToSelection(emoji) {
        if (!window.jm) {
          console.warn('jm æœªåˆå§‹åŒ–ï¼Œæ— æ³•åº”ç”¨å›¾æ ‡');
          return;
        }

        // è·å–å¤šé€‰ï¼ˆæ¡†é€‰ï¼‰æˆ–å•é€‰
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') {
            ids = window.getMultiSelection() || [];
          }
        } catch (e) { ids = []; }

        // è‹¥æ— å¤šé€‰ï¼Œåˆ™å°è¯•ç”¨ jm.get_selected_nodeï¼ˆå•é€‰ï¼‰
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }

        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ 1 ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹');
          return;
        }

        // å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„ topic å‰é¢æ’å…¥ emojiï¼ˆè‹¥å·²å­˜åœ¨è¡¨æƒ…åˆ™æ›¿æ¢ï¼‰
        // ä½¿ç”¨å®½æ¾çš„ emoji å»é™¤æ­£åˆ™ï¼ˆå…¼å®¹æ€§å·®æ—¶ä¹Ÿèƒ½å·¥ä½œï¼‰
        var emojiStrip = /^[^\w\u4e00-\u9fff\s\u2000-\u206F\u2E00-\u2E7F\u3000-\u303F\u3200-\u32FF\uFE00-\uFE0F\uFE30-\uFE4F\u1F000-\u1F9FF]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            // ç§»é™¤å¼€å¤´çš„éå­—æ¯æ•°å­—ä¸éä¸­æ–‡å­—ç¬¦ï¼ˆå¤šåŠæ˜¯ emoji æˆ–ç¬¦å·ï¼‰
            topic = topic.replace(emojiStrip, '').trim();
            var newTopic = (emoji ? (emoji + ' ' + topic) : topic);
            jm.update_node(node.id, newTopic);
          } catch (e) {
            console.warn('åº”ç”¨å›¾æ ‡å¤±è´¥', e);
          }
        });

        // ä¿å­˜å¹¶æç¤º
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²åº”ç”¨å›¾æ ‡'); } catch (e) { }
      }

      // ä»é€‰ä¸­èŠ‚ç‚¹æ¸…é™¤å›¾æ ‡ï¼ˆç›¸å½“äº applyIconToSelection('')ï¼‰
      window.clearIconFromToolbar = function () {
        if (!window.jm) return;
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') ids = window.getMultiSelection() || [];
        } catch (e) { ids = []; }
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }
        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ èŠ‚ç‚¹');
          return;
        }

        // åºå·emojiæ¨¡å¼ï¼šæ•°å­— + å˜ä½“é€‰æ‹©å™¨ + ç»„åˆåŒ…å›´æ¡†
        var numberEmojiPattern = /^[0-9]\uFE0F\u20E3/;
        // é€šç”¨emojiæ¨¡å¼
        var emojiStrip = /^[^\w\u4e00-\u9fff\s\u2000-\u206F\u2E00-\u2E7F\u3000-\u303F\u3200-\u32FF\uFE00-\uFE0F\uFE30-\uFE4F\u1F000-\u1F9FF]+/u;

        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';

            console.log("æ¸…é™¤å‰topic:", topic);

            // å…ˆå°è¯•ç§»é™¤åºå·emoji
            if (numberEmojiPattern.test(topic)) {
              topic = topic.replace(numberEmojiPattern, '').trim();
              console.log("ä½¿ç”¨åºå·emojiæ¨¡å¼æ¸…é™¤å:", topic);
            } else {
              // å¦‚æœä¸æ˜¯åºå·emojiï¼Œä½¿ç”¨é€šç”¨æ¨¡å¼
              var originalTopic = topic;
              topic = topic.replace(emojiStrip, '').trim();
              console.log("ä½¿ç”¨é€šç”¨emojiæ¨¡å¼æ¸…é™¤:", originalTopic, "->", topic);
            }

            jm.update_node(node.id, topic);
            console.log("æœ€ç»ˆæ›´æ–°ä¸º:", topic);
          } catch (e) { console.warn('æ¸…é™¤å›¾æ ‡å¤±è´¥', e); }
        });
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²æ¸…é™¤å›¾æ ‡'); } catch (e) { }
      };

      // åˆå§‹åŒ–å…¥å£ï¼šæœ€å¤šé‡è¯• 8 æ¬¡ï¼ˆæ¯æ¬¡ 120msï¼‰
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function () { initWithRetry(8); }, 120);
      } else {
        document.addEventListener('DOMContentLoaded', function () { setTimeout(function () { initWithRetry(8); }, 120); });
      }

      // åœ¨ jm åˆå§‹åŒ–åå†æ‰§è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ race
      window.MW_scheduleOnce && window.MW_scheduleOnce('initToolbarIconGrid', function () {
        initWithRetry(4);
      }, 300);
    })();    // æ‚¬åœèŠ‚ç‚¹å³ä¾§çš„å°±è¿‘å¿«æ·æŒ‰é’®ï¼ˆä¿®æ”¹ / AIæ‰©å†™å­èŠ‚ç‚¹ / åˆ é™¤ï¼‰
    (function setupNodeHoverActions() {
      console.log('[mindmap] èŠ‚ç‚¹æ‚¬åœæŒ‰é’®åˆå§‹åŒ–å¼€å§‹');
      try {
        const wrap = document.createElement('div');
        wrap.id = 'nodeHoverActions';
        wrap.setAttribute('aria-hidden', 'true');
        wrap.style.cssText = [
          'position:absolute',
          'display:none',
          'z-index:9999',
          'pointer-events:auto',
          'background:transparent'
        ].join(';');

        // ä»¥ DOM æ–¹å¼åˆ›å»ºï¼ˆå¤–å±‚ç™½åº•åœ†å½¢ + é˜´å½±å®¹å™¨ï¼Œå†…å±‚å¤ç”¨ ico-btnï¼‰ï¼Œé¿å…å­—ç¬¦ä¸²è½¬ä¹‰å’Œè‡ªåŠ¨æ ¼å¼åŒ–ç ´å URL
        var btnEdit = null, btnAIChild = null, btnDelete = null;
        (function () {
          function addBtn(title, iconUrl) {
            // å¤–å±‚åœ†å½¢å®¹å™¨
            var box = document.createElement('div');
            box.className = 'mw-fab';
            box.setAttribute('role', 'button');
            box.tabIndex = 0;
            box.title = title;
            box.style.cssText = [
              'position:absolute',
              'width:36px',
              'height:36px',
              'border-radius:50%',
              'background:#fff',
              'box-shadow:0 6px 18px rgba(0,0,0,0.3)',
              'display:flex',
              'align-items:center',
              'justify-content:center',
              'cursor:pointer',
              'transition:transform .12s ease, box-shadow .12s ease',
              'will-change:transform, left, top'
            ].join(';');
            box.addEventListener('mouseenter', function () { box.style.transform = 'scale(1.06)'; box.style.boxShadow = '0 8px 22px rgba(0,0,0,0.38)'; });
            box.addEventListener('mouseleave', function () { box.style.transform = ''; box.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)'; });

            // å†…å±‚å›¾æ ‡
            var ico = document.createElement('span');
            ico.className = 'ico-btn';
            ico.setAttribute('aria-hidden', 'true');
            // è®©å†…å±‚ä¸æ‹¦æˆªäº‹ä»¶ï¼Œç‚¹å‡»è½åœ¨å¤–å±‚ box
            ico.style.pointerEvents = 'none';
            // å‹ç¼©ä¸€ä¸‹å›¾æ ‡å°ºå¯¸ä»¥é€‚é… 36px åœ†
            ico.style.width = '22px';
            ico.style.height = '22px';
            ico.style.backgroundSize = 'contain';
            try { ico.style.setProperty('--ico', "url('" + iconUrl + "')"); } catch (_) { ico.style = "--ico: url('" + iconUrl + "')"; }

            box.appendChild(ico);
            wrap.appendChild(box);
            return box;
          }
          // btnEdit = addBtn('ä¿®æ”¹', '../res/edit.svg');
          btnAIChild = addBtn('AIæ‰©å†™å­èŠ‚ç‚¹', '../res/æ·»åŠ å­çº§.svg');
          // btnDelete = addBtn('åˆ é™¤èŠ‚ç‚¹', '../res/åˆ é™¤.svg');
        })();

        document.body.appendChild(wrap);
        console.log('[mindmap] èŠ‚ç‚¹æ‚¬åœæŒ‰é’®DOMåˆ›å»ºå®Œæˆ');

        let activeNodeEl = null;
        let activeNodeId = null;
        let hideTimer = null;

        // å°†ä¸‰ä¸ªæŒ‰é’®æŒ‰å¼§å½¢ï¼ˆä¸Š-ä¸­-ä¸‹ï¼‰åˆ†å¸ƒåœ¨èŠ‚ç‚¹å³ä¾§
        function positionNear(nodeEl) {
          const rect = nodeEl.getBoundingClientRect();
          const scrollX = window.scrollX || window.pageXOffset || 0;
          const scrollY = window.scrollY || window.pageYOffset || 0;

          // åŸºç‚¹ï¼šèŠ‚ç‚¹å³ä¾§ä¸­ç‚¹çš„ç¨å³å¤„ï¼ˆè®©æŒ‰é’®â€œç¯ç»•åœ¨åæ–¹â€ï¼‰
          const baseX = scrollX + rect.right + 12;
          const baseY = scrollY + rect.top + rect.height;

          // å¼§å½¢å‚æ•°
          const R = 48; // åŠå¾„
          const size = 36; // æŒ‰é’®ç›´å¾„
          const half = size / 2;

          // è§’åº¦ï¼ˆåº¦æ•°ï¼‰ä»ä¸Šåˆ°ä¸‹ï¼š-60Â°, 0Â°, 60Â°
          const deg = [-60, 0, 60];

          // å°† wrap æ”¾åˆ°åŸºç‚¹é™„è¿‘ï¼ˆç”¨äºè¿è´¯éšè—/æ˜¾ç¤ºï¼Œå­é¡¹ä½¿ç”¨ç»å¯¹å®šä½ï¼‰
          wrap.style.left = (baseX - half) + 'px';
          wrap.style.top = (baseY - half) + 'px';

          function place(el, angleDeg) {
            if (!el) return;
            const rad = angleDeg * Math.PI / 180;
            const x = Math.cos(rad) * R;
            const y = Math.sin(rad) * R;
            el.style.left = Math.round(x - half) + 'px';
            el.style.top = Math.round(y - half) + 'px';
          }

          place(btnEdit, deg[0]);
          place(btnAIChild, deg[1]);
          place(btnDelete, deg[2]);
        }

        function showFor(nodeEl) {
          if (!nodeEl) return;
          activeNodeEl = nodeEl;
          activeNodeId = nodeEl.getAttribute('nodeid') || nodeEl.getAttribute('nodeId') || null;
          console.log('[mindmap] showFor æ˜¾ç¤ºæŒ‰é’®, nodeId:', activeNodeId);
          positionNear(nodeEl);
          wrap.style.display = 'block';
          wrap.setAttribute('aria-hidden', 'false');
        }

        function getSelectedNodeId() {
          try {
            var sel = (window.jm && typeof jm.get_selected_node === 'function') ? jm.get_selected_node() : null;
            return sel && sel.id ? sel.id : null;
          } catch (_) { return null; }
        }
        function hide() {
          // è‹¥å½“å‰èŠ‚ç‚¹ä»è¢«é€‰ä¸­ï¼Œåˆ™ä¿æŒæ˜¾ç¤º
          try {
            var sid = getSelectedNodeId();
            if (sid && activeNodeId && sid === activeNodeId) return;
          } catch (_) { }
          wrap.style.display = 'none';
          wrap.setAttribute('aria-hidden', 'true');
          activeNodeEl = null;
          activeNodeId = null;
        }

        // äº‹ä»¶å§”æ‰˜ï¼šè¿›å…¥ jmnode æˆ–å…¶å­å…ƒç´ æ—¶æ˜¾ç¤º
        document.addEventListener('mouseover', function (e) {
          const t = e.target;
          const nodeEl = t && (t.closest ? t.closest('jmnode') : (t.tagName && t.tagName.toLowerCase() === 'jmnode' ? t : null));
          if (nodeEl) {
            if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
            showFor(nodeEl);
          }
        }, { passive: true });

        // ç¦»å¼€ jmnode æˆ–å…¶å­å…ƒç´ ï¼šè‹¥æœªè¿›å…¥æŒ‰é’®ç»„ä¸”æœªä»åœ¨åŒä¸€ jmnode å†…ï¼Œåˆ™å»¶è¿Ÿéšè—
        document.addEventListener('mouseout', function (e) {
          const t = e.target;
          const fromNode = t && (t.closest ? t.closest('jmnode') : (t.tagName && t.tagName.toLowerCase() === 'jmnode' ? t : null));
          if (fromNode) {
            const to = e.relatedTarget;
            if (wrap.contains(to)) return; // è¿›å…¥æŒ‰é’®ç»„ï¼Œä¸éšè—
            const toNode = to && to.closest ? to.closest('jmnode') : null;
            if (toNode && toNode === fromNode) return; // åœ¨åŒä¸€èŠ‚ç‚¹å†…ç§»åŠ¨ï¼Œä¸éšè—
            hideTimer = setTimeout(hide, 200);
          }
        }, { passive: true });

        // é¼ æ ‡åœ¨æŒ‰é’®ç»„ä¸Šæ–¹æ—¶ä¿æŒæ˜¾ç¤º
        wrap.addEventListener('mouseenter', function () {
          if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
        });
        wrap.addEventListener('mouseleave', function (e) {
          const to = e.relatedTarget;
          // è¿”å›èŠ‚ç‚¹ä¸éšè—
          if (activeNodeEl && to && activeNodeEl.contains && activeNodeEl.contains(to)) return;
          hideTimer = setTimeout(hide, 150);
        });

        // è‹¥æœ‰é€‰ä¸­ä½†æ— æ‚¬åœï¼Œä¹Ÿæ˜¾ç¤ºåœ¨é€‰ä¸­èŠ‚ç‚¹æ—
        (function setupSelectionFollow() {
          function getNodeElById(id) {
            if (!id) return null;
            return document.querySelector('jmnode[nodeid="' + id + '"]') ||
              document.querySelector('jmnode[nodeId="' + id + '"]');
          }
          var lastSid = null;
          setInterval(function () {
            try {
              var sid = getSelectedNodeId();
              if (sid !== lastSid) {
                lastSid = sid;
                if (sid) {
                  var el = getNodeElById(sid);
                  if (el) showFor(el);
                } else {
                  // æ— é€‰ä¸­æ—¶ç›´æ¥éšè—æŒ‰é’®
                  hide();
                }
              } else if (sid && wrap.style.display === 'none') {
                // é€‰ä¸­å­˜åœ¨ä½†æœªæ˜¾ç¤ºï¼Œè¡¥ä¸€æ¬¡
                var el2 = getNodeElById(sid);
                if (el2) showFor(el2);
              }
            } catch (_) { }
          }, 300);
        })();

        // ç‚¹å‡»æŒ‰é’®å‰ï¼Œç¡®ä¿å°†æ‚¬åœèŠ‚ç‚¹è®¾ä¸ºé€‰ä¸­ï¼Œå¤ç”¨é¡¶éƒ¨å·²æœ‰é€»è¾‘
        function ensureSelect() {
          try {
            if (activeNodeId && window.jm && typeof jm.select_node === 'function') {
              jm.select_node(activeNodeId);
            }
          } catch (_) { /* ignore */ }
        }

        // ç‚¹å‡»/é”®ç›˜è§¦å‘ï¼šç»‘å®šåˆ°å¤–å±‚åœ†å½¢å®¹å™¨
        if (btnEdit) {
          btnEdit.addEventListener('click', function (e) {
            e.stopPropagation();
            ensureSelect();
            try { quickModifyNode(); } catch (_) { /* ignore */ }
          });
          btnEdit.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnEdit.click(); }
          });
        }
        if (btnAIChild) {
          btnAIChild.addEventListener('click', function (e) {
            e.stopPropagation();
            ensureSelect();

            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¿«é€ŸAIç”Ÿæˆ
            if (window.__quickAIEnabled) {
              // æ·»åŠ åŠ è½½çŠ¶æ€
              btnAIChild.classList.add('loading');
              btnAIChild.style.pointerEvents = 'none'; // é˜²æ­¢é‡å¤ç‚¹å‡»

              // ä¿å­˜æŒ‰é’®å¼•ç”¨åˆ°å…¨å±€ï¼Œä»¥ä¾¿åœ¨AIå“åº”å¤„ç†æ—¶å¯ä»¥è®¿é—®
              window.__mw_ai_loading_button = btnAIChild;
            }

            try { aiCreateChild(); } catch (_) { /* ignore */ }
          });
          btnAIChild.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnAIChild.click(); }
          });
        }
        if (btnDelete) {
          btnDelete.addEventListener('click', function (e) {
            e.stopPropagation();
            ensureSelect();
            try { quickDeleteNode(); } catch (_) { /* ignore */ }
          });
          btnDelete.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btnDelete.click(); }
          });
        }

        // è§†å£å˜åŒ–æ—¶é‡å®šä½
        window.addEventListener('scroll', function () {
          if (activeNodeEl && wrap.style.display !== 'none') positionNear(activeNodeEl);
        }, { passive: true });
        window.addEventListener('resize', function () {
          if (activeNodeEl && wrap.style.display !== 'none') positionNear(activeNodeEl);
        });
      } catch (e) {
        console.error('[mindmap] èŠ‚ç‚¹æ‚¬åœæŒ‰é’®åˆå§‹åŒ–å¤±è´¥:', e);
        try { console.warn('[MW] nodeHoverActions init failed', e); } catch (_) { }
      }
      console.log('[mindmap] èŠ‚ç‚¹æ‚¬åœæŒ‰é’®åˆå§‹åŒ–å®Œæˆ');
    })();

  </script>

  <script>
    (function () {
      function renderMindmapFromMd(payload) {
        const md = payload?.md || '';
        const images = payload?.images || [];
        console.log('[mindmap] renderMindmapFromMd å¼€å§‹, docId:', payload?.docId || 'unknown', 'mdé•¿åº¦:', md.length, 'imagesæ•°é‡:', images.length);
        // æ›´æ–°å½“å‰æ–‡æ¡£IDï¼Œç”¨äºæ’¤é”€ç®¡ç†å™¨æŒ‰æ–‡æ¡£éš”ç¦»
        if (payload?.docId) {
          window.currentFileName = payload.docId;
          console.log('[mindmap] æ›´æ–°å½“å‰æ–‡æ¡£IDä¸º:', window.currentFileName);
        }

        try {
          // ç­‰å¾…è½¬æ¢å™¨å‡†å¤‡å°±ç»ª
          if (!window.converter) {
            console.log('[mindmap] ç­‰å¾…è½¬æ¢å™¨åŠ è½½...');
            // ç›‘å¬è½¬æ¢å™¨å°±ç»ªäº‹ä»¶
            window.addEventListener('converterReady', function () {
              renderMindmapFromMd(payload);
            }, { once: true });
            return;
          }

          console.log('[mindmap] ä½¿ç”¨ converter.mdToNodeTree æ¸²æŸ“');

          // ä½¿ç”¨è½¬æ¢å™¨å°†markdownè½¬æ¢ä¸ºnodeTree
          const nodeTree = window.converter.mdToNodeTree(md);
          console.log('[mindmap] markdownè½¬æ¢æˆåŠŸ, nodeTree:', nodeTree);

          // å¦‚æœæœ‰mindmapå®ä¾‹ï¼Œç›´æ¥åŠ è½½nodeTree
          if (window.jm && window.jm.show) {
            console.log('[mindmap] ä½¿ç”¨ jm.show åŠ è½½nodeTree');
            window.jm.show(nodeTree);
          } else {
            console.log('[mindmap] ç­‰å¾…mindmapåˆå§‹åŒ–å®Œæˆåå†åŠ è½½');
            // ç­‰å¾…mindmapåˆå§‹åŒ–å®Œæˆ
            window.addEventListener('mindmapReady', function () {
              if (window.jm && window.jm.show) {
                window.jm.show(nodeTree);
              }
            }, { once: true });
          }

          document.dispatchEvent(new CustomEvent('mw:load_markdown', { detail: payload }));
          console.log('[mindmap] renderMindmapFromMd å®Œæˆ, å·²æ´¾å‘ mw:load_markdown äº‹ä»¶');

        } catch (e) {
          console.warn('[mindmap] renderMindmapFromMd error', e);
          console.error('[mindmap] æ¸²æŸ“å¤±è´¥, docId:', payload?.docId || 'unknown', 'é”™è¯¯:', e.message);
        }
      }

      window.addEventListener('message', function (e) {
        const msg = e.data;
        if (!msg || typeof msg !== 'object') return;

        if (msg.type === 'mw_load_markdown' && msg.payload) {
          console.log('[mindmap] æ”¶åˆ° mw_load_markdown æ¶ˆæ¯, docId:', msg.payload.docId || 'unknown', 'rev:', msg.payload.rev || 'none', 'mdé•¿åº¦:', msg.payload.md ? msg.payload.md.length : 0);
          renderMindmapFromMd(msg.payload);
        }

        if (msg.type === 'mw_relayout') {
          console.log('[mindmap] æ”¶åˆ° mw_relayout æ¶ˆæ¯');
          try {
            if (typeof window.updateLayout === 'function') window.updateLayout();
          } catch (_) { }
        }

        // å¤„ç†AIåˆå§‹æ ‘ç”Ÿæˆå®Œæˆçš„æ¶ˆæ¯ï¼ˆç”¨äºå¿«é€ŸAIæ¨¡å¼ä¸‹å…³é—­è¾“å…¥å¼¹çª—ï¼‰
        if (msg.type === 'AI_INITIAL_TREE_GENERATED') {
          console.log('[mindmap] æ”¶åˆ° AI_INITIAL_TREE_GENERATED æ¶ˆæ¯ï¼Œå…³é—­è¾“å…¥å¼¹çª—');
          try {
            closeAIGenerateModal();
          } catch (e) {
            console.warn('[mindmap] å…³é—­AIç”Ÿæˆå¼¹çª—å¤±è´¥:', e);
          }
        }
      }, { passive: true });
    })();
  </script>

  <script>
    // å±‚çº§å±•å¼€åŠŸèƒ½
    function expandToLevel(level) {
      console.log('[mindmap] expandToLevel è¢«è°ƒç”¨, level:', level);
      if (!window.jm) {
        console.warn('æ€ç»´å¯¼å›¾æœªåˆå§‹åŒ–');
        return;
      }

      try {
        if (level === 'all') {
          // å±•å¼€å…¨éƒ¨
          console.log('[mindmap] å±•å¼€å…¨éƒ¨èŠ‚ç‚¹');
          jm.expand_all();
        } else {
          // å±•å¼€åˆ°æŒ‡å®šå±‚çº§
          console.log('[mindmap] å±•å¼€åˆ°å±‚çº§:', level);
          jm.expand_to_depth(level);
        }
        console.log('[mindmap] å±‚çº§å±•å¼€å®Œæˆ, level:', level);
      } catch (error) {
        console.error('[mindmap] å±•å¼€å±‚çº§å¤±è´¥, level:', level, 'é”™è¯¯:', error);
      }
    }

    // AIç”Ÿæˆåˆå§‹æ ‘ç›¸å…³å‡½æ•°
    function handleAIGenerateInitialTree() {
      // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†å¿«é€ŸAIç”Ÿæˆ
      if (window.__quickAIEnabled) {
        // æé€Ÿæ¨¡å¼ä¸‹ç›´æ¥è°ƒç”¨ï¼Œä¸å¼¹çª—
        aiGenerateInitialTreeMini({
          templateKey: 'ç”Ÿæˆåˆå§‹æ ‘',
          miniPrompt: 'è¯·è¾“å…¥æ€ç»´å¯¼å›¾ä¸»é¢˜',
          autoRun: true
        });
      } else {
        // æ™®é€šæ¨¡å¼ä¸‹è°ƒç”¨åŸæœ‰çš„è¿·ä½ æ¨¡å¼
        aiGenerateInitialTreeMini();
      }
    }

    function showAIGenerateInitialTreeModal() {
      // åˆ›å»ºæ¨¡æ€å¼¹çª—
      var modalHtml = `
        <div id="aiGenerateModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 320px; max-width: 400px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">AIç”Ÿæˆåˆå§‹æ ‘</h3>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">ä¸­å¿ƒä¸»é¢˜åç§°ï¼š</label>
              <input type="text" id="aiTopicInput" placeholder="è¯·è¾“å…¥æ€ç»´å¯¼å›¾çš„ä¸­å¿ƒä¸»é¢˜" 
                     style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeAIGenerateModal()" style="padding: 6px 16px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
              <button onclick="confirmAIGenerate()" style="padding: 6px 16px; border: none; background: #4c9aff; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">ç¡®å®š</button>
            </div>
          </div>
        </div>
      `;

      // æ·»åŠ åˆ°body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // èšç„¦è¾“å…¥æ¡†
      setTimeout(function () {
        document.getElementById('aiTopicInput').focus();
      }, 100);

      // æ·»åŠ å›è½¦é”®æ”¯æŒ
      document.getElementById('aiTopicInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          confirmAIGenerate();
        }
      });
    }

    function closeAIGenerateModal() {
      var modal = document.getElementById('aiGenerateModal');
      if (modal) {
        modal.remove();
      }
    }

    function confirmAIGenerate() {
      var topicInput = document.getElementById('aiTopicInput');
      var topic = topicInput ? topicInput.value.trim() : '';

      if (!topic) {
        alert('è¯·è¾“å…¥ä¸­å¿ƒä¸»é¢˜åç§°');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºå¿«é€ŸAIç”Ÿæˆæ¨¡å¼
      var isQuickAI = window.__quickAIEnabled;

      if (isQuickAI) {
        // å¿«é€ŸAIæ¨¡å¼ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œä¸ç«‹å³å…³é—­å¼¹çª—
        var modalContent = document.querySelector('#aiGenerateModal > div');
        if (modalContent) {
          modalContent.innerHTML = `
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">AIç”Ÿæˆåˆå§‹æ ‘</h3>
            <div style="text-align: center; padding: 20px 0;">
              <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #4c9aff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
              <p style="margin: 16px 0 0 0; color: #666; font-size: 14px;">æ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾ï¼Œè¯·ç¨å€™...</p>
            </div>
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
          `;
        }
      } else {
        // éå¿«é€ŸAIæ¨¡å¼ï¼šç«‹å³å…³é—­å¼¹çª—
        closeAIGenerateModal();
      }

      // è°ƒç”¨AIç”Ÿæˆåˆå§‹æ ‘ï¼Œä¼ å…¥ä¸»é¢˜å‚æ•°
      aiGenerateInitialTreeMini({
        templateKey: 'ç”Ÿæˆåˆå§‹æ ‘',
        miniPrompt: 'è¯·è¾“å…¥æ€ç»´å¯¼å›¾ä¸»é¢˜',
        placeholders: {
          name: { desc: 'åˆå§‹ä¸»é¢˜', value: topic }
        },
        autoRun: true
      });

      // å¿«é€ŸAIæ¨¡å¼ä¸‹ï¼Œå¼¹çª—éšè—é€»è¾‘ç”±AIç»“æœå¤„ç†å‡½æ•°è´Ÿè´£
      if (!isQuickAI) {
        // éå¿«é€ŸAIæ¨¡å¼ï¼šå»¶è¿Ÿå…³é—­å¼¹çª—ï¼ˆç¡®ä¿AIçª—å£å·²å¼¹å‡ºï¼‰
        setTimeout(function () {
          closeAIGenerateModal();
        }, 500);
      }
    }

    // æ˜¾ç¤ºåŠ è½½æç¤ºå¼¹çª—
    function showLoadingModal(message) {
      // å¦‚æœå·²å­˜åœ¨åŠ è½½å¼¹çª—ï¼Œå…ˆç§»é™¤
      hideLoadingModal();

      var modalHtml = `
        <div id="loadingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; max-width: 360px;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">AIç”Ÿæˆåˆå§‹æ ‘</h3>
            <div style="text-align: center; padding: 20px 0;">
              <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #4c9aff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
              <p style="margin: 16px 0 0 0; color: #666; font-size: 14px;">${message || 'æ­£åœ¨ç”Ÿæˆæ€ç»´å¯¼å›¾ï¼Œè¯·ç¨å€™...'}</p>
            </div>
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
            </style>
          </div>
        </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    // éšè—åŠ è½½æç¤ºå¼¹çª—
    function hideLoadingModal() {
      var modal = document.getElementById('loadingModal');
      if (modal) {
        modal.remove();
      }
    }
  </script>

  <script>
    // æ·»åŠ å­æ ‘åŠŸèƒ½ç›¸å…³å‡½æ•°
    function showAddSubtreeModal() {
      // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†èŠ‚ç‚¹
      const selectedNode = jm.get_selected_node ? jm.get_selected_node() : null;
      if (!selectedNode) {
        _show('warn', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
        return;
      }

      // åˆ›å»ºæ¨¡æ€å¼¹çª—
      var modalHtml = `
        <div id="addSubtreeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 500px; max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">æ·»åŠ å­æ ‘</h3>
            <div style="margin-bottom: 20px; flex: 1; display: flex; flex-direction: column;">
              <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">Markdownå†…å®¹ï¼š</label>
              <textarea id="subtreeMarkdownInput" placeholder="è¯·ç²˜è´´markdownæ ¼å¼çš„å†…å®¹ï¼Œå°†è½¬æ¢ä¸ºå­æ ‘ç»“æ„..." 
                       style="width: 100%; height: 300px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; box-sizing: border-box; font-family: monospace; resize: vertical;"></textarea>
              <div style="margin-top: 8px; font-size: 12px; color: #666;">æç¤ºï¼šæ”¯æŒç›´æ¥ç²˜è´´å¯Œæ–‡æœ¬å†…å®¹ï¼Œå°†è‡ªåŠ¨è½¬æ¢ä¸ºmarkdownæ ¼å¼</div>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeAddSubtreeModal()" style="padding: 6px 16px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
              <button onclick="confirmAddSubtree()" style="padding: 6px 16px; border: none; background: #4c9aff; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">ç¡®å®š</button>
            </div>
          </div>
        </div>
      `;

      // æ·»åŠ åˆ°body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // èšç„¦è¾“å…¥æ¡†
      setTimeout(function () {
        document.getElementById('subtreeMarkdownInput').focus();
      }, 100);

      // æ·»åŠ å¿«æ·é”®æ”¯æŒ (Ctrl+Enter ç¡®è®¤)
      document.getElementById('subtreeMarkdownInput').addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.key === 'Enter') {
          confirmAddSubtree();
        }
      });

      // æ·»åŠ ç²˜è´´äº‹ä»¶å¤„ç†ï¼Œæ”¯æŒå¯Œæ–‡æœ¬è½¬Markdown
      document.getElementById('subtreeMarkdownInput').addEventListener('paste', function (e) {
        handlePasteForMarkdown(e, this, _show);
      });
    }

    function closeAddSubtreeModal() {
      var modal = document.getElementById('addSubtreeModal');
      if (modal) {
        modal.remove();
      }
    }

    function confirmAddSubtree() {
      var markdownInput = document.getElementById('subtreeMarkdownInput');
      var markdown = markdownInput ? markdownInput.value.trim() : '';

      if (!markdown) {
        _show('warn', 'è¯·è¾“å…¥markdownå†…å®¹');
        return;
      }

      // å…³é—­å¼¹çª—
      closeAddSubtreeModal();

      // å¤„ç†å­æ ‘æ·»åŠ 
      processAddSubtree(markdown);
    }

    function processAddSubtree(markdown) {
      try {
        const selectedNode = jm.get_selected_node ? jm.get_selected_node() : null;
        if (!selectedNode) {
          _show('warn', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingModal('æ­£åœ¨è§£æå¹¶æ·»åŠ å­æ ‘...');

        // ä½¿ç”¨converterå°†markdownè½¬æ¢ä¸ºnodetree
        if (window && window.converter && typeof window.converter.mdToNodeTree === 'function') {
          try {
            const nodeTree = window.converter.mdToNodeTree(markdown);
            if (nodeTree) {
              // ä½¿ç”¨insertNodeTreeChildrenå°†å­æ ‘æ·»åŠ åˆ°é€‰ä¸­èŠ‚ç‚¹ä¸‹
              insertNodeTreeChildren(selectedNode.id, nodeTree, 'subtree_' + Date.now());
              _show('success', 'å­æ ‘æ·»åŠ æˆåŠŸ');
              
              // ä¿å­˜æ›´æ”¹
              if (typeof debouncedSave === 'function') debouncedSave();
              
              // è®°å½•æ’¤é”€çŠ¶æ€
              if (window.undoManager && typeof window.undoManager.recordIfChanged === 'function') {
                try {
                  window.undoManager.recordIfChanged();
                } catch (e) {
                  console.warn('[æ·»åŠ å­æ ‘] æ— æ³•è®°å½•çŠ¶æ€å˜åŒ–:', e);
                }
              }
            } else {
              _show('error', 'markdownè§£æå¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„æ ‘ç»“æ„');
            }
          } catch (convErr) {
            console.error('mdToNodeTree error:', convErr);
            _show('error', 'markdownå†…å®¹è§£æå¤±è´¥: ' + (convErr.message || 'æœªçŸ¥é”™è¯¯'));
          }
        } else {
          _show('error', 'è½¬æ¢å™¨æœªåŠ è½½ï¼Œæ— æ³•è§£æmarkdownå†…å®¹');
        }
      } catch (err) {
        console.error('æ·»åŠ å­æ ‘å¤±è´¥:', err);
        _show('error', 'æ·»åŠ å­æ ‘å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
      } finally {
        hideLoadingModal();
      }
    }
  </script>
</body>

</html>