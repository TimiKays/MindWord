<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="../jsmind-local/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>



  <link rel="stylesheet" href="mindmap.css">

</head>

</head>

<body>
  <div class="toolbar">
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->


    <span class="ico-btn" role="button" onclick="downloadMindmap()" tabindex="0" title="ä¸‹è½½å›¾ç‰‡"
      style="--ico: url('res/download.svg'); "></span>
    <span class="ico-btn" role="button" onclick="exportData()" tabindex="0" title="æŸ¥çœ‹JSON"
      style="--ico: url('res/code.svg'); "></span>


    <!-- å›¾æ ‡é€‰æ‹©å™¨ä¸‹æ‹‰èœå•ï¼ˆå·²å®šåˆ¶ï¼šéšè—é»˜è®¤ caretã€åªä¿ç•™ç½‘æ ¼å†…ç¬¬ä¸€ä¸ªâ€œæ¸…é™¤â€æŒ‰é’®ï¼‰ -->
    <style>
      /* éšè— Bootstrap çš„ä¸‹æ‹‰å°ç®­å¤´å¹¶å»æ‰å¯èƒ½çš„èšç„¦åŠ¨ç”»/outline */
      #iconPickerBtn.dropdown-toggle::after {
        display: none !important;
      }

      #iconPickerBtn:focus {
        outline: none !important;
        box-shadow: none !important;
      }

      /* å·¥å…·æ å†…å›¾æ ‡æŒ‰é’®ä¿è¯ emoji å¯è§ */
      #iconGridToolbar .icon-picker-item {
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", system-ui, sans-serif;
        color: #222 !important;
        font-size: 20px !important;
        line-height: 1;
        padding: 0;
        background: white !important;
      }

      /* å»æ‰ä¸‹æ‹‰èœå•è‡ªèº«çš„åŠ¨ç”»ï¼ˆè‹¥å­˜åœ¨ï¼‰ */
      #iconPickerDropdown .dropdown-menu {
        transition: none !important;
        -webkit-transition: none !important;
        -moz-transition: none !important;

      }
    </style>

    <div class="dropdown" id="iconPickerDropdown" style="display: inline-block;">

      <span id="iconPickerBtn" class="ico-btn dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true"
        aria-expanded="false" title="é€‰æ‹©å›¾æ ‡" tabindex="0" style="--ico: url('res/tag.svg');"></span>
      <div class="dropdown-menu" aria-labelledby="iconPickerBtn"
        style="width: 360px; max-height: 420px; overflow-y: auto; overflow-x: hidden;">
        <div style="padding: 12px;">
          <h6 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">é€‰æ‹©å›¾æ ‡</h6>
          <div id="iconGridToolbar"
            style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding-bottom:8px; box-sizing: border-box; column-gap:6px;">
            <!-- å›¾æ ‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆï¼ˆç¬¬ä¸€ä¸ªä¸ºæ¸…é™¤ï¼‰ -->
          </div>
        </div>
        <!-- å·²ç§»é™¤é‡å¤çš„åº•éƒ¨æ¸…é™¤æŒ‰é’®ï¼ˆä»…ä¿ç•™ç½‘æ ¼ä¸­çš„ç¬¬ä¸€ä¸ªæ¸…é™¤æŒ‰é’®ï¼‰ -->
      </div>
    </div>

    <!-- batchOperations ä¿ç•™åœ¨ DOM ä¸­ä½†ä¼šè¢«ç§»åŠ¨åˆ°ç”»å¸ƒå·¦ä¸Šï¼ˆé€šè¿‡è„šæœ¬åœ¨éç§»åŠ¨ç«¯æ˜¾ç¤ºï¼‰ -->
    <div id="batchOperations"
      style="display: none; float: right; padding: 1px 6px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; ">å·²é€‰ä¸­ <span id="selectedCount">0</span>
        ä¸ªèŠ‚ç‚¹</span>
    </div>

    <!-- å³ä¾§ä¸‰ä¸ªç®€å•å¤é€‰æ¡†ï¼šè¯¦æƒ…é¢æ¿ / æ˜¾ç¤ºèŠ‚ç‚¹ç±»å‹ / æ˜¾ç¤ºåˆ—è¡¨èŠ‚ç‚¹ -->
    <div id="toolbarToggles"
      style="margin-left:auto;display:flex;gap:12px;align-items:flex-end;justify-content:flex-end;">
      <span id="toggleNodeDetailsBtn" class="ico-btn state-on" role="button" tabindex="0" aria-pressed="true"
        title="è¯¦æƒ…é¢æ¿" style="--ico: url('res/detail.svg'); "></span>
      <label class="mw-toggle-showtype"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowNodeTypeCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">æ˜¾ç¤ºç±»å‹</span>
      </label>
      <label class="mw-toggle-showtitleonly"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowListNodesCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">åªçœ‹æ ‡é¢˜</span>
      </label>
    </div>





  </div>

  <div class="main-container">
    <div id="fullScreenMindmap"></div>



    <!-- æµ®åŠ¨èŠ‚ç‚¹è¯¦æƒ…é¢æ¿ï¼ˆå¯å…³é—­ï¼‰ï¼Œä¿ç•™å†…éƒ¨å­—æ®µå’ŒåŠŸèƒ½ -->
    <div id="nodeDetails" role="dialog" aria-hidden="true" aria-label="èŠ‚ç‚¹è¯¦æƒ…">
      <div class="panel-header">
        <strong>èŠ‚ç‚¹è¯¦æƒ…</strong>
        <button class="panel-close-btn" aria-label="å…³é—­èŠ‚ç‚¹è¯¦æƒ…" onclick="hideNodeDetails()">âœ•</button>
      </div>

      <div id="nodeDetailsEmpty" style="display:none; padding:24px; text-align:center; color:#64748b;">
        <img src="../res/empty.svg" alt="ç©ºçŠ¶æ€" style="width:72px;height:72px;opacity:0.9;margin-bottom:12px;">
        <div>è¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹</div>
      </div>

      <div id="nodeDetailsForm">
        <div id="nodeInfo"></div>

        <div class="form-group">
          <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
          <textarea id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜..." rows="3"
            style="width:100%; resize:vertical; line-height:1.4em;"></textarea>
        </div>

        <div class="form-group">
          <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
          <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
        </div>

        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
          <button class="btn" onclick="expandWithAI()"
            style="flex: 1; background: linear-gradient(135deg, #6da8e7, #6adbc8); color: white;">AIæ‰©å†™</button>
          <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #ffffff;"
            title="AIé…ç½®">âš™ï¸</button>
        </div>

        <!-- è‡ªåŠ¨æ›´æ–°æç¤º -->
        <div id="autoUpdateIndicator"
          style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
          <span style="display: inline-block; animation: pulse 1s ease-in-out;">âœ“</span> å·²è‡ªåŠ¨æ›´æ–°
        </div>

      </div>

      <!-- é€šçŸ¥æ¡¥æ¥å™¨ -->
      <script src="../notification-bridge.js"></script>

    </div>
  </div>
  </div>

  <script src="../jsmind-local/jsmind.js"></script>
  <script src="../jsmind-local/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <!-- ä½¿ç”¨ä¸jsMind 0.5.7ç‰ˆæœ¬åŒ¹é…çš„æˆªå›¾æ’ä»¶ -->
  <script src="../jsmind-local/jsmind.screenshot.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script src="plugins/undo_manager.js"></script>




  <script src="icons.js"></script>
  <script type="module" src="mindmap-core.js"></script>
  <script>

    /* mindmap-ui.js - UI related extracted scripts */


    // --- extracted block from original HTML ---
    // AIæ‰©å†™å‡½æ•°ï¼ˆæ”¹ä¸ºä½¿ç”¨çˆ¶å±‚æ‰˜ç®¡çš„ AI å¼¹çª—ç»„ä»¶ï¼Œmodal æ¨¡å¼ï¼‰
    function expandWithAI() {
      try {
        const selectedNode = jm.get_selected_node();
        if (!selectedNode) {
          showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
          return;
        }

        // æ„é€  requestId
        function genId() { return 'r_' + Math.random().toString(36).slice(2, 10); }
        const requestId = genId();

        // å‡†å¤‡ templateDataï¼šä½¿ç”¨é¢„è®¾æ¨¡æ¿ï¼ˆæ‰©å±•å­èŠ‚ç‚¹ï¼‰ï¼Œå¹¶æ³¨å…¥çœŸå®ä¸Šä¸‹æ–‡
        var topic = selectedNode.topic || '';
        // ä¼˜å…ˆä»æœ€æ–°èŠ‚ç‚¹æ•°æ®è¯»å–å¤‡æ³¨ï¼›å›é€€åˆ°è¯¦æƒ…é¢æ¿è¾“å…¥
        var _nodeLatest = null;
        try { _nodeLatest = jm.get_node ? jm.get_node(selectedNode.id) : selectedNode; } catch (_) { _nodeLatest = selectedNode; }
        var notes = (_nodeLatest && _nodeLatest.data && _nodeLatest.data.notes) ? _nodeLatest.data.notes
          : (document.getElementById('nodeNotes') ? document.getElementById('nodeNotes').value : '');

        // è®¡ç®— fullPath ä¸ siblingNodesï¼ˆè‹¥å¯ç”¨ï¼‰
        function _computeFullPath(n) {
          try {
            if (typeof window.getNodeFullPath === 'function') return window.getNodeFullPath(n);
          } catch (_) { /* ignore */ }
          try {
            var path = [];
            var cur = n;
            while (cur) {
              path.unshift(cur.topic || '');
              var p = jm.get_parent ? jm.get_parent(cur.id) : null;
              if (!p) break;
              cur = p;
            }
            return path.join(' / ');
          } catch (e) {
            return n.topic || '';
          }
        }
        // ç»Ÿä¸€ä½¿ç”¨çœŸå®èŠ‚ç‚¹å¯¹è±¡ï¼Œé¿å…è½»é‡å¯¹è±¡ä¸¢å¤±çˆ¶é“¾/children
        var realSel = null;
        try { realSel = jm.get_node ? jm.get_node(selectedNode.id) : selectedNode; } catch (_) { realSel = selectedNode; }

        // å®Œæ•´è·¯å¾„ï¼šä»æ ¹åˆ°å½“å‰èŠ‚ç‚¹
        function _computeFullPathStrict(n) {
          try {
            // è‹¥æœ‰å¤–éƒ¨å·¥å…·å‡½æ•°åˆ™ä¼˜å…ˆ
            if (typeof window.getNodeFullPath === 'function') return window.getNodeFullPath(n);
          } catch (_) { /* ignore */ }
          try {
            var path = [];
            var cur = n;
            while (cur) {
              path.unshift(cur.topic || '');
              cur = (jm.get_parent && cur.id) ? jm.get_parent(cur.id) : null;
            }
            return path.join(' / ');
          } catch (e) { return n && (n.topic || ''); }
        }
        var fullPath = '';
        try {
          fullPath = (realSel && realSel.data && (realSel.data.fullPath || (realSel.data.data && realSel.data.data.fullPath))) || '';
        } catch (e) {
          fullPath = (realSel && realSel.topic) ? realSel.topic : '';
        }

        // å…„å¼ŸèŠ‚ç‚¹ï¼šç›´æ¥ä»èŠ‚ç‚¹æ•°æ®ä¸­è¯»å–ï¼ˆä¼˜å…ˆä½¿ç”¨ data.siblingNodesï¼‰
        var siblingNodes = '';
        try {
          var sib = (realSel && realSel.data && (realSel.data.siblingNodes || (realSel.data.data && realSel.data.data.siblingNodes))) || [];
          if (Array.isArray(sib)) {
            siblingNodes = sib.filter(Boolean).join(', ');
          } else if (typeof sib === 'string') {
            siblingNodes = sib;
          }
        } catch (e) { siblingNodes = ''; }

        // ä» prompt-templates.json ä¸­è¯»å–â€œæ‰©å±•å­èŠ‚ç‚¹â€æ¨¡æ¿å†…å®¹ï¼ˆè‹¥æ— æ³•è®¿é—®åˆ™å›é€€ï¼‰
        var templateText = '';
        try {
          var tplList = window.__prompt_templates || null;
          if (!tplList) {
            // lazy load from ai/newai/prompt-templates.json if available via fetch (silent)
            try {
              // sync attempt may fail in file://; fallback to default string
              // we will try to read from a global if demo pages preloaded templates
              tplList = window.__prompt_templates || tplList;
            } catch (err) { tplList = tplList || null; }
          }
          if (Array.isArray(tplList)) {
            for (var ti = 0; ti < tplList.length; ti++) {
              var t = tplList[ti];
              if (t && t.name === 'æ‰©å±•å­èŠ‚ç‚¹') { templateText = t.content || ''; break; }
            }
          }
        } catch (e) { templateText = ''; }

        // æœ€ç»ˆå›é€€ç­–ç•¥ï¼šå¦‚æœæ²¡æœ‰æ¨¡æ¿åˆ™ä½¿ç”¨ topic æˆ–ç®€å•å ä½ç¬¦
        if (!templateText || !String(templateText).trim()) {
          templateText = topic || '{{name}}';
        }

        var payload = {
          // modal æ¨¡å¼ï¼šä¸è®¾ç½® mode æˆ–ç¡®ä¿ä¸æ˜¯ 'direct'
          platformConfig: {}, // å¯é€‰ï¼šç•™ç©ºç”±çˆ¶é¡µé¢é€‰æ‹©å·²ä¿å­˜å¹³å°æˆ–æ‰“å¼€é…ç½®
          modelConfig: {},
          templateData: {
            templateText: templateText,
            placeholders: {
              // å¯¹é½æ–°ç»„ä»¶é»˜è®¤å ä½ç¬¦æ ¼å¼ {{name}}
              name: { desc: 'èŠ‚ç‚¹ä¸»é¢˜', value: topic },
              notes: { desc: 'èŠ‚ç‚¹å¤‡æ³¨', value: notes },
              fullPath: { desc: 'èŠ‚ç‚¹å®Œæ•´è·¯å¾„', value: fullPath },
              siblingNodes: { desc: 'åŒçº§å…„å¼ŸèŠ‚ç‚¹ï¼ˆä»¥é€—å·åˆ†éš”ï¼‰', value: siblingNodes },
              nodeId: { desc: 'èŠ‚ç‚¹ID', value: selectedNode.id },
              // è¡¥å……ä¸Šä¸‹æ–‡æ‘˜è¦ï¼Œå¤ç”¨æ—§é€»è¾‘æ€æƒ³ï¼šæä¾›å¯è¯»æ–‡æœ¬ï¼Œä¾¿äºæ¨¡æ¿ç›´æ¥å¼•ç”¨ {{context}}
              context: {
                desc: 'èŠ‚ç‚¹ä¸Šä¸‹æ–‡æ‘˜è¦',
                value: (function () {
                  try {
                    var lines = [];
                    lines.push('èŠ‚ç‚¹: ' + (topic || ''));
                    lines.push('è·¯å¾„: ' + (fullPath || ''));
                    if (notes) lines.push('å¤‡æ³¨: ' + notes);
                    if (parent && (parent.topic || '')) lines.push('çˆ¶èŠ‚ç‚¹: ' + (parent.topic || ''));
                    if (siblingNodes) lines.push('åŒçº§å…„å¼Ÿ: ' + siblingNodes);
                    var childTitles = (selectedNode.children || []).map(function (c) { return c.topic || ''; }).filter(Boolean).join(', ');
                    if (childTitles) lines.push('å·²æœ‰å­èŠ‚ç‚¹: ' + childTitles);
                    return lines.join('\\n');
                  } catch (e) {
                    return (topic || '') + '\\n' + (fullPath || '');
                  }
                })()
              }
            }
          },
          options: {}
        };

        // æŒ‡å®šé¢„ç½®æ¨¡æ¿ key ä¸å‚æ•°æ˜ å°„ï¼Œä¾¿äºå¼¹çª—è‡ªåŠ¨é€‰ä¸­æ¨¡æ¿å’Œå±•ç¤ºå‚æ•°
        try { payload.templateData.templateKey = 'æ‰©å±•å­èŠ‚ç‚¹'; } catch (e) { }
        try { payload.params = payload.templateData.placeholders; } catch (e) { }

        // ä¸´æ—¶æ¶ˆæ¯å¤„ç†å™¨ï¼šç­‰å¾… AI_MODAL_RESULT å›æ¥
        const onMessage = function (e) {
          try {
            const msg = e && e.data;
            if (!msg || msg.type !== 'AI_MODAL_RESULT' || msg.requestId !== requestId) return;
            // æ¸…ç†
            window.removeEventListener('message', onMessage);
            clearTimeout(timeoutT);

            if (msg.status === 'ok') {
              try {
                const detail = msg.detail || {};
                // æœŸæœ› detail ä¸­åŒ…å«ç”Ÿæˆçš„å†…å®¹ï¼ˆä¾‹å¦‚ detail.output æˆ– detail.textï¼‰
                // æ”¯æŒä¸¤ç§å¸¸è§æ ¼å¼ï¼šdetail.outputï¼ˆå¸¦ [OUTPUT] åŒ…è£¹ï¼‰æˆ– detail.text
                const outText = detail.output || detail.text || (detail.result && detail.result.text) || '';
                if (!outText) {
                  showWarning('AI æœªè¿”å›æœ‰æ•ˆå†…å®¹');
                  return;
                }

                // å°† AI è¿”å›çš„æ–‡æœ¬è§£æä¸ºè‹¥å¹²å­èŠ‚ç‚¹ï¼ˆç®€å•æŒ‰æ¢è¡Œåˆ†å‰²æ ‡é¢˜è¡Œæˆ– Markdown æ ‡é¢˜ï¼‰
                // è‹¥è¿”å›ç»“æ„åŒ– [OUTPUT] æ ‡ç­¾ï¼Œå°è¯•æå–æ ‡ç­¾å†…å†…å®¹
                let parsed = outText;
                const m = /\[OUTPUT\]([\s\S]*)\[\/OUTPUT\]/i.exec(outText);
                if (m && m[1]) parsed = m[1].trim();

                // ç®€å•è§£æç­–ç•¥ï¼šæŒ‰è¡Œå–ä»¥ '#' å¼€å¤´çš„æ ‡é¢˜æˆ–éç©ºè¡Œä½œä¸ºå­èŠ‚ç‚¹æ ‡é¢˜
                // å¤„ç†å…¼å®¹æ€§ï¼šå…ˆå»é™¤ \r å†æŒ‰ '\n' åˆ†å‰²ï¼Œé¿å…æ­£åˆ™å­—é¢é‡è¢«æ ¼å¼åŒ–å™¨æ‹†è¡Œ
                var normalized = (parsed || '').replace(/\r/g, '');
                var lines = normalized.split('\n').map(function (s) { return (s || '').trim(); }).filter(function (s) { return !!s; });
                var childTitles = [];
                lines.forEach(function (line) {
                  var h = (line || '').replace(/^#+\s*/, '').trim();
                  if (h) childTitles.push(h);
                });
                if (childTitles.length === 0) {
                  // é€€å›åˆ°æŒ‰æ®µè½åˆ†å‰²ï¼šæŒ‰è¿ç»­ç©ºè¡Œï¼ˆ'\n\n' æˆ– æ›´å¤šï¼‰åˆ†å‰²
                  var paras = normalized.split(/\n{2,}/).map(function (s) { return (s || '').trim(); }).filter(function (s) { return !!s; });
                  paras.forEach(function (p) {
                    var firstLine = (p.split('\n')[0] || '').trim();
                    if (firstLine) childTitles.push(firstLine);
                  });
                }

                if (childTitles.length === 0) {
                  showWarning('æ— æ³•ä» AI è¾“å‡ºè§£æå‡ºå­èŠ‚ç‚¹ï¼Œè¯·æ£€æŸ¥è¾“å‡ºæ ¼å¼');
                  return;
                }

                // æ’å…¥å­èŠ‚ç‚¹ï¼ˆä½¿ç”¨ jm APIï¼Œæ’å…¥åˆ° selectedNode ä¸‹ï¼‰
                childTitles.forEach(function (title) {
                  try {
                    // ä½¿ç”¨ jm.add_node(parentid, nodeid, topic)
                    const nid = 'n_' + Math.random().toString(36).slice(2, 9);
                    jm.add_node(selectedNode.id, nid, title);
                  } catch (e) {
                    console.warn('æ’å…¥å­èŠ‚ç‚¹å¤±è´¥', e);
                  }
                });

                // ä¿å­˜ / æç¤º
                try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
                try { showSuccess && showSuccess('å·²ä¸ºè¯¥èŠ‚ç‚¹ç”Ÿæˆ ' + childTitles.length + ' ä¸ªå­èŠ‚ç‚¹'); } catch (e) { }
              } catch (err) {
                console.error('å¤„ç† AI ç»“æœå¤±è´¥', err);
                showError('å¤„ç† AI ç»“æœå¤±è´¥: ' + (err && err.message ? err.message : String(err)));
              }
            } else {
              // error
              const detailMsg = (msg.detail && msg.detail.message) ? msg.detail.message : 'AI è¿”å›é”™è¯¯';
              showError('AI ç”Ÿæˆå¤±è´¥: ' + detailMsg);
            }
          } catch (e) {
            console.warn('expandWithAI onMessage error', e);
          }
        };

        window.addEventListener('message', onMessage);

        // è¶…æ—¶ä¿æŠ¤ï¼ˆ30sï¼‰ï¼šä»…åœ¨éåµŒå…¥ï¼ˆé modalï¼‰åœºæ™¯æ˜¾ç¤ºå…¨å±€é”™è¯¯ï¼›åµŒå…¥åœºæ™¯ç”±çˆ¶é¡µé¢/modal å¤„ç†è¶…æ—¶
        const timeoutT = setTimeout(function () {
          try {
            // å…ˆç§»é™¤ç›‘å¬ï¼Œé¿å…åç»­é‡å¤è§¦å‘
            window.removeEventListener('message', onMessage);
            // è‹¥å½“å‰é¡µé¢è¢«åµŒå…¥åˆ°çˆ¶é¡µé¢ï¼ˆé€šå¸¸è¡¨ç¤ºä¼šç”±çˆ¶é¡µé¢æ˜¾ç¤º modalï¼‰ï¼Œåˆ™è·³è¿‡æœ¬åœ°çš„é”™è¯¯æç¤º
            const isEmbedded = (window.parent && window.parent !== window);
            if (isEmbedded) {
              console.debug('[MW][AI] timeout skipped: parent/modal should handle it', requestId);
              // å¯é€‰ï¼šé€šçŸ¥çˆ¶çª—å£è¶…æ—¶ï¼ˆæ³¨é‡Šæ‰ä»¥é¿å…å¤šä½™æ¶ˆæ¯ï¼‰
              // try { window.parent.postMessage({ type: 'AI_MODAL_TIMEOUT', requestId: requestId }, '*'); } catch (_) {}
              return;
            }
            // éåµŒå…¥ï¼ˆheadlessï¼‰åœºæ™¯æ˜¾ç¤ºæœ¬åœ°é”™è¯¯
            showError('AI å“åº”è¶…æ—¶ï¼ˆ30sï¼‰');
          } catch (e) { }
        }, 30000);

        // å‘é€è¯·æ±‚ç»™çˆ¶é¡µé¢
        try {
          console.log('[MW][AI] send AI_MODAL_OPEN_REQUEST', requestId, payload);
          window.parent.postMessage({ type: 'AI_MODAL_OPEN_REQUEST', requestId: requestId, payload: payload }, '*');
        } catch (e) {
          clearTimeout(timeoutT);
          window.removeEventListener('message', onMessage);
          console.error('å‘é€ AI è¯·æ±‚å¤±è´¥', e);
          showError('å‘é€ AI è¯·æ±‚å¤±è´¥: ' + e.message);
        }

      } catch (e) {
        console.error('AIæ‰©å†™å‡ºé”™:', e);
        showError('AIæ‰©å†™å‡ºé”™: ' + e.message);
      }
    }

    // éšè—/æ˜¾ç¤ºæµ®åŠ¨é¢æ¿çš„ APIï¼ˆä¾› showNodeDetails è°ƒç”¨ï¼‰
    function hideNodeDetails() {
      const p = document.getElementById('nodeDetails');
      if (p) {
        p.style.display = 'none';
        p.setAttribute('aria-hidden', 'true');
        // å®‰å…¨ç§»é™¤æ‹–æ‹½ç›‘å¬ï¼ˆè‹¥åœ¨é—­åŒ…ä¸­å®šä¹‰åˆ™ä¸ä¼šæŠ›é”™ï¼‰
        if (typeof removeNodeDetailsDragHandlers === 'function') {
          try { removeNodeDetailsDragHandlers(); } catch (e) { /* ignore */ }
        } else if (typeof window.removeNodeDetailsDragHandlers === 'function') {
          try { window.removeNodeDetailsDragHandlers(); } catch (e) { /* ignore */ }
        }
      }
      // åŒæ­¥å…³é—­â€œè¯¦æƒ…é¢æ¿â€å¼€å…³ï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨å†å¼€å¯
      try {
        window.__nodeDetailsEnabled = false;
        const cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.checked = false;
          cb.setAttribute('aria-checked', 'false');
        }
        const btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.classList.remove('state-on');
          btn.classList.remove('state-default');
          btn.classList.add('state-off');
          btn.setAttribute('aria-pressed', 'false');
        }
      } catch (e) { /* ignore */ }
    }
    function showNodeDetailsPanel() {
      const p = document.getElementById('nodeDetails');
      if (p) {
        p.style.display = 'block';
        p.setAttribute('aria-hidden', 'false');
        // ä»…å½“é¢æ¿æœªè¢«ç”¨æˆ·ç§»åŠ¨è¿‡æ—¶ï¼Œæ‰é‡ç½®ä¸ºé»˜è®¤é å³ä½ç½®
        if (p.dataset.moved !== 'true') {
          p.style.right = '12px';
          p.style.left = 'auto';
          p.style.top = '80px';
        }
        // åˆå§‹åŒ–æ‹–æ‹½ç›‘å¬ï¼ˆå¹‚ç­‰ï¼‰
        try {
          if (typeof initNodeDetailsDragHandlers === 'function') {
            initNodeDetailsDragHandlers();
          } else if (typeof window.initNodeDetailsDragHandlers === 'function') {
            window.initNodeDetailsDragHandlers();
          }
        } catch (e) { /* ignore */ }
      }
    }

    /* æ‰“å¼€è¯¦æƒ…é¢æ¿å¹¶æç¤ºâ€œè¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹â€ */
    function showEmptyDetailsPrompt() {
      try {
        if (window.__nodeDetailsEnabled === false) {
          try { console.log('[MW][details][UI] skip empty: toggle disabled'); } catch (e) { }
          return;
        }
        // ç¡®ä¿é¢æ¿å¯è§
        try { showNodeDetailsPanel(); } catch (e) { try { console.warn('[MW][details][UI] showNodeDetailsPanel failed', e); } catch (ee) { } }
        var panel = document.getElementById('nodeDetails');
        var empty = document.getElementById('nodeDetailsEmpty');
        var form = document.getElementById('nodeDetailsForm');
        var info = document.getElementById('nodeInfo');
        var topic = document.getElementById('nodeTopic');
        var notes = document.getElementById('nodeNotes');

        // åˆ‡æ¢ä¸ºç©ºçŠ¶æ€ï¼šæ˜¾ç¤ºç©ºè§†å›¾ï¼Œéšè—è¡¨å•
        if (empty) empty.style.display = 'block';
        if (form) form.style.display = 'none';

        if (topic) topic.value = '';
        if (notes) notes.value = '';

        // å…³é”®æ—¥å¿—ï¼šè¾“å‡ºå„å…ƒç´ ä¸å¯è§æ€§
        try {
          console.log('[MW][details][UI] showEmptyDetailsPrompt:',
            {
              panelExists: !!panel,
              panelDisplay: panel && panel.style ? panel.style.display : undefined,
              panelAriaHidden: panel ? panel.getAttribute('aria-hidden') : undefined,
              emptyExists: !!empty,
              emptyDisplay: empty && empty.style ? empty.style.display : undefined,
              formExists: !!form,
              formDisplay: form && form.style ? form.style.display : undefined
            }
          );
        } catch (e) { }
      } catch (e) {
        try { console.warn('[MW][details][UI] showEmptyDetailsPrompt error', e); } catch (ee) { }
      }
    }

    try { window.showEmptyDetailsPrompt = showEmptyDetailsPrompt; } catch (e) { /* ignore */ }
    // ç¼©æ”¾ä¸­å¿ƒä¿®æ­£ï¼šåœ¨é¼ æ ‡/è§¦æ‘¸ä½ç½®è®¾ç½® transform-originï¼Œé…åˆç°æœ‰åº“ç¼©æ”¾ä»¥è¯¥ç‚¹ä¸ºä¸­å¿ƒ
    (function setupZoomOrigin() {
      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;
      function setOrigin(clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        container.style.transformOrigin = `${x}px ${y}px`;
      }
      // é¼ æ ‡æ»šè½®ï¼šåœ¨ç¼©æ”¾å‰è®¾ç½® origin
      container.addEventListener('wheel', function (e) {
        if (e.ctrlKey || e.metaKey || e.shiftKey || e.altKey) {
          // è‹¥ç”¨æˆ·åŒæ—¶æŒ‰é”®ï¼Œä»æ”¯æŒï¼Œä½†ä¼˜å…ˆè®¾ç½® origin
        }
        setOrigin(e.clientX, e.clientY);
        // ä¸é˜»æ­¢åŸç”Ÿæ»šåŠ¨/ç¼©æ”¾é€»è¾‘ï¼Œè®©ç°æœ‰åº“å¤„ç†å®é™…ç¼©æ”¾
      }, { passive: true });
      // è§¦æ‘¸ï¼šè®°å½•è§¦æ‘¸ç‚¹ä»¥è®¾ç½® originï¼ˆç”¨äºåŒæŒ‡ç¼©æ”¾å‰ï¼‰
      container.addEventListener('touchstart', function (e) {
        if (!e.touches || e.touches.length === 0) return;
        const t = e.touches[0];
        setOrigin(t.clientX, t.clientY);
      }, { passive: true });
    })();


    /* æ‹–æ‹½æ”¯æŒï¼šé¼ æ ‡ä¸è§¦æ‘¸ */
    (function () {
      let dragging = false;
      let startX = 0, startY = 0;
      let origLeft = 0, origTop = 0;
      let handlersAdded = false;



      function onPointerDown(e) {
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        dragging = true;
        p.style.transition = 'none';
        const rect = p.getBoundingClientRect();
        origLeft = rect.left;
        origTop = rect.top;
        if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        } else {
          startX = e.clientX;
          startY = e.clientY;
        }
        // prevent iframe text selection during drag
        document.body.style.userSelect = 'none';
      }

      function onPointerMove(e) {
        if (!dragging) return;
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        let cx = (e.type === 'touchmove') ? e.touches[0].clientX : e.clientX;
        let cy = (e.type === 'touchmove') ? e.touches[0].clientY : e.clientY;
        const dx = cx - startX;
        const dy = cy - startY;
        const left = origLeft + dx;
        const top = origTop + dy;
        // é™åˆ¶åˆ°è§†å£å†…
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const rect = p.getBoundingClientRect();
        const w = rect.width, h = rect.height;
        const minLeft = 8;
        const maxLeft = vw - w - 8;
        const minTop = 8;
        const maxTop = vh - h - 8;
        const nx = Math.min(Math.max(left, minLeft), Math.max(minLeft, maxLeft));
        const ny = Math.min(Math.max(top, minTop), Math.max(minTop, maxTop));
        // è®°å½•ä¸´æ—¶ä½ç§»é‡ï¼ŒonPointerUp ä¼šåŸºäºæ­¤åˆ¤æ–­æ˜¯å¦æ ‡è®°ä¸ºå·²ç§»åŠ¨
        try {
          p.dataset._dragMovedX = String(dx);
          p.dataset._dragMovedY = String(dy);
        } catch (e) { /* ignore */ }
        p.style.right = 'auto';
        p.style.left = nx + 'px';
        p.style.top = ny + 'px';
      }

      function onPointerUp() {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = '';
        const p = document.getElementById('nodeDetails');
        if (p) p.style.transition = '';
        // æ ‡è®°æ˜¯å¦å‘ç”Ÿè¿‡æ˜¾è‘—ä½ç§»ï¼Œé¡µé¢æœªåˆ·æ–°å‰ä¿æŒä½ç½®
        try {
          if (p) {
            const movedX = parseFloat(p.dataset._dragMovedX || '0');
            const movedY = parseFloat(p.dataset._dragMovedY || '0');
            if (Math.abs(movedX) > 2 || Math.abs(movedY) > 2) {
              p.dataset.moved = 'true';
            }
            delete p.dataset._dragMovedX;
            delete p.dataset._dragMovedY;
          }
        } catch (e) { /* ignore */ }
      }

      function initNodeDetailsDragHandlers() {
        if (handlersAdded) return;
        const p = document.getElementById('nodeDetails');
        if (!p) return;
        // ä½¿ç”¨ panel-header ä½œä¸ºæŠ“æ‰‹ï¼Œå¦‚æ— åˆ™å…¨é¢æ¿å¯æ‹–
        const handle = p.querySelector('.panel-header') || p;
        handle.addEventListener('mousedown', onPointerDown, { passive: true });
        window.addEventListener('mousemove', onPointerMove, { passive: true });
        window.addEventListener('mouseup', onPointerUp, { passive: true });
        handle.addEventListener('touchstart', onPointerDown, { passive: true });
        window.addEventListener('touchmove', onPointerMove, { passive: true });
        window.addEventListener('touchend', onPointerUp, { passive: true });
        handlersAdded = true;
      }



      // å¦‚æœé¢æ¿å·²æ˜¾ç¤ºï¼Œåˆå§‹åŒ–ä¸€æ¬¡
      document.addEventListener('DOMContentLoaded', function () {
        const p = document.getElementById('nodeDetails');
        if (p && p.style.display !== 'none') initNodeDetailsDragHandlers();
      });
      // åœ¨çª—å£å¤§å°å˜åŒ–æ—¶å¾®è°ƒä½ç½®ï¼Œé¿å…è¶…å‡º
      window.addEventListener('resize', function () {
        const p = document.getElementById('nodeDetails');
        if (!p || p.style.display === 'none') return;
        const rect = p.getBoundingClientRect();
        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
        const maxLeft = Math.max(8, vw - rect.width - 8);
        const maxTop = Math.max(8, vh - rect.height - 8);
        let left = rect.left;
        let top = rect.top;
        if (left > maxLeft) left = maxLeft;
        if (top > maxTop) top = maxTop;
        p.style.left = left + 'px';
        p.style.top = top + 'px';
      });

    })();


    // --- extracted block from original HTML ---
    (function () {
      // èŠ‚ç‚¹è¯¦æƒ…å¼€å…³ï¼ˆé»˜è®¤å¼€å¯ï¼‰
      window.__nodeDetailsEnabled = (window.__nodeDetailsEnabled === undefined) ? true : !!window.__nodeDetailsEnabled;

      function updateToggleUI() {
        var enabled = !!window.__nodeDetailsEnabled;
        // å¤é€‰æ¡†ï¼ˆå…¼å®¹ä¿ç•™ï¼‰
        var cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.checked = enabled;
          cb.setAttribute('aria-checked', enabled ? 'true' : 'false');
        }
        // å›¾æ ‡æŒ‰é’®ï¼ˆæ–°ï¼‰
        var btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.classList.remove('state-on', 'state-off', 'state-default');
          btn.classList.add(enabled ? 'state-on' : 'state-off');
          btn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
        }
      }

      // åˆ‡æ¢å¤„ç†ï¼šå¯ç”¨æ—¶è‹¥å­˜åœ¨é€‰ä¸­èŠ‚ç‚¹ç«‹å³æ˜¾ç¤ºè¯¦æƒ…ï¼›ç¦ç”¨æ—¶éšè—é¢æ¿å¹¶é˜»æ­¢åç»­å¼¹å‡º
      function handleToggleChange(checked) {
        window.__nodeDetailsEnabled = !!checked;
        if (!window.__nodeDetailsEnabled) {
          if (typeof hideNodeDetails === 'function') {
            try { hideNodeDetails(); } catch (e) { /* ignore */ }
          }
        } else {
          // å¯ç”¨æ—¶ï¼šè‹¥æœ‰é€‰ä¸­èŠ‚ç‚¹ï¼Œç«‹å³æ˜¾ç¤ºå…¶è¯¦æƒ…ï¼›å¦åˆ™æ‰“å¼€é¢æ¿å¹¶æç¤ºâ€œè¯·é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹â€
          try {
            var sel = null;
            if (window.jm && typeof window.jm.get_selected_node === 'function') {
              sel = window.jm.get_selected_node();
            }
            if (sel) {
              try { showNodeDetails(sel); } catch (e) { /* ignore */ }
            } else {
              // æ— é€‰ä¸­èŠ‚ç‚¹ï¼šæ‰“å¼€é¢æ¿å¹¶æ˜¾ç¤ºç©ºçŠ¶æ€
              try { showEmptyDetailsPrompt(); } catch (e) { /* ignore */ }
            }
          } catch (e) { /* ignore */ }
        }
        updateToggleUI();
      }

      // æŒ‚è½½äº‹ä»¶
      document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ– UIï¼ˆæ— è®ºæ˜¯å¦æœ‰å¤é€‰æ¡†æˆ–æŒ‰é’®ï¼‰
        updateToggleUI();

        // å¤é€‰æ¡†ï¼ˆå…¼å®¹ï¼‰
        var cb = document.getElementById('toggleNodeDetailsCheckbox');
        if (cb) {
          cb.addEventListener('change', function (e) {
            handleToggleChange(!!e.target.checked);
          }, { passive: true });
          cb.addEventListener('keydown', function (e) {
            if (e.key === ' ' || e.key === 'Enter') {
              setTimeout(function () { handleToggleChange(!!cb.checked); }, 0);
            }
          });
        }

        // å›¾æ ‡æŒ‰é’®ï¼ˆæ–°ï¼‰
        var btn = document.getElementById('toggleNodeDetailsBtn');
        if (btn) {
          btn.addEventListener('click', function () {
            handleToggleChange(!window.__nodeDetailsEnabled);
          });
          btn.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleToggleChange(!window.__nodeDetailsEnabled);
            }
          });
        }
      });

      // åŒ…è£… showNodeDetailsï¼šè‹¥å¼€å…³å…³é—­åˆ™é™é»˜è¿”å›
      if (typeof window.showNodeDetails === 'function') {
        var _origShowNodeDetails = window.showNodeDetails;
        window.showNodeDetails = function (node) {
          if (window.__nodeDetailsEnabled === false) return;
          return _origShowNodeDetails.apply(this, arguments);
        };
      } else {
        // è‹¥å‡½æ•°å°šæœªå®šä¹‰ï¼Œå»¶è¿ŸåŒ…è£…ï¼ˆåœ¨åç»­å®šä¹‰æ—¶æ£€æµ‹ï¼‰
        var _tryWrap = function () {
          if (typeof window.showNodeDetails === 'function') {
            var _orig = window.showNodeDetails;
            window.showNodeDetails = function (node) {
              if (window.__nodeDetailsEnabled === false) return;
              return _orig.apply(this, arguments);
            };
            clearInterval(_tryWrapInterval);
          }
        };
        var _tryWrapInterval = setInterval(_tryWrap, 200);
      }
    })();


    // --- extracted block from original HTML ---
    (function mw_post_init_fix() {
      try {
        function isMobileNow() {
          var isSmallScreen = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
          var hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
          return isSmallScreen || (hasTouch && window.innerWidth <= 900);
        }

        function relocateBatchOpsIfNeeded() {
          try {
            var isMobile = isMobileNow();
            var batch = document.getElementById('batchOperations');
            var mw = document.getElementById('mw-batchops');
            if (!batch || !mw) return;
            if (!isMobile) {
              // copy count
              var sc = batch.querySelector('#selectedCount');
              var scVal = sc ? sc.textContent : '0';
              var targetStrong = mw.querySelector('#selectedCountDisplay');
              if (targetStrong) targetStrong.textContent = scVal;
              batch.style.display = 'none';
              mw.style.display = 'inline-flex';
              // keep references
              window.__mw_batch_source = batch;
              window.__mw_batch_target = mw;
            } else {
              batch.style.display = 'none';
              if (mw) mw.style.display = 'none';
            }
          } catch (e) { console.warn('[MW] relocateBatchOpsIfNeeded failed', e); }
        }

        function ensureDetailsToggleVisibleOnDesktop() {
          try {
            var cbDetails = document.getElementById('toggleNodeDetailsCheckbox');
            if (!cbDetails) return;
            var label = cbDetails.parentElement;
            if (!label) return;
            if (!isMobileNow()) {
              label.style.display = ''; // restore default
            }
          } catch (e) { /* ignore */ }
        }

        // sync selected count periodically (small cost, robust)
        function startSelectedCountSync() {
          try {
            var source = document.getElementById('batchOperations');
            var target = document.getElementById('mw-batchops');
            if (!source || !target) return;
            var sSrc = source.querySelector('#selectedCount');
            var sTgt = target.querySelector('#selectedCountDisplay');
            if (!sSrc || !sTgt) return;
            var last = null;
            setInterval(function () {
              try {
                var now = sSrc.textContent || sSrc.innerText || '0';
                if (now !== last) {
                  last = now;
                  sTgt.textContent = now;
                }
              } catch (e) { }
            }, 250);
          } catch (e) { /* ignore */ }
        }

        // run on load and on resize/orientationchange
        function boot() {
          relocateBatchOpsIfNeeded();
          ensureDetailsToggleVisibleOnDesktop();
          startSelectedCountSync();
        }

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          setTimeout(boot, 50);
        } else {
          document.addEventListener('DOMContentLoaded', function () { setTimeout(boot, 50); });
          window.addEventListener('load', function () { setTimeout(boot, 50); });
        }
        window.addEventListener('resize', function () { setTimeout(relocateBatchOpsIfNeeded, 60); });
        window.addEventListener('orientationchange', function () { setTimeout(relocateBatchOpsIfNeeded, 60); });
      } catch (e) {
        console.error('[MW] post init fix error', e);
      }
    })();


    // toolbar å›¾æ ‡é€‰æ‹©å™¨åˆå§‹åŒ– â€”â€” æ›´ç¨³å¥çš„å®ç°ï¼šä½¿ç”¨ textContentã€ç­‰å¾… availableIcons ä¸ jm å°±ç»ª
    (function () {
      function createToolbarIconGrid() {
        var grid = document.getElementById('iconGridToolbar');
        if (!grid) return;
        grid.innerHTML = '';

        // é¦–ä½ä¸ºæ¸…é™¤å›¾æ ‡æŒ‰é’®ï¼ˆç½‘æ ¼å†…å”¯ä¸€çš„æ¸…é™¤ï¼‰
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'icon-picker-item';
        clearBtn.title = 'æ¸…é™¤å›¾æ ‡';
        clearBtn.style.cssText = 'alpha:0.3;width:40px;height:40px;border:1px dashed #ddd;color:#dbdbdb !important;border-radius:4px;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;';
        clearBtn.textContent = 'ğŸš«';
        clearBtn.onclick = function (e) { e.stopPropagation(); clearIconFromToolbar(); };
        grid.appendChild(clearBtn);

        // å¦‚æœ MWIcons.getGroups å¯ç”¨ï¼ŒæŒ‰ç»„æ¸²æŸ“ï¼ˆå¸¦åˆ†ç»„æ ‡é¢˜ï¼‰
        var groups = (window.MWIcons && typeof window.MWIcons.getGroups === 'function') ? window.MWIcons.getGroups() : null;

        if (groups && Object.keys(groups).length > 0) {
          // åˆ›å»ºåˆ†ç»„å®¹å™¨
          Object.keys(groups).forEach(function (groupKey) {
            var group = groups[groupKey];
            // åˆ†ç»„æ ‡é¢˜
            var header = document.createElement('div');
            header.style.cssText = 'grid-column: 1 / -1; font-size:12px; font-weight:600; color:#333; padding:6px 0 4px 0;';
            header.textContent = (groupKey.charAt(0).toUpperCase() + groupKey.slice(1));
            grid.appendChild(header);

            // åˆ†ç»„å›¾æ ‡ç½‘æ ¼ï¼ˆ7åˆ—å†…ä½¿ç”¨ç›¸åŒæ ·å¼ï¼‰
            group.forEach(function (icon) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'icon-picker-item';
              btn.title = icon.name || '';
              btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
              btn.textContent = icon.emoji || '';
              btn.onclick = function (ev) {
                ev.stopPropagation();
                applyIconToSelection(icon.emoji);
                try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
              };
              btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
              btn.onmouseout = function () { btn.style.background = 'white'; };
              grid.appendChild(btn);
            });
          });
          return;
        }

        // å…¼å®¹å›é€€ï¼šæ‰å¹³åŒ– window.availableIcons æˆ–å…¨å±€ availableIcons
        var icons = (window.availableIcons && window.availableIcons.length) ? window.availableIcons
          : (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length) ? availableIcons
            : [];
        if (!icons || icons.length === 0) {
          // æ˜¾ç¤ºå ä½æç¤ºï¼ˆç”¨æˆ·çœ‹åˆ°ä¸ä¼šç©ºç™½ï¼‰
          var ph = document.createElement('div');
          ph.style.cssText = 'grid-column: 1 / -1; color:#6c757d; font-size:12px; padding:6px; text-align:center;';
          ph.textContent = 'å›¾æ ‡åº“åŠ è½½ä¸­...';
          grid.appendChild(ph);
          return;
        }

        icons.forEach(function (icon) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'icon-picker-item';
          btn.title = icon.name || '';
          btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
          btn.textContent = icon.emoji || '';
          btn.onclick = function (ev) {
            ev.stopPropagation();
            applyIconToSelection(icon.emoji);
            // å…³é—­ dropdownï¼ˆBootstrapï¼‰
            try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
          };
          btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
          btn.onmouseout = function () { btn.style.background = 'white'; };
          grid.appendChild(btn);
        });
      }

      // å®‰å…¨çš„åˆå§‹åŒ–ï¼šå¦‚æœ availableIcons å°šæœªå°±ç»ªï¼Œé‡å¤å°è¯•å‡ æ¬¡
      function initWithRetry(attemptsLeft) {
        try {
          if ((window.availableIcons && window.availableIcons.length > 0) || (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length > 0) || attemptsLeft <= 0) {
            createToolbarIconGrid();
            return;
          }
        } catch (e) { /* ignore */ }

        setTimeout(function () { initWithRetry(attemptsLeft - 1); }, 120);
      }

      // å°† emoji åº”ç”¨åˆ°å½“å‰é€‰ä¸­èŠ‚ç‚¹ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
      function applyIconToSelection(emoji) {
        if (!window.jm) {
          console.warn('jm æœªåˆå§‹åŒ–ï¼Œæ— æ³•åº”ç”¨å›¾æ ‡');
          return;
        }

        // è·å–å¤šé€‰ï¼ˆæ¡†é€‰ï¼‰æˆ–å•é€‰
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') {
            ids = window.getMultiSelection() || [];
          }
        } catch (e) { ids = []; }

        // è‹¥æ— å¤šé€‰ï¼Œåˆ™å°è¯•ç”¨ jm.get_selected_nodeï¼ˆå•é€‰ï¼‰
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }

        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ 1 ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹');
          return;
        }

        // å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„ topic å‰é¢æ’å…¥ emojiï¼ˆè‹¥å·²å­˜åœ¨è¡¨æƒ…åˆ™æ›¿æ¢ï¼‰
        // ä½¿ç”¨å®½æ¾çš„ emoji å»é™¤æ­£åˆ™ï¼ˆå…¼å®¹æ€§å·®æ—¶ä¹Ÿèƒ½å·¥ä½œï¼‰
        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            // ç§»é™¤å¼€å¤´çš„éå­—æ¯æ•°å­—ä¸éä¸­æ–‡å­—ç¬¦ï¼ˆå¤šåŠæ˜¯ emoji æˆ–ç¬¦å·ï¼‰
            topic = topic.replace(emojiStrip, '').trim();
            var newTopic = (emoji ? (emoji + ' ' + topic) : topic);
            jm.update_node(node.id, newTopic);
          } catch (e) {
            console.warn('åº”ç”¨å›¾æ ‡å¤±è´¥', e);
          }
        });

        // ä¿å­˜å¹¶æç¤º
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²åº”ç”¨å›¾æ ‡'); } catch (e) { }
      }

      // ä»é€‰ä¸­èŠ‚ç‚¹æ¸…é™¤å›¾æ ‡ï¼ˆç›¸å½“äº applyIconToSelection('')ï¼‰
      window.clearIconFromToolbar = function () {
        if (!window.jm) return;
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') ids = window.getMultiSelection() || [];
        } catch (e) { ids = []; }
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }
        if (!ids || ids.length === 0) {
          showWarning && showWarning('è¯·å…ˆé€‰ä¸­ èŠ‚ç‚¹');
          return;
        }

        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            topic = topic.replace(emojiStrip, '').trim();
            jm.update_node(node.id, topic);
          } catch (e) { console.warn('æ¸…é™¤å›¾æ ‡å¤±è´¥', e); }
        });
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('å·²æ¸…é™¤å›¾æ ‡'); } catch (e) { }
      };

      // åˆå§‹åŒ–å…¥å£ï¼šæœ€å¤šé‡è¯• 8 æ¬¡ï¼ˆæ¯æ¬¡ 120msï¼‰
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function () { initWithRetry(8); }, 120);
      } else {
        document.addEventListener('DOMContentLoaded', function () { setTimeout(function () { initWithRetry(8); }, 120); });
      }

      // åœ¨ jm åˆå§‹åŒ–åå†æ‰§è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ race
      window.MW_scheduleOnce && window.MW_scheduleOnce('initToolbarIconGrid', function () {
        initWithRetry(4);
      }, 300);
    })();
  </script>

</body>

</html>
</body>

</html>