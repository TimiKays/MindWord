<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>思维导图编辑器</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="../jsmind-local/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>



  <link rel="stylesheet" href="mindmap.css">
</head>

</head>

<body>
  <div class="toolbar">
    <!-- 批量操作工具栏 -->


    <button id="export-json-btn" class="btn" onclick="exportData()">查看JSON</button>
    <button class="btn" onclick="downloadMindmap()">下载图片</button>

    <!-- 图标选择器下拉菜单（已定制：隐藏默认 caret、只保留网格内第一个“清除”按钮） -->
    <style>
      /* 隐藏 Bootstrap 的下拉小箭头并去掉可能的聚焦动画/outline */
      #iconPickerBtn.dropdown-toggle::after { display: none !important; }
      #iconPickerBtn:focus { outline: none !important; box-shadow: none !important; }
      /* 工具栏内图标按钮保证 emoji 可见 */
      #iconGridToolbar .icon-picker-item {
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", system-ui, sans-serif;
        color: #222 !important;
        font-size: 20px !important;
        line-height: 1;
        padding: 0;
        background: white !important;
      }
      /* 去掉下拉菜单自身的动画（若存在） */
      #iconPickerDropdown .dropdown-menu {
        transition: none !important;
        -webkit-transition: none !important;
        -moz-transition: none !important;
        
      }
    </style>

    <div class="dropdown" id="iconPickerDropdown" style="display: inline-block;">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="iconPickerBtn" data-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false" title="选择图标">
        😊 图标
      </button>
      <div class="dropdown-menu" aria-labelledby="iconPickerBtn"
        style="width: 360px; max-height: 420px; overflow-y: auto; overflow-x: hidden;">
        <div style="padding: 12px;">
          <h6 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">选择图标</h6>
          <div id="iconGridToolbar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding-bottom:8px; box-sizing: border-box; column-gap:6px;">
            <!-- 图标将通过JavaScript动态生成（第一个为清除） -->
          </div>
        </div>
        <!-- 已移除重复的底部清除按钮（仅保留网格中的第一个清除按钮） -->
      </div>
    </div>

    <!-- 右侧三个简单复选框：详情面板 / 显示节点类型 / 显示列表节点 -->
    <div id="toolbarToggles"
      style="margin-left:auto;display:flex;gap:12px;align-items:flex-end;justify-content:flex-end;">
      <label class="mw-toggle-showdetails"
        style="display:flex;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleNodeDetailsCheckbox" type="checkbox" checked style="width:18px;height:18px;margin:6px auto;display:block;">
        <span style="display:block;margin-top:0;">详情面板</span>
      </label>
      <label class="mw-toggle-showtype"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowNodeTypeCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">显示类型</span>
      </label>
      <label class="mw-toggle-showtitleonly"
        style="display:none;flex-direction:column;align-items:center;font-size:12px;margin:0 4px;">
        <input id="toggleShowListNodesCheckbox" type="checkbox" style="width:18px;height:18px;margin-bottom:6px;">
        <span style="display:block;margin-top:0;">只看标题</span>
      </label>
    </div>



    <!-- batchOperations 保留在 DOM 中但会被移动到画布左上（通过脚本在非移动端显示） -->
    <div id="batchOperations"
      style="display: inline-block; margin-top: 2px; padding: 5px 10px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; margin-right: 10px;">已选中 <span id="selectedCount">0</span>
        个节点</span>
    </div>

  </div>

  <div class="main-container">
    <div id="fullScreenMindmap"></div>

    <!-- batchOperations 将在页面加载时被移动（非移动端）到 #fullScreenMindmap 左上角 -->


    <div id="mw-batchops" aria-hidden="false" style="display:none;">
      <span id="mw-batchops-text">已选中 <strong id="selectedCountDisplay">0</strong> 个节点</span>
    </div>

    <!-- 浮动节点详情面板（可关闭），保留内部字段和功能 -->
    <div id="nodeDetails" role="dialog" aria-hidden="true" aria-label="节点详情">
      <div class="panel-header">
        <strong>节点详情</strong>
        <button class="panel-close-btn" aria-label="关闭节点详情" onclick="hideNodeDetails()">✕</button>
      </div>

      <div id="nodeInfo"></div>

      <div class="form-group">
        <label for="nodeTopic">节点主题:</label>
        <textarea id="nodeTopic" placeholder="输入节点主题..." rows="3" style="width:100%; resize:vertical; line-height:1.4em;"></textarea>
      </div>

      <div class="form-group">
        <label for="nodeNotes">节点备注:</label>
        <textarea id="nodeNotes" placeholder="输入节点备注..."></textarea>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn" onclick="expandWithAI()"
          style="flex: 1; background: linear-gradient(135deg, #6da8e7, #6adbc8); color: white;">AI扩写</button>
        <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #ffffff;"
          title="AI配置">⚙️</button>
      </div>

      <!-- 自动更新提示 -->
      <div id="autoUpdateIndicator"
        style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
        <span style="display: inline-block; animation: pulse 1s ease-in-out;">✓</span> 已自动更新
      </div>

      <!-- 通知桥接器 -->
      <script src="../notification-bridge.js"></script>

    </div>
  </div>
  </div>

  <script src="../jsmind-local/jsmind.js"></script>
  <script src="../jsmind-local/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <!-- 使用与jsMind 0.5.7版本匹配的截图插件 -->
  <script src="../jsmind-local/jsmind.screenshot.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script src="plugins/undo_manager.js"></script>




  <script src="icons.js"></script>
  <script type="module" src="mindmap-core.js"></script>
  <script src="mindmap-ui.js"></script>

  <script>
    // toolbar 图标选择器初始化 —— 更稳健的实现：使用 textContent、等待 availableIcons 与 jm 就绪
    (function () {
      function createToolbarIconGrid() {
        var grid = document.getElementById('iconGridToolbar');
        if (!grid) return;
        grid.innerHTML = '';

        // 首位为清除图标按钮（网格内唯一的清除）
        var clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.className = 'icon-picker-item';
        clearBtn.title = '清除图标';
        clearBtn.style.cssText = 'alpha:0.3;width:40px;height:40px;border:1px dashed #ddd;color:#dbdbdb !important;border-radius:4px;background:#fff;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;';
        clearBtn.textContent = '🚫';
        clearBtn.onclick = function (e) { e.stopPropagation(); clearIconFromToolbar(); };
        grid.appendChild(clearBtn);

        // 如果 MWIcons.getGroups 可用，按组渲染（带分组标题）
        var groups = (window.MWIcons && typeof window.MWIcons.getGroups === 'function') ? window.MWIcons.getGroups() : null;

        if (groups && Object.keys(groups).length > 0) {
          // 创建分组容器
          Object.keys(groups).forEach(function (groupKey) {
            var group = groups[groupKey];
            // 分组标题
            var header = document.createElement('div');
            header.style.cssText = 'grid-column: 1 / -1; font-size:12px; font-weight:600; color:#333; padding:6px 0 4px 0;';
            header.textContent = (groupKey.charAt(0).toUpperCase() + groupKey.slice(1));
            grid.appendChild(header);

            // 分组图标网格（7列内使用相同样式）
            group.forEach(function (icon) {
              var btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'icon-picker-item';
              btn.title = icon.name || '';
              btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
              btn.textContent = icon.emoji || '';
              btn.onclick = function (ev) {
                ev.stopPropagation();
                applyIconToSelection(icon.emoji);
                try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
              };
              btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
              btn.onmouseout = function () { btn.style.background = 'white'; };
              grid.appendChild(btn);
            });
          });
          return;
        }

        // 兼容回退：扁平化 window.availableIcons 或全局 availableIcons
        var icons = (window.availableIcons && window.availableIcons.length) ? window.availableIcons
                  : (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length) ? availableIcons
                  : [];
        if (!icons || icons.length === 0) {
          // 显示占位提示（用户看到不会空白）
          var ph = document.createElement('div');
          ph.style.cssText = 'grid-column: 1 / -1; color:#6c757d; font-size:12px; padding:6px; text-align:center;';
          ph.textContent = '图标库加载中...';
          grid.appendChild(ph);
          return;
        }

        icons.forEach(function (icon) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'icon-picker-item';
          btn.title = icon.name || '';
          btn.style.cssText = 'width:40px;height:40px;border:1px solid #ddd;border-radius:4px;background:white;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;';
          btn.textContent = icon.emoji || '';
          btn.onclick = function (ev) {
            ev.stopPropagation();
            applyIconToSelection(icon.emoji);
            // 关闭 dropdown（Bootstrap）
            try { $('#iconPickerDropdown .dropdown-toggle').dropdown('toggle'); } catch (e) { }
          };
          btn.onmouseover = function () { btn.style.background = '#f0f0f0'; };
          btn.onmouseout = function () { btn.style.background = 'white'; };
          grid.appendChild(btn);
        });
      }

      // 安全的初始化：如果 availableIcons 尚未就绪，重复尝试几次
      function initWithRetry(attemptsLeft) {
        try {
          if ((window.availableIcons && window.availableIcons.length > 0) || (typeof availableIcons !== 'undefined' && availableIcons && availableIcons.length > 0) || attemptsLeft <= 0) {
            createToolbarIconGrid();
            return;
          }
        } catch (e) { /* ignore */ }

        setTimeout(function () { initWithRetry(attemptsLeft - 1); }, 120);
      }

      // 将 emoji 应用到当前选中节点（支持多选）
      function applyIconToSelection(emoji) {
        if (!window.jm) {
          console.warn('jm 未初始化，无法应用图标');
          return;
        }

        // 获取多选（框选）或单选
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') {
            ids = window.getMultiSelection() || [];
          }
        } catch (e) { ids = []; }

        // 若无多选，则尝试用 jm.get_selected_node（单选）
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }

        if (!ids || ids.length === 0) {
          showWarning && showWarning('请先选中 1 个或多个节点');
          return;
        }

        // 对每个节点的 topic 前面插入 emoji（若已存在表情则替换）
        // 使用宽松的 emoji 去除正则（兼容性差时也能工作）
        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            // 移除开头的非字母数字与非中文字符（多半是 emoji 或符号）
            topic = topic.replace(emojiStrip, '').trim();
            var newTopic = (emoji ? (emoji + ' ' + topic) : topic);
            jm.update_node(node.id, newTopic);
          } catch (e) {
            console.warn('应用图标失败', e);
          }
        });

        // 保存并提示
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('已应用图标'); } catch (e) { }
      }

      // 从选中节点清除图标（相当于 applyIconToSelection('')）
      window.clearIconFromToolbar = function () {
        if (!window.jm) return;
        var ids = [];
        try {
          if (typeof window.getMultiSelection === 'function') ids = window.getMultiSelection() || [];
        } catch (e) { ids = []; }
        if (!ids || ids.length === 0) {
          try {
            var sel = jm.get_selected_node && jm.get_selected_node();
            if (sel) {
              var selId = (typeof sel === 'string') ? sel : (sel.id || null);
              if (selId) ids = [selId];
            }
          } catch (e) { }
        }
        if (!ids || ids.length === 0) {
          showWarning && showWarning('请先选中 节点');
          return;
        }

        var emojiStrip = /^[^\w\u4e00-\u9fff\s]+/u;
        ids.forEach(function (id) {
          try {
            var node = jm.get_node(id);
            if (!node) return;
            var topic = node.topic || '';
            topic = topic.replace(emojiStrip, '').trim();
            jm.update_node(node.id, topic);
          } catch (e) { console.warn('清除图标失败', e); }
        });
        try { if (typeof debouncedSave === 'function') debouncedSave(); } catch (e) { }
        try { showSuccess && showSuccess('已清除图标'); } catch (e) { }
      };

      // 初始化入口：最多重试 8 次（每次 120ms）
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(function () { initWithRetry(8); }, 120);
      } else {
        document.addEventListener('DOMContentLoaded', function () { setTimeout(function () { initWithRetry(8); }, 120); });
      }

      // 在 jm 初始化后再执行一次，防止 race
      window.MW_scheduleOnce && window.MW_scheduleOnce('initToolbarIconGrid', function () {
        initWithRetry(4);
      }, 300);
    })();
  </script>

</body>

</html>