<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../styles.css">
  <link type="text/css" rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/style/jsmind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    // é¢„åŠ è½½AIæ¨¡å—
    import { AIExpander } from './ai-expander.js';
    import { AIConfigManager } from './ai-config.js';
    // å°†ç±»å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
    window.AIExpander = AIExpander;
    window.AIConfigManager = AIConfigManager;
  </script>
  <style>
    body {
      font-family: 'Consolas', 'Monaco', monospace;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      flex: 1;
      display: flex;
      height: calc(100vh - 60px);
    }

    #fullScreenMindmap {
      width: 70%;
      height: 100%;
      position: relative;
      background: white;
      overflow: auto;
      /* æ·»åŠ æ»šåŠ¨æ¡æ”¯æŒ */
    }

    /* jsmind èŠ‚ç‚¹å®¹å™¨æ»šåŠ¨æ”¯æŒ */
    #fullScreenMindmap .jsmind-inner {
      overflow: auto !important;
    }

    /* ç¡®ä¿æ€ç»´å¯¼å›¾èŠ‚ç‚¹å®¹å™¨å¯ä»¥æ»šåŠ¨ */
    #fullScreenMindmap .jmnodes {
      overflow: visible !important;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    #fullScreenMindmap::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #fullScreenMindmap::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    #fullScreenMindmap::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    #fullScreenMindmap::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    #nodeDetails {
      width: 30%;
      height: 100%;
      padding: 20px;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      background: #f8f9fa;
    }



    .node-info {
      background: white;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #495057;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: inherit;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 500px;
    }

    .notes-section {
      background: white;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .note-item {
      padding: 10px;
      border-left: 3px solid #007bff;
      background: #f8f9fa;
      margin-bottom: 10px;
      border-radius: 0 4px 4px 0;
    }

    .note-item h5 {
      margin: 0 0 5px 0;
      color: #fad503;
      font-size: 14px;
    }

    .note-item p {
      margin: 0;
      color: #495057;
      font-size: 12px;
      line-height: 1.4;
    }

    /* è‡ªåŠ¨æ›´æ–°åŠ¨ç”» */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .auto-update-show {
      animation: fadeIn 0.3s ease-in-out;
    }

    /* æ¡†é€‰çŸ©å½¢ä¸å¤šé€‰é«˜äº® */
    #selectionRect {
      position: fixed;
      border: 1px dashed #4c9aff;
      background: rgba(76, 154, 255, 0.15);
      pointer-events: none;
      display: none;
      z-index: 999;
    }



    /* å¤šé€‰èŠ‚ç‚¹æ‚¬åœæ•ˆæœ - å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ */
    /* #fullScreenMindmap .jmnode.multi-selected:hover { background-color: #3a8ce2; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); } */

    /* é€‰ä¸­èŠ‚ç‚¹çš„è„‰å†²åŠ¨ç”» - å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ */
    @keyframes pulse-multi {
      /* åŠ¨ç”»å·²ç¦ç”¨ï¼Œä¿ç•™ç©ºå…³é”®å¸§é¿å…å¼•ç”¨é”™è¯¯ */
    }

    /* å•é€‰å’Œå¤šé€‰èŠ‚ç‚¹æ ·å¼ç»Ÿä¸€å®šä¹‰ */
    #fullScreenMindmap .jmnode.selected:not(.multi-selected) {
      background-color: rgb(251, 255, 17);
      color: #fff;
      box-shadow: 2px 2px 8px #000;
    }

    /* å¤šé€‰èŠ‚ç‚¹åŸºç¡€æ ·å¼ - å·²ç§»é™¤ï¼Œåªä½¿ç”¨è¦†ç›–å±‚æ ·å¼ */
    /* #fullScreenMindmap .jmnode.multi-selected { background-color: #4c9aff; color: white; border: 4px solid #f8ad0b; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); } */

    /* èŠ‚ç‚¹æ–‡æœ¬æ¢è¡Œæ ·å¼ */
    #fullScreenMindmap .jmnode {
      white-space: normal;
      word-break: break-word;
      overflow: visible;
    }

    /* å¤šé€‰èŠ‚ç‚¹å±•å¼€å™¨æ ·å¼ - å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ */
    /* #fullScreenMindmap .jmnode.multi-selected .jmexpander { background-color: #4c9aff; border-color: #ffcf4c; color: #fff; } */

    /* å¤šé€‰èŠ‚ç‚¹å†…å®¹æ ·å¼ - å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ */
    /* #fullScreenMindmap .jmnode.multi-selected * { color: #fff; background-color: rgba(76, 154, 255, 0.15); } */



    /* ç¼–è¾‘è¾“å…¥æœ€å°å®½åº¦ï¼Œé¿å…è¿‡çŸ­å¯¼è‡´ç¼–è¾‘ä½“éªŒå·® */
    .jsmind-editor,
    #jsmind-editor {
      min-width: 100px;
      padding: 2px 6px;
      line-height: 1.4;
      font-size: 14px;
    }

    /* å¤šé€‰è¦†ç›–å±‚æ ·å¼ - ç®€æ´ç‰ˆ */
    .multi-overlay {
      position: absolute;
      left: -2px;
      top: -2px;
      right: -2px;
      bottom: -2px;
      border: 4px solid #ffd900;
      border-radius: 4px;
      pointer-events: none;
      z-index: 100;
    }

    /* è¾…åŠ©ç±» */
    .mw-force-visible {
      display: block;
      visibility: visible;
    }

    /* å†…è”æ ·å¼ç±» - å·²ç§»é™¤ï¼Œä¸å†ä½¿ç”¨ */
    /* .jmnode.multi-selected-inline { background-color: rgba(76, 154, 255, 0.3); border: 2px solid #4c9aff; box-shadow: 0 0 0 3px rgba(76, 154, 255, 0.8); position: relative; } */
  </style>
</head>

<body>
  <div class="toolbar">
    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <div id="batchOperations"
      style="display: inline-block; margin-top: 200px; padding: 5px 10px; background: rgba(76, 154, 255, 0.1); border-radius: 4px; border: 1px solid #4c9aff;">
      <span style="color: #4c9aff; font-size: 12px; margin-right: 10px;">å·²é€‰ä¸­ <span id="selectedCount">0</span>
        ä¸ªèŠ‚ç‚¹</span>
      <button class="btn" onclick="batchDelete()" style="background: #dc3545; margin-right: 5px;"
        title="åˆ é™¤é€‰ä¸­çš„èŠ‚ç‚¹">åˆ é™¤</button>
      <button class="btn" onclick="batchMove()" style="background: #28a745; margin-right: 5px;"
        title="ç§»åŠ¨é€‰ä¸­çš„èŠ‚ç‚¹">ç§»åŠ¨</button>
      <button class="btn" onclick="clearMultiSelection()" style="background: #6c757d; margin-right: 5px;"
        title="æ¸…é™¤é€‰æ‹©">æ¸…é™¤</button>
      <button class="btn" onclick="debugMultiSelect()" style="background: #17a2b8; margin-right: 5px;" title="è°ƒè¯•å¤šé€‰æ ·å¼">ğŸ”
        è°ƒè¯•</button>
      <button class="btn" onclick="forceMultiSelectStyle()" style="background: #fd7e14;" title="å¼ºåˆ¶åº”ç”¨å¤šé€‰æ ·å¼">âš¡
        å¼ºåˆ¶æ ·å¼</button>
    </div>

    <button class="btn" onclick="exportData()">æŸ¥çœ‹JSON</button>
    <button class="btn" onclick="downloadMindmap()">ä¸‹è½½å›¾ç‰‡</button>

  </div>

  <div class="main-container">
    <div id="fullScreenMindmap"></div>

    <div id="nodeDetails">


      <div id="nodeInfo">

      </div>


      <div class="form-group">
        <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
        <input type="text" id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜...">
      </div>

      <div class="form-group">
        <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
        <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn" onclick="expandWithAI()"
          style="flex: 1; background: linear-gradient(135deg, #6da8e7, #6adbc8); color: white;">AIæ‰©å†™</button>
        <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #ffffff;"
          title="AIé…ç½®">âš™ï¸</button>
      </div>

      <!-- è‡ªåŠ¨æ›´æ–°æç¤º -->
      <div id="autoUpdateIndicator"
        style="display: none; margin-bottom: 10px; padding: 5px 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; color: #155724; font-size: 12px; text-align: center;">
        <span style="display: inline-block; animation: pulse 1s ease-in-out;">âœ“</span> å·²è‡ªåŠ¨æ›´æ–°
      </div>

      <!-- é€šçŸ¥æ¡¥æ¥å™¨ -->
      <script src="../notification-bridge.js"></script>
      <script>
        // AIæ‰©å†™å‡½æ•°
        function expandWithAI() {
          try {
            const selectedNode = jm.get_selected_node();
            if (!selectedNode) {
              showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
              return;
            }

            if (window.AIExpander) {
              window.AIExpander.expandNode(selectedNode.id, jm);
            } else {
              showError('AIæ‰©å†™æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
          } catch (e) {
            console.error('AIæ‰©å†™å‡ºé”™:', e);
            showError('AIæ‰©å†™å‡ºé”™: ' + e.message);
          }
        }
      </script>
    </div>
  </div>
  </div>

  <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.js"></script>
  <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
  <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
  <!-- ä½¿ç”¨ä¿®å¤ç‰ˆæœ¬çš„æˆªå›¾æ’ä»¶ï¼Œé¿å…HTTPSå®‰å…¨è­¦å‘Š -->
  <script src="jsmind.screenshot.fixed.js"></script>
  <script type="module" src="../converter/sync.js"></script>
  <script type="module" src="../converter/load.js"></script>
  <script>
    let jm = null;
    let currentNodeTree = null;

    // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
    function initMindmap() {
      if (jm) {
        loadNodeTree(); // ä¸ä¼ å‚æ•°ï¼Œè®©å‡½æ•°è‡ªå·±ä»localStorageè·å–
        return;
      }

      const options = {
        container: 'fullScreenMindmap',           // å®¹å™¨IDï¼Œå¿…å¡«
        editable: true,                         // æ˜¯å¦å¯ç¼–è¾‘ï¼Œé»˜è®¤ä¸ºtrue
        theme: 'primary',                       // ä¸»é¢˜ï¼šprimary|success|info|warning|danger|greensea|nephrite|belizehole|wisteria|asphalt
        mode: 'side',                           // æ˜¾ç¤ºæ¨¡å¼ï¼šfull|sideå³ä¾§
        support_html: true,                     // èŠ‚ç‚¹æ˜¯å¦æ”¯æŒHTMLï¼Œé»˜è®¤ä¸ºtrue
        view: {
          engine: 'svg',                   // æ€ç»´å¯¼å›¾å„èŠ‚ç‚¹ä¹‹é—´çº¿æ¡çš„ç»˜åˆ¶å¼•æ“ï¼Œcanvas|svg
          hmargin: 100,                       // æ°´å¹³è¾¹è·
          vmargin: 50,                        // å‚ç›´è¾¹è·
          line_width: 2,                      // è¿æ¥çº¿å®½åº¦
          line_color: '#555',                 // è¿æ¥çº¿é¢œè‰²
          expander_style: 'circle',           // å±•å¼€å™¨æ ·å¼ï¼šnumber|circle|square


          node_overflow: 'wrap',              // æ–‡å­—è¿‡é•¿å¤„ç†ï¼šhidden|wrapï¼Œæ”¹ä¸ºwrapç¡®ä¿å¤šé€‰æ—¶å†…å®¹ä¸è¢«éšè—



        },
        layout: {
          hspace: 30,                         // èŠ‚ç‚¹æ°´å¹³é—´è·
          vspace: 20,                         // èŠ‚ç‚¹å‚ç›´é—´è·
          pspace: 13                          // èŠ‚ç‚¹ä¸è¿æ¥çº¿çš„é—´è·
        },
        shortcut: {
          enable: true,                         // æ˜¯å¦å¯ç”¨å¿«æ·é”®
          handles: {},                        // è‡ªå®šä¹‰å¤„ç†å‡½æ•°

          // å¿«æ·é”®æ˜ å°„
          mapping: {
            addchild: 9,                    // Tab - æ·»åŠ å­èŠ‚ç‚¹
            addbrother: 13,                 // Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
            editnode: 113,                  // F2 - ç¼–è¾‘èŠ‚ç‚¹
            delnode: 46,                    // Delete - åˆ é™¤èŠ‚ç‚¹
            toggle: 32,                     // Space - å±•å¼€/æŠ˜å èŠ‚ç‚¹

            // åˆ‡æ¢é€‰ä¸­
            left: 37,                       // é€‰ä¸­å·¦ä¾§èŠ‚ç‚¹
            up: 38,                         // 
            right: 39,                      // 
            down: 40,                       // 

          }
        },

        // é¢„è®¾ä¸»é¢˜é…ç½®
        // theme: 'info',  // ä½¿ç”¨jsmindå†…ç½®ä¸»é¢˜ï¼šprimary, warning, danger, success, info, orange, etc.

      };

      jm = new jsMind(options);

      // å°†jsMindå®ä¾‹èµ‹å€¼ç»™windowï¼Œä¾›å…¶ä»–æ¨¡å—è®¿é—®
      window.jm = jm;

      // é…ç½®æ€ç»´å¯¼å›¾å®¹å™¨çš„æ»šåŠ¨è¡Œä¸º
      setupMindmapScrolling();

      // åŒ…è£…æ ¸å¿ƒAPIä»¥æ•è·æ–°å¢/ç§»åŠ¨èŠ‚ç‚¹ï¼Œåš"ç±»å‹å¯¹é½"å¹¶ä¿å­˜
      (function wrapMindAPIs() {
        // æ–°å¢èŠ‚ç‚¹åŒ…è£…
        const __origAdd = jm.add_node && jm.add_node.bind(jm);
        if (__origAdd) {
          jm.add_node = function (parent_node, nodeid, topic, data) {
            const ret = __origAdd(parent_node, nodeid, topic, data);
            try {
              const id = nodeid || (ret && ret.id);
              if (id && typeof applySiblingOrParentType === 'function') {
                applySiblingOrParentType(id);
              }
              // è‹¥çˆ¶èŠ‚ç‚¹ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨
              try {
                const pid = (typeof parent_node === 'string' ? parent_node : (parent_node && parent_node.id))
                  || (id && jm.get_node(id) && jm.get_node(id).parent && jm.get_node(id).parent.id);
                if (pid) {
                  const p = jm.get_node(pid);
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(id, p);
                  }
                }
              } catch (e2) {
                // å¿½ç•¥å½’ä¸€åˆ—è¡¨å¤„ç†é”™è¯¯
              }
              if (typeof debouncedSave === 'function') debouncedSave();
            } catch (e) {
              // å¿½ç•¥åç½®å¤„ç†é”™è¯¯
            }
            return ret;
          };
        }
        // ç§»åŠ¨èŠ‚ç‚¹åŒ…è£…
        const __origMove = jm.move_node && jm.move_node.bind(jm);
        if (__origMove) {
          jm.move_node = function (nodeid, beforeid, parentid, direction) {
            const ret = __origMove(nodeid, beforeid, parentid, direction);
            try {
              if (nodeid && typeof applySiblingOrParentType === 'function') {
                applySiblingOrParentType(nodeid);
              }
              // è‹¥æ–°çˆ¶èŠ‚ç‚¹ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨
              try {
                if (parentid) {
                  const p = jm.get_node(parentid);
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(nodeid, p);
                  }
                }
              } catch (e2) {
                // å¿½ç•¥å½’ä¸€åˆ—è¡¨å¤„ç†é”™è¯¯
              }
              if (typeof debouncedSave === 'function') debouncedSave();
            } catch (e) {
              // å¿½ç•¥åç½®å¤„ç†é”™è¯¯
            }
            return ret;
          };
        }
      })();

      // åˆå§‹åŒ–å®ŒæˆååŠ è½½æ•°æ®
      loadNodeTree();

      // ç»‘å®šäº‹ä»¶
      jm.add_event_listener(function (type, data) {
        if (type === jsMind.event_type.select) {
          const selectedNodeid = jm.get_selected_node();
          if (selectedNodeid) {
            // æ£€æŸ¥æ˜¯å¦å¤„äºæ‰¹é‡ç§»åŠ¨æ¨¡å¼
            if (window.__batchMoving && window.__batchMoveIds && window.__batchMoveIds.length > 0) {
              // æ‰¹é‡ç§»åŠ¨æ¨¡å¼ï¼šæ‰§è¡Œç§»åŠ¨æ“ä½œ
              try {
                const targetNodeId = selectedNodeid;
                const idsToMove = [...window.__batchMoveIds];

                // å–æ¶ˆæ‰¹é‡ç§»åŠ¨æ¨¡å¼
                if (window.cancelBatchMove) {
                  window.cancelBatchMove();
                }

                // æ‰§è¡Œæ‰¹é‡ç§»åŠ¨
                let anchorId = targetNodeId;
                for (const nodeId of idsToMove) {
                  if (!nodeId || nodeId === targetNodeId) continue;
                  try {
                    jm.move_node(nodeId, anchorId, jm.get_node(targetNodeId).parent.id);
                    anchorId = nodeId;
                  } catch (e) {
                    console.warn('èŠ‚ç‚¹ç§»åŠ¨å¤±è´¥:', nodeId, e);
                  }
                }

                showSuccess(`æˆåŠŸç§»åŠ¨ ${idsToMove.length} ä¸ªèŠ‚ç‚¹`);
              } catch (e) {
                console.error('æ‰¹é‡ç§»åŠ¨å¤±è´¥:', e);
                showError('æ‰¹é‡ç§»åŠ¨å¤±è´¥');
              }
            } else {
              // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
              showNodeDetails(selectedNodeid);
            }
          }
        }
      });

    }

    // é…ç½®æ€ç»´å¯¼å›¾å®¹å™¨çš„æ»šåŠ¨è¡Œä¸º
    function setupMindmapScrolling() {
      if (!jm) return;

      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;

      // ç­‰å¾…jsmindå®Œå…¨åˆå§‹åŒ–
      setTimeout(() => {
        // æŸ¥æ‰¾jsmindåˆ›å»ºçš„jmnodeså®¹å™¨
        const jmnodes = container.querySelector('.jmnodes');
        const jsmindInner = container.querySelector('.jsmind-inner');

        if (jmnodes) {
          // ç¡®ä¿jmnodeså¯ä»¥è¶…å‡ºå®¹å™¨è¾¹ç•Œ
          jmnodes.style.overflow = 'visible';
          jmnodes.style.position = 'relative';
        }

        if (jsmindInner) {
          // ç¡®ä¿å†…éƒ¨å®¹å™¨æœ‰æ»šåŠ¨æ¡
          jsmindInner.style.overflow = 'auto';
          jsmindInner.style.width = '100%';
          jsmindInner.style.height = '100%';
        }

        // å·²ç§»é™¤å†—ä½™æ»šåŠ¨è°ƒè¯•è¾“å‡º
      }, 500); // å»¶è¿Ÿ500msç¡®ä¿jsmindå®ŒæˆDOMåˆ›å»º
    }

    // åŠ è½½NodeTreeæ•°æ®
    function loadNodeTree(nodeTreeData) {
      if (!jm) return;

      // å¦‚æœæ²¡æœ‰æä¾›æ•°æ®ï¼Œå°è¯•ä»localStorageè·å–
      if (!nodeTreeData) {
        const cachedData = localStorage.getItem('mindword_nodetree_data');
        if (cachedData) {
          try {
            nodeTreeData = JSON.parse(cachedData);
          } catch (error) {
            nodeTreeData = getDefaultNodeTree();
          }
        } else {
          nodeTreeData = getDefaultNodeTree();
        }
      }

      try {
        // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
        if (typeof nodeTreeData === 'string') {
          nodeTreeData = JSON.parse(nodeTreeData);
        }

        jm.show(nodeTreeData);
        currentNodeTree = nodeTreeData;

        // å»¶è¿Ÿæ‰§è¡ŒDOMæ“ä½œï¼Œç¡®ä¿å…ƒç´ å·²åŠ è½½
        setTimeout(() => {


          // è‡ªåŠ¨é€‰æ‹©æ ¹èŠ‚ç‚¹å¹¶æ˜¾ç¤ºè¯¦æƒ…
          const rootNode = jm.get_root();
          if (rootNode) {
            jm.select_node(rootNode.id);
            showNodeDetails(rootNode);
          }
        }, 100);
      } catch (error) {
        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½é»˜è®¤æ•°æ®
        try {
          jm.show(getDefaultNodeTree());
        } catch (defaultError) {
          console.error('åŠ è½½é»˜è®¤æ•°æ®å¤±è´¥:', defaultError);
        }
      }
    }

    // è·å–å½“å‰NodeTree
    function getCurrentNodeTree() {
      return jm ? jm.get_data() : null;
    }

    // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
    function showNodeDetails(node) {
      // å…è®¸ä¼ å…¥ id æˆ– node å¯¹è±¡ï¼Œç»Ÿä¸€ä¸º node
      if (node && typeof node === 'string') {
        node = jm && jm.get_node ? jm.get_node(node) : node;
      }
      if (!node) return;

      const nodeInfo = document.getElementById('nodeInfo');
      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');
      if (!nodeInfo || !nodeTopic || !nodeNotes) return;

      // å®‰å…¨å­—æ®µè¯»å–
      const level = (node.level != null) ? node.level
        : (node.data && node.data.level != null ? node.data.level : 0);
      const ordered = (node.ordered != null) ? node.ordered
        : (node.data && node.data.ordered != null ? node.data.ordered : undefined);
      const marker = (node.marker != null) ? node.marker
        : (node.data && node.data.marker != null ? node.data.marker : undefined);
      const type = (node.type != null) ? node.type
        : (node.data && node.data.type != null ? node.data.type : undefined);
      const notes = (node.notes != null) ? node.notes
        : (node.data && node.data.notes != null ? node.data.notes : '');

      // æ„é€ è°ƒè¯•å¿«ç…§ï¼ˆé¿å…å¾ªç¯å¼•ç”¨ï¼‰
      const snapshot = {
        id: node.id,
        topic: node.topic || '',
        type: type,
        level: level,
        ordered: ordered,
        marker: marker,
        notes: notes,
        parentId: node.parent && node.parent.id ? node.parent.id : null,
        childrenIds: Array.isArray(node.children) ? node.children.map(c => c && c.id).filter(Boolean) : []
      };


      nodeTopic.value = snapshot.topic || '';
      nodeNotes.value = notes || '';

      // è®¾ç½®è‡ªåŠ¨æ›´æ–°äº‹ä»¶ç›‘å¬
      setupAutoUpdate();
    }

    // è®¾ç½®è‡ªåŠ¨æ›´æ–°åŠŸèƒ½
    function setupAutoUpdate() {
      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');

      if (!nodeTopic || !nodeNotes) return;

      // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬é¿å…é‡å¤
      nodeTopic.removeEventListener('input', handleAutoUpdate);
      nodeNotes.removeEventListener('input', handleAutoUpdate);

      // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬
      nodeTopic.addEventListener('input', handleAutoUpdate);
      nodeNotes.addEventListener('input', handleAutoUpdate);
    }

    // å¤„ç†è‡ªåŠ¨æ›´æ–°
    let autoUpdateTimer = null;
    function handleAutoUpdate() {
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      if (autoUpdateTimer) {
        clearTimeout(autoUpdateTimer);
      }

      // å»¶è¿Ÿ500msæ‰§è¡Œæ›´æ–°ï¼Œé¿å…é¢‘ç¹æ›´æ–°
      autoUpdateTimer = setTimeout(() => {
        const selected = jm.get_selected_node();
        if (!selected) return;

        const nodeTopic = document.getElementById('nodeTopic');
        const nodeNotes = document.getElementById('nodeNotes');

        const newTopic = nodeTopic.value.trim();
        const newNotes = nodeNotes.value.trim();

        // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        let hasChanges = false;

        if (newTopic !== selected.topic) {
          jm.update_node(selected.id, newTopic);
          hasChanges = true;
        }

        // ç¡®ä¿ data å­˜åœ¨ï¼Œé¿å…ç©ºå¼•ç”¨
        if (!selected.data) selected.data = {};
        const prevNotes = (selected.notes != null ? selected.notes : (selected.data.notes != null ? selected.data.notes : ''));
        if (newNotes !== prevNotes) {
          selected.data.notes = newNotes;
          hasChanges = true;
        }

        if (hasChanges) {
          refreshAllNotesDisplay();
          saveToLocalStorage();
          showAutoUpdateIndicator();
        }
      }, 500);
    }

    // æ˜¾ç¤ºè‡ªåŠ¨æ›´æ–°æç¤º
    function showAutoUpdateIndicator() {
      const indicator = document.getElementById('autoUpdateIndicator');
      if (!indicator) return;

      indicator.style.display = 'block';
      indicator.classList.add('auto-update-show');

      // 2ç§’åéšè—æç¤º
      setTimeout(() => {
        indicator.style.display = 'none';
        indicator.classList.remove('auto-update-show');
      }, 2000);
    }

    // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨
    function updateNodeNotes() {
      if (!jm) return;

      const selected = jm.get_selected_node();
      if (!selected) {
        showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
        return;
      }

      const nodeTopic = document.getElementById('nodeTopic');
      const nodeNotes = document.getElementById('nodeNotes');

      const newTopic = nodeTopic.value.trim();
      const newNotes = nodeNotes.value.trim();

      // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜åŒ–éœ€è¦æ›´æ–°
      let hasChanges = false;

      // æ›´æ–°èŠ‚ç‚¹ä¸»é¢˜ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
      if (newTopic !== selected.topic) {
        jm.update_node(selected.id, newTopic);
        hasChanges = true;
      }

      // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
      if (newNotes !== (selected.notes || '')) {
        // ç›´æ¥æ›´æ–°æ ¹çº§åˆ«çš„noteså­—æ®µï¼ˆä¸å…¶ä»–ä»£ç ä¿æŒä¸€è‡´ï¼‰
        selected.data.notes = newNotes;
        hasChanges = true;
      }

      // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œæç¤ºç”¨æˆ·
      if (!hasChanges) {
        showInfo('èŠ‚ç‚¹å†…å®¹æ²¡æœ‰å˜åŒ–ï¼');
        return;
      }

      refreshAllNotesDisplay();

      // // åŒæ­¥åˆ°çˆ¶é¡µé¢
      // if (window.parent !== window) {
      //     window.parent.postMessage({
      //         type: 'mindmapUpdated',
      //         data: jm.get_data()
      //     }, '*');
      // }

      // ä¿å­˜åˆ°localStorageå¹¶åŒæ­¥
      saveToLocalStorage();

      showSuccess('èŠ‚ç‚¹æ›´æ–°æˆåŠŸï¼');
    }

    // åˆ·æ–°æ‰€æœ‰å¤‡æ³¨æ˜¾ç¤º
    function refreshAllNotesDisplay() {
      if (!jm) return;

      const notesList = document.getElementById('notesList');
      if (!notesList) return; // é˜²æ­¢DOMå…ƒç´ ä¸å­˜åœ¨

      const nodeTree = jm.get_data();

      if (!nodeTree || !nodeTree.data) {
        notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹æ•°æ®</p>';
        return;
      }

      const nodesWithNotes = [];

      function collectNodes(node) {
        if (!node) return;

        const notes = node.notes;  // ç›´æ¥ä»æ ¹çº§åˆ«è¯»å–notes
        if (notes && notes.trim()) {
          nodesWithNotes.push({
            id: node.id,
            topic: node.topic || 'æœªå‘½åèŠ‚ç‚¹',
            notes: notes.trim(),
            level: node.level || 0
          });
        }

        if (node.children) {
          node.children.forEach(collectNodes);
        }
      }

      collectNodes(nodeTree.data);

      if (nodesWithNotes.length === 0) {
        notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹åŒ…å«å¤‡æ³¨ä¿¡æ¯</p>';
        return;
      }

      nodesWithNotes.sort((a, b) => a.level - b.level);

      let html = '';
      nodesWithNotes.forEach(node => {
        const levelIndent = 'ã€€'.repeat(node.level);
        html += `
                    <div class="note-item">
                        <h5>${levelIndent}${node.topic}</h5>
                        <p>${node.notes}</p>
                        <small style="color: #6c757d;">ID: ${node.id}</small>
                    </div>
                `;
      });

      notesList.innerHTML = html;
    }

    // è®¾ç½®é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¤‡æ³¨
    function setupHoverNotes() {
      const container = document.getElementById('fullScreenMindmap');
      const notesOverlay = document.getElementById('notesOverlay');
      const hoverNote = document.getElementById('hoverNote');

      let hoverTimeout;

      container.addEventListener('mousemove', function (e) {
        if (!jm) return;

        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        let node = null;
        try {
          if (jm.get_node_by_coordinate) {
            node = jm.get_node_by_coordinate(x, y);
          } else {
            const target = e.target;
            if (target && target.closest('.jmnode')) {
              const nodeId = target.closest('.jmnode').getAttribute('nodeid');
              if (nodeId) {
                node = jm.get_node(nodeId);
              }
            }
          }
        } catch (error) {
          // é™é»˜å¤„ç†é”™è¯¯
        }

        if (node && node.notes && node.notes.trim()) {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            hoverNote.textContent = node.notes;
            notesOverlay.style.display = 'block';
            notesOverlay.style.left = Math.min(x + 10, rect.width - 260) + 'px';
            notesOverlay.style.top = Math.max(y - 50, 10) + 'px';
          }, 300);
        } else {
          clearTimeout(hoverTimeout);
          hoverTimeout = setTimeout(() => {
            notesOverlay.style.display = 'none';
          }, 100);
        }
      });

      container.addEventListener('mouseleave', function () {
        clearTimeout(hoverTimeout);
        notesOverlay.style.display = 'none';
      });
    }



    /* ç”»å¸ƒæ¡†é€‰å¤šé€‰åŠŸèƒ½ */
    function setupBoxSelection() {
      const container = document.getElementById('fullScreenMindmap');
      if (!container) return;

      // åœ¨ jsmind å†…éƒ¨å®¹å™¨å†…ç»˜åˆ¶æ¡†é€‰çŸ©å½¢ï¼Œç¡®ä¿åæ ‡ä¸æ»šåŠ¨ä¸€è‡´
      const inner = container.querySelector('.jsmind-inner') || container;
      // ä½¿å®¹å™¨å¯èšç„¦ï¼Œç¡®ä¿åœ¨ iframe ä¸­å¯æ¥æ”¶ç©ºæ ¼é”®
      inner.setAttribute('tabindex', '0');
      inner.style.outline = 'none';
      inner.addEventListener('mouseenter', () => { try { inner.focus({ preventScroll: true }); } catch (e) { } });
      inner.addEventListener('mousedown', () => { try { inner.focus({ preventScroll: true }); } catch (e) { } });
      // èŠ‚ç‚¹å®¹å™¨ï¼ˆjsMind ä¼šæŠŠèŠ‚ç‚¹æ”¾åœ¨ .jmnodes ä¸‹ï¼‰
      const nodesRoot = container.querySelector('.jmnodes') || inner;

      // å·²ç§»é™¤å†—ä½™èŠ‚ç‚¹åˆ†ææ—¥å¿—

      // åˆ›å»ºæ¡†é€‰çŸ©å½¢å…ƒç´ ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰ - ä½¿ç”¨è§†å£åæ ‡ç³»ï¼ŒæŒ‚åˆ° document.body é¿å…è¢«ç¼©æ”¾å±‚å½±å“
      let rectEl = document.querySelector('#selectionRect');
      if (!rectEl) {
        rectEl = document.createElement('div');
        rectEl.id = 'selectionRect';
        document.body.appendChild(rectEl);
      }

      let isSelecting = false;
      let isSelectingPrimed = false;
      let isPanning = false;
      let isDownOnNode = false;
      let isDraggingNode = false; // è®°å½•æ˜¯å¦æ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹
      let startX = 0, startY = 0;
      let startClientX = 0, startClientY = 0;
      let startScrollLeft = 0, startScrollTop = 0;
      let addMode = false; // æ˜¯å¦å åŠ é€‰æ‹©ï¼ˆShift/Metaï¼‰ï¼Œç©ºæ ¼ä¸ºç”»å¸ƒæ‹–æ‹½
      let isSpacePressed = false; // ç©ºæ ¼æŒ‰ä¸‹æ—¶å¯ç”¨ç”»å¸ƒæ‹–æ‹½

      // è®¡ç®—å†…å±‚å®¹å™¨çš„ç¼©æ”¾æ¯”ä¾‹ï¼ˆCSS transform: scaleï¼‰ï¼Œç”¨äºåæ ‡æ¢ç®—
      function getInnerScale() {
        const r = inner.getBoundingClientRect();
        const sxRaw = r.width / (inner.clientWidth || r.width);
        const syRaw = r.height / (inner.clientHeight || r.height);
        const sx = (isFinite(sxRaw) && sxRaw > 0) ? sxRaw : 1;
        const sy = (isFinite(syRaw) && syRaw > 0) ? syRaw : 1;
        return { sx, sy };
      }

      // ç›‘å¬ç©ºæ ¼é”®çŠ¶æ€ï¼›åœ¨è¾“å…¥æ¡†/æ–‡æœ¬åŸŸ/å¯ç¼–è¾‘å†…å®¹å†…æŒ‰ç©ºæ ¼ä¸è§¦å‘æ‹–æ‹½
      window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar') {
          const t = e.target;
          const isTyping = t && (
            t.tagName === 'INPUT' ||
            t.tagName === 'TEXTAREA' ||
            t.isContentEditable
          );
          if (!isTyping) {
            isSpacePressed = true;
            // é˜»æ­¢é¡µé¢æ»šåŠ¨ï¼ˆç©ºæ ¼é»˜è®¤ä¼šæ»šåŠ¨é¡µé¢ï¼‰
            e.preventDefault();
          }
        }
      }, { passive: false });

      window.addEventListener('keyup', (e) => {
        if (e.code === 'Space' || e.key === ' ' || e.key === 'Spacebar') {
          isSpacePressed = false;
        }
      });
      const multiSelected = new Set();

      // å»é‡å’ŒèŠ‚æµæ§åˆ¶å˜é‡
      let lastMultiSelectedIds = [];
      let isUpdatingHighlight = false;
      let highlightUpdateScheduled = false;

      function updateHighlight() {
        // å»é‡ï¼šæ£€æŸ¥å¤šé€‰é›†åˆæ˜¯å¦çœŸæ­£å‘ç”Ÿå˜åŒ–
        const currentIds = Array.from(multiSelected).sort();
        const hasChanged = JSON.stringify(currentIds) !== JSON.stringify(lastMultiSelectedIds);

        if (!hasChanged && !highlightUpdateScheduled) {
          console.log('â­ï¸ å¤šé€‰é›†åˆæœªå˜åŒ–ï¼Œè·³è¿‡æ›´æ–°');
          return;
        }

        // èŠ‚æµï¼šå¦‚æœæ­£åœ¨æ›´æ–°ï¼Œæ ‡è®°éœ€è¦å†æ¬¡æ›´æ–°ï¼Œä½†ä¸ç«‹å³æ‰§è¡Œ
        if (isUpdatingHighlight) {
          console.log('â³ æ›´æ–°è¿›è¡Œä¸­ï¼Œæ ‡è®°éœ€è¦å†æ¬¡æ›´æ–°');
          highlightUpdateScheduled = true;
          return;
        }

        // ä½¿ç”¨ requestAnimationFrame è¿›è¡ŒèŠ‚æµ
        isUpdatingHighlight = true;
        requestAnimationFrame(() => {
          performHighlightUpdate();
          lastMultiSelectedIds = currentIds.slice(); // ä¿å­˜å½“å‰çŠ¶æ€
          isUpdatingHighlight = false;

          // å¦‚æœæœ‰æ’é˜Ÿçš„æ›´æ–°ï¼Œæ‰§è¡Œå®ƒ
          if (highlightUpdateScheduled) {
            highlightUpdateScheduled = false;
            console.log('ğŸ”„ æ‰§è¡Œæ’é˜Ÿçš„æ›´æ–°');
            updateHighlight();
          }
        });
      }

      function performHighlightUpdate() {
        console.log(`ğŸ¯ æ‰§è¡Œé«˜äº®æ›´æ–°ï¼Œé€‰ä¸­èŠ‚ç‚¹æ•°: ${multiSelected.size}`);

        // æ¸…ç†é«˜äº®ï¼šä»…ç§»é™¤èŠ‚ç‚¹çŸ©å½¢ä¸Šçš„å¤šé€‰ç±»ï¼Œå¹¶ç§»é™¤è¦†ç›–å±‚
        const prevMulti = document.querySelectorAll('.jmnode.multi-selected');
        let clearCount = 0;
        prevMulti.forEach(el => {
          el.classList.remove('multi-selected');
          clearCount++;
        });
        // é¢å¤–ï¼šç§»é™¤æ‰€æœ‰å¤šé€‰è¦†ç›–å±‚ï¼Œé¿å…æ®‹ç•™
        document.querySelectorAll('.multi-overlay').forEach(ov => ov.remove());

        // åº”ç”¨é«˜äº®
        multiSelected.forEach(id => {
          const el = getNodeElement(id);
          if (el) {
            applyMultiSelectStyle(el, id);
          }
        });

        // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
        updateBatchToolbar();

        // æš´éœ²ä¾¿æ· API
        exposeMultiSelectAPI();
      }

      // è·å–èŠ‚ç‚¹å…ƒç´ çš„è¾…åŠ©å‡½æ•°
      function getNodeElement(nodeId) {
        let el = document.querySelector(`jmnode[nodeid="${nodeId}"]`) ||
          document.querySelector(`.jmnode[nodeid="${nodeId}"]`) ||
          document.querySelector(`[nodeid="${nodeId}"]`);

        if (el && el.tagName !== 'Jmnode' && !el.classList.contains('jmnode')) {
          el = el.closest('jmnode') || el.closest('.jmnode') || el;
        }
        return el;
      }

      // åº”ç”¨å¤šé€‰æ ·å¼çš„æ ¸å¿ƒå‡½æ•°
      function applyMultiSelectStyle(el, nodeId) {
        el.classList.add('multi-selected');

        // åˆ›å»ºè¦†ç›–å±‚ - ç¡®ä¿é«˜äº®ä¸è¢«å†…éƒ¨å­å±‚é®æŒ¡
        if (!el.querySelector(':scope > .multi-overlay')) {
          const ov = document.createElement('div');
          ov.className = 'multi-overlay';
          el.appendChild(ov);
        }

        // **å…³é”®ä¿®å¤**ï¼šç¡®ä¿èŠ‚ç‚¹å…ƒç´ æœ¬èº«å¯è§ï¼Œå³ä½¿å…¶å†…éƒ¨çš„jmexpanderè¢«éšè—
        const computedStyle = window.getComputedStyle(el);
        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
          el.classList.add('mw-force-visible');
        }
      }

      // æ›´æ–°æ‰¹é‡æ“ä½œå·¥å…·æ 
      function updateBatchToolbar() {
        const batchOps = document.getElementById('batchOperations');
        const selectedCount = document.getElementById('selectedCount');
        const count = multiSelected.size;

        if (count > 0) {
          batchOps.style.display = 'inline-block';
          selectedCount.textContent = count;
        } else {
          batchOps.style.display = 'none';
        }
      }

      // æš´éœ²ä¾¿æ· API
      function exposeMultiSelectAPI() {
        window.getMultiSelection = () => Array.from(multiSelected);
        window.clearMultiSelection = () => {
          multiSelected.clear();
          if (window.jm && typeof jm.select_clear === 'function') {
            try { jm.select_clear(); } catch (err) { }
          }
          updateHighlight();
        };
        window.selectMultipleNodes = (ids) => {
          if (!Array.isArray(ids)) return;
          ids.forEach(id => id && multiSelected.add(id));
          updateHighlight();
        };
      }

      // ç®€åŒ–çš„è°ƒè¯•å‡½æ•°
      window.debugMultiSelect = function () {
        console.log('å¤šé€‰é›†åˆå¤§å°:', multiSelected.size);
        console.log('å¤šé€‰èŠ‚ç‚¹ID:', Array.from(multiSelected));
      };

      // å¼ºåˆ¶é‡ç½®æ ·å¼å‡½æ•°
      window.forceMultiSelectStyle = function () {
        multiSelected.forEach(id => {
          const el = getNodeElement(id);
          if (el) {
            // å¼ºåˆ¶ç§»é™¤å¯èƒ½å†²çªçš„å†…è”æ ·å¼
            el.style.background = '';
            el.style.backgroundColor = '';
            el.style.backgroundImage = '';

            // åº”ç”¨å¤šé€‰æ ·å¼ï¼ˆå¤ç”¨æ ¸å¿ƒé€»è¾‘ï¼‰
            applyMultiSelectStyle(el, id);

            // **å…³é”®ä¿®å¤**ï¼šç¡®ä¿èŠ‚ç‚¹å…ƒç´ æœ¬èº«å¯è§ï¼Œå³ä½¿å…¶å†…éƒ¨çš„jmexpanderè¢«éšè—
            const computedStyle = window.getComputedStyle(el);
            if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
              el.style.display = 'block !important';
              el.style.visibility = 'visible !important';
            }
          }
        });
      };

      function rectsIntersect(a, b) {
        return a.left <= b.right && a.right >= b.left && a.top <= b.bottom && a.bottom >= b.top;
      }

      function onMouseDown(e) {
        if (e.button !== 0) return; // ä»…å·¦é”®
        // è‹¥æ­£åœ¨ç¼–è¾‘æˆ–ç‚¹å‡»åˆ°ç¼–è¾‘è¾“å…¥ï¼Œå¿½ç•¥æœ¬æ¨¡å—ï¼Œäº¤ç»™ jsMind å¤„ç†
        const tt = e.target;
        if (tt && (tt.tagName === 'INPUT' || tt.tagName === 'TEXTAREA' || tt.isContentEditable || tt.id === 'jsmind-editor' || (tt.closest && (tt.closest('.jsmind-editor') || tt.closest('#jsmind-editor'))))) {
          return;
        }
        // é¿å…åœ¨èŠ‚ç‚¹/å³ä¾§é¢æ¿/å·¥å…·æ ä¸Šè§¦å‘æ¡†é€‰/æ‹–æ‹½

        // ç®€åŒ–èŠ‚ç‚¹æ£€æµ‹ - ç›´æ¥æ£€æŸ¥ç›®æ ‡å…ƒç´ åŠå…¶çˆ¶å…ƒç´ 
        let nodeElement = null;
        const target = e.target;

        // æ–¹æ³•1: æ£€æŸ¥ç›®æ ‡å…ƒç´ æœ¬èº«æ˜¯å¦æœ‰.jmnodeç±»
        if (target.classList && target.classList.contains('jmnode')) {
          nodeElement = target;
        }
        // æ–¹æ³•2: æ£€æŸ¥ç›®æ ‡å…ƒç´ æ˜¯å¦æœ‰nodeidå±æ€§
        else if (target.hasAttribute && target.hasAttribute('nodeid')) {
          nodeElement = target;
        }
        // æ–¹æ³•3: æ£€æŸ¥çˆ¶å…ƒç´ 
        else if (target.closest) {
          nodeElement = target.closest('.jmnode');
          if (!nodeElement) {
            nodeElement = target.closest('[nodeid]');
          }
        }

        isDownOnNode = !!nodeElement;

        // åå¤‡æ–¹æ¡ˆï¼šæ£€æŸ¥é¼ æ ‡ä½ç½®æ˜¯å¦åœ¨èŠ‚ç‚¹åŒºåŸŸå†…
        if (!isDownOnNode) {
          const allNodes = document.querySelectorAll('[nodeid]');

          for (let i = 0; i < allNodes.length; i++) {
            const node = allNodes[i];
            const rect = node.getBoundingClientRect();
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            if (mouseX >= rect.left && mouseX <= rect.right && mouseY >= rect.top && mouseY <= rect.bottom) {
              isDownOnNode = true;
              break;
            }
          }
        }

        // å¦‚æœç‚¹å‡»åœ¨ç©ºç™½åŒºåŸŸï¼ˆéèŠ‚ç‚¹ã€éå·¥å…·æ ã€éæ‰¹é‡æ“ä½œé¢æ¿ï¼‰ï¼Œæ¸…é™¤é€‰æ‹©
        if (!isDownOnNode && !e.target.closest('#toolbar') && !e.target.closest('#batchOperations')) {
          multiSelected.clear();
          if (window.jm && typeof jm.select_clear === 'function') { try { jm.select_clear(); } catch (err) { } }
          updateHighlight();
        }

        if (isDownOnNode) {
          // åœ¨èŠ‚ç‚¹ä¸ŠæŒ‰ä¸‹ï¼Œæ ‡è®°ä¸ºæ‹–æ‹½çŠ¶æ€ï¼Œç¦ç”¨æ¡†é€‰
          isDraggingNode = true;
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';


          // å¦‚æœæŒ‰ä½Shifté”®ç‚¹å‡»èŠ‚ç‚¹ï¼Œåˆ‡æ¢é€‰æ‹©çŠ¶æ€
          if (e.shiftKey || e.metaKey) {
            const clickedNode = e.target.closest('.jmnode');
            if (clickedNode) {
              const nodeId = clickedNode.getAttribute('nodeid');
              if (nodeId) {
                if (multiSelected.has(nodeId)) {
                  multiSelected.delete(nodeId);
                } else {
                  multiSelected.add(nodeId);
                }
                updateHighlight();
                e.preventDefault();
                return;
              }
            }
          }

          // **å…³é”®ä¿®å¤**ï¼šå¦‚æœå½“å‰èŠ‚ç‚¹åœ¨å¤šé€‰é›†åˆä¸­ï¼Œé˜»æ­¢jsMindçš„æ‹–æ‹½æ’ä»¶å¤„ç†
          // é¿å…å¤šé€‰èŠ‚ç‚¹æ‹–æ‹½æ—¶å‡ºç° "Cannot read properties of null (reading 'tagName')" é”™è¯¯
          const clickedNode = e.target.closest('.jmnode');
          if (clickedNode) {
            const nodeId = clickedNode.getAttribute('nodeid');
            if (nodeId && multiSelected.has(nodeId) && multiSelected.size > 1) {
              // å¤šé€‰èŠ‚ç‚¹è¢«ç‚¹å‡»ï¼Œé˜»æ­¢jsMindæ‹–æ‹½æ’ä»¶çš„é»˜è®¤è¡Œä¸º
              e.preventDefault();
              e.stopPropagation();
              console.log('é˜»æ­¢jsMindæ‹–æ‹½æ’ä»¶å¤„ç†å¤šé€‰èŠ‚ç‚¹');
              return;
            }
          }

          // å•ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œè®©jsMindå¤„ç†æ‹–æ‹½
          return;
        }

        if (e.target.closest('#nodeDetails') || e.target.closest('.toolbar')) {
          // åœ¨é¢æ¿/å·¥å…·æ ä¸ŠæŒ‰ä¸‹ï¼Œç¦æ­¢æ¡†é€‰
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';

          // **ä¸é˜»æ­¢äº‹ä»¶å†’æ³¡**ï¼Œè®©å…¶ä»–åŠŸèƒ½æ­£å¸¸å·¥ä½œ
          return;
        }

        // ç©ºæ ¼ + æ‹–æ‹½ => ç”»å¸ƒå¹³ç§»
        if (isSpacePressed) {
          isPanning = true;
          const r = inner.getBoundingClientRect();
          startClientX = e.clientX;
          startClientY = e.clientY;
          startScrollLeft = inner.scrollLeft;
          startScrollTop = inner.scrollTop;
          inner.style.cursor = 'grabbing';
          e.preventDefault();
          return;
        }

        // æ™®é€šæ‹–æ‹½ => å¾…åˆ¤å®šæ¡†é€‰ï¼ˆä»…å½“ç§»åŠ¨è¶…é˜ˆå€¼æ‰çœŸæ­£å¼€å§‹ï¼‰
        isSelecting = false;
        isSelectingPrimed = true;
        addMode = !!(e.shiftKey || e.metaKey);

        // è®°å½•èµ·ç‚¹çš„è§†å£(client)åæ ‡ï¼Œåç»­å…¨éƒ¨ä»¥ client åæ ‡ç³»ç»˜åˆ¶ï¼Œé¿å…ç¼©æ”¾/æ»šåŠ¨æ¢ç®—è¯¯å·®
        startClientX = e.clientX;
        startClientY = e.clientY;
        // å…¼å®¹æ€§ä¿ç•™é€»è¾‘åæ ‡ï¼ˆä½†ä¸ç”¨äºç¢°æ’æ£€æµ‹ï¼‰
        startX = startClientX;
        startY = startClientY;

        // æš‚ä¸æ¸…ç©ºï¼Œç­‰çœŸæ­£å¼€å§‹æ¡†é€‰æ—¶å†å†³å®šæ˜¯å¦æ¸…ç©º
        Object.assign(rectEl.style, {
          display: 'none',
          left: `${startClientX}px`,
          top: `${startClientY}px`,
          width: '0px',
          height: '0px'
        });

        // é˜»æ­¢é»˜è®¤é€‰æ‹©è¡Œä¸ºï¼Œé¿å…æ–‡å­—é€‰ä¸­
        e.preventDefault();
      }

      function onMouseMove(e) {
        // ç¼–è¾‘è¾“å…¥å‘½ä¸­æ—¶ä¸å‚ä¸æ¡†é€‰/æ‹–æ‹½åˆ¤å®š
        const tmm = e.target;
        if (tmm && ((tmm.id === 'jsmind-editor') || (tmm.closest && (tmm.closest('.jsmind-editor') || tmm.closest('#jsmind-editor'))) || tmm.tagName === 'INPUT' || tmm.tagName === 'TEXTAREA' || tmm.isContentEditable)) {
          return;
        }
        // ç”»å¸ƒå¹³ç§»æ¨¡å¼
        if (isPanning) {
          const dx = e.clientX - startClientX;
          const dy = e.clientY - startClientY;
          inner.scrollLeft = startScrollLeft - dx;
          inner.scrollTop = startScrollTop - dy;
          e.preventDefault();
          return;
        }

        // å¦‚æœæ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹ï¼Œå®Œå…¨è·³è¿‡æ¡†é€‰é€»è¾‘
        if (isDownOnNode || isDraggingNode) {
          // éšè—æ¡†é€‰çŸ©å½¢ï¼Œä½†**ä¸é˜»æ­¢**jsMindçš„äº‹ä»¶å¤„ç†
          rectEl.style.display = 'none';

          // **æ–°å¢**ï¼šå¤šé€‰èŠ‚ç‚¹æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ
          if (isDraggingNode && multiSelected.size > 1) {
            // ä¸ºå¤šé€‰èŠ‚ç‚¹æ·»åŠ æ‹–æ‹½æ—¶çš„ç‰¹æ®Šæ ·å¼
            multiSelected.forEach(nodeId => {
              const nodeEl = document.querySelector(`[nodeid="${nodeId}"]`);
              if (nodeEl) {
                nodeEl.style.opacity = '0.8';
                nodeEl.style.transform = 'scale(1.1)';
                nodeEl.style.transition = 'all 0.1s ease';
              }
            });
          }

          return;
        }

        // æ™ºèƒ½æ‹–æ‹½æ£€æµ‹ï¼šå¦‚æœé¼ æ ‡æŒ‰ä¸‹æ—¶æœªæ£€æµ‹åˆ°èŠ‚ç‚¹ï¼Œä½†ç§»åŠ¨æ—¶æ£€æµ‹åˆ°åœ¨èŠ‚ç‚¹ä¸Šï¼Œåˆ™è®¤ä¸ºæ˜¯æ‹–æ‹½
        if (!isDownOnNode && !isDraggingNode && isSelectingPrimed) {
          const hoveredNode = document.elementFromPoint(e.clientX, e.clientY);
          if (hoveredNode && (hoveredNode.classList.contains('jmnode') || hoveredNode.closest('.jmnode'))) {
            isDraggingNode = true;
            isSelecting = false;
            isSelectingPrimed = false;
            rectEl.style.display = 'none';
            return;
          }
        }

        if (!isSelecting && !isSelectingPrimed) return;

        // ä½¿ç”¨è§†å£(client)åæ ‡ç³»ç»˜åˆ¶é€‰æ¡†ï¼Œé¿å… transform/scroll æ¢ç®—è¯¯å·®
        const curClientX = e.clientX;
        const curClientY = e.clientY;

        const x = Math.min(startClientX, curClientX);
        const y = Math.min(startClientY, curClientY);
        const w = Math.abs(curClientX - startClientX);
        const h = Math.abs(curClientY - startClientY);

        // ç§»åŠ¨è¶…è¿‡é˜ˆå€¼(>4px)æ‰çœŸæ­£å¼€å§‹æ¡†é€‰
        if (isSelectingPrimed && !isSelecting) {
          if (w > 4 || h > 4) {
            isSelecting = true;
            isSelectingPrimed = false;
            if (!addMode) multiSelected.clear();
            rectEl.style.display = 'block';
          } else {
            return;
          }
        }

        // ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨é€»è¾‘åæ ‡ï¼Œå› ä¸ºinnerå®¹å™¨å·²ç»åº”ç”¨äº†transform scale
        // selectionRectä½œä¸ºinnerçš„å­å…ƒç´ ï¼Œä¼šè‡ªåŠ¨ç»§æ‰¿ç¼©æ”¾æ•ˆæœ

        // è¾¹ç•Œæ£€æŸ¥ï¼šç¡®ä¿çŸ©å½¢ä¸ä¼šè¶…å‡ºinnerå®¹å™¨çš„é€»è¾‘è¾¹ç•Œ
        const maxX = inner.scrollWidth;
        const maxY = inner.scrollHeight;
        const clampedX = Math.max(0, Math.min(x, maxX));
        const clampedY = Math.max(0, Math.min(y, maxY));
        const clampedW = Math.min(w, maxX - clampedX);
        const clampedH = Math.min(h, maxY - clampedY);

        Object.assign(rectEl.style, {
          left: `${clampedX}px`,
          top: `${clampedY}px`,
          width: `${clampedW}px`,
          height: `${clampedH}px`
        });

        // é€‰æ¡†ä¸èŠ‚ç‚¹å‡ä½¿ç”¨ client(getBoundingClientRect) åæ ‡ç³»è¿›è¡Œç›¸äº¤æ£€æµ‹ï¼ˆç›´æ¥ä½¿ç”¨è§†å£åæ ‡ï¼‰
        const selClient = {
          left: x,
          top: y,
          right: x + w,
          bottom: y + h
        };



        // èŠ‚ç‚¹æŸ¥è¯¢
        let nodeElements = [];
        const allNodeElements = document.querySelectorAll('[nodeid]');

        if (allNodeElements.length > 0) {
          nodeElements = Array.from(allNodeElements);
        } else {
          if (nodesRoot) {
            nodeElements = Array.from(nodesRoot.querySelectorAll('.jmnode'));
          }

          if (nodeElements.length === 0) {
            nodeElements = Array.from(document.querySelectorAll('.jmnode'));
          }
        }

        let intersectedCount = 0;
        nodeElements.forEach(el => {
          const nb = el.getBoundingClientRect();
          const intersects = rectsIntersect(selClient, {
            left: nb.left, top: nb.top, right: nb.right, bottom: nb.bottom
          });
          const id = el.getAttribute('nodeid');
          if (!id) return;

          if (intersects) {
            multiSelected.add(id);
            intersectedCount++;
          } else if (!addMode) {
            // æ›¿æ¢æ¨¡å¼æ—¶ï¼Œå®æ—¶ç§»é™¤æœªå‘½ä¸­çš„èŠ‚ç‚¹
            multiSelected.delete(id);
          }
        });

        // å·²ç§»é™¤æ¡†é€‰ç»Ÿè®¡æ—¥å¿—

        updateHighlight();
      }

      function onMouseUp() {
        // ç»“æŸç”»å¸ƒå¹³ç§»
        if (isPanning) {
          isPanning = false;
          inner.style.cursor = '';
          return;
        }

        // è‹¥å¤„äºé¢„å¤‡çŠ¶æ€ä½†æœªè¶…è¿‡é˜ˆå€¼ï¼Œåˆ™å–æ¶ˆ
        if (isSelectingPrimed && !isSelecting) {
          isSelectingPrimed = false;
          return;
        }

        // è‹¥æœ¬æ¬¡æ‹–æ‹½èµ·ç‚¹åœ¨èŠ‚ç‚¹ä¸Šæˆ–æ­£åœ¨æ‹–æ‹½èŠ‚ç‚¹ï¼Œåˆ™ä¸è¿›è¡Œæ¡†é€‰
        if (isDownOnNode || isDraggingNode) {
          // **æ–°å¢**ï¼šå¤šé€‰èŠ‚ç‚¹æ‹–æ‹½ç»“æŸæ—¶çš„æ ·å¼æ¢å¤
          if (isDraggingNode && multiSelected.size > 1) {
            // æ¢å¤å¤šé€‰èŠ‚ç‚¹çš„åŸå§‹æ ·å¼
            multiSelected.forEach(nodeId => {
              const nodeEl = document.querySelector(`[nodeid="${nodeId}"]`);
              if (nodeEl) {
                nodeEl.style.opacity = '';
                nodeEl.style.transform = '';
                nodeEl.style.transition = '';
              }
            });
          }

          isDownOnNode = false;
          isDraggingNode = false;
          isSelecting = false;
          isSelectingPrimed = false;
          rectEl.style.display = 'none';
          return;
        }

        if (!isSelecting) return;

        isSelecting = false;
        rectEl.style.display = 'none';
        updateHighlight();
      }

      // ç»‘å®šäº‹ä»¶åˆ° innerï¼Œè¿™æ ·æ»šåŠ¨ä¸åæ ‡ç³»ä¸€è‡´
      // **ä¸ä½¿ç”¨æ•è·é˜¶æ®µ**ï¼Œé¿å…å¹²æ‰°jsMindçš„äº‹ä»¶å¤„ç†
      inner.addEventListener('mousedown', onMouseDown);
      inner.addEventListener('mousemove', onMouseMove);
      // mouseup ç»‘å®šåˆ° windowï¼Œé¿å…åœ¨å¿«é€Ÿæ‹–åŠ¨å‡ºå®¹å™¨æ—¶ä¸¢äº‹ä»¶
      window.addEventListener('mouseup', onMouseUp);
      // åœ¨ç¼–è¾‘è¾“å…¥ä¸Šé˜»æ­¢äº‹ä»¶ä¼ æ’­ï¼Œé¿å…æ‹–æ‹½/æ¡†é€‰/åŒå‡»å¹²æ‰°ï¼ˆæ•è·é˜¶æ®µï¼Œä¿ç•™é»˜è®¤ä»¥ä¿è¯å…‰æ ‡å®šä½ï¼‰
      const isEditTarget = (t) => !!(t && ((t.id === 'jsmind-editor') || (t.closest && (t.closest('.jsmind-editor') || t.closest('#jsmind-editor'))) || t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable));
      ['mousedown', 'mousemove', 'click', 'dblclick'].forEach(ev => {
        document.addEventListener(ev, function (e) {
          const t = e.target;
          if (isEditTarget(t)) {
            e.stopImmediatePropagation();
            e.stopPropagation();
            // ä¸è¦ preventDefaultï¼Œç¡®ä¿å…‰æ ‡ä¸é€‰æ‹©æ­£å¸¸
          }
        }, true);
      });

      // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬ï¼Œç”¨äºåˆ‡æ¢èŠ‚ç‚¹é€‰æ‹©çŠ¶æ€ï¼ˆç¼–è¾‘æ€ä¸‹ä¸å¤„ç†ï¼Œé¿å…å†²çªï¼‰
      inner.addEventListener('dblclick', function (e) {
        if (document.querySelector('.jsmind-editor') || document.querySelector('#jsmind-editor') || (e.target && (e.target.tagName === 'INPUT' || e.target.isContentEditable || (e.target.closest && (e.target.closest('.jsmind-editor') || e.target.closest('#jsmind-editor')))))) {
          return;
        }
        const clickedNode = e.target.closest('.jmnode');
        if (clickedNode) {
          const nodeId = clickedNode.getAttribute('nodeid');
          if (nodeId) {
            if (multiSelected.has(nodeId)) {
              multiSelected.delete(nodeId);
            } else {
              multiSelected.add(nodeId);
            }
            updateHighlight();
            e.preventDefault();
          }
        }
      });

      // ä½¿ç”¨jsMindåŸç”Ÿäº‹ä»¶ç³»ç»Ÿæ£€æµ‹æ‹–æ‹½
      if (window.jsMind && jm) {
        // ç›‘å¬æ‰€æœ‰jsMindäº‹ä»¶
        jm.add_event_listener(function (type, data) {
          // æ‹–æ‹½å¼€å§‹äº‹ä»¶
          if (type === jsMind.event_type.move_node) {
            if (data && data.data && Array.isArray(data.data) && data.data.length >= 3) {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }
          }

          // ç›‘å¬èŠ‚ç‚¹é€‰æ‹©å˜åŒ–ï¼ˆå¯èƒ½è¡¨ç¤ºæ‹–æ‹½ç»“æŸï¼‰
          if (type === jsMind.event_type.select_node || type === jsMind.event_type.select_clear) {
            if (isDraggingNode) {
              setTimeout(() => {
                isDraggingNode = false;
              }, 100);
            }
          }
        });
      } else {
        // å¤‡ç”¨æ‹–æ‹½æ£€æµ‹æœºåˆ¶
        let dragStartTimer = null;

        // ç›‘å¬mousedownäº‹ä»¶ï¼Œæ£€æµ‹æ˜¯å¦åœ¨èŠ‚ç‚¹ä¸Š
        inner.addEventListener('mousedown', function (e) {
          if (e.target && e.target.closest && e.target.closest('.jmnode')) {
            // å»¶è¿Ÿè®¾ç½®æ‹–æ‹½çŠ¶æ€ï¼Œé¿å…è¯¯è§¦å‘
            dragStartTimer = setTimeout(() => {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }, 100); // 100mså»¶è¿Ÿ
          }
        }, true);

        // ç›‘å¬mouseupäº‹ä»¶ï¼Œé‡ç½®æ‹–æ‹½çŠ¶æ€
        window.addEventListener('mouseup', function () {
          if (dragStartTimer) {
            clearTimeout(dragStartTimer);
            dragStartTimer = null;
          }
          if (isDraggingNode) {
            isDraggingNode = false;
          }
        });

        // ç›‘å¬mousemoveäº‹ä»¶ï¼Œå¦‚æœåœ¨èŠ‚ç‚¹ä¸Šç§»åŠ¨ä¸”æŒ‰ä¸‹äº†é¼ æ ‡ï¼Œè®¤ä¸ºæ˜¯æ‹–æ‹½
        inner.addEventListener('mousemove', function (e) {
          if (e.buttons === 1 && e.target && e.target.closest && e.target.closest('.jmnode')) {
            if (!isDraggingNode) {
              isDraggingNode = true;
              isSelecting = false;
              isSelectingPrimed = false;
              rectEl.style.display = 'none';
            }
          }
        }, true);
      }

      // æ‰¹é‡åˆ é™¤ï¼ˆDelete/Backspaceï¼‰å·²å¤šé€‰çš„èŠ‚ç‚¹ï¼ˆæ•è·é˜¶æ®µä¼˜å…ˆäºå†…ç½®åˆ é™¤ï¼‰
      document.addEventListener('keydown', (e) => {
        const key = e.key || '';
        if ((key === 'Delete' || key === 'Backspace') && typeof window.getMultiSelection === 'function') {
          const ids = window.getMultiSelection();
          if (Array.isArray(ids) && ids.length > 0) {
            e.preventDefault();
            e.stopPropagation();
            ids.filter(id => id && id !== 'root').forEach(id => {
              try { jm.remove_node(id); } catch (err) { }
            });
            if (typeof window.clearMultiSelection === 'function') window.clearMultiSelection();
            if (typeof debouncedSave === 'function') debouncedSave();
          }
        }
      }, true);

      // æ‰¹é‡åˆ é™¤å‡½æ•°ï¼ˆä¾›æŒ‰é’®è°ƒç”¨ï¼‰
      window.batchDelete = function () {
        const ids = window.getMultiSelection();
        if (!Array.isArray(ids) || ids.length === 0) {
          showWarning('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„èŠ‚ç‚¹');
          return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªèŠ‚ç‚¹å—ï¼Ÿ`)) return;

        let deletedCount = 0;
        ids.filter(id => id && id !== 'root').forEach(id => {
          try {
            jm.remove_node(id);
            deletedCount++;
          } catch (err) {
            console.warn(`åˆ é™¤èŠ‚ç‚¹ ${id} å¤±è´¥:`, err);
          }
        });

        if (typeof window.clearMultiSelection === 'function') window.clearMultiSelection();
        if (typeof debouncedSave === 'function') debouncedSave();

        showSuccess(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªèŠ‚ç‚¹`);
      };

      // æ‰¹é‡ç§»åŠ¨å‡½æ•°
      window.batchMove = function () {
        const ids = window.getMultiSelection();
        if (!Array.isArray(ids) || ids.length === 0) {
          showWarning('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„èŠ‚ç‚¹');
          return;
        }

        // è®¾ç½®æ‰¹é‡ç§»åŠ¨æ¨¡å¼
        window.__batchMoving = true;
        window.__batchMoveIds = ids;

        // æ˜¾ç¤ºç§»åŠ¨æç¤º
        const hint = document.createElement('div');
        hint.id = 'batchMoveHint';
        hint.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(76, 154, 255, 0.9);
          color: white;
          padding: 15px 25px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 1000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          text-align: center;
          max-width: 300px;
        `;
        hint.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">æ‰¹é‡ç§»åŠ¨æ¨¡å¼</div>
          <div>ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹ï¼Œå°†é€‰ä¸­çš„ ${ids.length} ä¸ªèŠ‚ç‚¹ç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹åé¢</div>
          <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">æŒ‰ ESC é”®å–æ¶ˆ</div>
        `;
        document.body.appendChild(hint);

        // æ·»åŠ ESCé”®å–æ¶ˆåŠŸèƒ½
        const escHandler = function (e) {
          if (e.key === 'Escape') {
            cancelBatchMove();
          }
        };
        document.addEventListener('keydown', escHandler);

        // å–æ¶ˆæ‰¹é‡ç§»åŠ¨å‡½æ•°
        window.cancelBatchMove = function () {
          window.__batchMoving = false;
          window.__batchMoveIds = [];
          const hint = document.getElementById('batchMoveHint');
          if (hint) hint.remove();
          document.removeEventListener('keydown', escHandler);
          delete window.cancelBatchMove;
        };

        showInfo('æ‰¹é‡ç§»åŠ¨æ¨¡å¼å·²æ¿€æ´»ï¼Œç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹å®Œæˆç§»åŠ¨');
      };
    }

    function exportData() {
      if (!jm) return;
      try {
        const data = jm.get_data();
        const jsonText = JSON.stringify(data, null, 2);
        const pre = document.getElementById('jsonPreview');
        if (pre) pre.textContent = jsonText;
        if (window.jQuery && $('#jsonModal').modal) {
          $('#jsonModal').modal('show');
        } else {
          const w = window.open('', '_blank', 'width=900,height=700');
          if (w) {
            w.document.write('<pre style="white-space:pre-wrap;word-break:break-word;">' +
              (jsonText.replace(/</g, '<')) + '</pre>');
            w.document.close();
          } else {
            showWarning('è¯·å…è®¸å¼¹çª—ä»¥æŸ¥çœ‹JSON');
          }
        }
      } catch (e) {
        showError('æŸ¥çœ‹JSONå¤±è´¥: ' + e.message);
      }
    }

    // æç¤ºä¿¡æ¯å‡½æ•°
    function showWarning(msg) {
      console.warn(msg);
      alert(msg);
    }

    function showError(msg) {
      console.error(msg);
      alert(msg);
    }

    function showSuccess(msg) {
      console.log(msg);
      alert(msg);
    }

    function showInfo(msg) {
      console.log(msg);
      alert(msg);
    }

    // è·å–é»˜è®¤NodeTree
    function getDefaultNodeTree() {
      return {
        "meta": {
          "name": "jsMind remote",
          "author": "mindword",
          "version": "1.0.0"
        },
        "format": "node_tree",
        "data": {
          "id": "root",
          "topic": "æ¬¢è¿ä½¿ç”¨æ€ç»´å¯¼å›¾",
          "children": [
            {
              "id": "sub1",
              "topic": "ç‚¹å‡»èŠ‚ç‚¹ç¼–è¾‘",
              "direction": "right",
              "children": [
                {
                  "id": "sub1_1",
                  "topic": "åŒå‡»ç¼–è¾‘æ–‡æœ¬",
                  "data": {
                    "notes": "åŒå‡»èŠ‚ç‚¹å¯ä»¥ç¼–è¾‘æ–‡æœ¬å†…å®¹"
                  }
                },
                {
                  "id": "sub1_2",
                  "topic": "æ‹–æ‹½è°ƒæ•´ä½ç½®",
                  "data": {
                    "notes": "æ‹–æ‹½èŠ‚ç‚¹å¯ä»¥è°ƒæ•´ä½ç½®å’Œå±‚çº§å…³ç³»"
                  }
                }
              ]
            },
            {
              "id": "sub2",
              "topic": "å³ä¾§ç¼–è¾‘è¯¦æƒ…",
              "direction": "right",
              "data": {
                "notes": "åœ¨å³ä¾§é¢æ¿å¯ä»¥ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯"
              }
            }
          ]
        }
      };
    }

    // ä¿å­˜å½“å‰æ•°æ®åˆ°localStorage
    function saveToLocalStorage() {
      if (!jm) return;

      const currentData = jm.get_data();
      const dataString = JSON.stringify(currentData);

      // é¿å…è§¦å‘æœ¬åœ°ç›‘å¬å™¨ï¼ˆé˜²æ­¢å¾ªç¯åŠ è½½ï¼‰
      lastStorageData = dataString;
      // æ ‡è®°æŠ‘åˆ¶ï¼šæœ¬é¡µå³å°†å†™å…¥ nodetreeï¼Œä¸€æ¬¡è‡ªå‘å†™å…¥
      window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
      localStorage.setItem('mindword_nodetree_data', dataString);
      // åŒæ­¥æ•°æ®åˆ°å„ä¸ªç³»ç»Ÿ
      try {
        // 1. ä¼˜å…ˆä½¿ç”¨syncAllå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (typeof syncAll === 'function') {
          // åŠ¨æ€åŠ è½½è½¬æ¢å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
          if (!window.converter) {
            console.log('æ­£åœ¨åŠ è½½è½¬æ¢å™¨...');
            import('../converter/converter.js')
              .then(module => {
                window.converter = new module.ConverterManager();
                console.log('è½¬æ¢å™¨å·²åŠ è½½');
                // è½¬æ¢å™¨å°±ç»ªåï¼Œç»Ÿä¸€ä»æ€ç»´å¯¼å›¾æºåŒæ­¥å¹¶å†™ä¸‰ä»½ç¼“å­˜
                if (typeof syncAll === 'function') {
                  window.__mindmapSelfUpdateUntil = Date.now() + 1500;
                  // æ ‡è®°æŠ‘åˆ¶ï¼šsyncAll æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å†æ¬¡å†™å…¥ nodetree
                  window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
                  syncAll('mindmap', true, true, currentData);
                }
              })
              .catch(error => {
                console.warn('è½¬æ¢å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ¨¡å¼:', error);
                // é™çº§å¤„ç†ï¼šç›´æ¥ä¿å­˜åˆ°localStorage
                localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
              });
          } else {
            // è½¬æ¢å™¨å·²å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨ï¼šä»æ€ç»´å¯¼å›¾æºåŒæ­¥å¹¶å†™ä¸‰ä»½ç¼“å­˜
            if (typeof syncAll === 'function') {
              window.__mindmapSelfUpdateUntil = Date.now() + 1500;
              // æ ‡è®°æŠ‘åˆ¶ï¼šsyncAll æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½å†æ¬¡å†™å…¥ nodetree
              window.__mindmapSuppressCount = (window.__mindmapSuppressCount || 0) + 1;
              syncAll('mindmap', true, true, currentData);
            }
          }
        } else {
          // 2. é™çº§å¤„ç†ï¼šä¿å­˜åˆ°localStorage
          console.log('syncAllå‡½æ•°ä¸å­˜åœ¨ï¼Œä¿å­˜åˆ°localStorage');
          localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
        }
        // åŒæ­¥åˆ°çˆ¶é¡µé¢
        if (window.parent !== window) {
          window.parent.postMessage({
            type: 'mindmapUpdated',
            data: currentData
          }, '*');
        }
      } catch (error) {
        console.warn('åŒæ­¥æ–¹æ³•è°ƒç”¨å¤±è´¥:', error);
        // æœ€ç»ˆé™çº§å¤„ç†
        localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
      }
    }

    // é˜²æŠ–ä¿å­˜
    let saveTimer = null;
    function debouncedSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => saveToLocalStorage(), 300);
    }

    // ç±»å‹å¯¹é½è¾…åŠ©å‡½æ•°ï¼šè¯»å–/å†™å…¥èŠ‚ç‚¹ç±»å‹ï¼ˆä¼˜å…ˆæ ¹çº§åˆ«ï¼Œå…¼å®¹ data.typeï¼‰
    function getNodeType(n) {
      if (!n) return undefined;

      if (typeof n.type !== 'undefined') {
        return n.type;
      } else if (n.data && typeof n.data.type !== 'undefined') {
        return n.data.type;
      } else if (n.data && n.data.data && typeof n.data.data.type !== 'undefined') {
        return n.data.data.type;
      }
      return undefined;
    }
    function setNodeType(n, t) {
      if (!n) return;
      n.type = t;
      if (n.data) {
        if (n.data.data) {
          n.data.data.type = t;
        } else {
          n.data.type = t;
        }
      }
    }

    // è®¾ç½®èŠ‚ç‚¹å±‚çº§ï¼ˆæ ‡é¢˜ç±»å‹ä¸“ç”¨ï¼‰
    function setNodeLevel(n, level) {
      if (!n || level < 1 || level > 6) return;
      n.level = level;
      if (n.data) {
        if (n.data.data) {
          n.data.data.level = level;
        } else {
          n.data.level = level;
        }
      }
    }
    // è¯»å–èŠ‚ç‚¹å±‚çº§ï¼ˆå…¼å®¹æ ¹çº§å’Œ data.levelï¼‰
    function getNodeLevel(n) {
      if (!n) return null;
      if (typeof n.level !== 'undefined') return n.level;
      if (n.data && typeof n.data.level !== 'undefined') return n.data.level;
      if (n.data && n.data.data && typeof n.data.data.level !== 'undefined') return n.data.data.level;

      // Fallback 1ï¼šå¦‚æœèŠ‚ç‚¹topicæ˜¯æ•°å­—ï¼Œå°è¯•è§£æä¸ºå±‚çº§
      if (n.topic && /^\d+$/.test(n.topic.trim())) {
        const topicLevel = parseInt(n.topic.trim());
        if (topicLevel >= 0 && topicLevel <= 6) {
          return topicLevel;
        }
      }

      // Fallback 2ï¼šåŸºäºèŠ‚ç‚¹åœ¨çˆ¶èŠ‚ç‚¹ä¸­çš„ä½ç½®ä¼°ç®—å±‚çº§
      if (n.parent) {
        const parent = jm.get_node(n.parent.id);
        if (parent && parent.children && parent.children.length > 0) {
          // è®¡ç®—èŠ‚ç‚¹åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­çš„ä½ç½®
          const siblingIndex = parent.children.findIndex(child => child && child.id === n.id);
          if (siblingIndex >= 0) {
            // ç®€å•çš„å¯å‘å¼ï¼šå¦‚æœçˆ¶èŠ‚ç‚¹æœ‰æ˜ç¡®çš„å±‚çº§ï¼Œå­èŠ‚ç‚¹åº”è¯¥æ¯”çˆ¶èŠ‚ç‚¹ä½ä¸€çº§
            const parentLevel = getNodeLevel(parent);
            if (parentLevel !== null && parentLevel >= 1 && parentLevel < 6) {
              const estimatedLevel = parentLevel + 1;
              return estimatedLevel;
            }
          }
        }
      }

      return null;
    }

    // å°†èŠ‚ç‚¹å¼ºåˆ¶è®¾ä¸ºåˆ—è¡¨ç±»å‹ï¼Œå¹¶å°½é‡ç»§æ‰¿åˆ—è¡¨æ ‡è¯†
    function forceListType(n, inheritFrom) {
      if (!n) return;
      const oldType = getNodeType(n);
      let ordered = false;
      let marker = '-';
      if (inheritFrom) {
        const inhData = inheritFrom.data || {};
        ordered = (inhData.ordered != null) ? inhData.ordered : (inheritFrom.ordered != null ? inheritFrom.ordered : false);
        marker = (inhData.marker != null) ? inhData.marker : (inheritFrom.marker != null ? inheritFrom.marker : (ordered ? '1.' : '-'));
      }
      n.type = 'list';
      n.ordered = ordered;
      n.marker = marker;
      if (!n.data) n.data = {};

      // ä¿®å¤ï¼šå¤„ç† jsMind çš„æ•°æ®ç»“æ„å˜åŒ–
      if (n.data.data) {
        // å¦‚æœå­˜åœ¨åµŒå¥—çš„ data ç»“æ„
        n.data.data.type = 'list';
        n.data.data.ordered = ordered;
        n.data.data.marker = marker;
      } else {
        // ä¼ ç»Ÿçš„æ•°æ®ç»“æ„
        n.data.type = 'list';
        n.data.ordered = ordered;
        n.data.marker = marker;
      }

      delete n.level;
      if (n.data) {
        if (n.data.data) {
          delete n.data.data.level;
        } else {
          delete n.data.level;
        }
      }
    }

    // å°†æŸèŠ‚ç‚¹åŠå…¶å…¨éƒ¨å­å­™å½’ä¸€ä¸ºåˆ—è¡¨ï¼ˆç”¨äºè¢«æŒ‚è½½åˆ°åˆ—è¡¨çˆ¶èŠ‚ç‚¹ä¹‹ä¸‹ï¼‰
    function normalizeSubtreeUnderList(rootId, parentNodeForInherit) {
      if (!jm) return;
      const root = jm.get_node(rootId);
      if (!root) return;

      const inheritFrom = parentNodeForInherit || (root.parent ? jm.get_node(root.parent.id) : null);

      const stack = [root];

      while (stack.length > 0) {
        const cur = stack.pop();
        forceListType(cur, inheritFrom);

        if (cur.children && cur.children.length) {
          for (const ch of cur.children) {
            if (ch) stack.push(ch);
          }
        }
      }
    }



    // æ ¹æ®åŒçº§ï¼ˆè‹¥æœ‰ï¼‰æˆ–çˆ¶èŠ‚ç‚¹ï¼ˆè‹¥æ— åŒçº§ï¼‰å¯¹é½å½“å‰èŠ‚ç‚¹ç±»å‹
    function applySiblingOrParentType(nodeOrId) {
      if (!jm) return;
      let node = null;
      if (nodeOrId && typeof nodeOrId === 'object' && nodeOrId.id) {
        node = nodeOrId;
      } else {
        node = jm.get_node(nodeOrId);
      }
      if (!node) return;

      // æ”¶é›†åŒçº§ï¼ˆæ’é™¤è‡ªå·±ï¼‰
      let siblings = [];
      if (node.parent) {
        const parentNode = jm.get_node(node.parent.id);
        if (parentNode && parentNode.children && parentNode.children.length > 0) {
          siblings = parentNode.children.filter(c => c && c.id !== node.id);
        }
      }

      // å‚è€ƒç±»å‹ï¼šä¼˜å…ˆåŒçº§çš„ç¬¬ä¸€ä¸ªæœ‰ç±»å‹çš„èŠ‚ç‚¹ï¼Œå¦åˆ™çˆ¶èŠ‚ç‚¹ç±»å‹
      let refType;
      let refLevel;

      if (siblings.length > 0) {
        for (const s of siblings) {
          const t = getNodeType(s);
          if (typeof t !== 'undefined') {
            refType = t;
            refLevel = getNodeLevel(s);
            break;
          }
        }
      }

      if (typeof refType === 'undefined' && siblings.length === 0 && node.parent) {
        const p = jm.get_node(node.parent.id);
        const pType = getNodeType(p);
        const pLevel = getNodeLevel(p) || 0;

        if (pType === undefined) {
          refType = 'list';
        } else {
          refType = (pType === 'heading' && pLevel >= 6) ? 'list' : pType;

          if (refType === 'heading') {
            if (pLevel >= 1) {
              refLevel = pLevel + 1;
            } else {
              if (p.topic && /^\d+$/.test(p.topic.trim())) {
                const parentTopicLevel = parseInt(p.topic.trim());
                if (parentTopicLevel >= 0 && parentTopicLevel < 6) {
                  refLevel = parentTopicLevel + 1;
                } else {
                  refLevel = 2;
                }
              } else {
                refLevel = 2;
              }
            }
          }
        }
      }

      if (typeof refType === 'undefined') return; // æ²¡æœ‰å¯å‚è€ƒç±»å‹åˆ™ä¸æ”¹
      const curType = getNodeType(node);
      const curLevel = getNodeLevel(node);

      if (curType !== refType) {
        setNodeType(node, refType);

        // å¦‚æœæ˜¯æ ‡é¢˜ç±»å‹ä¸”æœ‰å‚è€ƒå±‚çº§ï¼Œè®¾ç½®åˆé€‚çš„å±‚çº§
        if (refType === 'heading' && typeof refLevel !== 'undefined' && refLevel > 0) {
          setNodeLevel(node, refLevel);
        }

        // ç±»å‹å˜åŒ–åè§¦å‘ä¸€æ¬¡è½»é‡ä¿å­˜ï¼ˆä¸é¢å¤–è°ƒç”¨å…¨é‡åŒæ­¥ï¼‰
        debouncedSave();
      } else if (refType === 'heading' && typeof refLevel !== 'undefined' && curLevel !== refLevel) {
        // ç±»å‹ç›¸åŒä½†å±‚çº§ä¸åŒï¼Œè°ƒæ•´å±‚çº§
        setNodeLevel(node, refLevel);
        debouncedSave();
      }
    }

    // è®¾ç½®æ€ç»´å¯¼å›¾å˜åŒ–ç›‘å¬å™¨
    function setupMindmapChangeWatcher() {
      if (!jm) return;

      // ç›‘å¬jsMindçš„å„ç§å˜åŒ–äº‹ä»¶
      jm.add_event_listener(function (type, data) {
        // åªåœ¨ç‰¹å®šäº‹ä»¶ç±»å‹æ—¶è§¦å‘ä¿å­˜
        const saveEvents = [
          jsMind.event_type.edit,
          jsMind.event_type.add_node,
          jsMind.event_type.remove_node,
          jsMind.event_type.move_node,
          jsMind.event_type.move
        ];

        if (saveEvents.includes(type)) {
          // ä¸“é—¨å¤„ç† move_nodeï¼šç”¨äº‹ä»¶è¿”å›çš„ [nodeId, beforeId, parentId, direction] å…ˆå¼ºåˆ¶é‡æŒ‚è½½ï¼Œå†å½’ä¸€/ä¿å­˜
          try {
            if (type === jsMind.event_type.move_node && data && Array.isArray(data.data) && data.data.length >= 3) {
              const movedId = data.data[0];
              const beforeId = data.data.length > 1 ? data.data[1] : null;
              const newParentId = data.data[2];
              const direction = data.data.length > 3 ? data.data[3] : null;

              // æ‰¹é‡è·Ÿéšç§»åŠ¨ï¼šå¦‚æœå­˜åœ¨å¤šé€‰å¹¶ä¸”å½“å‰ç§»åŠ¨çš„æ˜¯å¤šé€‰é›†åˆä¸­çš„ä¸€ä¸ªï¼Œåˆ™æŠŠå…¶ä½™é€‰ä¸­èŠ‚ç‚¹ä¹Ÿç§»åŠ¨åˆ°ç›¸åŒçš„æ–°çˆ¶èŠ‚ç‚¹ï¼Œä¾æ¬¡è·Ÿåœ¨ movedId ä¹‹å
              try {
                if (!window.__batchMoving && typeof window.getMultiSelection === 'function') {
                  const selectedIds = window.getMultiSelection ? window.getMultiSelection() : [];
                  if (Array.isArray(selectedIds) && selectedIds.length > 1 && selectedIds.includes(movedId)) {
                    window.__batchMoving = true;
                    // å…ˆå°† movedId ä½œä¸ºé”šç‚¹ï¼Œä¹‹åçš„èŠ‚ç‚¹ä¾æ¬¡æ’å…¥åˆ°å®ƒåé¢
                    let anchorId = movedId;
                    for (const sid of selectedIds) {
                      if (!sid || sid === movedId) continue;
                      try {
                        // å°†å…¶ä»–èŠ‚ç‚¹ç§»åŠ¨åˆ°ä¸ movedId ç›¸åŒçš„æ–°çˆ¶èŠ‚ç‚¹ï¼Œå¹¶æ’åœ¨ anchorId åé¢
                        jm.move_node(sid, anchorId, newParentId, direction);
                        anchorId = sid;
                      } catch (eMoveBatch) {
                        // å¿½ç•¥æŸä¸ªèŠ‚ç‚¹ç§»åŠ¨å¤±è´¥ï¼Œç»§ç»­å…¶ä»–
                      }
                    }
                  }
                }
              } finally {
                // çŸ­æš‚å»¶è¿Ÿåè§£é™¤æ‰¹é‡æ ‡è®°ï¼Œå…è®¸åç»­æ­£å¸¸ move äº‹ä»¶
                setTimeout(() => { window.__batchMoving = false; }, 0);
              }

              // 1) å¼ºåˆ¶é‡æŒ‚è½½ï¼ˆç¡®ä¿ç»“æ„çœŸçš„å˜åŒ–ï¼‰
              try {
                jm.move_node(movedId, beforeId, newParentId, direction);
              } catch (eMove) {
                // å¿½ç•¥é‡æŒ‚è½½é”™è¯¯
              }

              // 2) å»¶åä¸€å¸§è¯»å–æœ€æ–°èŠ‚ç‚¹ä¸çˆ¶èŠ‚ç‚¹ï¼Œåšç±»å‹å¯¹é½ä¸åˆ—è¡¨å½’ä¸€ï¼Œå†ä¿å­˜
              setTimeout(() => {
                try {
                  const fresh = jm.get_node(movedId);
                  const parentNode = jm.get_node(newParentId);

                  if (fresh) {
                    applySiblingOrParentType(fresh, parentNode);

                    if (parentNode && typeof getNodeType === 'function') {
                      const parentType = getNodeType(parentNode);
                      // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºåˆ—è¡¨ç±»å‹ï¼Œæˆ–è€…çœ‹èµ·æ¥åƒæ˜¯åˆ—è¡¨ï¼ˆæœ‰åˆ—è¡¨ç‰¹å¾ï¼‰
                      const hasListFeatures = parentNode.data && (parentNode.data.listMarker || parentNode.data.marker || parentNode.data.listLevel !== undefined);

                      if (parentType === 'list' || (parentType === undefined && hasListFeatures)) {
                        normalizeSubtreeUnderList(movedId, parentNode);
                      }
                    }
                  }

                  debouncedSave();
                } catch (eLater) {
                  console.warn('move_node å»¶åå¤„ç†å¤±è´¥:', eLater);
                }
              }, 0);
            }
          } catch (e0) {
            console.warn('åŸºäºè¿”å›IDå¤„ç† move_node å¤±è´¥:', e0);
          }

          // å°è¯•è·å–å—å½±å“èŠ‚ç‚¹å¯¹è±¡ï¼ˆå…¼å®¹å¤šç§äº‹ä»¶æ•°æ®å½¢æ€ï¼‰
          let node = null;
          try {
            // 1) å¸¸è§ï¼šdata.node å¯èƒ½æ˜¯å¯¹è±¡æˆ– id
            let maybe = data && (data.node != null ? data.node : null);
            // 2) move äº‹ä»¶æœ‰æ—¶ç›´æ¥æŠŠèŠ‚ç‚¹å¯¹è±¡æ”¾åœ¨ data ä¸Š
            if (!maybe && data && typeof data === 'object' && data.id) {
              maybe = data;
            }
            // 3) å¦‚æœ maybe æ˜¯ id å­—ç¬¦ä¸²
            if (maybe && typeof maybe === 'string') {
              node = jm.get_node(maybe);
            } else if (maybe && typeof maybe === 'object' && maybe.id) {
              node = maybe;
            }
            // 4) å…œåº•ï¼šç”¨å½“å‰é€‰ä¸­èŠ‚ç‚¹
            if (!node) {
              const sel = jm.get_selected_node && jm.get_selected_node();
              if (sel) {
                node = typeof sel === 'string' ? jm.get_node(sel) : sel;
              }
            }
          } catch (e) {
            console.warn('äº‹ä»¶æ•°æ®ä¸­æ— æ³•è§£æèŠ‚ç‚¹:', e);
          }

          // ç±»å‹å¯¹é½ï¼šå»¶ååˆ°ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯ï¼Œç¡®ä¿jsMindå·²æ›´æ–°çˆ¶å­å…³ç³»
          if (node) {
            setTimeout(() => {
              try {
                const fresh = jm.get_node(node.id);
                if (!fresh) return;

                // è·å–çˆ¶èŠ‚ç‚¹
                const parentNode = fresh.parent ? jm.get_node(fresh.parent.id) : null;
                applySiblingOrParentType(fresh, parentNode);

                // è‹¥çˆ¶ä¸ºåˆ—è¡¨ï¼Œåˆ™å°†è‡ªå·±ä¸å­å­™å…¨éƒ¨å½’ä¸€ä¸ºåˆ—è¡¨ï¼ˆå…œåº•ï¼Œé˜²æ­¢æœªèµ°APIåŒ…è£…ï¼‰
                try {
                  const p = fresh.parent ? jm.get_node(fresh.parent.id) : null;
                  if (p && typeof getNodeType === 'function' && getNodeType(p) === 'list') {
                    normalizeSubtreeUnderList(fresh.id, p);
                  }
                } catch (e2) {
                  // å¿½ç•¥å½’ä¸€åŒ–é”™è¯¯
                }

                debouncedSave();
              } catch (e3) {
                console.warn('å»¶åå¤„ç†å¤±è´¥:', e3);
              }
            }, 0);
          }
        }
      });
    }


    // ç›‘å¬localStorageå˜åŒ–ï¼ˆåŒ…æ‹¬åŒä¸€é¡µé¢å†…çš„ä¿®æ”¹ï¼‰
    let lastStorageData = null;
    let storageCheckTimer = null;
    let lastChangeTime = 0;

    // æ£€æŸ¥localStorageæ•°æ®æ˜¯å¦å˜åŒ–çš„å‡½æ•°ï¼ˆå¸¦é˜²æŠ–ï¼‰
    function checkLocalStorageChange() {
      const now = Date.now();
      if (window.__mindmapSelfUpdateUntil && now < window.__mindmapSelfUpdateUntil) {
        return;
      }

      let currentData;
      try {
        currentData = localStorage.getItem('mindword_nodetree_data');
      } catch (e) {
        return;
      }

      // è‹¥ä¸ºæœ¬é¡µè‡ªå‘å†™å…¥ï¼Œæ¶ˆè´¹ä¸€æ¬¡æŠ‘åˆ¶è®¡æ•°å¹¶è·³è¿‡åˆ·æ–°
      if (window.__mindmapSuppressCount && window.__mindmapSuppressCount > 0) {
        window.__mindmapSuppressCount--;
        lastStorageData = currentData;
        return;
      }

      if (currentData !== lastStorageData) {
        lastStorageData = currentData;
        lastChangeTime = now;

        // é˜²æŠ–å¤„ç†ï¼šå»¶è¿Ÿ500msæ‰§è¡Œï¼Œé¿å…é¢‘ç¹åˆ·æ–°
        clearTimeout(storageCheckTimer);
        storageCheckTimer = setTimeout(() => {
          try {
            loadNodeTree();
          } catch (e) {
            // å¿½ç•¥é‡æ–°åŠ è½½é”™è¯¯
          }
        }, 500);
      }
    }


    // è®¾ç½®localStorageå˜åŒ–ç›‘å¬å™¨
    function setupLocalStorageWatcher() {
      // ä¿å­˜åˆå§‹æ•°æ®
      lastStorageData = localStorage.getItem('mindword_nodetree_data');

      // ä½¿ç”¨setIntervalå®šæœŸæ£€æŸ¥å˜åŒ–ï¼ˆæ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼‰
      setInterval(checkLocalStorageChange, 500);

      // åŒæ—¶ç›‘å¬storageäº‹ä»¶ï¼ˆå¤„ç†å…¶ä»–é¡µé¢çš„å˜åŒ–ï¼‰
      window.addEventListener('storage', function (e) {
        if (e.key === 'mindword_nodetree_data') {
          checkLocalStorageChange();
        }
      });

      // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºåŒä¸€é¡µé¢å†…çš„é€šçŸ¥ï¼‰
      window.addEventListener('mindwordDataUpdated', function () {
        checkLocalStorageChange();
      });
    }

    // ä¸‹è½½æ€ç»´å¯¼å›¾ä¸ºå›¾ç‰‡
    function downloadMindmap() {
      if (!jm) return;
      try {
        // åˆ›å»ºæ–°çš„æˆªå›¾æ’ä»¶å®ä¾‹ï¼Œä½¿ç”¨ç™½è‰²èƒŒæ™¯
        var screenshot_plugin = new JmScreenshot(jm, {
          background: '#ffffff'  // è®¾ç½®ç™½è‰²èƒŒæ™¯
        });
        screenshot_plugin.shoot();
      } catch (error) {
        // é™é»˜å¤„ç†ä¸‹è½½é”™è¯¯
      }
    }



    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', async function () {
      // åˆå§‹åŒ–è½¬æ¢å™¨
      try {
        if (!window.converter) {
          const module = await import('../converter/converter.js');
          window.converter = new module.ConverterManager();
          // å¹¿æ’­å°±ç»ªäº‹ä»¶ï¼ˆä¾›éœ€è¦æ—¶ç›‘å¬ï¼‰
          window.dispatchEvent(new Event('converterReady'));
        }
      } catch (error) {
        // å¿½ç•¥è½¬æ¢å™¨åˆå§‹åŒ–é”™è¯¯
      }

      initMindmap();
      setupLocalStorageWatcher();
      setupMindmapChangeWatcher();
      // å¯ç”¨æ¡†é€‰å¤šé€‰
      setupBoxSelection();

      // åˆå§‹åŒ–AIæ‰©å†™åŠŸèƒ½
      if (window.AIExpander) {
        window.aiExpander = new window.AIExpander();
        window.aiExpander.init(jm);
      }
    });



  </script>
</body>

</html>