<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindWord</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap CSS for notifications -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 精确还原 Tab 样式（作用于 .tabs / .tab，保留类名与交互不变） */
        .tabs {
            display: flex;
            border-radius: 8px;
            background-color: #e5e7eb;
            overflow: hidden;
            width: fit-content;
            border: 1px solid #d1d5db;
            padding: 0;
            align-items: center;
            flex: 0 0 auto;
            gap: 0px;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #9b9da1;
            transition: background 0.2s ease, color 0.15s ease;
            margin: 2px;

        }

        .tab:last-child {
            /* 保持自然形态 */
        }

        .tab.active {
            background-color: #ffffff;
            border-radius: 6px;
            margin: 2px;
            color: #333;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);


        }

        /* svg/icon 精确 16px */
        .tab svg,
        .tab .icon {
            width: 16px;
            height: 16px;
            flex: 0 0 16px;
            display: block;
            fill: #9b9da1;
        }

        .tab.active svg,
        .tab.active .icon {
            fill: #333;
        }

        .tab:not(.active):hover {
            background-color: #eff0f1;
        }

        .tab>span {
            line-height: 16px;
            font-weight: 400;
            font-size: 14px;
        }

        /* 兼容 emoji 文字符号，使其尺寸与 svg 一致 */
        .tab>.emoji,
        .tab>.emj {
            font-size: 16px;
            line-height: 16px;
            display: inline-block;
        }

        /* 焦点可见，但样式更柔和（保留可访问性） */
        .tab:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        }

        /* 移动端克隆容器保持样式一致 */
        .mobile-tabs {
            display: none;
            gap: 8px;
        }

        /* 当 mobile-tabs 显示时，使用相同的样式行为 */
        @media (max-width: 768px) {
            .mobile-tabs {
                display: flex;
                position: fixed;
                bottom: 8px;
                left: 50%;
                transform: translateX(-50%);
                background: transparent;
                z-index: 999;
            }

            .header .tabs {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="brand"
            style="font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-weight:700; font-size:26px; background: linear-gradient(0deg,#0b82e4 0%,#11c49d 100%); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">
            MindWord
        </div>
        <div class="tabs">
            <div class="tab active" data-panel="editor" style="font-size:14px;"><svg t="1759394685575" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1342" width="200"
                    height="200">
                    <path
                        d="M527.37066667 90.6976v62.41493333a7.8016 7.8016 0 0 1-7.80266667 7.8016H199.92426667a39.00906667 39.00906667 0 0 0-38.38613334 31.98826667l-0.624 7.02186667V824.07466667a39.00906667 39.00906667 0 0 0 31.98826667 38.38613333l7.02186667 0.624H824.07466667a39.00906667 39.00906667 0 0 0 38.38613333-31.98826667l0.624-7.02186666v-338.60266667a7.8016 7.8016 0 0 1 7.8016-7.8016h62.41493333a7.8016 7.8016 0 0 1 7.80266667 7.8016v338.60266667a117.02826667 117.02826667 0 0 1-105.79413333 116.4832l-11.2352 0.54613333H199.92533333a117.02826667 117.02826667 0 0 1-116.4832-105.79413333l-0.54613333-11.2352V199.92533333a117.02826667 117.02826667 0 0 1 105.79413333-116.4832l11.2352-0.54613333h319.64373334a7.8016 7.8016 0 0 1 7.8016 7.80266667z m327.83466666 33.93813333l44.16 44.15893334a7.8016 7.8016 0 0 1 0 11.00053333L413.85066667 665.30773333a7.8016 7.8016 0 0 1-11.00053334 0l-44.15893333-44.16a7.8016 7.8016 0 0 1 0-10.99946666l485.51253333-485.51253334a7.8016 7.8016 0 0 1 11.00053334 0z"
                        p-id="1343"></path>
                </svg>


                <span>文本编辑</span>
            </div>
            <div class="tab active" data-panel="preview" style="font-size:14px;"><svg t="1759394709317" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1495" width="200"
                    height="200">
                    <path
                        d="M648.101506 803.835981a35.839821 35.839821 0 0 0-35.839821-35.839821H291.836621a35.839821 35.839821 0 1 0 0 72.106306h319.9984a35.839821 35.839821 0 0 0 36.266485-36.266485z m127.99936-159.9992a35.839821 35.839821 0 0 0-35.839821-35.839821H291.836621a35.839821 35.839821 0 1 0 0 72.106306h447.99776a35.839821 35.839821 0 0 0 36.266485-36.266485z m-191.99904-159.9992a35.839821 35.839821 0 0 0-35.839821-35.839821h-255.99872a35.839821 35.839821 0 1 0 0 72.106306h255.99872a35.839821 35.839821 0 0 0 35.839821-36.266485z m238.932139 469.330986H200.103746V72.106306H511.99552v239.785468A72.959635 72.959635 0 0 0 584.101826 383.99808h238.932139zM582.821833 110.506114l200.958995 201.812324h-200.958995z m291.83854 191.145711L597.328427 21.333227a76.799616 76.799616 0 0 0-14.506594-11.519943l-4.266646-2.133322h-2.986652A71.679642 71.679642 0 0 0 546.128683 0H200.957075A72.959635 72.959635 0 0 0 127.99744 72.106306v879.782268A72.959635 72.959635 0 0 0 200.957075 1023.99488h622.930219A71.252977 71.252977 0 0 0 895.9936 951.888574V352.424905a71.252977 71.252977 0 0 0-21.333227-50.77308z"
                        fill="#5E5C5C" p-id="1496"></path>
                </svg>
                <span>文档预览</span>
            </div>
            <div class="tab active" data-panel="mindmap" style="font-size:14px;"><svg t="1759394646816" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1189" width="200"
                    height="200">
                    <path
                        d="M911.45752364 467.61583017a44.38416983 44.38416983 0 0 1 0 88.76833966h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833966h355.07335381z m0 310.68918518a44.38416983 44.38416983 0 0 1 0 88.76833967h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833967h355.07335381z m0-621.37837037a44.38416983 44.38416983 0 0 1 0 88.76833967h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833967h355.07335381zM112.54247636 556.38416983l-5.90309451-0.31068918C53.42276267 550.34792194 55.42004994 467.61583017 112.54247636 467.61583017h88.76833846c23.16853673 0 32.22290674-18.59696746 44.91677969-101.06275248 1.50906228-9.85328541 2.21920795-14.64677535 3.10689185-19.97287637 17.13228883-107.72037874 42.60880202-163.06743857 115.48760837-187.38996353a44.38416983 44.38416983 0 0 1 28.05079518 84.24115405c-29.6042411 9.85328541-43.7184066 40.5671311-55.92405333 117.08543795l-3.01812334 19.52903502c-4.83787481 31.46837621-9.98643758 58.18764614-16.42214316 80.60165113L315.37812943 467.61583017H378.84749172a44.38416983 44.38416983 0 0 1 44.07348064 39.19122219L423.23166155 512a44.38416983 44.38416983 0 0 1-44.38416983 44.38416983H315.42251429l2.13043943 6.96831423c5.59240533 19.61780231 10.20835946 42.52003472 14.55800806 69.01738277l1.81975146 11.53988471 3.06250699 19.57341867c12.16126188 76.51830806 26.27542858 107.23215254 55.92405334 117.08543795a44.38416983 44.38416983 0 1 1-28.09517884 84.24115405c-72.92319001-24.32252496-98.35531954-79.66958356-115.48760837-187.38996353-0.8876839-5.3260998-1.59782958-10.11959094-3.10689185-19.97287637C233.53372157 575.02552095 224.47935154 556.38416983 201.31081482 556.38416983H112.54247636z"
                        fill="#000000" fill-opacity=".65" p-id="1190"></path>
                </svg>

                <span>思维导图</span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-small" id="focus-toggle">
                <div class="focus-icon"></div>
                <span>专注模式</span>
            </button>
        </div>
    </header>

    <!-- 移动端底部 Tabs 容器（JS 会在移动端将顶部 tabs 克隆到这里） -->
    <div id="mobile-tabs" class="mobile-tabs" aria-hidden="true"></div>

    <!-- 主内容区域 -->
    <main class="main-content" id="main-content">
        <!-- 专注模式提示 -->
        <div class="focus-indicator">专注模式</div>

        <!-- MD编辑面板 -->
        <div class="panel editor-panel" id="editor-panel">
            <div class="panel-header">
                <span>Markdown 编辑器</span>
                <button class="btn btn-icon" onclick="togglePanel('editor')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="editor-placeholder">
                    <div class="loading">正在加载编辑器</div>
                    <small>地址: <span id="editor-url">未配置</span></small>
                </div>
            </div>
        </div>

        <!-- 分隔条1 -->
        <div class="resizer" id="resizer1"></div>

        <!-- MD预览面板 -->
        <div class="panel preview-panel" id="preview-panel">
            <div class="panel-header">
                <span>Markdown 预览</span>
                <button class="btn btn-icon" onclick="togglePanel('preview')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="preview-placeholder">
                    <div class="loading">正在加载预览</div>
                    <small>地址: <span id="preview-url">未配置</span></small>
                </div>
            </div>
        </div>

        <!-- 分隔条2 -->
        <div class="resizer" id="resizer2"></div>

        <!-- 思维导图面板 -->
        <div class="panel mindmap-panel" id="mindmap-panel">
            <div class="panel-header">
                <span>思维导图</span>
                <button class="btn btn-icon" onclick="togglePanel('mindmap')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="mindmap-placeholder">
                    <div class="loading">正在加载思维导图</div>
                    <small>地址: <span id="mindmap-url">未配置</span></small>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================================
        // 📌 页面配置 - 在这里修改三个页面的地址
        // ===================================
        const PAGE_CONFIG = {
            // Markdown 编辑器页面地址
            editor: {
                url: 'editor/editor.html', // 填入您的编辑器页面地址，例如: 'https://your-domain.com/editor.html'
                title: 'Markdown 编辑器'
            },

            // Markdown 预览页面地址
            preview: {
                url: 'md2word/md2word.html', // 填入您的预览页面地址，例如: 'https://your-domain.com/preview.html'
                title: 'Markdown 预览'
            },

            // 思维导图页面地址
            mindmap: {
                url: 'jsmind/mindmap.html', // 填入您的思维导图页面地址，例如: 'https://your-domain.com/mindmap.html'
                title: '思维导图'
            }
        };

        // ===================================
        // 应用状态管理
        // ===================================

        // 面板状态管理
        const panels = {
            editor: true,
            preview: true,
            mindmap: true
        };

        // 专注模式状态
        let focusMode = false;
        let activeFocusPanel = 'editor';

        // 拖拽状态 - 优化后的状态管理
        let dragState = {
            isDragging: false,
            currentResizer: null,
            startX: 0,
            currentX: 0,
            leftPanel: null,
            rightPanel: null,
            startLeftWidth: 0,
            startRightWidth: 0,
            containerWidth: 0,
            animationId: null
        };

        // ===================================
        // 页面加载功能
        // ===================================

        // 加载iframe内容（改进：标识 iframe，onload 后向子页请求重排）
        function loadPanelContent(panelName) {
            const config = PAGE_CONFIG[panelName];
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const placeholder = document.getElementById(`${panelName}-placeholder`);
            const urlSpan = document.getElementById(`${panelName}-url`);

            // 更新URL显示
            urlSpan.textContent = config.url || '未配置';

            if (!config.url) {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">⚠️ 页面地址未配置</div>
                    <small>请在 PAGE_CONFIG.${panelName}.url 中设置页面地址</small>
                `;
                return;
            }

            // 检查是否已经有iframe
            const existingIframe = panelContent.querySelector('iframe');
            if (existingIframe) {
                return;
            }

            // 创建iframe
            const iframe = document.createElement('iframe');
            // 添加时间戳参数避免缓存
            const timestamp = new Date().getTime();
            iframe.src = config.url + (config.url.includes('?') ? '&' : '?') + '_t=' + timestamp;

            // 标识 iframe 便于后续选择与消息转发
            iframe.dataset.panel = panelName;
            iframe.id = `iframe-${panelName}`;

            // 样式：确保占满面板内容
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.backgroundColor = 'white';
            iframe.style.display = 'none';

            // 加载成功后显示并请求子页重排（立即+短延迟）
            iframe.onload = function () {
                placeholder.style.display = 'none';
                iframe.style.display = 'block';

                // 请求子页重排，防止首次渲染时尺寸未就绪
                try {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                        setTimeout(() => {
                            try { iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*'); } catch (e) { }
                        }, 200);
                    }
                } catch (e) { console.warn('postMessage to iframe failed', e); }
            };

            iframe.onerror = function () {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">❌ 页面加载失败</div>
                    <small>地址: ${config.url}</small>
                    <br>
                    <button onclick="retryLoad('${panelName}')" style="margin-top: 10px; padding: 5px 10px; border: 1px solid #3498db; background: white; color: #3498db; border-radius: 4px; cursor: pointer;">重试</button>
                `;
            };

            panelContent.appendChild(iframe);

            // 在父页窗口尺寸变化时，通知子 iframe 重排（防止父容器被调整）
            // 延迟合并多次 resize
            let _relayoutTimer = null;
            window.addEventListener('resize', function () {
                clearTimeout(_relayoutTimer);
                _relayoutTimer = setTimeout(function () {
                    try {
                        if (iframe && iframe.contentWindow) iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                    } catch (e) { }
                }, 150);
            }, { passive: true });
        }

        // 重试加载
        function retryLoad(panelName) {
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const iframe = panelContent.querySelector('iframe');
            if (iframe) {
                iframe.remove();
            }

            const placeholder = document.getElementById(`${panelName}-placeholder`);
            placeholder.innerHTML = `
                <div class="loading">正在重新加载</div>
                <small>地址: <span id="${panelName}-url">${PAGE_CONFIG[panelName].url}</span></small>
            `;
            placeholder.style.display = 'flex';

            setTimeout(() => loadPanelContent(panelName), 100);
        }

        // ===================================
        // 专注模式功能
        // ===================================

        // 切换专注模式
        function toggleFocusMode() {
            focusMode = !focusMode;
            const mainContent = document.getElementById('main-content');
            const focusToggle = document.getElementById('focus-toggle');

            if (focusMode) {
                mainContent.classList.add('focus-mode');
                focusToggle.classList.add('active');
                focusToggle.querySelector('span').textContent = '退出专注';
                enterFocusMode();
            } else {
                mainContent.classList.remove('focus-mode');
                focusToggle.classList.remove('active');
                focusToggle.querySelector('span').textContent = '专注模式';
                exitFocusMode();
            }

            updateLayout();
            updateTabs();
        }

        // 进入专注模式
        function enterFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = false;
            });
            panels[activeFocusPanel] = true;
        }

        // 退出专注模式
        function exitFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = true;
            });
        }

        // ===================================
        // 面板管理功能
        // ===================================

        // 切换面板显示/隐藏
        function togglePanel(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
            } else {
                const visiblePanels = Object.values(panels).filter(v => v).length;

                if (visiblePanels <= 1 && panels[panelName]) {
                    showWarning('至少需要保留一个视图面板！', 3000);
                    return;
                }

                panels[panelName] = !panels[panelName];
            }

            updateLayout();
            updateTabs();
        }

        // 处理Tab点击
        function handleTabClick(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
                updateLayout();
                updateTabs();
            } else {
                togglePanel(panelName);
            }
            // 在移动端切换到某个面板时，若是思维导图则触发 iframe 强制重载/重排
            try { if (typeof MW_reloadMindmapOnShowIfMobile === 'function') MW_reloadMindmapOnShowIfMobile(panelName); } catch (e) { /* ignore */ }
        }

        // 更新布局
        function updateLayout() {
            const editorPanel = document.getElementById('editor-panel');
            const previewPanel = document.getElementById('preview-panel');
            const mindmapPanel = document.getElementById('mindmap-panel');
            const resizer1 = document.getElementById('resizer1');
            const resizer2 = document.getElementById('resizer2');

            // 显示/隐藏面板
            editorPanel.classList.toggle('hidden', !panels.editor);
            previewPanel.classList.toggle('hidden', !panels.preview);
            mindmapPanel.classList.toggle('hidden', !panels.mindmap);

            if (focusMode) {
                resizer1.style.display = 'none';
                resizer2.style.display = 'none';
                return;
            }

            // 处理分隔条显示
            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            resizer1.style.display = 'none';
            resizer2.style.display = 'none';

            if (visiblePanels.length === 2) {
                if (visiblePanels.includes('editor') && visiblePanels.includes('preview')) {
                    resizer1.style.display = 'block';
                } else if (visiblePanels.includes('preview') && visiblePanels.includes('mindmap')) {
                    resizer2.style.display = 'block';
                } else if (visiblePanels.includes('editor') && visiblePanels.includes('mindmap')) {
                    resizer1.style.display = 'block';
                }
            } else if (visiblePanels.length === 3) {
                resizer1.style.display = 'block';
                resizer2.style.display = 'block';
            }

            resetFlexBasis();
        }

        // 重置flex基础值
        function resetFlexBasis() {
            if (focusMode) return;

            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            if (visiblePanels.length === 0) return;

            // 重置flex属性
            if (panels.editor) {
                document.getElementById('editor-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.preview) {
                document.getElementById('preview-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.mindmap) {
                document.getElementById('mindmap-panel').style.flex = visiblePanels.length === 3 ? '2' : '1';
            }
        }

        // 更新tab状态
        function updateTabs() {
            document.querySelectorAll('.tab[data-panel]').forEach(tab => {
                const panelName = tab.dataset.panel;
                if (focusMode) {
                    tab.classList.toggle('active', panelName === activeFocusPanel);
                } else {
                    tab.classList.toggle('active', panels[panelName]);
                }
            });
        }

        // ===================================
        // 拖拽功能 - 使用像素直接映射，1:1跟随鼠标
        // ===================================

        // 获取相邻面板
        function getAdjacentPanels(resizer) {
            const mainContent = document.getElementById('main-content');
            const allChildren = Array.from(mainContent.children);
            const resizerIndex = allChildren.indexOf(resizer);

            let leftPanel = null;
            let rightPanel = null;

            // 向左找可见面板
            for (let i = resizerIndex - 1; i >= 0; i--) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    leftPanel = element;
                    break;
                }
            }

            // 向右找可见面板
            for (let i = resizerIndex + 1; i < allChildren.length; i++) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    rightPanel = element;
                    break;
                }
            }

            return { leftPanel, rightPanel };
        }

        // 开始拖拽
        function startDrag(e, resizer) {
            if (focusMode) return;

            e.preventDefault();

            const { leftPanel, rightPanel } = getAdjacentPanels(resizer);
            if (!leftPanel || !rightPanel) return;

            const containerWidth = document.getElementById('main-content').offsetWidth;

            // 设置拖拽状态
            dragState = {
                isDragging: true,
                currentResizer: resizer,
                startX: e.clientX,
                currentX: e.clientX,
                leftPanel: leftPanel,
                rightPanel: rightPanel,
                startLeftWidth: leftPanel.offsetWidth,
                startRightWidth: rightPanel.offsetWidth,
                containerWidth: containerWidth,
                animationId: null
            };

            // 添加视觉反馈和禁用过渡
            resizer.classList.add('dragging');
            document.body.classList.add('resizing', 'no-select');
            leftPanel.classList.add('resizing');
            rightPanel.classList.add('resizing');
        }

        // 处理拖拽 - 1:1像素映射
        function handleDrag(e) {
            if (!dragState.isDragging) return;

            dragState.currentX = e.clientX;

            // 取消之前的动画帧
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // 使用requestAnimationFrame确保流畅性
            dragState.animationId = requestAnimationFrame(() => {
                const deltaX = dragState.currentX - dragState.startX;

                // 计算新的宽度（像素值）
                const newLeftWidth = dragState.startLeftWidth + deltaX;
                const newRightWidth = dragState.startRightWidth - deltaX;

                // 设置最小宽度限制
                const minWidth = 100;

                if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
                    // 转换为百分比以保持响应式
                    const leftPercent = (newLeftWidth / dragState.containerWidth) * 100;
                    const rightPercent = (newRightWidth / dragState.containerWidth) * 100;

                    // 直接设置width而不是flex，确保精确控制
                    dragState.leftPanel.style.width = `${leftPercent}%`;
                    dragState.rightPanel.style.width = `${rightPercent}%`;
                    dragState.leftPanel.style.flex = 'none';
                    dragState.rightPanel.style.flex = 'none';
                }
            });
        }

        // 结束拖拽
        function endDrag() {
            if (!dragState.isDragging) return;

            // 取消动画帧
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // 清理视觉反馈
            if (dragState.currentResizer) {
                dragState.currentResizer.classList.remove('dragging');
            }
            if (dragState.leftPanel) {
                dragState.leftPanel.classList.remove('resizing');
            }
            if (dragState.rightPanel) {
                dragState.rightPanel.classList.remove('resizing');
            }
            document.body.classList.remove('resizing', 'no-select');

            // 重置状态
            dragState = {
                isDragging: false,
                currentResizer: null,
                startX: 0,
                currentX: 0,
                leftPanel: null,
                rightPanel: null,
                startLeftWidth: 0,
                startRightWidth: 0,
                containerWidth: 0,
                animationId: null
            };
        }

        // 初始化拖拽功能
        function initResizing() {
            const resizers = document.querySelectorAll('.resizer');

            resizers.forEach(resizer => {
                // 鼠标按下开始拖拽
                resizer.addEventListener('mousedown', (e) => startDrag(e, resizer), { passive: false });
            });

            // 全局鼠标事件
            document.addEventListener('mousemove', handleDrag, { passive: true });
            document.addEventListener('mouseup', endDrag, { passive: true });

            // 防止拖拽时选择文本
            document.addEventListener('selectstart', (e) => {
                if (dragState.isDragging) e.preventDefault();
            });
        }

        // ===================================
        // 事件监听器
        // ===================================

        // 移动端自动进入专注模式（隐藏专注切换按钮并进入专注）
        (function initMobileFocus() {
            const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
            const focusToggle = document.getElementById('focus-toggle');
            if (isMobile) {
                // 隐藏专注切换按钮（样式已在 mobile CSS 中隐藏 header-right）
                if (focusToggle) focusToggle.style.display = 'none';

                // 设置专注状态并激活默认面板
                focusMode = true;
                activeFocusPanel = activeFocusPanel || 'editor';

                const mainContent = document.getElementById('main-content');
                if (mainContent) mainContent.classList.add('focus-mode');

                // 调用现有的专注初始化逻辑（如果存在）
                if (typeof enterFocusMode === 'function') enterFocusMode();
                if (typeof updateTabs === 'function') updateTabs();
                if (typeof updateLayout === 'function') updateLayout();
            }
        })();

        // 专注模式切换按钮事件
        document.getElementById('focus-toggle').addEventListener('click', toggleFocusMode);

        // Tab点击事件
        document.querySelectorAll('.tab[data-panel]').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelName = tab.dataset.panel;
                handleTabClick(panelName);
            });
        });

        // 键盘快捷键 - ESC退出专注模式
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && focusMode) {
                toggleFocusMode();
            }
        });

        // ===================================
        // 全局通知系统
        // ===================================

        /**
         * 显示全局通知消息（替代alert）
         * @param {string} message - 通知消息
         * @param {string} type - 通知类型：success, danger, warning, info
         * @param {number} duration - 显示时长（毫秒）
         */
        function showNotification(message, type = 'info', duration = 1500) {
            if (typeof $ === 'undefined') {
                // 如果jQuery不可用，回退到alert
                alert(message);
                return;
            }

            // 统一颜色方案
            const typeStyles = {
                success: 'background-color: #28a745; border-color: #28a745; color: white;', // 绿色
                danger: 'background-color: #dc3545; border-color: #dc3545; color: white;',   // 红色
                warning: 'background-color: #ffc107; border-color: #ffc107; color: #212529;', // 黄色
                info: 'background-color: #17a2b8; border-color: #17a2b8; color: white;'     // 蓝色
            };

            // 创建通知容器（如果不存在）——右对齐多条通知，垂直排列
            if ($('#global-notification-container').length === 0) {
                $('body').append('<div id="global-notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; align-items: flex-end;"></div>');
            }

            // 创建通知元素
            const notificationId = 'global-notification-' + Date.now();
            const notificationHtml = `
                <div id="${notificationId}" class="alert alert-dismissible fade show" 
                     style="display: inline-flex; align-items: center; height: 24px; line-height: 14px; padding: 0 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); margin: 0; white-space: nowrap; ${typeStyles[type] || typeStyles.info}">
                    <span style="font-size:12px; padding-right:16px;">${message}</span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="color: inherit; opacity: 0.9; padding:0 6px; height:20px; line-height:20px; background:transparent; border:none; display:inline-flex; align-items:center; justify-content:center;">
                        <span aria-hidden="true" style="font-size:12px; line-height:20px;">&times;</span>
                    </button>
                </div>
            `;

            // 添加到通知容器
            $('#global-notification-container').append(notificationHtml);

            // 自动移除
            setTimeout(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // 重新排列剩余通知
                    rearrangeGlobalNotifications();
                });
            }, duration);

            // 点击关闭按钮时移除
            $(`#${notificationId} .close`).click(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // 重新排列剩余通知
                    rearrangeGlobalNotifications();
                });
            });
        }

        /**
         * 重新排列全局通知
         */
        function rearrangeGlobalNotifications() {
            const $container = $('#global-notification-container');
            const $notifications = $container.children('.alert');

            if ($notifications.length === 0) {
                // 如果没有通知了，移除容器
                $container.remove();
                return;
            }

            // 重新计算位置
            $notifications.each(function (index) {
                const $notification = $(this);
                // 添加平滑过渡效果
                $notification.css('transition', 'transform 0.3s ease');
                $notification.css('transform', `translateY(0)`);
            });
        }

        /**
         * 显示成功通知
         */
        function showSuccess(message, duration = 1500) {
            showNotification(message, 'success', duration);
        }

        /**
         * 显示错误通知
         */
        function showError(message, duration = 3000) {
            showNotification(message, 'danger', duration);
        }

        /**
         * 显示警告通知
         */
        function showWarning(message, duration = 2000) {
            showNotification(message, 'warning', duration);
        }

        /**
         * 显示信息通知
         */
        function showInfo(message, duration = 1500) {
            showNotification(message, 'info', duration);
        }

        /**
         * 处理来自子页面的通知消息
         * - 新增处理 mw_editing_mode 消息以设置全局抑制标志 window.__mw_global_suppress_toasts
         * - 当全局抑制生效时，对 type==='notification' 的消息仅记录到 console 不展示 UI 通知
         */
        function handleNotificationMessage(event) {
            // 验证消息来源
            if (!event.data || !event.data.type) return;

            // 先处理编辑模式开关消息（由子 iframe 广播）
            try {
                if (event.data.type === 'mw_editing_mode') {
                    try {
                        window.__mw_global_suppress_toasts = !!event.data.editing;
                        console.log('[INDEX] mw_editing_mode ->', window.__mw_global_suppress_toasts);
                    } catch (e) { /* ignore */ }
                    return;
                }
            } catch (e) { /* ignore */ }

            // 转发来自思维导图的节点选中消息到 editor iframe（用于滚动/高亮）
            try {
                if (event.data.type === 'mindmap-node-selected') {
                    // 找到 editor 面板 iframe（基于 PAGE_CONFIG 或常见选择器）
                    var editorIframe = document.querySelector('iframe[data-panel="editor"], iframe#panel-editor, iframe[src*="editor/editor.html"]');
                    // 找到 preview/md2word 面板 iframe
                    var previewIframe = document.querySelector('iframe[data-panel="preview"], iframe#panel-preview, iframe[src*="md2word/md2word.html"], iframe[src*="preview"]');
                    var payload = event.data;
                    var forwardEditor = {
                        type: 'editor-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };
                    var forwardPreview = {
                        type: 'preview-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };

                    // 转发到 editor iframe
                    if (editorIframe && editorIframe.contentWindow) {
                        try {
                            editorIframe.contentWindow.postMessage(forwardEditor, '*');
                            console.log('[INDEX FORWARD] -> editor', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD] editor postMessage failed', e);
                        }
                    } else {
                        // 如果 editor iframe 尚未就绪，缓存最后一条消息，init 时可重发
                        window.__mw__pendingEditorMessage = forwardEditor;
                        console.log('[INDEX FORWARD] editor iframe not ready, cached');
                    }

                    // 转发到 preview/md2word iframe（如果存在）
                    if (previewIframe && previewIframe.contentWindow) {
                        try {
                            previewIframe.contentWindow.postMessage(forwardPreview, '*');
                            console.log('[INDEX FORWARD PREVIEW] -> preview', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD PREVIEW] preview postMessage failed', e);
                        }
                    } else {
                        // 缓存以便在 iframe 初始化时重发
                        window.__mw__pendingPreviewMessage = forwardPreview;
                        console.log('[INDEX FORWARD PREVIEW] preview iframe not ready, cached');
                    }
                    return;
                }
            } catch (e) {
                console.warn('forwarding mindmap message failed', e);
            }

            // 只处理通知相关的消息
            if (event.data.type === 'notification') {
                const { message, notificationType, duration } = event.data;

                // 若父页处于全局抑制状态，则跳过可视通知，仅写 console（避免编辑时打断）
                if (window.__mw_global_suppress_toasts) {
                    try {
                        console.log('[INDEX] notification suppressed ->', notificationType, message);
                    } catch (e) { }
                    return;
                }

                switch (notificationType) {
                    case 'success':
                        showSuccess(message, duration);
                        break;
                    case 'error':
                        showError(message, duration);
                        break;
                    case 'warning':
                        showWarning(message, duration);
                        break;
                    case 'info':
                        showInfo(message, duration);
                        break;
                    default:
                        showNotification(message, notificationType, duration);
                }
            }
        }

        // ===================================
        // 初始化
        // ===================================

        // 初始化应用
        function initApp() {
            updateLayout();
            initResizing();

            // 加载所有面板内容
            Object.keys(PAGE_CONFIG).forEach(panelName => {
                loadPanelContent(panelName);
            });

            // 监听来自子页面的消息
            window.addEventListener('message', handleNotificationMessage);
            // 调试：打印所有收到的原始 message，便于排查 mindmap -> index -> editor 的消息流
            window.addEventListener('message', function (e) {
                try { console.log('[INDEX RAW MESSAGE]', e && e.data); } catch (err) { }
            }, { passive: true });

            console.log('📌 Markdown Studio 已初始化');
            console.log('配置信息:', PAGE_CONFIG);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initApp);

        // 在移动端创建底部 tabs：克隆 header .tabs 到 mobile-tabs（保持事件绑定）
        function createMobileTabs() {
            try {
                const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
                const headerTabs = document.querySelector('.header .tabs');
                const mobileContainer = document.getElementById('mobile-tabs');
                if (!headerTabs || !mobileContainer) return;

                // 清空并克隆
                mobileContainer.innerHTML = '';
                headerTabs.querySelectorAll('.tab[data-panel]').forEach(tab => {
                    const panel = tab.dataset.panel;
                    const clone = tab.cloneNode(true);
                    clone.classList.remove('active');
                    clone.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleTabClick(panel);
                        // 视觉反馈
                        document.querySelectorAll('.mobile-tabs .tab').forEach(t => t.classList.remove('active'));
                        clone.classList.add('active');
                    });
                    mobileContainer.appendChild(clone);
                });

                // 显示/隐藏与 focusMode 状态同步
                if (isMobile) {
                    mobileContainer.setAttribute('aria-hidden', 'false');
                    mobileContainer.style.display = 'flex';
                } else {
                    mobileContainer.setAttribute('aria-hidden', 'true');
                    mobileContainer.style.display = 'none';
                }

                // 同步激活状态
                updateTabs();
            } catch (e) {
                console.warn('createMobileTabs error', e);
            }
        }

        // 当窗口尺寸变化时同步 mobile tabs
        window.addEventListener('resize', () => {
            // debounce 简单实现
            clearTimeout(window._mobileTabsResizeTimer);
            window._mobileTabsResizeTimer = setTimeout(() => createMobileTabs(), 120);
        });

        // 在 initApp 中也调用一次（在 DOMContentLoaded 之后）
        document.addEventListener('DOMContentLoaded', () => {
            createMobileTabs();
        });
    </script>

    <script>
        (function () {
            // 仅在移动端启用的 mindmap iframe 强制重载策略
            function isMobile() {
                return (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
            }

            function reloadMindmapIframeOnce() {
                var iframe = document.getElementById('iframe-mindmap');
                if (!iframe) {
                    // 如果没有 id 为 iframe-mindmap 的元素，尝试按 panel src 选择
                    iframe = document.querySelector('iframe[src*="jsmind/mindmap.html"]');
                }
                if (!iframe) return;
                try {
                    var src = iframe.getAttribute('src') || iframe.src;
                    src = src.replace(/([?&])_t=\d+/, '$1');
                    iframe.src = src + (src.includes('?') ? '&' : '?') + '_t=' + Date.now();

                    function onLoadHandler() {
                        try {
                            if (iframe.contentWindow) {
                                iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                                setTimeout(function () { try { iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*'); } catch (e) { } }, 200);
                            }
                        } catch (e) { }
                        iframe.removeEventListener('load', onLoadHandler);
                    }
                    iframe.addEventListener('load', onLoadHandler);
                } catch (e) { console.warn('reloadMindmapIframeOnce error', e); }
            }

            window.MW_reloadMindmapOnShowIfMobile = function (panelName) {
                if (panelName !== 'mindmap') return;
                if (!isMobile()) return;
                setTimeout(reloadMindmapIframeOnce, 80);
            };
        })();
    </script>
</body>

</html>

</html>