<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindWord</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Bootstrap CSS for notifications -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="brand" style="font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; font-weight:700; font-size:26px; background: linear-gradient(0deg,#0b82e4 0%,#11c49d 100%); -webkit-background-clip: text; background-clip: text; color: transparent; -webkit-text-fill-color: transparent;">
          MindWord
        </div>
        <div class="tabs">
            <div class="tab active" data-panel="editor" style="font-size:14px;">âœï¸ æ–‡æœ¬ç¼–è¾‘</div>
            <div class="tab active" data-panel="preview" style="font-size:14px;">ğŸ“„ æ–‡æ¡£é¢„è§ˆ</div>
            <div class="tab active" data-panel="mindmap" style="font-size:14px;">ğŸ§  æ€ç»´å¯¼å›¾</div>
        </div>
        <div class="header-right">
            <button class="btn btn-small" id="focus-toggle">
                <div class="focus-icon"></div>
                <span>ä¸“æ³¨æ¨¡å¼</span>
            </button>
        </div>
    </header>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨ Tabs å®¹å™¨ï¼ˆJS ä¼šåœ¨ç§»åŠ¨ç«¯å°†é¡¶éƒ¨ tabs å…‹éš†åˆ°è¿™é‡Œï¼‰ -->
    <div id="mobile-tabs" class="mobile-tabs" aria-hidden="true"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="main-content">
        <!-- ä¸“æ³¨æ¨¡å¼æç¤º -->
        <div class="focus-indicator">ä¸“æ³¨æ¨¡å¼</div>

        <!-- MDç¼–è¾‘é¢æ¿ -->
        <div class="panel editor-panel" id="editor-panel">
            <div class="panel-header">
                <span>Markdown ç¼–è¾‘å™¨</span>
                <button class="btn btn-icon" onclick="togglePanel('editor')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="editor-placeholder">
                    <div class="loading">æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨</div>
                    <small>åœ°å€: <span id="editor-url">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡1 -->
        <div class="resizer" id="resizer1"></div>

        <!-- MDé¢„è§ˆé¢æ¿ -->
        <div class="panel preview-panel" id="preview-panel">
            <div class="panel-header">
                <span>Markdown é¢„è§ˆ</span>
                <button class="btn btn-icon" onclick="togglePanel('preview')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="preview-placeholder">
                    <div class="loading">æ­£åœ¨åŠ è½½é¢„è§ˆ</div>
                    <small>åœ°å€: <span id="preview-url">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡2 -->
        <div class="resizer" id="resizer2"></div>

        <!-- æ€ç»´å¯¼å›¾é¢æ¿ -->
        <div class="panel mindmap-panel" id="mindmap-panel">
            <div class="panel-header">
                <span>æ€ç»´å¯¼å›¾</span>
                <button class="btn btn-icon" onclick="togglePanel('mindmap')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="mindmap-placeholder">
                    <div class="loading">æ­£åœ¨åŠ è½½æ€ç»´å¯¼å›¾</div>
                    <small>åœ°å€: <span id="mindmap-url">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================================
        // ğŸ“Œ é¡µé¢é…ç½® - åœ¨è¿™é‡Œä¿®æ”¹ä¸‰ä¸ªé¡µé¢çš„åœ°å€
        // ===================================
        const PAGE_CONFIG = {
            // Markdown ç¼–è¾‘å™¨é¡µé¢åœ°å€
            editor: {
                url: 'editor/editor.html', // å¡«å…¥æ‚¨çš„ç¼–è¾‘å™¨é¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/editor.html'
                title: 'Markdown ç¼–è¾‘å™¨'
            },

            // Markdown é¢„è§ˆé¡µé¢åœ°å€
            preview: {
                url: 'md2word/md2word.html', // å¡«å…¥æ‚¨çš„é¢„è§ˆé¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/preview.html'
                title: 'Markdown é¢„è§ˆ'
            },

            // æ€ç»´å¯¼å›¾é¡µé¢åœ°å€
            mindmap: {
                url: 'jsmind/mindmap.html', // å¡«å…¥æ‚¨çš„æ€ç»´å¯¼å›¾é¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/mindmap.html'
                title: 'æ€ç»´å¯¼å›¾'
            }
        };

        // ===================================
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        // ===================================

        // é¢æ¿çŠ¶æ€ç®¡ç†
        const panels = {
            editor: true,
            preview: true,
            mindmap: true
        };

        // ä¸“æ³¨æ¨¡å¼çŠ¶æ€
        let focusMode = false;
        let activeFocusPanel = 'editor';

        // æ‹–æ‹½çŠ¶æ€ - ä¼˜åŒ–åçš„çŠ¶æ€ç®¡ç†
        let dragState = {
            isDragging: false,
            currentResizer: null,
            startX: 0,
            currentX: 0,
            leftPanel: null,
            rightPanel: null,
            startLeftWidth: 0,
            startRightWidth: 0,
            containerWidth: 0,
            animationId: null
        };

        // ===================================
        // é¡µé¢åŠ è½½åŠŸèƒ½
        // ===================================

        // åŠ è½½iframeå†…å®¹
        function loadPanelContent(panelName) {
            const config = PAGE_CONFIG[panelName];
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const placeholder = document.getElementById(`${panelName}-placeholder`);
            const urlSpan = document.getElementById(`${panelName}-url`);

            // æ›´æ–°URLæ˜¾ç¤º
            urlSpan.textContent = config.url || 'æœªé…ç½®';

            if (!config.url) {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">âš ï¸ é¡µé¢åœ°å€æœªé…ç½®</div>
                    <small>è¯·åœ¨ PAGE_CONFIG.${panelName}.url ä¸­è®¾ç½®é¡µé¢åœ°å€</small>
                `;
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰iframe
            const existingIframe = panelContent.querySelector('iframe');
            if (existingIframe) {
                return;
            }

            // åˆ›å»ºiframe
            const iframe = document.createElement('iframe');
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            iframe.src = config.url + (config.url.includes('?') ? '&' : '?') + '_t=' + timestamp;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.backgroundColor = 'white';

            // iframeåŠ è½½äº‹ä»¶
            iframe.onload = function () {
                placeholder.style.display = 'none';
                iframe.style.display = 'block';
            };

            iframe.onerror = function () {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">âŒ é¡µé¢åŠ è½½å¤±è´¥</div>
                    <small>åœ°å€: ${config.url}</small>
                    <br>
                    <button onclick="retryLoad('${panelName}')" style="margin-top: 10px; padding: 5px 10px; border: 1px solid #3498db; background: white; color: #3498db; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
                `;
            };

            iframe.style.display = 'none';
            panelContent.appendChild(iframe);
        }

        // é‡è¯•åŠ è½½
        function retryLoad(panelName) {
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const iframe = panelContent.querySelector('iframe');
            if (iframe) {
                iframe.remove();
            }

            const placeholder = document.getElementById(`${panelName}-placeholder`);
            placeholder.innerHTML = `
                <div class="loading">æ­£åœ¨é‡æ–°åŠ è½½</div>
                <small>åœ°å€: <span id="${panelName}-url">${PAGE_CONFIG[panelName].url}</span></small>
            `;
            placeholder.style.display = 'flex';

            setTimeout(() => loadPanelContent(panelName), 100);
        }

        // ===================================
        // ä¸“æ³¨æ¨¡å¼åŠŸèƒ½
        // ===================================

        // åˆ‡æ¢ä¸“æ³¨æ¨¡å¼
        function toggleFocusMode() {
            focusMode = !focusMode;
            const mainContent = document.getElementById('main-content');
            const focusToggle = document.getElementById('focus-toggle');

            if (focusMode) {
                mainContent.classList.add('focus-mode');
                focusToggle.classList.add('active');
                focusToggle.querySelector('span').textContent = 'é€€å‡ºä¸“æ³¨';
                enterFocusMode();
            } else {
                mainContent.classList.remove('focus-mode');
                focusToggle.classList.remove('active');
                focusToggle.querySelector('span').textContent = 'ä¸“æ³¨æ¨¡å¼';
                exitFocusMode();
            }

            updateLayout();
            updateTabs();
        }

        // è¿›å…¥ä¸“æ³¨æ¨¡å¼
        function enterFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = false;
            });
            panels[activeFocusPanel] = true;
        }

        // é€€å‡ºä¸“æ³¨æ¨¡å¼
        function exitFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = true;
            });
        }

        // ===================================
        // é¢æ¿ç®¡ç†åŠŸèƒ½
        // ===================================

        // åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
        function togglePanel(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
            } else {
                const visiblePanels = Object.values(panels).filter(v => v).length;

                if (visiblePanels <= 1 && panels[panelName]) {
                    showWarning('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªè§†å›¾é¢æ¿ï¼', 3000);
                    return;
                }

                panels[panelName] = !panels[panelName];
            }

            updateLayout();
            updateTabs();
        }

        // å¤„ç†Tabç‚¹å‡»
        function handleTabClick(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
                updateLayout();
                updateTabs();
            } else {
                togglePanel(panelName);
            }
        }

        // æ›´æ–°å¸ƒå±€
        function updateLayout() {
            const editorPanel = document.getElementById('editor-panel');
            const previewPanel = document.getElementById('preview-panel');
            const mindmapPanel = document.getElementById('mindmap-panel');
            const resizer1 = document.getElementById('resizer1');
            const resizer2 = document.getElementById('resizer2');

            // æ˜¾ç¤º/éšè—é¢æ¿
            editorPanel.classList.toggle('hidden', !panels.editor);
            previewPanel.classList.toggle('hidden', !panels.preview);
            mindmapPanel.classList.toggle('hidden', !panels.mindmap);

            if (focusMode) {
                resizer1.style.display = 'none';
                resizer2.style.display = 'none';
                return;
            }

            // å¤„ç†åˆ†éš”æ¡æ˜¾ç¤º
            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            resizer1.style.display = 'none';
            resizer2.style.display = 'none';

            if (visiblePanels.length === 2) {
                if (visiblePanels.includes('editor') && visiblePanels.includes('preview')) {
                    resizer1.style.display = 'block';
                } else if (visiblePanels.includes('preview') && visiblePanels.includes('mindmap')) {
                    resizer2.style.display = 'block';
                } else if (visiblePanels.includes('editor') && visiblePanels.includes('mindmap')) {
                    resizer1.style.display = 'block';
                }
            } else if (visiblePanels.length === 3) {
                resizer1.style.display = 'block';
                resizer2.style.display = 'block';
            }

            resetFlexBasis();
        }

        // é‡ç½®flexåŸºç¡€å€¼
        function resetFlexBasis() {
            if (focusMode) return;

            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            if (visiblePanels.length === 0) return;

            // é‡ç½®flexå±æ€§
            if (panels.editor) {
                document.getElementById('editor-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.preview) {
                document.getElementById('preview-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.mindmap) {
                document.getElementById('mindmap-panel').style.flex = visiblePanels.length === 3 ? '2' : '1';
            }
        }

        // æ›´æ–°tabçŠ¶æ€
        function updateTabs() {
            document.querySelectorAll('.tab[data-panel]').forEach(tab => {
                const panelName = tab.dataset.panel;
                if (focusMode) {
                    tab.classList.toggle('active', panelName === activeFocusPanel);
                } else {
                    tab.classList.toggle('active', panels[panelName]);
                }
            });
        }

        // ===================================
        // æ‹–æ‹½åŠŸèƒ½ - ä½¿ç”¨åƒç´ ç›´æ¥æ˜ å°„ï¼Œ1:1è·Ÿéšé¼ æ ‡
        // ===================================

        // è·å–ç›¸é‚»é¢æ¿
        function getAdjacentPanels(resizer) {
            const mainContent = document.getElementById('main-content');
            const allChildren = Array.from(mainContent.children);
            const resizerIndex = allChildren.indexOf(resizer);

            let leftPanel = null;
            let rightPanel = null;

            // å‘å·¦æ‰¾å¯è§é¢æ¿
            for (let i = resizerIndex - 1; i >= 0; i--) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    leftPanel = element;
                    break;
                }
            }

            // å‘å³æ‰¾å¯è§é¢æ¿
            for (let i = resizerIndex + 1; i < allChildren.length; i++) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    rightPanel = element;
                    break;
                }
            }

            return { leftPanel, rightPanel };
        }

        // å¼€å§‹æ‹–æ‹½
        function startDrag(e, resizer) {
            if (focusMode) return;

            e.preventDefault();

            const { leftPanel, rightPanel } = getAdjacentPanels(resizer);
            if (!leftPanel || !rightPanel) return;

            const containerWidth = document.getElementById('main-content').offsetWidth;

            // è®¾ç½®æ‹–æ‹½çŠ¶æ€
            dragState = {
                isDragging: true,
                currentResizer: resizer,
                startX: e.clientX,
                currentX: e.clientX,
                leftPanel: leftPanel,
                rightPanel: rightPanel,
                startLeftWidth: leftPanel.offsetWidth,
                startRightWidth: rightPanel.offsetWidth,
                containerWidth: containerWidth,
                animationId: null
            };

            // æ·»åŠ è§†è§‰åé¦ˆå’Œç¦ç”¨è¿‡æ¸¡
            resizer.classList.add('dragging');
            document.body.classList.add('resizing', 'no-select');
            leftPanel.classList.add('resizing');
            rightPanel.classList.add('resizing');
        }

        // å¤„ç†æ‹–æ‹½ - 1:1åƒç´ æ˜ å°„
        function handleDrag(e) {
            if (!dragState.isDragging) return;

            dragState.currentX = e.clientX;

            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»å¸§
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // ä½¿ç”¨requestAnimationFrameç¡®ä¿æµç•…æ€§
            dragState.animationId = requestAnimationFrame(() => {
                const deltaX = dragState.currentX - dragState.startX;

                // è®¡ç®—æ–°çš„å®½åº¦ï¼ˆåƒç´ å€¼ï¼‰
                const newLeftWidth = dragState.startLeftWidth + deltaX;
                const newRightWidth = dragState.startRightWidth - deltaX;

                // è®¾ç½®æœ€å°å®½åº¦é™åˆ¶
                const minWidth = 100;

                if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
                    // è½¬æ¢ä¸ºç™¾åˆ†æ¯”ä»¥ä¿æŒå“åº”å¼
                    const leftPercent = (newLeftWidth / dragState.containerWidth) * 100;
                    const rightPercent = (newRightWidth / dragState.containerWidth) * 100;

                    // ç›´æ¥è®¾ç½®widthè€Œä¸æ˜¯flexï¼Œç¡®ä¿ç²¾ç¡®æ§åˆ¶
                    dragState.leftPanel.style.width = `${leftPercent}%`;
                    dragState.rightPanel.style.width = `${rightPercent}%`;
                    dragState.leftPanel.style.flex = 'none';
                    dragState.rightPanel.style.flex = 'none';
                }
            });
        }

        // ç»“æŸæ‹–æ‹½
        function endDrag() {
            if (!dragState.isDragging) return;

            // å–æ¶ˆåŠ¨ç”»å¸§
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // æ¸…ç†è§†è§‰åé¦ˆ
            if (dragState.currentResizer) {
                dragState.currentResizer.classList.remove('dragging');
            }
            if (dragState.leftPanel) {
                dragState.leftPanel.classList.remove('resizing');
            }
            if (dragState.rightPanel) {
                dragState.rightPanel.classList.remove('resizing');
            }
            document.body.classList.remove('resizing', 'no-select');

            // é‡ç½®çŠ¶æ€
            dragState = {
                isDragging: false,
                currentResizer: null,
                startX: 0,
                currentX: 0,
                leftPanel: null,
                rightPanel: null,
                startLeftWidth: 0,
                startRightWidth: 0,
                containerWidth: 0,
                animationId: null
            };
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initResizing() {
            const resizers = document.querySelectorAll('.resizer');

            resizers.forEach(resizer => {
                // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
                resizer.addEventListener('mousedown', (e) => startDrag(e, resizer), { passive: false });
            });

            // å…¨å±€é¼ æ ‡äº‹ä»¶
            document.addEventListener('mousemove', handleDrag, { passive: true });
            document.addEventListener('mouseup', endDrag, { passive: true });

            // é˜²æ­¢æ‹–æ‹½æ—¶é€‰æ‹©æ–‡æœ¬
            document.addEventListener('selectstart', (e) => {
                if (dragState.isDragging) e.preventDefault();
            });
        }

        // ===================================
        // äº‹ä»¶ç›‘å¬å™¨
        // ===================================

        // ç§»åŠ¨ç«¯è‡ªåŠ¨è¿›å…¥ä¸“æ³¨æ¨¡å¼ï¼ˆéšè—ä¸“æ³¨åˆ‡æ¢æŒ‰é’®å¹¶è¿›å…¥ä¸“æ³¨ï¼‰
        (function initMobileFocus() {
            const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
            const focusToggle = document.getElementById('focus-toggle');
            if (isMobile) {
                // éšè—ä¸“æ³¨åˆ‡æ¢æŒ‰é’®ï¼ˆæ ·å¼å·²åœ¨ mobile CSS ä¸­éšè— header-rightï¼‰
                if (focusToggle) focusToggle.style.display = 'none';

                // è®¾ç½®ä¸“æ³¨çŠ¶æ€å¹¶æ¿€æ´»é»˜è®¤é¢æ¿
                focusMode = true;
                activeFocusPanel = activeFocusPanel || 'editor';

                const mainContent = document.getElementById('main-content');
                if (mainContent) mainContent.classList.add('focus-mode');

                // è°ƒç”¨ç°æœ‰çš„ä¸“æ³¨åˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof enterFocusMode === 'function') enterFocusMode();
                if (typeof updateTabs === 'function') updateTabs();
                if (typeof updateLayout === 'function') updateLayout();
            }
        })();

        // ä¸“æ³¨æ¨¡å¼åˆ‡æ¢æŒ‰é’®äº‹ä»¶
        document.getElementById('focus-toggle').addEventListener('click', toggleFocusMode);

        // Tabç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.tab[data-panel]').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelName = tab.dataset.panel;
                handleTabClick(panelName);
            });
        });

        // é”®ç›˜å¿«æ·é”® - ESCé€€å‡ºä¸“æ³¨æ¨¡å¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && focusMode) {
                toggleFocusMode();
            }
        });

        // ===================================
        // å…¨å±€é€šçŸ¥ç³»ç»Ÿ
        // ===================================

        /**
         * æ˜¾ç¤ºå…¨å±€é€šçŸ¥æ¶ˆæ¯ï¼ˆæ›¿ä»£alertï¼‰
         * @param {string} message - é€šçŸ¥æ¶ˆæ¯
         * @param {string} type - é€šçŸ¥ç±»å‹ï¼šsuccess, danger, warning, info
         * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
         */
        function showNotification(message, type = 'info', duration = 1500) {
            if (typeof $ === 'undefined') {
                // å¦‚æœjQueryä¸å¯ç”¨ï¼Œå›é€€åˆ°alert
                alert(message);
                return;
            }

            // ç»Ÿä¸€é¢œè‰²æ–¹æ¡ˆ
            const typeStyles = {
                success: 'background-color: #28a745; border-color: #28a745; color: white;', // ç»¿è‰²
                danger: 'background-color: #dc3545; border-color: #dc3545; color: white;',   // çº¢è‰²
                warning: 'background-color: #ffc107; border-color: #ffc107; color: #212529;', // é»„è‰²
                info: 'background-color: #17a2b8; border-color: #17a2b8; color: white;'     // è“è‰²
            };

            // åˆ›å»ºé€šçŸ¥å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰â€”â€”å³å¯¹é½å¤šæ¡é€šçŸ¥ï¼Œå‚ç›´æ’åˆ—
            if ($('#global-notification-container').length === 0) {
                $('body').append('<div id="global-notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; align-items: flex-end;"></div>');
            }

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notificationId = 'global-notification-' + Date.now();
            const notificationHtml = `
                <div id="${notificationId}" class="alert alert-dismissible fade show" 
                     style="display: inline-flex; align-items: center; height: 24px; line-height: 14px; padding: 0 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); margin: 0; white-space: nowrap; ${typeStyles[type] || typeStyles.info}">
                    <span style="font-size:12px; padding-right:16px;">${message}</span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="color: inherit; opacity: 0.9; padding:0 6px; height:20px; line-height:20px; background:transparent; border:none; display:inline-flex; align-items:center; justify-content:center;">
                        <span aria-hidden="true" style="font-size:12px; line-height:20px;">&times;</span>
                    </button>
                </div>
            `;

            // æ·»åŠ åˆ°é€šçŸ¥å®¹å™¨
            $('#global-notification-container').append(notificationHtml);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // é‡æ–°æ’åˆ—å‰©ä½™é€šçŸ¥
                    rearrangeGlobalNotifications();
                });
            }, duration);

            // ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶ç§»é™¤
            $(`#${notificationId} .close`).click(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // é‡æ–°æ’åˆ—å‰©ä½™é€šçŸ¥
                    rearrangeGlobalNotifications();
                });
            });
        }

        /**
         * é‡æ–°æ’åˆ—å…¨å±€é€šçŸ¥
         */
        function rearrangeGlobalNotifications() {
            const $container = $('#global-notification-container');
            const $notifications = $container.children('.alert');

            if ($notifications.length === 0) {
                // å¦‚æœæ²¡æœ‰é€šçŸ¥äº†ï¼Œç§»é™¤å®¹å™¨
                $container.remove();
                return;
            }

            // é‡æ–°è®¡ç®—ä½ç½®
            $notifications.each(function (index) {
                const $notification = $(this);
                // æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
                $notification.css('transition', 'transform 0.3s ease');
                $notification.css('transform', `translateY(0)`);
            });
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
         */
        function showSuccess(message, duration = 1500) {
            showNotification(message, 'success', duration);
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
         */
        function showError(message, duration = 3000) {
            showNotification(message, 'danger', duration);
        }

        /**
         * æ˜¾ç¤ºè­¦å‘Šé€šçŸ¥
         */
        function showWarning(message, duration = 2000) {
            showNotification(message, 'warning', duration);
        }

        /**
         * æ˜¾ç¤ºä¿¡æ¯é€šçŸ¥
         */
        function showInfo(message, duration = 1500) {
            showNotification(message, 'info', duration);
        }

        /**
         * å¤„ç†æ¥è‡ªå­é¡µé¢çš„é€šçŸ¥æ¶ˆæ¯
         * - æ–°å¢å¤„ç† mw_editing_mode æ¶ˆæ¯ä»¥è®¾ç½®å…¨å±€æŠ‘åˆ¶æ ‡å¿— window.__mw_global_suppress_toasts
         * - å½“å…¨å±€æŠ‘åˆ¶ç”Ÿæ•ˆæ—¶ï¼Œå¯¹ type==='notification' çš„æ¶ˆæ¯ä»…è®°å½•åˆ° console ä¸å±•ç¤º UI é€šçŸ¥
         */
        function handleNotificationMessage(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æº
            if (!event.data || !event.data.type) return;

            // å…ˆå¤„ç†ç¼–è¾‘æ¨¡å¼å¼€å…³æ¶ˆæ¯ï¼ˆç”±å­ iframe å¹¿æ’­ï¼‰
            try {
                if (event.data.type === 'mw_editing_mode') {
                    try {
                        window.__mw_global_suppress_toasts = !!event.data.editing;
                        console.log('[INDEX] mw_editing_mode ->', window.__mw_global_suppress_toasts);
                    } catch (e) { /* ignore */ }
                    return;
                }
            } catch (e) { /* ignore */ }

            // è½¬å‘æ¥è‡ªæ€ç»´å¯¼å›¾çš„èŠ‚ç‚¹é€‰ä¸­æ¶ˆæ¯åˆ° editor iframeï¼ˆç”¨äºæ»šåŠ¨/é«˜äº®ï¼‰
            try {
                if (event.data.type === 'mindmap-node-selected') {
                    // æ‰¾åˆ° editor é¢æ¿ iframeï¼ˆåŸºäº PAGE_CONFIG æˆ–å¸¸è§é€‰æ‹©å™¨ï¼‰
                    var editorIframe = document.querySelector('iframe[data-panel="editor"], iframe#panel-editor, iframe[src*="editor/editor.html"]');
                    // æ‰¾åˆ° preview/md2word é¢æ¿ iframe
                    var previewIframe = document.querySelector('iframe[data-panel="preview"], iframe#panel-preview, iframe[src*="md2word/md2word.html"], iframe[src*="preview"]');
                    var payload = event.data;
                    var forwardEditor = {
                        type: 'editor-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };
                    var forwardPreview = {
                        type: 'preview-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };

                    // è½¬å‘åˆ° editor iframe
                    if (editorIframe && editorIframe.contentWindow) {
                        try {
                            editorIframe.contentWindow.postMessage(forwardEditor, '*');
                            console.log('[INDEX FORWARD] -> editor', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD] editor postMessage failed', e);
                        }
                    } else {
                        // å¦‚æœ editor iframe å°šæœªå°±ç»ªï¼Œç¼“å­˜æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œinit æ—¶å¯é‡å‘
                        window.__mw__pendingEditorMessage = forwardEditor;
                        console.log('[INDEX FORWARD] editor iframe not ready, cached');
                    }

                    // è½¬å‘åˆ° preview/md2word iframeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (previewIframe && previewIframe.contentWindow) {
                        try {
                            previewIframe.contentWindow.postMessage(forwardPreview, '*');
                            console.log('[INDEX FORWARD PREVIEW] -> preview', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD PREVIEW] preview postMessage failed', e);
                        }
                    } else {
                        // ç¼“å­˜ä»¥ä¾¿åœ¨ iframe åˆå§‹åŒ–æ—¶é‡å‘
                        window.__mw__pendingPreviewMessage = forwardPreview;
                        console.log('[INDEX FORWARD PREVIEW] preview iframe not ready, cached');
                    }
                    return;
                }
            } catch (e) {
                console.warn('forwarding mindmap message failed', e);
            }

            // åªå¤„ç†é€šçŸ¥ç›¸å…³çš„æ¶ˆæ¯
            if (event.data.type === 'notification') {
                const { message, notificationType, duration } = event.data;

                // è‹¥çˆ¶é¡µå¤„äºå…¨å±€æŠ‘åˆ¶çŠ¶æ€ï¼Œåˆ™è·³è¿‡å¯è§†é€šçŸ¥ï¼Œä»…å†™ consoleï¼ˆé¿å…ç¼–è¾‘æ—¶æ‰“æ–­ï¼‰
                if (window.__mw_global_suppress_toasts) {
                    try {
                        console.log('[INDEX] notification suppressed ->', notificationType, message);
                    } catch (e) {}
                    return;
                }

                switch (notificationType) {
                    case 'success':
                        showSuccess(message, duration);
                        break;
                    case 'error':
                        showError(message, duration);
                        break;
                    case 'warning':
                        showWarning(message, duration);
                        break;
                    case 'info':
                        showInfo(message, duration);
                        break;
                    default:
                        showNotification(message, notificationType, duration);
                }
            }
        }

        // ===================================
        // åˆå§‹åŒ–
        // ===================================

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            updateLayout();
            initResizing();

            // åŠ è½½æ‰€æœ‰é¢æ¿å†…å®¹
            Object.keys(PAGE_CONFIG).forEach(panelName => {
                loadPanelContent(panelName);
            });

            // ç›‘å¬æ¥è‡ªå­é¡µé¢çš„æ¶ˆæ¯
            window.addEventListener('message', handleNotificationMessage);
            // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ”¶åˆ°çš„åŸå§‹ messageï¼Œä¾¿äºæ’æŸ¥ mindmap -> index -> editor çš„æ¶ˆæ¯æµ
            window.addEventListener('message', function (e) {
                try { console.log('[INDEX RAW MESSAGE]', e && e.data); } catch (err) {}
            }, { passive: true });

            console.log('ğŸ“Œ Markdown Studio å·²åˆå§‹åŒ–');
            console.log('é…ç½®ä¿¡æ¯:', PAGE_CONFIG);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // åœ¨ç§»åŠ¨ç«¯åˆ›å»ºåº•éƒ¨ tabsï¼šå…‹éš† header .tabs åˆ° mobile-tabsï¼ˆä¿æŒäº‹ä»¶ç»‘å®šï¼‰
        function createMobileTabs() {
            try {
                const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
                const headerTabs = document.querySelector('.header .tabs');
                const mobileContainer = document.getElementById('mobile-tabs');
                if (!headerTabs || !mobileContainer) return;

                // æ¸…ç©ºå¹¶å…‹éš†
                mobileContainer.innerHTML = '';
                headerTabs.querySelectorAll('.tab[data-panel]').forEach(tab => {
                    const panel = tab.dataset.panel;
                    const clone = tab.cloneNode(true);
                    clone.classList.remove('active');
                    clone.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleTabClick(panel);
                        // è§†è§‰åé¦ˆ
                        document.querySelectorAll('.mobile-tabs .tab').forEach(t => t.classList.remove('active'));
                        clone.classList.add('active');
                    });
                    mobileContainer.appendChild(clone);
                });

                // æ˜¾ç¤º/éšè—ä¸ focusMode çŠ¶æ€åŒæ­¥
                if (isMobile) {
                    mobileContainer.setAttribute('aria-hidden', 'false');
                    mobileContainer.style.display = 'flex';
                } else {
                    mobileContainer.setAttribute('aria-hidden', 'true');
                    mobileContainer.style.display = 'none';
                }

                // åŒæ­¥æ¿€æ´»çŠ¶æ€
                updateTabs();
            } catch (e) {
                console.warn('createMobileTabs error', e);
            }
        }

        // å½“çª—å£å°ºå¯¸å˜åŒ–æ—¶åŒæ­¥ mobile tabs
        window.addEventListener('resize', () => {
            // debounce ç®€å•å®ç°
            clearTimeout(window._mobileTabsResizeTimer);
            window._mobileTabsResizeTimer = setTimeout(() => createMobileTabs(), 120);
        });

        // åœ¨ initApp ä¸­ä¹Ÿè°ƒç”¨ä¸€æ¬¡ï¼ˆåœ¨ DOMContentLoaded ä¹‹åï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            createMobileTabs();
        });
    </script>
</body>
</html>

</html>