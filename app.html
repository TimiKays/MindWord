<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindWord</title>
    <link rel="stylesheet" href="styles.css">
    <!-- å›½é™…åŒ–æ”¯æŒ -->
    <script src="i18n/locales.js"></script>
    <script src="i18n/i18n-manager.js"></script>
    <!-- Bootstrap CSS for notifications -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <style>
        /* å®Œå…¨åŒ¹é…ä½ è´´å‡ºçš„æŒ‰é’®ç»„å¤–è§‚ï¼ˆé Tailwind å®ç°ï¼‰ */
        .tabs {
            display: flex;
            align-items: center;
            gap: 6px;
            /* ç­‰åŒäº tailwind çš„ gap-4 */
            border-radius: 8px;
            padding: 4px;
            /* p-1 */
            background-color: rgba(0, 0, 0, 0.05);
            /* bg-black/5 */
            /* æ·±è‰²æ¨¡å¼å¯è‡ªè¡Œæ‰©å±•ï¼Œå¦‚æœéœ€è¦æˆ‘å¯ä»¥åŠ  media-query æˆ– .dark å‰ç¼€ */
            font-size: 14px;
            /* text-sm */
            font-weight: 500;
            /* font-medium */
            width: fit-content;
            box-sizing: border-box;
            flex: 0 0 auto;
        }

        /* æ¯ä¸ª tab è§†è§‰ç­‰åŒäºä½ ç»™çš„ button */
        .tab {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            /* ç­‰åŒäº gap-2 */
            padding: 6px 12px;
            /* py-1.5 px-3 */
            border-radius: 6px;
            /* rounded-md */
            cursor: pointer;
            transition: color 0.15s ease, background-color 0.15s ease;
            color: #6b7280;
            /* text-gray-500 */
            background: transparent;
            box-shadow: none;
            white-space: nowrap;
            line-height: 1;
        }

        /* éæ¿€æ´» hover ä»…æ”¹å˜æ–‡å­—é¢œè‰²ï¼ˆä¸ç¤ºä¾‹ä¸€è‡´ï¼‰ */
        .tab:not(.active):hover {
            color: #101922;
            /* hover:text-[#101922] */
        }

        /* æ¿€æ´»é¡¹ï¼šç™½åº•ã€æ·±è‰²æ–‡å­—ã€è½»é˜´å½± */
        .tab.active {
            background: #ffffff;
            color: #101922;
            /* text-[#101922] */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            /* shadow-sm é£æ ¼ */
        }

        /* å›¾æ ‡ï¼šå¦‚æœæ˜¯ SVG æ§åˆ¶å¤§å°/å¡«å……ï¼›å¦‚æœæ˜¯ font iconï¼ˆmaterial symbolsï¼‰ä¹Ÿèƒ½å…¼å®¹ */
        .tab svg,
        .tab .icon,
        .tab .material-symbols-outlined {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            flex: 0 0 16px;
        }

        /* å¦‚æœä½¿ç”¨ SVGï¼Œæ§åˆ¶ fillï¼›font icon ä½¿ç”¨ color */
        .tab svg {
            fill: currentColor;
        }

        .tab .icon {
            fill: currentColor;
        }

        /* æ¿€æ´»/éæ¿€æ´»é¢œè‰²é€šè¿‡ colorï¼ˆcurrentColorï¼‰å˜åŒ–å³å¯ */
        .tab:not(.active) svg,
        .tab:not(.active) .icon {
            opacity: 0.85;
            color: #6b7280;
        }

        .tab.active svg,
        .tab.active .icon {
            color: #101922;
            opacity: 1;
        }

        /* æ–‡æœ¬ */
        .tab>span {
            font-size: 14px;
            font-weight: 500;
            line-height: 16px;
            color: inherit;
            /* ç»§æ‰¿ currentColor */
        }

        /* emoji çš„å°ºå¯¸ä¸å›¾æ ‡ä¸€è‡´ */
        .tab>.emoji,
        .tab>.emj {
            font-size: 16px;
            line-height: 16px;
            display: inline-block;
        }

        /* å¯è®¿é—®çš„ç„¦ç‚¹ç¯ï¼ˆè½»é‡ï¼‰ */
        .tab:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(16, 25, 34, 0.08);
        }

        /* åœ¨å°å±æ—¶ï¼Œå¦‚æœéœ€è¦å…‹éš†åˆ°åº•éƒ¨ï¼Œä¿æŒéšè—/æ˜¾ç¤ºé€»è¾‘ä¸å˜ï¼ˆJS æ§åˆ¶ show/hideï¼‰ */
        .mobile-tabs {
            display: none;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .header .tabs {
                display: none;
            }

            .mobile-tabs {
                display: flex;
                position: fixed;
                bottom: 8px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 999;
                gap: 8px;
            }

            /* ç§»åŠ¨ç«¯æ±‰å ¡å›¾æ ‡å±…ä¸­è°ƒæ•´ */
            #doc-menu-btn {
                top: 10px !important;
                /* transform: translateY(-50%); */
                left: 12px;
            }

            /* LOGOå‘å³ç§»åŠ¨ */
            .header .brand {
                margin-left: 25px !important;
            }

            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºè®¤è¯åŒºåŸŸ */
            .header-right {
                display: flex !important;
                align-items: center;
                margin-left: auto;
                margin-right: 8px;
            }

            /* ç§»åŠ¨ç«¯è®¤è¯åŒºåŸŸæ ·å¼è°ƒæ•´ */
            #auth-area {
                margin-left: 8px !important;
                margin-right: 0 !important;
            }

            #auth-link,
            #auth-user {
                height: 32px !important;
                font-size: 11px !important;
                padding: 0 8px !important;
            }

            #auth-username {
            font-size: 11px !important;
            max-width: 60px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        #auth-logout {
            height: 32px !important;
            font-size: 11px !important;
            padding: 0 8px !important;
        }

        /* ä¸ªäººèœå•ä¸‹æ‹‰æ ·å¼ */
        .user-dropdown {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .user-dropdown:hover {
            background-color: #f8fafc;
        }

        .dropdown-arrow {
            margin-left: 4px;
            font-size: 12px;
            transition: transform 0.2s;
            color: #64748b;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            min-width: 240px;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            background-color: #f8fafc;
            border-radius: 8px 8px 0 0;
        }

        .menu-username {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .menu-email {
            font-size: 13px;
            color: #64748b;
        }

        .menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f8fafc;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #374151;
        }

        .menu-item:hover {
            background-color: #f8fafc;
        }

        .menu-item:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }

        .menu-item.danger {
            color: #dc2626;
        }

        .menu-item.danger:hover {
            background-color: #fef2f2;
        }

        .menu-icon {
            margin-right: 10px;
            width: 16px;
            text-align: center;
            color: #64748b;
        }

            /* ä¸ªäººèœå•ç§»åŠ¨ç«¯æ ·å¼ */
            .user-dropdown {
                padding: 4px 8px !important;
            }
            
            .user-menu-dropdown {
                top: 32px !important;
                right: 0 !important;
                min-width: 200px !important;
                max-width: 240px !important;
            }
            
            .menu-header {
                padding: 8px 12px !important;
            }
            
            .menu-username {
                font-size: 14px !important;
            }
            
            .menu-email {
                font-size: 11px !important;
            }
            
            .menu-item {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }
        }
    </style>
    <!-- ZIP æ‰“åŒ…ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <!-- LeanCloud SDKï¼ˆä»…å‰ç«¯ AppID/AppKeyï¼Œåˆ‡å‹¿ä½¿ç”¨ Master Keyï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
</head>

<body>
    <!-- æ–‡æ¡£ä¾§æ è§¦å‘æŒ‰é’®ä¸ä¾§æ  -->
    <style>
        #doc-menu-btn {
            position: fixed;
            top: 17px;
            left: 15px;
            z-index: 10000;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #111827;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        #doc-menu-btn:hover {
            background: #f8fafc;
        }

        #doc-sidebar {
            position: fixed;
            top: 68px;
            left: 0;
            width: 560px;
            max-width: 80vw;
            height: calc(100vh - 68px);
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 10000;
            transform: translateX(-100%);
            transition: transform 0.22s ease;
            display: flex;
            flex-direction: column;
        }

        #doc-sidebar.open {
            transform: translateX(0);
        }

        #doc-sidebar .side-header {
            padding: 10px 12px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
        }

        #doc-sidebar .side-header .title {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 8px;
        }

        #doc-sidebar .side-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        #doc-sidebar .side-header .title {
            font-weight: 600;
            color: #0f172a;
        }

        #doc-sidebar .side-actions {
            display: flex;
            gap: 6px;
            padding-right: 40px;
            /* ä¸ºå…³é—­æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        #doc-sidebar .side-actions button {
            height: 28px;
            padding: 0 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #334155;
            cursor: pointer;
            font-size: 12px;
        }

        #doc-sidebar .side-actions button:hover {
            background: #f8fafc;
        }

        /* ä¾§æ»‘æ å³ä¸Šè§’å…³é—­æŒ‰é’® */
        #btn-close-sidebar {
            position: absolute;
            top: 8px;
            right: 12px;
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        #btn-close-sidebar:hover {
            background: #f1f5f9;
            color: #475569;
        }

        #doc-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .doc-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border: 1px solid #f1f5f9;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fff;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease;
        }

        .doc-item:hover {
            background-color: #f8fafc;
            border-color: #e2e8f0;
        }

        .doc-item.active {
            background-color: #e0f2fe;
            border-color: #0ea5e9;
            border-left: 3px solid #0ea5e9;
        }

        .doc-name {
            font-size: 13px;
            color: #0f172a;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 300px;
        }

        .doc-buttons {
            display: flex;
            gap: 6px;
        }

        .doc-buttons button {
            height: 24px;
            padding: 0 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: #fff;
            color: #334155;
            font-size: 12px;
            cursor: pointer;
        }

        .doc-buttons button:hover {
            background: #f8fafc;
        }

        .side-footer {
            border-top: 1px solid #f1f5f9;
            padding: 8px;
            display: flex;
            gap: 6px;
        }

        .side-footer input[type="file"] {
            display: none;
        }
    </style>

    <button id="doc-menu-btn" title="æ–‡æ¡£åˆ—è¡¨">
        <span style="display:inline-block;width:16px;height:12px;">
            <span style="display:block;height:2px;background:#0f172a;border-radius:2px;"></span>
            <span style="display:block;height:2px;background:#0f172a;border-radius:2px;margin-top:3px;"></span>
            <span style="display:block;height:2px;background:#0f172a;border-radius:2px;margin-top:3px;"></span>
        </span>
    </button>

    <aside id="doc-sidebar" aria-hidden="true">
        <div class="side-header">
            <div class="title" data-i18n="docs.myDocuments">æˆ‘çš„æ–‡æ¡£</div>
            <div class="side-actions">
                <button id="btn-new-doc" data-i18n="docs.newDoc">æ–°å¢</button>
                <button id="btn-export-all" data-i18n="docs.exportAllZip">å…¨éƒ¨å¯¼å‡ºZIP</button>
                <label for="import-zip-input"><button id="btn-import-zip" data-i18n="docs.importZip">å¯¼å…¥ZIP</button></label>
                <button id="btn-sync-cloud" title="é¢„ç•™" style="display:none;">äº‘åŒæ­¥</button>
                <button id="btn-clear-data" style="background-color: #e74c3c; color: white;"
                    title="æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®" data-i18n="docs.clearData">æ¸…ç©ºæ•°æ®</button>
            </div>
            <button id="btn-close-sidebar" title="å…³é—­">&times;</button>
        </div>
        <div id="doc-list"></div>
        <div class="side-footer">
            <input id="import-zip-input" type="file" accept=".zip" />
        </div>
    </aside>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="brand"
            style="font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin-left: 50;   font-weight:700; font-size:26px; display:flex; align-items:center;">
            <span class="brand-clickable"
                style="background: linear-gradient(0deg,#0b82e4 0%,#11c49d 100%); -webkit-background-clip: text; background-clip: text; color: transparent;  cursor: pointer;"
                onclick="window.location.href='index.html'" title="è¿”å›é¦–é¡µ">
                <img src="favicon.ico" alt="favicon"
                    style="width:32px;height:32px;vertical-align:middle;margin-right:8px;">
                MindWord
            </span>
        </div>
        <div class="tabs">
            <div class="tab active" data-panel="editor" style="font-size:14px;"><svg t="1759394685575" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1342">
                    <path
                        d="M527.37066667 90.6976v62.41493333a7.8016 7.8016 0 0 1-7.80266667 7.8016H199.92426667a39.00906667 39.00906667 0 0 0-38.38613334 31.98826667l-0.624 7.02186667V824.07466667a39.00906667 39.00906667 0 0 0 31.98826667 38.38613333l7.02186667 0.624H824.07466667a39.00906667 39.00906667 0 0 0 38.38613333-31.98826667l0.624-7.02186666v-338.60266667a7.8016 7.8016 0 0 1 7.8016-7.8016h62.41493333a7.8016 7.8016 0 0 1 7.80266667 7.8016v338.60266667a117.02826667 117.02826667 0 0 1-105.79413333 116.4832l-11.2352 0.54613333H199.92533333a117.02826667 117.02826667 0 0 1-116.4832-105.79413333l-0.54613333-11.2352V199.92533333a117.02826667 117.02826667 0 0 1 105.79413333-116.4832l11.2352-0.54613333h319.64373334a7.8016 7.8016 0 0 1 7.8016 7.80266667z m327.83466666 33.93813333l44.16 44.15893334a7.8016 7.8016 0 0 1 0 11.00053333L413.85066667 665.30773333a7.8016 7.8016 0 0 1-11.00053334 0l-44.15893333-44.16a7.8016 7.8016 0 0 1 0-10.99946666l485.51253333-485.51253334a7.8016 7.8016 0 0 1 11.00053334 0z"
                        p-id="1343"></path>
                </svg>


                <span data-i18n="app.editor">æ–‡æœ¬ç¼–è¾‘</span>
            </div>
            <div class="tab active" data-panel="preview" style="font-size:14px;"><svg t="1759394709317" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1495">
                    <path
                        d="M648.101506 803.835981a35.839821 35.839821 0 0 0-35.839821-35.839821H291.836621a35.839821 35.839821 0 1 0 0 72.106306h319.9984a35.839821 35.839821 0 0 0 36.266485-36.266485z m127.99936-159.9992a35.839821 35.839821 0 0 0-35.839821-35.839821H291.836621a35.839821 35.839821 0 1 0 0 72.106306h447.99776a35.839821 35.839821 0 0 0 36.266485-36.266485z m-191.99904-159.9992a35.839821 35.839821 0 0 0-35.839821-35.839821h-255.99872a35.839821 35.839821 0 1 0 0 72.106306h255.99872a35.839821 35.839821 0 0 0 35.839821-36.266485z m238.932139 469.330986H200.103746V72.106306H511.99552v239.785468A72.959635 72.959635 0 0 0 584.101826 383.99808h238.932139zM582.821833 110.506114l200.958995 201.812324h-200.958995z m291.83854 191.145711L597.328427 21.333227a76.799616 76.799616 0 0 0-14.506594-11.519943l-4.266646-2.133322h-2.986652A71.679642 71.679642 0 0 0 546.128683 0H200.957075A72.959635 72.959635 0 0 0 127.99744 72.106306v879.782268A72.959635 72.959635 0 0 0 200.957075 1023.99488h622.930219A71.252977 71.252977 0 0 0 895.9936 951.888574V352.424905a71.252977 71.252977 0 0 0-21.333227-50.77308z"
                        fill="#5E5C5C" p-id="1496"></path>
                </svg>
                <span data-i18n="app.preview">æ–‡æ¡£é¢„è§ˆ</span>
            </div>
            <div class="tab active" data-panel="mindmap" style="font-size:14px;"><svg t="1759394646816" class="icon"
                    viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1189">
                    <path
                        d="M911.45752364 467.61583017a44.38416983 44.38416983 0 0 1 0 88.76833966h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833966h355.07335381z m0 310.68918518a44.38416983 44.38416983 0 0 1 0 88.76833967h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833967h355.07335381z m0-621.37837037a44.38416983 44.38416983 0 0 1 0 88.76833967h-355.07335381a44.38416983 44.38416983 0 0 1 0-88.76833967h355.07335381zM112.54247636 556.38416983l-5.90309451-0.31068918C53.42276267 550.34792194 55.42004994 467.61583017 112.54247636 467.61583017h88.76833846c23.16853673 0 32.22290674-18.59696746 44.91677969-101.06275248 1.50906228-9.85328541 2.21920795-14.64677535 3.10689185-19.97287637 17.13228883-107.72037874 42.60880202-163.06743857 115.48760837-187.38996353a44.38416983 44.38416983 0 0 1 28.05079518 84.24115405c-29.6042411 9.85328541-43.7184066 40.5671311-55.92405333 117.08543795l-3.01812334 19.52903502c-4.83787481 31.46837621-9.98643758 58.18764614-16.42214316 80.60165113L315.37812943 467.61583017H378.84749172a44.38416983 44.38416983 0 0 1 44.07348064 39.19122219L423.23166155 512a44.38416983 44.38416983 0 0 1-44.38416983 44.38416983H315.42251429l2.13043943 6.96831423c5.59240533 19.61780231 10.20835946 42.52003472 14.55800806 69.01738277l1.81975146 11.53988471 3.06250699 19.57341867c12.16126188 76.51830806 26.27542858 107.23215254 55.92405334 117.08543795a44.38416983 44.38416983 0 1 1-28.09517884 84.24115405c-72.92319001-24.32252496-98.35531954-79.66958356-115.48760837-187.38996353-0.8876839-5.3260998-1.59782958-10.11959094-3.10689185-19.97287637C233.53372157 575.02552095 224.47935154 556.38416983 201.31081482 556.38416983H112.54247636z"
                        fill="#000000" fill-opacity=".65" p-id="1190"></path>
                </svg>

                <span data-i18n="app.mindmap">æ€ç»´å¯¼å›¾</span>
            </div>

        </div>
        <button class="btn btn-small" id="focus-toggle" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;">
            <div class="focus-icon"></div>
            <span data-i18n="app.focus">ä¸“æ³¨</span>
        </button>
        <div class="header-right">
            <!-- è´¦å·åŒºï¼šæœªç™»å½•æ˜¾ç¤º"æ³¨å†Œ/ç™»å½•"ï¼Œå·²ç™»å½•æ˜¾ç¤º"ç”¨æˆ·å/é€€å‡ºç™»å½•" -->
            <div id="auth-area" style="display:inline-flex; align-items:center; gap:8px; margin-left:10px;">
                <!-- è¯­è¨€åˆ‡æ¢ -->
                <select id="lang-switch" title="Language" onchange="window.i18nManager.setLanguage(this.value)"
                    style="height:30px; border:1px solid #e2e8f0; border-radius:6px; background:#fff; color:#334155; font-size:12px; padding:0 8px;">
                    <option value="zh" >ä¸­æ–‡</option>
                    <option value="en" >EN</option>
                </select>
                <a id="auth-link" href="auth.html"
                    style="display:inline-flex; align-items:center; height:30px; padding:0 10px; border:1px solid #e2e8f0; border-radius:6px; background:#fff; color:#334155; text-decoration:none; font-size:12px; cursor:pointer;"
                    data-i18n="docs.registerLogin">
                    æ³¨å†Œ/ç™»å½•
                </a>
                <div id="auth-user" style="display:none; align-items:center; gap:8px; position: relative;">
                    <div class="user-dropdown" style="display:flex; align-items:center; gap:4px; cursor: pointer; position: relative;">
                        <span id="auth-username" style="font-size:12px; color:#334155;"></span>
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s ease;">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </div>
                    
                    <!-- ä¸ªäººèœå•ä¸‹æ‹‰é¢æ¿ -->
                    <div class="user-menu-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 200px; z-index: 1000;">
                        <div class="user-menu-header" style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9;">
                            <div style="font-size: 14px; font-weight: 600; color: #1e293b;" id="menu-username"></div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 2px;" data-i18n="docs.personalAccount">ä¸ªäººè´¦æˆ·</div>
                        </div>
                        
                        <div class="user-menu-items" style="padding: 8px 0;">
                            <!-- äº‘åŒæ­¥æ§åˆ¶åŒºï¼ˆè‹±æ–‡ï¼‰ï¼šCloudflare Worker æ–¹æ¡ˆ -->
                            <div class="menu-item" id="cloud-sync-controls-menu" style="display:flex; align-items:center; gap:8px; padding: 8px 16px; cursor: pointer; transition: background-color 0.15s ease;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: #374151;" data-i18n="cloud.backupTitle">äº‘åŒæ­¥</div>
                                    <div style="font-size: 11px; color: #9ca3af;" id="cloud-sync-status-menu" data-i18n="docs.bidirectionalSync">åŒå‘åŒæ­¥ä¸ºæœ€æ–°</div>
                                </div>
                                <button id="cloud-sync-sync-btn-menu" class="btn btn-small" style="height:24px; font-size:11px; padding: 0 8px;" data-i18n="cloud.sync">åŒæ­¥</button>
                            </div>
                            
                            <!-- äº‘åŒæ­¥æ§åˆ¶åŒºï¼ˆä¸­æ–‡ï¼‰ï¼šLeanCloud Data æ–¹æ¡ˆ -->
                            <div class="menu-item" id="lc-sync-controls-menu" style="display:none; align-items:center; gap:8px; padding: 8px 16px; cursor: pointer; transition: background-color 0.15s ease;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: #374151;" data-i18n="cloud.backupTitle">äº‘åŒæ­¥</div>
                                    <div style="font-size: 11px; color: #9ca3af;" id="lc-sync-status-menu" data-i18n="docs.oneClickSync">ä¸€é”®åŒæ­¥</div>
                                </div>
                                <button id="lc-sync-btn-menu" class="btn btn-small" style="height:24px; font-size:11px; padding: 0 8px;">åŒæ­¥</button>
                            </div>
                            
                            <div class="menu-item" style="display:flex; align-items:center; gap:8px; padding: 8px 16px; cursor: pointer; transition: background-color 0.15s ease;" onclick="document.getElementById('lc-clear-btn-menu').click();">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14M10 11v6M14 11v6"/>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; color: #374151;" data-i18n="docs.clearCloudData">æ¸…ç©ºäº‘æ•°æ®</div>
                                    <div style="font-size: 11px; color: #9ca3af;" data-i18n="docs.deleteAllCloudBackups">åˆ é™¤æ‰€æœ‰äº‘ç«¯å¤‡ä»½</div>
                                </div>
                                <button id="lc-clear-btn-menu" class="btn btn-small" style="height:24px; font-size:11px; padding: 0 8px; background:#e74c3c; color:#fff;" data-i18n="cloud.clear">æ¸…ç©º</button>
                            </div>
                            
                            <div class="menu-divider" style="height: 1px; background: #f1f5f9; margin: 8px 0;"></div>
                            
                            <div class="menu-item" style="display:flex; align-items:center; gap:8px; padding: 8px 16px; cursor: pointer; transition: background-color 0.15s ease;" onclick="document.getElementById('auth-logout-menu').click();">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>
                                </svg>
                                <div style="font-size: 13px; color: #dc2626;" data-i18n="auth.logout">é€€å‡ºç™»å½•</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- éšè—çš„é€€å‡ºç™»å½•æŒ‰é’®ï¼ˆç”¨äºèœå•è°ƒç”¨ï¼‰ -->
                    <button id="auth-logout-menu" style="display:none;"></button>
                    
                    <!-- äº‘åŒæ­¥å¼¹çª—ï¼ˆè‹±æ–‡æ–¹æ¡ˆä½¿ç”¨ï¼‰ -->
                    <div id="cloud-sync-modal"
                        style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                        <div
                            style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 420px; width: 90%;">
                            <h3 style="margin: 0 0 10px 0; color: #333;" data-i18n="cloud.backupTitle">äº‘å¤‡ä»½</h3>
                            <div style="font-size: 13px; color: #555; margin-bottom: 12px;">
                                <div>æœ€æ–°å¤‡ä»½æ—¶é—´ï¼š<span id="cloud-sync-latest-time">â€”</span></div>
                                <div>å·²å¤‡ä»½æ–‡ä»¶æ•°ï¼š<span id="cloud-sync-file-count">â€”</span></div>
                                <div>æ€»ä½“å¤§å°ï¼š<span id="cloud-sync-total-size">â€”</span></div>
                                <div style="color:#888; margin-top:6px;" data-i18n="cloud.capacityLimit">å®¹é‡ä¸Šé™ï¼šæ¯ç”¨æˆ· 10MBï¼ˆä»…ä¿ç•™æœ€æ–°ä¸€ä»½ï¼‰</div>
                            </div>
                            <div style="display:flex; gap:8px; justify-content:flex-end;">
                                <button id="cloud-sync-modal-sync" class="btn btn-small" style="height:30px;" data-i18n="cloud.sync">ä¸€é”®åŒæ­¥</button>
                                <button id="cloud-sync-modal-clear" class="btn btn-small"
                                    style="height:30px; background:#e74c3c; color:#fff;" data-i18n="cloud.clear">æ¸…ç©ºå¤‡ä»½</button>
                                <button id="cloud-sync-modal-close" class="btn btn-small" style="height:30px;" data-i18n="cloud.close">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äº‘åŒæ­¥å¼¹çª—ï¼ˆè‹±æ–‡æ–¹æ¡ˆä½¿ç”¨ï¼‰ -->
                <div id="cloud-sync-modal"
                    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
                    <div
                        style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 420px; width: 90%;">
                        <h3 style="margin: 0 0 10px 0; color: #333;">äº‘å¤‡ä»½</h3>
                        <div style="font-size: 13px; color: #555; margin-bottom: 12px;">
                            <div><span data-i18n="cloud.latestBackup">æœ€æ–°å¤‡ä»½æ—¶é—´</span>ï¼š<span id="cloud-sync-latest-time">â€”</span></div>
                            <div><span data-i18n="cloud.fileCount">å·²å¤‡ä»½æ–‡ä»¶æ•°</span>ï¼š<span id="cloud-sync-file-count">â€”</span></div>
                            <div><span data-i18n="cloud.totalSize">æ€»ä½“å¤§å°</span>ï¼š<span id="cloud-sync-total-size">â€”</span></div>
                            <div style="color:#888; margin-top:6px;"><span data-i18n="cloud.capacityLimit">å®¹é‡ä¸Šé™ï¼šæ¯ç”¨æˆ· 10MBï¼ˆä»…ä¿ç•™æœ€æ–°ä¸€ä»½ï¼‰</span></div>
                        </div>
                        <div style="display:flex; gap:8px; justify-content:flex-end;">
                            <button id="cloud-sync-modal-sync" class="btn btn-small" style="height:30px;" data-i18n="docs.oneClickSync">ä¸€é”®åŒæ­¥</button>
                            <button id="cloud-sync-modal-clear" class="btn btn-small"
                                style="height:30px; background:#e74c3c; color:#fff;" data-i18n="cloud.clear">æ¸…ç©ºå¤‡ä»½</button>
                            <button id="cloud-sync-modal-close" class="btn btn-small" style="height:30px;" data-i18n="cloud.close">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨ Tabs å®¹å™¨ï¼ˆJS ä¼šåœ¨ç§»åŠ¨ç«¯å°†é¡¶éƒ¨ tabs å…‹éš†åˆ°è¿™é‡Œï¼‰ -->
    <div id="mobile-tabs" class="mobile-tabs" aria-hidden="true"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="main-content">
        <!-- ä¸“æ³¨æ¨¡å¼æç¤º -->
        <div class="focus-indicator"><span data-i18n="app.focus">ä¸“æ³¨</span></div>

        <!-- MDç¼–è¾‘é¢æ¿ -->
        <div class="panel editor-panel" id="editor-panel">
            <div class="panel-header">
                <span data-i18n="app.editor">Markdown ç¼–è¾‘å™¨</span>
                <button class="btn btn-icon" onclick="togglePanel('editor')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="editor-placeholder">
                    <div class="loading"><span data-i18n="app.loading">æ­£åœ¨åŠ è½½ç¼–è¾‘å™¨</span></div>
                    <small><span data-i18n="app.address">åœ°å€</span>: <span id="editor-url" data-i18n="app.notConfigured">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡1 -->
        <div class="resizer" id="resizer1"></div>

        <!-- MDé¢„è§ˆé¢æ¿ -->
        <div class="panel preview-panel" id="preview-panel">
            <div class="panel-header">
                <span data-i18n="app.preview">Markdown é¢„è§ˆ</span>
                <button class="btn btn-icon" onclick="togglePanel('preview')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="preview-placeholder">
                    <div class="loading"><span data-i18n="app.loading">æ­£åœ¨åŠ è½½é¢„è§ˆ</span></div>
                    <small><span data-i18n="app.address">åœ°å€</span>: <span id="preview-url" data-i18n="app.notConfigured">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>

        <!-- åˆ†éš”æ¡2 -->
        <div class="resizer" id="resizer2"></div>

        <!-- æ€ç»´å¯¼å›¾é¢æ¿ -->
        <div class="panel mindmap-panel" id="mindmap-panel">
            <div class="panel-header">
                <span data-i18n="app.mindmap">æ€ç»´å¯¼å›¾</span>
                <button class="btn btn-icon" onclick="togglePanel('mindmap')">&times;</button>
            </div>
            <div class="panel-content">
                <div class="placeholder" id="mindmap-placeholder">
                    <div class="loading"><span data-i18n="app.loading">æ­£åœ¨åŠ è½½æ€ç»´å¯¼å›¾</span></div>
                    <small><span data-i18n="app.address">åœ°å€</span>: <span id="mindmap-url" data-i18n="app.notConfigured">æœªé…ç½®</span></small>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS for notifications -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================================
        // ğŸ“Œ é¡µé¢é…ç½® - åœ¨è¿™é‡Œä¿®æ”¹ä¸‰ä¸ªé¡µé¢çš„åœ°å€
        // ===================================
        const PAGE_CONFIG = {
            // Markdown ç¼–è¾‘å™¨é¡µé¢åœ°å€
            editor: {
                url: 'editor/editor.html', // å¡«å…¥æ‚¨çš„ç¼–è¾‘å™¨é¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/editor.html'
                title: 'Markdown ç¼–è¾‘å™¨'
            },

            // Markdown é¢„è§ˆé¡µé¢åœ°å€
            preview: {
                url: 'md2word/md2word.html', // å¡«å…¥æ‚¨çš„é¢„è§ˆé¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/preview.html'
                title: 'Markdown é¢„è§ˆ'
            },

            // æ€ç»´å¯¼å›¾é¡µé¢åœ°å€
            mindmap: {
                url: 'jsmind/mindmap.html', // å¡«å…¥æ‚¨çš„æ€ç»´å¯¼å›¾é¡µé¢åœ°å€ï¼Œä¾‹å¦‚: 'https://your-domain.com/mindmap.html'
                title: 'æ€ç»´å¯¼å›¾'
            }
        };

        // ===================================
        // åº”ç”¨çŠ¶æ€ç®¡ç†
        // ===================================

        // é¢æ¿çŠ¶æ€ç®¡ç†
        const panels = {
            editor: true,
            preview: true,
            mindmap: true
        };

        // ä¸“æ³¨æ¨¡å¼çŠ¶æ€
        let focusMode = false;
        let activeFocusPanel = 'editor';

        // çŠ¶æ€å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            focusMode: 'mindword_focus_mode',
            activeFocusPanel: 'mindword_active_focus_panel',
            panels: 'mindword_panels_state'
        };

        // æ‹–æ‹½çŠ¶æ€ - ä¼˜åŒ–åçš„çŠ¶æ€ç®¡ç†
        let dragState = {
            isDragging: false,
            currentResizer: null,
            startX: 0,
            currentX: 0,
            leftPanel: null,
            rightPanel: null,
            startLeftWidth: 0,
            startRightWidth: 0,
            containerWidth: 0,
            animationId: null
        };

        // ===================================
        // é¡µé¢åŠ è½½åŠŸèƒ½
        // ===================================

        // åŠ è½½iframeå†…å®¹ï¼ˆæ”¹è¿›ï¼šæ ‡è¯† iframeï¼Œonload åå‘å­é¡µè¯·æ±‚é‡æ’ï¼‰
        function loadPanelContent(panelName) {
            const config = PAGE_CONFIG[panelName];
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const placeholder = document.getElementById(`${panelName}-placeholder`);
            const urlSpan = document.getElementById(`${panelName}-url`);

            // æ›´æ–°URLæ˜¾ç¤º
            urlSpan.textContent = config.url || 'æœªé…ç½®';

            if (!config.url) {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">âš ï¸ <span data-i18n="errors.pageNotConfigured">é¡µé¢åœ°å€æœªé…ç½®</span></div>
                    <small><span data-i18n="errors.setPageAddress">è¯·åœ¨ PAGE_CONFIG.${panelName}.url ä¸­è®¾ç½®é¡µé¢åœ°å€</span></small>
                `;
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰iframe
            const existingIframe = panelContent.querySelector('iframe');
            if (existingIframe) {
                return;
            }

            // åˆ›å»ºiframe
            const iframe = document.createElement('iframe');
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            iframe.src = config.url + (config.url.includes('?') ? '&' : '?') + '_t=' + timestamp;

            // æ ‡è¯† iframe ä¾¿äºåç»­é€‰æ‹©ä¸æ¶ˆæ¯è½¬å‘
            iframe.dataset.panel = panelName;
            iframe.id = `iframe-${panelName}`;

            // æ ·å¼ï¼šç¡®ä¿å æ»¡é¢æ¿å†…å®¹
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.backgroundColor = 'white';
            iframe.style.display = 'none';

            // åŠ è½½æˆåŠŸåæ˜¾ç¤ºå¹¶è¯·æ±‚å­é¡µé‡æ’ï¼ˆç«‹å³+çŸ­å»¶è¿Ÿï¼‰
            iframe.onload = function () {
                placeholder.style.display = 'none';
                iframe.style.display = 'block';

                // è¯·æ±‚å­é¡µé‡æ’ï¼Œé˜²æ­¢é¦–æ¬¡æ¸²æŸ“æ—¶å°ºå¯¸æœªå°±ç»ª
                try {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                        setTimeout(() => {
                            try { iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*'); } catch (e) { }
                        }, 200);
                        // è‹¥å­˜åœ¨å¾…å‘é€çš„markdown/æ–‡æ¡£ï¼Œåœ¨iframeå°±ç»ªåç«‹åˆ»å‘é€ï¼Œç¡®ä¿â€œå³ç‚¹å³åˆ‡â€
                        try {
                            if (panelName === 'editor' && window.__mw_pendingEditorDocument) {
                                iframe.contentWindow.postMessage({ type: 'mw_load_document', payload: window.__mw_pendingEditorDocument }, '*');
                                window.__mw_pendingEditorDocument = null;
                            }
                            if (panelName === 'preview' && window.__mw_pendingPreviewMarkdown) {
                                iframe.contentWindow.postMessage({ type: 'mw_load_markdown', payload: window.__mw_pendingPreviewMarkdown }, '*');
                                window.__mw_pendingPreviewMarkdown = null;
                            }
                            if (panelName === 'mindmap' && window.__mw_pendingMindmapMarkdown) {
                                iframe.contentWindow.postMessage({ type: 'mw_load_markdown', payload: window.__mw_pendingMindmapMarkdown }, '*');
                                window.__mw_pendingMindmapMarkdown = null;
                            }
                        } catch (e) { /* ignore */ }
                    }
                } catch (e) { console.warn('postMessage to iframe failed', e); }
            };

            iframe.onerror = function () {
                placeholder.innerHTML = `
                    <div style="color: #e74c3c;">âŒ <span data-i18n="errors.pageLoadFailed">é¡µé¢åŠ è½½å¤±è´¥</span></div>
                    <small><span data-i18n="app.address">åœ°å€</span>: ${config.url}</small>
                    <br>
                    <button onclick="retryLoad('${panelName}')" style="margin-top: 10px; padding: 5px 10px; border: 1px solid #3498db; background: white; color: #3498db; border-radius: 4px; cursor: pointer;"><span data-i18n="errors.retry">é‡è¯•</span></button>
                `;
            };

            panelContent.appendChild(iframe);

            // åœ¨çˆ¶é¡µçª—å£å°ºå¯¸å˜åŒ–æ—¶ï¼Œé€šçŸ¥å­ iframe é‡æ’ï¼ˆé˜²æ­¢çˆ¶å®¹å™¨è¢«è°ƒæ•´ï¼‰
            // å»¶è¿Ÿåˆå¹¶å¤šæ¬¡ resize
            let _relayoutTimer = null;
            window.addEventListener('resize', function () {
                clearTimeout(_relayoutTimer);
                _relayoutTimer = setTimeout(function () {
                    try {
                        if (iframe && iframe.contentWindow) iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                    } catch (e) { }
                }, 150);
            }, { passive: true });
        }

        // é‡è¯•åŠ è½½
        function retryLoad(panelName) {
            const panelContent = document.querySelector(`#${panelName}-panel .panel-content`);
            const iframe = panelContent.querySelector('iframe');
            if (iframe) {
                iframe.remove();
            }

            const placeholder = document.getElementById(`${panelName}-placeholder`);
            placeholder.innerHTML = `
                <div class="loading"><span data-i18n="errors.reloading">æ­£åœ¨é‡æ–°åŠ è½½</span></div>
                <small><span data-i18n="app.address">åœ°å€</span>: <span id="${panelName}-url">${PAGE_CONFIG[panelName].url}</span></small>
            `;
            placeholder.style.display = 'flex';

            setTimeout(() => loadPanelContent(panelName), 100);
        }

        // ===================================
        // ä¸“æ³¨æ¨¡å¼åŠŸèƒ½
        // ===================================

        // åˆ‡æ¢ä¸“æ³¨æ¨¡å¼
        function toggleFocusMode() {
            focusMode = !focusMode;
            const mainContent = document.getElementById('main-content');
            const focusToggle = document.getElementById('focus-toggle');

            if (focusMode) {
                mainContent.classList.add('focus-mode');
                focusToggle.classList.add('active');
                enterFocusMode();
            } else {
                mainContent.classList.remove('focus-mode');
                focusToggle.classList.remove('active');
                exitFocusMode();
            }

            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            saveStateToStorage();

            updateLayout();
            updateTabs();
        }

        // è¿›å…¥ä¸“æ³¨æ¨¡å¼
        function enterFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = false;
            });
            panels[activeFocusPanel] = true;
        }

        // é€€å‡ºä¸“æ³¨æ¨¡å¼
        function exitFocusMode() {
            Object.keys(panels).forEach(panelName => {
                panels[panelName] = true;
            });
        }

        // ===================================
        // é¢æ¿ç®¡ç†åŠŸèƒ½
        // ===================================

        // åˆ‡æ¢é¢æ¿æ˜¾ç¤º/éšè—
        function togglePanel(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
            } else {
                const visiblePanels = Object.values(panels).filter(v => v).length;

                if (visiblePanels <= 1 && panels[panelName]) {
                    showWarning(i18n.t('errors.keepOnePanel'), 3000);
                    return;
                }

                panels[panelName] = !panels[panelName];
            }

            // ä¿å­˜çŠ¶æ€åˆ°localStorage
            saveStateToStorage();

            updateLayout();
            updateTabs();
        }

        // å¤„ç†Tabç‚¹å‡»
        function handleTabClick(panelName) {
            if (focusMode) {
                activeFocusPanel = panelName;
                Object.keys(panels).forEach(name => {
                    panels[name] = (name === panelName);
                });
                // ä¿å­˜çŠ¶æ€åˆ°localStorage
                saveStateToStorage();
                updateLayout();
                updateTabs();
            } else {
                togglePanel(panelName);
            }
            // åœ¨ç§»åŠ¨ç«¯åˆ‡æ¢åˆ°æŸä¸ªé¢æ¿æ—¶ï¼Œè‹¥æ˜¯æ€ç»´å¯¼å›¾åˆ™è§¦å‘ iframe å¼ºåˆ¶é‡è½½/é‡æ’
            try { if (typeof MW_reloadMindmapOnShowIfMobile === 'function') MW_reloadMindmapOnShowIfMobile(panelName); } catch (e) { /* ignore */ }
        }

        // æ›´æ–°å¸ƒå±€
        function updateLayout() {
            const editorPanel = document.getElementById('editor-panel');
            const previewPanel = document.getElementById('preview-panel');
            const mindmapPanel = document.getElementById('mindmap-panel');
            const resizer1 = document.getElementById('resizer1');
            const resizer2 = document.getElementById('resizer2');

            // æ˜¾ç¤º/éšè—é¢æ¿
            editorPanel.classList.toggle('hidden', !panels.editor);
            previewPanel.classList.toggle('hidden', !panels.preview);
            mindmapPanel.classList.toggle('hidden', !panels.mindmap);

            if (focusMode) {
                resizer1.style.display = 'none';
                resizer2.style.display = 'none';
                return;
            }

            // å¤„ç†åˆ†éš”æ¡æ˜¾ç¤º
            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            resizer1.style.display = 'none';
            resizer2.style.display = 'none';

            if (visiblePanels.length === 2) {
                if (visiblePanels.includes('editor') && visiblePanels.includes('preview')) {
                    resizer1.style.display = 'block';
                } else if (visiblePanels.includes('preview') && visiblePanels.includes('mindmap')) {
                    resizer2.style.display = 'block';
                } else if (visiblePanels.includes('editor') && visiblePanels.includes('mindmap')) {
                    resizer1.style.display = 'block';
                }
            } else if (visiblePanels.length === 3) {
                resizer1.style.display = 'block';
                resizer2.style.display = 'block';
            }

            resetFlexBasis();
        }

        // é‡ç½®flexåŸºç¡€å€¼
        function resetFlexBasis() {
            if (focusMode) return;

            const visiblePanels = [];
            if (panels.editor) visiblePanels.push('editor');
            if (panels.preview) visiblePanels.push('preview');
            if (panels.mindmap) visiblePanels.push('mindmap');

            if (visiblePanels.length === 0) return;

            // é‡ç½®flexå±æ€§
            if (panels.editor) {
                document.getElementById('editor-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.preview) {
                document.getElementById('preview-panel').style.flex = visiblePanels.length === 3 ? '1' : '1';
            }
            if (panels.mindmap) {
                document.getElementById('mindmap-panel').style.flex = visiblePanels.length === 3 ? '2' : '1';
            }
        }

        // æ›´æ–°tabçŠ¶æ€
        function updateTabs() {
            document.querySelectorAll('.tab[data-panel]').forEach(tab => {
                const panelName = tab.dataset.panel;
                if (focusMode) {
                    tab.classList.toggle('active', panelName === activeFocusPanel);
                } else {
                    tab.classList.toggle('active', panels[panelName]);
                }
            });
        }

        // ä¿å­˜çŠ¶æ€åˆ°localStorage
        function saveStateToStorage() {
            try {
                localStorage.setItem(STORAGE_KEYS.focusMode, JSON.stringify(focusMode));
                localStorage.setItem(STORAGE_KEYS.activeFocusPanel, JSON.stringify(activeFocusPanel));
                localStorage.setItem(STORAGE_KEYS.panels, JSON.stringify(panels));
            } catch (e) {
                console.warn('Failed to save state to localStorage:', e);
            }
        }

        // ä»localStorageæ¢å¤çŠ¶æ€
        function restoreStateFromStorage() {
            try {
                const savedFocusMode = localStorage.getItem(STORAGE_KEYS.focusMode);
                const savedActiveFocusPanel = localStorage.getItem(STORAGE_KEYS.activeFocusPanel);
                const savedPanels = localStorage.getItem(STORAGE_KEYS.panels);

                if (savedFocusMode !== null) {
                    focusMode = JSON.parse(savedFocusMode);
                }

                if (savedActiveFocusPanel !== null) {
                    activeFocusPanel = JSON.parse(savedActiveFocusPanel);
                }

                if (savedPanels !== null) {
                    const parsedPanels = JSON.parse(savedPanels);
                    Object.keys(panels).forEach(key => {
                        if (parsedPanels.hasOwnProperty(key)) {
                            panels[key] = parsedPanels[key];
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to restore state from localStorage:', e);
            }
        }

        // åº”ç”¨æ¢å¤çš„çŠ¶æ€
        function applyRestoredState() {
            const mainContent = document.getElementById('main-content');
            const focusToggle = document.getElementById('focus-toggle');

            if (focusMode) {
                mainContent.classList.add('focus-mode');
                focusToggle.classList.add('active');
                focusToggle.querySelector('span').textContent = 'ä¸“æ³¨';
            } else {
                mainContent.classList.remove('focus-mode');
                focusToggle.classList.remove('active');
                focusToggle.querySelector('span').textContent = 'ä¸“æ³¨';
            }

            updateLayout();
            updateTabs();
        }

        // ===================================
        // æ‹–æ‹½åŠŸèƒ½ - ä½¿ç”¨åƒç´ ç›´æ¥æ˜ å°„ï¼Œ1:1è·Ÿéšé¼ æ ‡
        // ===================================

        // è·å–ç›¸é‚»é¢æ¿
        function getAdjacentPanels(resizer) {
            const mainContent = document.getElementById('main-content');
            const allChildren = Array.from(mainContent.children);
            const resizerIndex = allChildren.indexOf(resizer);

            let leftPanel = null;
            let rightPanel = null;

            // å‘å·¦æ‰¾å¯è§é¢æ¿
            for (let i = resizerIndex - 1; i >= 0; i--) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    leftPanel = element;
                    break;
                }
            }

            // å‘å³æ‰¾å¯è§é¢æ¿
            for (let i = resizerIndex + 1; i < allChildren.length; i++) {
                const element = allChildren[i];
                if (element.classList.contains('panel') && !element.classList.contains('hidden')) {
                    rightPanel = element;
                    break;
                }
            }

            return { leftPanel, rightPanel };
        }

        // å¼€å§‹æ‹–æ‹½
        function startDrag(e, resizer) {
            if (focusMode) return;

            e.preventDefault();

            const { leftPanel, rightPanel } = getAdjacentPanels(resizer);
            if (!leftPanel || !rightPanel) return;

            const containerWidth = document.getElementById('main-content').offsetWidth;

            // è®¾ç½®æ‹–æ‹½çŠ¶æ€
            dragState = {
                isDragging: true,
                currentResizer: resizer,
                startX: e.clientX,
                currentX: e.clientX,
                leftPanel: leftPanel,
                rightPanel: rightPanel,
                startLeftWidth: leftPanel.offsetWidth,
                startRightWidth: rightPanel.offsetWidth,
                containerWidth: containerWidth,
                animationId: null
            };

            // æ·»åŠ è§†è§‰åé¦ˆå’Œç¦ç”¨è¿‡æ¸¡
            resizer.classList.add('dragging');
            document.body.classList.add('resizing', 'no-select');
            leftPanel.classList.add('resizing');
            rightPanel.classList.add('resizing');
        }

        // å¤„ç†æ‹–æ‹½ - 1:1åƒç´ æ˜ å°„
        function handleDrag(e) {
            if (!dragState.isDragging) return;

            dragState.currentX = e.clientX;

            // å–æ¶ˆä¹‹å‰çš„åŠ¨ç”»å¸§
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // ä½¿ç”¨requestAnimationFrameç¡®ä¿æµç•…æ€§
            dragState.animationId = requestAnimationFrame(() => {
                const deltaX = dragState.currentX - dragState.startX;

                // è®¡ç®—æ–°çš„å®½åº¦ï¼ˆåƒç´ å€¼ï¼‰
                const newLeftWidth = dragState.startLeftWidth + deltaX;
                const newRightWidth = dragState.startRightWidth - deltaX;

                // è®¾ç½®æœ€å°å®½åº¦é™åˆ¶
                const minWidth = 100;

                if (newLeftWidth >= minWidth && newRightWidth >= minWidth) {
                    // è½¬æ¢ä¸ºç™¾åˆ†æ¯”ä»¥ä¿æŒå“åº”å¼
                    const leftPercent = (newLeftWidth / dragState.containerWidth) * 100;
                    const rightPercent = (newRightWidth / dragState.containerWidth) * 100;

                    // ç›´æ¥è®¾ç½®widthè€Œä¸æ˜¯flexï¼Œç¡®ä¿ç²¾ç¡®æ§åˆ¶
                    dragState.leftPanel.style.width = `${leftPercent}%`;
                    dragState.rightPanel.style.width = `${rightPercent}%`;
                    dragState.leftPanel.style.flex = 'none';
                    dragState.rightPanel.style.flex = 'none';
                }
            });
        }

        // ç»“æŸæ‹–æ‹½
        function endDrag() {
            if (!dragState.isDragging) return;

            // å–æ¶ˆåŠ¨ç”»å¸§
            if (dragState.animationId) {
                cancelAnimationFrame(dragState.animationId);
            }

            // æ¸…ç†è§†è§‰åé¦ˆ
            if (dragState.currentResizer) {
                dragState.currentResizer.classList.remove('dragging');
            }
            if (dragState.leftPanel) {
                dragState.leftPanel.classList.remove('resizing');
            }
            if (dragState.rightPanel) {
                dragState.rightPanel.classList.remove('resizing');
            }
            document.body.classList.remove('resizing', 'no-select');

            // é‡ç½®çŠ¶æ€
            dragState = {
                isDragging: false,
                currentResizer: null,
                startX: 0,
                currentX: 0,
                leftPanel: null,
                rightPanel: null,
                startLeftWidth: 0,
                startRightWidth: 0,
                containerWidth: 0,
                animationId: null
            };
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initResizing() {
            const resizers = document.querySelectorAll('.resizer');

            resizers.forEach(resizer => {
                // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
                resizer.addEventListener('mousedown', (e) => startDrag(e, resizer), { passive: false });
            });

            // å…¨å±€é¼ æ ‡äº‹ä»¶
            document.addEventListener('mousemove', handleDrag, { passive: true });
            document.addEventListener('mouseup', endDrag, { passive: true });

            // é˜²æ­¢æ‹–æ‹½æ—¶é€‰æ‹©æ–‡æœ¬
            document.addEventListener('selectstart', (e) => {
                if (dragState.isDragging) e.preventDefault();
            });
        }

        // ===================================
        // äº‹ä»¶ç›‘å¬å™¨
        // ===================================

        // ç§»åŠ¨ç«¯è‡ªåŠ¨è¿›å…¥ä¸“æ³¨æ¨¡å¼ï¼ˆéšè—ä¸“æ³¨åˆ‡æ¢æŒ‰é’®å¹¶è¿›å…¥ä¸“æ³¨ï¼‰
        function initMobileFocus() {
            const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
            const focusToggle = document.getElementById('focus-toggle');

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€
            const hasSavedState = localStorage.getItem(STORAGE_KEYS.focusMode) !== null;

            if (isMobile) {
                // åªæœ‰åœ¨æ²¡æœ‰ä¿å­˜çŠ¶æ€çš„æƒ…å†µä¸‹æ‰åº”ç”¨ç§»åŠ¨ç«¯é»˜è®¤è¡Œä¸º
                // éšè—ä¸“æ³¨åˆ‡æ¢æŒ‰é’®ï¼ˆæ ·å¼å·²åœ¨ mobile CSS ä¸­éšè— header-rightï¼‰
                if (focusToggle) focusToggle.style.display = 'none';

                // è®¾ç½®ä¸“æ³¨çŠ¶æ€å¹¶æ¿€æ´»é»˜è®¤é¢æ¿
                focusMode = true;
                activeFocusPanel = activeFocusPanel || 'editor';

                const mainContent = document.getElementById('main-content');
                if (mainContent) mainContent.classList.add('focus-mode');

                // è°ƒç”¨ç°æœ‰çš„ä¸“æ³¨åˆå§‹åŒ–é€»è¾‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof enterFocusMode === 'function') enterFocusMode();
                if (typeof updateTabs === 'function') updateTabs();
                if (typeof updateLayout === 'function') updateLayout();
            } else if (isMobile && hasSavedState) {
                // å¦‚æœæœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œåªéšè—ä¸“æ³¨åˆ‡æ¢æŒ‰é’®
                if (focusToggle) focusToggle.style.display = 'none';
            }
        }

        // ä¸“æ³¨æ¨¡å¼åˆ‡æ¢æŒ‰é’®äº‹ä»¶
        document.getElementById('focus-toggle').addEventListener('click', toggleFocusMode);

        // Tabç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.tab[data-panel]').forEach(tab => {
            tab.addEventListener('click', () => {
                const panelName = tab.dataset.panel;
                handleTabClick(panelName);
            });
        });

        // é”®ç›˜å¿«æ·é”® - ESCé€€å‡ºä¸“æ³¨æ¨¡å¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && focusMode) {
                toggleFocusMode();
            }
        });

        // ===================================
        // å…¨å±€é€šçŸ¥ç³»ç»Ÿ
        // ===================================

        /**
         * æ˜¾ç¤ºå…¨å±€é€šçŸ¥æ¶ˆæ¯ï¼ˆæ›¿ä»£alertï¼‰
         * @param {string} message - é€šçŸ¥æ¶ˆæ¯
         * @param {string} type - é€šçŸ¥ç±»å‹ï¼šsuccess, danger, warning, info
         * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
         */
        function showNotification(message, type = 'info', duration = 1500) {
            if (typeof $ === 'undefined') {
                // å¦‚æœjQueryä¸å¯ç”¨ï¼Œå›é€€åˆ°alert
                alert(message);
                return;
            }

            // ç»Ÿä¸€é¢œè‰²æ–¹æ¡ˆ
            const typeStyles = {
                success: 'background-color: #28a745; border-color: #28a745; color: white;', // ç»¿è‰²
                danger: 'background-color: #dc3545; border-color: #dc3545; color: white;',   // çº¢è‰²
                warning: 'background-color: #ffc107; border-color: #ffc107; color: #212529;', // é»„è‰²
                info: 'background-color: #17a2b8; border-color: #17a2b8; color: white;'     // è“è‰²
            };

            // åˆ›å»ºé€šçŸ¥å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰â€”â€”å³å¯¹é½å¤šæ¡é€šçŸ¥ï¼Œå‚ç›´æ’åˆ—
            if ($('#global-notification-container').length === 0) {
                $('body').append('<div id="global-notification-container" style="position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 6px; align-items: flex-end;"></div>');
            }

            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notificationId = 'global-notification-' + Date.now();
            const notificationHtml = `
                <div id="${notificationId}" class="alert alert-dismissible fade show" 
                     style="display: inline-flex; align-items: center; height: 24px; line-height: 14px; padding: 0 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.08); margin: 0; white-space: nowrap; ${typeStyles[type] || typeStyles.info}">
                    <span style="font-size:12px; padding-right:16px;">${message}</span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="color: inherit; opacity: 0.9; padding:0 6px; height:20px; line-height:20px; background:transparent; border:none; display:inline-flex; align-items:center; justify-content:center;">
                        <span aria-hidden="true" style="font-size:12px; line-height:20px;">&times;</span>
                    </button>
                </div>
            `;

            // æ·»åŠ åˆ°é€šçŸ¥å®¹å™¨
            $('#global-notification-container').append(notificationHtml);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // é‡æ–°æ’åˆ—å‰©ä½™é€šçŸ¥
                    rearrangeGlobalNotifications();
                });
            }, duration);

            // ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶ç§»é™¤
            $(`#${notificationId} .close`).click(() => {
                const $notification = $(`#${notificationId}`);
                $notification.fadeOut(300, function () {
                    $notification.remove();
                    // é‡æ–°æ’åˆ—å‰©ä½™é€šçŸ¥
                    rearrangeGlobalNotifications();
                });
            });
        }

        /**
         * é‡æ–°æ’åˆ—å…¨å±€é€šçŸ¥
         */
        function rearrangeGlobalNotifications() {
            const $container = $('#global-notification-container');
            const $notifications = $container.children('.alert');

            if ($notifications.length === 0) {
                // å¦‚æœæ²¡æœ‰é€šçŸ¥äº†ï¼Œç§»é™¤å®¹å™¨
                $container.remove();
                return;
            }

            // é‡æ–°è®¡ç®—ä½ç½®
            $notifications.each(function (index) {
                const $notification = $(this);
                // æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ
                $notification.css('transition', 'transform 0.3s ease');
                $notification.css('transform', `translateY(0)`);
            });
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
         */
        function showSuccess(message, duration = 1500) {
            showNotification(message, 'success', duration);
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
         */
        function showError(message, duration = 3000) {
            showNotification(message, 'danger', duration);
        }

        /**
         * æ˜¾ç¤ºè­¦å‘Šé€šçŸ¥
         */
        function showWarning(message, duration = 2000) {
            showNotification(message, 'warning', duration);
        }

        /**
         * æ˜¾ç¤ºä¿¡æ¯é€šçŸ¥
         */
        function showInfo(message, duration = 1500) {
            showNotification(message, 'info', duration);
        }

        /**
         * å¤„ç†æ¥è‡ªå­é¡µé¢çš„é€šçŸ¥æ¶ˆæ¯
         * - æ–°å¢å¤„ç† mw_editing_mode æ¶ˆæ¯ä»¥è®¾ç½®å…¨å±€æŠ‘åˆ¶æ ‡å¿— window.__mw_global_suppress_toasts
         * - å½“å…¨å±€æŠ‘åˆ¶ç”Ÿæ•ˆæ—¶ï¼Œå¯¹ type==='notification' çš„æ¶ˆæ¯ä»…è®°å½•åˆ° console ä¸å±•ç¤º UI é€šçŸ¥
         */
        function handleNotificationMessage(event) {
            // éªŒè¯æ¶ˆæ¯æ¥æº
            if (!event.data || !event.data.type) return;

            // å…ˆå¤„ç†ç¼–è¾‘æ¨¡å¼å¼€å…³æ¶ˆæ¯ï¼ˆç”±å­ iframe å¹¿æ’­ï¼‰
            try {
                if (event.data.type === 'mw_editing_mode') {
                    try {
                        window.__mw_global_suppress_toasts = !!event.data.editing;
                        console.log('[INDEX] mw_editing_mode ->', window.__mw_global_suppress_toasts);
                    } catch (e) { /* ignore */ }
                    return;
                }
            } catch (e) { /* ignore */ }

            // è½¬å‘æ¥è‡ªæ€ç»´å¯¼å›¾çš„èŠ‚ç‚¹é€‰ä¸­æ¶ˆæ¯åˆ° editor iframeï¼ˆç”¨äºæ»šåŠ¨/é«˜äº®ï¼‰
            try {
                if (event.data.type === 'mindmap-node-selected') {
                    // æ‰¾åˆ° editor é¢æ¿ iframeï¼ˆåŸºäº PAGE_CONFIG æˆ–å¸¸è§é€‰æ‹©å™¨ï¼‰
                    var editorIframe = document.querySelector('iframe[data-panel="editor"], iframe#panel-editor, iframe[src*="editor/editor.html"]');
                    // æ‰¾åˆ° preview/md2word é¢æ¿ iframe
                    var previewIframe = document.querySelector('iframe[data-panel="preview"], iframe#panel-preview, iframe[src*="md2word/md2word.html"], iframe[src*="preview"]');
                    var payload = event.data;
                    var forwardEditor = {
                        type: 'editor-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };
                    var forwardPreview = {
                        type: 'preview-scroll-to',
                        nodeid: payload.nodeid,
                        raw: payload.raw,
                        parentPath: payload.parentPath
                    };

                    // è½¬å‘åˆ° editor iframe
                    if (editorIframe && editorIframe.contentWindow) {
                        try {
                            editorIframe.contentWindow.postMessage(forwardEditor, '*');
                            console.log('[INDEX FORWARD] -> editor', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD] editor postMessage failed', e);
                        }
                    } else {
                        // å¦‚æœ editor iframe å°šæœªå°±ç»ªï¼Œç¼“å­˜æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œinit æ—¶å¯é‡å‘
                        window.__mw__pendingEditorMessage = forwardEditor;
                        console.log('[INDEX FORWARD] editor iframe not ready, cached');
                    }

                    // è½¬å‘åˆ° preview/md2word iframeï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (previewIframe && previewIframe.contentWindow) {
                        try {
                            previewIframe.contentWindow.postMessage(forwardPreview, '*');
                            console.log('[INDEX FORWARD PREVIEW] -> preview', { nodeid: payload.nodeid });
                        } catch (e) {
                            console.warn('[INDEX FORWARD PREVIEW] preview postMessage failed', e);
                        }
                    } else {
                        // ç¼“å­˜ä»¥ä¾¿åœ¨ iframe åˆå§‹åŒ–æ—¶é‡å‘
                        window.__mw__pendingPreviewMessage = forwardPreview;
                        console.log('[INDEX FORWARD PREVIEW] preview iframe not ready, cached');
                    }
                    return;
                }
            } catch (e) {
                console.warn('forwarding mindmap message failed', e);
            }

            // åªå¤„ç†é€šçŸ¥ç›¸å…³çš„æ¶ˆæ¯
            if (event.data.type === 'notification') {
                const { message, notificationType, duration } = event.data;

                // è‹¥çˆ¶é¡µå¤„äºå…¨å±€æŠ‘åˆ¶çŠ¶æ€ï¼Œåˆ™è·³è¿‡å¯è§†é€šçŸ¥ï¼Œä»…å†™ consoleï¼ˆé¿å…ç¼–è¾‘æ—¶æ‰“æ–­ï¼‰
                if (window.__mw_global_suppress_toasts) {
                    try {
                        console.log('[INDEX] notification suppressed ->', notificationType, message);
                    } catch (e) { }
                    return;
                }

                switch (notificationType) {
                    case 'success':
                        showSuccess(message, duration);
                        break;
                    case 'error':
                        showError(message, duration);
                        break;
                    case 'warning':
                        showWarning(message, duration);
                        break;
                    case 'info':
                        showInfo(message, duration);
                        break;
                    default:
                        showNotification(message, notificationType, duration);
                }
            }
        }

        // ===================================
        // åˆå§‹åŒ–
        // ===================================

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // ä»localStorageæ¢å¤çŠ¶æ€ï¼ˆåœ¨ç§»åŠ¨ç«¯è‡ªåŠ¨ä¸“æ³¨æ¨¡å¼ä¹‹å‰ï¼‰
            restoreStateFromStorage();

            updateLayout();
            initResizing();

            // åŠ è½½æ‰€æœ‰é¢æ¿å†…å®¹
            Object.keys(PAGE_CONFIG).forEach(panelName => {
                loadPanelContent(panelName);
            });

            // åº”ç”¨æ¢å¤çš„çŠ¶æ€åˆ°UI
            applyRestoredState();

            // ç§»åŠ¨ç«¯è‡ªåŠ¨ä¸“æ³¨æ¨¡å¼åˆå§‹åŒ–ï¼ˆåœ¨çŠ¶æ€æ¢å¤ä¹‹åï¼‰
            initMobileFocus();

            // ç›‘å¬æ¥è‡ªå­é¡µé¢çš„æ¶ˆæ¯
            window.addEventListener('message', handleNotificationMessage);
            // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ”¶åˆ°çš„åŸå§‹ messageï¼Œä¾¿äºæ’æŸ¥ mindmap -> index -> editor çš„æ¶ˆæ¯æµ
            window.addEventListener('message', function (e) {
                try { console.log('[INDEX RAW MESSAGE]æ”¶åˆ°æ¶ˆæ¯', e && e.data); } catch (err) { }
            }, { passive: true });

            console.log('ğŸ“Œ Markdown Studio å·²åˆå§‹åŒ–');
            console.log('é…ç½®ä¿¡æ¯:', PAGE_CONFIG);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initApp);

        // é¢„åŠ è½½ AI prompt æ¨¡æ¿åˆ°å…¨å±€ï¼Œä¾›å­ iframeï¼ˆå¦‚ mindmapï¼‰åŒæ­¥è¯»å–
        (function preloadAIPromptTemplates() {
            try {
                if (window.__prompt_templates) return;
                var url = 'ai/newai/prompt-templates.json';
                fetch(url, { cache: 'no-cache' }).then(function (resp) {
                    if (!resp.ok) throw new Error('fetch failed ' + resp.status);
                    return resp.json();
                }).then(function (json) {
                    try { window.__prompt_templates = json; console.log('[INDEX] loaded prompt-templates.json', Array.isArray(json) ? json.length : 0); } catch (e) { }
                }).catch(function (err) {
                    console.warn('[INDEX] preload prompt-templates.json failed', err);
                    try { window.__prompt_templates = window.__prompt_templates || null; } catch (e) { }
                });
            } catch (e) { console.warn('[INDEX] preloadAIPromptTemplates error', e); }
        })();

        /* ==== AI å¼¹çª—çˆ¶å±‚æ‰˜ç®¡æ³¨å…¥ï¼ˆæ¥è‡ª ai/newai/demo-caller.html çš„é€‚é…å®ç°ï¼‰ ====
           å­ iframe é€šè¿‡ postMessage({ type:'AI_MODAL_OPEN_REQUEST', requestId, payload }, '*')
           è°ƒç”¨ä½äº ai/newai/AIServiceModal.html çš„ AIServiceModalã€‚æ”¯æŒ modal ä¸ headlessï¼ˆdirectï¼‰ã€‚
        */
        (function injectAiModalHost() {
            try {
                var existing = document.getElementById('aiModalFrame');
                if (!existing) {
                    var frame = document.createElement('iframe');
                    frame.id = 'aiModalFrame';
                    frame.src = 'ai/newai/AIServiceModal.html';
                    frame.style.position = 'fixed';
                    frame.style.inset = '0';
                    frame.style.width = '100%';
                    frame.style.height = '100%';
                    frame.style.border = '0';
                    frame.style.display = 'none';
                    frame.setAttribute('aria-hidden', 'true');
                    frame.style.zIndex = '9999';
                    frame.style.background = 'transparent';
                    document.body.appendChild(frame);
                }
            } catch (e) {
                console.warn('[INDEX][AI] inject aiModalFrame failed', e);
            }

            window.__ai_req_map = window.__ai_req_map || new Map();
            window._headlessTimeouts = window._headlessTimeouts || new Map();

            window.addEventListener('message', function (e) {
                try {
                    var msg = e && e.data;
                    if (!msg || typeof msg !== 'object') return;

                    if (msg.type === 'AI_MODAL_OPEN_REQUEST' && msg.requestId) {
                        console.log('[INDEX] AI_MODAL_OPEN_REQUEST', msg.requestId, msg.payload);
                        window.__ai_req_map.set(msg.requestId, e.source);
                        var aiFrame = document.getElementById('aiModalFrame');

                        if (msg.payload && msg.payload.mode === 'direct') {
                            // headless handling (kept for compatibility)
                            var platformCfgRaw = msg.payload.platformConfig || msg.payload.platform || {};
                            var platformConfig = Object.assign({}, platformCfgRaw);

                            try {
                                var storageStr = aiFrame && aiFrame.contentWindow && aiFrame.contentWindow.localStorage
                                    ? aiFrame.contentWindow.localStorage.getItem('allAIPlatformConfigs')
                                    : null;
                                if (!platformConfig.provider && storageStr) {
                                    try {
                                        var allCfgs = JSON.parse(storageStr || '{}') || {};
                                        var keys = Object.keys(allCfgs || {});
                                        var chosen = null;
                                        for (var i = 0; i < keys.length; i++) {
                                            var k = keys[i];
                                            var c = allCfgs[k] || {};
                                            var hasApiKey = c.apiKey && String(c.apiKey).trim() !== '';
                                            var okCloudflare = (k !== 'cloudflare') || (c.cloudflareAccountId && String(c.cloudflareAccountId).trim() !== '');
                                            var okAzure = (k !== 'azure') || (c.azureEndpoint && String(c.azureEndpoint).trim() !== '');
                                            if (hasApiKey && okCloudflare && okAzure) {
                                                chosen = { key: k, cfg: c };
                                                break;
                                            }
                                        }
                                        if (chosen) {
                                            platformConfig.provider = platformConfig.provider || chosen.key;
                                            platformConfig.apiKey = platformConfig.apiKey || chosen.cfg.apiKey || '';
                                            if (chosen.cfg.azureEndpoint) platformConfig.azureEndpoint = platformConfig.azureEndpoint || chosen.cfg.azureEndpoint;
                                            if (chosen.cfg.cloudflareAccountId) platformConfig.cloudflareAccountId = platformConfig.cloudflareAccountId || chosen.cfg.cloudflareAccountId;
                                            console.log('[INDEX] selected saved platform from aiModalFrame.localStorage:', chosen.key);
                                        }
                                    } catch (err) { console.warn('[INDEX] parse aiModalFrame.localStorage failed', err); }
                                }
                            } catch (err) { console.warn('[INDEX] read aiFrame localStorage failed', err); }

                            var _tplRaw = msg.payload.templateData || {
                                templateText: msg.payload.template || '',
                                placeholders: msg.payload.params || {}
                            };
                            
                            // Handle templateKey - load template content if templateKey is provided
                            if (msg.payload.templateKey && !(_tplRaw && typeof _tplRaw.templateText === 'string' && _tplRaw.templateText.trim())) {
                                try {
                                    // Try to get template content from the iframe's template system
                                    var aiFrame = document.getElementById('aiModalFrame');
                                    if (aiFrame && aiFrame.contentWindow && aiFrame.contentWindow.promptTemplates) {
                                        var templates = aiFrame.contentWindow.promptTemplates;
                                        for (var i = 0; i < templates.length; i++) {
                                            if (templates[i].name === msg.payload.templateKey) {
                                                _tplRaw.templateText = templates[i].content || '';
                                                console.log('[INDEX] Loaded template content for key:', msg.payload.templateKey);
                                                break;
                                            }
                                        }
                                    }
                                } catch (err) { 
                                    console.warn('[INDEX] Failed to load template content for key:', msg.payload.templateKey, err); 
                                }
                            }
                            
                            try {
                                if (!(_tplRaw && typeof _tplRaw.templateText === 'string' && _tplRaw.templateText.trim())) {
                                    var ph = (_tplRaw && _tplRaw.placeholders) ? _tplRaw.placeholders : (msg.payload.placeholders || msg.payload.params || {});
                                    var candidate = '';
                                    if (ph) {
                                        if (ph.input && typeof ph.input === 'object' && typeof ph.input.value === 'string') candidate = ph.input.value;
                                        else if (typeof ph.input === 'string') candidate = ph.input;
                                    }
                                    if (!candidate && typeof msg.payload.template === 'string') candidate = msg.payload.template;
                                    if (candidate && String(candidate).trim()) { _tplRaw.templateText = String(candidate); }
                                }
                            } catch (err) { console.warn('[INDEX] fill templateText failed', err); }

                            var headlessPayload = {
                                platformConfig: platformConfig,
                                modelConfig: msg.payload.modelConfig || msg.payload.model || {},
                                templateData: _tplRaw,
                                options: msg.payload.options || {}
                            };
                            
                            // Pass templateKey if provided
                            if (msg.payload.templateKey) {
                                headlessPayload.templateData.templateKey = msg.payload.templateKey;
                            }

                            try {
                                aiFrame.contentWindow.postMessage({
                                    type: 'AI_MODAL_OPEN',
                                    payload: Object.assign({}, headlessPayload, { requestId: msg.requestId, mode: 'silent' })
                                }, '*');
                                var HEADLESS_TIMEOUT_MS = 15000;
                                var t = setTimeout(function () {
                                    try {
                                        var src = window.__ai_req_map.get(msg.requestId);
                                        if (src) {
                                            src.postMessage({
                                                type: 'AI_MODAL_RESULT',
                                                requestId: msg.requestId,
                                                status: 'error',
                                                detail: { message: 'headless call timeout' }
                                            }, '*');
                                        }
                                    } catch (e) { }
                                    window._headlessTimeouts.delete(msg.requestId);
                                    window.__ai_req_map.delete(msg.requestId);
                                }, HEADLESS_TIMEOUT_MS);
                                window._headlessTimeouts.set(msg.requestId, { timer: t, source: e.source });
                            } catch (err) {
                                console.error('[INDEX] post to aiModalFrame failed', err);
                                try { e.source.postMessage({ type: 'AI_MODAL_RESULT', requestId: msg.requestId, status: 'error', detail: { message: 'failed to post to aiModalFrame: ' + (err && err.message ? err.message : String(err)) } }, '*'); } catch (_) { }
                                window.__ai_req_map.delete(msg.requestId);
                            }
                            return;
                        }

                        // modal path: show frame and forward
                        try { if (aiFrame) { aiFrame.style.display = 'block'; aiFrame.focus && aiFrame.focus(); } } catch (_) { }
                        
                        // å¤„ç†templateKeyå‚æ•°ï¼Œç±»ä¼¼headlessæ¨¡å¼çš„é€»è¾‘
                        var modalPayload = Object.assign({}, msg.payload || {}, { requestId: msg.requestId });
                        
                        // å¦‚æœå­˜åœ¨templateKeyä½†æ²¡æœ‰templateDataï¼Œéœ€è¦æ„å»ºtemplateData
                        if (modalPayload.templateKey && !modalPayload.templateData) {
                            modalPayload.templateData = {
                                templateKey: modalPayload.templateKey,
                                templateText: modalPayload.template || '',
                                placeholders: modalPayload.placeholders || modalPayload.params || {}
                            };
                        }
                        
                        try {
                            aiFrame.contentWindow.postMessage({
                                type: 'AI_MODAL_OPEN',
                                payload: modalPayload
                            }, '*');
                            console.log('[INDEX] forwarded AI_MODAL_OPEN to aiModalFrame', msg.requestId);
                        } catch (err) {
                            console.error('[INDEX] forward AI_MODAL_OPEN failed', err);
                            try { e.source.postMessage({ type: 'AI_MODAL_RESULT', requestId: msg.requestId, status: 'error', detail: { message: 'failed to forward to aiModalFrame' } }, '*'); } catch (_) { }
                            window.__ai_req_map.delete(msg.requestId);
                        }
                    }

                    // handle AI_MODAL_RESULT: when modal's "ä¿å­˜å¹¶åº”ç”¨" sends output, forward it as a RESULT to the original requester
                    if (msg.type === 'AI_MODAL_RESULT' && msg.requestId) {
                        console.log('[INDEX] AI_MODAL_RESULT', msg.requestId, 'actionType:', msg.actionType);
                        var srcWinSave = window.__ai_req_map.get(msg.requestId);
                        try { var fsave = document.getElementById('aiModalFrame'); if (fsave) fsave.style.display = 'none'; } catch (_) { }

                        // æ„é€ æ¶ˆæ¯ï¼Ÿ

                        // var outMsgSave = {
                        //     type: 'AI_MODAL_RESULT',
                        //     actionType: msg.actionType,
                        //     requestId: msg.requestId,
                        //     status: 'ok',
                        //     detail: { output: msg.output }
                        // };
                        if (srcWinSave) {
                            try {
                                srcWinSave.postMessage(msg, '*');
                                window.__ai_req_map.delete(msg.requestId);
                                console.log('[INDEX] forwarded AI_MODAL_RESULT as RESULT to source', msg.requestId, 'with actionType:', msg.actionType);
                            } catch (e) {
                                console.warn('[INDEX] forward save output failed', e);
                            }
                        } else {
                            console.warn('[INDEX] source not found for AI_MODAL_RESULT', msg.requestId);
                        }
                        return;
                    }

                    // modal result
                    if (msg.type === 'AI_MODAL_RESULT' && msg.requestId) {
                        console.log('[INDEX] AI_MODAL_RESULT', msg.requestId, msg.status, 'actionType:', msg.actionType);
                        var srcWin = window.__ai_req_map.get(msg.requestId);
                        // ä»…åœ¨æ¶ˆæ¯æ²¡æœ‰è¦æ±‚ä¿ç•™ï¼ˆkeepOpenï¼‰æ—¶æ‰éšè— aiModalFrameã€‚
                        // å¦‚æœ msg.keepOpen === trueï¼Œåˆ™ä¿æŒå¼¹çª—æ‰“å¼€ï¼ˆé”™è¯¯æ—¶ modal ä¼šå‘é€ keepOpen:trueï¼‰
                        try {
                            var f = document.getElementById('aiModalFrame');
                            if (f && !msg.keepOpen) {
                                f.style.display = 'none';
                            }
                        } catch (_) { }
                        if (srcWin) {
                            try { 
                                srcWin.postMessage(msg, '*'); 
                                console.log('[INDEX] forwarded AI_MODAL_RESULT to source', msg.requestId, 'with actionType:', msg.actionType);
                            } catch (e) { 
                                console.warn('[INDEX] forward result failed', e); 
                            }
                            window.__ai_req_map.delete(msg.requestId);
                        } else {
                            console.warn('[INDEX] source not found for', msg.requestId);
                        }
                    }

                    // headless run result
                    if (msg.type === 'AI_MODAL_RUN_RESULT' && msg.requestId) {
                        console.log('[INDEX] AI_MODAL_RUN_RESULT', msg.requestId, msg.status);
                        var srcWin2 = window.__ai_req_map.get(msg.requestId);
                        try { var f2 = document.getElementById('aiModalFrame'); if (f2) f2.style.display = 'none'; } catch (_) { }
                        var outMsg = { type: 'AI_MODAL_RESULT', requestId: msg.requestId, status: msg.status === 'ok' ? 'ok' : 'error', detail: msg.detail };
                        if (srcWin2) { try { srcWin2.postMessage(outMsg, '*'); } catch (e) { console.warn('[INDEX] forward headless result failed', e); } window.__ai_req_map.delete(msg.requestId); } else { console.warn('[INDEX] source not found for headless', msg.requestId); }
                    }
                } catch (err) {
                    console.warn('[INDEX] ai message handler error', err);
                }
            }, false);
        })();

        // åœ¨ç§»åŠ¨ç«¯åˆ›å»ºåº•éƒ¨ tabsï¼šå…‹éš† header .tabs åˆ° mobile-tabsï¼ˆä¿æŒäº‹ä»¶ç»‘å®šï¼‰
        function createMobileTabs() {
            try {
                const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
                const headerTabs = document.querySelector('.header .tabs');
                const mobileContainer = document.getElementById('mobile-tabs');
                if (!headerTabs || !mobileContainer) return;

                // æ¸…ç©ºå¹¶å…‹éš†
                mobileContainer.innerHTML = '';
                headerTabs.querySelectorAll('.tab[data-panel]').forEach(tab => {
                    const panel = tab.dataset.panel;
                    const clone = tab.cloneNode(true);
                    clone.classList.remove('active');
                    clone.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleTabClick(panel);
                        // è§†è§‰åé¦ˆ
                        document.querySelectorAll('.mobile-tabs .tab').forEach(t => t.classList.remove('active'));
                        clone.classList.add('active');
                    });
                    mobileContainer.appendChild(clone);
                });

                // æ˜¾ç¤º/éšè—ä¸ focusMode çŠ¶æ€åŒæ­¥
                if (isMobile) {
                    mobileContainer.setAttribute('aria-hidden', 'false');
                    mobileContainer.style.display = 'flex';
                } else {
                    mobileContainer.setAttribute('aria-hidden', 'true');
                    mobileContainer.style.display = 'none';
                }

                // åŒæ­¥æ¿€æ´»çŠ¶æ€
                updateTabs();
            } catch (e) {
                console.warn('createMobileTabs error', e);
            }
        }

        // å½“çª—å£å°ºå¯¸å˜åŒ–æ—¶åŒæ­¥ mobile tabs
        window.addEventListener('resize', () => {
            // debounce ç®€å•å®ç°
            clearTimeout(window._mobileTabsResizeTimer);
            window._mobileTabsResizeTimer = setTimeout(() => createMobileTabs(), 120);
        });

        // åœ¨ initApp ä¸­ä¹Ÿè°ƒç”¨ä¸€æ¬¡ï¼ˆåœ¨ DOMContentLoaded ä¹‹åï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            createMobileTabs();
        });
    </script>

    <script>
        (function () {
            // ä»…åœ¨ç§»åŠ¨ç«¯å¯ç”¨çš„ mindmap iframe å¼ºåˆ¶é‡è½½ç­–ç•¥
            function isMobile() {
                return (window.matchMedia && window.matchMedia('(max-width: 768px)').matches)
                    || ('ontouchstart' in window && navigator.maxTouchPoints > 0);
            }

            function reloadMindmapIframeOnce() {
                var iframe = document.getElementById('iframe-mindmap');
                if (!iframe) {
                    // å¦‚æœæ²¡æœ‰ id ä¸º iframe-mindmap çš„å…ƒç´ ï¼Œå°è¯•æŒ‰ panel src é€‰æ‹©
                    iframe = document.querySelector('iframe[src*="jsmind/mindmap.html"]');
                }
                if (!iframe) return;
                try {
                    var src = iframe.getAttribute('src') || iframe.src;
                    src = src.replace(/([?&])_t=\d+/, '$1');
                    iframe.src = src + (src.includes('?') ? '&' : '?') + '_t=' + Date.now();

                    function onLoadHandler() {
                        try {
                            if (iframe.contentWindow) {
                                iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*');
                                setTimeout(function () { try { iframe.contentWindow.postMessage({ type: 'mw_relayout' }, '*'); } catch (e) { } }, 200);
                            }
                        } catch (e) { }
                        iframe.removeEventListener('load', onLoadHandler);
                    }
                    iframe.addEventListener('load', onLoadHandler);
                } catch (e) { console.warn('reloadMindmapIframeOnce error', e); }
            }

            window.MW_reloadMindmapOnShowIfMobile = function (panelName) {
                if (panelName !== 'mindmap') return;
                if (!isMobile()) return;
                setTimeout(reloadMindmapIframeOnce, 80);
            };
        })();
    </script>
    <script>
        (function () {
            // æ¥è‡ª editor çš„åˆ·æ–°è¯·æ±‚ï¼šç”±é¡¶å±‚æ‰§è¡Œæ•´é¡µåˆ·æ–°
            window.addEventListener('message', function (e) {
                try {
                    var d = e && e.data;
                    if (!d || d.type !== 'editor-reload-request') return;
                    // å¯é€‰ï¼šæ£€æŸ¥æ¥æºæˆ– requestId ç­‰ä»¥å¢åŠ å®‰å…¨æ€§
                    try {
                        if (top && top.location && top !== window) {
                            top.location.reload();
                        } else {
                            window.location.reload();
                        }
                    } catch (err) {
                        try { window.location.reload(); } catch (e) { /* ignore */ }
                    }
                } catch (err) { }
            }, { passive: true });
        })();
    </script>
    <script>
        // =============== æ–‡æ¡£åº“ä¸ä¾§æ  ===============
        const MW_STORAGE_KEYS = {
            docs: 'mw_documents',
            active: 'mw_active_doc'
        };

        function mw_loadDocs() {
            try { return JSON.parse(localStorage.getItem(MW_STORAGE_KEYS.docs) || '[]'); } catch (_) { return []; }
        }
        function mw_saveDocs(docs) {
            localStorage.setItem(MW_STORAGE_KEYS.docs, JSON.stringify(docs));
        }
        function mw_setActive(docId) {
            localStorage.setItem(MW_STORAGE_KEYS.active, docId || '');
        }
        function mw_getActive() {
            return localStorage.getItem(MW_STORAGE_KEYS.active) || '';
        }

        function mw_renderList() {
            const list = document.getElementById('doc-list');
            const docs = mw_loadDocs();
            const active = mw_getActive();
            list.innerHTML = '';

            // è¿‡æ»¤æ‰å·²åˆ é™¤çš„æ–‡æ¡£
            const visibleDocs = docs.filter(doc => !doc.deletedAt);

            if (!visibleDocs.length) {
                list.innerHTML = '<div style="padding:12px;color:#64748b;font-size:12px;">æš‚æ— æ–‡æ¡£ï¼Œç‚¹å‡»"æ–°å¢"åˆ›å»º</div>';
                return;
            }
            visibleDocs.forEach(doc => {
                const row = document.createElement('div');
                row.className = 'doc-item' + (active === doc.id ? ' active' : '');
                row.innerHTML = `
                    <div class="doc-name" title="${doc.name}">${doc.name}</div>
                    <div class="doc-buttons">
                        <button data-act="export" data-i18n="app.toolbar.export">å¯¼å‡º</button>
                        <button data-act="del" data-i18n="app.node.delete" style="color:#b91c1c;border-color:#fecaca;">åˆ é™¤</button>
                    </div>
                `;
                row.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘æ•´è¡Œç‚¹å‡»
                    if (e.target.tagName === 'BUTTON') return;
                    mw_openDoc(doc.id);
                };
                row.querySelector('[data-act="export"]').onclick = () => mw_exportDocZip(doc.id);
                row.querySelector('[data-act="del"]').onclick = () => mw_deleteDoc(doc.id);
                list.appendChild(row);
            });
            
            // å¯¹æ–°åˆ›å»ºçš„æŒ‰é’®åº”ç”¨å›½é™…åŒ–ç¿»è¯‘
            if (window.i18nManager) {
                window.i18nManager.updatePageTranslations();
            }
        }

        function mw_toggleSidebar(open) {
            const el = document.getElementById('doc-sidebar');
            if (open === true) el.classList.add('open');
            else if (open === false) el.classList.remove('open');
            else el.classList.toggle('open');
            el.setAttribute('aria-hidden', el.classList.contains('open') ? 'false' : 'true');
        }

        function mw_newDoc() {
            const name = prompt('æ–°æ–‡æ¡£åç§°ï¼š', 'æœªå‘½åæ–‡æ¡£');
            if (!name) return;
            const id = 'doc_' + Date.now();
            const doc = {
                id, name,
                md: '# ' + name + '\n',
                images: [], // {name, mime, dataUrl}
                createdAt: Date.now(),
                updatedAt: Date.now(),
                version: 1
            };
            const docs = mw_loadDocs();
            docs.push(doc);
            mw_saveDocs(docs);
            mw_setActive(id);
            mw_renderList();
            mw_notifyEditorLoad(doc);
            try { showSuccess && showSuccess('å·²åˆ›å»ºå¹¶æ‰“å¼€'); } catch (_) { }
        }

        function mw_openDoc(id) {
            const docs = mw_loadDocs();
            const doc = docs.find(d => d.id === id);
            if (!doc) return alert('æ–‡æ¡£ä¸å­˜åœ¨');
            mw_setActive(id);
            mw_renderList();
            // æ‰“å¼€æ—¶ä»¥ Markdown ä¸ºå‡†åŒæ­¥ä¸‰é¢æ¿
            mw_notifyEditorLoad(doc);
            mw_notifyPreviewLoad(doc);
            mw_notifyMindmapLoad(doc);
            // ç«‹å³å…³é—­ä¾§æ å¹¶ç¡®ä¿ç¼–è¾‘å™¨é¢æ¿æ˜¾ç¤ºï¼ˆé¿å… handleTabClick åœ¨éä¸“æ³¨æ¨¡å¼ä¸‹æŠŠç¼–è¾‘å™¨åˆ‡æ¢ä¸ºéšè—ï¼‰
            try { mw_toggleSidebar(false); } catch (_) { }
            try {
                // panels.editor = true;
                saveStateToStorage();
                updateLayout();
                updateTabs();
            } catch (_) { }
        }

        function mw_deleteDoc(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥æ–‡æ¡£ï¼Ÿæ­¤æ“ä½œä¼šåœ¨æ‰€æœ‰è®¾å¤‡ä¸ŠåŒæ­¥åˆ é™¤')) return;
            let docs = mw_loadDocs();
            const idx = docs.findIndex(d => d.id === id);
            if (idx >= 0) {
                // åªä¿ç•™IDå’Œåˆ é™¤ä¿¡æ¯ï¼Œç§»é™¤å…¶ä»–æ•°æ®ä»¥èŠ‚çœç©ºé—´
                docs[idx] = {
                    id: docs[idx].id,
                    name: docs[idx].name,
                    deletedAt: Date.now(),
                    updatedAt: Date.now()
                };
                mw_saveDocs(docs);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡æ¡£
                if (mw_getActive() === id) {
                    // æ¸…ç©ºå½“å‰æ´»åŠ¨æ–‡æ¡£
                    mw_setActive('');

                    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªåˆ é™¤çš„æ–‡æ¡£
                    const activeDoc = docs.find(d => !d.deletedAt);
                    if (activeDoc) {
                        mw_setActive(activeDoc.id);
                        // é€šçŸ¥å„ä¸ªé¢æ¿åŠ è½½ç¬¬ä¸€ä¸ªæœªåˆ é™¤æ–‡æ¡£
                        mw_notifyEditorLoad(activeDoc);
                        mw_notifyPreviewLoad(activeDoc);
                        mw_notifyMindmapLoad(activeDoc);
                    } else {
                        // å¦‚æœæ²¡æœ‰å‰©ä½™æœªåˆ é™¤æ–‡æ¡£ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæœªå‘½åæ–‡æ¡£
                        const newId = 'doc_' + Date.now();
                        const newDoc = {
                            id: newId,
                            name: 'æœªå‘½åæ–‡æ¡£',
                            md: '# æœªå‘½åæ–‡æ¡£\n',
                            images: [],
                            createdAt: Date.now(),
                            updatedAt: Date.now(),
                            version: 1
                        };
                        docs.push(newDoc);
                        mw_saveDocs(docs);
                        mw_setActive(newId);
                        mw_renderList();
                        // é€šçŸ¥å„ä¸ªé¢æ¿åŠ è½½æ–°æ–‡æ¡£
                        mw_notifyEditorLoad(newDoc);
                        mw_notifyPreviewLoad(newDoc);
                        mw_notifyMindmapLoad(newDoc);
                    }
                }

                mw_renderList();
                try { showSuccess && showSuccess('å·²æ ‡è®°ä¸ºåˆ é™¤ï¼Œå°†åœ¨æ‰€æœ‰è®¾å¤‡åŒæ­¥'); } catch (_) { }
            }
        }

        function mw_notifyEditorLoad(doc) {
            const editorIframe = document.querySelector('iframe[data-panel="editor"], iframe#iframe-editor, iframe[src*="editor/editor.html"]');
            const payload = {
                id: doc.id,
                name: doc.name,
                md: doc.md,
                images: doc.images || [],
                aiPlatformConfigs: doc.aiPlatformConfigs || null,
                aiPromptTemplates: doc.aiPromptTemplates || null,
                rev: doc.version || doc.updatedAt || Date.now(),
                origin: 'index'
            };
            if (editorIframe && editorIframe.contentWindow) {
                try {
                    editorIframe.contentWindow.postMessage({ type: 'mw_load_document', payload }, '*');
                    console.log('[DOC] -> editor mw_load_document', payload.id, 'rev=', payload.rev);
                } catch (e) { console.warn('postMessage to editor failed', e); }
            } else {
                // iframe æœªå°±ç»ªï¼Œç¼“å­˜å¾…å‘å†…å®¹ï¼Œonload ç«‹å³æ´¾å‘
                try { window.__mw_pendingEditorDocument = payload; } catch (_) { }
            }
        }

        function mw_notifyPreviewLoad(doc) {
            const previewIframe = document.querySelector('iframe[data-panel="preview"], iframe#iframe-preview, iframe[src*="md2word/md2word.html"], iframe[src*="preview"]');
            const payload = { md: doc.md, images: doc.images || [], rev: doc.version || doc.updatedAt || Date.now(), origin: 'index' };
            if (previewIframe && previewIframe.contentWindow) {
                try {
                    previewIframe.contentWindow.postMessage({ type: 'mw_load_markdown', payload }, '*');
                    console.log('[DOC] -> preview mw_load_markdown', (doc.id || ''), 'rev=', payload.rev);
                } catch (e) { console.warn('postMessage to preview failed', e); }
            } else {
                // iframe å°šæœªå°±ç»ªï¼Œç¼“å­˜å¾…å‘é€æ•°æ®ï¼Œå¾… onload æ—¶ç«‹å³å‘é€
                try { window.__mw_pendingPreviewMarkdown = payload; } catch (_) { }
            }
        }

        function mw_notifyMindmapLoad(doc) {
            const mmIframe = document.querySelector('iframe[data-panel="mindmap"], iframe#iframe-mindmap, iframe[src*="jsmind/mindmap.html"]');
            const payload = { md: doc.md, images: doc.images || [], rev: doc.version || doc.updatedAt || Date.now(), origin: 'index' };
            if (mmIframe && mmIframe.contentWindow) {
                try {
                    mmIframe.contentWindow.postMessage({ type: 'mw_load_markdown', payload }, '*');
                    console.log('[DOC] -> mindmap mw_load_markdown', (doc.id || ''), 'rev=', payload.rev);
                } catch (e) { console.warn('postMessage to mindmap failed', e); }
            }
        }

        // ===== å¯¼å‡ºä¸ºZIPï¼ˆå•æ–‡æ¡£/å…¨éƒ¨ï¼‰ =====
        async function mw_exportDocZip(id) {
            const docs = mw_loadDocs();
            const doc = docs.find(d => d.id === id);
            if (!doc) return alert('æ–‡æ¡£ä¸å­˜åœ¨');
            const zip = new JSZip();
            const safeName = (doc.name || 'document').replace(/[\\/:*?"<>|]+/g, '_');
            const root = zip.folder(safeName);

            // md
            root.file('index.md', doc.md || '');

            // images
            if (doc.images && doc.images.length) {
                const imgFolder = root.folder('images');
                for (const img of doc.images) {
                    const fname = img.name || ('img_' + Date.now() + '.png');
                    // å°† dataURL è½¬ä¸ºäºŒè¿›åˆ¶
                    const blob = await mw_dataUrlToBlob(img.dataUrl || '', img.mime || 'image/png');
                    const ab = await blob.arrayBuffer();
                    imgFolder.file(fname, ab);
                }
            }



            // meta
            root.file('meta.json', JSON.stringify({
                id: doc.id,
                name: doc.name,
                version: doc.version || 1,
                exportedAt: Date.now()
            }, null, 2));

            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, safeName + '.zip');
            try { showSuccess && showSuccess('ZIP å¯¼å‡ºå®Œæˆ'); } catch (_) { }
        }

        async function mw_exportAllZip() {
            const docs = mw_loadDocs();
            if (!docs.length) return alert('æ²¡æœ‰æ–‡æ¡£å¯å¯¼å‡º');
            const zip = new JSZip();

            // åˆ›å»ºAIæ–‡ä»¶å¤¹ï¼ˆä¸æ–‡æ¡£æ–‡ä»¶å¤¹å¹³çº§ï¼‰
            const aiFolder = zip.folder('ai');
            const aiCfg = mw_fetchAIPlatformConfigsSnapshot();
            if (aiCfg) aiFolder.file('platform-configs.json', JSON.stringify(aiCfg, null, 2));
            const tpl = mw_fetchAIPromptTemplatesSnapshot();
            if (tpl) aiFolder.file('prompt-templates.json', JSON.stringify(tpl, null, 2));

            for (const doc of docs) {
                const safeName = (doc.name || 'document').replace(/[\\/:*?"<>|]+/g, '_');
                const root = zip.folder(safeName);
                root.file('index.md', doc.md || '');

                if (doc.images && doc.images.length) {
                    const imgFolder = root.folder('images');
                    for (const img of doc.images) {
                        const fname = img.name || ('img_' + Date.now() + '.png');
                        const blob = await mw_dataUrlToBlob(img.dataUrl || '', img.mime || 'image/png');
                        const ab = await blob.arrayBuffer();
                        imgFolder.file(fname, ab);
                    }
                }

                root.file('meta.json', JSON.stringify({
                    id: doc.id, name: doc.name, version: doc.version || 1
                }, null, 2));
            }
            const blob = await zip.generateAsync({ type: 'blob' });
            saveAs(blob, 'MindWord_AllDocs.zip');
            try { showSuccess && showSuccess('å…¨éƒ¨ ZIP å¯¼å‡ºå®Œæˆ'); } catch (_) { }
        }

        // ===== å¯¼å…¥ZIPï¼ˆæ”¯æŒå¤šæ–‡æ¡£ï¼‰ =====
        async function mw_importZip(file) {
            if (!file) return;
            const zip = await JSZip.loadAsync(file);

            // å…¼å®¹å¤šç§å‹ç¼©å™¨çš„è·¯å¾„æ ¼å¼ï¼šæ”¶é›† zip.files ä¸­çš„æ‰€æœ‰é¡¶çº§æ–‡ä»¶å¤¹ï¼ˆå»é‡ï¼‰
            const topFolderSet = new Set();
            Object.keys(zip.files).forEach(name => {
                if (!name) return;
                const parts = name.split('/');
                if (parts.length > 1 && parts[0].trim()) {
                    topFolderSet.add(parts[0].trim() + '/');
                } else if (name.endsWith('/') && !name.slice(0, -1).includes('/')) {
                    // å…¼å®¹åªæœ‰ç›®å½•æ¡ç›®çš„æƒ…å†µï¼ˆä¾‹å¦‚æŸäº›å·¥å…·ä¼šä»…ä¿ç•™ç›®å½• entryï¼‰
                    topFolderSet.add(name);
                }
            });
            const topFolders = Array.from(topFolderSet);
            const docs = mw_loadDocs();

            // è¯»å–æ ¹çº§ ai é…ç½®ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå¹¶ä¾›æ‰€æœ‰æ–‡æ¡£å¤ç”¨ã€‚
            // è¯´æ˜ï¼šå¯¼å‡ºçš„ AI é…ç½®ç°åœ¨æ”¾åœ¨ ZIP æ ¹ç›®å½•çš„ ai/ æ–‡ä»¶å¤¹ä¸‹ï¼ˆä¸å„æ–‡æ¡£æ–‡ä»¶å¤¹å¹³çº§ï¼‰ã€‚
            let rootAiCfg = null, rootTpl = null;
            try {
                const rootAiFolder = zip.folder('ai');
                if (rootAiFolder) {
                    const cfg = rootAiFolder.file('platform-configs.json');
                    const tpf = rootAiFolder.file('prompt-templates.json');
                    if (cfg) try { rootAiCfg = JSON.parse(await cfg.async('string')); } catch (_) { console.warn('mw_importZip: parse root platform-configs.json failed'); }
                    if (tpf) try { rootTpl = JSON.parse(await tpf.async('string')); } catch (_) { console.warn('mw_importZip: parse root prompt-templates.json failed'); }
                }
            } catch (err) {
                console.warn('mw_importZip: read root ai folder failed', err);
            }

            // è‹¥æ²¡æœ‰é¡¶çº§æ–‡ä»¶å¤¹ï¼Œå°è¯•å•æ–‡æ¡£ï¼ˆç›´æ¥ index.mdï¼‰
            const processOne = async (folderName) => {
                const folder = zip.folder(folderName);
                const mdFile = folder.file('index.md');
                if (!mdFile) return;
                const md = await mdFile.async('string');
                const images = [];
                const imgFolder = folder.folder('images');
                if (imgFolder) {
                    const files = Object.values(imgFolder.files).filter(f => !f.dir);
                    for (const entry of files) {
                        try {
                            const fullName = entry.name || '';
                            const mime = mw_guessMime(fullName);
                            // entry æœ¬èº«å°±æ˜¯ JSZip çš„ file å¯¹è±¡ â€”â€” ç›´æ¥è°ƒç”¨å…¶ async æ–¹æ³•æ›´ç¨³å¥
                            const ab = await entry.async('arraybuffer');
                            const dataUrl = await mw_arrayBufferToDataUrl(ab, mime);
                            // åªä¿ç•™æ–‡ä»¶åï¼Œä¸å¸¦è·¯å¾„
                            const fname = fullName.split('/').pop() || fullName;
                            images.push({ name: fname, mime, dataUrl });
                        } catch (err) {
                            console.warn('mw_importZip: è¯»å–å›¾ç‰‡æ¡ç›®å¤±è´¥ï¼Œå·²è·³è¿‡', entry && entry.name, err);
                        }
                    }
                }
                // AI - ä»…ä½¿ç”¨æ ¹çº§ ai æ–‡ä»¶å¤¹ï¼ˆå¯¼å‡ºå·²å°† AI é…ç½®ç§»è‡³æ ¹çº§ ai/ï¼Œä¸æ–‡æ¡£æ–‡ä»¶å¤¹å¹³çº§ï¼‰
                // ä»ä¸Šå±‚é¢„è¯»å–çš„ rootAiCfg / rootTpl ç›´æ¥å¤ç”¨ï¼ˆé¿å…æŸ¥æ‰¾å·²è¢«ç§»é™¤çš„å­æ–‡ä»¶å¤¹ï¼‰
                let aiCfg = rootAiCfg;
                let tpl = rootTpl;
                // è¯´æ˜ï¼šæ—§çš„å­æ–‡ä»¶å¤¹å…¼å®¹é€»è¾‘å·²å¼ƒç”¨ï¼Œæ•…ä¸å†å°è¯• folder.folder('ai')ï¼Œä»¥é¿å…è¦†ç›–æˆ–è¯»å–å¤±è´¥ã€‚
                const safeName = folderName.replace(/\/$/, '').replace(/[\\/:*?"<>|]+/g, '_');
                const id = 'doc_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                docs.push({
                    id, name: safeName || 'å¯¼å…¥æ–‡æ¡£', md, images,
                    aiPlatformConfigs: aiCfg, aiPromptTemplates: tpl,
                    createdAt: Date.now(), updatedAt: Date.now(), version: 1
                });
            };

            if (topFolders.length) {
                for (const folderName of topFolders) { await processOne(folderName); }
            } else {
                // å°è¯•æ ¹çº§ index.md
                const mdFile = zip.file('index.md');
                if (mdFile) await processOne('');
            }

            mw_saveDocs(docs);
            mw_renderList();
            try { showSuccess && showSuccess('ZIP å¯¼å…¥å®Œæˆ'); } catch (_) { }

            // å¦‚æœè§£æåˆ°äº†æ ¹çº§ AI é…ç½®ï¼Œåˆ™å†™å…¥é¢æ¿æœŸæœ›çš„ localStorage å¹¶å°è¯•åˆ·æ–° AI é¢æ¿
            try {
                if (rootAiCfg) {
                    try { localStorage.setItem('allAIPlatformConfigs', JSON.stringify(rootAiCfg)); } catch (e) { console.warn('[mw_importZip] write allAIPlatformConfigs failed', e); }
                }
                if (rootTpl) {
                    try { localStorage.setItem('promptTemplates', JSON.stringify(rootTpl)); } catch (e) { console.warn('[mw_importZip] write promptTemplates failed', e); }
                }

                // å°è¯•åˆ·æ–°åŒæºçš„ aiModalFrameï¼ˆå¦‚æœå¯è®¿é—®ï¼‰
                try {
                    var af = document.getElementById('aiModalFrame');
                    if (af && af.contentWindow) {
                        try {
                            af.contentWindow.populateSavedPlatformsList && af.contentWindow.populateSavedPlatformsList();
                            af.contentWindow.populateUsagePlatforms && af.contentWindow.populateUsagePlatforms();
                            af.contentWindow.populateTemplateSelect && af.contentWindow.populateTemplateSelect();
                        } catch (e) { console.warn('[mw_importZip] refresh aiModalFrame failed', e); }
                    } else {
                        // å›é€€ï¼šå‘é€ postMessageï¼Œç”± AI é¢æ¿ç›‘å¬å¹¶è‡ªè¡Œå†™å…¥/åˆ·æ–°ï¼ˆè‹¥å·²å®ç°ç›‘å¬ï¼‰
                        window.postMessage({ type: 'IMPORT_AI_FROM_ZIP', payload: { configs: rootAiCfg, templates: rootTpl } }, '*');
                    }
                } catch (e) { console.warn('[mw_importZip] notify ai panel failed', e); }
            } catch (e) {
                console.warn('[mw_importZip] write ai configs failed', e);
            }
        }

        // ===== è¾…åŠ©å‡½æ•° =====
        function mw_extractTitleFromMd(md) {
            try {
                const lines = String(md || '').split(/\r?\n/);
                const first = (lines.find(l => l.trim().length > 0) || '').trim();
                if (!first) return 'æœªå‘½åæ–‡æ¡£';
                const cleaned = first
                    .replace(/^#{1,6}\s*/, '')
                    .replace(/^[-*+]\s+/, '')
                    .replace(/^\d+\.\s+/, '')
                    .trim();
                return cleaned || 'æœªå‘½åæ–‡æ¡£';
            } catch (_) { return 'æœªå‘½åæ–‡æ¡£'; }
        }
        function mw_guessMime(name) {
            const lower = (name || '').toLowerCase();
            if (lower.endsWith('.png')) return 'image/png';
            if (lower.endsWith('.jpg') || lower.endsWith('.jpeg')) return 'image/jpeg';
            if (lower.endsWith('.gif')) return 'image/gif';
            if (lower.endsWith('.webp')) return 'image/webp';
            return 'application/octet-stream';
        }
        async function mw_arrayBufferToDataUrl(ab, mime) {
            const blob = new Blob([ab], { type: mime || 'application/octet-stream' });
            return await new Promise(resolve => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.readAsDataURL(blob);
            });
        }
        async function mw_dataUrlToBlob(dataUrl, mime) {
            if (!dataUrl) return new Blob([], { type: mime || 'application/octet-stream' });
            const arr = dataUrl.split(','), bstr = atob(arr[1]);
            let n = bstr.length, u8 = new Uint8Array(n);
            while (n--) u8[n] = bstr.charCodeAt(n);
            return new Blob([u8], { type: mime || 'application/octet-stream' });
        }

        function mw_fetchAIPlatformConfigsSnapshot() {
            try {
                const frame = document.getElementById('aiModalFrame');
                const ls = frame && frame.contentWindow && frame.contentWindow.localStorage;
                if (!ls) return null;
                const raw = ls.getItem('allAIPlatformConfigs');
                if (!raw) return null;
                const json = JSON.parse(raw);
                return json;
            } catch (_) { return null; }
        }
        function mw_fetchAIPromptTemplatesSnapshot() {
            try {
                return window.__prompt_templates || null;
            } catch (_) { return null; }
        }

        // ===== æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ® =====
        function mw_clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼\n\nç¡®è®¤è¦æ¸…ç©ºä»¥ä¸‹æ•°æ®å—ï¼Ÿ\nâ€¢ æ‰€æœ‰æ–‡æ¡£æ•°æ®\nâ€¢ AIå¹³å°é…ç½®\nâ€¢ æç¤ºè¯æ¨¡æ¿\nâ€¢ ç¼–è¾‘å™¨è®¾ç½®\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚')) {
                try {
                    // æ¸…ç©ºæ‰€æœ‰localStorageæ•°æ®
                    localStorage.clear();

                    // é‡æ–°åˆå§‹åŒ–å¿…è¦çš„æ•°æ®ç»“æ„
                    localStorage.setItem('mindword_docs', '[]');
                    localStorage.setItem('mindword_active_doc_id', '');

                    // åˆ·æ–°ç•Œé¢
                    mw_renderList();

                    // é€šçŸ¥ç¼–è¾‘å™¨æ¸…ç©ºå†…å®¹
                    window.postMessage({ type: 'mw_apply_markdown', payload: { md: '', images: [] } }, '*');

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    try { showSuccess && showSuccess('æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…ç©º'); } catch (_) { }

                    console.log('æ‰€æœ‰æœ¬åœ°æ•°æ®å·²æ¸…ç©º');
                } catch (error) {
                    console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                    try { showError && showError('æ¸…ç©ºæ•°æ®å¤±è´¥: ' + error.message); } catch (_) { }
                }
            }
        }

        // ===== äº‹ä»¶ç»‘å®š =====
        (function initDocSidebar() {
            const btn = document.getElementById('doc-menu-btn');
            const closeBtn = document.getElementById('btn-close-sidebar');
            const newBtn = document.getElementById('btn-new-doc');
            const exportAllBtn = document.getElementById('btn-export-all');
            const importInput = document.getElementById('import-zip-input');
            const importBtn = document.getElementById('btn-import-zip');
            const clearDataBtn = document.getElementById('btn-clear-data');
            const sidebar = document.getElementById('doc-sidebar');

            btn && (btn.onclick = () => { mw_toggleSidebar(); mw_renderList(); });
            closeBtn && (closeBtn.onclick = () => mw_toggleSidebar(false));
            newBtn && (newBtn.onclick = () => mw_newDoc());
            exportAllBtn && (exportAllBtn.onclick = () => mw_exportAllZip());
            importBtn && (importBtn.onclick = () => importInput && importInput.click());
            importInput && importInput.addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (f) mw_importZip(f);
                e.target.value = '';
            });
            clearDataBtn && (clearDataBtn.onclick = () => mw_clearAllData());

            // ä¾§æ»‘æ å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨æ”¶èµ·
            if (sidebar) {
                sidebar.addEventListener('blur', function (e) {
                    // æ£€æŸ¥æ–°çš„ç„¦ç‚¹å…ƒç´ æ˜¯å¦åœ¨ä¾§æ»‘æ å†…éƒ¨
                    setTimeout(() => {
                        const activeElement = document.activeElement;
                        const isFocusInsideSidebar = sidebar.contains(activeElement);
                        const isFocusOnMenuBtn = activeElement === btn;

                        // å¦‚æœç„¦ç‚¹ä¸åœ¨ä¾§æ»‘æ å†…ä¸”ä¸åœ¨èœå•æŒ‰é’®ä¸Šï¼Œåˆ™æ”¶èµ·ä¾§æ»‘æ 
                        if (!isFocusInsideSidebar && !isFocusOnMenuBtn) {
                            mw_toggleSidebar(false);
                        }
                    }, 0);
                });

                // ä¸ºä¾§æ»‘æ å†…çš„å¯äº¤äº’å…ƒç´ æ·»åŠ ç„¦ç‚¹ç®¡ç†
                sidebar.addEventListener('focusin', function (e) {
                    // å½“ä¾§æ»‘æ å†…è·å¾—ç„¦ç‚¹æ—¶ï¼Œç¡®ä¿ä¾§æ»‘æ ä¿æŒæ‰“å¼€çŠ¶æ€
                    if (!sidebar.classList.contains('open')) {
                        mw_toggleSidebar(true);
                    }
                });
            }

            // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸï¼ˆåŒ…æ‹¬iframeï¼‰è‡ªåŠ¨æ”¶èµ·ä¾§æ»‘æ 
            function setupClickOutsideHandler() {
                let isProcessingClick = false;
                
                // å¤„ç†ç‚¹å‡»äº‹ä»¶
                function handleClickOutside(event) {
                    if (isProcessingClick) return;
                    
                    const sidebar = document.getElementById('doc-sidebar');
                    const menuBtn = document.getElementById('doc-menu-btn');
                    
                    if (!sidebar || !sidebar.classList.contains('open')) return;
                    
                    // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨ä¾§æ»‘æ å†…éƒ¨æˆ–èœå•æŒ‰é’®ä¸Š
                    const isClickInsideSidebar = sidebar.contains(event.target);
                    const isClickOnMenuBtn = menuBtn && (event.target === menuBtn || menuBtn.contains(event.target));
                    
                    if (!isClickInsideSidebar && !isClickOnMenuBtn) {
                        isProcessingClick = true;
                        mw_toggleSidebar(false);
                        setTimeout(() => { isProcessingClick = false; }, 100);
                    }
                }
                
                // å¤„ç†çª—å£å¤±ç„¦äº‹ä»¶ï¼ˆå¤„ç†iframeç‚¹å‡»ï¼‰
                function handleWindowBlur() {
                    const sidebar = document.getElementById('doc-sidebar');
                    if (sidebar && sidebar.classList.contains('open')) {
                        // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿iframeç‚¹å‡»è¢«æ•è·
                        setTimeout(() => {
                            mw_toggleSidebar(false);
                        }, 50);
                    }
                }
                
                // ç»‘å®šäº‹ä»¶
                document.addEventListener('click', handleClickOutside, true);
                window.addEventListener('blur', handleWindowBlur);
                
                // è¿”å›æ¸…ç†å‡½æ•°
                return function cleanup() {
                    document.removeEventListener('click', handleClickOutside, true);
                    window.removeEventListener('blur', handleWindowBlur);
                };
            }
            
            // åˆå§‹åŒ–ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå¤„ç†
            const cleanupClickHandler = setupClickOutsideHandler();
            
            // é¡µé¢å¸è½½æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬
            window.addEventListener('beforeunload', cleanupClickHandler);

            // åˆå§‹æ¸²æŸ“ä¸€æ¬¡ï¼ˆä¸å¼ºåˆ¶æ‰“å¼€ï¼‰
            mw_renderList();
        })();

        // ç›‘å¬æ¥è‡ªç¼–è¾‘å™¨çš„æ–‡æ¡£æ›´æ–°æ¶ˆæ¯
        window.addEventListener('message', function (e) {
            const msg = e && e.data;
            if (!msg || typeof msg !== 'object') return;

            // ç¼–è¾‘å™¨è¯·æ±‚å½“å‰æ´»åŠ¨æ–‡æ¡£ï¼ˆå¦‚åˆ·æ–°åï¼‰
            if (msg.type === 'mw_request_active') {
                const activeId = mw_getActive();
                if (!activeId) return;
                const docs = mw_loadDocs();
                const doc = docs.find(d => d.id === activeId);
                if (doc) mw_notifyEditorLoad(doc);
                return;
            }

            // æ¥è‡ª mindmap æˆ–å…¶ä»–å­é¡µé¢ï¼šè¦æ±‚çˆ¶é¡µç»Ÿä¸€åº”ç”¨ä¸€ä»½ Markdown åˆ°â€œå½“å‰æ´»åŠ¨æ–‡æ¡£â€
            // æ•ˆæœï¼šç«‹å³æ›´æ–°æœ¬åœ°æ–‡æ¡£åº“å¹¶åŒæ—¶å¹¿æ’­ç»™ editor / preview / mindmapï¼Œæ— éœ€åˆ·æ–°
            if (msg.type === 'mw_apply_markdown') {
                try {
                    const payload = msg.payload || {};
                    const md = typeof payload.md === 'string' ? payload.md : '';
                    const images = Array.isArray(payload.images) ? payload.images : [];
                    let docs = mw_loadDocs();
                    const activeId = mw_getActive();

                    if (activeId) {
                        const idx = docs.findIndex(d => d.id === activeId);
                        if (idx >= 0) {
                            // è¦†ç›–å½“å‰æ´»åŠ¨æ–‡æ¡£
                            docs[idx].md = md;
                            docs[idx].images = images;
                            docs[idx].updatedAt = Date.now();
                            // ç‰ˆæœ¬è‡ªå¢ï¼ˆæˆ–åˆå§‹åŒ–ï¼‰
                            docs[idx].version = (Number(docs[idx].version || 1) + 1);
                            const newName = mw_extractTitleFromMd(md);
                            if (newName && docs[idx].name !== newName) docs[idx].name = newName;
                            mw_saveDocs(docs);
                            mw_renderList();
                            const doc = docs[idx];
                            // å¹¿æ’­åˆ°ä¸‰ç«¯ï¼ˆæºå¸¦ revï¼‰
                            mw_notifyEditorLoad(doc);
                            mw_notifyPreviewLoad(doc);
                            mw_notifyMindmapLoad(doc);
                            try { showSuccess && showSuccess('æ–‡æ¡£å·²æ›´æ–°'); } catch (_) { }
                            return;
                        }
                    }

                    // æ— æ´»åŠ¨æ–‡æ¡£æˆ–æœªæ‰¾åˆ°ï¼šåˆ›å»ºæ–°çš„å¹¶è®¾ä¸ºæ´»åŠ¨
                    const newId = 'doc_' + Date.now();
                    const name = mw_extractTitleFromMd(md || '');
                    const doc = {
                        id: newId,
                        name,
                        md: md || ('# ' + name + '\n'),
                        images: images,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        version: 1
                    };
                    docs.push(doc);
                    mw_saveDocs(docs);
                    mw_setActive(newId);
                    mw_renderList();
                    // å¹¿æ’­åˆ°ä¸‰ç«¯
                    mw_notifyEditorLoad(doc);
                    // mw_notifyPreviewLoad(doc);
                    // mw_notifyMindmapLoad(doc);
                    try { showSuccess && showSuccess('å·²åˆ›å»ºæ–°æ–‡æ¡£å¹¶åº”ç”¨'); } catch (_) { }
                    return;
                } catch (err) {
                    try { showError && showError('åº”ç”¨ AI å†…å®¹å¤±è´¥'); } catch (_) { }
                    console.warn('[INDEX] mw_apply_markdown failed', err);
                }
            }

        }, { passive: true });

        // ===== ç›‘å¬localStorageä¸­markdownæ•°æ®å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°æ–‡æ¡£æ ‡é¢˜ =====
        let lastMarkdownData = localStorage.getItem('mindword_markdown_data');
        let lastActiveDocId = mw_getActive();

        // æ£€æŸ¥markdownæ•°æ®å˜åŒ–å¹¶æ›´æ–°æ–‡æ¡£æ ‡é¢˜
        function checkMarkdownDataChange() {
            const currentMarkdownData = localStorage.getItem('mindword_markdown_data');
            const currentActiveId = mw_getActive();

            // å¦‚æœæ²¡æœ‰æ´»åŠ¨æ–‡æ¡£ä½†æœ‰markdownæ•°æ®ï¼Œåˆ›å»ºæ–°æ–‡æ¡£
            if (!currentActiveId && currentMarkdownData && currentMarkdownData !== lastMarkdownData) {
                lastMarkdownData = currentMarkdownData;

                const docs = mw_loadDocs();
                const newId = 'doc_' + Date.now();
                const name = mw_extractTitleFromMd(currentMarkdownData) || 'æœªå‘½åæ–‡æ¡£';

                const doc = {
                    id: newId,
                    name,
                    md: currentMarkdownData,
                    images: [],
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    version: 1
                };

                docs.push(doc);
                mw_saveDocs(docs);
                mw_setActive(newId);
                mw_renderList();

                // é€šçŸ¥å„é¢æ¿åŠ è½½æ–°æ–‡æ¡£
                mw_notifyEditorLoad(doc);
                mw_notifyPreviewLoad(doc);
                mw_notifyMindmapLoad(doc);

                try { showSuccess && showSuccess('å·²åˆ›å»ºæ–°æ–‡æ¡£'); } catch (_) { }
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»åŠ¨æ–‡æ¡£ä¸”markdownæ•°æ®å‘ç”Ÿå˜åŒ–
            if (currentActiveId && currentMarkdownData !== lastMarkdownData) {
                lastMarkdownData = currentMarkdownData;

                const docs = mw_loadDocs();
                const idx = docs.findIndex(d => d.id === currentActiveId);

                if (idx >= 0 && currentMarkdownData) {
                    // æ›´æ–°mdå†…å®¹ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
                    docs[idx].md = currentMarkdownData;
                    docs[idx].updatedAt = Date.now();
                    docs[idx].version = (Number(docs[idx].version || 1) + 1);

                    // æå–æ–°æ ‡é¢˜
                    const newName = mw_extractTitleFromMd(currentMarkdownData);

                    // å¦‚æœæ ‡é¢˜å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°æ–‡æ¡£ä¿¡æ¯
                    if (newName && docs[idx].name !== newName) {
                        docs[idx].name = newName;
                    }

                    // ä¿å­˜æ–‡æ¡£åˆ—è¡¨å¹¶åˆ·æ–°æ˜¾ç¤º
                    mw_saveDocs(docs);
                    mw_renderList();

                    try { showSuccess && showSuccess('æ–‡æ¡£å†…å®¹å·²æ›´æ–°'); } catch (_) { }
                }
            }

            // æ£€æŸ¥æ´»åŠ¨æ–‡æ¡£æ˜¯å¦å‘ç”Ÿå˜åŒ–
            if (currentActiveId !== lastActiveDocId) {
                lastActiveDocId = currentActiveId;
                lastMarkdownData = currentMarkdownData;
            }
        }

        // è®¾ç½®localStorageç›‘å¬å™¨
        window.addEventListener('storage', function (e) {
            if (e.key === 'mindword_markdown_data') {
                checkMarkdownDataChange();
            }
        });

        // å®šæœŸæ£€æŸ¥localStorageå˜åŒ–ï¼ˆç”¨äºåŒä¸€é¡µé¢å†…çš„å˜åŒ–ï¼‰
        setInterval(checkMarkdownDataChange, 1000);
    </script>
    <!-- ç™»å½•çŠ¶æ€åˆå§‹åŒ–ä¸åˆ‡æ¢ -->
    <script>
        (function initAuthArea() {
            // æ›¿æ¢ä¸ºä½ çš„å®é™… AppID/AppKeyï¼ˆä¸è¦ä½¿ç”¨ Master Keyï¼‰
            var APP_ID = 'MQ3fZEqOgskJBWGoxOwqG1nT-gzGzoHsz';
            var APP_KEY = 'bhU0peMhrAVKEJ2OQbiFKXwC';

            try {
                if (typeof AV !== 'undefined' && AV && !AV.applicationId) {
                    // ä» LeanCloud æ§åˆ¶å°å¤åˆ¶â€œAPI æœåŠ¡å™¨åœ°å€â€åˆ° SERVER_URLï¼ˆå¿…å¡«ï¼‰
                    var SERVER_URL = 'https://mq3fzeqo.lc-cn-n1-shared.com';
                    if (!SERVER_URL || SERVER_URL.indexOf('http') !== 0) {
                        console.error('[AUTH] LeanCloud SERVER_URL æœªè®¾ç½®ï¼Œè¯·åˆ°æ§åˆ¶å°å¤åˆ¶â€œAPI æœåŠ¡å™¨åœ°å€â€å¹¶æ›¿æ¢å ä½ç¬¦ LEANCLOUD_SERVER_URL');
                    }
                    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });
                }
            } catch (e) {
                console.warn('[AUTH] AV init failed', e);
            }

            function refreshAuthUI() {
                var user = null;
                try {
                    // é¦–å…ˆå°è¯•AV.User.current()
                    user = (typeof AV !== 'undefined' && AV.User && AV.User.current) ? AV.User.current() : null;

                    // å¦‚æœAV.User.current()è¿”å›nullï¼Œå°è¯•ä»localStorageæ‰‹åŠ¨è·å–
                    if (!user) {
                        var appId = 'MQ3fZEqOgskJBWGoxOwqG1nT-gzGzoHsz';
                        var localUserKey = 'AV/' + appId + '/currentUser';
                        var localUserData = localStorage.getItem(localUserKey);

                        if (localUserData) {
                            try {
                                var userObj = JSON.parse(localUserData);
                                if (userObj && userObj.objectId) {
                                    // åˆ›å»ºæ¨¡æ‹Ÿç”¨æˆ·å¯¹è±¡
                                    user = {
                                        id: userObj.objectId,
                                        username: userObj.username,
                                        email: userObj.email,
                                        get: function (key) {
                                            return userObj[key];
                                        }
                                    };
                                    console.log('[AUTH] ä»localStorageæ¢å¤ç”¨æˆ·:', userObj.username);
                                }
                            } catch (e) {
                                console.warn('[AUTH] è§£ææœ¬åœ°ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                } catch (_) { }

                var link = document.getElementById('auth-link');
                var userBox = document.getElementById('auth-user');
                var nameSpan = document.getElementById('auth-username');

                if (user && userBox && nameSpan) {
                    // ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨user.usernameï¼Œå› ä¸ºlocalStorageä¸­çš„æ•°æ®usernameåœ¨æ ¹å¯¹è±¡
                    var username = user.username || (user.get && (user.get('username') || user.get('email'))) || 'å·²ç™»å½•';
                    nameSpan.textContent = username;
                    // åŒæ—¶æ›´æ–°èœå•ä¸­çš„ç”¨æˆ·å
                    var menuUsername = document.getElementById('menu-username');
                    if (menuUsername) menuUsername.textContent = username;
                    // ç™»å½•åéšè—"æ³¨å†Œ/ç™»å½•"æŒ‰é’®ï¼Œæ˜¾ç¤ºç”¨æˆ·åŒºåŸŸ
                    if (link) link.style.display = 'none';
                    userBox.style.display = 'inline-flex';
                    console.log('[AUTH] ç”¨æˆ·å·²ç™»å½•:', username);
                } else {
                    if (link) link.style.display = 'inline-flex';
                    if (userBox) userBox.style.display = 'none';
                    console.log('[AUTH] ç”¨æˆ·æœªç™»å½•æˆ–è·å–å¤±è´¥');
                }
            }

            // é€€å‡ºç™»å½•
            try {
                var logoutBtn = document.getElementById('auth-logout');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function () {
                        // åˆ›å»ºè‡ªå®šä¹‰å¯¹è¯æ¡†
                        var dialogHtml = `
                            <div id="logout-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                                <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 400px; text-align: center;">
                                    <h3 style="margin: 0 0 16px 0; color: #333;">ç¡®è®¤é€€å‡ºç™»å½•</h3>
                                    <p style="margin: 0 0 24px 0; color: #666;">è¯·é€‰æ‹©å¯¹æœ¬åœ°æ•°æ®çš„å¤„ç†æ–¹å¼ï¼š</p>
                                    <div style="display: flex; gap: 12px; justify-content: center;">
                                        <button id="logout-save" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                                        <button id="logout-nosave" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¸ä¿å­˜</button>
                                        <button id="logout-cancel" style="padding: 8px 16px; background: #9e9e9e; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        `;

                        // æ·»åŠ å¯¹è¯æ¡†åˆ°é¡µé¢
                        document.body.insertAdjacentHTML('beforeend', dialogHtml);
                        var dialog = document.getElementById('logout-dialog');

                        // å¤„ç†æŒ‰é’®ç‚¹å‡»
                        function handleLogoutChoice(choice) {
                            // ç§»é™¤å¯¹è¯æ¡†
                            if (dialog) dialog.remove();

                            // å¦‚æœç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œç›´æ¥è¿”å›
                            if (choice === 'cancel') {
                                console.log('[AUTH] ç”¨æˆ·å–æ¶ˆé€€å‡ºç™»å½•');
                                return;
                            }

                            // æ‰§è¡Œé€€å‡ºç™»å½•
                            try {
                                if (typeof AV !== 'undefined' && AV && AV.User && AV.User.logOut) {
                                    AV.User.logOut().then(function () {
                                        try { showSuccess && showSuccess('å·²é€€å‡ºç™»å½•'); } catch (_) { }

                                        // æ¸…ç†ç”¨æˆ·ç›¸å…³æ•°æ®
                                        var appId = 'MQ3fZEqOgskJBWGoxOwqG1nT-gzGzoHsz';
                                        localStorage.removeItem('AV/' + appId + '/currentUser');
                                        localStorage.removeItem('AV/' + appId + '/subscriptionId');

                                        // æ ¹æ®ç”¨æˆ·é€‰æ‹©å¤„ç†æœ¬åœ°æ•°æ®
                                        if (choice === 'nosave') {
                                            // ä¸ä¿å­˜æ¨¡å¼ï¼šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ç”¨æˆ·æ•°æ®å’Œæ–‡æ¡£æ•°æ®ï¼‰
                                            var keysToKeep = []; // ä¸ä¿ç•™ä»»ä½•æ•°æ®
                                            var keysToRemove = [];

                                            for (var i = 0; i < localStorage.length; i++) {
                                                var key = localStorage.key(i);
                                                if (keysToKeep.indexOf(key) === -1) {
                                                    keysToRemove.push(key);
                                                }
                                            }

                                            keysToRemove.forEach(function (key) {
                                                localStorage.removeItem(key);
                                            });

                                            console.log('[AUTH] å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆåŒ…æ‹¬æ–‡æ¡£æ•°æ®ï¼‰');
                                            try { showSuccess && showSuccess('å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®'); } catch (_) { }
                                        } else if (choice === 'save') {
                                            // ä¿å­˜æ¨¡å¼ï¼šåªæ¸…é™¤ç”¨æˆ·æ•°æ®ï¼Œä¿ç•™æ‰€æœ‰æ–‡æ¡£æ•°æ®
                                            console.log('[AUTH] ä¿ç•™æ‰€æœ‰æœ¬åœ°æ–‡æ¡£æ•°æ®');
                                            try { showSuccess && showSuccess('å·²ä¿ç•™æ‰€æœ‰æœ¬åœ°æ–‡æ¡£æ•°æ®'); } catch (_) { }
                                        }

                                        refreshAuthUI();
                                        // åˆ·æ–°å…¨é¡µï¼Œç¡®ä¿ iframe å­é¡µä¹Ÿæ„ŸçŸ¥çŠ¶æ€
                                        setTimeout(function () { location.reload(); }, 250);
                                    }).catch(function (err) {
                                        console.warn('[AUTH] logout failed', err);
                                        try { showError && showError('é€€å‡ºå¤±è´¥ï¼š' + (err && err.message ? err.message : 'æœªçŸ¥é”™è¯¯')); } catch (_) { }
                                    });
                                }
                            } catch (e) { console.warn('[AUTH] logout error', e); }
                        }

                        // ç»‘å®šæŒ‰é’®äº‹ä»¶
                        document.getElementById('logout-save').addEventListener('click', function () { handleLogoutChoice('save'); });
                        document.getElementById('logout-nosave').addEventListener('click', function () { handleLogoutChoice('nosave'); });
                        document.getElementById('logout-cancel').addEventListener('click', function () { handleLogoutChoice('cancel'); });

                        // ç‚¹å‡»èƒŒæ™¯ä¹Ÿå¯ä»¥å–æ¶ˆ
                        dialog.addEventListener('click', function (e) {
                            if (e.target === dialog) {
                                handleLogoutChoice('cancel');
                            }
                        });
                    });
                }
            } catch (e) { console.warn(e); }

            // é¦–æ¬¡æ¸²æŸ“
            refreshAuthUI();
            // åˆ·æ–°äº‘åŒæ­¥UIï¼ˆå¦‚æœå·²åŠ è½½è„šæœ¬ï¼‰
            try { if (typeof window.__mw_initCloudSyncUI === 'function') window.__mw_initCloudSyncUI(); } catch (_) { }

            // å»¶è¿Ÿé‡è¯•ï¼Œç¡®ä¿LeanCloud SDKå®Œå…¨åˆå§‹åŒ–
            setTimeout(function () {
                console.log('[AUTH] å»¶è¿Ÿåˆ·æ–°è®¤è¯çŠ¶æ€');
                refreshAuthUI();
            }, 1000);

            // å¦‚æœç”¨æˆ·ä»ç™»å½•é¡µé¢è¿”å›ï¼Œå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
            if (document.referrer && document.referrer.includes('auth.html')) {
                setTimeout(function () {
                    console.log('[AUTH] ä»ç™»å½•é¡µé¢è¿”å›ï¼Œå†æ¬¡åˆ·æ–°è®¤è¯çŠ¶æ€');
                    refreshAuthUI();
                }, 2000);
            }

            // ä¸ªäººèœå•ä¸‹æ‹‰åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒç‚¹å‡»å¤–éƒ¨åŒºåŸŸè‡ªåŠ¨å…³é—­ï¼ŒåŒ…æ‹¬iframeï¼‰
            try {
                const userDropdown = document.querySelector('.user-dropdown');
                const userMenuDropdown = document.querySelector('.user-menu-dropdown');
                const dropdownArrow = document.querySelector('.dropdown-arrow');
                
                if (userDropdown && userMenuDropdown) {
                    // ç‚¹å‡»ç”¨æˆ·åæˆ–ç®­å¤´å±•å¼€/æ”¶èµ·èœå•
                    userDropdown.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const isVisible = userMenuDropdown.style.display === 'block';
                        userMenuDropdown.style.display = isVisible ? 'none' : 'block';
                        if (dropdownArrow) {
                            dropdownArrow.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
                        }
                        
                        // å¦‚æœèœå•æ‰“å¼€ï¼Œè®¾ç½®ç‚¹å‡»å¤–éƒ¨å…³é—­å¤„ç†
                        if (!isVisible) {
                            setupUserMenuClickOutsideHandler();
                        } else {
                            removeUserMenuClickOutsideHandler();
                        }
                    });
                    
                    // ç‚¹å‡»èœå•å†…éƒ¨ä¸å…³é—­èœå•
                    userMenuDropdown.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // èœå•é¡¹æ‚¬åœæ•ˆæœ
                    const menuItems = userMenuDropdown.querySelectorAll('.menu-item');
                    menuItems.forEach(item => {
                        item.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = '#f8fafc';
                        });
                        item.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = 'transparent';
                        });
                    });
                    
                    // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸè‡ªåŠ¨å…³é—­èœå•ï¼ˆå¢å¼ºç‰ˆï¼Œæ”¯æŒiframeï¼‰
                    let userMenuClickOutsideHandler = null;
                    let userMenuWindowBlurHandler = null;
                    
                    function setupUserMenuClickOutsideHandler() {
                        if (userMenuClickOutsideHandler) return; // é¿å…é‡å¤ç»‘å®š
                        
                        let isProcessingClick = false;
                        
                        // å¤„ç†ç‚¹å‡»äº‹ä»¶
                        userMenuClickOutsideHandler = function(event) {
                            if (isProcessingClick) return;
                            
                            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨èœå•å†…éƒ¨æˆ–è§¦å‘æŒ‰é’®ä¸Š
                            const isClickInsideMenu = userMenuDropdown.contains(event.target);
                            const isClickOnDropdown = userDropdown.contains(event.target);
                            
                            if (!isClickInsideMenu && !isClickOnDropdown) {
                                isProcessingClick = true;
                                closeUserMenu();
                                setTimeout(() => { isProcessingClick = false; }, 100);
                            }
                        };
                        
                        // å¤„ç†çª—å£å¤±ç„¦äº‹ä»¶ï¼ˆå¤„ç†iframeç‚¹å‡»ï¼‰
                        userMenuWindowBlurHandler = function() {
                            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿iframeç‚¹å‡»è¢«æ•è·
                            setTimeout(() => {
                                closeUserMenu();
                            }, 50);
                        };
                        
                        // ç»‘å®šäº‹ä»¶ï¼ˆä½¿ç”¨æ•è·é˜¶æ®µç¡®ä¿ä¼˜å…ˆå¤„ç†ï¼‰
                        document.addEventListener('click', userMenuClickOutsideHandler, true);
                        window.addEventListener('blur', userMenuWindowBlurHandler);
                    }
                    
                    function removeUserMenuClickOutsideHandler() {
                        if (userMenuClickOutsideHandler) {
                            document.removeEventListener('click', userMenuClickOutsideHandler, true);
                            userMenuClickOutsideHandler = null;
                        }
                        if (userMenuWindowBlurHandler) {
                            window.removeEventListener('blur', userMenuWindowBlurHandler);
                            userMenuWindowBlurHandler = null;
                        }
                    }
                    
                    function closeUserMenu() {
                        userMenuDropdown.style.display = 'none';
                        if (dropdownArrow) {
                            dropdownArrow.style.transform = 'rotate(0deg)';
                        }
                        removeUserMenuClickOutsideHandler();
                    }
                    
                    // æ·»åŠ ESCé”®å…³é—­èœå•æ”¯æŒ
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape' && userMenuDropdown.style.display === 'block') {
                            closeUserMenu();
                        }
                    });
                }
            } catch (e) {
                console.warn('[AUTH] ä¸ªäººèœå•åˆå§‹åŒ–å¤±è´¥:', e);
            }
        })();
    </script>

    <script>
        (function () {
            const LANG_KEY = 'mw_lang';
            function getLang() { try { return localStorage.getItem(LANG_KEY) || 'zh'; } catch (_) { return 'zh'; } }
            function applyLangToUI() {
                const lang = getLang();
                const authUser = document.getElementById('auth-user');
                const enCtrls = document.getElementById('cloud-sync-controls');
                const zhCtrls = document.getElementById('lc-sync-controls');
                const enMenuCtrls = document.getElementById('cloud-sync-controls-menu');
                const zhMenuCtrls = document.getElementById('lc-sync-controls-menu');
                if (!authUser || authUser.style.display === 'none') return;
                if (lang === 'zh') { 
                    if (enCtrls) enCtrls.style.display = 'none'; 
                    if (zhCtrls) zhCtrls.style.display = 'inline-flex';
                    if (enMenuCtrls) enMenuCtrls.style.display = 'none';
                    if (zhMenuCtrls) zhMenuCtrls.style.display = 'flex';
                }
                else { 
                    if (enCtrls) enCtrls.style.display = 'inline-flex'; 
                    if (zhCtrls) zhCtrls.style.display = 'none';
                    if (enMenuCtrls) enMenuCtrls.style.display = 'flex';
                    if (zhMenuCtrls) zhMenuCtrls.style.display = 'none';
                }
            }
            document.addEventListener('DOMContentLoaded', function () {
                var sel = document.getElementById('lang-switch');
                if (sel) {
                    try { sel.value = getLang(); } catch (_) { }
                    sel.addEventListener('change', function () {
                        try { localStorage.setItem(LANG_KEY, sel.value); } catch (_) { }
                        applyLangToUI();
                    });
                }
                applyLangToUI();
                window.addEventListener('storage', function (e) { if (e.key && e.key.startsWith('AV/')) setTimeout(applyLangToUI, 200); });
                window.__mw_applyLangToUI = applyLangToUI;
                
                // åˆå§‹åŒ–i18nç®¡ç†å™¨
                if (window.i18nManager) {
                    window.i18nManager.init();
                    // åŒæ­¥è¯­è¨€é€‰æ‹©å™¨çŠ¶æ€
                    const currentLang = window.i18nManager.getCurrentLanguage();
                    if (sel) sel.value = currentLang;
                }
            });
        })();
    </script>
    <!-- æœ¬åœ°å­˜å‚¨ä¿®æ”¹æ—¶é—´ç›‘å¬å™¨ -->
    <script>
        // ç›‘å¬AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿çš„ä¿®æ”¹ï¼Œè‡ªåŠ¨è®°å½•ä¿®æ”¹æ—¶é—´ï¼ˆç®€æ´æ— é‡å¤ç‰ˆï¼‰
        
            // ç®€å•çš„å“ˆå¸Œå‡½æ•°
            function simpleHash(str) {
                let hash = 0;
                if (!str || str.length === 0) return hash.toString(36);
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            
            let isUpdatingModifiedTime = false;

            // æ›´æ–°AIé…ç½®çš„ä¿®æ”¹æ—¶é—´
            function updateAIConfigModifiedTime(newValue) {
                if (isUpdatingModifiedTime) return;
                
                try {
                    const newHash = newValue ? simpleHash(newValue) : '';
                    const storedHash = localStorage.getItem('allAIPlatformConfigs_hash') || '';
                    
                    if (newHash !== storedHash) {
                        console.log(`[Storage Listener] AIé…ç½®å“ˆå¸Œå˜åŒ–: ${storedHash} -> ${newHash}`);
                        
                        isUpdatingModifiedTime = true;
                        localStorage.setItem('allAIPlatformConfigs_hash', newHash);
                        localStorage.setItem('allAIPlatformConfigs_last_modified', Date.now().toString());
                        isUpdatingModifiedTime = false;
                        
                       
                        
                        console.log('[Storage Listener] AIé…ç½®å†…å®¹å˜åŒ–ï¼Œå·²æ›´æ–°ä¿®æ”¹æ—¶é—´å’Œå“ˆå¸Œ');
                    }
                } catch (e) {
                    isUpdatingModifiedTime = false;
                    console.warn('[Storage Listener] æ›´æ–°AIé…ç½®ä¿®æ”¹æ—¶é—´å¤±è´¥:', e);
                }
            }

            // æ›´æ–°æç¤ºè¯æ¨¡æ¿çš„ä¿®æ”¹æ—¶é—´
            function updatePromptTemplatesModifiedTime(newValue) {
                if (isUpdatingModifiedTime) return;
                
                try {
                    const newHash = newValue ? simpleHash(newValue) : '';
                    const storedHash = localStorage.getItem('promptTemplates_hash') || '';
                    
                    if (newHash !== storedHash) {
                        console.log(`[Storage Listener] æç¤ºè¯æ¨¡æ¿å“ˆå¸Œå˜åŒ–: ${storedHash} -> ${newHash}`);
                        
                        isUpdatingModifiedTime = true;
                        localStorage.setItem('promptTemplates_hash', newHash);
                        localStorage.setItem('promptTemplates_last_modified', Date.now().toString());
                        isUpdatingModifiedTime = false;
                        
                       
                        
                        // console.log('[Storage Listener] æç¤ºè¯æ¨¡æ¿å†…å®¹å˜åŒ–ï¼Œå·²æ›´æ–°ä¿®æ”¹æ—¶é—´å’Œå“ˆå¸Œ');
                    }
                } catch (e) {
                    isUpdatingModifiedTime = false;
                    // console.warn('[Storage Listener] æ›´æ–°æç¤ºè¯æ¨¡æ¿ä¿®æ”¹æ—¶é—´å¤±è´¥:', e);
                }
            }

            // // ç»Ÿä¸€çš„å…¥å£å‡½æ•°ï¼Œæ ¹æ®keyåˆ†å‘åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°
            // function updateModifiedTimeIfChanged(key, newValue) {
            //     if (key === 'allAIPlatformConfigs') {
            //         updateAIConfigModifiedTime(newValue);
            //     } else if (key === 'promptTemplates') {
            //         updatePromptTemplatesModifiedTime(newValue);
            //     }
            // }

            // // é‡å†™localStorage.setItemï¼ˆåªé‡å†™ä¸€æ¬¡ï¼Œé¿å…é‡å¤ï¼‰
            // if (!window.__mw_storageListenerInitialized) {
            //     const originalSetItem = localStorage.setItem;
                
            //     localStorage.setItem = function(key, value) {
            //         // é¿å…é€’å½’è°ƒç”¨
            //         if (isUpdatingModifiedTime || key.endsWith('_last_modified')) {
            //             return originalSetItem.call(this, key, value);
            //         }
                    
            //         // è°ƒç”¨åŸå§‹æ–¹æ³•
            //         const result = originalSetItem.call(this, key, value);
                    
            //         // ç«‹å³æ£€æµ‹ï¼ˆåˆ†ç¦»å¤„ç†ï¼Œé¿å…æ··æ·†ï¼‰
            //         if (key === 'allAIPlatformConfigs') {
            //             updateAIConfigModifiedTime(value);
            //         } else if (key === 'promptTemplates') {
            //             updatePromptTemplatesModifiedTime(value);
            //         }
                    
            //         return result;
            //     };
                
            //     window.__mw_storageListenerInitialized = true;
            // }

            // ç›‘å¬è·¨é¡µé¢çš„storageäº‹ä»¶ï¼ˆåªç»‘å®šä¸€æ¬¡ï¼‰
            if (!window.__mw_storageEventBound) {
                window.addEventListener('storage', function(e) {
                    if (e.key === 'allAIPlatformConfigs') {
                        console.log('[Storage Listener] æ£€æµ‹åˆ°è·¨é¡µé¢AIé…ç½®å˜åŒ–');
                        updateAIConfigModifiedTime(e.newValue);
                    } else if (e.key === 'promptTemplates') {
                        console.log('[Storage Listener] æ£€æµ‹åˆ°è·¨é¡µé¢æç¤ºè¯æ¨¡æ¿å˜åŒ–');
                        updatePromptTemplatesModifiedTime(e.newValue);
                    }
                });
                window.__mw_storageEventBound = true;
            }

            // // åˆå§‹åŒ–å“ˆå¸Œå€¼ï¼ˆåªåˆå§‹åŒ–ä¸€æ¬¡ï¼‰
            // function initializeHashes() {
            //     if (window.__mw_hashesInitialized) return;
                
            //     try {
            //         // ä»localStorageè¯»å–å·²ä¿å­˜çš„å“ˆå¸Œå€¼ä½œä¸ºåŸºå‡†
            //         const savedAIConfigHash = localStorage.getItem('allAIPlatformConfigs_hash') || '';
            //         const savedPromptTemplatesHash = localStorage.getItem('promptTemplates_hash') || '';
                    
            //         // è®¡ç®—å½“å‰æ•°æ®çš„å“ˆå¸Œå€¼
            //         const aiConfig = localStorage.getItem('allAIPlatformConfigs');
            //         const currentAIConfigHash = aiConfig ? simpleHash(aiConfig) : '';
                    
            //         const promptTemplates = localStorage.getItem('promptTemplates');
            //         const currentPromptTemplatesHash = promptTemplates ? simpleHash(promptTemplates) : '';
                    
            //         console.log('[Storage Listener] åˆå§‹åŒ–æ£€æµ‹:', {
            //             aiConfig: { saved: savedAIConfigHash, current: currentAIConfigHash },
            //             promptTemplates: { saved: savedPromptTemplatesHash, current: currentPromptTemplatesHash }
            //         });
                    
            //         // åªåœ¨æœ‰æ•°æ®ä¸”å“ˆå¸Œä¸åŒ¹é…æ—¶ï¼Œæ‰è®¤ä¸ºæ•°æ®å‘ç”Ÿäº†å˜åŒ–
            //         // å¦‚æœsavedHashä¸ºç©ºï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œä¸åº”è¯¥è§¦å‘ä¿®æ”¹æ—¶é—´æ›´æ–°
            //         if (currentAIConfigHash && savedAIConfigHash && currentAIConfigHash !== savedAIConfigHash) {
            //             console.log('[Storage Listener] æ£€æµ‹åˆ°AIé…ç½®æ•°æ®å˜åŒ–ï¼Œæ›´æ–°ä¿®æ”¹æ—¶é—´');
            //             localStorage.setItem('allAIPlatformConfigs_hash', currentAIConfigHash);
            //             localStorage.setItem('allAIPlatformConfigs_last_modified', Date.now().toString());
            //         }
                    
            //         if (currentPromptTemplatesHash && savedPromptTemplatesHash && currentPromptTemplatesHash !== savedPromptTemplatesHash) {
            //             console.log('[Storage Listener] æ£€æµ‹åˆ°æç¤ºè¯æ¨¡æ¿æ•°æ®å˜åŒ–ï¼Œæ›´æ–°ä¿®æ”¹æ—¶é—´');
            //             localStorage.setItem('promptTemplates_hash', currentPromptTemplatesHash);
            //             localStorage.setItem('promptTemplates_last_modified', Date.now().toString());
            //         }
                    
            //         // æ›´æ–°å†…å­˜ç¼“å­˜
            //         lastAIConfigHash = currentAIConfigHash;
            //         lastPromptTemplatesHash = currentPromptTemplatesHash;
                    
            //         window.__mw_hashesInitialized = true;
            //     } catch (e) {
            //         console.warn('[Storage Listener] åˆå§‹åŒ–å“ˆå¸Œå€¼å¤±è´¥:', e);
            //     }
            // }

            // // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            // if (document.readyState === 'loading') {
            //     document.addEventListener('DOMContentLoaded', initializeHashes);
            // } else {
            //     initializeHashes();
            // }
            
            // console.log('[Storage Listener] AIé…ç½®å’Œæç¤ºè¯æ¨¡æ¿ä¿®æ”¹æ—¶é—´ç›‘å¬å™¨å·²å¯åŠ¨ï¼ˆç®€æ´æ— é‡å¤ç‰ˆï¼‰');
        
    </script>
    <!-- äº‘åŒæ­¥é€»è¾‘è„šæœ¬ï¼ˆè‹±æ–‡æ–¹æ¡ˆï¼šCloudflare Worker/R2ï¼‰ -->
    <script src="cloud-sync.js"></script>
    <!-- ä¸­æ–‡æ–¹æ¡ˆï¼šLeanCloud Data åŒæ­¥è„šæœ¬ -->
    <script src="leancloud-sync.js"></script>
</body>

</html>