<!DOCTYPE html>
<html>
<head>
    <title>测试自动清理未命名文档</title>
</head>
<body>
    <h1>测试自动清理未命名文档功能</h1>
    <button onclick="testCleanup()">运行测试</button>
    <div id="result"></div>

    <script>
        // 模拟用户提供的JSON数据
        const testDocs = [
            {
                "id": "doc_1761816582996",
                "name": "未命名文档",
                "md": "# 未命名文档\n",
                "images": [],
                "createdAt": 1761816582996,
                "updatedAt": 1761827080679,
                "version": 6
            },
            {
                "id": "doc_1761806580454",
                "name": "未命名文档",
                "md": "# 未命名文档\n",
                "updatedAt": 1761806580478
            },
            {
                "id": "doc_1761740294479_627",
                "name": "欢迎使用 MindWord",
                "deletedAt": 1761826826049,
                "updatedAt": 1761826826049
            },
            {
                "id": "doc_1761740294547_818",
                "name": "BI基础概念",
                "md": "# BI基础概念\n\n这是一些真实的内容",
                "createdAt": 1761740294547,
                "updatedAt": 1761827000000
            }
        ];

        // 模拟localStorage
        const localStorage = {
            data: {},
            setItem: function(key, value) {
                this.data[key] = value;
            },
            getItem: function(key) {
                return this.data[key] || null;
            }
        };

        // 模拟mw_loadDocs函数
        function mw_loadDocs() {
            const docsJson = localStorage.getItem('mindword_docs');
            return docsJson ? JSON.parse(docsJson) : [];
        }

        // 模拟mw_saveDocs函数
        function mw_saveDocs(docs) {
            localStorage.setItem('mindword_docs', JSON.stringify(docs));
        }

        // 模拟isAutoGeneratedEmptyDoc函数
        function isAutoGeneratedEmptyDoc(doc) {
            return doc.name === "未命名文档" && 
                   doc.md === "# 未命名文档\n" && 
                   (!doc.images || doc.images.length === 0);
        }

        // 复制app.html中的清理函数
        function mw_cleanAutoGeneratedEmptyDocs() {
            const docs = mw_loadDocs();
            const hasRealDocs = docs.some(doc => !doc.deletedAt && !isAutoGeneratedEmptyDoc(doc));
            
            if (hasRealDocs) {
                // 如果有真实文档，删除所有自动生成的空文档
                const cleanedDocs = docs.filter(doc => !isAutoGeneratedEmptyDoc(doc));
                if (cleanedDocs.length !== docs.length) {
                    mw_saveDocs(cleanedDocs);
                    console.log('自动清理了', docs.length - cleanedDocs.length, '个自动生成的空文档');
                    return true;
                }
            }
            return false;
        }

        function testCleanup() {
            // 设置测试数据
            mw_saveDocs(testDocs);
            
            console.log('测试前的文档数量:', mw_loadDocs().length);
            console.log('测试前的文档:', mw_loadDocs());
            
            // 运行清理函数
            const cleaned = mw_cleanAutoGeneratedEmptyDocs();
            
            const resultDiv = document.getElementById('result');
            const afterCleanup = mw_loadDocs();
            
            console.log('清理结果:', cleaned);
            console.log('清理后的文档数量:', afterCleanup.length);
            console.log('清理后的文档:', afterCleanup);
            
            resultDiv.innerHTML = `
                <h3>测试结果：</h3>
                <p>是否执行了清理: ${cleaned ? '是' : '否'}</p>
                <p>清理前文档数量: ${testDocs.length}</p>
                <p>清理后文档数量: ${afterCleanup.length}</p>
                <p>清理的未命名文档数量: ${testDocs.length - afterCleanup.length}</p>
                <h4>剩余的文档：</h4>
                <ul>
                    ${afterCleanup.map(doc => `<li>${doc.name} (${doc.id})</li>`).join('')}
                </ul>
            `;
        }
    </script>
</body>
</html>