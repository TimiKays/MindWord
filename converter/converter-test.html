<!--
 * MindWord - æ ‘å¿ƒ | åƒç”»å›¾ä¸€æ ·å†™æ–‡æ¡£çš„æ€ç»´å¯¼å›¾å†™ä½œå·¥å…·
 * GitHub: https://github.com/TimiKays/MindWord
 * 
 * Copyright 2025 Timi Kays
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½¬æ¢å™¨æµ‹è¯• - ä¸‰åŒºåŸŸå¸ƒå±€ v1.5</title>
    <!-- å•Šï¼Œæˆ‘å¿˜è®°å¼•å…¥ jsmind äº† -->
    <link type="text/css" rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/style/jsmind.css" />
    <link rel="stylesheet" href="main.css" />
</head>

<body>
    <div class="header">
        <h1>ğŸ”„ è½¬æ¢å™¨æµ‹è¯• - ä¸‰åŒºåŸŸå®æ—¶åŒæ­¥</h1>
    </div>

    <div class="controls">
        <button class="btn" onclick="convertMdToAst()">ğŸ“„ â†’ ğŸŒ³ (mdâ†’AST)</button>
        <button class="btn" onclick="convertAstToMd()">ğŸ“„ â† ğŸŒ³ (ASTâ†’md)</button>
        <button class="btn" onclick="convertAstToNode()">ğŸŒ³ â†’ ğŸ§  (ASTâ†’node)</button>
        <button class="btn" onclick="convertNodeToAst()">ğŸŒ³ â† ğŸ§  (nodeâ†’AST)</button>
        <button class="btn" onclick="viewMindmap()" style="background: #9b59b6; margin-left: 10px;">æŸ¥çœ‹æ€ç»´å¯¼å›¾</button>

        <button class="btn" onclick="importMarkdown()" style="background: #27ae60;">å¯¼å…¥MD</button>
        <button class="btn" onclick="downloadCurrentMarkdown()" style="background: #3498db;">ä¸‹è½½MD</button>
        <button class="btn" onclick="downloadCurrentAst()" style="background: #9b59b6;">ä¸‹è½½AST</button>
        <button class="btn" onclick="downloadCurrentNodeTree()" style="background: #e67e22;">ä¸‹è½½NodeTree</button>

        <input type="file" id="markdownFileInput" accept=".md,.txt" style="display: none;"
            onchange="handleMarkdownFile(event)">
    </div>

    <div class="main-container">
        <!-- å·¦ä¾§ï¼šMarkdown -->
        <div class="panel">
            <div class="panel-header">ğŸ“„ Markdown ç¼–è¾‘å™¨</div>
            <div class="panel-content">
                <textarea class="panel-textarea" id="markdownInput" placeholder="è¾“å…¥æˆ–ç²˜è´´Markdownå†…å®¹..."></textarea>
                <div class="sample-buttons">
                    <button class="sample-btn" onclick="loadSample('simple')">ç®€å•ç¤ºä¾‹</button>
                    <button class="sample-btn" onclick="loadSample('complex')">å¤æ‚ç¤ºä¾‹</button>
                    <button class="sample-btn" onclick="loadSample('heading')">æ ‡é¢˜ç¤ºä¾‹</button>
                </div>
                <div id="markdownStats" class="stats" style="display: none;"></div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šAST JSON -->
        <div class="panel">
            <div class="panel-header">ğŸŒ³ AST ç»“æ„ (JSON)</div>
            <div class="panel-content">
                <textarea class="panel-textarea" id="astOutput" placeholder="ASTç»“æ„å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div id="astStats" class="stats" style="display: none;"></div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šNode-Tree -->
        <div class="panel">
            <div class="panel-header">ğŸ§  Node-Tree ç»“æ„</div>
            <div class="panel-content">
                <textarea class="panel-textarea" id="nodeTreeOutput" placeholder="Node-treeç»“æ„å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div id="nodeTreeStats" class="stats" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- æ€ç»´å¯¼å›¾iframeå¼¹çª— -->
    <div id="mindmapModal" class="mindmap-modal">
        <div class="mindmap-container">
            <div class="mindmap-header">
                <h2>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="btn" onclick="syncMindmapToMarkdown()"
                        style="background: #27ae60; padding: 5px 10px; font-size: 12px;">åŒæ­¥åˆ°Markdown</button>
                    <button class="btn" onclick="loadNodeTree()"
                        style="background: #3498db; padding: 5px 10px; font-size: 12px;">é‡æ–°åŠ è½½</button>
                    <button class="close-btn" onclick="closeMindmapModal()">&times;</button>
                </div>
            </div>
            <div class="mindmap-content">
                <iframe id="mindmapFrame" src=""
                    style="width: 100%; height: 100%; border: none; border-radius: 4px;"></iframe>
            </div>
        </div>
    </div>

    <script>
        let mindmapFrame = null;
        let mindmapWindow = null;
        let isMindmapInitialized = false;

        // æ‰“å¼€æ€ç»´å¯¼å›¾å¼¹çª—
        function viewMindmap() {
            document.getElementById('mindmapModal').style.display = 'block';

            // è®¾ç½®iframeçš„srcä¸ºmindmap.html
            const frame = document.getElementById('mindmapFrame');
            frame.src = 'mindmap.html';
        }

        // å…³é—­æ€ç»´å¯¼å›¾å¼¹çª—
        function closeMindmapModal() {
            document.getElementById('mindmapModal').style.display = 'none';
            // å…³é—­å¼¹çª—æ—¶åˆ·æ–°å½“å‰é¡µé¢
            window.location.reload();
        }

        // ç›‘å¬æ¥è‡ªiframeçš„æ¶ˆæ¯
        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'mindmapUpdated') {
                console.log('æ€ç»´å¯¼å›¾å·²æ›´æ–°');
                syncMindmapToMarkdown();
            }
        });
    </script>
    <!-- è½¬æ¢å™¨ç›¸å…³è„šæœ¬ -->
    <script type="module">
        import { ConverterManager } from './converter.js';

        // å°†è½¬æ¢å™¨æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.converter = new ConverterManager();
        console.log('ğŸ¯ è½¬æ¢å™¨å·²å…¨å±€æš´éœ²åˆ° window.converter');

        // é€šçŸ¥å…¶ä»–è„šæœ¬è½¬æ¢å™¨å·²å°±ç»ª
        window.dispatchEvent(new CustomEvent('converterReady'));
    </script>

    <script src="sync.js"></script>
    <script src="load.js"></script>


    <!-- å…¨å±€é”®ç›˜ç›‘å¬äº‹ä»¶ï¼šCtrl+Sä¿å­˜å½“å‰markdown -->
    <script>
        document.addEventListener('keydown', function (event) {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹Ctrl+S (Windows) æˆ– Cmd+S (Mac)
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault(); // é˜»æ­¢æµè§ˆå™¨é»˜è®¤ä¿å­˜è¡Œä¸º

                // æ£€æŸ¥saveCurrentMarkdownå‡½æ•°æ˜¯å¦å¯ç”¨
                if (typeof saveCurrentMarkdown === 'function') {
                    try {
                        saveCurrentMarkdown();

                        console.log('å·²ä¿å­˜å½“å‰markdownåˆ°ç¼“å­˜');

                        // å¯é€‰ï¼šæ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æç¤º
                        showSaveNotification('å·²ä¿å­˜åˆ°ç¼“å­˜');
                    } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        showSaveNotification('ä¿å­˜å¤±è´¥: ' + error.message, true);
                    }
                } else {
                    console.warn('saveCurrentMarkdownå‡½æ•°æœªå®šä¹‰');
                    showSaveNotification('ä¿å­˜åŠŸèƒ½æœªå°±ç»ª', true);
                }
            }
        });

        // æ˜¾ç¤ºä¿å­˜é€šçŸ¥çš„è¾…åŠ©å‡½æ•°
        function showSaveNotification(message, isError = false) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 10000;
                transition: opacity 0.3s ease;
                background: ${isError ? '#e74c3c' : '#27ae60'};
            `;

            document.body.appendChild(notification);

            // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }
    </script>

</body>

</html>