<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</title>
    <link type="text/css" rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/style/jsmind.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // é¢„åŠ è½½AIæ¨¡å—
        import { AIExpander } from '../ai/ai-expander.js';
        import { AIConfigManager } from '../ai/ai-config.js';
        // å°†ç±»å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸ
        window.AIExpander = AIExpander;
        window.AIConfigManager = AIConfigManager;
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .mindmap-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mindmap-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .main-container {
            flex: 1;
            display: flex;
            height: calc(100vh - 60px);
        }

        #fullScreenMindmap {
            width: 70%;
            height: 100%;
            position: relative;
            background: white;
        }

        #nodeDetails {
            width: 30%;
            height: 100%;
            padding: 20px;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            background: #f8f9fa;
        }

        #notesOverlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            max-width: 250px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            font-size: 12px;
            z-index: 100;
        }

        .node-info {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .notes-section {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .note-item {
            padding: 10px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 4px 4px 0;
        }

        .note-item h5 {
            margin: 0 0 5px 0;
            color: #007bff;
            font-size: 14px;
        }

        .note-item p {
            margin: 0;
            color: #495057;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div class="mindmap-header">
        <h2>æ€ç»´å¯¼å›¾ç¼–è¾‘å™¨</h2>
        <div class="controls">
            <button class="btn" onclick="syncToParent()">åŒæ­¥åˆ°çˆ¶é¡µé¢</button>
            <button class="btn" onclick="loadFromParent()">ä»çˆ¶é¡µé¢åŠ è½½</button>
            <button class="btn" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
            <button class="btn" onclick="testNodeSelection()" style="background: #ffc107; color: #000;">æµ‹è¯•èŠ‚ç‚¹é€‰æ‹©</button>
            <button class="btn" onclick="downloadMindmap()" style="background: #28a745;">ä¸‹è½½å›¾ç‰‡</button>
        </div>
    </div>

    <div class="main-container">
        <div id="fullScreenMindmap"></div>

        <div id="nodeDetails">
            <div class="node-info">
                <h3>èŠ‚ç‚¹è¯¦æƒ…</h3>
                <div id="nodeInfo">
                    <p>ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
            </div>

            <div class="form-group">
                <label for="nodeTopic">èŠ‚ç‚¹ä¸»é¢˜:</label>
                <input type="text" id="nodeTopic" placeholder="è¾“å…¥èŠ‚ç‚¹ä¸»é¢˜...">
            </div>

            <div class="form-group">
                <label for="nodeNotes">èŠ‚ç‚¹å¤‡æ³¨:</label>
                <textarea id="nodeNotes" placeholder="è¾“å…¥èŠ‚ç‚¹å¤‡æ³¨..."></textarea>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn" onclick="updateNodeNotes()" style="flex: 1;">
                    æ›´æ–°èŠ‚ç‚¹
                </button>
                <button class="btn" onclick="expandWithAI()" style="flex: 1; background: #6f42c1;">
                    AIæ‰©å†™
                </button>
                <button class="btn" onclick="AIExpander.showConfig()" style="flex: 0 0 40px; background: #6c757d;"
                    title="AIé…ç½®">âš™ï¸</button>
            </div>

            <script>
                // AIæ‰©å†™å‡½æ•°
                function expandWithAI() {
                    try {
                        const selectedNode = jm.get_selected_node();
                        if (!selectedNode) {
                            if (typeof NotificationBridge !== 'undefined') {
                                NotificationBridge.showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                            } else {
                                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                            }
                            return;
                        }

                        if (window.AIExpander) {
                            window.AIExpander.expandNode(selectedNode.id, jm);
                        } else {
                            if (typeof NotificationBridge !== 'undefined') {
                                NotificationBridge.showError('AIæ‰©å†™æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            } else {
                                alert('AIæ‰©å†™æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                            }
                        }
                    } catch (e) {
                        console.error('AIæ‰©å†™å‡ºé”™:', e);
                        if (typeof NotificationBridge !== 'undefined') {
                            NotificationBridge.showError('AIæ‰©å†™å‡ºé”™: ' + e.message);
                        } else {
                            alert('AIæ‰©å†™å‡ºé”™: ' + e.message);
                        }
                    }
                }
            </script>

            <div class="notes-section">
                <h4>ğŸ“‹ æ‰€æœ‰èŠ‚ç‚¹å¤‡æ³¨</h4>
                <div id="notesList">
                    <p style="color: #6c757d;">æš‚æ— å¤‡æ³¨</p>
                </div>
            </div>

            <div style="margin-top: 20px; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 10px;">
                <p><strong>ğŸ“‹ ä½¿ç”¨è¯´æ˜:</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>ç‚¹å‡»ä»»æ„èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…å’Œå¤‡æ³¨</li>
                    <li>åœ¨å³ä¾§ç¼–è¾‘ä¸»é¢˜å’Œå¤‡æ³¨å†…å®¹</li>
                    <li>æ‰€æœ‰èŠ‚ç‚¹å¤‡æ³¨ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨ä¸‹æ–¹çš„å¤‡æ³¨åˆ—è¡¨ä¸­</li>
                    <li>é¼ æ ‡æ‚¬åœåœ¨èŠ‚ç‚¹ä¸Šå¯æŸ¥çœ‹å¤‡æ³¨é¢„è§ˆ</li>
                </ul>

                <p style="margin-top: 10px;"><strong>ğŸ¯ æ•°æ®ç»“æ„è¯´æ˜:</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px; color: #007bff;">
                    <li>èŠ‚ç‚¹ID: jsMindæ ‡å‡†å­—æ®µï¼Œå”¯ä¸€æ ‡è¯†</li>
                    <li>èŠ‚ç‚¹ä¸»é¢˜: jsMindæ ‡å‡†å­—æ®µï¼Œæ˜¾ç¤ºæ–‡æœ¬</li>
                    <li>å¤‡æ³¨å­—æ®µ: è‡ªå®šä¹‰æ‰©å±•ï¼Œå­˜å‚¨åœ¨èŠ‚ç‚¹æ ¹çº§åˆ«</li>
                    <li>å…¶ä»–å­—æ®µ: å¯è‡ªç”±æ·»åŠ çš„è‡ªå®šä¹‰å±æ€§</li>
                </ul>
            </div>
        </div>
    </div>
    </div>

    </div>
    </div>

    <!-- é¼ æ ‡æ‚¬åœå¤‡æ³¨å±‚ -->
    <div id="notesOverlay">
        <div style="font-weight: bold; color: #007bff; margin-bottom: 4px;">èŠ‚ç‚¹å¤‡æ³¨</div>
        <div id="hoverNote"></div>
    </div>

    <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.js"></script>
    <script src="https://jsd.onmicrosoft.cn/npm/jsmind@0.8.7/es6/jsmind.draggable-node.js"></script>
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
    <script src="https://unpkg.com/jsmind@0.8.7/es6/jsmind.screenshot.js"></script>
    <script src="sync.js"></script>
    <script src="load.js"></script>
    <script>
        let jm = null;
        let currentNodeTree = null;

        // åˆå§‹åŒ–æ€ç»´å¯¼å›¾
        function initMindmap() {
            if (jm) {
                console.log('æ€ç»´å¯¼å›¾å·²åˆå§‹åŒ–');
                loadNodeTree(); // ä¸ä¼ å‚æ•°ï¼Œè®©å‡½æ•°è‡ªå·±ä»localStorageè·å–
                return;
            }

            console.log('å¼€å§‹åˆå§‹åŒ–æ€ç»´å¯¼å›¾...');

            const options = {
                container: 'fullScreenMindmap',           // å®¹å™¨IDï¼Œå¿…å¡«
                editable: true,                         // æ˜¯å¦å¯ç¼–è¾‘ï¼Œé»˜è®¤ä¸ºtrue
                theme: 'primary',                       // ä¸»é¢˜ï¼šprimary|success|info|warning|danger|greensea|nephrite|belizehole|wisteria|asphalt
                mode: 'side',                           // æ˜¾ç¤ºæ¨¡å¼ï¼šfull|sideå³ä¾§
                support_html: true,                     // èŠ‚ç‚¹æ˜¯å¦æ”¯æŒHTMLï¼Œé»˜è®¤ä¸ºtrue
                view: {
                    engine: 'svg',                   // æ€ç»´å¯¼å›¾å„èŠ‚ç‚¹ä¹‹é—´çº¿æ¡çš„ç»˜åˆ¶å¼•æ“ï¼Œcanvas|svg
                    hmargin: 100,                       // æ°´å¹³è¾¹è·
                    vmargin: 50,                        // å‚ç›´è¾¹è·
                    line_width: 2,                      // è¿æ¥çº¿å®½åº¦
                    line_color: '#555',                 // è¿æ¥çº¿é¢œè‰²
                    expander_style: 'number',           // å±•å¼€å™¨æ ·å¼ï¼šnumber|circle|square
                    expander_color: '#000',             // å±•å¼€å™¨é¢œè‰²
                    expander_size: 12,                  // å±•å¼€å™¨å¤§å°
                    node_overflow: 'wrap',            // æ–‡å­—è¿‡é•¿å¤„ç†ï¼šhidden|wrap
                    zoom: {
                        min: 0.1, // æœ€å°ç¼©æ”¾æ¯”ä¾‹
                        max: 5.0, // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
                        step: 0.1, // ç¼©æ”¾æ­¥é•¿
                        mask_key: 4096 // Ctrl Key å¯ç”¨ç¼©æ”¾æ“ä½œçš„åŠŸèƒ½é”®
                    },
                    draggable: true,                    // æ˜¯å¦å¯æ‹–æ‹½ç”»å¸ƒ
                    hide_scrollbars_when_draggable: true // æ‹–æ‹½æ—¶æ˜¯å¦éšè—æ»šåŠ¨æ¡
                },
                layout: {
                    hspace: 30,                         // èŠ‚ç‚¹æ°´å¹³é—´è·
                    vspace: 20,                         // èŠ‚ç‚¹å‚ç›´é—´è·
                    pspace: 13,                         // èŠ‚ç‚¹ä¸è¿æ¥çº¿çš„é—´è·
                    cousin_space: 10,                   // ç›¸é‚»èŠ‚ç‚¹å­èŠ‚ç‚¹ä¹‹é—´çš„é¢å¤–å‚ç›´ç©ºé—´

                    // å¸ƒå±€ç®—æ³•ç›¸å…³
                    depth_space: 15,                    // å±‚çº§é—´è·

                    // èŠ‚ç‚¹å°ºå¯¸ç›¸å…³
                    node_width: 100,                    // èŠ‚ç‚¹é»˜è®¤å®½åº¦
                    node_height: 50,                    // èŠ‚ç‚¹é»˜è®¤é«˜åº¦

                    // è¿æ¥çº¿æ ·å¼
                    line_type: 'curve',              // è¿æ¥çº¿ç±»å‹ï¼šstraight|curve|polyline
                    line_radius: 5,                     // è¿æ¥çº¿åœ†è§’åŠå¾„
                    line_width: 2,                      // è¿æ¥çº¿å®½åº¦
                    line_color: '#555'                  // è¿æ¥çº¿é¢œè‰²
                },
                shortcut: {
                    enable: true,                         // æ˜¯å¦å¯ç”¨å¿«æ·é”®
                    handles: {},                        // è‡ªå®šä¹‰å¤„ç†å‡½æ•°

                    // å¿«æ·é”®æ˜ å°„
                    mapping: {
                        addchild: 9,                    // Tab - æ·»åŠ å­èŠ‚ç‚¹
                        addbrother: 13,                 // Enter - æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
                        editnode: 113,                  // F2 - ç¼–è¾‘èŠ‚ç‚¹
                        delnode: 46,                    // Delete - åˆ é™¤èŠ‚ç‚¹
                        toggle: 32,                     // Space - å±•å¼€/æŠ˜å èŠ‚ç‚¹

                        // åˆ‡æ¢é€‰ä¸­
                        left: 37,                       // é€‰ä¸­å·¦ä¾§èŠ‚ç‚¹
                        up: 38,                         // 
                        right: 39,                      // 
                        down: 40,                       // 

                        // ä¸‹é¢çš„éƒ½æ˜¯AIå¹»è§‰// å…¶ä»–å¸¸ç”¨å¿«æ·é”®
                        // copy: 67,                       // Ctrl+C - å¤åˆ¶èŠ‚ç‚¹
                        // paste: 86,                      // Ctrl+V - ç²˜è´´èŠ‚ç‚¹
                        // cut: 88,                        // Ctrl+X - å‰ªåˆ‡èŠ‚ç‚¹
                        // undo: 90,                       // Ctrl+Z - æ’¤é”€
                        // redo: 89,                       // Ctrl+Y - é‡åš

                        // // è§†å›¾æ“ä½œ
                        // zoomin: 187,                    // Ctrl++ - æ”¾å¤§
                        // zoomout: 189,                   // Ctrl+- - ç¼©å°
                        // zoomfit: 48,                    // Ctrl+0 - é€‚åº”çª—å£

                    }
                },

                // èŠ‚ç‚¹é»˜è®¤æ ·å¼
                node: {
                    background_color: '#fff',           // èƒŒæ™¯é¢œè‰²
                    foreground_color: '#333',           // æ–‡å­—é¢œè‰²
                    border_color: '#ccc',               // è¾¹æ¡†é¢œè‰²
                    border_width: 1,                    // è¾¹æ¡†å®½åº¦
                    font_size: 14,                      // å­—ä½“å¤§å°
                    font_family: 'Arial, sans-serif',   // å­—ä½“æ—
                    font_weight: 'normal',                // å­—ä½“ç²—ç»†
                    text_align: 'center',               // æ–‡å­—å¯¹é½æ–¹å¼
                    line_height: 1.5,                   // è¡Œé«˜
                    padding: 5,                         // å†…è¾¹è·
                    border_radius: 5,                   // åœ†è§’åŠå¾„

                    // èŠ‚ç‚¹é˜´å½±
                    shadow: true,                       // æ˜¯å¦æ˜¾ç¤ºé˜´å½±
                    shadow_color: '#000',               // é˜´å½±é¢œè‰²
                    shadow_blur: 3,                     // é˜´å½±æ¨¡ç³Šåº¦
                    shadow_offset_x: 1,                 // é˜´å½±æ°´å¹³åç§»
                    shadow_offset_y: 1                  // é˜´å½±å‚ç›´åç§»
                },



                // äº‹ä»¶ç›‘å¬
                event_handles: {
                    // èŠ‚ç‚¹äº‹ä»¶
                    show: function (node) {
                        console.log('èŠ‚ç‚¹æ˜¾ç¤º:', node);
                    },
                    edit: function (node) {
                        console.log('èŠ‚ç‚¹ç¼–è¾‘:', node);
                    },
                    select: function (node) {
                        console.log('èŠ‚ç‚¹é€‰æ‹©:', node);
                    },
                    unselect: function (node) {
                        console.log('èŠ‚ç‚¹å–æ¶ˆé€‰æ‹©:', node);
                    },
                    expand: function (node) {
                        console.log('èŠ‚ç‚¹å±•å¼€:', node);
                    },
                    collapse: function (node) {
                        console.log('èŠ‚ç‚¹æŠ˜å :', node);
                    },
                    add: function (node) {
                        console.log('èŠ‚ç‚¹æ·»åŠ :', node);
                    },
                    remove: function (node) {
                        console.log('èŠ‚ç‚¹åˆ é™¤:', node);
                    },
                    move: function (node) {
                        console.log('èŠ‚ç‚¹ç§»åŠ¨:', node);
                    },
                    resize: function (node) {
                        console.log('èŠ‚ç‚¹å¤§å°æ”¹å˜:', node);
                    },

                    // ç”»å¸ƒäº‹ä»¶
                    mousedown: function (e) {
                        console.log('ç”»å¸ƒé¼ æ ‡æŒ‰ä¸‹:', e);
                    },
                    mousemove: function (e) {
                        console.log('ç”»å¸ƒé¼ æ ‡ç§»åŠ¨:', e);
                    },
                    mouseup: function (e) {
                        console.log('ç”»å¸ƒé¼ æ ‡é‡Šæ”¾:', e);
                    },
                    click: function (e) {
                        console.log('ç”»å¸ƒç‚¹å‡»:', e);
                    },
                    dblclick: function (e) {
                        console.log('ç”»å¸ƒåŒå‡»:', e);
                    },
                    contextmenu: function (e) {
                        console.log('ç”»å¸ƒå³é”®èœå•:', e);
                    },

                    // é”®ç›˜äº‹ä»¶
                    keydown: function (e) {
                        console.log('é”®ç›˜æŒ‰ä¸‹:', e);
                    },
                    keyup: function (e) {
                        console.log('é”®ç›˜é‡Šæ”¾:', e);
                    }
                },

                // å·¥å…·æ é…ç½®
                toolbar: {
                    enable: true,                       // æ˜¯å¦å¯ç”¨å·¥å…·æ 
                    position: 'left',                    // å·¥å…·æ ä½ç½®ï¼štop|bottom|left|right
                    buttons: [                          // å·¥å…·æ æŒ‰é’®
                        'addchild',                     // æ·»åŠ å­èŠ‚ç‚¹
                        'addbrother',                   // æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
                        'editnode',                     // ç¼–è¾‘èŠ‚ç‚¹
                        'delnode',                      // åˆ é™¤èŠ‚ç‚¹
                        'toggle',                       // å±•å¼€/æŠ˜å 
                        'zoomin',                       // æ”¾å¤§
                        'zoomout',                      // ç¼©å°
                        'zoomfit',                      // é€‚åº”çª—å£
                        'expandall',                    // å±•å¼€å…¨éƒ¨
                        'collapseall',                   // æŠ˜å å…¨éƒ¨
                        'reset'                         // é‡ç½®è§†å›¾
                    ]
                },

                // èœå•é…ç½®
                contextmenu: {
                    enable: true,                       // æ˜¯å¦å¯ç”¨å³é”®èœå•
                    items: [                            // èœå•é¡¹
                        'addchild',                     // æ·»åŠ å­èŠ‚ç‚¹
                        'addbrother',                   // æ·»åŠ å…„å¼ŸèŠ‚ç‚¹
                        'editnode',                     // ç¼–è¾‘èŠ‚ç‚¹
                        'delnode',                      // åˆ é™¤èŠ‚ç‚¹
                        'toggle',                       // å±•å¼€/æŠ˜å 
                        'moveup',                       // ä¸Šç§»èŠ‚ç‚¹
                        'movedown',                     // ä¸‹ç§»èŠ‚ç‚¹
                        'movetop',                      // ç§»åŠ¨åˆ°é¡¶éƒ¨
                        'movebottom'                    // ç§»åŠ¨åˆ°åº•éƒ¨
                    ]
                }
            };

            jm = new jsMind(options);

            // åˆå§‹åŒ–å®ŒæˆååŠ è½½æ•°æ®
            loadNodeTree();
            console.log('æ€ç»´å¯¼å›¾æ•°æ®:', jm.get_data())

            console.log('æ€ç»´å¯¼å›¾åˆå§‹åŒ–å®Œæˆ');

            // ç»‘å®šäº‹ä»¶
            jm.add_event_listener(function (type, data) {
                switch (type) {
                    case jsMind.event_type.show:
                        console.log('æ€ç»´å¯¼å›¾æ˜¾ç¤ºå®Œæˆ');
                        break;
                    case jsMind.event_type.edit:
                        console.log('èŠ‚ç‚¹ç¼–è¾‘:', data);
                        break;
                    case jsMind.event_type.select:
                        console.log('èŠ‚ç‚¹é€‰æ‹©:', data);
                        // ä»jsMindè·å–å®Œæ•´çš„èŠ‚ç‚¹å¯¹è±¡
                        const selectedNodeid = jm.get_selected_node();
                        if (selectedNodeid) {
                            showNodeDetails(selectedNodeid);
                        } else {
                            console.error('æ‰¾ä¸åˆ°é€‰ä¸­çš„èŠ‚ç‚¹:', data.node);
                        }
                        break;
                }
            });

        }

        // åŠ è½½NodeTreeæ•°æ®
        function loadNodeTree(nodeTreeData) {
            if (!jm) {
                console.error('jsMindæœªåˆå§‹åŒ–');
                return;
            }

            // å¦‚æœæ²¡æœ‰æä¾›æ•°æ®ï¼Œå°è¯•ä»localStorageè·å–
            if (!nodeTreeData) {
                const cachedData = localStorage.getItem('mindword_nodetree_data');
                if (cachedData) {
                    try {
                        nodeTreeData = JSON.parse(cachedData);
                        console.log('ä»localStorageåŠ è½½NodeTree:', nodeTreeData);
                    } catch (error) {
                        console.error('è§£ælocalStorageæ•°æ®å¤±è´¥:', error);
                        nodeTreeData = getDefaultNodeTree();
                    }
                } else {
                    console.log('localStorageä¸­æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    nodeTreeData = getDefaultNodeTree();
                }
            }

            try {
                // ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
                if (typeof nodeTreeData === 'string') {
                    nodeTreeData = JSON.parse(nodeTreeData);
                }

                jm.show(nodeTreeData);
                currentNodeTree = nodeTreeData;

                // å»¶è¿Ÿæ‰§è¡ŒDOMæ“ä½œï¼Œç¡®ä¿å…ƒç´ å·²åŠ è½½
                setTimeout(() => {
                    refreshAllNotesDisplay();

                    // è‡ªåŠ¨é€‰æ‹©æ ¹èŠ‚ç‚¹å¹¶æ˜¾ç¤ºè¯¦æƒ…
                    const rootNode = jm.get_root();
                    if (rootNode) {
                        console.log('è‡ªåŠ¨é€‰æ‹©æ ¹èŠ‚ç‚¹:', rootNode);
                        jm.select_node(rootNode.id);
                        showNodeDetails(rootNode);
                    }
                }, 100);

                console.log('NodeTreeåŠ è½½æˆåŠŸ');
            } catch (error) {
                console.error('åŠ è½½NodeTreeå¤±è´¥:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½é»˜è®¤æ•°æ®
                try {
                    jm.show(getDefaultNodeTree());
                    console.log('å·²åŠ è½½é»˜è®¤NodeTree');
                } catch (defaultError) {
                    console.error('åŠ è½½é»˜è®¤NodeTreeä¹Ÿå¤±è´¥:', defaultError);
                }
            }
        }

        // è·å–å½“å‰NodeTree
        function getCurrentNodeTree() {
            return jm ? jm.get_data() : null;
        }

        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…
        function showNodeDetails(node) {
            console.log('=== è°ƒè¯•ï¼šshowNodeDetails è¢«è°ƒç”¨ ===');
            console.log('èŠ‚ç‚¹æ•°æ®ç»“æ„:', {
                ç»“æ„è¯´æ˜: 'jsMindèŠ‚ç‚¹æ˜¯çµæ´»çš„JSONå¯¹è±¡ï¼Œå¿…éœ€å­—æ®µï¼šid, topic',
                è‡ªå®šä¹‰å­—æ®µ: 'notes, levelç­‰æ‰©å±•å­—æ®µå­˜å‚¨åœ¨æ ¹çº§åˆ«',
                èŠ‚ç‚¹ä¿¡æ¯: {
                    id: node.id,           // å¿…éœ€ï¼šèŠ‚ç‚¹å”¯ä¸€æ ‡è¯†
                    topic: node.topic,     // å¿…éœ€ï¼šèŠ‚ç‚¹æ˜¾ç¤ºæ–‡æœ¬
                    notes: node.data.notes,     // è‡ªå®šä¹‰ï¼šå¤‡æ³¨å­—æ®µï¼ˆå¯é€‰ï¼‰
                    level: node.data.data.level,     // è‡ªå®šä¹‰ï¼šèŠ‚ç‚¹å±‚çº§ï¼ˆå¯é€‰ï¼‰
                    parentid: node.data.parentid // å¯é€‰ï¼šçˆ¶èŠ‚ç‚¹ID
                }
            });

            const nodeInfo = document.getElementById('nodeInfo');
            const nodeTopic = document.getElementById('nodeTopic');
            const nodeNotes = document.getElementById('nodeNotes');

            if (!nodeInfo || !nodeTopic || !nodeNotes) {
                console.error('æ‰¾ä¸åˆ°DOMå…ƒç´ :', {
                    nodeInfo: !!nodeInfo,
                    nodeTopic: !!nodeTopic,
                    nodeNotes: !!nodeNotes
                });
                return;
            }

            console.log('æ‰€æœ‰DOMå…ƒç´ éƒ½å­˜åœ¨ï¼Œå¼€å§‹æ›´æ–°å†…å®¹...');

            // å®‰å…¨è·å–èŠ‚ç‚¹å±‚çº§
            let nodeLevel = 0;
            try {
                // å°è¯•ä»ä¸åŒä½ç½®è·å–levelå±æ€§
                nodeLevel = node.level !== undefined ? node.level :
                    (node.data && node.data.level !== undefined ? node.data.level : 0);
            } catch (e) {
                console.warn('æ— æ³•è¯»å–èŠ‚ç‚¹å±‚çº§:', e);
            }

            nodeInfo.innerHTML = `
                <p><strong>èŠ‚ç‚¹ID:</strong> ${node.id}</p>
                <p><strong>ä¸»é¢˜:</strong> ${node.topic || 'æ— ä¸»é¢˜'}</p>
                <p><strong>å±‚çº§:</strong> ${nodeLevel}</p>
                <p><strong>çˆ¶èŠ‚ç‚¹:</strong> ${node.parentid || 'æ ¹èŠ‚ç‚¹'}</p>
            `;

            nodeTopic.value = node.topic || '';
            nodeNotes.value = node.data.notes || '';  // ç›´æ¥ä»æ ¹çº§åˆ«è¯»å–notes

            console.log('èŠ‚ç‚¹è¯¦æƒ…å·²æ›´æ–°å®Œæˆ');
        }

        // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨
        function updateNodeNotes() {
            if (!jm) return;

            const selected = jm.get_selected_node();
            if (!selected) {
                if (typeof NotificationBridge !== 'undefined') {
                    NotificationBridge.showWarning('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                } else {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹');
                }
                return;
            }

            const nodeTopic = document.getElementById('nodeTopic');
            const nodeNotes = document.getElementById('nodeNotes');

            const newTopic = nodeTopic.value.trim();
            const newNotes = nodeNotes.value.trim();

            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å˜åŒ–éœ€è¦æ›´æ–°
            let hasChanges = false;

            // æ›´æ–°èŠ‚ç‚¹ä¸»é¢˜ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
            if (newTopic !== selected.topic) {
                jm.update_node(selected.id, newTopic);
                hasChanges = true;
            }

            // æ›´æ–°èŠ‚ç‚¹å¤‡æ³¨ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
            if (newNotes !== (selected.notes || '')) {
                // ç›´æ¥æ›´æ–°æ ¹çº§åˆ«çš„noteså­—æ®µï¼ˆä¸å…¶ä»–ä»£ç ä¿æŒä¸€è‡´ï¼‰
                selected.data.notes = newNotes;
                hasChanges = true;
            }

            // å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œæç¤ºç”¨æˆ·
            if (!hasChanges) {
                if (typeof NotificationBridge !== 'undefined') {
                    NotificationBridge.showInfo('èŠ‚ç‚¹å†…å®¹æ²¡æœ‰å˜åŒ–ï¼');
                } else {
                    alert('èŠ‚ç‚¹å†…å®¹æ²¡æœ‰å˜åŒ–ï¼');
                }
                return;
            }

            refreshAllNotesDisplay();

            // // åŒæ­¥åˆ°çˆ¶é¡µé¢
            // if (window.parent !== window) {
            //     window.parent.postMessage({
            //         type: 'mindmapUpdated',
            //         data: jm.get_data()
            //     }, '*');
            // }

            // ä¿å­˜åˆ°localStorageå¹¶åŒæ­¥
            saveToLocalStorage();

            if (typeof NotificationBridge !== 'undefined') {
                NotificationBridge.showSuccess('èŠ‚ç‚¹æ›´æ–°æˆåŠŸï¼');
            } else {
                alert('èŠ‚ç‚¹æ›´æ–°æˆåŠŸï¼');
            }
        }

        // åˆ·æ–°æ‰€æœ‰å¤‡æ³¨æ˜¾ç¤º
        function refreshAllNotesDisplay() {
            if (!jm) return;

            const notesList = document.getElementById('notesList');
            if (!notesList) return; // é˜²æ­¢DOMå…ƒç´ ä¸å­˜åœ¨

            const nodeTree = jm.get_data();

            if (!nodeTree || !nodeTree.data) {
                notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹æ•°æ®</p>';
                return;
            }

            const nodesWithNotes = [];

            function collectNodes(node) {
                if (!node) return;

                const notes = node.notes;  // ç›´æ¥ä»æ ¹çº§åˆ«è¯»å–notes
                if (notes && notes.trim()) {
                    nodesWithNotes.push({
                        id: node.id,
                        topic: node.topic || 'æœªå‘½åèŠ‚ç‚¹',
                        notes: notes.trim(),
                        level: node.level || 0
                    });
                }

                if (node.children) {
                    node.children.forEach(collectNodes);
                }
            }

            collectNodes(nodeTree.data);

            if (nodesWithNotes.length === 0) {
                notesList.innerHTML = '<p style="color: #6c757d;">æš‚æ— èŠ‚ç‚¹åŒ…å«å¤‡æ³¨ä¿¡æ¯</p>';
                return;
            }

            nodesWithNotes.sort((a, b) => a.level - b.level);

            let html = '';
            nodesWithNotes.forEach(node => {
                const levelIndent = 'ã€€'.repeat(node.level);
                html += `
                    <div class="note-item">
                        <h5>${levelIndent}${node.topic}</h5>
                        <p>${node.notes}</p>
                        <small style="color: #6c757d;">ID: ${node.id}</small>
                    </div>
                `;
            });

            notesList.innerHTML = html;
        }

        // è®¾ç½®é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¤‡æ³¨
        function setupHoverNotes() {
            const container = document.getElementById('fullScreenMindmap');
            const notesOverlay = document.getElementById('notesOverlay');
            const hoverNote = document.getElementById('hoverNote');

            let hoverTimeout;

            container.addEventListener('mousemove', function (e) {
                if (!jm) return;

                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // ä½¿ç”¨jsmindæä¾›çš„æŸ¥æ‰¾èŠ‚ç‚¹æ–¹æ³•
                let node = null;
                try {
                    if (jm.get_node_by_coordinate) {
                        node = jm.get_node_by_coordinate(x, y);
                    } else {
                        // å¤‡ç”¨æ–¹æ³•ï¼šé€šè¿‡äº‹ä»¶ç›®æ ‡æŸ¥æ‰¾
                        const target = e.target;
                        if (target && target.closest('.jmnode')) {
                            const nodeId = target.closest('.jmnode').getAttribute('nodeid');
                            if (nodeId) {
                                node = jm.get_node(nodeId);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('è·å–èŠ‚ç‚¹å¤±è´¥:', error);
                }

                if (node && node.notes && node.notes.trim()) {  // ä½¿ç”¨æ ¹çº§åˆ«çš„notes
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        hoverNote.textContent = node.notes;  // ä½¿ç”¨æ ¹çº§åˆ«çš„notes
                        notesOverlay.style.display = 'block';
                        notesOverlay.style.left = Math.min(x + 10, rect.width - 260) + 'px';
                        notesOverlay.style.top = Math.max(y - 50, 10) + 'px';
                    }, 300);
                } else {
                    clearTimeout(hoverTimeout);
                    hoverTimeout = setTimeout(() => {
                        notesOverlay.style.display = 'none';
                    }, 100);
                }
            });

            container.addEventListener('mouseleave', function () {
                clearTimeout(hoverTimeout);
                notesOverlay.style.display = 'none';
            });
        }

        // ä¸çˆ¶é¡µé¢é€šä¿¡
        function syncToParent() {
            if (window.parent !== window && jm) {
                window.parent.postMessage({
                    type: 'mindmapUpdated',
                    data: jm.get_data()
                }, '*');
                if (typeof NotificationBridge !== 'undefined') {
                    NotificationBridge.showSuccess('å·²åŒæ­¥åˆ°çˆ¶é¡µé¢ï¼');
                } else {
                    alert('å·²åŒæ­¥åˆ°çˆ¶é¡µé¢ï¼');
                }
            }
        }

        function loadFromParent() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'loadNodeTreeRequest'
                }, '*');
            }
        }

        // // æµ‹è¯•èŠ‚ç‚¹é€‰æ‹©å’ŒAIæ‰©å†™åŠŸèƒ½
        function testNodeSelection() {
            console.log('=== æµ‹è¯•èŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½ ===');

            if (!jm) {
                console.error('æ€ç»´å¯¼å›¾æœªåˆå§‹åŒ–');
                return;
            }

            // è·å–æ ¹èŠ‚ç‚¹
            const rootNode = jm.get_root();
            if (rootNode) {
                console.log('æ‰¾åˆ°æ ¹èŠ‚ç‚¹:', rootNode);

                // æ‰‹åŠ¨é€‰æ‹©æ ¹èŠ‚ç‚¹
                jm.select_node(rootNode.id);

                // ç›´æ¥è°ƒç”¨showNodeDetails
                showNodeDetails(rootNode);

                // æµ‹è¯•AIæ‰©å†™åŠŸèƒ½
                if (window.AIExpander) {
                    alert('AIæ‰©å†™åŠŸèƒ½å·²åŠ è½½ï¼Œç‚¹å‡»ç¡®å®šå¼€å§‹æµ‹è¯•');
                    window.AIExpander.expandNode(rootNode.id, jm);
                } else {
                    alert('AIæ‰©å†™æ¨¡å—æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ai-expander.jsæ–‡ä»¶');
                }

                console.log('æµ‹è¯•å®Œæˆï¼Œè¯·æ£€æŸ¥å³ä¾§è¯¦æƒ…é¢æ¿');
            } else {
                console.error('æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹');
            }
        }

        function exportData() {
            if (!jm) return;

            const data = jm.get_data();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mindmap.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // è·å–é»˜è®¤NodeTree
        function getDefaultNodeTree() {
            return {
                "meta": {
                    "name": "jsMind remote",
                    "author": "mindword",
                    "version": "1.0.0"
                },
                "format": "node_tree",
                "data": {
                    "id": "root",
                    "topic": "æ¬¢è¿ä½¿ç”¨æ€ç»´å¯¼å›¾",
                    "children": [
                        {
                            "id": "sub1",
                            "topic": "ç‚¹å‡»èŠ‚ç‚¹ç¼–è¾‘",
                            "direction": "right",
                            "children": [
                                {
                                    "id": "sub1_1",
                                    "topic": "åŒå‡»ç¼–è¾‘æ–‡æœ¬",
                                    "data": {
                                        "notes": "åŒå‡»èŠ‚ç‚¹å¯ä»¥ç¼–è¾‘æ–‡æœ¬å†…å®¹"
                                    }
                                },
                                {
                                    "id": "sub1_2",
                                    "topic": "æ‹–æ‹½è°ƒæ•´ä½ç½®",
                                    "data": {
                                        "notes": "æ‹–æ‹½èŠ‚ç‚¹å¯ä»¥è°ƒæ•´ä½ç½®å’Œå±‚çº§å…³ç³»"
                                    }
                                }
                            ]
                        },
                        {
                            "id": "sub2",
                            "topic": "å³ä¾§ç¼–è¾‘è¯¦æƒ…",
                            "direction": "right",
                            "data": {
                                "notes": "åœ¨å³ä¾§é¢æ¿å¯ä»¥ç¼–è¾‘èŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯"
                            }
                        }
                    ]
                }
            };
        }

        // ä¿å­˜å½“å‰æ•°æ®åˆ°localStorageå¹¶åŒæ­¥
        function saveToLocalStorage() {
            if (!jm) return;

            const currentData = jm.get_data();
            const dataString = JSON.stringify(currentData);

            // é¿å…è§¦å‘æœ¬åœ°ç›‘å¬å™¨ï¼ˆé˜²æ­¢å¾ªç¯åŠ è½½ï¼‰
            lastStorageData = dataString;
            localStorage.setItem('mindword_nodetree_data', dataString);

            // åŒæ­¥æ•°æ®åˆ°å„ä¸ªç³»ç»Ÿ
            try {
                // 1. ä¼˜å…ˆä½¿ç”¨syncAllå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (typeof syncAll === 'function') {
                    // åŠ¨æ€åŠ è½½è½¬æ¢å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    if (!window.converter) {
                        console.log('æ­£åœ¨åŠ è½½è½¬æ¢å™¨...');
                        import('./converter.js')
                            .then(module => {
                                window.converter = new module.ConverterManager();
                                console.log('è½¬æ¢å™¨å·²åŠ è½½');
                                syncAll('nodeTree', true, true, currentData);
                            })
                            .catch(error => {
                                console.warn('è½¬æ¢å™¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ¨¡å¼:', error);
                                // é™çº§å¤„ç†ï¼šç›´æ¥ä¿å­˜åˆ°localStorage
                                localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
                            });
                    } else {
                        // è½¬æ¢å™¨å·²å­˜åœ¨ï¼Œç›´æ¥è°ƒç”¨
                        syncAll('nodeTree', true, true, currentData);
                    }
                } else {
                    // 2. é™çº§å¤„ç†ï¼šä¿å­˜åˆ°localStorage
                    console.log('syncAllå‡½æ•°ä¸å­˜åœ¨ï¼Œä¿å­˜åˆ°localStorage');
                    localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
                }

                // 3. åŒæ­¥åˆ°çˆ¶é¡µé¢
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'mindmapUpdated',
                        data: currentData
                    }, '*');
                    console.log('å·²åŒæ­¥åˆ°çˆ¶é¡µé¢');
                }
            } catch (error) {
                console.warn('åŒæ­¥æ–¹æ³•è°ƒç”¨å¤±è´¥:', error);
                // æœ€ç»ˆé™çº§å¤„ç†
                localStorage.setItem('mindword_nodetree_data', JSON.stringify(currentData));
            }

            console.log('æ€ç»´å¯¼å›¾æ•°æ®å·²ä¿å­˜åˆ°localStorageå¹¶åŒæ­¥');
        }

        // é˜²æŠ–ä¿å­˜ï¼ˆé¿å…é¢‘ç¹æ“ä½œï¼‰
        let saveTimer = null;
        function debouncedSave() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveToLocalStorage();
            }, 300);
        }

        // è®¾ç½®æ€ç»´å¯¼å›¾å˜åŒ–ç›‘å¬å™¨
        function setupMindmapChangeWatcher() {
            if (!jm) return;

            // ç›‘å¬jsMindçš„å„ç§å˜åŒ–äº‹ä»¶
            jm.add_event_listener(function (type, data) {
                // åªåœ¨ç‰¹å®šäº‹ä»¶ç±»å‹æ—¶è§¦å‘ä¿å­˜
                const saveEvents = [
                    jsMind.event_type.edit,
                    jsMind.event_type.add_node,
                    jsMind.event_type.remove_node,
                    jsMind.event_type.move_node
                ];

                if (saveEvents.includes(type)) {
                    console.log('æ£€æµ‹åˆ°æ€ç»´å¯¼å›¾å˜åŒ–:', type, data);
                    debouncedSave();
                }
            });

            console.log('æ€ç»´å¯¼å›¾å˜åŒ–ç›‘å¬å™¨å·²è®¾ç½®');
        }


        // ç›‘å¬localStorageå˜åŒ–ï¼ˆåŒ…æ‹¬åŒä¸€é¡µé¢å†…çš„ä¿®æ”¹ï¼‰
        let lastStorageData = null;
        let storageCheckTimer = null;
        let lastChangeTime = 0;

        // æ£€æŸ¥localStorageæ•°æ®æ˜¯å¦å˜åŒ–çš„å‡½æ•°ï¼ˆå¸¦é˜²æŠ–ï¼‰
        function checkLocalStorageChange() {
            const now = Date.now();
            const currentData = localStorage.getItem('mindword_nodetree_data');

            if (currentData !== lastStorageData) {
                console.log('æ£€æµ‹åˆ°localStorageæ•°æ®å˜åŒ–ï¼Œå‡†å¤‡é‡æ–°åŠ è½½...');
                lastStorageData = currentData;
                lastChangeTime = now;

                // é˜²æŠ–å¤„ç†ï¼šå»¶è¿Ÿ500msæ‰§è¡Œï¼Œé¿å…é¢‘ç¹åˆ·æ–°
                clearTimeout(storageCheckTimer);
                storageCheckTimer = setTimeout(() => {
                    loadNodeTree();
                }, 500);
            }
        }


        // è®¾ç½®localStorageå˜åŒ–ç›‘å¬å™¨
        function setupLocalStorageWatcher() {
            // ä¿å­˜åˆå§‹æ•°æ®
            lastStorageData = localStorage.getItem('mindword_nodetree_data');

            // ä½¿ç”¨setIntervalå®šæœŸæ£€æŸ¥å˜åŒ–ï¼ˆæ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(checkLocalStorageChange, 500);

            // åŒæ—¶ç›‘å¬storageäº‹ä»¶ï¼ˆå¤„ç†å…¶ä»–é¡µé¢çš„å˜åŒ–ï¼‰
            window.addEventListener('storage', function (e) {
                if (e.key === 'mindword_nodetree_data') {
                    console.log('é€šè¿‡storageäº‹ä»¶æ£€æµ‹åˆ°æ•°æ®å˜åŒ–');
                    checkLocalStorageChange();
                }
            });

            // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºåŒä¸€é¡µé¢å†…çš„é€šçŸ¥ï¼‰
            window.addEventListener('mindwordDataUpdated', function () {
                console.log('é€šè¿‡è‡ªå®šä¹‰äº‹ä»¶æ£€æµ‹åˆ°æ•°æ®å˜åŒ–');
                checkLocalStorageChange();
            });

            console.log('localStorageç›‘å¬å™¨å·²è®¾ç½®');
        }

        // ä¸‹è½½æ€ç»´å¯¼å›¾ä¸ºå›¾ç‰‡
        function downloadMindmap() {
            if (!jm) {
                alert('æ€ç»´å¯¼å›¾å°šæœªåˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            try {
                console.log('å¼€å§‹ä¸‹è½½æ€ç»´å¯¼å›¾...');

                // ä½¿ç”¨jsMindçš„æˆªå›¾åŠŸèƒ½
                jm.shoot();

                console.log('ä¸‹è½½å·²å¯åŠ¨');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', async function () {
            // åˆå§‹åŒ–è½¬æ¢å™¨
            try {
                if (!window.converter) {
                    console.log('æ­£åœ¨åˆå§‹åŒ–è½¬æ¢å™¨...');
                    const module = await import('./converter.js');
                    window.converter = new module.ConverterManager();
                    console.log('è½¬æ¢å™¨åˆå§‹åŒ–å®Œæˆ');
                }
            } catch (error) {
                console.warn('è½¬æ¢å™¨åˆå§‹åŒ–å¤±è´¥:', error);
            }

            initMindmap();
            setupLocalStorageWatcher();
            setupMindmapChangeWatcher();

            // åˆå§‹åŒ–AIæ‰©å†™åŠŸèƒ½
            if (window.AIExpander) {
                window.aiExpander = new window.AIExpander();
                window.aiExpander.init(jm);
            }
        });

        // // æä¾›ä¸€ä¸ªæ‰‹åŠ¨è§¦å‘åˆ·æ–°çš„æ–¹æ³•
        // function forceReloadData() {
        //     console.log('æ‰‹åŠ¨å¼ºåˆ¶åˆ·æ–°æ•°æ®');
        //     loadNodeTree();
        // }
        // // é€šçŸ¥çˆ¶é¡µé¢å·²åŠ è½½å®Œæˆ
        // if (window.parent !== window) {
        //     window.parent.postMessage({
        //         type: 'mindmapReady'
        //     }, '*');
        // }

    </script>
</body>

</html>